# 骰子系统更新说明

## 脚本导入链接

### Stable 版本（稳定版，推荐普通用户使用）

```typescript
import 'https://testingcf.jsdelivr.net/gh/jerryzmtz/my-tavern-scripts@main/dist/骰子系统/stable.js'
```

### Nightly 版本（每日构建版，推荐尝鲜用户使用）

```typescript
import 'https://testingcf.jsdelivr.net/gh/jerryzmtz/my-tavern-scripts@nightly/dist/骰子系统/nightly.js'
```

## 更新流程

### 更新 Nightly 版本（日常开发）

1. **切换到 nightly 分支**
   - 在 GitHub Desktop 中，点击顶部的分支名（显示 `main`）
   - 选择 `nightly`，如果没有则先创建

2. **修改代码**
   - 在 `src/骰子系统/index.ts` 中修改你的代码

3. **提交并推送**
   - 在 GitHub Desktop 中：
     - 填写提交信息（例如："添加新功能"）
     - 点击 `Commit to nightly`
     - 点击 `Push origin`

4. **等待自动打包**
   - GitHub Actions 会自动打包
   - 等待几分钟后，在 GitHub 仓库的 `Actions` 标签页查看打包状态
   - 打包完成后，nightly 版本会自动更新
   - 用户可以通过 nightly 链接获取最新版本

### 更新 Stable 版本（发布稳定版）

1. **切换到 main 分支**
   - 在 GitHub Desktop 中，点击分支名，选择 `main`

2. **合并 nightly 的更改**
   - 方法 A：合并整个 nightly 分支（推荐）
     - 点击 `Branch` → `Merge into current branch...`
     - 选择 `nightly`
     - 点击 `Merge nightly into main`
   - 方法 B：选择性合并特定提交
     - 在 `History` 标签页找到要合并的提交
     - 右键点击提交，选择 `Cherry-pick commit`

3. **提交并推送**
   - 如果有新的提交，填写提交信息（例如："发布稳定版 v2.90"）
   - 点击 `Commit to main`
   - 点击 `Push origin`

4. **等待自动打包**
   - GitHub Actions 会自动打包并打版本标签
   - 等待几分钟后，stable 版本会自动更新
   - 用户可以通过 stable 链接获取稳定版本

### 创建 Nightly 分支（如果还没有）

如果还没有 nightly 分支，先创建：

1. 在 GitHub Desktop 中，点击分支名（显示 `main`）
2. 点击 `New branch`
3. 输入分支名：`nightly`
4. 点击 `Create branch`
5. 点击 `Publish branch` 推送到 GitHub

## 工作流程建议

### 日常开发流程

```
1. 在 nightly 分支开发新功能
   ↓
2. 测试功能是否正常
   ↓
3. 如果稳定，合并到 main 分支发布 stable 版本
```

### 快速更新示例

**更新 Nightly：**
1. 切换到 nightly 分支
2. 修改 `src/骰子系统/index.ts`
3. Commit to nightly
4. Push origin
5. 等待 GitHub Actions 自动打包（约 2-5 分钟）

**发布 Stable：**
1. 切换到 main 分支
2. Branch → Merge into current branch → 选择 nightly
3. Commit to main
4. Push origin
5. 等待 GitHub Actions 自动打包并打标签（约 2-5 分钟）

## 验证打包结果

打包完成后，可以在 GitHub 仓库中查看：

1. 访问：`https://github.com/jerryzmtz/my-tavern-scripts`
2. 点击 `dist` 文件夹
3. 进入 `骰子系统` 文件夹
4. 应该能看到：
   - **main 分支**：`stable.js` 和 `stable.js.map`
   - **nightly 分支**：`nightly.js` 和 `nightly.js.map`

## 重要提示

- **Nightly 分支**：用于日常开发和测试，可以频繁更新
- **Main 分支**：用于发布稳定版本，只在功能稳定后合并
- **自动打包**：两个分支都会自动打包，无需手动操作
- **用户选择**：
  - 尝鲜用户 → 使用 nightly 链接（最新功能，可能有 bug）
  - 稳定用户 → 使用 stable 链接（经过测试的稳定版本）
- **版本标签**：main 分支会自动打版本标签（如 v2.80.0），便于缓存刷新

## 常见问题

### 打包失败怎么办？

1. **检查 GitHub Actions 日志**
   - 访问仓库的 `Actions` 标签页
   - 点击失败的 workflow
   - 查看错误信息

2. **检查代码是否有语法错误**
   - 在本地运行 `pnpm build` 测试
   - 确保 TypeScript 代码没有语法错误

3. **检查文件路径是否正确**
   - 确保 `src/骰子系统/index.ts` 存在
   - 确保文件没有拼写错误

### 链接访问不了？

1. **等待几分钟**
   - jsDelivr 可能需要时间索引新文件
   - 特别是刚公开的仓库，可能需要 10-30 分钟

2. **清除 jsDelivr 缓存**
   - 访问：https://www.jsdelivr.com/tools/purge
   - 输入链接（把 `testingcf.jsdelivr` 改成 `cdn.jsdelivr`）：
     ```
     https://cdn.jsdelivr.net/gh/jerryzmtz/my-tavern-scripts@main/dist/骰子系统/stable.js
     ```
   - 点击 `Purge` 清除缓存

3. **尝试不同镜像**
   - `https://testingcf.jsdelivr.net`（主服务器，国内可能较慢）
   - `https://fastly.jsdelivr.net`（Fastly 镜像）
   - `https://gcore.jsdelivr.net`（G-Core 镜像）

4. **检查仓库是否公开**
   - jsDelivr 无法访问私有仓库
   - 确保仓库设置为 Public

5. **检查路径是否正确**
   - 确保链接中包含 `@main` 或 `@nightly` 指定分支
   - 路径中的中文字符会被自动编码，这是正常的

### 如何查看打包是否成功？

1. **访问 GitHub Actions**
   - `https://github.com/jerryzmtz/my-tavern-scripts/actions`
   - 查看最新的 `bundle` workflow 是否成功（绿色对勾）

2. **检查 dist 文件夹**
   - `https://github.com/jerryzmtz/my-tavern-scripts/tree/main/dist/骰子系统`
   - 应该能看到 `stable.js` 和 `stable.js.map` 文件

3. **测试链接**
   - 在浏览器中直接访问脚本链接
   - 应该能看到 JavaScript 代码而不是错误信息

### 脚本在酒馆助手中无效？

1. **检查脚本链接是否正确**
   - 确保链接完整且正确
   - 确保使用了正确的分支（`@main` 或 `@nightly`）

2. **检查浏览器控制台**
   - 在酒馆中按 `F12` 打开开发者工具
   - 切换到 `Console`（控制台）标签
   - 查看是否有红色错误信息

3. **等待 jsDelivr 索引**
   - 刚打包的文件可能需要几分钟才能通过 jsDelivr 访问
   - 尝试等待 5-10 分钟后重试

4. **清除浏览器缓存**
   - 按 `Ctrl + Shift + R` 强制刷新
   - 或者在浏览器设置中清除缓存

## 链接格式说明

### 为什么需要 `@main` 或 `@nightly`？

使用分支标识符（`@main` 或 `@nightly`）可以让 jsDelivr 更准确地定位文件，避免缓存问题。

### 完整链接格式

```
https://testingcf.jsdelivr.net/gh/用户名/仓库名@分支名/dist/路径/文件名.js
```

示例：
- Stable: `https://testingcf.jsdelivr.net/gh/jerryzmtz/my-tavern-scripts@main/dist/骰子系统/stable.js`
- Nightly: `https://testingcf.jsdelivr.net/gh/jerryzmtz/my-tavern-scripts@nightly/dist/骰子系统/nightly.js`

### 如果省略分支名会怎样？

如果不加 `@main` 或 `@nightly`，jsDelivr 会使用默认分支（通常是 main）。对于 stable 版本，可以省略，但建议明确指定分支以避免问题。
