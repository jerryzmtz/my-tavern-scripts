const t=[[/荞麦面|拉面/,'ti:soup'],[/ring|livehouse/,'fa:guitar'],[/黄瓜/,'ti:plant'],[/芒果/,'ti:lemon'],[/剧本/,'fa:scroll'],[/吉他/,'fa:guitar'],[/番茄/,'ti:apple'],[/沙拉/,'ti:salad'],[/奶茶/,'ti:cup'],[/钢琴/,'fa:music'],[/橘子/,'ti:lemon'],[/音箱/,'fa:volume-high'],[/唱片/,'fa:compact-disc'],[/眼镜/,'fa:glasses'],[/长袍/,'ti:shirt'],[/薯条/,'fa:utensils'],[/铅笔/,'fa:pencil'],[/种子/,'ti:plant'],[/冰淇淋/,'ti:ice-cream'],[/草莓/,'fa:apple-whole'],[/布丁/,'ti:cookie'],[/插画|绘本/,'fa:palette'],[/t恤/,'ti:shirt'],[/录音/,'fa:microphone'],[/风铃/,'ti:wind'],[/苹果/,'ti:apple'],[/颜料/,'fa:palette'],[/制服/,'ti:shirt'],[/扫帚/,'ti:brush'],[/发带|发绳/,'fa:ribbon'],[/椰子/,'ti:palm'],[/休息室|休息区|休息/,'fa:couch'],[/扶梯/,'ti:escalator'],[/长椅|长凳|公园椅/,'ti:armchair'],[/凳/,'fa:chair'],[/花坛|花圃/,'ti:flower'],[/书架/,'fa:book'],[/雕像|石像/,'fa:monument'],[/被褥/,'fa:bed'],[/暖炉|壁炉/,'ti:flame'],[/水池/,'ti:pool'],[/木屋/,'ti:home'],[/工坊/,'fa:hammer'],[/存档点|记录点/,'fa:floppy-disk'],[/传送门|传送阵/,'fa:door-open'],[/陷阱|地雷|尖刺/,'ti:alert-triangle'],[/开关|拉杆|按钮/,'fa:gamepad'],[/篝火|营火|火把/,'fa:fire'],[/路牌|告示|公示|公告/,'ti:certificate'],[/祭坛/,'ti:candle'],[/机场|停机坪/,'fa:plane'],[/吊篮|缆车/,'fa:cable-car'],[/车站|站|地铁|火车站/,'fa:train'],[/停车场|车库/,'fa:square-parking'],[/路|公路|高速/,'fa:road'],[/校车|巴士|公交/,'fa:bus'],[/大巴/,'fa:bus-simple'],[/厨房/,'ti:chef-hat'],[/淋浴/,'fa:shower'],[/浴室/,'fa:bath'],[/厕所|洗手间|卫生间/,'fa:toilet'],[/阳台|天台|露台/,'ti:telescope'],[/地下室|地窖/,'ti:stairs-down'],[/地下|地底/,'fa:arrow-down'],[/书房/,'fa:book-open'],[/客厅|起居室|大厅/,'fa:couch'],[/闺房/,'fa:ribbon'],[/中庭/,'fa:building-columns'],[/会议室/,'fa:users'],[/琴室/,'fa:music'],[/后台/,'fa:masks-theater'],[/下水道|排水管/,'ti:ripple'],[/摄影棚|片场|影棚/,'fa:film'],[/武器店|铁匠铺/,'fa:gavel'],[/防具店/,'fa:shield-halved'],[/道具店|杂货铺/,'fa:bag-shopping'],[/温泉|澡堂/,'ti:bath'],[/赌场|娱乐城|扭蛋机/,'ti:cards'],[/实验室|研究所/,'fa:flask'],[/医务室/,'fa:hospital'],[/工厂|发电厂/,'fa:industry'],[/警察局|派出所/,'fa:building-shield'],[/法院|法庭|县衙|府衙/,'fa:scale-balanced'],[/监狱|牢房|监房|禁闭|监牢|牢狱/,'fa:handcuffs'],[/职员室|教师室|教务处/,'fa:folder'],[/空间站|宇宙飞船/,'fa:rocket'],[/岛屿|岛/,'fa:umbrella-beach'],[/雪山|冰原|冻土/,'fa:snowflake'],[/火山|熔岩/,'fa:volcano'],[/湖/,'fa:water'],[/沙漠|荒漠/,'ti:cactus'],[/海沟/,'fa:water'],[/珊瑚/,'ti:fish'],[/沼泽|泥潭/,'ti:droplet'],[/王座|大殿/,'fa:crown'],[/驿站|驿馆/,'ti:horse'],[/大内/,'ti:building-castle'],[/墓地|坟场|乱葬岗/,'ti:grave'],[/地牢|地下城/,'ti:spider'],[/竞技场|决斗场/,'fa:swords'],[/仙山|灵山/,'fa:mountain'],[/灵脉|龙脉/,'ti:topology-star-3'],[/丹药|仙丹/,'fa:pills'],[/法宝|仙器/,'ti:flask'],[/阵法|法阵/,'ti:hexagon'],[/洞府|仙府/,'fa:mountain-sun'],[/渡劫|天劫/,'fa:bolt'],[/江湖|武林/,'ti:sword'],[/剑冢|兵器谱/,'fa:swords'],[/魔法阵|召唤阵/,'ti:wand'],[/炼金术|炼金/,'ti:flask'],[/魔杖|法杖/,'ti:wand'],[/魔法书|咒语书/,'fa:book-open'],[/触手|触须/,'ti:ripple'],[/禁书|秘典/,'fa:book-skull'],[/邪教|教团/,'ti:candle'],[/古神|旧神|外神/,'fa:eye'],[/义体/,'ti:robot'],[/全息/,'ti:device-projector'],[/数据中心|机房/,'fa:server'],[/芯片|晶片/,'fa:microchip'],[/scp|收容|单元/,'fa:shield-halved'],[/系统/,'fa:gear'],[/飞艇/,'ti:air-balloon'],[/齿轮/,'fa:gears'],[/蒸汽机|锅炉/,'ti:flask'],[/钟楼/,'ti:clock'],[/废土/,'fa:house-crack'],[/辐射/,'fa:radiation'],[/避难所|安全屋/,'ti:home-off'],[/拾荒/,'fa:recycle'],[/变异|变种/,'fa:biohazard'],[/星舰|战舰/,'fa:rocket'],[/太空港/,'fa:satellite'],[/虫洞|跃迁/,'fa:circle-notch'],[/外星人/,'ti:alien'],[/镜像世界/,'fa:clone'],[/阴阳界|彼岸/,'fa:scale-balanced'],[/黄泉|冥界/,'fa:skull'],[/招魂|降灵/,'ti:candle'],[/苔原|冻原/,'ti:snowflake'],[/雨林|热带/,'ti:palm'],[/竹林/,'ti:plant'],[/稀树草原/,'ti:deer'],[/荆棘/,'ti:cactus'],[/花海/,'ti:flower'],[/浮空岛|天空岛|高空/,'fa:cloud'],[/地心|地核/,'fa:fire'],[/菌类|蘑菇林/,'ti:mushroom'],[/暴风雪/,'fa:snowflake'],[/沙尘暴/,'fa:tornado'],[/龙卷风/,'fa:tornado'],[/流星雨/,'ti:meteor'],[/日食|月食/,'fa:moon'],[/酸雨|毒雨/,'fa:cloud-rain'],[/极光|星空/,'ti:stars'],[/锻造台|熔炉/,'fa:hammer'],[/附魔台/,'ti:sparkles'],[/工作台/,'ti:tool'],[/炼药台/,'ti:flask'],[/酿造台/,'ti:beer'],[/纺织机/,'ti:needle'],[/马厩|兽栏/,'ti:horse'],[/剧情物品|信物|关键|任务物品/,'fa:key'],[/文件|日记|书信|档案/,'fa:file-lines'],[/线索|痕迹|证据/,'fa:magnifying-glass'],[/钥匙|通行证|门卡/,'fa:id-card'],[/威胁|敌人|怪物|敌对/,'fa:skull'],[/陷阱|机关/,'fa:explosion'],[/野兽|猛兽/,'ti:paw'],[/恶魔|魔物/,'fa:skull'],[/龙套|警卫|店员|服务员/,'fa:user-tie'],[/路人|居民|村民/,'fa:user'],[/商人|老板/,'fa:shop'],[/地标|雕像|纪念碑/,'fa:monument'],[/机制|控制台|装置/,'fa:gears'],[/遗迹|废墟/,'fa:dungeon'],[/传送门|入口/,'fa:door-open'],[/火元素|烈焰/,'fa:fire'],[/水元素|寒冰/,'fa:droplet'],[/风元素|疾风/,'fa:wind'],[/土元素/,'fa:mountain'],[/雷元素/,'fa:bolt'],[/光元素|圣光/,'ti:sparkles'],[/暗元素|暗影/,'fa:moon'],[/时空/,'ti:clock'],[/樱花/,'ti:flower'],[/枫树|红枫/,'ti:leaf'],[/荷花|莲花/,'ti:flower'],[/玫瑰/,'ti:flower'],[/向日葵/,'ti:flower'],[/蝴蝶/,'ti:butterfly'],[/蜜蜂/,'ti:bug'],[/蝙蝠/,'ti:bat'],[/乌鸦|渡鸦/,'ti:feather'],[/凤凰|火鸟/,'fa:fire'],[/白鸽/,'ti:feather'],[/猫/,'ti:cat'],[/兔子/,'ti:deer'],[/boss|首领|魔王/,'ti:skull'],[/亡灵|丧尸|僵尸|骷髅/,'fa:skull'],[/野兽/,'ti:paw'],[/史莱姆|软泥/,'fa:droplet'],[/恶魔/,'fa:skull'],[/机器人|机甲/,'fa:robot'],[/金币|钱袋/,'fa:coins'],[/宝石|钻石/,'fa:gem'],[/水晶/,'fa:gem'],[/药水|药剂/,'fa:flask'],[/钥匙|门卡/,'fa:key'],[/地图/,'fa:map'],[/宝箱/,'fa:box'],[/布料|布/,'ti:shirt'],[/剑/,'ti:sword'],[/弩/,'ti:bow'],[/枪/,'fa:gun'],[/血迹|血泊/,'fa:droplet'],[/脚印/,'ti:shoe'],[/尸体|残骸/,'fa:skull-crossbones'],[/迷雾/,'ti:mist'],[/燃烧|着火/,'fa:fire'],[/冰冻|结冰/,'ti:snowflake'],[/中毒/,'ti:flask-off'],[/流血|出血/,'fa:droplet'],[/眩晕|昏迷/,'ti:stars'],[/沉默/,'ti:volume-off'],[/虚弱|衰弱/,'ti:mood-sad'],[/狂暴|狂怒/,'ti:mood-angry'],[/隐身|潜行/,'fa:ghost'],[/温馨|温暖/,'ti:heart'],[/恐怖|惊悚/,'ti:ghost'],[/浪漫|甜蜜/,'fa:heart'],[/紧张|压迫/,'ti:alert-triangle'],[/平和|宁静/,'ti:leaf'],[/激烈|热血/,'ti:flame'],[/悲伤|哀愁/,'ti:mood-sad'],[/欢乐|喜庆/,'fa:party-horn'],[/孤独|寂寥/,'ti:mood-empty'],[/神像/,'fa:floppy-disk'],[/楼梯|梯子/,'ti:stairs'],[/椅子|沙发/,'ti:armchair'],[/床|铺/,'fa:bed'],[/挂钩/,'ti:hanger'],[/桌/,'ti:table'],[/柜/,'fa:box'],[/墙/,'ti:wall'],[/板|牌/,'fa:chalkboard'],[/显示器|显示屏|电脑|服务器|终端|面板|数据/,'fa:desktop'],[/摄像/,'fa:video'],[/信号/,'fa:satellite-dish'],[/窗户|窗/,'ti:window'],[/电梯/,'ti:escalator'],[/机关|装置/,'fa:gears'],[/锁|封印/,'fa:lock'],[/门|大门|入口|出口/,'fa:door-open'],[/街道|街角|马路|街/,'fa:person-walking'],[/巷/,'ti:lane'],[/桥|桥梁/,'fa:bridge'],[/广场/,'fa:square-full'],[/边境/,'fa:flag'],[/走廊|过道|玄关|通道/,'ti:shoe'],[/宿舍|寝室/,'fa:building'],[/房间|卧室/,'fa:bed'],[/室/,'fa:door-closed'],[/庭院|院子/,'ti:plant'],[/门廊/,'fa:door-open'],[/商业街/,'fa:bag-shopping'],[/商城|购物中心/,'fa:building'],[/旅馆|客栈|酒店|招待所/,'fa:hotel'],[/便利店|超市|商店/,'fa:store'],[/餐厅|饭店|食堂/,'fa:utensils'],[/咖啡|茶室/,'fa:mug-hot'],[/酒吧|夜店/,'fa:wine-glass'],[/演唱会|演出/,'fa:guitar'],[/仓库|储藏/,'fa:warehouse'],[/医院|诊所/,'fa:hospital'],[/银行|金库|总行|分行/,'fa:building-columns'],[/办公|写字楼|公司/,'fa:briefcase'],[/海滩|海边|海岸|沙滩/,'fa:umbrella-beach'],[/海洋|深海/,'fa:water'],[/瀑布|河流|溪流/,'fa:droplet'],[/洞穴|山洞/,'fa:circle-dot'],[/森林|树林|丛林|树/,'fa:tree'],[/草原|平原|草地/,'ti:plant'],[/山脉|悬崖|山顶/,'fa:mountain'],[/公园|花园/,'fa:tree'],[/基地|营地/,'fa:campground'],[/楼/,'fa:building'],[/王宫|皇宫/,'fa:crown'],[/宫殿/,'fa:building-columns'],[/城堡|要塞/,'fa:chess-rook'],[/教堂|修道院/,'fa:church'],[/神社|神殿|寺庙|圣殿/,'fa:place-of-worship'],[/遗迹|废墟/,'fa:building-columns'],[/迷宫/,'ti:spider'],[/塔|高塔|灯塔/,'ti:tower'],[/公会/,'fa:shield-halved'],[/魔法|法师/,'ti:wand'],[/教学楼|教室/,'fa:school'],[/图书馆/,'fa:book'],[/服务台|接待台/,'fa:bell-concierge'],[/体育馆|操场|训练场/,'ti:run'],[/博物馆|展览|礼堂/,'fa:building-columns'],[/学院|学校|学园|小学/,'fa:school'],[/看守/,'fa:eye'],[/黑影|黑衣人/,'fa:user-secret'],[/商人|店主/,'fa:coins'],[/访客|游客|嘉宾/,'fa:user'],[/守卫|士兵|骑士/,'fa:shield-halved'],[/龙套|路人|村民/,'fa:users'],[/粮仓|粮食|谷物/,'ti:wheat'],[/武器|剑|刀|枪/,'fa:swords'],[/防具|盾|盔甲/,'ti:shirt'],[/食物|料理/,'ti:meat'],[/书信|纸条|笔记|纸/,'fa:file'],[/铁/,'fa:link'],[/蛋糕|甜点|点心|果子/,'ti:cake'],[/酒/,'fa:wine-glass'],[/鱼/,'ti:fish'],[/饼/,'ti:bread'],[/面包/,'ti:bread'],[/茶|饮料/,'ti:cup'],[/照片/,'fa:camera'],[/玩偶|毛绒|玩具/,'fa:gamepad'],[/手机/,'fa:mobile'],[/包装/,'fa:gift'],[/手册|指南/,'fa:book'],[/任务/,'fa:clipboard-list'],[/羊皮/,'fa:scroll'],[/行李|箱包/,'fa:suitcase'],[/物品|道具/,'fa:bag-shopping'],[/工具|器具/,'fa:screwdriver-wrench'],[/光|光源|灯/,'fa:lightbulb'],[/痕迹|踪迹/,'ti:shoe'],[/烟雾|毒气/,'ti:mist'],[/护盾|力场/,'fa:shield-halved'],[/加速/,'fa:wind'],[/再生|恢复/,'fa:heart'],[/异界|虚空|传送/,'fa:circle-notch'],[/神秘|诡异/,'fa:eye'],[/城市|城镇|小镇|村庄|社区/,'fa:city'],[/公寓|住所|家|住宅|别墅|合宿/,'fa:house'],[/阁楼|顶层/,'fa:house'],[/心理|脑/,'fa:brain'],[/生物|基因/,'fa:dna'],[/检测|调查/,'fa:magnifying-glass'],[/舞蹈/,'ti:walk'],[/环境|石|木|金属|障碍/,'fa:mountain']],n=t,e=t,a=[{icon:'fa:heart',keywords:['恋人','恋爱','爱情','恋情','情侣','男友','女友','暗恋','单恋','心动','喜欢','爱慕','倾心','钟情','情人','爱人','恋慕','倾慕']},{icon:'fa:ring',keywords:['丈夫','妻子','夫妻','配偶','伴侣','结婚','婚姻','夫君','娘子','老公','老婆']},{icon:'fa:child',keywords:['青梅','竹马','发小','总角','儿时','童年']},{icon:'fa:people-roof',keywords:['家人','亲人','父母','父亲','母亲','兄弟','姐妹','兄妹','姐弟','儿子','女儿','爷爷','奶奶','外公','外婆','叔叔','阿姨','表亲','堂亲','血亲']},{icon:'fa:star',keywords:['挚友','密友','至交','闺蜜','死党','知己','莫逆','铁杆','世交','心腹','刎颈','金兰']},{icon:'fa:user-group',keywords:['朋友','友人','好友','友情','伙伴','队友','战友','同伴','盟友','故交','旧识','玩伴']},{icon:'fa:handshake-angle',keywords:['搭档','拍档','合伙','协作','配合']},{icon:'fa:shield-heart',keywords:['信赖','信任','信靠','依托','依赖','依附','依靠']},{icon:'fa:house-user',keywords:['室友','合租','同住','屋檐']},{icon:'fa:graduation-cap',keywords:['师父','师傅','徒弟','师徒','老师','学生','导师','弟子','门生','同学','同窗','同级','同班','前辈','后辈','学长','学姐','学弟','学妹']},{icon:'fa:compass',keywords:['向导','指引','引路','领路','导航','顾问']},{icon:'fa:file-signature',keywords:['契约','合同','婚约','誓约','约定','束缚','缔结','主仆','服从']},{icon:'fa:handshake',keywords:['交易','合作','生意','客户','商业','利益','雇佣','共犯']},{icon:'fa:gavel',keywords:['定罪','审判','判决','问责','制裁','惩罚','罪人','裁决','刑罚','处决','处刑','治罪']},{icon:'fa:thumbs-up',keywords:['感激','感谢','报恩','谢意','恩情','铭记','恩人']},{icon:'fa:hand-holding-heart',keywords:['同情','怜悯','体谅','哀怜','惋惜','宽恕','慰藉','关怀']},{icon:'fa:eye',keywords:['兴趣','好奇','关注','有趣','意趣','感兴趣','观察']},{icon:'ti:swords',keywords:['对手','竞争','劲敌','宿敌','情敌','死对头','冤家','敌手','对头','对峙','争锋','较量']},{icon:'fa:skull',keywords:['敌人','仇人','仇恨','敌对','仇敌','死敌','憎恨','怨恨','仇怨','敌意']},{icon:'ti:ghost',keywords:['恐惧','害怕','畏惧','忌惮','恐慌','惊恐','惧怕','阴影','梦魇','噩梦']},{icon:'fa:thumbs-down',keywords:['厌恶','讨厌','嫌弃','恶心','反感','鄙视','唾弃','不屑','憎恶','轻视','嫌恶']},{icon:'fa:ban',keywords:['排斥','拒绝','疏远','抵触','隔离','冷落','孤立','对立','隔阂']},{icon:'fa:hands-praying',keywords:['信仰','崇拜','敬仰','仰慕','追随','信徒','教徒','狂信','粉丝','迷弟','迷妹']},{icon:'fa:face-meh',keywords:['中立','无感','冷漠','路人','旁观','互不','陌生','无论','熟人','认识','面熟']},{icon:'ti:circles-relation',keywords:['复杂','微妙','纠葛','羁绊','纠缠']},{icon:'fa:link',keywords:['共鸣','共情','同感','心灵相通','灵魂共振','心意相通','默契']},{icon:'fa:crosshairs',keywords:['执着','执念','偏执','痴迷','沉迷','狂热','专注','迷恋']},{icon:'fa:medal',keywords:['赏识','欣赏','器重','看重','青睐','认可','肯定','重视']}],o={retro:{bgNav:'#e6e2d3',bgPanel:'#e6e2d3',border:'#dcd0c0',textMain:'#5e4b35',textSub:'#999',btnBg:'#dcd0c0',btnHover:'#cbbba8',btnActiveBg:'#8d7b6f',btnActiveText:'#fdfaf5',accent:'#7a695f',inputBg:'#f5f2eb'},dark:{bgNav:'#2b2b2b',bgPanel:'#252525',border:'#444',textMain:'#eee',textSub:'#aaa',btnBg:'#3a3a3a',btnHover:'#4a4a4a',btnActiveBg:'#6a5acd',btnActiveText:'#fff',accent:'#9b8cd9',inputBg:'#3a3a3a'},modern:{bgNav:'#ffffff',bgPanel:'#f8f9fa',border:'#e0e0e0',textMain:'#333',textSub:'#666',btnBg:'#f1f3f5',btnHover:'#e9ecef',btnActiveBg:'#007bff',btnActiveText:'#fff',accent:'#007bff',inputBg:'#f1f3f5'},forest:{bgNav:'#e8f5e9',bgPanel:'#e8f5e9',border:'#c8e6c9',textMain:'#2e7d32',textSub:'#81c784',btnBg:'#c8e6c9',btnHover:'#a5d6a7',btnActiveBg:'#43a047',btnActiveText:'#fff',accent:'#4caf50',inputBg:'#c8e6c9'},ocean:{bgNav:'#e3f2fd',bgPanel:'#e3f2fd',border:'#90caf9',textMain:'#1565c0',textSub:'#64b5f6',btnBg:'#bbdefb',btnHover:'#90caf9',btnActiveBg:'#1976d2',btnActiveText:'#fff',accent:'#2196f3',inputBg:'#bbdefb'},cyber:{bgNav:'#000000',bgPanel:'#0a0a0a',border:'#333',textMain:'#00ffcc',textSub:'#ff00ff',btnBg:'#111',btnHover:'#222',btnActiveBg:'#ff00ff',btnActiveText:'#000',accent:'#00ffcc',inputBg:'#111'},nightowl:{bgNav:'#0a2133',bgPanel:'#011627',border:'#132e45',textMain:'#e0e6f2',textSub:'#a6b8cc',btnBg:'#1f3a52',btnHover:'#2a4a68',btnActiveBg:'#7fdbca',btnActiveText:'#011627',accent:'#7fdbca',inputBg:'#1f3a52'},sakura:{bgNav:'#F9F0EF',bgPanel:'#F9F0EF',border:'#EBDCD9',textMain:'#6B5552',textSub:'#C08D8D',btnBg:'#EBDCD9',btnHover:'#D8C7C4',btnActiveBg:'#C08D8D',btnActiveText:'#F9F0EF',accent:'#C08D8D',inputBg:'#EBDCD9'},minepink:{bgNav:'#1a1a1a',bgPanel:'#1a1a1a',border:'#333333',textMain:'#ffb3d9',textSub:'#ff80c1',btnBg:'#2a2a2a',btnHover:'#3a3a3a',btnActiveBg:'#ff80c1',btnActiveText:'#1a1a1a',accent:'#ff80c1',inputBg:'#2a2a2a'},purple:{bgNav:'#f3e5f5',bgPanel:'#f3e5f5',border:'#ce93d8',textMain:'#6a1b9a',textSub:'#9c27b0',btnBg:'#e1bee7',btnHover:'#ce93d8',btnActiveBg:'#9c27b0',btnActiveText:'#fff',accent:'#9c27b0',inputBg:'#e1bee7'},wechat:{bgNav:'#F7F7F7',bgPanel:'#F7F7F7',border:'#E5E5E5',textMain:'#333333',textSub:'#666666',btnBg:'#E5E5E5',btnHover:'#D5D5D5',btnActiveBg:'#09B83E',btnActiveText:'#FFFFFF',accent:'#09B83E',inputBg:'#E5E5E5'},educational:{bgNav:'#000000',bgPanel:'#000000',border:'#1B1B1B',textMain:'#FFFFFF',textSub:'#CCCCCC',btnBg:'#1B1B1B',btnHover:'#2B2B2B',btnActiveBg:'#FF9900',btnActiveText:'#000000',accent:'#FF9900',inputBg:'#1B1B1B'},vaporwave:{bgNav:'#191970',bgPanel:'#191970',border:'rgba(0,255,255,0.3)',textMain:'#00FFFF',textSub:'#FF00FF',btnBg:'rgba(25,25,112,0.8)',btnHover:'rgba(0,255,255,0.2)',btnActiveBg:'#FF00FF',btnActiveText:'#191970',accent:'#00FFFF',inputBg:'rgba(25,25,112,0.6)'},classicpackaging:{bgNav:'#000000',bgPanel:'#000000',border:'#FFFF00',textMain:'#FFFF00',textSub:'#CCCC00',btnBg:'#FF0000',btnHover:'#CC0000',btnActiveBg:'#0000FF',btnActiveText:'#FFFF00',accent:'#FF0000',inputBg:'#1a1a1a'},galgame:{bgNav:'#FFF0F5',bgPanel:'#FFF0F5',border:'#F0D4E4',textMain:'#6B4A5A',textSub:'#B08A9A',btnBg:'#FFE4E9',btnHover:'#FFD4E4',btnActiveBg:'#E8B4D9',btnActiveText:'#6B4A5A',accent:'#E8B4D9',inputBg:'#FFF8FA'},terminal:{bgNav:'#0c0c0c',bgPanel:'#0c0c0c',border:'#00ff00',textMain:'#00ff00',textSub:'#00cc00',btnBg:'#1a1a1a',btnHover:'#2a2a2a',btnActiveBg:'#00ff00',btnActiveText:'#0c0c0c',accent:'#00ff00',inputBg:'#0c0c0c'},dreamcore:{bgNav:'#F4F1EA',bgPanel:'#F4F1EA',border:'#D6D2C4',textMain:'#5C5869',textSub:'#9490A0',btnBg:'#E6E1D5',btnHover:'#DBD8CC',btnActiveBg:'#8A9AC6',btnActiveText:'#FFFFFF',accent:'#8A9AC6',inputBg:'#FFFFFF'},aurora:{bgNav:'linear-gradient(135deg,#0f172a,#1e293b)',bgPanel:'linear-gradient(180deg,#0f172a 0%,#334155 100%)',border:'#38bdf8',textMain:'#e2e8f0',textSub:'#94a3b8',btnBg:'linear-gradient(135deg,#162a3d,#25224d)',btnHover:'linear-gradient(135deg,#1e3a5f,#312e81)',btnActiveBg:'linear-gradient(135deg,#38bdf8,#a855f7)',btnActiveText:'#fff',accent:'#38bdf8',inputBg:'#0f172a'},chouten:{bgNav:'linear-gradient(135deg,rgba(26,10,46,0.95) 0%,rgba(45,27,78,0.95) 50%,rgba(26,10,46,0.95) 100%)',bgPanel:'rgba(26,10,46,0.95)',border:'#FF7EB6',textMain:'#FFFFFF',textSub:'#D0BFFF',btnBg:'rgba(255,255,255,0.1)',btnHover:'rgba(255,107,157,0.3)',btnActiveBg:'linear-gradient(90deg,#FF6B9D,#B388FF)',btnActiveText:'#FFFFFF',accent:'#7FFFD4',inputBg:'rgba(0,0,0,0.3)'}};function i(t,n){try{const e=t=>{try{return t?.jQuery}catch{return null}},a=[e(window),e(window.parent),e(window.top)].filter((t,n,e)=>!!t&&e.indexOf(t)===n);if(!a.length)return;const i=o[t]||o.aurora,r=new Set(['cyber','terminal','aurora','chouten','classicpackaging']).has(t),c=r?'invert(1) brightness(1.05)':'none',s=r?'0.85':'0.55',l=r?'dark':'light',d='#shujuku_v104-popup.auto-card-updater-popup, [id^="shujuku"][id$="-popup"].auto-card-updater-popup',u='#shujuku_v104-main-window, [id^="shujuku"][id$="-main-window"]',p=`${d}, ${u}, ${'#shujuku_v104-visualizer-window, [id^="shujuku"][id$="-visualizer-window"]'}`,f=`${d}, ${u}`,g=`\n      <style id="dice-db-theme-sync">\n        ${n?`\n        /* 字体同步：覆盖数据库文本字体（避免影响图标字体 / pseudo-element 图标） */\n        html body .auto-card-updater-popup,\n        html body #shujuku_v104-main-window,\n        html body [id^="shujuku"][id$="-main-window"],\n        html body #shujuku_v104-popup.auto-card-updater-popup,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup {\n          --acu-font-family: ${n};\n          font-family: var(--acu-font-family) !important;\n        }\n\n        html body .auto-card-updater-popup :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body #shujuku_v104-main-window :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body [id^="shujuku"][id$="-main-window"] :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body #shujuku_v104-popup.auto-card-updater-popup :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em) {\n          font-family: var(--acu-font-family) !important;\n        }\n      `:''}\n        html body .auto-card-updater-popup {\n          --acu-bg-0: ${i.bgPanel} !important;\n          --acu-bg-1: ${i.bgNav} !important;\n          --acu-bg-2: ${i.btnBg} !important;\n          --acu-border: ${i.border} !important;\n          --acu-border-2: ${i.border} !important;\n          --acu-text-1: ${i.textMain} !important;\n          --acu-text-2: ${i.textSub} !important;\n          --acu-text-3: ${i.textSub} !important;\n          --acu-accent: ${i.accent} !important;\n          --acu-accent-glow: ${i.accent}1a !important;\n        }\n        /* ========== 按钮系统美化 ========== */\n        html body .auto-card-updater-popup button,\n        html body .auto-card-updater-popup .button {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 8px !important;\n          padding: 8px 16px !important;\n          font-weight: 500 !important;\n          cursor: pointer !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n          position: relative !important;\n        }\n        \n        /* 普通按钮悬停效果 */\n        html body .auto-card-updater-popup button:hover,\n        html body .auto-card-updater-popup .button:hover {\n          background: ${i.btnHover} !important;\n          transform: translateY(-2px) !important;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;\n        }\n        \n        /* 普通按钮点击效果 */\n        html body .auto-card-updater-popup button:active,\n        html body .auto-card-updater-popup .button:active {\n          transform: translateY(0) scale(0.98) !important;\n          box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1) !important;\n          transition-duration: 0.1s !important;\n        }\n        \n        /* Primary 按钮 - 更强的视觉权重 */\n        html body .auto-card-updater-popup button.primary,\n        html body .auto-card-updater-popup .button.primary {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border-color: ${i.btnActiveBg} !important;\n          font-weight: 600 !important;\n          box-shadow: 0 2px 8px ${i.accent}33 !important;\n        }\n        \n        /* Primary 按钮悬停效果 */\n        html body .auto-card-updater-popup button.primary:hover,\n        html body .auto-card-updater-popup .button.primary:hover {\n          transform: translateY(-2px) !important;\n          box-shadow: 0 6px 20px ${i.accent}44 !important;\n          filter: brightness(1.1) !important;\n        }\n        \n        /* Primary 按钮点击效果 */\n        html body .auto-card-updater-popup button.primary:active,\n        html body .auto-card-updater-popup .button.primary:active {\n          transform: translateY(0) scale(0.98) !important;\n          box-shadow: 0 2px 8px ${i.accent}22 !important;\n          filter: brightness(0.95) !important;\n        }\n        \n        /* 禁用状态按钮 */\n        html body .auto-card-updater-popup button:disabled,\n        html body .auto-card-updater-popup .button:disabled {\n          opacity: 0.5 !important;\n          cursor: not-allowed !important;\n          transform: none !important;\n          box-shadow: none !important;\n        }\n        /* button-group 内按钮 - 继承基础样式即可，不需要重复定义 */\n        html body :is(${d}) .button-group.acu-data-mgmt-buttons button,\n        html body :is(${d}) .button-group.acu-data-mgmt-buttons .button {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n        html body :is(${d}) .button-group.acu-data-mgmt-buttons button:hover,\n        html body :is(${d}) .button-group.acu-data-mgmt-buttons .button:hover {\n          background: ${i.btnHover} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup code,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup code {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-left: 2px solid ${i.accent} !important;\n        }\n        html body :is(${d}) table thead th,\n        html body :is(${d}) table th {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border-color: ${i.border} !important;\n        }\n\n        /* ========== 弹窗容器美化 ========== */\n        html body :is(${p}) {\n          border-radius: 16px !important;\n          box-shadow: \n            0 25px 50px -12px rgba(0, 0, 0, 0.25),\n            0 0 0 1px ${i.border},\n            0 0 40px -10px ${i.accent}33 !important;\n          animation: acu-db-popup-enter 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;\n        }\n\n        @keyframes acu-db-popup-enter {\n          from {\n            opacity: 0;\n            transform: scale(0.95) translateY(10px);\n          }\n          to {\n            opacity: 1;\n            transform: scale(1) translateY(0);\n          }\n        }\n\n        /* ========== 头部样式 (使用 :is() 简化选择器) ========== */\n        html body :is(${f}) {\n          padding-top: 0 !important;\n        }\n\n        html body :is(${f}) .acu-layout {\n          margin-top: 0 !important;\n        }\n\n        html body :is(${p}) .acu-window-header {\n          background: linear-gradient(135deg, ${i.bgNav} 0%, ${i.bgPanel} 100%) !important;\n          border-bottom: 1px solid ${i.border} !important;\n          color: ${i.textMain} !important;\n          padding: 14px 18px !important;\n          position: relative !important;\n          margin: 0 !important;\n          z-index: 32012 !important;\n        }\n\n        /* 头部底部高光线 */\n        html body :is(${p}) .acu-window-header::after {\n          content: '' !important;\n          position: absolute !important;\n          bottom: 0 !important;\n          left: 50% !important;\n          transform: translateX(-50%) !important;\n          width: 60% !important;\n          height: 1px !important;\n          background: linear-gradient(90deg, transparent, ${i.accent}66, transparent) !important;\n        }\n\n        /* 标题文字 */\n        html body :is(${p}) .acu-window-title,\n        html body :is(${p}) .acu-window-title span {\n          color: ${i.textMain} !important;\n          font-weight: 600 !important;\n          letter-spacing: 0.3px !important;\n        }\n\n        /* 标题图标 */\n        html body :is(${p}) .acu-window-title i {\n          color: ${i.accent} !important;\n          transition: transform 0.3s ease, color 0.2s ease !important;\n        }\n\n        /* 标题图标悬停动画 */\n        html body :is(${p}) .acu-window-header:hover .acu-window-title i {\n          transform: rotate(15deg) scale(1.1) !important;\n        }\n\n        /* 窗口按钮 */\n        html body :is(${p}) .acu-window-btn {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 8px !important;\n          padding: 6px 10px !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        html body :is(${p}) .acu-window-btn:hover {\n          background: ${i.btnHover} !important;\n          color: ${i.textMain} !important;\n          transform: translateY(-1px) !important;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;\n        }\n\n        html body :is(${p}) .acu-window-btn.close:hover {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          box-shadow: 0 2px 12px ${i.accent}44 !important;\n        }\n\n        html body :is(${d}) .acu-stepper {\n          background-color: ${i.inputBg} !important;\n          border-color: ${i.border} !important;\n        }\n        html body :is(${d}) .acu-stepper-btn {\n          background-color: ${i.btnBg} !important;\n          color: ${i.textSub} !important;\n        }\n        html body :is(${d}) .acu-stepper-btn:hover {\n          background-color: ${i.btnHover} !important;\n          color: ${i.accent} !important;\n        }\n        html body :is(${d}) .acu-stepper-btn:active {\n          background-color: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n        }\n        html body :is(${d}) .acu-stepper-value {\n          background-color: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border-left: 1px solid ${i.border} !important;\n          border-right: 1px solid ${i.border} !important;\n        }\n        html body :is(${d}) input[type="number"] {\n          color-scheme: ${l} !important;\n        }\n        html body :is(${d}) input[type="number"]::-webkit-inner-spin-button,\n        html body :is(${d}) input[type="number"]::-webkit-outer-spin-button {\n          filter: ${c} !important;\n          opacity: ${s} !important;\n        }\n        /* ========== 表单控件美化 ========== */\n        html body .auto-card-updater-popup :is(input, select, textarea),\n        html body :is(${d}) :is(input, select, textarea) {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          background-image: none !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-color: ${i.border} !important;\n          box-shadow: none !important;\n          text-shadow: none !important;\n          border-radius: 6px !important;\n          padding: 8px 12px !important;\n          font-size: 14px !important;\n          transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease !important;\n        }\n\n        /* 输入框聚焦效果 - 增强版 */\n        html body .auto-card-updater-popup :is(input, select, textarea):focus,\n        html body :is(${d}) :is(input, select, textarea):focus {\n          border-color: ${i.accent} !important;\n          box-shadow: 0 0 0 3px ${i.accent}22, 0 2px 8px rgba(0, 0, 0, 0.08) !important;\n          outline: none !important;\n        }\n\n        /* 输入框悬停效果 */\n        html body .auto-card-updater-popup :is(input, select, textarea):hover:not(:focus),\n        html body :is(${d}) :is(input, select, textarea):hover:not(:focus) {\n          border-color: ${i.accent}66 !important;\n        }\n\n        /* 修复 placeholder 颜色 */\n        html body .auto-card-updater-popup :is(input, textarea)::placeholder,\n        html body :is(${d}) :is(input, textarea)::placeholder {\n          color: ${i.textSub} !important;\n          opacity: 0.6 !important;\n          transition: opacity 0.2s ease !important;\n        }\n\n        /* placeholder 聚焦时淡化 */\n        html body .auto-card-updater-popup :is(input, textarea):focus::placeholder,\n        html body :is(${d}) :is(input, textarea):focus::placeholder {\n          opacity: 0.4 !important;\n        }\n\n        /* ========== Select 下拉框美化 ========== */\n        html body .auto-card-updater-popup select,\n        html body :is(${d}) select {\n          appearance: none !important;\n          -webkit-appearance: none !important;\n          padding-right: 36px !important;\n          cursor: pointer !important;\n          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;\n          background-repeat: no-repeat !important;\n          background-position: right 12px center !important;\n          background-size: 12px !important;\n        }\n\n        /* Select 悬停时箭头颜色变化 */\n        html body .auto-card-updater-popup select:hover,\n        html body :is(${d}) select:hover {\n          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='${encodeURIComponent(i.accent)}' d='M6 8L1 3h10z'/%3E%3C/svg%3E") !important;\n        }\n\n        /* ========== Textarea 美化 ========== */\n        html body .auto-card-updater-popup textarea,\n        html body :is(${d}) textarea {\n          min-height: 80px !important;\n          resize: vertical !important;\n          line-height: 1.5 !important;\n        }\n\n        /* ========== 数据隔离区专用布局修复 ========== */\n        html body :is(${d}) [id$="-data-isolation-input-area"] {\n          margin-top: 12px !important;\n        }\n\n        html body :is(${d}) [id$="-data-isolation-input-area"] > div {\n          display: flex !important;\n          align-items: stretch !important;\n          gap: 12px !important;\n          margin-top: 8px !important;\n        }\n\n        html body :is(${d}) [id$="-data-isolation-combo"] {\n          position: relative !important;\n          flex: 1 1 auto !important;\n          min-width: 0 !important;\n          display: block !important;\n        }\n\n        html body :is(${d}) [id$="-data-isolation-code"] {\n          width: 100% !important;\n          min-height: 44px !important;\n          padding-right: 52px !important;\n        }\n\n        html body :is(${d}) button[id$="-data-isolation-history-toggle"] {\n          position: absolute !important;\n          right: 8px !important;\n          top: 50% !important;\n          transform: translateY(-50%) !important;\n          width: 34px !important;\n          min-width: 34px !important;\n          height: 34px !important;\n          min-height: 34px !important;\n          padding: 0 !important;\n          border-radius: 8px !important;\n          border: 1px solid ${i.border} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          line-height: 1 !important;\n          font-size: 13px !important;\n          display: inline-flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n          box-shadow: none !important;\n          z-index: 2 !important;\n        }\n\n        html body :is(${d}) button[id$="-data-isolation-history-toggle"]:hover {\n          background: ${i.btnHover} !important;\n          color: ${i.accent} !important;\n          transform: translateY(-50%) !important;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.14) !important;\n        }\n\n        html body :is(${d}) [id$="-data-isolation-history-list"] {\n          margin: 0 !important;\n          padding: 6px !important;\n          border-radius: 10px !important;\n          border: 1px solid ${i.border} !important;\n          background: ${i.bgPanel} !important;\n          box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18) !important;\n          max-height: 240px !important;\n          z-index: 32030 !important;\n        }\n\n        html body :is(${d}) [id$="-data-isolation-history-list"] li {\n          color: ${i.textMain} !important;\n          border-radius: 6px !important;\n        }\n\n        html body :is(${d}) [id$="-data-isolation-history-list"] li:hover {\n          background: ${i.btnHover} !important;\n        }\n\n        /* ========== 模板预设工具栏统一样式 ========== */\n        html body :is(${d}) .acu-template-presets {\n          border: 1px solid ${i.border} !important;\n          background: ${i.bgPanel} !important;\n          border-radius: 12px !important;\n          box-shadow: 0 8px 22px rgba(0, 0, 0, 0.08) !important;\n        }\n\n        html body :is(${d}) .acu-template-preset-toolbar {\n          display: flex !important;\n          flex-direction: column !important;\n          gap: 12px !important;\n          align-items: stretch !important;\n        }\n\n        html body :is(${d}) .acu-template-preset-toolbar .acu-template-preset-left {\n          display: grid !important;\n          grid-template-columns: minmax(220px, 1fr) auto auto !important;\n          align-items: center !important;\n          gap: 10px !important;\n          width: 100% !important;\n        }\n\n        html body :is(${d}) .acu-template-preset-toolbar .acu-template-preset-actions {\n          display: grid !important;\n          grid-template-columns: repeat(4, minmax(108px, 1fr)) !important;\n          gap: 10px !important;\n          width: 100% !important;\n          align-items: stretch !important;\n        }\n\n        html body :is(${d}) .acu-template-preset-toolbar :is(select.text_pole, [id$="-template-preset-select"]) {\n          min-height: 44px !important;\n        }\n\n        html body :is(${d}) .acu-mini-btn {\n          min-height: 44px !important;\n          padding: 10px 14px !important;\n          border-radius: 10px !important;\n          border: 1px solid ${i.border} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          font-size: 15px !important;\n          font-weight: 650 !important;\n          letter-spacing: 0.1px !important;\n          display: inline-flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n          gap: 8px !important;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;\n          transition: transform 0.18s ease, box-shadow 0.18s ease, background-color 0.18s ease, border-color 0.18s ease !important;\n        }\n\n        html body :is(${d}) .acu-mini-btn:hover {\n          background: ${i.btnHover} !important;\n          border-color: ${i.accent}66 !important;\n          color: ${i.textMain} !important;\n          transform: translateY(-1px) !important;\n          box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12) !important;\n        }\n\n        html body :is(${d}) .acu-mini-btn:active {\n          transform: translateY(0) scale(0.98) !important;\n          box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1) !important;\n        }\n\n        html body :is(${d}) .acu-mini-btn.primary {\n          background: ${i.btnActiveBg} !important;\n          border-color: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          box-shadow: 0 8px 20px ${i.accent}33 !important;\n        }\n\n        html body :is(${d}) .acu-mini-btn.primary:hover {\n          filter: brightness(1.08) !important;\n        }\n\n        html body :is(${d}) button[id$="-template-preset-delete"].acu-mini-btn,\n        html body :is(${d}) .acu-mini-btn.danger {\n          border-color: ${i.border} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;\n        }\n\n        html body :is(${d}) button[id$="-data-isolation-save"].primary {\n          min-height: 44px !important;\n          padding: 10px 18px !important;\n          white-space: nowrap !important;\n          border-radius: 10px !important;\n          background: ${i.textMain} !important;\n          border-color: ${i.textMain} !important;\n          color: ${i.bgPanel} !important;\n          font-weight: 700 !important;\n          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18) !important;\n        }\n\n        html body :is(${d}) button[id$="-data-isolation-save"].primary:hover {\n          background: ${i.accent} !important;\n          border-color: ${i.accent} !important;\n          color: ${i.btnActiveText} !important;\n        }\n\n        html body :is(${d}) button[id$="-data-isolation-delete-entries"] {\n          min-height: 42px !important;\n          min-width: 280px !important;\n          padding: 10px 18px !important;\n          border-radius: 10px !important;\n          border: 1px solid ${i.border} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          font-weight: 650 !important;\n          letter-spacing: 0.1px !important;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08) !important;\n        }\n\n        html body :is(${d}) button[id$="-data-isolation-delete-entries"]:hover {\n          background: ${i.btnHover} !important;\n          border-color: ${i.accent}66 !important;\n          color: ${i.textMain} !important;\n          box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12) !important;\n          transform: translateY(-1px) !important;\n          filter: none !important;\n        }\n\n        html body :is(${d}) button[id$="-data-isolation-delete-entries"]:active {\n          transform: translateY(0) scale(0.98) !important;\n          box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1) !important;\n          filter: none !important;\n        }\n\n        /* Textarea resize 手柄样式 */\n        html body .auto-card-updater-popup textarea::-webkit-resizer,\n        html body :is(${d}) textarea::-webkit-resizer {\n          border-width: 8px !important;\n          border-style: solid !important;\n          border-color: transparent ${i.border} ${i.border} transparent !important;\n        }\n\n        /* ========== 禁用状态 ========== */\n        html body .auto-card-updater-popup :is(input, select, textarea):disabled,\n        html body :is(${d}) :is(input, select, textarea):disabled {\n          opacity: 0.5 !important;\n          cursor: not-allowed !important;\n          background-color: ${i.bgNav} !important;\n        }\n\n        /* ========== Checkbox 强化覆盖 ========== */\n        /* Checkbox Container (Group) */\n        html body :is(${d}) .checkbox-group {\n          background-color: transparent !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* Checkbox Label */\n        html body :is(${d}) .checkbox-group label {\n          color: ${i.textMain} !important;\n        }\n\n        /* Checkbox Input Element (统一自绘，压制酒馆主题/脚本自绘) */\n        html body :is(${d}) input[type="checkbox"],\n        html body :is(${d}) .checkbox-group input[type="checkbox"] {\n          -webkit-appearance: none !important;\n          appearance: none !important;\n          width: 18px !important;\n          height: 18px !important;\n          min-width: 18px !important;\n          min-height: 18px !important;\n          border-radius: 5px !important;\n          border: 1.5px solid ${i.border} !important;\n          background-color: ${i.inputBg} !important;\n          background-image: none !important;\n          background-repeat: no-repeat !important;\n          background-position: center !important;\n          background-size: 12px 10px !important;\n          box-shadow: none !important;\n          padding: 0 !important;\n          margin: 2px 8px 2px 0 !important;\n          cursor: pointer !important;\n          vertical-align: middle !important;\n          transition: all 0.2s ease !important;\n        }\n        html body :is(${d}) input[type="checkbox"]::before,\n        html body :is(${d}) input[type="checkbox"]::after {\n          content: none !important;\n          display: none !important;\n        }\n\n        /* Checkbox hover effect */\n        html body :is(${d}) input[type="checkbox"]:hover {\n          border-color: ${i.accent} !important;\n          box-shadow: 0 0 0 3px ${i.accent}22 !important;\n        }\n\n        /* Checked State */\n        html body :is(${d}) input[type="checkbox"]:checked {\n          background-color: ${i.accent} !important;\n          border-color: ${i.accent} !important;\n          background-image: none !important;\n        }\n\n        /* 设置区 checkbox 改为开关形态，降低重复勾选框噪声 */\n        html body :is(${d}) .checkbox-group {\n          display: flex !important;\n          align-items: center !important;\n          justify-content: space-between !important;\n          gap: 12px !important;\n          padding: 10px 14px !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 12px !important;\n          background: ${i.bgPanel} !important;\n        }\n\n        html body :is(${d}) .checkbox-group > label {\n          margin: 0 !important;\n          flex: 1 1 auto !important;\n          order: 1 !important;\n          color: ${i.textMain} !important;\n          font-size: 14px !important;\n          font-weight: 650 !important;\n          line-height: 1.45 !important;\n          cursor: pointer !important;\n        }\n\n        html body :is(${d}) .checkbox-group > input[type="checkbox"] {\n          -webkit-appearance: none !important;\n          appearance: none !important;\n          order: 2 !important;\n          margin: 0 0 0 10px !important;\n          width: 42px !important;\n          min-width: 42px !important;\n          height: 24px !important;\n          min-height: 24px !important;\n          border-radius: 999px !important;\n          border: 1.5px solid ${i.border} !important;\n          background: ${i.inputBg} !important;\n          background-image: none !important;\n          position: relative !important;\n          box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.08) !important;\n        }\n\n        html body :is(${d}) .checkbox-group > input[type="checkbox"]::before {\n          content: '' !important;\n          display: block !important;\n          position: absolute !important;\n          top: 2px !important;\n          left: 2px !important;\n          width: 18px !important;\n          height: 18px !important;\n          border-radius: 50% !important;\n          background: ${i.btnActiveText} !important;\n          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.22) !important;\n          transform: translateX(0) !important;\n          transition: transform 0.18s ease, background-color 0.18s ease !important;\n        }\n\n        html body :is(${d}) .checkbox-group > input[type="checkbox"]::after {\n          content: none !important;\n          display: none !important;\n        }\n\n        html body :is(${d}) .checkbox-group > input[type="checkbox"]:checked {\n          background: ${i.btnActiveBg} !important;\n          border-color: ${i.btnActiveBg} !important;\n          background-image: none !important;\n          color: transparent !important;\n          -webkit-text-fill-color: transparent !important;\n        }\n\n        html body :is(${d}) .checkbox-group > input[type="checkbox"]:checked::before {\n          transform: translateX(18px) !important;\n        }\n\n        html body :is(${d}) .checkbox-group > input[type="checkbox"]:focus-visible {\n          outline: none !important;\n          box-shadow: 0 0 0 3px ${i.accent}33 !important;\n        }\n\n        html body :is(${d}) .checkbox-group > input[type="checkbox"]:disabled {\n          opacity: 0.55 !important;\n          cursor: not-allowed !important;\n        }\n\n        html body :is(${d}) .checkbox-group:has(> input[type="checkbox"]:checked) {\n          border-color: ${i.accent}66 !important;\n          box-shadow: 0 0 0 1px ${i.accent}22 inset !important;\n        }\n\n        /* ========== 表头样式增强 ========== */\n        html body .auto-card-updater-popup :is(th, thead th),\n        html body :is(${d}) table thead th,\n        html body :is(${d}) table th {\n          color: ${i.btnActiveText} !important;\n          background: linear-gradient(135deg, ${i.btnActiveBg} 0%, ${i.accent} 100%) !important;\n          background-color: ${i.btnActiveBg} !important;\n          font-weight: 600 !important;\n          text-transform: uppercase !important;\n          font-size: 12px !important;\n          letter-spacing: 0.5px !important;\n          padding: 12px 14px !important;\n          border: none !important;\n          border-bottom: 2px solid ${i.accent} !important;\n          position: relative !important;\n        }\n\n        /* 表头首列圆角 */\n        html body .auto-card-updater-popup table thead th:first-child,\n        html body :is(${d}) table thead th:first-child {\n          border-top-left-radius: 8px !important;\n        }\n\n        /* 表头末列圆角 */\n        html body .auto-card-updater-popup table thead th:last-child,\n        html body :is(${d}) table thead th:last-child {\n          border-top-right-radius: 8px !important;\n        }\n\n        /* ========== Status & Messages Display 状态与消息显示 ========== */\n        html body .auto-card-updater-popup span[id$="-status-display"],\n        html body .auto-card-updater-popup span[id$="-messages-display"],\n        html body .auto-card-updater-popup p.notes,\n        html body :is(${d}) span[id$="-status-display"],\n        html body :is(${d}) span[id$="-messages-display"],\n        html body :is(${d}) p.notes,\n        html body span[id$="-card-update-status-display"],\n        html body span[id$="-total-messages-display"],\n        html body [id$="-status-message"] {\n          display: block !important;\n          background-color: var(--acu-bg-2) !important;\n          color: var(--acu-text-1) !important;\n          border: 1px solid var(--acu-border) !important;\n          border-radius: 8px !important;\n          padding: 10px 14px !important;\n          margin: 10px 0 !important;\n          font-size: 13px !important;\n          line-height: 1.5 !important;\n          box-shadow: inset 0 1px 3px rgba(0,0,0,0.08) !important;\n          word-break: break-all !important;\n        }\n\n        html body .auto-card-updater-popup span[id$="-status-display"] b,\n        html body :is(${d}) span[id$="-status-display"] b,\n        html body span[id$="-card-update-status-display"] b {\n          color: var(--acu-accent) !important;\n          font-weight: 600 !important;\n        }\n\n        html body .auto-card-updater-popup span[id$="-status-display"] *:not(b):not([style*="color"]),\n        html body :is(${d}) span[id$="-status-display"] *:not(b):not([style*="color"]),\n        html body span[id$="-card-update-status-display"] *:not(b):not([style*="color"]) {\n          color: inherit !important;\n        }\n\n        /* ========== 表格行样式增强 ========== */\n        html body .auto-card-updater-popup table tbody tr {\n          background-color: ${i.bgPanel} !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        /* 斑马纹效果 */\n        html body .auto-card-updater-popup table tbody tr:nth-child(even) {\n          background-color: ${i.bgNav} !important;\n        }\n\n        /* 行悬停效果 */\n        html body .auto-card-updater-popup table tbody tr:hover {\n          background-color: ${i.btnHover} !important;\n          box-shadow: inset 3px 0 0 ${i.accent} !important;\n        }\n\n        /* 单元格样式 */\n        html body .auto-card-updater-popup table tbody td {\n          color: ${i.textMain} !important;\n          padding: 10px 14px !important;\n          border-bottom: 1px solid ${i.border} !important;\n          border-left: none !important;\n          border-right: none !important;\n          border-top: none !important;\n          vertical-align: middle !important;\n        }\n\n        /* 最后一行无底边框 */\n        html body .auto-card-updater-popup table tbody tr:last-child td {\n          border-bottom: none !important;\n        }\n\n        /* ========== 表格容器美化 ========== */\n        html body .auto-card-updater-popup table,\n        html body :is(${d}) table {\n          table-layout: fixed !important;\n          width: 100% !important;\n          border-collapse: separate !important;\n          border-spacing: 0 !important;\n          max-width: 100% !important;\n          box-sizing: border-box !important;\n          border-radius: 8px !important;\n          overflow: hidden !important;\n          border: 1px solid ${i.border} !important;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;\n        }\n\n        html body .auto-card-updater-popup table :is(thead, tbody, tr),\n        html body :is(${d}) table :is(thead, tbody, tr) {\n          width: 100% !important;\n          box-sizing: border-box !important;\n        }\n\n        /* 单元格基础样式 */\n        html body .auto-card-updater-popup table :is(th, td),\n        html body :is(${d}) table :is(th, td),\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table th,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table td {\n          text-align: left !important;\n          padding: 10px 14px !important;\n          overflow: hidden !important;\n          text-overflow: ellipsis !important;\n          white-space: nowrap !important;\n          box-sizing: border-box !important;\n        }\n\n        /* 第一列（名称列）左对齐 */\n        html body .auto-card-updater-popup table :is(th, td):first-child,\n        html body :is(${d}) table :is(th, td):first-child {\n          text-align: left !important;\n          width: 25% !important;\n        }\n\n        /* 中间列居中对齐 */\n        html body .auto-card-updater-popup table :is(th, td):not(:first-child):not(:last-child),\n        html body :is(${d}) table :is(th, td):not(:first-child):not(:last-child) {\n          text-align: center !important;\n          width: calc((100% - 25%) / 4) !important;\n        }\n\n        /* 最后一列（操作列）居中 */\n        html body .auto-card-updater-popup table :is(th, td):last-child,\n        html body :is(${d}) table :is(th, td):last-child {\n          text-align: center !important;\n          width: 25% !important;\n        }\n\n        /* ========== Mobile Responsive 移动端适配 ========== */\n        @media (max-width: 768px) {\n          html body .auto-card-updater-popup table,\n          html body :is(${d}) table {\n            font-size: 0.85em !important;\n            box-shadow: none !important;\n          }\n\n          html body .auto-card-updater-popup table :is(th, td),\n          html body :is(${d}) table :is(th, td) {\n            padding: 8px 10px !important;\n          }\n\n          /* 移动端表头样式简化 */\n          html body .auto-card-updater-popup table thead th,\n          html body :is(${d}) table thead th {\n            padding: 10px 8px !important;\n            font-size: 11px !important;\n          }\n\n          /* 移动端弹窗入场动画优化 */\n          html body :is(${p}) {\n            animation: acu-db-popup-enter-mobile 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;\n          }\n        }\n\n        @keyframes acu-db-popup-enter-mobile {\n          from {\n            opacity: 0;\n            transform: translateY(20px);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0);\n          }\n        }\n\n        /* ========== Radio group 单选按钮组 ========== */\n        html body :is(${d}) .qrf_radio_group {\n          background-color: ${i.btnBg} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 8px !important;\n          padding: 10px 14px !important;\n        }\n\n        html body :is(${d}) .qrf_radio_group :is(label, span) {\n          color: ${i.textMain} !important;\n        }\n\n        html body :is(${d}) input[type="radio"] {\n          -webkit-appearance: none !important;\n          appearance: none !important;\n          box-sizing: border-box !important;\n          width: 18px !important;\n          height: 18px !important;\n          min-width: 18px !important;\n          min-height: 18px !important;\n          padding: 0 !important;\n          margin: 0 8px 0 0 !important;\n          border-radius: 50% !important;\n          border: 1.5px solid ${i.border} !important;\n          background-color: ${i.inputBg} !important;\n          box-shadow: none !important;\n          position: relative !important;\n          cursor: pointer !important;\n          flex-shrink: 0 !important;\n          vertical-align: middle !important;\n          transition: all 0.2s ease !important;\n        }\n\n        html body :is(${d}) input[type="radio"]:hover {\n          border-color: ${i.accent} !important;\n          box-shadow: 0 0 0 3px ${i.accent}22 !important;\n        }\n\n        html body :is(${d}) input[type="radio"]:checked {\n          border-color: ${i.accent} !important;\n        }\n\n        html body :is(${d}) input[type="radio"]:checked::after {\n          content: '' !important;\n          position: absolute !important;\n          width: 10px !important;\n          height: 10px !important;\n          border-radius: 50% !important;\n          background: ${i.accent} !important;\n          top: 50% !important;\n          left: 50% !important;\n          transform: translate(-50%, -50%) !important;\n        }\n\n        /* ========== Worldbook entry list 世界书条目列表 ========== */\n        html body :is(${d}) .qrf_worldbook_entry_list,\n        html body :is(${d}) [class*="worldbook-entry-list"] {\n          background-color: ${i.btnBg} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 8px !important;\n        }\n\n        html body :is(${d}) .qrf_worldbook_entry_list :is(label, span, div) {\n          color: ${i.textMain} !important;\n        }\n\n        /* ========== Plot prompt segment ========== */\n        html body :is(${d}) :is(textarea.plot-prompt-segment-content, .plot-prompt-segment-content) {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n\n        html body :is(${d}) .plot-prompt-segment {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 8px !important;\n        }\n\n        /* ========== 剧情推进区专属修复 ========== */\n        html body :is(${d}) #acu-tab-plot .acu-card > div:first-child {\n          display: flex !important;\n          align-items: flex-start !important;\n          justify-content: space-between !important;\n          gap: 14px !important;\n          flex-wrap: wrap !important;\n        }\n\n        html body :is(${d}) #acu-tab-plot .acu-card > div:first-child > div:first-child {\n          flex: 1 1 360px !important;\n          min-width: 0 !important;\n        }\n\n        html body :is(${d}) #acu-tab-plot .acu-card > div:first-child > div:first-child > p.notes {\n          display: block !important;\n          margin: 6px 0 0 0 !important;\n          padding: 0 !important;\n          border: 0 !important;\n          background: transparent !important;\n          box-shadow: none !important;\n          color: ${i.textSub} !important;\n          font-size: 13px !important;\n          line-height: 1.45 !important;\n          word-break: normal !important;\n        }\n\n        html body :is(${d}) #acu-tab-plot .acu-card > div:first-child > div:nth-child(2) {\n          display: inline-flex !important;\n          align-items: center !important;\n          gap: 8px !important;\n          flex: 0 0 auto !important;\n          white-space: nowrap !important;\n        }\n\n        html body :is(${d}) :is(button[id$="-plot-start-loop-btn"], button[id$="-plot-stop-loop-btn"]) {\n          writing-mode: horizontal-tb !important;\n          text-orientation: mixed !important;\n          white-space: nowrap !important;\n          word-break: keep-all !important;\n          min-width: 148px !important;\n          width: auto !important;\n          max-width: 100% !important;\n          padding: 12px 22px !important;\n          display: inline-flex !important;\n          align-items: center !important;\n          justify-content: center !important;\n          gap: 8px !important;\n        }\n\n        html body :is(${d}) :is(button[id$="-plot-start-loop-btn"], button[id$="-plot-stop-loop-btn"]) i {\n          flex-shrink: 0 !important;\n        }\n\n        /* ========== Toggle switch ========== */\n        /* 内部 checkbox 维持隐藏 */\n        html body :is(${d}) .toggle-switch input[type="checkbox"] {\n          -webkit-appearance: auto !important;\n          appearance: auto !important;\n          background: transparent !important;\n          border: 0 !important;\n          box-shadow: none !important;\n          width: 0 !important;\n          height: 0 !important;\n          min-width: 0 !important;\n          min-height: 0 !important;\n          opacity: 0 !important;\n          margin: 0 !important;\n        }\n\n        /* 状态文本高亮 */\n        html body :is(${d}) span[style*="lightgreen"] {\n          color: ${i.accent} !important;\n        }\n\n        /* Toggle switch 轨道与滑块 */\n        html body :is(${d}) .toggle-switch .slider {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          border: 1.5px solid ${i.border} !important;\n          border-radius: 20px !important;\n          transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        html body :is(${d}) .toggle-switch .slider:before {\n          background-color: ${i.btnActiveText} !important;\n          border: 1px solid ${i.border} !important;\n          transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        html body :is(${d}) .toggle-switch input:checked + .slider {\n          background-color: ${i.btnActiveBg} !important;\n          background: ${i.btnActiveBg} !important;\n          border-color: ${i.btnActiveBg} !important;\n        }\n\n        html body :is(${d}) .toggle-switch input:checked + .slider:before {\n          background-color: ${i.btnActiveText} !important;\n          border-color: ${i.btnActiveText} !important;\n        }\n\n        /* ========== Prompt Segment Toolbar ========== */\n        html body :is(${d}) .prompt-segment {\n          background-color: ${i.bgPanel} !important;\n          border: 1px solid ${i.border} !important;\n          color: ${i.textMain} !important;\n          border-radius: 8px !important;\n        }\n\n        html body :is(${d}) .prompt-segment-toolbar {\n          background-color: transparent !important;\n          color: ${i.textMain} !important;\n        }\n\n        html body :is(${d}) .prompt-segment-toolbar :is(.prompt-segment-role, .prompt-segment-main-slot, .prompt-segment-delete-btn) {\n          background-color: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 6px !important;\n          transition: all 0.2s ease !important;\n        }\n\n        html body :is(${d}) .prompt-segment-toolbar :is(.prompt-segment-role, .prompt-segment-main-slot, .prompt-segment-delete-btn):hover {\n          background-color: ${i.btnHover} !important;\n        }\n\n        /* ========== Tabs Navigation 标签页导航 ========== */\n        html body :is(${f}) .acu-tabs-nav {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          color: ${i.textMain} !important;\n          border-bottom: 1px solid ${i.border} !important;\n          margin: 0 !important;\n          position: sticky !important;\n          top: 0 !important;\n          z-index: 32011 !important;\n          isolation: isolate !important;\n        }\n\n        html body :is(${f}) .acu-nav-section-title {\n          color: ${i.textSub} !important;\n          font-size: 11px !important;\n          text-transform: uppercase !important;\n          letter-spacing: 0.5px !important;\n          font-weight: 600 !important;\n        }\n\n        /* Tab Button (default state) */\n        html body :is(${f}) .acu-tab-button {\n          background-color: transparent !important;\n          background: transparent !important;\n          color: ${i.textSub} !important;\n          border: 1px solid transparent !important;\n          border-radius: 8px !important;\n          padding: 8px 14px !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        /* Tab Button (hover) */\n        html body :is(${f}) .acu-tab-button:hover {\n          background-color: ${i.btnBg} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          transform: translateY(-1px) !important;\n        }\n\n        /* Tab Button (active state) */\n        html body :is(${f}) .acu-tab-button.active {\n          background-color: ${i.btnActiveBg} !important;\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border-color: ${i.btnActiveBg} !important;\n          box-shadow: 0 2px 8px ${i.accent}33 !important;\n        }\n\n        /* ========== 可视化编辑器 ========== */\n        /* Header - 增强渐变效果 */\n        #acu-visualizer-content .acu-vis-header {\n          background: linear-gradient(135deg, ${i.bgNav} 0%, ${i.bgPanel} 100%) !important;\n          border-bottom: 1px solid ${i.border} !important;\n          color: ${i.textMain} !important;\n          position: relative !important;\n        }\n\n        /* Header 底部高光 */\n        #acu-visualizer-content .acu-vis-header::after {\n          content: '' !important;\n          position: absolute !important;\n          bottom: 0 !important;\n          left: 50% !important;\n          transform: translateX(-50%) !important;\n          width: 40% !important;\n          height: 1px !important;\n          background: linear-gradient(90deg, transparent, ${i.accent}44, transparent) !important;\n        }\n\n        /* Content Area */\n        #acu-visualizer-content .acu-vis-content {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n        }\n\n        /* Sidebar - 增强样式 */\n        #acu-visualizer-content .acu-vis-sidebar {\n          background-color: ${i.bgNav} !important;\n          background: ${i.bgNav} !important;\n          border-right: 1px solid ${i.border} !important;\n          box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05) !important;\n        }\n\n        /* Main Section */\n        #acu-visualizer-content .acu-vis-main {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* Title & Actions */\n        #acu-visualizer-content .acu-vis-title {\n          color: ${i.textMain} !important;\n          font-weight: 600 !important;\n        }\n\n        #acu-visualizer-content .acu-vis-actions {\n          color: ${i.textSub} !important;\n        }\n\n        /* 可视化编辑器 - 数据卡片 */\n        /* Card Grid Layout - 增强间距和动画 */\n        #acu-visualizer-content .acu-card-grid {\n          display: grid !important;\n          grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;\n          gap: 20px !important;\n          padding: 20px !important;\n        }\n\n        /* Data Card Container - 现代化卡片设计 */\n        #acu-visualizer-content .acu-data-card {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 12px !important;\n          overflow: visible !important;\n          overflow-y: auto !important;\n          max-height: 70vh !important;\n          display: flex !important;\n          flex-direction: column !important;\n          transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;\n          box-shadow: \n            0 2px 8px rgba(0, 0, 0, 0.08),\n            0 1px 2px rgba(0, 0, 0, 0.04) !important;\n          position: relative !important;\n        }\n\n        /* 卡片左侧装饰线 */\n        #acu-visualizer-content .acu-data-card::before {\n          content: '' !important;\n          position: absolute !important;\n          top: 12px !important;\n          bottom: 12px !important;\n          left: 0 !important;\n          width: 3px !important;\n          background: ${i.accent} !important;\n          border-radius: 0 3px 3px 0 !important;\n          opacity: 0 !important;\n          transition: opacity 0.25s ease !important;\n        }\n\n        /* 卡片悬停效果 */\n        #acu-visualizer-content .acu-data-card:hover {\n          transform: translateY(-6px) !important;\n          box-shadow: \n            0 12px 28px rgba(0, 0, 0, 0.15),\n            0 4px 8px rgba(0, 0, 0, 0.08),\n            0 0 0 1px ${i.accent}22 !important;\n          border-color: ${i.accent}66 !important;\n        }\n\n        /* 悬停时显示装饰线 */\n        #acu-visualizer-content .acu-data-card:hover::before {\n          opacity: 1 !important;\n        }\n\n        /* Add Row Card - 虚线边框样式增强 */\n        #acu-visualizer-content #acu-vis-add-row,\n        #acu-visualizer-content .acu-data-card#acu-vis-add-row {\n          background: ${i.bgPanel} !important;\n          background-color: ${i.bgPanel} !important;\n          border: 2px dashed ${i.accent}66 !important;\n          border-color: ${i.accent}66 !important;\n          display: flex !important;\n          flex-direction: column !important;\n          align-items: center !important;\n          justify-content: center !important;\n          gap: 6px !important;\n          min-height: 84px !important;\n          padding: 10px 12px !important;\n          cursor: pointer !important;\n          transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        /* 添加卡片无装饰线 */\n        #acu-visualizer-content #acu-vis-add-row::before {\n          display: none !important;\n        }\n\n        #acu-visualizer-content #acu-vis-add-row i,\n        #acu-visualizer-content #acu-vis-add-row i.fa-solid,\n        #acu-visualizer-content #acu-vis-add-row i.fa-plus,\n        #acu-visualizer-content .acu-data-card#acu-vis-add-row > i,\n        #acu-vis-add-row i[style] {\n          color: ${i.accent} !important;\n          font-size: 28px !important;\n          line-height: 1 !important;\n          transition: all 0.25s ease !important;\n        }\n\n        #acu-visualizer-content #acu-vis-add-row div,\n        #acu-visualizer-content .acu-data-card#acu-vis-add-row > div,\n        #acu-vis-add-row div[style] {\n          color: ${i.accent} !important;\n          font-size: 14px !important;\n          line-height: 1.2 !important;\n          font-weight: 650 !important;\n          transition: all 0.25s ease !important;\n        }\n\n        #acu-visualizer-content #acu-vis-add-row:hover {\n          background: ${i.btnBg} !important;\n          background-color: ${i.btnBg} !important;\n          border-color: ${i.accent} !important;\n          border-style: solid !important;\n          transform: translateY(-4px) !important;\n          box-shadow: 0 8px 20px ${i.accent}22 !important;\n        }\n\n        #acu-visualizer-content #acu-vis-add-row:hover i,\n        #acu-visualizer-content #acu-vis-add-row:hover div,\n        #acu-vis-add-row:hover i[style],\n        #acu-vis-add-row:hover div[style] {\n          color: ${i.btnActiveBg} !important;\n          transform: scale(1.2) !important;\n        }\n\n        /* Card Header - 现代化设计 */\n        #acu-visualizer-content .acu-card-header {\n          background: linear-gradient(135deg, ${i.btnActiveBg} 0%, ${i.accent} 100%) !important;\n          background-color: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          padding: 14px 18px !important;\n          font-weight: 600 !important;\n          font-size: 14px !important;\n          display: flex !important;\n          align-items: center !important;\n          justify-content: space-between !important;\n          border-bottom: none !important;\n          border-radius: 12px 12px 0 0 !important;\n          position: relative !important;\n        }\n\n        /* Card Header 底部微光 */\n        #acu-visualizer-content .acu-card-header::after {\n          content: '' !important;\n          position: absolute !important;\n          bottom: 0 !important;\n          left: 0 !important;\n          right: 0 !important;\n          height: 1px !important;\n          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent) !important;\n        }\n\n        /* Card Body - 优化内边距和排版 */\n        #acu-visualizer-content .acu-card-body {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          padding: 18px !important;\n          flex: 1 !important;\n          color: ${i.textMain} !important;\n          font-size: 14px !important;\n          line-height: 1.6 !important;\n          border-radius: 0 0 12px 12px !important;\n        }\n        /* 可视化编辑器 - 交互按钮 */\n        /* Lock Buttons - 通配符统一处理所有锁定按钮 */\n        #acu-visualizer-content [class*="acu-lock"],\n        #acu-visualizer-content [class*="acu-vis-lock"] {\n          background: ${i.btnBg} !important;\n          color: ${i.textSub} !important;\n          border: 1px solid ${i.border} !important;\n          padding: 4px 6px !important;\n          cursor: pointer !important;\n          transition: all 0.2s ease !important;\n          /* 紧凑尺寸 - 防止触摸屏优化导致按钮增大 */\n          min-width: unset !important;\n          min-height: unset !important;\n          width: auto !important;\n          height: auto !important;\n          font-size: 12px !important;\n          line-height: 1 !important;\n          border-radius: 4px !important;\n          flex-shrink: 0 !important;\n        }\n\n        #acu-visualizer-content [class*="acu-lock"]:hover,\n        #acu-visualizer-content [class*="acu-vis-lock"]:hover {\n          background: ${i.btnHover} !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* Delete Buttons (Red warning) */\n        #acu-visualizer-content .acu-vis-del-row,\n        #acu-visualizer-content .acu-vis-del-table-btn {\n          background: ${i.btnBg} !important;\n          color: ${i.textSub} !important;\n          border: 1px solid ${i.border} !important;\n          cursor: pointer !important;\n          transition: all 0.2s ease !important;\n        }\n\n        #acu-visualizer-content .acu-vis-del-row:hover,\n        #acu-visualizer-content .acu-vis-del-table-btn:hover {\n          background: #ff4444 !important;\n          color: #fff !important;\n          border-color: #cc0000 !important;\n        }\n\n        /* Add Table Button */\n        #acu-visualizer-content .acu-add-table-btn {\n          background: ${i.accent} !important;\n          color: #fff !important;\n          border: none !important;\n          padding: 10px 16px !important;\n          cursor: pointer !important;\n          transition: all 0.2s ease !important;\n        }\n\n        #acu-visualizer-content .acu-add-table-btn:hover {\n          background: ${i.btnActiveBg} !important;\n        }\n\n        /* 可视化编辑器 - 工具栏容器 */\n        #acu-visualizer-content .acu-vis-toolbar {\n          display: flex !important;\n          align-items: center !important;\n          justify-content: space-between !important;\n          padding: 8px 12px !important;\n          background: ${i.bgNav} !important;\n          border-bottom: 1px solid ${i.border} !important;\n          flex-shrink: 0 !important;\n          flex-wrap: wrap !important;\n          gap: 8px !important;\n        }\n\n        /* 可视化编辑器 - 模式切换与操作按钮 */\n        /* Mode Switch Container */\n        #acu-visualizer-content .acu-mode-switch {\n          display: flex !important;\n          gap: 4px !important;\n          padding: 4px !important;\n          background: ${i.bgPanel} !important;\n          border-radius: 6px !important;\n          border: 1px solid ${i.border} !important;\n          flex-shrink: 0 !important;\n        }\n\n        /* Mode Button (default) */\n        #acu-visualizer-content .acu-mode-btn {\n          background: transparent !important;\n          color: ${i.textSub} !important;\n          border: 1px solid transparent !important;\n          padding: 6px 10px !important;\n          cursor: pointer !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n          border-radius: 4px !important;\n          font-size: 12px !important;\n          white-space: nowrap !important;\n          min-width: unset !important;\n          min-height: unset !important;\n        }\n\n        #acu-visualizer-content .acu-mode-btn:hover {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          transform: translateY(-1px) !important;\n        }\n\n        #acu-visualizer-content .acu-mode-btn:active {\n          transform: translateY(0) scale(0.98) !important;\n        }\n\n        /* Mode Button (active) */\n        #acu-visualizer-content .acu-mode-btn.active {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border-color: ${i.btnActiveBg} !important;\n          box-shadow: 0 2px 8px ${i.accent}33 !important;\n        }\n\n        /* 操作按钮区域 */\n        #acu-visualizer-content .acu-vis-actions {\n          display: flex !important;\n          gap: 6px !important;\n          flex-wrap: wrap !important;\n          justify-content: flex-end !important;\n          flex-shrink: 1 !important;\n          min-width: 0 !important;\n        }\n\n        /* Primary Button */\n        #acu-visualizer-content .acu-btn-primary {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border: none !important;\n          padding: 6px 12px !important;\n          border-radius: 4px !important;\n          cursor: pointer !important;\n          font-weight: 600 !important;\n          font-size: 12px !important;\n          white-space: nowrap !important;\n          min-width: unset !important;\n          min-height: unset !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n          box-shadow: 0 2px 6px ${i.accent}33 !important;\n        }\n\n        #acu-visualizer-content .acu-btn-primary:hover {\n          filter: brightness(1.1) !important;\n          transform: translateY(-1px) !important;\n          box-shadow: 0 4px 12px ${i.accent}44 !important;\n        }\n\n        #acu-visualizer-content .acu-btn-primary:active {\n          transform: translateY(0) scale(0.98) !important;\n          box-shadow: 0 1px 4px ${i.accent}22 !important;\n        }\n\n        /* Secondary Button */\n        #acu-visualizer-content .acu-btn-secondary {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          padding: 6px 12px !important;\n          border-radius: 4px !important;\n          cursor: pointer !important;\n          font-size: 12px !important;\n          white-space: nowrap !important;\n          min-width: unset !important;\n          min-height: unset !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        #acu-visualizer-content .acu-btn-secondary:hover {\n          background: ${i.btnHover} !important;\n          transform: translateY(-1px) !important;\n          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;\n        }\n\n        #acu-visualizer-content .acu-btn-secondary:active {\n          transform: translateY(0) scale(0.98) !important;\n        }\n        /* 可视化编辑器 - 字段元素 */\n        /* Field Row */\n        #acu-visualizer-content .acu-field-row {\n          display: flex !important;\n          align-items: flex-start !important;\n          gap: 12px !important;\n          padding: 10px 0 !important;\n          border-bottom: 1px solid ${i.border} !important;\n          transition: background-color 0.2s ease !important;\n        }\n\n        #acu-visualizer-content .acu-field-row:last-child {\n          border-bottom: none !important;\n        }\n\n        /* Field Label - 覆盖inline style的justify-content:space-between，让锁定按钮紧跟文字 */\n        #acu-visualizer-content .acu-field-label {\n          color: ${i.textSub} !important;\n          font-weight: 600 !important;\n          min-width: 140px !important;\n          max-width: 200px !important;\n          font-size: 13px !important;\n          padding-top: 8px !important;\n          user-select: none !important;\n          overflow: visible !important;\n          text-overflow: ellipsis !important;\n          white-space: nowrap !important;\n          /* 覆盖inline style，让锁定按钮紧跟在列名后面而不是被推到右边 */\n          justify-content: flex-start !important;\n        }\n\n        /* Field Value Wrapper - 改为横向布局，锁定按钮紧跟在值后面 */\n        #acu-visualizer-content .acu-field-value-wrap {\n          flex: 1 1 0 !important;\n          min-width: 0 !important;\n          display: flex !important;\n          flex-direction: row !important;\n          align-items: flex-start !important;\n          gap: 8px !important;\n          width: 100% !important;\n        }\n\n        /* 单元格锁定按钮 - 紧凑样式 */\n        #acu-visualizer-content .acu-field-value-wrap > .acu-lock-btn {\n          flex-shrink: 0 !important;\n          padding: 4px 6px !important;\n          font-size: 12px !important;\n          border-radius: 4px !important;\n          min-width: unset !important;\n          min-height: unset !important;\n          width: auto !important;\n          height: auto !important;\n        }\n\n        /* Field Value (editable) */\n        #acu-visualizer-content .acu-field-value {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          padding: 8px 12px !important;\n          border-radius: 6px !important;\n          font-size: 14px !important;\n          min-height: 38px !important;\n          /* 修复：让输入框始终占满一行，文字自动换行 */\n          flex: 1 1 0 !important;\n          min-width: 0 !important;\n          width: 100% !important;\n          box-sizing: border-box !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n          cursor: text !important;\n          line-height: 1.5 !important;\n          /* 文字换行 */\n          white-space: pre-wrap !important;\n          word-wrap: break-word !important;\n          word-break: break-word !important;\n          overflow-wrap: break-word !important;\n        }\n\n        #acu-visualizer-content .acu-field-value:hover {\n          border-color: ${i.accent} !important;\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;\n        }\n\n        #acu-visualizer-content .acu-field-value:focus {\n          border-color: ${i.accent} !important;\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          outline: none !important;\n          box-shadow: 0 0 0 3px ${i.accent}33 !important;\n        }\n\n        /* 可视化编辑器 - 配置面板 */\n        /* Panel Container */\n        #acu-visualizer-content .acu-config-panel {\n          background: ${i.bgPanel} !important;\n          padding: 20px !important;\n          border-radius: 8px !important;\n        }\n\n        /* Config Section */\n        #acu-visualizer-content .acu-config-section {\n          margin-bottom: 24px !important;\n        }\n\n        #acu-visualizer-content .acu-config-section h4 {\n          color: ${i.textMain} !important;\n          font-size: 16px !important;\n          font-weight: 600 !important;\n          margin-bottom: 12px !important;\n        }\n\n        /* Form Group */\n        #acu-visualizer-content .acu-form-group {\n          margin-bottom: 16px !important;\n        }\n\n        #acu-visualizer-content .acu-form-group label {\n          color: ${i.textSub} !important;\n          display: block !important;\n          margin-bottom: 6px !important;\n          font-weight: 500 !important;\n        }\n\n        /* Form Inputs */\n        #acu-visualizer-content .acu-form-input,\n        #acu-visualizer-content .acu-form-textarea {\n          background: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          padding: 8px 12px !important;\n          border-radius: 6px !important;\n          width: 100% !important;\n          font-size: 14px !important;\n          transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;\n        }\n\n        #acu-visualizer-content .acu-form-input:hover,\n        #acu-visualizer-content .acu-form-textarea:hover {\n          border-color: ${i.accent}66 !important;\n        }\n\n        #acu-visualizer-content .acu-form-input:focus,\n        #acu-visualizer-content .acu-form-textarea:focus {\n          border-color: ${i.accent} !important;\n          outline: none !important;\n          box-shadow: 0 0 0 3px ${i.accent}22 !important;\n        }\n\n        #acu-visualizer-content .acu-form-textarea {\n          min-height: 80px !important;\n          resize: vertical !important;\n          line-height: 1.5 !important;\n        }\n\n        /* Hint Text */\n        #acu-visualizer-content .acu-hint {\n          color: ${i.textSub} !important;\n          font-size: 12px !important;\n          opacity: 0.7 !important;\n          margin-top: 4px !important;\n        }\n\n        /* ========== 可视化编辑器 - 侧边栏导航 ========== */\n        /* 侧边栏容器 */\n        #acu-visualizer-content .acu-vis-sidebar {\n          background: ${i.bgNav} !important;\n          border-right: 1px solid ${i.border} !important;\n          padding: 8px !important;\n          overflow-y: auto !important;\n        }\n\n        /* 通配符: 侧边栏内所有按钮统一紧凑样式 - 防止触控优化导致按钮放大 */\n        #acu-visualizer-content .acu-vis-sidebar button,\n        #acu-visualizer-content [class*="acu-table-nav-"] button,\n        #acu-visualizer-content [class*="acu-vis-del-"] {\n          min-width: unset !important;\n          min-height: unset !important;\n          width: auto !important;\n          height: auto !important;\n          padding: 4px 6px !important;\n          font-size: 12px !important;\n          line-height: 1 !important;\n          border-radius: 4px !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textSub} !important;\n          border: 1px solid ${i.border} !important;\n          cursor: pointer !important;\n          transition: all 0.2s ease !important;\n          flex-shrink: 0 !important;\n        }\n\n        #acu-visualizer-content .acu-vis-sidebar button:hover,\n        #acu-visualizer-content [class*="acu-table-nav-"] button:hover {\n          background: ${i.btnHover} !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* 删除按钮悬停时变红色警告 */\n        #acu-visualizer-content [class*="acu-vis-del-"]:hover {\n          background: #ff4444 !important;\n          color: #fff !important;\n          border-color: #cc0000 !important;\n        }\n\n        /* Table Nav Item (default) */\n        #acu-visualizer-content .acu-table-nav-item {\n          background: transparent !important;\n          color: ${i.textSub} !important;\n          border: 1px solid transparent !important;\n          padding: 6px 8px !important;\n          cursor: pointer !important;\n          transition: all 0.2s ease !important;\n          display: flex !important;\n          align-items: center !important;\n          justify-content: space-between !important;\n          gap: 6px !important;\n          border-radius: 6px !important;\n          margin-bottom: 2px !important;\n          font-size: 16px !important;\n        }\n\n        /* Table Nav Item (hover) */\n        #acu-visualizer-content .acu-table-nav-item:hover {\n          background: ${i.btnHover} !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* Table Nav Item (active) */\n        #acu-visualizer-content .acu-table-nav-item.active {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border-color: ${i.btnActiveBg} !important;\n        }\n\n        /* 表格导航内容区 */\n        #acu-visualizer-content .acu-table-nav-content {\n          display: flex !important;\n          align-items: center !important;\n          gap: 6px !important;\n          flex: 1 !important;\n          min-width: 0 !important;\n          overflow: hidden !important;\n        }\n\n        /* 表格导航操作按钮区 */\n        #acu-visualizer-content .acu-table-nav-actions {\n          display: flex !important;\n          align-items: center !important;\n          gap: 4px !important;\n          flex-shrink: 0 !important;\n        }\n\n        /* Table Name */\n        #acu-visualizer-content .acu-table-name {\n          font-weight: 500 !important;\n          flex: 1 !important;\n          overflow: hidden !important;\n          text-overflow: ellipsis !important;\n          white-space: nowrap !important;\n        }\n\n        /* Table Index */\n        #acu-visualizer-content .acu-table-index {\n          font-size: 10px !important;\n          color: ${i.textSub} !important;\n          opacity: 0.7 !important;\n        }\n\n        /* 新增表格按钮 */\n        #acu-visualizer-content .acu-add-table-btn {\n          width: 100% !important;\n          margin-top: 8px !important;\n          padding: 8px 12px !important;\n          background: ${i.accent} !important;\n          color: ${i.btnActiveText} !important;\n          border: none !important;\n          border-radius: 6px !important;\n          font-size: 12px !important;\n          cursor: pointer !important;\n          min-width: unset !important;\n          min-height: unset !important;\n        }\n\n        #acu-visualizer-content .acu-add-table-btn:hover {\n          filter: brightness(1.1) !important;\n        }\n\n        /* 表格导航按钮 - 透明背景（使用更广泛的选择器） */\n        .acu-table-order-btn,\n        .acu-vis-del-table-btn,\n        .acu-vis-sidebar .acu-table-order-btn,\n        .acu-vis-sidebar .acu-vis-del-table-btn,\n        .acu-table-nav-actions .acu-table-order-btn,\n        .acu-table-nav-actions .acu-vis-del-table-btn,\n        #acu-visualizer-content .acu-table-order-btn,\n        #acu-visualizer-content .acu-vis-del-table-btn {\n          background: transparent !important;\n          background-color: transparent !important;\n          border: none !important;\n          color: ${i.textSub} !important;\n          opacity: 0.7 !important;\n        }\n\n        .acu-table-order-btn:hover,\n        .acu-vis-del-table-btn:hover,\n        .acu-vis-sidebar .acu-table-order-btn:hover,\n        .acu-vis-sidebar .acu-vis-del-table-btn:hover,\n        .acu-table-nav-actions .acu-table-order-btn:hover,\n        .acu-table-nav-actions .acu-vis-del-table-btn:hover,\n        #acu-visualizer-content .acu-table-order-btn:hover,\n        #acu-visualizer-content .acu-vis-del-table-btn:hover {\n          background: ${i.btnHover} !important;\n          background-color: ${i.btnHover} !important;\n          color: ${i.textMain} !important;\n          opacity: 1 !important;\n        }\n\n        .acu-table-order-btn:disabled,\n        #acu-visualizer-content .acu-table-order-btn:disabled {\n          opacity: 0.3 !important;\n          cursor: not-allowed !important;\n        }\n\n        /* 可视化编辑器 - 滚动条与响应式 */\n        /* Scrollbar Styles */\n        #acu-visualizer-content ::-webkit-scrollbar {\n          width: 8px !important;\n          height: 8px !important;\n        }\n\n        #acu-visualizer-content ::-webkit-scrollbar-track {\n          background: ${i.bgNav} !important;\n          border-radius: 4px !important;\n        }\n\n        #acu-visualizer-content ::-webkit-scrollbar-thumb {\n          background: ${i.btnBg} !important;\n          border-radius: 4px !important;\n          border: 2px solid ${i.bgNav} !important;\n        }\n\n        #acu-visualizer-content ::-webkit-scrollbar-thumb:hover {\n          background: ${i.btnHover} !important;\n        }\n\n        /* Responsive Styles */\n        @media (max-width: 768px) {\n          /* 工具栏响应式 - 垂直堆叠布局 */\n          #acu-visualizer-content .acu-vis-toolbar {\n            flex-direction: column !important;\n            align-items: stretch !important;\n            padding: 8px !important;\n            gap: 8px !important;\n          }\n\n          #acu-visualizer-content .acu-mode-switch {\n            width: 100% !important;\n            justify-content: center !important;\n          }\n\n          #acu-visualizer-content .acu-mode-btn {\n            flex: 1 !important;\n            text-align: center !important;\n            padding: 10px 8px !important;\n            min-height: 44px !important;\n          }\n\n          #acu-visualizer-content .acu-vis-actions {\n            width: 100% !important;\n            justify-content: center !important;\n          }\n\n          #acu-visualizer-content .acu-btn-primary,\n          #acu-visualizer-content .acu-btn-secondary {\n            flex: 1 !important;\n            text-align: center !important;\n            padding: 10px 12px !important;\n            min-height: 44px !important;\n          }\n\n          #acu-visualizer-content .acu-vis-header {\n            flex-direction: column !important;\n            height: auto !important;\n            padding: 10px !important;\n          }\n\n          #acu-visualizer-content .acu-vis-sidebar {\n            width: 100% !important;\n            border-right: none !important;\n            border-bottom: 1px solid ${i.border} !important;\n            max-height: 200px !important;\n            overflow-y: auto !important;\n          }\n\n          #acu-visualizer-content .acu-vis-content {\n            flex-direction: column !important;\n          }\n\n          #acu-visualizer-content .acu-card-grid {\n            grid-template-columns: 1fr !important;\n            padding: 12px !important;\n            gap: 16px !important;\n          }\n\n          /* 移动端卡片简化动画 */\n          #acu-visualizer-content .acu-data-card {\n            border-radius: 10px !important;\n          }\n\n          #acu-visualizer-content .acu-data-card:hover {\n            transform: none !important;\n          }\n\n          #acu-visualizer-content .acu-data-card::before {\n            display: none !important;\n          }\n\n          #acu-visualizer-content .acu-card-header {\n            padding: 12px 14px !important;\n            border-radius: 10px 10px 0 0 !important;\n          }\n\n          #acu-visualizer-content .acu-card-body {\n            padding: 14px !important;\n            border-radius: 0 0 10px 10px !important;\n          }\n\n          #acu-visualizer-content .acu-field-row {\n            flex-direction: column !important;\n            align-items: stretch !important;\n          }\n\n          #acu-visualizer-content .acu-field-label {\n            min-width: unset !important;\n            width: 100% !important;\n            padding-bottom: 4px !important;\n          }\n\n          #acu-visualizer-content .acu-vis-actions {\n            justify-content: center !important;\n            width: 100% !important;\n            margin-top: 10px !important;\n          }\n\n          /* 移动端通用按钮触控优化 */\n          html body .auto-card-updater-popup button,\n          html body .auto-card-updater-popup .button {\n            min-height: 44px !important;\n            padding: 10px 16px !important;\n          }\n\n          /* 移动端禁用 transform 动画以提升性能 */\n          html body .auto-card-updater-popup button:hover,\n          html body .auto-card-updater-popup .button:hover {\n            transform: none !important;\n          }\n\n          html body .auto-card-updater-popup button:active,\n          html body .auto-card-updater-popup .button:active {\n            transform: scale(0.98) !important;\n          }\n\n          html body :is(${d}) [id$="-data-isolation-input-area"] > div {\n            flex-direction: column !important;\n          }\n\n          html body :is(${d}) button[id$="-data-isolation-save"].primary {\n            width: 100% !important;\n          }\n\n          html body :is(${d}) button[id$="-data-isolation-history-toggle"] {\n            width: 36px !important;\n            min-width: 36px !important;\n            height: 36px !important;\n            min-height: 36px !important;\n          }\n\n          html body :is(${d}) button[id$="-data-isolation-delete-entries"] {\n            width: 100% !important;\n            min-width: 0 !important;\n          }\n\n          html body :is(${d}) .acu-template-preset-toolbar .acu-template-preset-left {\n            grid-template-columns: 1fr !important;\n          }\n\n          html body :is(${d}) .acu-template-preset-toolbar .acu-template-preset-actions {\n            grid-template-columns: 1fr 1fr !important;\n          }\n\n          html body :is(${d}) .acu-mini-btn {\n            width: 100% !important;\n          }\n\n          html body :is(${d}) :is(button[id$="-plot-start-loop-btn"], button[id$="-plot-stop-loop-btn"]) {\n            width: 100% !important;\n          }\n        }\n\n        /* 可视化编辑器 - 列编辑器 */\n        /* Column List */\n        #acu-visualizer-content .acu-col-list {\n          display: flex !important;\n          flex-direction: column !important;\n          gap: 8px !important;\n          padding: 8px 0 !important;\n        }\n\n        /* Column Item */\n        #acu-visualizer-content .acu-col-item {\n          background: ${i.btnBg} !important;\n          border: 1px solid ${i.border} !important;\n          padding: 8px 12px !important;\n          border-radius: 6px !important;\n          display: flex !important;\n          align-items: center !important;\n          gap: 8px !important;\n          transition: all 0.2s ease !important;\n        }\n\n        #acu-visualizer-content .acu-col-item:hover {\n          background: ${i.btnHover} !important;\n        }\n\n        /* Column Input */\n        #acu-visualizer-content .acu-col-input {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          padding: 6px 10px !important;\n          border-radius: 4px !important;\n          flex: 1 !important;\n          font-size: 13px !important;\n        }\n\n        #acu-visualizer-content .acu-col-input:focus {\n          border-color: ${i.accent} !important;\n          outline: none !important;\n        }\n\n        /* Column Delete Button */\n        #acu-visualizer-content .acu-col-btn {\n          background: ${i.btnBg} !important;\n          color: ${i.textSub} !important;\n          border: 1px solid ${i.border} !important;\n          padding: 4px 8px !important;\n          border-radius: 4px !important;\n          cursor: pointer !important;\n          transition: all 0.2s ease !important;\n        }\n\n        #acu-visualizer-content .acu-col-btn:hover {\n          background: #ff4444 !important;\n          color: #fff !important;\n          border-color: #cc0000 !important;\n        }\n      </style>\n    `;for(const $ of a)$('#dice-db-theme-sync').remove(),$('head').append(g)}catch(t){}}const r='dice-db-toast-mute';function c(t){try{const n='\n#toast-container .acu-toast,\n.toast.acu-toast,\n.acu-toast.toast {\n  display: none !important;\n}\n',e=(()=>{const t=[],n=n=>{try{const e=n?.document;e&&!t.includes(e)&&t.push(e)}catch{return}};return n(window),n(window.parent),n(window.top),t})();for(const a of e){const e=a.getElementById(r);if(t){if(!e){const t=a.createElement('style');t.id=r,t.textContent=n,(a.head||a.documentElement).appendChild(t)}a.querySelectorAll('.acu-toast').forEach(t=>t.remove())}else e&&e.remove()}}catch{return}}!function(){const t='acu_visualizer_ui_v19_6_ai_overlay',o={全局数据表:null,世界地图点:'详细地点',地图元素表:'元素名称',主角信息:'姓名',重要人物表:'姓名',技能表:'技能名称',物品表:'物品名称',装备表:'装备名称',任务表:'名称',总结表:'编码索引',总体大纲:'编码索引',重要情报:'情报名称',势力:'名称'};function r(t,n,e){const a=o[t];if(null===a)return'_row_0';let i=1;if(a){const t=e.indexOf(a);-1!==t&&(i=t)}return n[i]?`${a||e[i]}=${n[i]}`:null}function s(){let t=window;try{for(;t.parent&&t.parent!==t;)t=t.parent}catch(t){}return t.AutoCardUpdaterAPI||window.AutoCardUpdaterAPI||null}function l(t){const n=s();if(!n||'function'!=typeof n.exportTableAsJson)return null;try{const e=n.exportTableAsJson();if(!e)return null;for(const n in e)if(n.startsWith('sheet_')&&e[n]?.name===t)return n}catch(t){console.warn('[DICE]getSheetKeyByTableName 失败:',t)}return null}function d(t,n,e){const a=s();if(!a||'function'!=typeof a.exportTableAsJson)return null;try{const i=a.exportTableAsJson(),r=i?.[t];if(!r||!r.content||!Array.isArray(r.content)||r.content.length<2)return null;const c=r.content[0],s=o[n];if(null===s)return'_row_0'===e?0:null;if(!s)return null;const l=c.indexOf(s);if(-1===l)return console.warn(`[DICE]findRowIndexByPrimaryKey: 在表 ${n} 中找不到主键字段 ${s}`),null;let d=e;const u=e.indexOf('=');-1!==u&&(d=e.substring(u+1));for(let t=1;t<r.content.length;t++){const n=r.content[t];if(n&&String(n[l])===String(d))return t-1}}catch(t){console.warn('[DICE]findRowIndexByPrimaryKey 失败:',t)}return null}async function u(t){const n=[],{preset:e,matchedOutcome:a,context:o}=t,i=[],r=[],c=Yn||pa();if(!c)throw new Error('效果执行失败：无法获取表格数据');const s=JSON.parse(JSON.stringify(c)),l=new Set,d=new Map;if(t.effectOverrides&&t.effectOverrides.length>0&&t.effectOverrides.forEach(t=>{d.set(t.effectId,t)}),!a.effects||0===a.effects.length)return n;console.info(`[DICE] Executing ${a.effects.length} effects for outcome "${a.name}"`);for(const t of a.effects){if(t.condition){const n={$roll:o.roll,$attr:o.attributeValue,$mod:o.modifier,$dc:o.dc},e=bn(t.condition,n);if(!e.success||!e.value){console.info(`[DICE] Effect ${t.id} skipped: condition "${t.condition}" not met`);continue}}if(e.effectsConfig?.allowedTargets&&e.effectsConfig.allowedTargets.length>0&&!e.effectsConfig.allowedTargets.includes(t.target)){console.warn(`[DICE] Effect ${t.id} blocked: target "${t.target}" not in allowedTargets`);continue}let r,c=0,u='';const f=d.get(t.id);if(f)c=Math.abs(f.computedValue),u=f.formula||String(t.value||'0'),r=Number.isFinite(f.rolledValue)?f.rolledValue:void 0,console.info(`[DICE] Effect ${t.id}: use confirmed override "${f.formula}" => ${f.computedValue}`);else{const n=p(t.value,`Effect ${t.id}`);u=n.formulaText,c=n.finalValue,r=n.rolledValue,n.valid&&console.info(`[DICE] Effect ${t.id}: rolled "${u}" = ${c}`)}const g=[...e.effectsConfig?.allowedTargets||[],o.attributeName].filter((t,n,e)=>Boolean(t)&&e.indexOf(t)===n),m=await Le(o.characterName,t.target,t.operation,c,{initValue:t.initValue,min:t.min,max:t.max,aliasCandidates:g,skipSave:!0,dataOverride:s});m.modifiedSheetKey&&l.add(m.modifiedSheetKey);const b={effectId:t.id,success:m.success,oldValue:m.oldValue,newValue:m.newValue,error:m.error,target:m.resolvedAttrName||t.target,level:1,triggerType:'primary',branchLabel:`L1/${a.name}`,formulaText:u,rolledValue:r};n.push(b),m.success&&i.push({characterName:o.characterName,target:t.target,operation:t.operation,value:c,initValue:t.initValue,min:t.min,max:t.max,aliasCandidates:g,resultRef:b}),m.success?console.info(`[DICE] Effect executed: ${o.characterName}.${m.resolvedAttrName||t.target} ${t.operation} ${c} (${m.oldValue} → ${m.newValue})`):console.error(`[DICE] Effect ${t.id} failed: ${m.error}`)}const u=await f(e,n,{characterName:o.characterName,attributeName:o.attributeName,attributeValue:o.attributeValue},s,l,i,r),g=[...n,...u];return g.some(t=>!t.success)?g.map(t=>t.success?{...t,success:!1,error:t.error||'事务回滚：同批次存在失败效果，整批未提交'}:t):ya(async()=>{const t=Yn||pa();if(!t)return g.map(t=>t.success?{...t,success:!1,error:t.error||'事务回滚：提交阶段无法读取最新数据'}:t);const n=JSON.parse(JSON.stringify(t)),e=new Set;for(const t of i){const a=await Le(t.characterName,t.target,t.operation,t.value,{initValue:t.initValue,min:t.min,max:t.max,aliasCandidates:t.aliasCandidates,skipSave:!0,dataOverride:n});if(!a.success)return g.map(t=>t.success?{...t,success:!1,error:t.error||`事务回滚：最新数据重放失败 (${a.error||'unknown'})`}:t);a.modifiedSheetKey&&e.add(a.modifiedSheetKey),t.resultRef.oldValue=a.oldValue,t.resultRef.newValue=a.newValue,t.resultRef.target=a.resolvedAttrName||t.resultRef.target,t.resultRef.error=void 0}return e.size>0&&await wa(n,Array.from(e)),r.forEach(t=>t()),g})}function p(t,n){const e=String(t??'').trim()||'0',a=gn(e);if(Number.isNaN(a.total))return console.warn(`[DICE] ${n} 效果值解析失败: "${e}"，按 0 处理`),{formulaText:e,finalValue:0,rolledValue:0,valid:!1};const o=Math.round(a.total);return{formulaText:e,finalValue:o,rolledValue:o,valid:!0}}async function f(t,n,e,a,o,i,r){const c=t.secondaryEffects;if(!c||0===c.length)return[];const s=(l=Number(t.secondaryMaxDepth??3),d=1,u=8,Math.max(d,Math.min(u,l)));var l,d,u;const f=new Map,g=[],m=[],b=r||m;let h=n.filter(t=>t.success);const v=()=>{const t=Ue(e.characterName,a),n={};return t.forEach(t=>{t&&'string'==typeof t.name&&'number'==typeof t.value&&!isNaN(t.value)&&(n[t.name]=t.value)}),n},x=(t,n,e)=>{switch(t){case'gt':return n>e;case'gte':return n>=e;case'lt':return n<e;case'lte':return n<=e;case'eq':return n===e;default:return!1}},w=(t,n,e)=>{const a=String(t||'').trim();if(!a)return 0;const o=a.replace(/\{([^}]+)\}/g,'$1'),i=Math.abs(n.newValue-n.oldValue),r=v(),c={...r,$attr:n.newValue,$old:n.oldValue,$new:n.newValue,$delta:i,$depth:e},s=bn(o,c);if(s.success&&void 0!==s.value){const t='boolean'==typeof s.value?s.value?1:0:Number(s.value);if(Number.isFinite(t))return t}const l=o.replace(/\$[a-zA-Z_]\w*/g,t=>{const n=c[t];return'number'==typeof n&&Number.isFinite(n)?String(n):'0'}),d=mn(l,r);if('number'==typeof d&&Number.isFinite(d))return d;const u=parseFloat(o);return Number.isFinite(u)?u:0},y=(t,n)=>String(t||'').replace(/\$([a-zA-Z_]\w*)/g,(t,e)=>{const a=n[`$${e}`];return null==a?t:String(a)}),k=(t,n)=>{const e=y(t,n);return y(e,n)},C=(t,n)=>{if(n)for(const[e,a]of Object.entries(n)){if(!a||!a.dice)continue;const n=gn(a.dice);t[`$${e}Roll`]=n.total;const o=a.entries?.[n.total]??String(n.total);t[`$${e}Result`]=k(o,t)}};for(let n=2;n<=s+1&&0!==h.length;n++){const r=[],s='all'===t.secondaryTriggerMode?'all':'first';for(const l of c){if(!1===l.enabled)continue;const c=Math.max(1,l.maxTriggerCount??1),d=f.get(l.id)||0;if(d>=c)continue;const u=[];for(const t of h){if(!t.success)continue;const e=t.target||t.effectId;if(!Ne(e,l.trigger.attribute))continue;const a=t.newValue,o=Math.abs(t.newValue-t.oldValue),i=w(l.trigger.value,t,n),r='threshold'===l.trigger.type?a:o;if(x(l.trigger.operator,r,i)&&(u.push({result:t,thresholdValue:i}),'first'===s))break}if(0===u.length)continue;const m=Math.max(0,c-d);if(0===m)continue;let E=0;const A=[];for(let c=0;c<u.length&&!(E>=m);c++){const d=u[c],f=d.result,m=d.thresholdValue,h=f.newValue,S=Math.abs(f.newValue-f.oldValue),I=E+1;let D=!1;if(l.callback){const t=window[l.callback];if('function'==typeof t){const a={attrValue:h,delta:S,context:e,depth:n,thresholdValue:m,matchIndex:I,chainMode:s};D=!0;const o=()=>{try{t(l,a),console.info(`[DICE] Secondary effect callback triggered: ${l.id} (depth=${n}, mode=${s}, match=${I}, ${l.trigger.type} ${l.trigger.operator} ${m})`)}catch(t){console.error('[DICE] Secondary effect callback error:',t)}};b.push(o)}}const M=[...l.effects||[]],T=[],N={$delta:S,$old:f.oldValue,$new:f.newValue,$attr:h,$depth:n,$initiator:e.characterName,$attribute:f.target||e.attributeName};if(l.outputText){const t={...N};if(l.randomTable){const n=gn(l.randomTable.dice);t.$tableRoll=n.total;const e=l.randomTable.entries[n.total]||`未知(${n.total})`;t.$tableResult=k(e,t)}C(t,l.randomTables);const e=k(l.outputText,t),a={effectId:l.id,success:!0,oldValue:f.oldValue,newValue:f.newValue,target:f.target,level:n,triggerType:l.trigger.type,triggerSourceId:l.id,triggerThreshold:m,triggerMatchIndex:I,outputMessage:e,branchLabel:`L${n}/${l.id}`};g.push(a),T.push(a)}if(l.subCheck){const t=l.subCheck,a=[t.attribute,...t.attributeCandidates||[]].filter((t,n,e)=>Boolean(t)&&e.indexOf(t)===n),o=t.label||t.attribute;let i=t.attribute,r=null;for(const t of a){const n=Fe(e.characterName,t,a);if('number'==typeof n&&Number.isFinite(n)){i=t,r=n;break}}if(null===r){const e=t.missingAttributeText||'⚠ 无法自动进行$subCheckLabel：发起者缺少属性[$subCheckAttrName]，请手动判定。',a={...N,$subCheckLabel:o,$subCheckAttrName:i},r={effectId:`${l.id}_subcheck_missing`,success:!0,oldValue:f.oldValue,newValue:f.newValue,target:f.target,level:n,triggerType:l.trigger.type,triggerSourceId:l.id,triggerThreshold:m,triggerMatchIndex:I,outputMessage:y(e,a),branchLabel:`L${n}/${l.id}/${o}:缺失属性`};g.push(r),T.push(r)}else{const e=t.dice||'1d100',a=gn(e).total,c='string'==typeof t.targetValue&&t.targetValue.trim().length>0?w(t.targetValue,f,n):r,s=t.operator||'lte',d=x(s,a,c),u=d?'成立':'不成立',p=d?t.success:t.failure,b={...N,$subCheckLabel:o,$subCheckAttrName:i,$subCheckAttrValue:r,$subCheckDice:e,$subCheckRoll:a,$subCheckTarget:c,$subCheckOperator:s,$subCheckPassed:d?1:0,$subCheckJudge:u};if(p?.randomTable){const t=gn(p.randomTable.dice);b.$tableRoll=t.total;const n=p.randomTable.entries[t.total]||`未知(${t.total})`;b.$tableResult=k(n,b)}if(C(b,p?.randomTables),p?.outputText){const t={effectId:`${l.id}_subcheck_${d?'success':'failure'}`,success:!0,oldValue:f.oldValue,newValue:f.newValue,target:f.target,level:n,triggerType:l.trigger.type,triggerSourceId:l.id,triggerThreshold:m,triggerMatchIndex:I,outputMessage:k(p.outputText,b),branchLabel:`L${n}/${l.id}/${o}:${d?'成功':'失败'}`};g.push(t),T.push(t)}p?.effects&&p.effects.length>0&&M.push(...p.effects)}}for(const c of M){if(c.condition){const t=v(),e={$roll:0,$attr:f.newValue,$old:f.oldValue,$new:f.newValue,$delta:S,$depth:n,$mod:0,$dc:0,...t},a=bn(c.condition,e);if(!a.success||!a.value)continue}if(t.effectsConfig?.allowedTargets&&t.effectsConfig.allowedTargets.length>0&&!t.effectsConfig.allowedTargets.includes(c.target))continue;const s=p(c.value,`Secondary ${l.id}/${c.id}`),d=s.finalValue,u=[...t.effectsConfig?.allowedTargets||[],e.attributeName].filter((t,n,e)=>Boolean(t)&&e.indexOf(t)===n),b=await Le(e.characterName,c.target,c.operation,d,{initValue:c.initValue,min:c.min,max:c.max,aliasCandidates:u,skipSave:Boolean(a),dataOverride:a});b.modifiedSheetKey&&o&&o.add(b.modifiedSheetKey);const h={effectId:c.id,success:b.success,oldValue:b.oldValue,newValue:b.newValue,error:b.error,target:b.resolvedAttrName||c.target,level:n,triggerType:l.trigger.type,triggerSourceId:l.id,triggerThreshold:m,triggerMatchIndex:I,branchLabel:`L${n}/${l.id}`,formulaText:s.formulaText,rolledValue:s.rolledValue};r.push(h),g.push(h),T.push(h),b.success&&i&&i.push({characterName:e.characterName,target:c.target,operation:c.operation,value:d,initValue:c.initValue,min:c.min,max:c.max,aliasCandidates:u,resultRef:h})}(D||0!==T.length)&&(E+=1,A.push(T))}if(0!==E){f.set(l.id,d+E);for(const t of A)t.forEach(t=>{t.triggerMatchCount=E})}}h=r.filter(t=>t.success)}if(!r){g.some(t=>!t.success)||m.forEach(t=>t())}return g}function g(t){return t&&0!==t.length?t.map(t=>{const n=t.branchLabel?`[${t.branchLabel}] `:t.level?`[L${t.level}] `:'',e=t.target||'-';if(!t.success&&t.error)return`${n}✗ ${e} 变更失败: ${t.error}`;if(t.outputMessage)return`${n}${t.outputMessage}`;const a=t.newValue-t.oldValue,o=a>0?'+':'',i=t.success?'✓':'✗',r=t.formulaText?` ｜算式:${t.formulaText}${void 0!==t.rolledValue?` ｜掷值:${t.rolledValue}`:''}`:'';return`${n}${i} ${e} ${t.oldValue} → ${t.newValue} (${o}${a})${r}`}):[]}function m(t,n){if(!t||0===t.length)return[];const e='【已填表】以下数值效果已同步填表，无需重复填表。',a=t.filter(t=>t.success).map(t=>{if(t.outputMessage)return t.outputMessage;const n=t.target||'属性',e=t.newValue-t.oldValue,a=e>0?'+':'',o=t.branchLabel?.startsWith('L1/')?t.branchLabel.slice(3):'',i=t.formulaText&&void 0!==t.rolledValue?`，${o?`按${o}分支`:'按当前分支'}算式${t.formulaText}得到${t.rolledValue}`:'';return`${o?`命中${o}分支后，`:''}${n}从${t.oldValue}变为${t.newValue}（变化${a}${e}${i}）`});return a.length>0?[e,...a]:n?.branchReasonText?[e,n.branchReasonText]:[]}const b={STORAGE_KEY_PREFIX:'acu_bookmarks_v1_',MAX_CONTEXTS:20,_cache:null,_currentContextId:null,_getStorageKey(t){return this.STORAGE_KEY_PREFIX+(t||oe())},_cleanupOldContexts(){try{const t=this.STORAGE_KEY_PREFIX,n=[];for(let e=0;e<localStorage.length;e++){const a=localStorage.key(e);a&&a.startsWith(t)&&n.push(a)}if(n.length<=this.MAX_CONTEXTS)return;const e=n.map(t=>{try{const n=JSON.parse(localStorage.getItem(t));return{key:t,time:n?._lastAccess||0}}catch{return{key:t,time:0}}});e.sort((t,n)=>n.time-t.time);const a=e.slice(this.MAX_CONTEXTS);a.forEach(t=>{localStorage.removeItem(t.key)}),a.length>0&&console.log(`[DICE]BookmarkManager 清理了 ${a.length} 个过期的bookmark数据（当前保留 ${this.MAX_CONTEXTS} 个聊天的数据，清理前共有 ${n.length} 个）`)}catch(t){console.warn('[DICE]BookmarkManager 清理失败',t)}},_load(){const t=oe();if(this._currentContextId!==t&&(this._cache=null,this._currentContextId=t),!this._cache)try{const t=localStorage.getItem(this._getStorageKey());this._cache=t?JSON.parse(t):{},delete this._cache._lastAccess}catch(t){this._cache={}}return this._cache},_save(){try{const t={...this._cache,_lastAccess:Date.now()};localStorage.setItem(this._getStorageKey(),JSON.stringify(t)),this._cleanupOldContexts()}catch(t){console.warn('[DICE]BookmarkManager 保存失败',t)}},isBookmarked(t,n){const e=this._load();return!(!e[t]||!e[t][n])},toggleBookmark(t,n){const e=this._load();e[t]||(e[t]={}),e[t][n]?(delete e[t][n],0===Object.keys(e[t]).length&&delete e[t]):e[t][n]=!0,this._save()},getBookmarks(t){const n=this._load();return n[t]?Object.keys(n[t]):[]},clearCurrentContext(){localStorage.removeItem(this._getStorageKey()),this._cache=null}},h=t=>String(t??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),v=t=>{let n='';for(let e=0;e<t.length;e++){const a=t.charCodeAt(e);if(a>=55296&&a<=56319){const a=t.charCodeAt(e+1);a>=56320&&a<=57343?(n+=t[e]+t[e+1],e++):n+='�';continue}a>=56320&&a<=57343?n+='�':n+=t[e]}return n},x=t=>{const n=String(t??'');try{return encodeURIComponent(n)}catch{return encodeURIComponent(v(n))}},w=t=>{const n=String(t??'');try{return decodeURIComponent(n)}catch{return v(n)}},y=(t,n,e)=>{if('ontouchstart'in window||navigator.maxTouchPoints>0)t.on('click',function(t){$(t.target).hasClass(n)&&e()});else{let a=!1;t.on('mousedown',function(t){a=$(t.target).hasClass(n)}),t.on('mouseup',function(t){a&&$(t.target).hasClass(n)&&e(),a=!1})}},k=t=>{const{$}=le();$('.acu-import-confirm-overlay').remove();const n=ca(),e=((t,n)=>{if(!n.includes(t))return t;let e=2,a=`${t} (${e})`;for(;n.includes(a);)e++,a=`${t} (${e})`;return a})(t.presetName,t.existingNames),a=$(`\n      <div class="acu-import-confirm-overlay acu-theme-${n.theme}">\n        <div class="acu-import-confirm-dialog">\n          <div class="acu-import-confirm-header">\n            <i class="fa-solid fa-file-import"></i> 导入${t.presetType}预设\n          </div>\n          <div class="acu-import-confirm-body">\n            <div class="acu-import-warning-container">\n              <i class="fa-solid fa-exclamation-triangle acu-import-warning-icon"></i>\n              <div class="acu-import-warning-title">发现同名预设</div>\n              <div class="acu-import-warning-message">预设「${h(t.presetName)}」已存在，请选择处理方式：</div>\n            </div>\n            <div class="acu-import-conflict-options">\n              <label class="acu-import-radio">\n                <input type="radio" name="preset-conflict-mode" value="overwrite" checked />\n                <span>覆盖现有预设</span>\n              </label>\n              <label class="acu-import-radio">\n                <input type="radio" name="preset-conflict-mode" value="rename" />\n                <span>新建副本（命名为「${h(e)}」）</span>\n              </label>\n            </div>\n          </div>\n          <div class="acu-import-confirm-footer">\n            <button class="acu-import-cancel-btn">取消</button>\n            <button class="acu-import-confirm-btn">确认导入</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(a);a[0].style.cssText='\n      position: fixed !important;\n      top: 0 !important;\n      left: 0 !important;\n      right: 0 !important;\n      bottom: 0 !important;\n      width: 100vw !important;\n      height: 100vh !important;\n      background: rgba(0,0,0,0.6) !important;\n      z-index: 31300 !important;\n      display: flex;\n      justify-content: center !important;\n      align-items: center !important;\n      padding: 16px;\n      box-sizing: border-box !important;\n    ';const o=()=>a.remove();a.find('.acu-import-cancel-btn').click(()=>{o(),t.onCancel()}),y(a,'acu-import-confirm-overlay',()=>{o(),t.onCancel()}),a.find('.acu-import-confirm-btn').click(function(){const n=a.find('input[name="preset-conflict-mode"]:checked').val();o(),'overwrite'===n?t.onOverwrite():t.onRename(e)})},C=(t,n)=>{const{$}=le(),e=$('#send_textarea');if(!e.length)return;const a=t=>String(t??'').replace(/\r\n?/g,'\n').replace(/[ \t]+\n/g,'\n').replace(/\n[ \t]+/g,'\n').replace(/\n{2,}/g,'\n').trim(),o=a(t),i=a(e.val()||''),r=/<meta:检定结果>[\s\S]*?<\/meta:检定结果>/g,c=/<user>(?:(?!<user>).)*?[。！？]/g,s=/\[投骰结果已隐藏\]/g,l=qt();let d=o,u=!1;if('dice'===n&&l.hideDiceResultFromUser&&(d='[投骰结果已隐藏]',u=!0),!i){if(e.val(d).trigger('input').trigger('change'),'dice'===n){e.data('acu-original-dice-text',o);const t=e[0];t._acuOriginalDiceText=o,t._acuHasDiceData=!0}return}let p=i,f='',g='',m='';if(s.test(p)){const t=e.data('acu-original-dice-text')||'';t?(p=p.replace(s,t),g=t,m=t):p=p.replace(s,'').trim()}const b=p.match(r);b&&b.length>0&&(g=b[b.length-1],m=g,p=p.replace(r,'\0').trim(),console.log('[DICE]ACU SmartInsert Found and extracted meta check result:',g.substring(0,50)+'...'));const h=p.match(c);h&&h.length>0&&(f=h[h.length-1],p=p.replace(c,'').trim(),console.log('[DICE]ACU SmartInsert Found and extracted action:',f));let v=p.replace(/[\u0000\u0001]/g,' ').replace(/\s+/g,' ').trim();if('dice'===n&&o.includes('<meta:检定结果>')&&v){const t=(a(o.replace(/<meta:检定结果>/g,'').replace(/<\/meta:检定结果>/g,'')).split('\n')[0]||'').trim(),n=t=>String(t||'').replace(/\s+/g,'').replace(/[：:，。,！？!?.]+$/g,'').trim(),e=n(v),i=n(t);e&&i&&(i.startsWith(e)||e.startsWith(i))&&(v='')}if('dice'===n){g=d,m=o,e.data('acu-original-dice-text',o);const t=e[0];t._acuOriginalDiceText=o,t._acuHasDiceData=!0}else'action'===n&&(f=o);const x=[];v&&x.push(v),f&&x.push(f),g&&x.push(g);const w=a(x.join(' '));e.val(w).trigger('input').trigger('change')},E=()=>{const{$}=le(),t=qt();if(void 0!==t.hideDiceResultFromUser&&t.hideDiceResultFromUser)return;const n=$('#send_textarea');if(!n.length)return;const e=n.val()||'',a=n.data('acu-original-dice-text');if(e.includes('[投骰结果已隐藏]')&&a){const t=e.replace(/\[投骰结果已隐藏\]/g,a);n.val(t),n.removeData('acu-original-dice-text');const o=n[0];o._acuOriginalDiceText=null,o._acuHasDiceData=!1}},A=()=>{const{$}=le(),t=$('#send_textarea');if(!t.length)return;const n=t[0];if(!n||n._acuValueIntercepted)return;n._acuValueIntercepted=!0;const e=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,'value'),a=n.value;Object.defineProperty(n,'value',{get:function(){let t;if(t=e&&e.get?e.get.call(this):this._value||a||'',!this._acuHasDiceData)return t;const n=this._acuOriginalDiceText;return t&&'string'==typeof t&&t.includes('[投骰结果已隐藏]')&&n?t.replace(/\[投骰结果已隐藏\]/g,n):t},set:function(t){e&&e.set?e.set.call(this,t):this._value=t},configurable:!0})},S='acu_table_order',I='acu_active_tab',D='acu_ui_config_v19',M='acu_data_snapshot_v19',T='acu_ui_collapsed_state',N='acu_options_collapsed',F='acu_dashboard_active',P='acu_table_heights_v19',j='acu_table_styles_v19',R='acu_hidden_tables_v19',B='acu_reverse_tables_v1',O=200,V=1200,L='acu_dice_config_v1',U='acu_attribute_presets_v1',q='acu_active_attr_preset_v1',Y='acu_action_presets_v1',W='acu_active_action_preset_v1',J='acu_advanced_presets_v1',H='acu_builtin_preset_visibility',X='acu_builtin_preset_order',K='acu_dice_last_preset',G='acu_dice_crazy_mode',Z={enabled:!1,crazyLevel:50,playerWeight:80,inSceneNpcWeight:15,offSceneNpcWeight:5},Q='1.7.0',tt=(t,n)=>{const e=t=>'number'==typeof t?`${t}.0.0`:'string'!=typeof t?'0.0.0':t,a=e(t),o=e(n),i=a.split('.').map(Number),r=o.split('.').map(Number);for(let t=0;t<Math.max(i.length,r.length);t++){const n=i[t]||0,e=r[t]||0;if(n<e)return-1;if(n>e)return 1}return 0},nt='acu_avatar_map_v1',et='acu_map_focus_v1',at={logs:[],maxLogs:1e3,filters:{log:!0,info:!0,warn:!0,error:!0},originalMethods:{},isIntercepted:!1,enabled:!1,restore(){'true'===localStorage.getItem('acu_console_capture_enabled')&&this.enable()},enable(){this.enabled||(this.enabled=!0,localStorage.setItem('acu_console_capture_enabled','true'),this.intercept())},disable(){if(!this.enabled)return;this.enabled=!1,localStorage.setItem('acu_console_capture_enabled','false'),localStorage.removeItem('acu_script_error_detected');const t=document.getElementById('acu-emergency-debug-btn');t&&(t.style.display='none')},intercept(){this.isIntercepted||(this.isIntercepted=!0,['log','info','warn','error'].forEach(t=>{this.originalMethods[t]=console[t];const n=this;console[t]=function(...e){n.originalMethods[t].apply(console,e),n.enabled&&n.capture(t,e)}}))},capture(t,n){if(this.enabled)try{const e=new Date,a=e.toLocaleTimeString('zh-CN',{hour12:!1}),o=n.map(t=>{if('object'==typeof t)try{return JSON.stringify(t,null,2)}catch{return String(t)}return String(t)}).join(' ');let i=null;'error'===t&&n[0]instanceof Error&&(i=n[0].stack||null);const r={id:Date.now()+Math.random(),timestamp:e,timeStr:a,type:t,content:o,stack:i,rawArgs:n};this.logs.push(r),this.logs.length>this.maxLogs&&this.logs.shift()}catch(t){}},clear(){this.logs=[]},getFilteredLogs(){return this.logs.filter(t=>this.filters[t.type])},setFilters(t){this.filters={...this.filters,...t}}},ot={errorCount:0,errorThreshold:3,lastErrorTime:0,errorWindow:5e3,fatalErrorDetected:!1,isFatalError(t,n,e,a,o){const i=[/jquery/i,/lodash/i,/vue/i,/react/i,/pixi/i,/gsap/i,/toastr/i,/node_modules/i],r=o||t?.stack||'',c=n||'';for(const t of i)if(t.test(r)||t.test(c))return!1;const s=[/acu_visualizer/i,/骰子系统/i,/LockManager/i,/Store/i,/ConsoleCaptureManager/i,/renderInterface/i,/init\s*\(/i];let l=!1;for(const t of s)if(t.test(r)||t.test(c)){l=!0;break}return l},handleError(t,n,e,a,o){try{if(!this.isFatalError(t,n,e,a,o))return;const i=Date.now();i-this.lastErrorTime>this.errorWindow&&(this.errorCount=0),this.errorCount++,this.lastErrorTime=i,this.errorCount>=this.errorThreshold&&!this.fatalErrorDetected&&(this.fatalErrorDetected=!0,this.triggerFatalError())}catch(t){console.error('[DICE]ErrorHandler 处理错误时失败:',t)}},triggerFatalError(){try{at.enabled||at.enable(),localStorage.setItem('acu_script_error_detected','true'),this.showEmergencyButton()}catch(t){console.error('[DICE]ErrorHandler 触发致命错误处理时失败:',t)}},showEmergencyButton(){try{let t=document.getElementById('acu-emergency-debug-btn');if(t)return void(t.style.display='block');t=document.createElement('button'),t.id='acu-emergency-debug-btn',t.innerHTML='<i class="fa-solid fa-bug"></i> 调试',t.style.cssText='\n          position: fixed;\n          bottom: 20px;\n          right: 20px;\n          z-index: 99999;\n          padding: 10px 16px;\n          background: #e74c3c;\n          color: #fff;\n          border: none;\n          border-radius: 6px;\n          font-size: 14px;\n          font-weight: bold;\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);\n          display: flex;\n          align-items: center;\n          gap: 6px;\n          transition: all 0.2s;\n        ',t.onmouseenter=function(){this.style.background='#c0392b',this.style.transform='scale(1.05)'},t.onmouseleave=function(){this.style.background='#e74c3c',this.style.transform='scale(1)'},t.onclick=function(){try{'function'==typeof window.showDebugConsoleModal?window.showDebugConsoleModal():alert('脚本出现错误，请打开浏览器开发者工具（F12）查看控制台')}catch(t){console.error('[DICE]紧急入口按钮点击失败:',t),alert('脚本出现错误，请打开浏览器开发者工具（F12）查看控制台')}},document.body.appendChild(t)}catch(t){console.error('[DICE]显示紧急入口按钮失败:',t)}},checkAndRestore(){try{'true'===localStorage.getItem('acu_script_error_detected')&&(at.enabled||at.enable(),this.showEmergencyButton())}catch(t){console.error('[DICE]ErrorHandler 检查错误状态失败:',t)}}};window.onerror=function(t,n,e,a,o){return ot.handleError(o||t,n,e,a,o?.stack),!1},window.addEventListener('unhandledrejection',function(t){ot.handleError(t.reason,null,null,null,t.reason?.stack)});const it='acu_regex_rules_v1',rt='acu_regex_presets_v1',ct='acu_regex_active_preset_v1',st='acu_regex_enabled_v1';const lt=[{id:'builtin_clear_extreme_words',name:'清除极端词',description:'清除AI常用的极端程度副词和形容词',operation:'replace',pattern:'极度|激烈的|剧烈的|强烈|深刻|极其|极高的|完全|未知',flags:{global:!1,caseInsensitive:!1,multiline:!1},replacement:'',scope:{type:'global'},enabled:!0,priority:50,executeMode:'auto',security:{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4}},{id:'builtin_remove_cliche',name:'去八股',description:'移除AI常见的八股文风格表达',operation:'replace',pattern:'一(丝+)|(、?)不容置疑([的地]?)|(、?)(不易|难以)(觉察|察觉)([的地]?)|(微|几)不可(查|察|闻)([的地]?)|，([^，]*?)指(关节|节|尖)(.*?)白|，([^，]*?)(一抹|弧度)(.*?)([^，]*?)(?=[。，])|支配|掌控|崩溃',flags:{global:!1,caseInsensitive:!1,multiline:!1},replacement:'',scope:{type:'global'},enabled:!0,priority:50,executeMode:'auto',security:{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4}},{id:'builtin_replace_user',name:'统一用户称呼',description:'将常见的用户称呼统一替换为指定名称，可自行修改替换目标',operation:'replace',pattern:'主角|<user>|{{user}}',flags:{global:!1,caseInsensitive:!1,multiline:!1},replacement:'！！请输入你的角色名！！',scope:{type:'global'},enabled:!1,priority:50,executeMode:'auto',security:{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4}},{id:'builtin_remove_negative_traits',name:'去除特殊属性中的负面情绪',description:'删除主角信息表与重要人物表中过于陈腐的性格标签',operation:'replace',pattern:'[^;：:\\s]*(绝望|崩溃|崩坏|恐惧|NTR|羞耻|快感|顺从|侵犯|服从|逻辑|决绝|臣服|屈服|敏感|洗脑)[^;：:\\s]*[:：]\\d+;?\\s?',flags:{global:!1,caseInsensitive:!1,multiline:!1},replacement:'',scope:{type:'table',tableNames:['主角信息','重要人物表']},enabled:!0,priority:50,executeMode:'auto',security:{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4}}],dt='acu_validation_enabled_v1',ut='acu_validation_mode',pt={tableReadonly:{name:'表级只读',scope:'table',icon:'fa-lock',desc:'禁止修改整个表'},rowLimit:{name:'行数限制',scope:'table',icon:'fa-arrows-up-down',desc:'限制表的行数范围'},sequence:{name:'序列递增',scope:'table',icon:'fa-sort-numeric-up',desc:'检查字段值是否严格递增'},required:{name:'必填',scope:'field',icon:'fa-asterisk',desc:'字段不能为空'},format:{name:'格式验证',scope:'field',icon:'fa-font',desc:'正则表达式匹配'},enum:{name:'枚举验证',scope:'field',icon:'fa-list',desc:'值必须在列表中'},numeric:{name:'数值范围',scope:'field',icon:'fa-hashtag',desc:'数值必须在范围内'},relation:{name:'关联验证',scope:'field',icon:'fa-link',desc:'引用其他表的值'},keyValue:{name:'键值对验证',scope:'field',icon:'fa-key',desc:'验证键值对格式和数值范围'}},ft=[{id:'summary_code_sequence',name:'总结表编码递增',description:'编码索引必须从AM0001开始严格递增，不可跳号或重复',enabled:!0,builtin:!0,intercept:!1,targetTable:'总结表',targetColumn:'编码索引',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'编码索引必须从AM0001开始严格递增，发现跳号或重复'},{id:'outline_code_sequence',name:'总体大纲编码递增',description:'编码索引必须从AM0001开始严格递增，不可跳号或重复',enabled:!0,builtin:!0,intercept:!1,targetTable:'总体大纲',targetColumn:'编码索引',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'编码索引必须从AM0001开始严格递增，发现跳号或重复'},{id:'summary_code_required',name:'总结表编码索引必填',description:'编码索引不能为空',enabled:!0,builtin:!0,intercept:!1,targetTable:'总结表',targetColumn:'编码索引',ruleType:'required',config:{},errorMessage:'编码索引不能为空'},{id:'outline_code_required',name:'总体大纲编码索引必填',description:'编码索引不能为空',enabled:!0,builtin:!0,intercept:!1,targetTable:'总体大纲',targetColumn:'编码索引',ruleType:'required',config:{},errorMessage:'编码索引不能为空'},{id:'quest_status_enum',name:'任务表状态',description:'任务状态必须为指定的枚举值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'状态(Enum Tag)',ruleType:'enum',config:{values:['进行中','已完成','已失败','已放弃']},errorMessage:'状态必须为枚举值之一：进行中、已完成、已失败、已放弃'},{id:'quest_type_enum',name:'任务表类型',description:'任务类型必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'类型',ruleType:'enum',config:{values:['主线','支线','日常']},errorMessage:'类型必须为：主线、支线、日常'},{id:'quest_priority_enum',name:'任务表优先级',description:'任务优先级必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'优先级',ruleType:'enum',config:{values:['紧急','重要','普通']},errorMessage:'优先级必须为：紧急、重要、普通'},{id:'quest_progress_format',name:'任务表进度',description:'进度必须为0%~100%格式',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'进度(%)',ruleType:'format',config:{pattern:'^(100|[1-9]?\\d)%$'},errorMessage:'进度必须为0%~100%格式（如：0%、50%、100%）'},{id:'equip_status_enum',name:'装备表状态',description:'装备状态必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'装备表',targetColumn:'状态',ruleType:'enum',config:{values:['已装备','闲置']},errorMessage:'状态必须为：已装备、闲置'},{id:'equip_quality_enum',name:'装备表品质',description:'装备品质必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'装备表',targetColumn:'品质',ruleType:'enum',config:{values:['普通','优秀','稀有','史诗','传说','神话']},errorMessage:'品质必须为：普通、优秀、稀有、史诗、传说、神话'},{id:'item_quality_enum',name:'物品表品质',description:'物品品质必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'物品表',targetColumn:'品质',ruleType:'enum',config:{values:['普通','优秀','稀有','史诗','传说','神话']},errorMessage:'品质必须为：普通、优秀、稀有、史诗、传说、神话'},{id:'skill_type_enum',name:'技能表类型',description:'技能类型必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'技能表',targetColumn:'类型',ruleType:'enum',config:{values:['主动','被动','特质']},errorMessage:'类型必须为：主动、被动、特质'},{id:'skill_quality_enum',name:'技能表品质',description:'技能品质必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'技能表',targetColumn:'品质',ruleType:'enum',config:{values:['普通','优秀','稀有','史诗','传说','神话']},errorMessage:'品质必须为：普通、优秀、稀有、史诗、传说、神话'},{id:'skill_proficiency_range',name:'技能熟练度范围',description:'技能熟练度必须在 0-100 之间',enabled:!0,builtin:!0,intercept:!1,targetTable:'技能表',targetColumn:'熟练度',ruleType:'numeric',config:{min:0,max:100},errorMessage:'熟练度必须在 0-100 之间'},{id:'npc_presence_enum',name:'重要人物在场状态',description:'在场状态必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'在场状态',ruleType:'enum',config:{values:['在场','离场']},errorMessage:'在场状态必须为：在场、离场'},{id:'map_explore_enum',name:'地图点探索状态',description:'探索状态必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'世界地图点',targetColumn:'探索状态',ruleType:'enum',config:{values:['未探索','部分探索','已探索']},errorMessage:'探索状态必须为：未探索、部分探索、已探索'},{id:'map_importance_enum',name:'地图点重要度',description:'重要度必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'世界地图点',targetColumn:'重要度',ruleType:'enum',config:{values:['核心','重要','普通']},errorMessage:'重要度必须为：核心、重要、普通'},{id:'intel_importance_enum',name:'情报重要度',description:'重要度必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要情报',targetColumn:'重要度',ruleType:'enum',config:{values:['核心','重要','普通']},errorMessage:'重要度必须为：核心、重要、普通'},{id:'player_location_relation',name:'主角地点关联',description:'主角所在地点必须存在于世界地图点表',enabled:!1,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'所在地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'所在地点必须是世界地图点表中已存在的详细地点'},{id:'npc_location_relation',name:'NPC地点关联',description:'NPC所在地点必须存在于世界地图点表',enabled:!1,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'所在地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'所在地点必须是世界地图点表中已存在的详细地点'},{id:'element_location_relation',name:'元素地点关联',description:'元素所在地点必须存在于世界地图点表的详细地点',enabled:!1,builtin:!0,intercept:!1,targetTable:'地图元素表',targetColumn:'所在地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'所在地点必须是世界地图点表中已存在的详细地点'},{id:'global_detail_location_relation',name:'全局详细地点关联',description:'当前详细地点必须存在于世界地图点表',enabled:!0,builtin:!0,intercept:!1,targetTable:'全局数据表',targetColumn:'当前详细地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'当前详细地点必须是世界地图点表中已存在的详细地点'},{id:'player_base_attributes_keyvalue',name:'主角基本属性',description:'基本属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'基础属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'基础属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'player_special_attributes_keyvalue',name:'主角特有属性',description:'特有属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'特有属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'特有属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'player_relationships_keyvalue',name:'主角人际关系',description:'人际关系必须为键值对格式',enabled:!0,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'人际关系',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'人际关系格式必须为"角色名:关系词;角色名:关系词"'},{id:'npc_base_attributes_keyvalue',name:'NPC基本属性',description:'基本属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'基础属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'基础属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'npc_special_attributes_keyvalue',name:'NPC特有属性',description:'特有属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'特有属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'特有属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'npc_relationships_keyvalue',name:'NPC人际关系',description:'人际关系必须为键值对格式',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'人际关系',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'人际关系格式必须为"角色名:关系词;角色名:关系词"'},{id:'option_table_single_row',name:'选项表单行限制',description:'选项表必须有且仅有一行数据',enabled:!0,builtin:!0,intercept:!1,targetTable:'选项表',targetColumn:null,ruleType:'rowLimit',config:{min:0,max:1},errorMessage:'选项表必须有且仅有一行数据'}],gt='acu_filter_blacklist_v1',mt='acu_filter_blacklist_version',bt=['时间','地点','备忘','总结','日期','选项','任务','纪要','服装','头像','进度','编码','上限','经验值','消耗','数量','等级','位置','ID','编号','三围','measurements','ages','年龄','order','号码','time','cost','chapter','location','calendar','day','year','month'],ht={getBlacklist(){const t=fe.get(gt,null),n=fe.get(mt,null);if(!t||!Array.isArray(t))return fe.set(gt,[...bt]),fe.set(mt,Q),[...bt];if(!n||tt(n,Q)<0){console.log(`[DICE]BlacklistManager 检测到黑名单版本较旧 (${n||'无版本'})，自动合并新版本`);new Set(t);const e=new Set(bt),a=[...bt];return t.forEach(t=>{e.has(t)||a.push(t)}),fe.set(gt,a),fe.set(mt,Q),a}return t},setBlacklist:t=>Array.isArray(t)?(fe.set(gt,t),fe.set(mt,Q),!0):(console.warn('[DICE]BlacklistManager 设置失败：必须是数组'),!1),resetToDefault:()=>(fe.set(gt,[...bt]),fe.set(mt,Q),!0),isBlacklisted(t){if(!t||'string'!=typeof t)return!1;const n=this.getBlacklist();if(0===n.length)return!1;const e=t.split(/>| > /).map(t=>t.trim()).filter(t=>t),a=e.length>0?e[e.length-1]:t;return n.some(t=>a.includes(t))}},vt='acu_validation_presets_v1',xt='acu_active_preset_id',wt={_cache:null,getAllPresets(){const t=fe.get(vt,null);if(!t)return this._initDefaultPreset(),this._cache;let n=!1;return t.forEach(t=>{if(!t.version||this._compareVersion(t.version,Q)<0){if(console.log(`[DICE]PresetManager 检测到预设 "${t.name}" 版本较旧 (${t.version||'无版本'})，自动更新`),'default'===t.id){const n=t.rules.filter(t=>!t.builtin),e=new Map;t.rules.filter(t=>t.builtin).forEach(t=>{const n=t.id||t.targetTable+'_'+t.ruleType;e.set(n,{enabled:t.enabled,intercept:t.intercept})}),t.rules=[...ft.map(t=>{const n=t.id||t.targetTable+'_'+t.ruleType,a=e.get(n);return{...t,builtin:!0,...a?{enabled:a.enabled,intercept:a.intercept}:{}}}),...n]}else this._mergeBuiltinRules(t);t.version=Q,n=!0}}),n&&(this._save(t),yt.clearCache(),this._cache=null),!n&&this._cache?this._cache:(this._cache=t,t)},getActivePreset(){const t=this.getAllPresets(),n=fe.get(xt,'default');return t.find(t=>t.id===n)||t[0]},setActivePreset(t){return!!this.getAllPresets().find(n=>n.id===t)&&(fe.set(xt,t),yt.clearCache(),console.log('[DICE]PresetManager 切换预设:',t),!0)},createPreset(t){const n=this.getAllPresets(),e={id:'preset_'+Date.now(),name:t||'新预设',builtin:!1,rules:[],version:Q,createdAt:(new Date).toISOString()};return n.push(e),this._save(n),e},duplicatePreset(t){const n=this.getAllPresets().find(n=>n.id===t);if(!n)return null;const e=this.getAllPresets(),a={id:'preset_'+Date.now(),name:n.name+' (副本)',builtin:!1,rules:JSON.parse(JSON.stringify(n.rules)),version:n.version||Q,createdAt:(new Date).toISOString()};return e.push(a),this._save(e),console.log('[DICE]PresetManager 复制预设:',n.name,'->',a.name),a},deletePreset(t){const n=this.getAllPresets(),e=n.find(n=>n.id===t);if(!e||'default'===e.id)return!1;const a=n.filter(n=>n.id!==t);return this._save(a),fe.get(xt)===t&&(fe.set(xt,'default'),yt.clearCache()),console.log('[DICE]PresetManager 删除预设:',t),!0},updatePresetRules(t,n){const e=this.getAllPresets(),a=e.find(n=>n.id===t);return!!a&&(a.rules=n,this._save(e),yt.clearCache(),!0)},exportPreset(t){const n=this.getAllPresets().find(n=>n.id===t);if(!n)return null;return JSON.stringify({format:'acu_preset_v1',version:Q,preset:{name:n.name,rules:n.rules}},null,2)},_compareVersion:(t,n)=>tt(t,n),mergePresetWithDefaults(t){const n=this.getAllPresets(),e=n.find(n=>n.id===t);if(!e)return!1;const a=e.rules.filter(t=>!t.builtin),o=new Set(ft.map(t=>t.id||t.targetTable+'_'+t.ruleType)),i=new Map;ft.forEach(t=>{const n=t.id||t.targetTable+'_'+t.ruleType;i.set(n,t)});const r=[],c=new Set;return ft.forEach(t=>{const n=t.id||t.targetTable+'_'+t.ruleType,a=e.rules.find(t=>(t.id||t.targetTable+'_'+t.ruleType)===n&&t.builtin);if(a){JSON.stringify(a)!==JSON.stringify(t)?r.push({...a,builtin:!0}):r.push({...t,builtin:!0})}else r.push({...t,builtin:!0});c.add(n)}),a.forEach(t=>{const n=t.id||t.targetTable+'_'+t.ruleType;o.has(n)||r.push({...t,builtin:!1})}),e.rules=r,e.version=Q,this._save(n),yt.clearCache(),console.log('[DICE]PresetManager 合并预设:',e.name),!0},importPreset(t,n=!1){try{const e=JSON.parse(t);if('acu_preset_v1'!==e.format||!e.preset)return null;const a=e.version||'0.0.0',o=this._compareVersion(a,Q)<0,i=this.getAllPresets(),r={id:'imported_'+Date.now(),name:e.preset.name||'导入的预设',builtin:!1,rules:e.preset.rules||[],version:a,createdAt:(new Date).toISOString()};return o&&n?(i.push(r),this._save(i),this.mergePresetWithDefaults(r.id),console.log('[DICE]PresetManager 导入并合并预设:',r.name)):(i.push(r),this._save(i),console.log('[DICE]PresetManager 导入预设:',r.name),o&&console.warn('[DICE]PresetManager 预设版本较旧，建议使用 mergePresetWithDefaults 方法合并新版本的默认值')),{preset:r,needsMerge:o&&!n}}catch(t){return console.error('[DICE]PresetManager 导入失败:',t),null}},_initDefaultPreset(){const t=fe.get(vt,null);if(t&&Array.isArray(t))return void(this._cache=t);const n={id:'default',name:'默认预设',builtin:!0,rules:ft.map(t=>({...t})),version:Q,createdAt:(new Date).toISOString()},e=fe.get('acu_validation_rules_v1',[]);e.length>0&&(n.rules.push(...e.map(t=>({...t,builtin:!1}))),console.log('[DICE]PresetManager 迁移旧规则:',e.length,'条')),this._cache=[n],this._save(this._cache),fe.set(xt,'default')},resetDefaultPreset(){const t=this.getAllPresets(),n=t.find(t=>'default'===t.id);if(n){const e=n.rules.filter(t=>!t.builtin);return n.rules=[...ft.map(t=>({...t})),...e],n.version=Q,this._save(t),yt.clearCache(),!0}return!1},_mergeBuiltinRules(t){const n=t.rules.filter(t=>!t.builtin),e=new Set(ft.map(t=>t.id||t.targetTable+'_'+t.ruleType)),a=new Map;t.rules.filter(t=>t.builtin).forEach(t=>{const n=t.id||t.targetTable+'_'+t.ruleType;a.set(n,t)});const o=[];ft.forEach(t=>{const n=t.id||t.targetTable+'_'+t.ruleType,e=a.get(n);e?o.push({...t,enabled:e.enabled,intercept:e.intercept,errorMessage:e.errorMessage,builtin:!0}):o.push({...t,builtin:!0})}),n.forEach(t=>{const n=t.id||t.targetTable+'_'+t.ruleType;e.has(n)||o.push({...t,builtin:!1})}),t.rules=o},_save(t){fe.set(vt,t),this._cache=t},clearCache(){this._cache=null}},yt={_cache:null,_enabledCache:null,getAllRules(){if(this._cache)return this._cache;const t=wt.getActivePreset(),n=this.getEnabledStates(),e=(t?.rules||[]).map(t=>({...t,enabled:void 0!==n[t.id]?n[t.id]:t.enabled}));return this._cache=e,e},getEnabledStates(){return this._enabledCache||(this._enabledCache=fe.get(dt,{})),this._enabledCache},toggleRuleEnabled(t,n){const e=this.getEnabledStates();e[t]=n,fe.set(dt,e),this._enabledCache=e,this._cache=null},toggleRuleIntercept(t,n){const e=wt.getActivePreset();if(!e)return!1;const a=e.rules.find(n=>n.id===t);return!!a&&(a.intercept=n,wt.updatePresetRules(e.id,e.rules),!0)},getEnabledRules(){return this.getAllRules().filter(t=>t.enabled)},addCustomRule(t){if(!t.id||!t.name||!t.targetTable)return console.error('[DICE]ValidationRuleManager 规则缺少必要字段'),!1;const n=wt.getActivePreset();if(!n)return!1;if(n.rules.some(n=>n.id===t.id))return console.error('[DICE]ValidationRuleManager 规则 ID 已存在:',t.id),!1;const e={...t,builtin:!1,enabled:!0};return n.rules.push(e),wt.updatePresetRules(n.id,n.rules),console.log('[DICE]ValidationRuleManager 添加规则:',e.name),!0},removeCustomRule(t){const n=wt.getActivePreset();if(!n)return!1;const e=n.rules.findIndex(n=>n.id===t);if(-1===e)return!1;n.rules.splice(e,1),wt.updatePresetRules(n.id,n.rules);const a=this.getEnabledStates();return delete a[t],fe.set(dt,a),this._enabledCache=a,console.log('[DICE]ValidationRuleManager 删除规则:',t),!0},updateCustomRule(t,n){const e=wt.getActivePreset();if(!e)return!1;const a=e.rules.findIndex(n=>n.id===t);return-1!==a&&(e.rules[a]={...e.rules[a],...n,id:t},wt.updatePresetRules(e.id,e.rules),!0)},getRule(t){return this.getAllRules().find(n=>n.id===t)},clearCache(){this._cache=null,this._enabledCache=null},getRulesByTable(t){return this.getEnabledRules().filter(n=>n.targetTable===t)}},$t={_cache:null,_enabledCache:null,_generateId:()=>`regex_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,getAllRules(){if(this._cache)return this._cache;const t=fe.get(it,[]);return this._cache=t,t},getEnabledStates(){return this._enabledCache||(this._enabledCache=fe.get(st,{})),this._enabledCache},_saveEnabledStates(t){fe.set(st,t),this._enabledCache=t},getEnabledRules(){return this.getAllRules().filter(t=>!1!==t.enabled)},getApplicableRules(t,n){return this.getEnabledRules().filter(e=>{switch(e.scope.type){case'global':return!0;case'table':return e.scope.tableNames&&e.scope.tableNames.includes(t);case'column':return e.scope.tableNames&&e.scope.tableNames.includes(t)&&e.scope.columnNames&&e.scope.columnNames.includes(n);default:return!1}}).sort((t,n)=>n.priority-t.priority)},toggleRuleEnabled(t,n){const e=fe.get(it,[]),a=e.findIndex(n=>n.id===t);-1!==a&&(e[a].enabled=n,fe.set(it,e));const o=kt.getActivePreset();o&&kt.updatePresetRules(o.id,e),this.clearCache()},addCustomRule(t){const n=fe.get(it,[]);if(!t.name||!t.pattern||!t.scope)return console.error('[DICE]RegexTransformationManager: 规则缺少必填字段'),!1;const e={id:this._generateId(),name:t.name,description:t.description,operation:t.operation||'replace',pattern:t.pattern,flags:t.flags||{},replacement:t.replacement,scope:t.scope,enabled:void 0===t.enabled||t.enabled,priority:t.priority||50,executeMode:t.executeMode||'auto',testCases:t.testCases||[],security:t.security||{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4},createdAt:Date.now(),updatedAt:Date.now()};return n.push(e),fe.set(it,n),this.clearCache(),this._syncRulesToActivePreset(),e},_syncRulesToActivePreset(){const t=kt.getActivePreset();if(t){const n=fe.get(it,[]);kt.updatePresetRules(t.id,n)}},removeRule(t){const n=fe.get(it,[]),e=n.findIndex(n=>n.id===t);return-1!==e&&(n.splice(e,1),fe.set(it,n),this.clearCache(),this._syncRulesToActivePreset(),!0)},updateRule(t,n){const e=fe.get(it,[]),a=e.findIndex(n=>n.id===t);return-1!==a&&(e[a]={...e[a],...n,id:t,updatedAt:Date.now()},fe.set(it,e),this.clearCache(),this._syncRulesToActivePreset(),!0)},getRule(t){return this.getAllRules().find(n=>n.id===t)},clearCache(){this._cache=null,this._enabledCache=null}},kt={_cache:null,_compareVersion:(t,n)=>tt(t,n),getAllPresets(){const t=fe.get(rt,null);if(!t||0===t.length){const t={id:'regex_default',name:'默认预设',description:'系统默认的正则转换规则预设',version:Q,rules:lt.map(t=>({...t,builtin:!0})),createdAt:Date.now(),updatedAt:Date.now()};return this._cache=[t],fe.set(rt,this._cache),this._cache}let n=!1;return t.forEach(t=>{if(!t.version||this._compareVersion(t.version,Q)<0){if(console.log(`[DICE]RegexPresetManager 检测到预设 "${t.name}" 版本较旧 (${t.version||'无版本'})，自动更新`),'regex_default'===t.id){const n=(t.rules||[]).filter(t=>!t.builtin),e=new Map;(t.rules||[]).filter(t=>t.builtin).forEach(t=>{e.set(t.id,{enabled:t.enabled})}),t.rules=[...lt.map(t=>{const n=e.get(t.id);return{...t,builtin:!0,...n?{enabled:n.enabled}:{}}}),...n]}else this._mergeBuiltinRules(t);t.version=Q,t.updatedAt=Date.now(),n=!0}}),n&&(this._save(t),$t.clearCache(),this._cache=null),!n&&this._cache?this._cache:(this._cache=t,t)},_mergeBuiltinRules(t){const n=(t.rules||[]).filter(t=>!t.builtin),e=new Set(lt.map(t=>t.id)),a=new Map;(t.rules||[]).filter(t=>t.builtin).forEach(t=>{a.set(t.id,t)});const o=[];lt.forEach(t=>{const n=a.get(t.id);n?o.push({...t,enabled:n.enabled,builtin:!0}):o.push({...t,builtin:!0})}),n.forEach(t=>{e.has(t.id)||o.push({...t,builtin:!1})}),t.rules=o},getActivePreset(){const t=fe.get(ct,'regex_default'),n=this.getAllPresets(),e=n.find(n=>n.id===t)||n[0],a=fe.get(it,[]);if(e&&e.rules&&e.rules.length>0){const t=new Set(a.map(t=>t.id)),n=e.rules.filter(n=>n.builtin&&!t.has(n.id));if(n.length>0){const t=[...n,...a];fe.set(it,t),$t.clearCache(),console.log(`[DICE]RegexPresetManager: 已合并 ${n.length} 条缺失的内置规则`)}}return e},setActivePreset(t){const n=this.getAllPresets().find(n=>n.id===t);return n?(fe.set(ct,t),fe.set(it,n.rules||[]),$t.clearCache(),!0):(console.error('[DICE]RegexPresetManager: 预设不存在',t),!1)},createPreset(t,n){const e=this.getAllPresets();if(e.some(n=>n.name===t))return console.error('[DICE]RegexPresetManager: 预设名称已存在',t),!1;const a=n?e.find(t=>t.id===n):this.getActivePreset(),o={id:`regex_preset_${Date.now()}`,name:t,description:a?.description,version:Q,rules:a?JSON.parse(JSON.stringify(a.rules)):[],createdAt:Date.now(),updatedAt:Date.now()};return e.push(o),this._save(e),o},updatePresetRules(t,n){const e=this.getAllPresets(),a=e.findIndex(n=>n.id===t);return-1!==a&&(e[a].rules=JSON.parse(JSON.stringify(n)),e[a].updatedAt=Date.now(),this._save(e),t===fe.get(ct)&&$t.clearCache(),!0)},deletePreset(t){const n=this.getAllPresets();if(n.length<=1)return console.error('[DICE]RegexPresetManager: 不能删除最后一个预设'),!1;const e=n.findIndex(n=>n.id===t);return-1!==e&&(n.splice(e,1),this._save(n),t===fe.get(ct)&&this.setActivePreset(n[0].id),!0)},exportPreset(t){const n=this.getAllPresets().find(n=>n.id===t);if(!n)return null;const e=this.getActivePreset(),a=e&&e.id===t?fe.get(it,[]):n.rules,o={...n,rules:a};return JSON.stringify(o,null,2)},importPreset(t){try{const n=JSON.parse(t);if(!n.name||!Array.isArray(n.rules))return console.error('[DICE]RegexPresetManager: 预设格式无效'),!1;const e=this.getAllPresets(),a={id:`regex_preset_${Date.now()}`,name:n.name,description:n.description,version:n.version||Q,rules:n.rules.map(t=>({...t,id:$t._generateId()})),createdAt:Date.now(),updatedAt:Date.now()};return e.push(a),this._save(e),a}catch(t){return console.error('[DICE]RegexPresetManager: 导入预设失败',t),!1}},_save(t){fe.set(rt,t),this._cache=t},clearCache(){this._cache=null}},_t={_regexCache:new Map,_buildFlags(t){const n=[];return t.caseInsensitive&&n.push('i'),t.global&&n.push('g'),t.multiline&&n.push('m'),t.unicode&&n.push('u'),t.sticky&&n.push('y'),n.join('')},_getRegex(t,n){const e=t.includes('(?<')||t.includes('(?<='),a=t.includes('(?=')||t.includes('(?!');(e||a)&&!n.unicode&&(n={...n,unicode:!0});const o=this._buildFlags(n),i=`${t}/${o}`;if(this._regexCache.has(i)){const t=this._regexCache.get(i);return t.lastIndex=0,t}try{const n=new RegExp(t,o);return this._regexCache.set(i,n),n}catch(n){return console.error('[DICE]RegexTransformationEngine: 正则表达式错误',t,n),null}},_scoreRegexComplexity(t){let n=0;/(\*|\+|\{)\1{2,}/.test(t)&&(n+=50),/(\.\*|\.\+)[^\[]*\1/.test(t)&&(n+=30);const e=(t.match(/\(/g)||[]).length;return n+=Math.min(5*e,20),n},_getTimeoutForRule(t){const n=this._scoreRegexComplexity(t.pattern),e=t.security?.maxMatchTime||100;return Math.max(e-2*n,50)},_safeReplace(t,n,e){const a=t,o=n.security?.maxInputLength||1e4;if(t.length>o)return{success:!1,oldValue:a,newValue:a,matched:!1,error:`输入长度超过限制(${o})`};try{const o=this._getTimeoutForRule(n),i=Date.now();let r;switch(n.operation){case'replace':r=t.replace(e,n.replacement||'');break;case'delete':r=t.replace(e,'');break;case'validate':e.test(t);r=t;break;default:r=t}const c=Date.now()-i;if(c>o)return console.warn('[DICE]RegexTransformationEngine: 正则匹配超时',n.pattern,c),{success:!1,oldValue:a,newValue:a,matched:!1,error:`匹配超时(${c}ms > ${o}ms)`};return{success:!0,oldValue:a,newValue:r,matched:a!==r||e.test(a)}}catch(t){return console.error('[DICE]RegexTransformationEngine: 正则替换错误',n.pattern,t),{success:!1,oldValue:a,newValue:a,matched:!1,error:String(t)}}},applyToValue(t,n){if(null==t)return{success:!0,oldValue:'',newValue:'',matched:!1};const e=String(t);let a=n.pattern,o=n.flags||{};const i=this._extractFlags(a);i.patternWithoutFlags!==a&&(a=i.patternWithoutFlags,o={...o,...i.flags}),void 0===o.global&&(o.global=!0);const r=this._getRegex(a,o);return r?this._safeReplace(e,n,r):{success:!1,oldValue:e,newValue:e,matched:!1,error:'无效的正则表达式'}},_extractFlags(t){const n={global:!1,caseInsensitive:!1,multiline:!1,unicode:!1,sticky:!1},e=t.match(/^\/(.+)\/([gimuy]*)$/);if(e){const[,t,a]=e;return a.includes('g')&&(n.global=!0),a.includes('i')&&(n.caseInsensitive=!0),a.includes('m')&&(n.multiline=!0),a.includes('u')&&(n.unicode=!0),a.includes('y')&&(n.sticky=!0),{flags:n,patternWithoutFlags:t}}return{flags:n,patternWithoutFlags:t}},applyToTable(t,n){let e=0;const a=[],o=[];try{let i=!1,r=new Map;if('name'in t&&'headers'in t&&'rows'in t){i=!0;const n=t;r.set(n.name,{sheet:n,sheetKey:n.name,name:n.name,headers:n.headers,contentRowIndex:-1})}else{const n=t;Object.keys(n).forEach(t=>{if(!t.startsWith('sheet_'))return;const e=n[t];if(!e||!e.content||!Array.isArray(e.content)||e.content.length<1)return void console.warn(`[DICE]applyToTable: 跳过无效表格 ${t}`);const a=e.name||t;r.set(a,{sheet:e,sheetKey:t,name:a,headers:e.content[0]||[],contentRowIndex:0})})}if(0===r.size)return console.warn('[DICE]applyToTable: 没有有效的表格数据'),{totalApplied:0,errors:['没有有效的表格数据'],modifiedSheetKeys:[]};for(const[t,c]of r.entries()){const{sheet:r,headers:s,sheetKey:l}=c;let d=!1;for(const o of n){if(!o.enabled)continue;const n=o.scope;if('global'===n.type||n.tableNames?.includes(t))try{if(i){const i=r.rows;for(let r=0;r<i.length;r++){const c=i[r];for(let i=0;i<c.length;i++){const r=s[i];if('column'===n.type&&!n.columnNames?.includes(r))continue;const l=this.applyToValue(c[i],o);l.success?l.matched&&(c[i]=l.newValue,e++,d=!0):a.push(`${o.name} [${t}]: ${l.error}`)}}}else{const i=r.content;for(let r=1;r<i.length;r++){const c=i[r];if(Array.isArray(c))for(let i=0;i<c.length;i++){const l=s[i];if('column'===n.type&&!n.columnNames?.includes(l))continue;const u=c[i],p=this.applyToValue(u,o);p.success?p.matched&&(c[i]=p.newValue,e++,d=!0,console.debug(`[DICE]正则转换: ${t}[${r}].${l}`,`"${p.oldValue}" -> "${p.newValue}"`)):a.push(`${o.name} [${t}]: ${p.error}`)}}}}catch(n){const e=n instanceof Error?n.message:String(n);console.error(`[DICE]applyToTable: 处理表格 ${t} 时出错:`,n),a.push(`${o.name} [${t}]: 处理表格时出错 - ${e}`)}}d&&l&&o.push(l)}e>0&&console.info(`[DICE]applyToTable: 成功应用 ${e} 处转换`),a.length>0&&console.warn(`[DICE]applyToTable: 遇到 ${a.length} 个错误`)}catch(t){const n=t instanceof Error?t.message:String(t);console.error('[DICE]applyToTable: 执行失败:',t),a.push(`执行失败: ${n}`)}return{totalApplied:e,errors:a,modifiedSheetKeys:o}},applyToCell(t,n,e,a){const o=$t.getApplicableRules(n,e);if(0===o.length)return{success:!0,oldValue:t||'',newValue:t||'',matched:!1};let i=o;if(a&&(i=o.filter(t=>t.executeMode===a||'auto'===t.executeMode)),0===i.length)return{success:!0,oldValue:t||'',newValue:t||'',matched:!1};let r=t||'',c=!1;for(const t of i){const n=this.applyToValue(r,t);if(!n.success)return n;n.matched&&(c=!0),r=n.newValue}return{success:!0,oldValue:t||'',newValue:r,matched:c}},applyToRow(t,n,e,a){return t.map((t,o)=>{const i=n[o];return this.applyToCell(t,e,i,a).newValue})},previewBatchTransform(t,n){const e=t.name,a=$t.getApplicableRules(e,null).filter(t=>'global'===t.scope.type||t.scope.tableNames?.includes(e)),o=[];for(const n of a){const a=[];let i=0;for(let o=0;o<t.rows.length;o++){const r=t.rows[o];for(let c=0;c<r.length;c++){const s=t.headers[c],l=r[c];if('column'===n.scope.type){if(!n.scope.columnNames?.includes(s)||!n.scope.tableNames?.includes(e))continue}else if('table'===n.scope.type&&!n.scope.tableNames?.includes(e))continue;const d=this.applyToValue(l,n);d.matched&&d.oldValue!==d.newValue&&(a.push({tableName:e,rowIndex:o,columnIndex:c,columnName:s,oldValue:d.oldValue,newValue:d.newValue}),i++)}}i>0&&o.push({rule:n,affectedCells:a,totalAffected:i})}return o},clearRegexCache(){this._regexCache.clear()}},Ct={findColumnIndex(t,n){const e=t.indexOf(n);if(-1!==e)return e;for(let e=0;e<t.length;e++){const a=t[e];if(a&&a.includes(n))return e}return-1},validateFormat(t,n){if(null==t||''===t)return!0;try{return new RegExp(n).test(String(t))}catch(t){return console.error('[DICE]ValidationEngine 正则表达式错误:',n,t),!0}},validateEnum:(t,n)=>null==t||''===t||(!Array.isArray(n)||0===n.length||n.includes(String(t))),validateNumeric(t,n,e){if(null==t||''===t)return!0;const a=String(t);let o;if(a.endsWith('%'))o=parseFloat(a);else if(a.includes('/')){const t=a.split('/');o=parseFloat(t[0])}else if(a.includes(':')){const t=a.split(':');o=parseFloat(t[t.length-1])}else o=parseFloat(a);return!isNaN(o)&&(!(null!=n&&o<n)&&!(null!=e&&o>e))},validateRelation(t,n,e,a){if(null==t||''===t)return!0;if(!n||!e||!a)return!0;let o=null;for(const t in n)if(n[t]?.name===e){o=n[t];break}if(!o||!o.content||o.content.length<2)return!0;const i=o.content[0],r=String(t),c=Array.isArray(a)?a:[a];for(const t of c){const n=i.indexOf(t);if(-1!==n)for(let t=1;t<o.content.length;t++)if(String(o.content[t][n]||'')===r)return!0}return 0===c.length},validateRequired:t=>null!=t&&''!==String(t).trim(),validateKeyValue(t,n){if(null==t||''===t)return!0;const e=n?.valueType||'text',a=n?.valueMin,o=n?.valueMax;let i=String(t);i=i.replace(/：/g,':').replace(/；/g,';').replace(/，/g,';'),i=i.replace(/\s+/g,'');const r=i.split(';').filter(t=>t.trim());if(0===r.length)return!1;for(const t of r){const n=t.indexOf(':');if(-1===n||0===n||n===t.length-1)return!1;const i=t.substring(0,n),r=t.substring(n+1);if(!i||!r)return!1;if('numeric'===e){if(!/^-?\d+(\.\d+)?$/.test(r.trim()))return!1;const t=parseFloat(r);if(isNaN(t))return!1;if(null!=a&&t<a)return!1;if(null!=o&&t>o)return!1}}return!0},validateTableReadonly:(t,n)=>!t||!n||JSON.stringify(t)===JSON.stringify(n),validateRowLimit:(t,n,e)=>!(null!=n&&t<n)&&!(null!=e&&t>e),validateSequence(t,n,e){if(!t||!t.content||t.content.length<2)return!0;if(!n||!e)return!0;const a=t.content[0]||[],o=t.content.slice(1)||[],i=a.indexOf(n);if(i<0)return!0;const r=e.prefix||'',c=void 0!==e.startFrom?e.startFrom:1,s=[],l=[];for(let t=0;t<o.length;t++){const n=o[t]?.[i];if(l.push({rowIndex:t,rawValue:n,type:typeof n}),null==n||''===n)continue;const e=String(n).trim();if(e)if(r){const n=r.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),a=new RegExp(`^${n}(\\d+)$`),o=e.match(a);if(o){const n=parseInt(o[1],10);isNaN(n)||s.push({rowIndex:t,value:e,num:n})}}else{const n=parseInt(e,10);isNaN(n)||s.push({rowIndex:t,value:e,num:n})}}if(0===s.length)return!0;s.sort((t,n)=>t.rowIndex-n.rowIndex);if(new Set(s.map(t=>t.num)).size!==s.length)return!1;for(let t=0;t<s.length;t++){const n=c+t;if(s[t].num!==n)return!1}return!0},checkTableRules(t,n,e){const a=[];if(!t||!n||!e)return a;for(const o of e){if(!o.enabled||!o.intercept)continue;const e=pt[o.ruleType];if(!e)continue;let i=null,r=null;for(const n in t)if(t[n]?.name===o.targetTable){i=t[n];break}for(const t in n)if(n[t]?.name===o.targetTable){r=n[t];break}if(r){if('table'===e.scope)if('tableReadonly'===o.ruleType)this.validateTableReadonly(i?.content,r?.content)||a.push({rule:o,tableName:o.targetTable,message:o.errorMessage||`表 "${o.targetTable}" 为只读，不允许修改`});else if('rowLimit'===o.ruleType){const t=(r.content?.length||1)-1;this.validateRowLimit(t,o.config?.min,o.config?.max)||a.push({rule:o,tableName:o.targetTable,message:o.errorMessage||`表 "${o.targetTable}" 行数 ${t} 超出限制 (${o.config?.min||0}-${o.config?.max||'∞'})`})}else'sequence'===o.ruleType&&o.targetColumn&&(this.validateSequence(r,o.targetColumn,o.config||{})||a.push({rule:o,tableName:o.targetTable,message:o.errorMessage||`字段 "${o.targetColumn}" 的编码索引必须从${o.config?.prefix||''}${String(o.config?.startFrom||1).padStart(4,'0')}开始严格递增，不可跳号或重复`}));else if('field'===e.scope&&o.targetColumn){const t=r.content?.[0]||[],e=this.findColumnIndex(t,o.targetColumn);if(-1===e)continue;for(let t=1;t<(r.content?.length||0);t++){const i=r.content[t],c=i?.[e];if(!this.validateValue(c,o,n)){a.push({rule:o,tableName:o.targetTable,rowIndex:t,columnName:o.targetColumn,currentValue:String(c??''),message:o.errorMessage||`字段 "${o.targetColumn}" 验证失败`});break}}}}else'rowLimit'===o.ruleType&&o.config?.min&&o.config.min>0&&a.push({rule:o,tableName:o.targetTable,message:o.errorMessage||`表 "${o.targetTable}" 不存在或为空 (需要至少 ${o.config.min} 行)`})}return a},validateValue(t,n,e){switch(n.ruleType){case'format':return this.validateFormat(t,n.config?.pattern);case'enum':return this.validateEnum(t,n.config?.values);case'numeric':return this.validateNumeric(t,n.config?.min,n.config?.max);case'relation':return this.validateRelation(t,e,n.config?.refTable,n.config?.refColumn);case'required':return this.validateRequired(t);case'keyValue':return this.validateKeyValue(t,n.config);default:return!0}},validateRow(t,n,e,a,o,i){const r=[],c=t[1]||t[0]||`行 ${a+1}`;for(const s of o){if(s.targetTable!==e)continue;if(!s.enabled)continue;const o=this.findColumnIndex(n,s.targetColumn);if(-1===o)continue;const l=t[o];this.validateValue(l,s,i)||r.push({ruleId:s.id,ruleName:s.name,ruleType:s.ruleType,rule:s,tableName:e,rowIndex:a,columnName:s.targetColumn,currentValue:String(l??''),rowTitle:c,errorMessage:s.errorMessage,severity:'error'})}return r},validateAllData(t){if(!t)return[];const n=yt.getEnabledRules();if(0===n.length)return[];const e=[];for(const a in t){if(!a.startsWith('sheet_'))continue;const o=t[a];if(!o?.name||!o?.content)continue;const i=o.name,r=o.content[0],c=n.filter(t=>t.targetTable===i);if(0===c.length)continue;for(const t of c){const n=pt[t.ruleType];if('table'===n?.scope)if('rowLimit'===t.ruleType){const n=o.content.length-1;this.validateRowLimit(n,t.config?.min,t.config?.max)||e.push({ruleId:t.id,ruleName:t.name,ruleType:t.ruleType,rule:t,tableName:i,rowIndex:-1,columnName:'',currentValue:`${n} 行`,errorMessage:t.errorMessage||`行数 ${n} 超出限制 (${t.config?.min||0}-${t.config?.max||'∞'})`,severity:'warning'})}else if('sequence'===t.ruleType&&t.targetColumn){if(!this.validateSequence(o,t.targetColumn,t.config||{})){const n={ruleId:t.id,ruleName:t.name,ruleType:t.ruleType,rule:t,tableName:i,rowIndex:-1,columnName:t.targetColumn,currentValue:'',errorMessage:t.errorMessage||`字段 "${t.targetColumn}" 的编码索引必须从${t.config?.prefix||''}${String(t.config?.startFrom||1).padStart(4,'0')}开始严格递增，不可跳号或重复`,severity:'error'};e.push(n)}}}const s=c.filter(t=>'table'!==pt[t.ruleType]?.scope);for(let n=1;n<o.content.length;n++){const a=o.content[n],c=this.validateRow(a,r,i,n-1,s,t);e.push(...c)}}return e},validateTable(t,n){if(!t)return[];const e=yt.getRulesByTable(n);if(0===e.length)return[];let a=null;for(const e in t)if(t[e]?.name===n){a=t[e];break}if(!a||!a.content||a.content.length<2)return[];const o=a.content[0],i=[];for(let r=1;r<a.content.length;r++){const c=a.content[r],s=this.validateRow(c,o,n,r-1,e,t);i.push(...s)}return i},groupErrorsByTable(t){const n={};for(const e of t)n[e.tableName]||(n[e.tableName]=[]),n[e.tableName].push(e);return n},getErrorCount(t){return this.validateAllData(t).length}},Et={DB_NAME:'acu_local_avatars',STORE_NAME:'avatars',DB_VERSION:1,_db:null,_urlCache:new Map,async init(){return this._db?this._db:new Promise((t,n)=>{const e=indexedDB.open(this.DB_NAME,this.DB_VERSION);e.onerror=()=>{console.error('[DICE]LocalAvatarDB 打开数据库失败:',e.error),n(e.error)},e.onsuccess=()=>{this._db=e.result,t(this._db)},e.onupgradeneeded=t=>{const n=t.target.result;n.objectStoreNames.contains(this.STORE_NAME)||n.createObjectStore(this.STORE_NAME,{keyPath:'name'})}})},async save(t,n){if(!t||!n)return!1;try{const e=await this.init();return new Promise((a,o)=>{const i=e.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME);this._urlCache.has(t)&&(URL.revokeObjectURL(this._urlCache.get(t)),this._urlCache.delete(t));const r={name:t,blob:n,size:n.size,type:n.type,updatedAt:Date.now()},c=i.put(r);c.onsuccess=()=>a(!0),c.onerror=()=>{console.error('[DICE]LocalAvatarDB 保存失败:',c.error),o(c.error)}})}catch(t){return console.error('[DICE]LocalAvatarDB save error:',t),!1}},async get(t){if(!t)return null;if(this._urlCache.has(t))return this._urlCache.get(t);try{const n=await this.init();return new Promise(e=>{const a=n.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).get(t);a.onsuccess=()=>{const n=a.result;if(n&&n.blob){const a=URL.createObjectURL(n.blob);this._urlCache.set(t,a),e(a)}else e(null)},a.onerror=()=>e(null)})}catch(t){return console.error('[DICE]LocalAvatarDB get error:',t),null}},async has(t){if(!t)return!1;try{const n=await this.init();return new Promise(e=>{const a=n.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getKey(t);a.onsuccess=()=>e(void 0!==a.result),a.onerror=()=>e(!1)})}catch(t){return!1}},async delete(t){if(!t)return!1;try{this._urlCache.has(t)&&(URL.revokeObjectURL(this._urlCache.get(t)),this._urlCache.delete(t));const n=await this.init();return new Promise(e=>{const a=n.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).delete(t);a.onsuccess=()=>e(!0),a.onerror=()=>e(!1)})}catch(t){return console.error('[DICE]LocalAvatarDB delete error:',t),!1}},async getAllNames(){try{const t=await this.init();return new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAllKeys();e.onsuccess=()=>n(e.result||[]),e.onerror=()=>n([])})}catch(t){return[]}},async getStats(){try{const t=await this.init();return new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAll();e.onsuccess=()=>{const t=e.result||[],a=t.reduce((t,n)=>t+(n.size||0),0);n({count:t.length,totalSize:a,totalSizeMB:(a/1024/1024).toFixed(2)})},e.onerror=()=>n({count:0,totalSize:0,totalSizeMB:'0'})})}catch(t){return{count:0,totalSize:0,totalSizeMB:'0'}}},async clearAll(){try{this._urlCache.forEach(t=>URL.revokeObjectURL(t)),this._urlCache.clear();const t=await this.init();return new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).clear();e.onsuccess=()=>n(!0),e.onerror=()=>n(!1)})}catch(t){return console.error('[DICE]LocalAvatarDB clearAll error:',t),!1}}},At={DB_NAME:'acu_favorites',STORE_NAME:'items',DB_VERSION:1,_db:null,async init(){return this._db?this._db:new Promise((t,n)=>{const e=indexedDB.open(this.DB_NAME,this.DB_VERSION);e.onerror=()=>{console.error('[DICE]FavoritesDB 打开数据库失败:',e.error),n(e.error)},e.onsuccess=()=>{this._db=e.result,t(this._db)},e.onupgradeneeded=t=>{const n=t.target.result;n.objectStoreNames.contains(this.STORE_NAME)||n.createObjectStore(this.STORE_NAME,{keyPath:'id'})}})},async add(t){if(!t||!t.id)return!1;try{const n=await this.init();return new Promise((e,a)=>{const o=n.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).add(t);o.onsuccess=()=>e(!0),o.onerror=()=>{console.error('[DICE]FavoritesDB add 失败:',o.error),a(o.error)}})}catch(t){return console.error('[DICE]FavoritesDB add error:',t),!1}},async get(t){if(!t)return null;try{const n=await this.init();return new Promise(e=>{const a=n.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).get(t);a.onsuccess=()=>{e(a.result||null)},a.onerror=()=>e(null)})}catch(t){return console.error('[DICE]FavoritesDB get error:',t),null}},async update(t,n){if(!t)return!1;try{const e=await this.get(t);if(!e)return!1;const a={...e,...n,id:e.id,updatedAt:Date.now()},o=await this.init();return new Promise((t,n)=>{const e=o.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).put(a);e.onsuccess=()=>t(!0),e.onerror=()=>{console.error('[DICE]FavoritesDB update 失败:',e.error),n(e.error)}})}catch(t){return console.error('[DICE]FavoritesDB update error:',t),!1}},async delete(t){if(!t)return!1;try{const n=await this.init();return new Promise(e=>{const a=n.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).delete(t);a.onsuccess=()=>e(!0),a.onerror=()=>e(!1)})}catch(t){return console.error('[DICE]FavoritesDB delete error:',t),!1}},async getAll(){try{const t=await this.init();return new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAll();e.onsuccess=()=>n(e.result||[]),e.onerror=()=>n([])})}catch(t){return console.error('[DICE]FavoritesDB getAll error:',t),[]}},async getAllTags(){try{const t=await this.getAll(),n=new Set;for(const e of t)if(e.tags&&Array.isArray(e.tags))for(const t of e.tags)t&&n.add(t);return Array.from(n).sort()}catch(t){return console.error('[DICE]FavoritesDB getAllTags error:',t),[]}},async getByTag(t){if(!t)return[];try{return(await this.getAll()).filter(n=>n.tags&&n.tags.includes(t))}catch(t){return console.error('[DICE]FavoritesDB getByTag error:',t),[]}},async clear(){try{const t=await this.init();return new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).clear();e.onsuccess=()=>n(!0),e.onerror=()=>n(!1)})}catch(t){return console.error('[DICE]FavoritesDB clear error:',t),!1}},async count(){try{const t=await this.init();return new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).count();e.onsuccess=()=>n(e.result||0),e.onerror=()=>n(0)})}catch(t){return console.error('[DICE]FavoritesDB count error:',t),0}}},St={DB_NAME:'acu_dice_history_stats',STORE_NAME:'records',DB_VERSION:1,_db:null,async init(){return this._db?this._db:new Promise((t,n)=>{const e=indexedDB.open(this.DB_NAME,this.DB_VERSION);e.onerror=()=>{console.error('[DICE]DiceHistoryStatsDB 打开数据库失败:',e.error),n(e.error)},e.onsuccess=()=>{this._db=e.result,t(this._db)},e.onupgradeneeded=t=>{const n=t.target.result;if(!n.objectStoreNames.contains(this.STORE_NAME)){const t=n.createObjectStore(this.STORE_NAME,{keyPath:'id',autoIncrement:!0});t.createIndex('eventType','eventType',{unique:!1}),t.createIndex('timestamp','timestamp',{unique:!1}),t.createIndex('chatId','chatId',{unique:!1}),t.createIndex('characterId','characterId',{unique:!1}),t.createIndex('chatCharacter',['chatId','characterId'],{unique:!1})}}})},async add(t){try{const n=await this.init();await new Promise(e=>{const a=n.transaction(this.STORE_NAME,'readwrite');a.oncomplete=()=>e(),a.onerror=()=>{console.warn('[DICE]DiceHistoryStatsDB add 失败:',a.error),e()},a.objectStore(this.STORE_NAME).add(t)})}catch(t){console.warn('[DICE]DiceHistoryStatsDB add error:',t)}},async getAll(){try{const t=await this.init();return await new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAll();e.onsuccess=()=>n(e.result||[]),e.onerror=()=>n([])})}catch(t){return console.warn('[DICE]DiceHistoryStatsDB getAll error:',t),[]}},async clear(){try{const t=await this.init();await new Promise(n=>{const e=t.transaction(this.STORE_NAME,'readwrite');e.oncomplete=()=>n(),e.onerror=()=>n(),e.objectStore(this.STORE_NAME).clear()})}catch(t){console.warn('[DICE]DiceHistoryStatsDB clear error:',t)}},async recordEvent(t,n){if('check'!==t&&'contest'!==t)return;const e=Nt(),a=n,o=Date.now(),i=Number(a.timestamp),r={eventType:t,timestamp:Number.isFinite(i)?i:o,chatId:e.chatId,characterId:e.characterId,success:!1,attrName:'',formula:'',total:0,target:0,outcomeText:''};if('check'===t)r.success=Boolean(a.success),r.attrName=String(a.attrName||'检定'),r.formula=String(a.formula||''),r.total=Number(a.total)||0,r.target=Number(a.target)||0,r.outcomeText=String(a.outcomeText||(r.success?'成功':'失败'));else{const t=String(a.winner||'tie');r.success='tie'!==t;const n=a.left||{},e=a.right||{};r.attrName=`${String(n.attribute||'')} vs ${String(e.attribute||'')}`.trim()||'对抗检定',r.formula='contest',r.total=Number(n.roll)||0,r.target=Number(n.target)||0,r.outcomeText=String(a.message||('tie'===t?'平局':'分出胜负'))}await this.add(r)},summarize(t){const n=t.filter(t=>'check'===t.eventType),e=t.filter(t=>'contest'===t.eventType),a=n.filter(t=>t.success).length,o=n.length>0?Number((a/n.length*100).toFixed(1)):0;return{total:t.length,checks:n.length,contests:e.length,checkSuccess:a,checkSuccessRate:o}},async getDashboardStats(){const t=await this.getAll(),n=Nt(),e='unknown_chat'!==n.chatId,a='unknown_character'!==n.characterId,o=e?t.filter(t=>t.chatId===n.chatId&&'unknown_chat'!==t.chatId):[],i=a?t.filter(t=>t.characterId===n.characterId&&'unknown_character'!==t.characterId):[];return{chat:this.summarize(o),character:this.summarize(i),global:this.summarize(t)}}},It={async addFavorite(t,n,e,a,o=[]){try{const i=SillyTavern.getCurrentChatId()||'',r={id:crypto.randomUUID(),header:e,rowData:a,tags:o,createdAt:Date.now(),updatedAt:Date.now(),sourceInfo:{tableUid:t,tableName:n,chatId:i}};return await At.add(r)?(console.log('[DICE]FavoritesManager 添加收藏:',r.id),r):null}catch(t){return console.error('[DICE]FavoritesManager addFavorite error:',t),null}},async updateFavorite(t,n){try{const e=await At.update(t,n);return e&&console.log('[DICE]FavoritesManager 更新收藏:',t),e}catch(t){return console.error('[DICE]FavoritesManager updateFavorite error:',t),!1}},async duplicateFavorite(t){try{const n=await At.get(t);if(!n)return null;const e={...n,id:crypto.randomUUID(),createdAt:Date.now(),updatedAt:Date.now()};return await At.add(e)?(console.log('[DICE]FavoritesManager 复制收藏:',t,'->',e.id),e):null}catch(t){return console.error('[DICE]FavoritesManager duplicateFavorite error:',t),null}},async deleteFavorite(t){try{const n=await At.delete(t);return n&&console.log('[DICE]FavoritesManager 删除收藏:',t),n}catch(t){return console.error('[DICE]FavoritesManager deleteFavorite error:',t),!1}},async addTag(t,n){try{const e=await At.get(t);return!!e&&(!!e.tags.includes(n)||(e.tags.push(n),await At.update(t,{tags:e.tags})))}catch(t){return console.error('[DICE]FavoritesManager addTag error:',t),!1}},async removeTag(t,n){try{const e=await At.get(t);if(!e)return!1;const a=e.tags.indexOf(n);return!(a>-1)||(e.tags.splice(a,1),await At.update(t,{tags:e.tags}))}catch(t){return console.error('[DICE]FavoritesManager removeTag error:',t),!1}},getAllTags:async()=>await At.getAllTags(),getAll:async()=>await At.getAll(),getByTag:async t=>await At.getByTag(t),getById:async t=>await At.get(t),findCompatibleTables(t,n){const e=[];for(const a in n){const o=n[a];if(!o||!o.content||!o.content[0])continue;const i=o.content[0].slice(1).map(t=>String(t||'')),r=t.header.length===i.length&&t.header.every((t,n)=>t===i[n]),c=t.header.filter(t=>i.includes(t)),s=t.header.filter(t=>!i.includes(t)),l=t.header.length>0?c.length/t.header.length:0;r?e.push({tableUid:a,tableName:o.name||a,mode:'strict',matchedCols:c,unmatchedCols:s,matchRatio:1}):l>0&&e.push({tableUid:a,tableName:o.name||a,mode:'loose',matchedCols:c,unmatchedCols:s,matchRatio:l})}return e.sort((t,n)=>'strict'===t.mode&&'strict'!==n.mode?-1:'strict'!==t.mode&&'strict'===n.mode?1:n.matchRatio-t.matchRatio)},mapRowToTable(t,n){const e=[null];for(const a of n){const n=t.header.indexOf(a);e.push(n>=0?t.rowData[n]:'')}return e},async exportFavorites(){try{const t=await At.getAll(),n={version:1,exportedAt:Date.now(),items:t};return JSON.stringify(n,null,2)}catch(t){return console.error('[DICE]FavoritesManager exportFavorites error:',t),''}},async importFavorites(t){try{const n=JSON.parse(t);if(!n||!n.items||!Array.isArray(n.items))return console.error('[DICE]FavoritesManager 导入格式无效'),null;let e=0,a=0;for(const t of n.items){if(!t.id||!t.header||!t.rowData)continue;if(await At.get(t.id))await At.update(t.id,{header:t.header,rowData:t.rowData,tags:t.tags||[],updatedAt:Date.now(),sourceInfo:t.sourceInfo}),a++;else{const n={id:t.id,header:t.header,rowData:t.rowData,tags:t.tags||[],createdAt:t.createdAt||Date.now(),updatedAt:Date.now(),sourceInfo:t.sourceInfo};await At.add(n),e++}}return console.log('[DICE]FavoritesManager 导入完成:',e,'新增,',a,'更新'),{added:e,updated:a}}catch(t){return console.error('[DICE]FavoritesManager importFavorites error:',t),null}}},Dt=()=>{const t=Yn||('function'==typeof pa?pa():null);if(t)for(const n in t){const e=t[n];if(e?.name?.includes('主角')&&e.content?.[1]?.[1])return e.content[1][1]}return null},Mt=()=>{try{const t=window.parent||window;if(t.SillyTavern?.getContext){const n=t.SillyTavern.getContext();if(n?.name1)return n.name1}if('undefined'!=typeof name1&&name1)return name1;if(t.name1)return t.name1;const $=t.jQuery||window.jQuery;if($){const t=$('#user_avatar_block .avatar-name, #persona_name_input').first();if(t.length){const n=t.val?.()||t.text?.();if(n&&n.trim())return n.trim()}}}catch(t){console.warn('[DICE]ACU getPersonaName error:',t)}return null},zt=()=>Mt()||Dt()||'主角',Tt=t=>{if(!t||'string'!=typeof t)return t;const n=zt();let e=t.replace(/<user>/gi,n);return e=e.replace(/\{\{user\}\}/gi,n),e},Nt=()=>{const t=SillyTavern;let n='unknown_chat',e='unknown_character';try{if('function'==typeof getCurrentChatId){const t=getCurrentChatId();if(null!=t){const e=String(t).trim();e&&(n=e)}}if('function'==typeof t?.getCurrentChatId){const e=t.getCurrentChatId();if(null!=e){const t=String(e).trim();t&&(n=t)}}}catch{}try{if('function'==typeof getCharData){const t=getCharData('current',!0),n=String(t?.avatar||'').trim();n&&(e=n)}if('unknown_character'===e){const n=t?.characterId,a=t?.characters,o=Number.parseInt(String(n??''),10);if(!Number.isNaN(o)&&o>=0&&Array.isArray(a)&&o<a.length){const t=String(a[o]?.avatar||'').trim();t&&(e=t)}}}catch{}return{chatId:n,characterId:e}},Ft={_cache:null,load(){if(!this._cache){const t=fe.get(nt,{});this._cache={};for(const n in t)'string'==typeof t[n]?this._cache[n]={url:t[n],offsetX:50,offsetY:50,scale:150,aliases:[],createdAt:0}:this._cache[n]={url:t[n].url||'',offsetX:t[n].offsetX??50,offsetY:t[n].offsetY??50,scale:t[n].scale??150,aliases:t[n].aliases||[],createdAt:t[n].createdAt??0}}return this._cache},save(){fe.set(nt,this._cache||{}),this._cache=null},get(t){const n=this.load()[t];if(n&&n.url)return n.url;for(const n in this._cache)if(this._cache[n].aliases&&this._cache[n].aliases.includes(t)&&this._cache[n].url)return this._cache[n].url;return null},async getAsync(t){if(!t)return null;const n=Dt(),e='<user>'===t||'主角'===t||n&&t===n,a=await Et.get(t);if(a)return a;if(e&&'<user>'!==t){const t=await Et.get('<user>');if(t)return t}const o=this.getPrimaryName(t);if(o!==t){const t=await Et.get(o);if(t)return t}return this.get(t)},async hasLocalAvatar(t){if(!t)return!1;if(await Et.has(t))return!0;const n=this.getPrimaryName(t);return n!==t&&await Et.has(n)},saveLocalAvatar:async(t,n)=>await Et.save(t,n),deleteLocalAvatar:async t=>await Et.delete(t),getOffsetX(t){const n=this._resolveByAlias(t);return n?n.offsetX??50:50},getOffsetY(t){const n=this._resolveByAlias(t);return n?n.offsetY??50:50},getScale(t){const n=this._resolveByAlias(t);return n?n.scale??150:150},_resolveByAlias(t){const n=this.load()[t];if(n)return n;for(const n in this._cache)if(this._cache[n].aliases&&this._cache[n].aliases.includes(t))return this._cache[n];return null},getPrimaryName(t){if(this.load()[t])return t;for(const n in this._cache)if(this._cache[n].aliases&&this._cache[n].aliases.includes(t))return n;return t},set(t,n,e=50,a=50,o=150,i=[]){const r=this.load()[t],c=r?r.createdAt??0:Date.now();this.load()[t]={url:n,offsetX:e,offsetY:a,scale:o,aliases:i,createdAt:c},this.save()},setPosition(t,n,e){const a=this.load()[t];a&&(a.offsetX=n,a.offsetY=e,this.save())},setScale(t,n){const e=this.load()[t];e&&(e.scale=n,this.save())},setAliases(t,n){const e=this.load()[t];e&&(e.aliases=n,this.save())},remove(t){delete this.load()[t],this.save()},getAll(){return this.load()},exportData(){return{version:1,exportTime:(new Date).toISOString(),avatars:this.load()}},importData(t,n=!0){if(!t||!t.avatars)throw new Error('无效的配置文件格式');const e=this.load(),a={added:0,updated:0,skipped:0};for(const o in t.avatars){const i=t.avatars[o];i.url&&(e[o]?n?(e[o]={url:i.url,offsetX:i.offsetX??50,offsetY:i.offsetY??50,scale:i.scale??150,aliases:i.aliases||[],createdAt:i.createdAt??0},a.updated++):a.skipped++:(e[o]={url:i.url,offsetX:i.offsetX??50,offsetY:i.offsetY??50,scale:i.scale??150,aliases:i.aliases||[],createdAt:i.createdAt??0},a.added++))}return this.save(),a},analyzeImport(t){if(!t||!t.avatars)return{valid:!1,error:'无效的配置文件格式'};const n=this.load(),e={valid:!0,total:0,newItems:[],conflicts:[]};for(const a in t.avatars)t.avatars[a].url&&(e.total++,n[a]?e.conflicts.push(a):e.newItems.push(a));return e}},Pt=t=>{if(!t)return{displayName:'',aliases:[]};const n=String(t).trim(),e=n.split(/[,，]/).map(t=>t.trim()).filter(Boolean);if(e.length<=1)return{displayName:n,aliases:[]};let a=0;for(let t=1;t<e.length;t++)e[t].length>e[a].length&&(a=t);return{displayName:e[a],aliases:e.filter((_,t)=>t!==a)}},jt=t=>Pt(t).displayName,Rt=t=>['主角','角色','人物','NPC','伙伴','队友','宠物','弟子','成员','player','character'].some(n=>t.toLowerCase().includes(n.toLowerCase())),Bt={_autoAliases:new Map,_conflicts:new Map,_displayNames:new Map,rebuild(t){this._autoAliases.clear(),this._conflicts.clear(),this._displayNames.clear();const n=new Map;for(const e in t){if(!Rt(e))continue;const a=t[e],o=a.headers||[],i=a.rows||[];let r=o.findIndex(t=>t&&(String(t).includes('姓名')||String(t).includes('名称')));r<0&&(r=1),i.forEach(t=>{const e=String(t[r]||'').trim();if(!e)return;const{displayName:a,aliases:o}=Pt(e);if(a&&(this._displayNames.set(a,e),0!==o.length))for(const t of o){n.has(t)||n.set(t,[]);const e=n.get(t);e.includes(a)||e.push(a)}})}for(const[t,e]of n)1===e.length?this._autoAliases.set(t,e[0]):this._conflicts.set(t,[...e]);this._autoAliases.size>0&&console.info(`[DICE]别名注册表: 自动注册 ${this._autoAliases.size} 个别名`+(this._conflicts.size>0?`, ${this._conflicts.size} 个冲突已跳过`:''))},resolve(t){if(!t)return t;if(t.includes(',')||t.includes('，'))return jt(t);const n=Ft.getPrimaryName(t);if(n!==t)return n;const e=this._autoAliases.get(t);return e||t},getAliases(t){const n=[];for(const[e,a]of this._autoAliases)a!==t||n.includes(e)||n.push(e);const e=Ft.load()[t]?.aliases||[];for(const t of e)n.includes(t)||n.push(t);return n},getConflicts(){return new Map(this._conflicts)},isDisplayName(t){return this._displayNames.has(t)}},Ot=t=>{if(!t)return[];const e=t.toLowerCase(),a=[];for(const[t,o]of n)t.test(e)&&a.push(o);return a},Vt=(t,n)=>{if(!t&&!n)return null;const a=t?.toLowerCase(),o=n?.toLowerCase();for(const[t,n]of e)if(a&&t.test(a))return n;for(const[t,n]of e)if(o&&t.test(o))return n;return null},Lt=function(){const t='__mvu__';let n=null,e=null;function a(){const t=window.SillyTavern||window.parent?.SillyTavern;try{return'function'==typeof t?.getCurrentChatId?t.getCurrentChatId():null}catch{return null}}function o(){const t=a();n&&t&&e&&e!==t&&(n=null,e=null)}function i(){const t=globalThis.LWB_Guard||window.LWB_Guard||window.parent?.LWB_Guard;if('object'!=typeof t||null===t)return!1;const n=window.SillyTavern||window.parent?.SillyTavern,e=n?.chatMetadata;if('object'!=typeof e||null===e)return!1;const a=window.eventEmit||window.parent?.eventEmit,o=window.eventOn||window.parent?.eventOn;if('function'==typeof a&&'function'==typeof o){const t=e.variables;if('object'==typeof t&&null!==t){const n=t;if(void 0!==n.ERAMetaData||void 0!==n.stat_data)return!1}}if(void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData)try{const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(null!=t)return!1}catch{}if(Object.keys(e).some(t=>t.startsWith('LWB_')||t.startsWith('lwb_')))return!0;const i=e.variables;if('object'!=typeof i||null===i)return!1;const r=i;return!!Object.keys(r).some(t=>t.startsWith('LWB_')||t.startsWith('lwb_'))}function r(){const t=window.SillyTavern||window.parent?.SillyTavern,n=t?.chatMetadata;if('object'!=typeof n||null===n)return!1;const e=n.variables;if('object'!=typeof e||null===e)return!1;const a=e;return void 0!==a.ERAMetaData||void 0!==a.stat_data}function c(){if(o(),n&&n._source)return n._source;if(i())return console.log('[DICE]MvuModule 智能检测到 LWB (小白X) 框架'),'lwb';const t=window.eventEmit||window.parent?.eventEmit,e=window.eventOn||window.parent?.eventOn,a='function'==typeof t&&'function'==typeof e;return a&&r()?(console.log('[DICE]MvuModule 智能检测到 ERA 框架（当前聊天有 ERA 数据）'),'era'):void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData?(console.log('[DICE]MvuModule 智能检测到 MVU 框架'),'mvu'):a?(console.log('[DICE]MvuModule 智能检测到 ERA 框架（新聊天，无数据）'),'era'):(console.log('[DICE]MvuModule 未检测到框架，默认使用 MVU 模式'),'mvu')}function s(t){if('string'!=typeof t)return t;const n=t.trim();if(!n.startsWith('{')&&!n.startsWith('['))return t;try{return JSON.parse(n)}catch{return t}}function l(){try{const t=window.SillyTavern||window.parent?.SillyTavern,n=t?.chatMetadata?.variables||{},e={};for(const[t,a]of Object.entries(n)){if(t.startsWith('LWB_')||t.startsWith('lwb_'))continue;const n=s(a);'object'==typeof n&&null!==n&&(e[t]=n)}return{stat_data:e,display_data:{},delta_data:{},_source:'lwb'}}catch(t){return console.warn('[DICE]获取LWB变量失败:',t),{stat_data:{},display_data:{},delta_data:{},_source:'lwb'}}}async function d(){return new Promise(t=>{const o=setTimeout(()=>{console.warn('[DICE]MvuModule ERA查询超时'),t(null)},5e3),i=window.eventEmit||window.parent?.eventEmit,r=window.eventOn||window.parent?.eventOn,c=window.eventOff||window.parent?.eventOff,s=i=>{if(clearTimeout(o),'function'==typeof c)try{c('era:queryResult',s)}catch(t){console.warn('[DICE]MvuModule 移除事件监听失败:',t)}if(i.result&&i.result.error)return console.error('[DICE]MvuModule ERA查询失败:',i.result.error),void t(null);const r={stat_data:i.result?.statWithoutMeta||null,delta_data:{},schema:null,_source:'era'};n=r,e=a(),t(r)};try{if(console.log('[DICE]MvuModule 开始获取ERA数据...'),console.log('[DICE]MvuModule ERA API 检查:',{eventEmit:'function'==typeof i,eventOn:'function'==typeof r,eventOff:'function'==typeof c}),'function'!=typeof r)return console.error('[DICE]MvuModule eventOn 不可用'),clearTimeout(o),void t(null);if('function'!=typeof i)return console.error('[DICE]MvuModule eventEmit 不可用'),clearTimeout(o),void t(null);r('era:queryResult',s),i('era:getCurrentVars')}catch(n){clearTimeout(o),console.error('[DICE]MvuModule ERA API调用失败:',n),t(null)}})}function u(t){return String(t??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}function p(){const t=c();if('era'===t){const t=window.eventEmit||window.parent?.eventEmit,n=window.eventOn||window.parent?.eventOn;return'function'==typeof t&&'function'==typeof n}if('lwb'===t){const t=window.SillyTavern||window.parent?.SillyTavern;return void 0!==t?.chatMetadata}return void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData}function f(){if(console.warn('[DICE]警告: getData() 是同步函数，可能无法正确获取 MVU 数据。建议使用 getDataWithRetry()'),o(),n)return n;if(i()){const t=l();return n=t,e=a(),console.log('[DICE]LWB 数据同步获取成功'),t}try{if(void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData){const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(t&&t.stat_data){const o={stat_data:t.stat_data||null,display_data:t.display_data||{},delta_data:t.delta_data||{},schema:t.schema||null,_source:'mvu'};return n=o,e=a(),o}}}catch(t){console.warn('[DICE]同步获取 MVU 数据失败:',t)}return null}async function g(t=3,o=500){try{if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)try{await Promise.race([waitGlobalInitialized('Mvu'),new Promise((_,t)=>setTimeout(()=>t(new Error('等待 MVU 初始化超时')),3e3))])}catch(t){console.warn('[DICE]等待 MVU 初始化失败，尝试直接获取:',t.message)}for(let i=1;i<=t;i++){try{if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)throw new Error('MVU API 不可用');const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(t&&t.stat_data){const o={stat_data:t.stat_data||null,display_data:t.display_data||{},delta_data:t.delta_data||{},schema:t.schema||null,_source:'mvu'};return n=o,e=a(),console.log('[DICE]MVU 数据获取成功'),o}}catch(n){console.warn(`[DICE]MVU 数据获取失败 (尝试 ${i}/${t}):`,n)}i<t&&await new Promise(t=>setTimeout(t,o))}return null}catch(t){return console.error('[DICE]MVU 初始化失败:',t),null}}function m(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]&&('number'==typeof t[0]||'string'==typeof t[0]||'boolean'==typeof t[0])}function b(t){return!!Array.isArray(t)&&t.every(t=>'string'==typeof t||'number'==typeof t||'boolean'==typeof t||null===t)}function h(t){return Array.isArray(t)?m(t)?0:t.length:t&&'object'==typeof t?Object.keys(t).filter(t=>!t.startsWith('$')).length:0}function v(t,n=!1){if(null==t)return'';if(n||Array.isArray(t))return m(t)?String(t[0]):b(t)?t.map(t=>String(t??'')).join(', '):String(t);const e=String(t).trim();if(/^-?\d+(\.\d+)?%?$/.test(e))return e;const a=e.match(/^(-?\d+(?:\.\d+)?%?)(,\s*\[[^\]]+\])?\s+/);if(a)return a[2]?a[1]+a[2].trim():a[1];const o=e.match(/^(-?\d+(?:\.\d+)?%?\/-?\d+(?:\.\d+)?%?),/);if(o)return o[1];const i=e.match(/^(-?\d+(?:\.\d+)?%?),/);if(i)return i[1];const r=e.match(/^(-?\d+(?:\.\d+)?%?)\s+[^\d]/);return r?r[1]:e}function x(t){if(!t)return 0;const n=String(t).trim().match(/^(-?\d+(?:\.\d+)?)/);if(n){const t=parseFloat(n[1]);return isNaN(t)?0:t}return 0}function w(t,n,e,a){const o=function(t,n){if(!n||!t)return'';const e=t.split('.');let a=n;for(const t of e){if(null==a)return'';a=a[t]}if(!a)return'';if('string'==typeof a&&a.includes('->')){const t=a.match(/^(-?[\d.]+)->(-?[\d.]+)/);if(t){const n=parseFloat(t[1]),e=parseFloat(t[2]);if(!isNaN(n)&&!isNaN(e))return e>n?'↑':e<n?'↓':''}return'•'}return''}(e,a),i=o?'mvu-changed':'';let r,c='mvu-value';m(n)?r=String(n[0]):b(n)?(r=n.map(t=>String(t??'')).join(', '),c+=' mvu-array-value'):r=v(n??'',!1);let s='';try{if('function'==typeof An&&An(r)){const n=x(r);if(n>0){let a=t;if(t.includes('.')){const n=t.split('.');a=n[n.length-1]}if(e&&e.includes('.')){const n=e.split('.'),o=n[n.length-1];o&&!/^\d+$/.test(o)&&o!==t&&(a=o)}s=`<i class="fa-solid fa-dice-d20 mvu-dice-icon acu-mvu-dice-icon" data-path="${u(e)}" data-attr-name="${u(a)}" data-attr-value="${n}" title="快捷投骰"></i>`}}}catch(t){console.warn('[DICE]MvuModule renderRow: 判断数字时出错',t)}return`\n                <div class="mvu-row ${i}">\n                    <div class="mvu-key">${u(t)}</div>\n                    <div class="mvu-value-wrap">\n                        <span class="${c}" data-path="${u(e)}">${u(r)}</span>\n                        ${s}\n                        ${o?`<span class="mvu-change-indicator">${o}</span>`:''}\n                    </div>\n                </div>\n            `}function k(t,n,e,a,o,i,r){const c=h(n),s=i?'':'collapsed';let l='',d=!1,p=0,f=0;if(!Array.isArray(n)||m(n)||b(n)){if(n&&'object'==typeof n&&!m(n)){const t=Object.entries(n).filter(([t])=>!t.startsWith('$'));for(const[n,i]of t){const t=e?`${e}.${n}`:n;!i||'object'!=typeof i||m(i)||b(i)?(f++,l+=w(n,i,t,a)):(d=!0,p++,l+=k(n,i,t,a,o+1,!1,r))}}}else n.forEach((t,n)=>{const i=`${e}[${n}]`;!t||'object'!=typeof t||m(t)||b(t)?(f++,l+=w(`[${n}]`,t,i,a)):(d=!0,p++,l+=k(`[${n}]`,t,i,a,o+1,!1,r))});const g=Array.isArray(n)?`[${c}]`:`(${c})`,v=r&&d?'mvu-card-body horizontal-nested':'mvu-card-body';let x=!1;if(r&&d&&0===o)if(!Array.isArray(n)||m(n)||b(n)){if(n&&'object'==typeof n&&!m(n)){const t=Object.entries(n).filter(([t])=>!t.startsWith('$'));for(const[n,e]of t)if(e&&'object'==typeof e&&!m(e)&&!b(e)){h(e)>=2&&(x=!0)}}}else n.forEach(t=>{if(t&&'object'==typeof t&&!m(t)&&!b(t)){h(t)>=2&&(x=!0)}});return`\n                <div class="mvu-card${r&&d&&(0===o&&(p>=2&&f<=1||x)||o>0&&0===f&&p>=2)?' has-nested-cards':''} ${s}" data-path="${u(e)}" data-depth="${o}">\n                    <div class="mvu-card-header">\n                        <div class="mvu-card-title">\n                            <span>${u(t)}</span>\n                            <span class="mvu-card-count">${g}</span>\n                        </div>\n                        <span class="mvu-card-toggle">▼</span>\n                    </div>\n                    <div class="${v}">\n                        ${l}\n                    </div>\n                </div>\n            `}return{MODULE_ID:t,isAvailable:p,getData:f,getDataWithRetry:async function(t=3,o=500){try{const c=await async function(){if(i()){const t=l();return console.log('[DICE]检测到 LWB 框架，数据条目数:',Object.keys(t.stat_data).length),{mode:'lwb',data:t}}const t=window.eventEmit||window.parent?.eventEmit,n=window.eventOn||window.parent?.eventOn;if('function'==typeof t&&'function'==typeof n&&r())try{const t=await Promise.race([d(),new Promise((_,t)=>setTimeout(()=>t(new Error('ERA timeout')),2e3))]);if(t&&t.stat_data)return console.log('[DICE]检测到 ERA 框架且数据可用'),{mode:'era',data:t}}catch(t){console.warn('[DICE]ERA 框架存在但数据不可用:',t.message)}try{if(await waitGlobalInitialized('Mvu'),void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData){const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(t&&t.stat_data)return console.log('[DICE]检测到 MVU 框架且数据可用'),{mode:'mvu',data:{stat_data:t.stat_data||null,display_data:t.display_data||{},delta_data:t.delta_data||{},schema:t.schema||null,_source:'mvu'}}}}catch(t){console.warn('[DICE]MVU 框架检测失败:',t)}return console.warn('[DICE]未检测到可用的变量框架，默认使用 MVU 模式'),{mode:'mvu',data:null}}();if(c.data)return n=c.data,e=a(),c.data;const s=c.mode;if('era'===s){for(let i=1;i<=t;i++){try{const t=await d();if(t&&t.stat_data)return n=t,e=a(),t}catch(n){console.warn(`[DICE]ERA 数据获取失败 (尝试 ${i}/${t}):`,n)}i<t&&await new Promise(t=>setTimeout(t,o))}return console.warn('[DICE]ERA 数据获取失败，尝试降级到 MVU'),await g(t,o)}if('lwb'===s){const t=l();return n=t,e=a(),t}return await g(t,o)}catch(t){return console.error('[DICE]数据获取失败:',t),null}},diagnoseVariableFramework:async function(){const t={timestamp:(new Date).toISOString(),era:{available:!1,eventEmit:'function'==typeof(window.eventEmit||window.parent?.eventEmit),eventOn:'function'==typeof(window.eventOn||window.parent?.eventOn),dataAvailable:!1,error:null},mvu:{available:!1,apiExists:void 0!==window.Mvu,getDataExists:'function'==typeof window.Mvu?.getMvuData,dataAvailable:!1,error:null},cache:{hasCache:!!n,cacheKeys:n?Object.keys(n):[]},recommendation:''};if(t.era.eventEmit&&t.era.eventOn)try{const n=await Promise.race([d(),new Promise((_,t)=>setTimeout(()=>t(new Error('Timeout')),2e3))]);t.era.available=!0,t.era.dataAvailable=!(!n||!n.stat_data)}catch(n){t.era.error=n.message}if(t.mvu.apiExists&&t.mvu.getDataExists)try{await Promise.race([waitGlobalInitialized('Mvu'),new Promise((_,t)=>setTimeout(()=>t(new Error('等待超时')),2e3))]);const n=window.Mvu.getMvuData({type:'message',message_id:'latest'});t.mvu.available=!0,t.mvu.dataAvailable=!(!n||!n.stat_data)}catch(n){t.mvu.error=n.message}return t.era.dataAvailable?t.recommendation='ERA 框架可用且数据正常':t.mvu.dataAvailable?t.recommendation='MVU 框架可用且数据正常':t.era.available||t.mvu.available?t.recommendation='框架已安装但数据不可用，请检查角色卡是否正确初始化变量':t.recommendation='未检测到任何变量框架，请确认已安装 MVU 或 ERA 插件',t},injectStyles:function(){const t=window.parent?.document||document;if(t.getElementById('mvu-module-styles'))return;const n=t.createElement('style');n.id='mvu-module-styles',n.textContent='\n            /* MVU 面板容器 */\n            .acu-mvu-panel {\n                height: 100%;\n                display: flex;\n                flex-direction: column;\n                min-height: 300px; /* 确保面板有足够的最小高度，避免显示为白条 */\n                overflow: hidden; /* 不在这里滚动，让父容器处理 */\n            }\n            .acu-mvu-panel .acu-panel-header {\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                padding: 10px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                flex-shrink: 0;\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title i {\n                color: var(--acu-accent);\n            }\n            .acu-mvu-panel .acu-header-actions {\n                display: flex;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn {\n                background: transparent;\n                border: none;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                padding: 4px;\n                font-size: 14px;\n                border-radius: 4px;\n                transition: all 0.2s;\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn:hover {\n                background: transparent;\n                color: var(--acu-accent);\n            }\n            .acu-mvu-panel .mvu-header-btn.active {\n                background: transparent;\n                color: var(--acu-accent);\n                font-weight: bold;\n            }\n            /* [新增] 数值模式样式 */\n            .mvu-numeric-mode {\n                padding: 0;\n            }\n            .mvu-numeric-level-controls {\n                position: sticky;\n                top: 0;\n                z-index: 10;\n            }\n            /* [新增] 可折叠层级控制样式 */\n            .mvu-level-controls-collapsible {\n                margin-bottom: 8px;\n            }\n            .mvu-level-controls-header {\n                transition: background 0.2s;\n            }\n            .mvu-level-controls-header:hover {\n                background: var(--acu-table-hover) !important;\n            }\n            .mvu-level-controls-body {\n                overflow-y: auto;\n                overflow-x: hidden;\n                transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, border-bottom 0.3s ease-out;\n                max-height: 300px; /* 限制最大高度，超出时可滚动 */\n                scrollbar-width: thin;\n            }\n            /* 移动端使用更小的最大高度 */\n            @media (max-width: 768px) {\n                .mvu-level-controls-body {\n                    max-height: 200px;\n                }\n            }\n            .mvu-level-controls-body::-webkit-scrollbar {\n                width: 6px;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-track {\n                background: transparent;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-thumb {\n                background: var(--acu-border);\n                border-radius: 3px;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-thumb:hover {\n                background: var(--acu-text-sub);\n            }\n            .mvu-level-controls-collapsible.collapsed .mvu-level-controls-body {\n                max-height: 0 !important;\n                padding-top: 0 !important;\n                padding-bottom: 0 !important;\n                border-bottom: none !important;\n                margin: 0 !important;\n            }\n            .mvu-level-controls-toggle-icon {\n                transition: transform 0.3s ease-out;\n            }\n            .mvu-level-controls-collapsible.collapsed .mvu-level-controls-toggle-icon {\n                transform: rotate(-90deg);\n            }\n            .mvu-numeric-items {\n                max-height: calc(100vh - 200px);\n                overflow-y: auto;\n            }\n            .mvu-numeric-item {\n                transition: background 0.2s;\n            }\n            .mvu-numeric-item:hover {\n                background: var(--acu-table-hover) !important;\n            }\n            .mvu-dice-icon {\n                transition: opacity 0.2s, transform 0.2s;\n            }\n            .mvu-dice-icon:hover {\n                opacity: 1 !important;\n                transform: scale(1.1);\n            }\n            .mvu-level-toggle:hover {\n                opacity: 1 !important;\n            }\n            .mvu-level-toggle[data-visible="true"]:hover {\n                background: var(--acu-accent) !important;\n                color: var(--acu-btn-active-text) !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .mvu-level-toggle[data-visible="false"]:hover,\n            .mvu-level-toggle[data-visible=""]:hover {\n                background: var(--acu-table-hover) !important;\n                color: var(--acu-text-sub) !important;\n                border-color: var(--acu-border) !important;\n            }\n\n            /* MVU 内容区 - 始终使用竖向滚动模式 */\n            .mvu-content {\n                display: flex;\n                flex-direction: column;\n                overflow-x: hidden;\n                overflow-y: auto; /* 直接在内容区启用滚动 */\n                flex: 1 1 auto;\n                min-height: 0; /* 关键：允许 flex 子项缩小以启用滚动 */\n                max-height: 100%; /* 限制最大高度为父容器 */\n                padding: 12px;\n                scrollbar-width: thin;\n            }\n            .mvu-content::-webkit-scrollbar {\n                display: none;\n            }\n            .mvu-content .mvu-card {\n                flex: 0 0 auto; /* 不拉伸，保持自然高度 */\n                min-width: 100%;\n                max-width: 100%;\n                width: 100%;\n            }\n            /* MVU面板始终支持滚动 */\n            .acu-mvu-panel {\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                flex: 1 1 0; /* 关键：使用 flex-basis: 0 让容器可以正确计算滚动 */\n                min-height: 300px; /* 确保面板有足够的最小高度，避免显示为白条 */\n            }\n\n            /* MVU 卡片 */\n            .mvu-card {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 10px;\n                overflow: hidden;\n            }\n            .mvu-card:last-child {\n                margin-bottom: 0;\n            }\n            .mvu-card-header {\n                background: var(--acu-table-head);\n                padding: 8px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.2s;\n            }\n            .mvu-card-header:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-card-title {\n                font-weight: 600;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .mvu-card-count {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: normal;\n            }\n            .mvu-card-toggle {\n                color: var(--acu-text-sub);\n                font-size: 10px;\n                transition: transform 0.2s;\n            }\n            .mvu-card.collapsed .mvu-card-toggle {\n                transform: rotate(-90deg);\n            }\n            .mvu-card-body {\n                padding: 8px 12px;\n                display: block;\n                overflow: hidden; /* 为 slideUp/slideDown 动画提供支持 */\n            }\n            .mvu-card.collapsed .mvu-card-body {\n                display: none;\n            }\n\n            /* 嵌套卡片 */\n            .mvu-card .mvu-card {\n                background: var(--acu-table-head);\n                margin: 6px 0;\n            }\n            .mvu-card .mvu-card .mvu-card-header {\n                background: rgba(128,128,128,0.1);\n                padding: 6px 10px;\n            }\n            .mvu-card .mvu-card .mvu-card-body {\n                padding: 6px 10px;\n            }\n\n            /* 嵌套卡片横向布局 - 只对嵌套卡片生效，键值对保持正常块级显示 */\n            .mvu-card-body.horizontal-nested {\n                display: flex;\n                flex-direction: row;\n                flex-wrap: nowrap;\n                gap: 12px;\n                overflow-x: auto;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: touch;\n                padding-bottom: 8px;\n                align-items: flex-start;\n            }\n            /* 如果父卡片有 has-nested-cards 类，使用 wrap 布局，让键值对和嵌套卡片可以换行 */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested {\n                flex-wrap: wrap;\n            }\n            /* 键值对行保持正常块级显示，占满一行 */\n            .mvu-card-body.horizontal-nested > .mvu-row {\n                display: flex;\n                flex: 0 0 100%;\n                width: 100%;\n                max-width: 100%; /* 确保不超过容器宽度 */\n                box-sizing: border-box;\n            }\n            /* 如果父卡片有 has-nested-cards 类，键值对应该根据内容自适应宽度，但仍然占满一行 */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                flex: 0 0 auto; /* 根据内容自适应宽度 */\n                min-width: 100%; /* 确保占满一行 */\n                width: auto; /* 根据内容自适应宽度 */\n                max-width: 450px; /* 限制键值对的最大宽度，避免占用过多横向空间 */\n                box-sizing: border-box;\n            }\n            @media (min-width: 769px) {\n                .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                    max-width: 550px; /* 大屏幕下也限制键值对的最大宽度 */\n                }\n            }\n            /* 只有嵌套卡片才横向排列 - 智能宽度 */\n            .mvu-card-body.horizontal-nested > .mvu-card {\n                flex: 0 0 auto; /* 根据内容自动调整宽度 */\n                min-width: 200px;\n                max-width: 350px;\n                width: auto;\n            }\n            /* 如果嵌套卡片内部也有横向排列的子卡片，移除最大宽度限制，允许根据内容自适应 */\n            .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                min-width: 400px; /* 为包含嵌套卡片的嵌套卡片设置更大的最小宽度 */\n                max-width: none; /* 移除最大宽度限制，允许根据内容自适应 */\n            }\n            @media (min-width: 769px) {\n                .mvu-card-body.horizontal-nested > .mvu-card {\n                    min-width: 240px;\n                    max-width: 400px;\n                }\n                .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                    min-width: 500px; /* 为包含嵌套卡片的嵌套卡片设置更大的最小宽度 */\n                    max-width: none; /* 移除最大宽度限制，允许根据内容自适应 */\n                }\n            }\n\n            /* 键值对行 */\n            .mvu-row {\n                display: flex;\n                align-items: flex-start;\n                padding: 5px 0;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .mvu-row:last-child {\n                border-bottom: none;\n            }\n            .mvu-key {\n                color: var(--acu-text-sub);\n                min-width: 80px;\n                max-width: 120px;\n                flex-shrink: 0;\n                font-size: 12px;\n                padding-right: 8px;\n                word-break: break-all;\n            }\n            .mvu-value-wrap {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                min-width: 0;\n            }\n            .mvu-value {\n                color: var(--acu-text-main);\n                font-size: var(--acu-font-size, 13px);\n                cursor: pointer;\n                padding: 1px 6px;\n                border-radius: 4px;\n                transition: background 0.2s;\n                word-break: break-word;\n                flex: 0 1 auto;\n            }\n            .mvu-value:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-value.mvu-array-value {\n                font-size: calc(var(--acu-font-size, 13px) * 0.92);\n                color: var(--acu-text-sub);\n            }\n            .mvu-change-indicator {\n                color: var(--acu-success-text);\n                font-weight: bold;\n                font-size: 12px;\n                flex-shrink: 0;\n            }\n            .mvu-row.mvu-changed {\n                background: var(--acu-success-bg);\n                margin: 0 -12px;\n                padding: 5px 12px;\n                border-radius: 4px;\n            }\n            .mvu-card .mvu-card .mvu-row.mvu-changed {\n                margin: 0 -10px;\n                padding: 5px 10px;\n            }\n\n            /* 空状态 */\n            .mvu-empty {\n                text-align: center;\n                padding: 40px 20px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 100%;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n            }\n            .mvu-empty i {\n                font-size: 32px;\n                margin-bottom: 12px;\n                display: block;\n                opacity: 0.5;\n            }\n            .mvu-empty p {\n                margin: 0 0 6px 0;\n            }\n            .mvu-empty .mvu-empty-hint {\n                font-size: 12px;\n                opacity: 0.7;\n            }\n\n            /* 编辑弹窗 */\n            .mvu-edit-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0,0,0,0.6);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 99999;\n                animation: mvuFadeIn 0.15s ease-out;\n            }\n            .mvu-edit-dialog {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                padding: 16px;\n                width: 90%;\n                max-width: 400px;\n                animation: mvuSlideIn 0.2s ease-out;\n            }\n            .mvu-edit-title {\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 12px;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .mvu-edit-path {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                padding: 6px 10px;\n                border-radius: 4px;\n                margin-bottom: 12px;\n                word-break: break-all;\n                font-family: monospace;\n            }\n            .mvu-edit-textarea {\n                width: 100%;\n                min-height: 80px;\n                padding: 10px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-input-bg, var(--acu-bg-panel));\n                color: var(--acu-text-main);\n                font-size: 13px;\n                resize: vertical;\n                box-sizing: border-box;\n            }\n            .mvu-edit-textarea:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .mvu-edit-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-top: 8px;\n                opacity: 0.7;\n            }\n            .mvu-edit-btns {\n                display: flex;\n                justify-content: flex-end;\n                gap: 8px;\n                margin-top: 16px;\n            }\n            .mvu-edit-btn {\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 13px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                transition: all 0.2s;\n            }\n            .mvu-edit-btn.mvu-btn-cancel {\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-sub);\n            }\n            .mvu-edit-btn.mvu-btn-cancel:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-edit-btn.mvu-btn-save {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .mvu-edit-btn.mvu-btn-save:hover {\n                opacity: 0.9;\n            }\n\n            @keyframes mvuFadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n            @keyframes mvuSlideIn {\n                from { transform: translateY(-20px); opacity: 0; }\n                to { transform: translateY(0); opacity: 1; }\n            }\n\n            /* 导航按钮 */\n            .acu-nav-btn.acu-mvu-btn.active {\n                background: var(--acu-btn-active-bg);\n                color: var(--acu-btn-active-text);\n            }\n        ',t.head.appendChild(n)},renderNavButton:function(n){return`<button class="acu-nav-btn acu-mvu-btn $${n?'active':''}" id="acu-btn-mvu" data-table="$${t}" style="order:-1;">\n                    <i class="fa-solid fa-code-branch"></i><span>变量</span>\n                </button>`},renderPanel:function(){const t=f(),n=t&&t._source||c(),e='era'===n;let a=!1;try{a='true'===localStorage.getItem('acu_mvu_numeric_mode')}catch(t){console.warn('[DICE]MvuModule 读取数值模式状态失败',t)}const o='vertical-layout',i='lwb'===n?'LWB 变量':'era'===n?'ERA 变量':'MVU 变量';if(!t)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${i}</span></div>\n                                <div class="acu-title-sub">(0项)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${Lt.MODULE_ID}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="刷新（自动重试获取变量）">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="关闭">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${o}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-exclamation-circle"></i>\n                                <p>无法获取 ${e?'ERA':'MVU'} 数据</p>\n                                <p class="mvu-empty-hint">请确保角色卡已配置 ${e?'ERA 框架':'MVU 框架'}，或点击刷新按钮自动重试获取变量</p>\n                            </div>\n                        </div>\n                    `;if(!t.stat_data||'object'==typeof t.stat_data&&0===Object.keys(t.stat_data).length)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${i}</span></div>\n                                <div class="acu-title-sub">(0项)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${Lt.MODULE_ID}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="刷新（自动重试获取变量）">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="关闭">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${o}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-inbox"></i>\n                                <p>当前没有变量数据</p>\n                                <p class="mvu-empty-hint">${'lwb'===n?'当前没有变量数据，变量将在 AI 通过 plot-log 输出后显示':'变量数据将在 AI 回复后自动初始化，或点击刷新按钮自动重试获取变量'}</p>\n                            </div>\n                        </div>\n                    `;if(a){const n=function(t){if(!t||!t.stat_data)return'<div class="mvu-empty"><i class="fa-solid fa-inbox"></i><p>当前没有变量数据</p></div>';let n={};try{const t=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');t&&(n=JSON.parse(t))}catch(t){console.warn('[DICE]MvuModule 读取层级显示偏好失败',t)}const e=[];function a(t,n,o){if(t&&'object'==typeof t)if(Array.isArray(t))m(t)||b(t)?t.forEach((t,a)=>{const i=n?`${n}[${a}]`:`[${a}]`,r=String(t??'').trim();if('function'==typeof An&&An(r)){const t=x(v(r,!1));t>0&&e.push({path:i,key:`[${a}]`,value:r,numericValue:t,levelNames:[...o]})}}):t.forEach((t,e)=>{a(t,n?`${n}[${e}]`:`[${e}]`,[...o,`[${e}]`])});else{const i=Object.entries(t).filter(([t])=>!t.startsWith('$'));for(const[t,r]of i){const i=n?`${n}.${t}`:t,c=[...o,t];if(!r||'object'!=typeof r||m(r)||b(r)){const n=String(r??'').trim();if('function'==typeof An&&An(n)){const a=x(v(n,!1));a>0&&e.push({path:i,key:t,value:n,numericValue:a,levelNames:c})}}else a(r,i,c)}}}const o=Object.keys(t.stat_data).filter(t=>!t.startsWith('$'));for(const n of o)a(t.stat_data[n],n,[n]);const i=e.filter(t=>{const n=t.levelNames.filter(t=>t&&!t.startsWith('['));for(const t of n)if(ht.isBlacklisted(t))return!1;return!0});if(0===i.length)return'<div class="mvu-empty"><i class="fa-solid fa-filter"></i><p>当前没有数值项</p></div>';const r=new Set;i.forEach(t=>{(t.levelNames.length>1?t.levelNames.slice(0,-1):[]).forEach(t=>{t&&!t.startsWith('[')&&r.add(t)})});const c=Array.from(r).sort();let s='';if(c.length>0){let t='';c.forEach(e=>{const a=!1!==n[e];t+=`<button class="mvu-level-toggle acu-mvu-level-toggle ${a?'active':''}" data-level="${u(e)}" data-visible="${a}" title="${a?'隐藏':'显示'}层级: ${u(e)}"><span>${u(e)}</span></button>`}),s=`\n          <div class="mvu-level-controls-collapsible collapsed">\n            <div class="mvu-level-controls-header acu-mvu-header">\n              <span class="acu-mvu-header-text">显示层级</span>\n              <i class="fa-solid fa-chevron-down mvu-level-controls-toggle-icon acu-mvu-toggle-icon"></i>\n            </div>\n            <div class="mvu-level-controls-body acu-mvu-body">\n              ${t}\n            </div>\n          </div>\n        `}let l='';return i.forEach(t=>{const n=t.levelNames.filter(t=>!t.startsWith('[')),e=t.levelNames.filter(t=>{if(t.startsWith('['))return!1;try{const n=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');if(n)return!1!==JSON.parse(n)[t]}catch(t){}return!0}),a=e.length>1?e.slice(0,-1):[],o=n.length>1?n.slice(0,-1):[],i=o.every(t=>{try{const n=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');if(n)return!1!==JSON.parse(n)[t]}catch(t){}return!0}),r=a.length>0?a.join(' > '):'';let c=t.key;if(t.path&&t.path.includes('.')){const n=t.path.split('.');c=n[n.length-1]}const s=`<i class="fa-solid fa-dice-d20 mvu-dice-icon acu-mvu-dice-icon" data-path="${u(t.path)}" data-attr-name="${u(c)}" data-attr-value="${t.numericValue}" title="快捷投骰"></i>`;let d=v(t.value,!1);d=d.replace(/,\s*\[[^\]]+\]/g,'');const p=i?'':'display:none;',f=JSON.stringify(o);l+=`\n          <div class="mvu-numeric-item acu-mvu-item" data-levels='${u(f)}' style="${p}">\n            <div class="acu-mvu-item-content">\n              <div class="mvu-path-display acu-mvu-path">${u(r)}</div>\n              <div class="acu-mvu-item-row">\n                <span class="acu-mvu-attr-name">${u(c)}</span>\n                <span class="mvu-value acu-mvu-val" data-path="${u(t.path)}" title="点击编辑">${u(d)}</span>\n                ${s}\n              </div>\n            </div>\n          </div>\n        `}),s+'<div class="mvu-numeric-items acu-mvu-list">'+l+'</div>'}(t);return`\n                    <div class="acu-panel-header">\n                        <div class="acu-panel-title">\n                            <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${i}</span> <span style="font-size:calc(var(--acu-font-size,13px) * 0.85);color:var(--acu-text-sub);margin-left:6px;">(数值模式)</span></div>\n                            <div class="acu-title-sub">(数值过滤)</div>\n                        </div>\n                        <div class="acu-header-actions">\n                            <div class="acu-height-control">\n                                <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${Lt.MODULE_ID}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                            </div>\n                            <button class="mvu-header-btn mvu-btn-numeric-mode active" title="切换到普通模式">\n                                <i class="fa-solid fa-list"></i>\n                            </button>\n                            <button class="mvu-header-btn mvu-btn-refresh" title="刷新（自动重试获取变量）">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                            <button class="acu-close-btn" title="关闭">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="mvu-content ${o} mvu-numeric-mode">\n                        ${n}\n                    </div>\n                `}const r=Object.keys(t.stat_data).filter(t=>!t.startsWith('$'));let s='';for(const n of r){const e=t.stat_data[n];h(e);!e||'object'!=typeof e||m(e)||b(e)?s+=`\n                            <div class="mvu-card" data-path="${u(n)}" data-depth="0">\n                                <div class="mvu-card-body">\n                                    ${w(n,e,n,t.delta_data)}\n                                </div>\n                            </div>\n                        `:s+=k(n,e,n,t.delta_data,0,!0,!1)}return`\n                    <div class="acu-panel-header">\n                        <div class="acu-panel-title">\n                            <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${i}</span></div>\n                            <div class="acu-title-sub">(${r.length}项)</div>\n                        </div>\n                        <div class="acu-header-actions">\n                            <div class="acu-height-control">\n                                <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${Lt.MODULE_ID}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                            </div>\n                            <button class="mvu-header-btn mvu-btn-numeric-mode" title="切换到数值模式（仅显示数值项）">\n                                <i class="fa-solid fa-filter"></i>\n                            </button>\n                            <button class="mvu-header-btn mvu-btn-refresh" title="刷新（自动重试获取变量）">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                            <button class="acu-close-btn" title="关闭">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="mvu-content ${o}">\n                        ${s}\n                    </div>\n                `},bindEvents:function(t){const $=window.parent?.jQuery||window.jQuery;if(!$||!t||!t.length)return void console.warn('[DICE]MvuModule bindEvents: jQuery or container not available');const n=$('#acu-data-area');n.length?(n.off('.mvu'),n.on('click.mvu','.mvu-card-header',function(t){t.stopPropagation();const n=$(this).closest('.mvu-card'),e=n.find('> .mvu-card-body').first();e.is(':animated')||e.hasClass('animating')||(n.hasClass('collapsed')?(e.hide(),n.removeClass('collapsed'),e.addClass('animating').slideDown(180,function(){$(this).removeClass('animating')})):e.addClass('animating').slideUp(180,function(){n.addClass('collapsed'),$(this).removeClass('animating')}))}),n.on('click.mvu','.mvu-btn-refresh',function(t){t.stopPropagation(),Lt.refresh(n)}),n.on('click.mvu','.mvu-btn-numeric-mode',function(t){t.stopPropagation();try{const t=!$(this).hasClass('active');if(localStorage.setItem('acu_mvu_numeric_mode',String(t)),'function'==typeof me){const t=ge();me(t)}'function'==typeof mo&&mo()}catch(t){console.warn('[DICE]MvuModule 切换数值模式失败',t),window.toastr&&window.toastr.error('切换模式失败')}}),n.on('click.mvu','.mvu-level-controls-header',function(t){t.stopPropagation();$(this).closest('.mvu-level-controls-collapsible').toggleClass('collapsed')}),n.on('click.mvu','.mvu-level-toggle',function(t){t.stopPropagation();const n=$(this),e=n.data('level'),a=!('true'===n.data('visible')||!0===n.data('visible'));try{const t=localStorage.getItem('acu_mvu_numeric_mode_visible_levels'),o=t?JSON.parse(t):{};o[e]=a,localStorage.setItem('acu_mvu_numeric_mode_visible_levels',JSON.stringify(o)),n.data('visible',a),a?(n.css({background:'var(--acu-accent)',color:'var(--acu-btn-active-text)',borderColor:'var(--acu-accent)',opacity:'1'}),n.attr('title',`隐藏层级: ${e}`)):(n.css({background:'transparent',color:'var(--acu-text-sub)',borderColor:'var(--acu-border)',opacity:'0.5'}),n.attr('title',`显示层级: ${e}`)),$('.mvu-numeric-item').each(function(){const t=$(this);try{const n=JSON.parse(t.attr('data-levels')||'[]');if(n.includes(e)){const e=n.filter(t=>{const n=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');return!1!==(n?JSON.parse(n):{})[t]}),a=e,o=a.length>0?a.join(' > '):'';t.find('.mvu-path-display').text(o)}}catch(t){console.warn('[DICE]MvuModule 更新路径显示失败',t)}})}catch(t){console.warn('[DICE]MvuModule 更新层级显示偏好失败',t)}}),n.on('click.mvu','.mvu-value',function(t){t.stopPropagation();const n=$(this),e=n.data('path');if(!e)return void console.warn('[DICE]MvuModule No path on value element');const a=n.text().replace(/\s*\$\s*$/,'').trim();Lt.showEditDialog(e,a,async function(t){if(null!==t&&t!==a){const a=await Lt.setValue(e,t),toastr=window.parent?.toastr||window.toastr;a?(n.text(t),n.css('background','var(--acu-success-bg)'),setTimeout(()=>n.css('background',''),1500)):toastr&&toastr.error('保存失败')}})}),n.on('click.mvu','.mvu-dice-icon',function(t){t.stopPropagation(),t.preventDefault();const n=$(this),e=n.data('path'),a=n.data('attr-name')||'属性',o=parseInt(n.data('attr-value'),10)||50;if(!e)return void console.warn('[DICE]MvuModule 骰子图标缺少路径信息');if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)return console.warn('[DICE]MvuModule MVU 框架未加载，降级为普通投骰'),void('function'==typeof We&&We({attrValue:o,targetValue:null,targetName:a,initiatorName:'<user>',fromMvu:!1}));let i=null;try{i=function(t){try{if(!t||'string'!=typeof t)return{initiator:null,attrName:null,candidates:[]};const n=t.split('.').filter(t=>t&&t.trim());if(0===n.length)return{initiator:null,attrName:null,candidates:[]};const e=['角色列表','系统','列表','表','数据','信息','变量','属性','状态','stat_data','delta_data'],a=n.filter(t=>!e.includes(t));let o=null;a.length>=2?o=a[a.length-2]:1===a.length&&(o=a[0]);let i=null;return a.length>0?i=a[a.length-1]:n.length>0&&(i=n[n.length-1]),{initiator:o||null,attrName:i||null,candidates:a.length>0?a:n.slice(-1)}}catch(t){return console.warn('[DICE]parseMvuPathForDice 解析路径时出错',t),{initiator:null,attrName:null,candidates:[]}}}(e)}catch(t){console.warn('[DICE]MvuModule 解析路径时出错',t)}'function'==typeof We&&We({attrValue:o,targetValue:null,targetName:a,initiatorName:i?.initiator||'<user>',fromMvu:!0,mvuPath:e,mvuParsedInfo:i})}),function(){const t=window.parent?.document||document,n=$(t);n.off('touchstart.mvuSwipeFix touchmove.mvuSwipeFix touchend.mvuSwipeFix','#acu-data-area');let e=0,a=0,o=!1;n.on('touchstart.mvuSwipeFix','#acu-data-area',function(t){$(t.target).closest('.acu-mvu-panel').length>0&&1===t.originalEvent.touches.length&&(e=t.originalEvent.touches[0].clientX,a=t.originalEvent.touches[0].clientY,o=!1)}),n.on('touchmove.mvuSwipeFix','#acu-data-area',function(t){if(!($(t.target).closest('.acu-mvu-panel').length>0))return;if(1!==t.originalEvent.touches.length)return;const n=t.originalEvent.touches[0],i=Math.abs(n.clientX-e),r=Math.abs(n.clientY-a);(r<5?i>5&&i>2*r:i>1.5*r&&i>10)&&(o=!0,t.stopImmediatePropagation(),t.stopPropagation())}),n.on('touchend.mvuSwipeFix','#acu-data-area',function(t){if(!($(t.target).closest('.acu-mvu-panel').length>0))return o=!1,e=0,void(a=0);o&&(t.stopImmediatePropagation(),t.stopPropagation(),o=!1),e=0,a=0});t.addEventListener('touchstart',function(t){$(t.target).closest('.acu-mvu-panel').length>0&&t.touches&&1===t.touches.length&&(e=t.touches[0].clientX,a=t.touches[0].clientY)},!0),t.addEventListener('touchmove',function(t){if($(t.target).closest('.acu-mvu-panel').length>0&&t.touches&&1===t.touches.length&&e&&a){const n=t.touches[0],o=Math.abs(n.clientX-e),i=Math.abs(n.clientY-a);(i<5?o>5&&o>2*i:o>1.5*i&&o>10)&&(t.stopImmediatePropagation(),t.stopPropagation(),t.preventDefault())}},!0),t.addEventListener('touchend',function(t){$(t.target).closest('.acu-mvu-panel').length>0&&o&&(t.stopImmediatePropagation(),t.stopPropagation(),t.preventDefault())},!0)}(),n.on('click.mvu','.acu-close-btn',function(t){t.stopPropagation();const e=n.find('.acu-search-input');e.length&&e.val()?e.val('').trigger('input').focus():('function'==typeof me&&me(null),'function'==typeof mo&&mo())}),n.on('pointerdown.mvu','.acu-height-drag-handle',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const e=this;e.setPointerCapture(t.pointerId),$(e).addClass('active');const a=n.height(),o=t.clientY,i=$(e).data('table'),r=void 0!==window.MIN_PANEL_HEIGHT?window.MIN_PANEL_HEIGHT:200,c=void 0!==window.MAX_PANEL_HEIGHT?window.MAX_PANEL_HEIGHT:800;e.onpointermove=function(t){const e=t.clientY-o;let i=a-e;i<r&&(i=r),i>c&&(i=c),n.css('height',i+'px')},e.onpointerup=function(t){if($(e).removeClass('active'),e.releasePointerCapture(t.pointerId),e.onpointermove=null,e.onpointerup=null,i&&'function'==typeof Ce&&'function'==typeof Ee){const t=Ce();t[i]=parseInt(n.css('height')),Ee(t),n.addClass('acu-manual-mode')}}}),n.on('dblclick.mvu','.acu-height-drag-handle',function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data('table');if(e&&'function'==typeof Ce&&'function'==typeof Ee){const t=Ce();delete t[e],Ee(t),n.css('height','').removeClass('acu-manual-mode')}}),n.on('dblclick.mvu','.acu-panel-header',function(t){if($(t.target).closest('.acu-search-input, .acu-close-btn, .mvu-header-btn').length)return;t.preventDefault(),t.stopPropagation();const e=Lt.MODULE_ID;if(e&&'function'==typeof Ce&&'function'==typeof Ee){const t=Ce();delete t[e],Ee(t),n.css('height','').removeClass('acu-manual-mode')}})):console.warn('[DICE]MvuModule bindEvents: #acu-data-area not found')},showEditDialog:function(t,n,e){const $=window.parent?.jQuery||window.jQuery,a=window.parent?.document||document;if(!$)return;$(a).find('.mvu-edit-overlay').remove();const o=`\n                    <div class="mvu-edit-overlay acu-edit-overlay acu-theme-${('function'==typeof ca?ca().theme:null)||'retro'}">\n                        <div class="mvu-edit-dialog acu-edit-dialog">\n                            <div class="acu-edit-title">\n                                <i class="fa-solid fa-edit acu-edit-icon-muted"></i>\n                                <span>编辑变量</span>\n                            </div>\n                            <div class="mvu-edit-path">${u(t)}</div>\n                            <textarea class="mvu-edit-textarea acu-edit-textarea">${u(n)}</textarea>\n                            <div class="mvu-edit-hint">Ctrl+Enter 保存 | Esc 取消</div>\n                            <div class="acu-dialog-btns">\n                                <button class="acu-dialog-btn mvu-btn-cancel">\n                                    <i class="fa-solid fa-times"></i> 取消\n                                </button>\n                                <button class="acu-dialog-btn acu-btn-confirm mvu-btn-save">\n                                    <i class="fa-solid fa-check"></i> 保存\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                `;$(a.body).append(o);const i=$(a).find('.mvu-edit-overlay'),r=i.find('.mvu-edit-textarea');setTimeout(()=>r.focus().select(),50),i.on('click','.mvu-btn-cancel',function(t){t.preventDefault(),t.stopPropagation(),i.remove(),e(null)}),i.on('click','.mvu-btn-save',function(t){t.preventDefault(),t.stopPropagation();const n=r.val();i.remove(),e(n)}),y(i,'mvu-edit-overlay',()=>{i.remove(),e(null)}),r.on('keydown',function(t){if('Escape'===t.key)t.preventDefault(),i.remove(),e(null);else if('Enter'===t.key&&t.ctrlKey){t.preventDefault();const n=r.val();i.remove(),e(n)}})},parsePath:function(t){const n=t.match(/^([^.\[]+)/),e=n?n[1]:t;let a=t.slice(e.length);return a.startsWith('.')&&(a=a.slice(1)),{rootName:e,subPath:a}},setLwbValue:function(t,a){try{const o=window.SillyTavern||window.parent?.SillyTavern;if(!o?.chatMetadata)return void console.error('[DICE]无法访问 chatMetadata');o.chatMetadata.variables||(o.chatMetadata.variables={});const{rootName:i,subPath:r}=this.parsePath(t);if(r){let t=s(o.chatMetadata.variables[i]);'object'==typeof t&&null!==t||(t={}),_.set(t,r,a),o.chatMetadata.variables[i]=JSON.stringify(t)}else o.chatMetadata.variables[i]='object'==typeof a&&null!==a?JSON.stringify(a):String(a??'');o.saveMetadata?.(),n=null,e=null,console.log('[DICE]LWB 变量已更新:',t,'=',a)}catch(t){console.error('[DICE]LWB 变量写入失败:',t)}},setValue:async function(t,n){if(!p())return!1;const e=c();try{let a=n;if('true'===n?a=!0:'false'===n?a=!1:isNaN(Number(n))||''===String(n).trim()||(a=Number(n)),'era'===e)return await async function(t,n){return new Promise(e=>{const a=setTimeout(()=>{console.warn('[DICE]MvuModule ERA写入超时'),e(!1)},5e3),o=window.eventEmit||window.parent?.eventEmit,i=window.eventOn||window.parent?.eventOn,r=window.eventOff||window.parent?.eventOff,c=t=>{clearTimeout(a),'function'==typeof r&&r('era:writeDone',c),console.log('[DICE]MvuModule ERA写入成功'),e(!0)};try{if(console.log('[DICE]MvuModule 开始设置ERA变量:',t,n),'function'!=typeof i)return console.error('[DICE]MvuModule eventOn 不可用'),clearTimeout(a),void e(!1);if('function'!=typeof o)return console.error('[DICE]MvuModule eventEmit 不可用'),clearTimeout(a),void e(!1);i('era:writeDone',c),o('era:updateByPath',{path:t,value:n})}catch(t){clearTimeout(a),console.error('[DICE]MvuModule ERA API调用失败:',t),e(!1)}})}(t,a);if('lwb'===e)return this.setLwbValue(t,a),!0;{const n=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(!n)return console.error('[DICE]MvuModule 无法获取 MVU 数据'),!1;const e=await window.Mvu.setMvuVariable(n,t,a,{reason:'手动编辑',is_recursive:!1});return e?await window.Mvu.replaceMvuData(n,{type:'message',message_id:'latest'}):console.warn('[DICE]MvuModule setMvuVariable 返回 false'),e}}catch(t){return console.error('[DICE]MvuModule setValue error:',t),!1}},isModuleTab:function(n){return n===t},clearCache:function(){n=null,e=null,console.log('[DICE]MvuModule 已清除 ERA 缓存')},detectMode:function(){return c()},refresh:function(t){if(this.clearCache(),!t||!t.length){const n=$('#acu-data-area');if(!n.length)return;t=n}const n=t.find('.mvu-btn-refresh');n.length&&n.find('i').addClass('fa-spin'),this.getDataWithRetry(10,1e3).then(e=>{if(n.length&&n.find('i').removeClass('fa-spin'),!he())return;t.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(t);const toastr=window.parent?.toastr||window.toastr,a=this.getData();toastr&&!a&&toastr.warning('无法获取变量数据，请稍后重试或确保角色卡已配置 MVU 框架')}).catch(e=>{if(console.error('[DICE]MvuModule Error refreshing data:',e),n.length&&n.find('i').removeClass('fa-spin'),!he())return;t.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(t);const toastr=window.parent?.toastr||window.toastr,a=this.getData();toastr&&!a&&toastr.error('获取变量数据时出错')})}}}(),Ut={critSuccessMax:5,hardSuccessDiv:5,difficultSuccessDiv:2,critFailMin:96,ruleType:'high_good',lastDiceType:'1d100',dndCritSuccess:20,dndCritFail:1,contestTieRule:'initiator_lose',hideDiceResultFromUser:!1,hideDiceResultInChat:!1,autoMergeProtagonist:!0},qt=()=>fe.get(L,Ut),Yt=t=>{const n=qt(),e={...n,...t};fe.set(L,e);const a=Object.keys(t).filter(t=>n[t]!==e[t]);a.length>0&&console.info(`[DICE]投骰配置已更新: ${a.join(', ')}`)},Wt=()=>{try{const t=qt(),n=void 0!==t.hideDiceResultFromUser&&t.hideDiceResultFromUser,e=void 0!==t.hideDiceResultInChat&&t.hideDiceResultInChat,a=/<meta:检定结果>[\s\S]*?<\/meta:检定结果>/g;try{const t=$('#send_textarea');if(t.length){let e=t.val()||'',o=e;if(n)a.test(o)&&(o=o.replace(a,'[投骰结果已隐藏]'));else{const n=t.data('acu-original-dice-text');n&&e.includes('[投骰结果已隐藏]')&&(o=e.replace(/\[投骰结果已隐藏\]/g,n),t.removeData('acu-original-dice-text'))}o!==e&&t.val(o).trigger('input').trigger('change')}}catch(t){console.warn('[DICE]ACU 处理输入栏投骰结果失败:',t)}let o;try{o=getLastMessageId()}catch(t){return}if(o<0)return;try{const t=getChatMessages(`0-${o}`,{role:'user'});if(!t||0===t.length)return;if(e){let n=0;if(t.forEach(t=>{try{const e=(t=>{if('function'==typeof retrieveDisplayedMessage)try{const n=retrieveDisplayedMessage(t);if(n&&n.length)return n}catch(t){}const n=String(t),e=$('#chat');if(!e.length)return $();return e.find(`.mes[mesid="${n}"], .mes[data-message-id="${n}"], .mes#mes_${n}, .message-body[data-message-id="${n}"]`).first()})(t.message_id);if(!e||!e.length)return;let a=e.find('.mes_text');a&&a.length||(a=e.find('.message-text, .text, [class*="text"], [class*="message"]').first(),a&&a.length||(a=e));const o=a.text();if(o.includes('[投骰结果已隐藏]'))return;const i=t.message||'';if(!i)return;const r=a.html()||'';let c=r;if(c=c.replace(/(&lt;|<)meta:检定结果(&gt;|>)[\s\S]*?(&lt;|<)\/meta:检定结果(&gt;|>)/g,'[投骰结果已隐藏]'),c===r&&(c=c.replace(/<meta:检定结果>[\s\S]*?<\/meta:检定结果>/g,'[投骰结果已隐藏]')),c!==r)return a.html(c),void n++;const s=/<meta:检定结果>[\s\S]*?<\/meta:检定结果>/g,l=o.replace(s,'[投骰结果已隐藏]');if(l!==o)return a.text(l),void n++;const d=i.replace(s,'[投骰结果已隐藏]');d!==i&&d!==o&&('function'==typeof formatAsDisplayedMessage?a.html(formatAsDisplayedMessage(d)):a.text(d),n++)}catch(n){console.warn(`[DICE]ACU 隐藏第 ${t.message_id} 楼投骰结果失败:`,n)}}),0===n){const t=$('#chat');t.length&&t.find('.mes, .message-body').each((_,t)=>{const e=$(t),a=e.find('.mes_text').length?e.find('.mes_text'):e,o=a.html()||'';let i=o.replace(/(&lt;|<)meta:检定结果(&gt;|>)[\s\S]*?(&lt;|<)\/meta:检定结果(&gt;|>)/g,'[投骰结果已隐藏]');i===o&&(i=o.replace(/<meta:检定结果>[\s\S]*?<\/meta:检定结果>/g,'[投骰结果已隐藏]')),i!==o&&(a.html(i),n++)})}n>0&&console.info(`[DICE]已隐藏 ${n} 条消息的投骰结果`)}else{let n=0;t.forEach(t=>{try{const e=(t=>{if('function'==typeof retrieveDisplayedMessage)try{const n=retrieveDisplayedMessage(t);if(n&&n.length)return n}catch(t){}const n=String(t),e=$('#chat');if(!e.length)return $();return e.find(`.mes[mesid="${n}"], .mes[data-message-id="${n}"], .mes#mes_${n}, .message-body[data-message-id="${n}"]`).first()})(t.message_id);if(!e||!e.length)return;const a=e.find('.mes_text');if(!a||!a.length)return;if(a.text().includes('[投骰结果已隐藏]')){const e=t.message||'';e&&(a.text(e),n++)}}catch(t){}}),n>0&&console.info(`[DICE]已恢复 ${n} 条消息的投骰结果`)}}catch(t){e&&console.warn('[DICE]ACU 处理聊天记录投骰结果失败:',t)}}catch(t){const n=qt();n&&(n.hideDiceResultFromUser||n.hideDiceResultInChat)&&console.warn('[DICE]ACU 隐藏投骰结果失败:',t)}},Jt=[{kind:'advanced',id:'coc7_check',name:'CoC7',description:'克苏鲁的呼唤7版: 1d100 <= 属性值即成功',version:Q,builtin:!0,diceExpression:'1d100',attribute:{label:'技能值',placeholder:'留空=50',defaultValue:50,key:'技能值'},dc:{hidden:!0,defaultValue:0},mod:{hidden:!0,defaultValue:0},customFields:[{id:'bonusPenalty',type:'number',label:'奖惩骰',defaultValue:'',placeholder:'+1 奖励, -1 惩罚'},{id:'requiredRank',type:'select',label:'最低成功等级',defaultValue:1,options:[{label:'成功',value:1},{label:'困难成功',value:2},{label:'极难成功',value:3}],contestOverride:{hidden:!0}}],derivedVars:[{id:'absBp',expr:'abs($bonusPenalty)'}],dicePatches:[{when:'$bonusPenalty > 0',op:'append',template:'b$absBp'},{when:'$bonusPenalty < 0',op:'append',template:'p$absBp'}],effectsConfig:{triggerPatterns:['SAN*','SAN值*','*理智*','*sanity*','*Sanity*'],allowedTargets:['SAN','SAN值','理智','Sanity','san']},pushedRoll:{enabled:!0,pushableOutcomes:['warning','failure'],blockedOutcomes:['crit_failure'],excludePatterns:['SAN*','SAN值*','*理智*','*sanity*','*Sanity*','*闪避*','*dodge*','*Dodge*'],outcomeLabels:{crit_success:'🎲 孤注一掷 — 大成功！',extreme_success:'🎲 孤注一掷 — 极难成功！',success:'🎲 孤注一掷成功！','*':'⚠ 孤注一掷失败！'}},resourceBurners:[{id:'coc7_luck_burn',resourceName:'幸运',target:'roll',ratio:1,direction:'decrease',suggestedAmount:'$roll.total - $attr',condition:'$roll.total > $attr && $isPushed == 0',selector:{namePatterns:{include:['*'],exclude:['SAN*','SAN值*','*理智*','*sanity*','*Sanity*','幸运*','*Luck*','*luck*']}},ui:{icon:'fa-clover',color:'var(--acu-accent)',tooltip:'消耗幸运降低骰子结果 (1:1)'}}],quickActions:[{id:'to_san_check',kind:'attr_shortcut',icon:'fa-brain',tooltip:'SAN检定',config:{presetId:'coc7_check',carryInitiator:!0,carryAttrValue:!1,carryTarget:!1,carryModifier:!1,carrySkillMod:!1,attrAliasCandidates:['SAN值','SAN','理智','sanity','Sanity','san'],fallbackAttrName:'SAN值'}},{id:'to_skill_growth',kind:'workflow_shortcut',icon:'fa-seedling',tooltip:'技能成长检定',config:{presetId:'coc7_growth_check',carryInitiator:!0,carryAttrName:!0,carryAttrValue:!0}}],outcomes:[{id:'crit_success',name:'大成功',condition:'$roll.total === 1',priority:1,rank:4,contestRank:100,outputText:''},{id:'extreme_success',name:'极难成功',condition:'$roll.total <= $attr / 5',priority:10,rank:3,contestRank:100,outputText:''},{id:'hard_success',name:'困难成功',condition:'$roll.total <= $attr / 2',priority:20,rank:2,contestRank:80,outputText:''},{id:'success',name:'成功',condition:'$roll.total <= $attr',priority:30,rank:1,contestRank:60,outputText:'',effects:[{id:'san_loss_success',target:'SAN',operation:'subtract',value:'1',outputText:'SAN 减少 $effectDelta (成功)'}]},{id:'failure',name:'失败',condition:'$roll.total > $attr',displayExpr:'$roll.total <= $attr',priority:50,rank:0,contestRank:40,outputText:'',effects:[{id:'san_loss_fail',target:'SAN',operation:'subtract',value:'1d6',outputText:'SAN 减少 $effectDelta'}]},{id:'crit_failure',name:'大失败',condition:'($attr < 50 && $roll.total >= 96) || ($attr >= 50 && $roll.total === 100)',priority:5,rank:-1,contestRank:20,outputText:'',effects:[{id:'san_loss_fumble',target:'SAN',operation:'subtract',value:'1d10',outputText:'SAN 减少 $effectDelta (大失败)'}]},{id:'unmet',name:'失败',condition:'false',priority:999,rank:-2}],outcomePolicy:{kind:'minRank',requiredRankVarId:'requiredRank',unmetOutcomeId:'unmet',keepActualOutcome:!0},secondaryEffects:[{id:'coc7_temp_insanity',trigger:{type:'delta',attribute:'SAN',operator:'gte',value:'5'},outputText:'⚠ 单次SAN损失$delta点(≥5)，触发临时疯狂流程，自动进行INT检定。',subCheck:{label:'INT检定',attribute:'INT',attributeCandidates:['智力','灵感','灵感值'],dice:'1d100',operator:'lte',success:{outputText:'🧠 $subCheckLabel：$subCheckDice=$subCheckRoll，判定 $subCheckRoll <= $subCheckTarget？$subCheckJudge，$initiator 陷入临时疯狂。\n症状：$symptomResult\n持续时间：即时发作约$durationImmediateRoll轮，整体影响约$durationSummaryRoll小时。',randomTables:{durationImmediate:{dice:'1d10'},durationSummary:{dice:'1d10'},symptom:{dice:'1d10',entries:{1:'失忆——$initiator 回过神来，发现自己身处陌生之处，不记得这段时间发生了什么',2:'假性残疾——$initiator 陷入心因性失明、失聪或肢体瘫痪',3:'暴力倾向——$initiator 陷入暴怒，不分敌我地攻击周围一切',4:'偏执——$initiator 产生严重的被害妄想，不信任任何人',5:'重要之人——$initiator 把在场某人当作了自己生命中的重要之人',6:'昏厥——$initiator 当场昏倒，不省人事',7:'惊慌逃跑——$initiator 不顾一切地逃离此地',8:'歇斯底里——$initiator 情绪彻底崩溃，无法控制地大笑、大哭或尖叫',9:'恐惧症——$initiator 获得一个新的恐惧症（由KP根据场景决定具体内容）',10:'狂躁症——$initiator 获得一个新的狂躁症（由KP根据场景决定具体内容）'}}}},failure:{outputText:'🧠 $subCheckLabel：$subCheckDice=$subCheckRoll，判定 $subCheckRoll <= $subCheckTarget？$subCheckJudge，$initiator 未陷入临时疯狂。'}},enabled:!0,maxTriggerCount:1},{id:'coc7_permanent_insanity',trigger:{type:'threshold',attribute:'SAN',operator:'lte',value:'0'},outputText:'💀 永久疯狂！SAN值降至$new，该角色永久疯狂，由KP接管成为NPC。',enabled:!0,maxTriggerCount:1}],contestRule:{mode:'rank',tieBreakers:['higher_attr','initiator_wins']},outputTemplate:'<meta:检定结果>\n$outcomeText\n元叙事：$initiator 发起了 $attrName 检定，$formula=$roll，判定 $conditionExpr？$judgeResult，判定为【$outcomeName】\n</meta:检定结果>'},{kind:'advanced',id:'coc7_growth_check',name:'CoC7-成长',description:'幕间技能成长快捷模式（检定成功可成长）',version:Q,builtin:!0,visible:!1,diceExpression:'1d100',attribute:{label:'技能值',placeholder:'留空=50',defaultValue:50,key:'技能值'},dc:{hidden:!0,defaultValue:0},mod:{hidden:!0,defaultValue:0},customFields:[{id:'growthGain',type:'text',label:'成长值',defaultValue:'1d10',placeholder:'如 1d10'}],outcomes:[{id:'growth_success',name:'成功',condition:'$roll.total > $attr',priority:30,rank:1,outputText:''},{id:'growth_failure',name:'失败',condition:'$roll.total <= $attr',displayExpr:'$roll.total > $attr',priority:60,rank:0,outputText:''}],currentAttrAutoUpdate:{enabled:!0,when:'success',operation:'add',valueExpr:'$growthGain',min:0,changeLabel:'成长',outputTextTemplate:'已填表：$attr成长$expr=$rolled，$attrPlain从$old变为$new'},outputTemplate:'<meta:检定结果>\n元叙事：$initiator 发起了$attrName成长检定，$formula=$roll，判定 $conditionExpr？$judgeResult，结果为【$outcomeName】\n</meta:检定结果>'},{kind:'advanced',id:'dnd5e_check',name:'DND5e',description:'D&D第五版: 1d20 + 调整值 >= DC (调整值自动从属性值计算)',version:Q,builtin:!0,diceExpression:'1d20',attribute:{label:'属性值',placeholder:'留空=10',defaultValue:10,key:'属性值',computeModifier:'floor(($attr - 10) / 2)'},dc:{label:'难度等级(DC)',placeholder:'留空=10',defaultValue:10},mod:{label:'额外加值',placeholder:'留空=0',defaultValue:0},skillMod:{label:'技能加值',placeholder:'留空=0',defaultValue:0},attrTargetMapping:{skillMod:['运动','体操','巧手','隐匿','奥秘','历史','调查','自然','宗教','驯兽','洞悉','医药','察觉','求生','欺瞒','威吓','表演','游说']},customFields:[{id:'advantage',type:'select',label:'优势/劣势',defaultValue:0,options:[{label:'正常',value:0},{label:'优势',value:1},{label:'劣势',value:-1}]}],dicePatches:[{when:'$advantage > 0',op:'replace',template:'2d20kh1'},{when:'$advantage < 0',op:'replace',template:'2d20kl1'}],outcomes:[{id:'crit_success',name:'大成功',condition:'$roll.hasTag(\'nat20\')',priority:1,outputText:''},{id:'success',name:'成功',condition:'$roll.total + $attrMod + $skillMod + $mod >= $dc',priority:30,outputText:''},{id:'failure',name:'失败',condition:'true',displayExpr:'$roll.total + $attrMod + $skillMod + $mod >= $dc',priority:50,outputText:''},{id:'crit_failure',name:'大失败',condition:'$roll.hasTag(\'nat1\')',priority:2,outputText:''}],contestRule:{mode:'value',tieBreakers:['status_quo'],hideDc:!0},contestOutputTemplate:'<meta:检定结果>\n 元叙事：进行了一次【$initiator $initAttrName vs $opponent $oppAttrName】的对抗检定。\n $initiator $initAttrName：$formula=$initRoll$initAttrModText$initSkillModText$initModText，总值=$initTotal；\n $opponent $oppAttrName：$formula=$oppRoll$oppAttrModText$oppSkillModText$oppModText，总值=$oppTotal。\n 最终结果：【$winner】\n </meta:检定结果>',outputTemplate:'<meta:检定结果>\n$outcomeText\n元叙事：$initiator 发起了 $attrName 检定，属性值$attrValue$attrModText$skillModText，$formula=$roll，判定 $conditionExpr？$judgeResult，判定为【$outcomeName】\n</meta:检定结果>'},{kind:'advanced',id:'fate',name:'Fate',description:'Fate规则: 4dF + 技能值 + 修正值 >= 难度',version:Q,builtin:!0,diceExpression:'4dF',attributeName:{label:'技能/风格',placeholder:'自由检定'},attribute:{label:'技能值',placeholder:'留空=0',defaultValue:0,key:'技能值'},dc:{label:'难度',placeholder:'留空=0',defaultValue:0},mod:{label:'修正值',placeholder:'留空=0',defaultValue:0},outcomes:[{id:'succeed_with_style',name:'大成功',condition:'$roll.total + $attr + $mod >= $dc + 3',priority:1,outputText:'Fate: 大成功！超出难度3级或更多，可获得额外好处。'},{id:'success',name:'成功',condition:'$roll.total + $attr + $mod >= $dc',priority:10,outputText:'Fate: 成功，达成目标。'},{id:'tie',name:'平手',condition:'$roll.total + $attr + $mod === $dc - 1',priority:20,outputText:'Fate: 平手，勉强达成但可能有小代价。'},{id:'failure',name:'失败',condition:'$roll.total + $attr + $mod < $dc',priority:99,outputText:'Fate: 失败，未能达成目标。'}],contestRule:{mode:'margin',hideDc:!0},outputTemplate:'<meta:检定结果>\n$outcomeText\n元叙事：$initiator 发起了 $attrName 检定，技能等级$attrValue，修正值$mod，$formula=$roll，总值=$roll+$attr+$mod，判定 $conditionExpr？$judgeResult，判定为【$outcomeName】\n</meta:检定结果>',contestOutputTemplate:'<meta:检定结果>\n 元叙事：进行了一次【$initiator $initAttrName vs $opponent $oppAttrName】的Fate对抗检定。\n $initiator $initAttrName：$formula=$initRoll，技能等级$initAttr+修正值$initMod，总值=$initTotal；\n $opponent $oppAttrName：$formula=$oppRoll，技能等级$oppAttr+修正值$oppMod，总值=$oppTotal。\n 差值(Shifts)：$margin（正数表示$initiator领先，负数表示$opponent领先）\n 最终结果：【$winner】\n </meta:检定结果>'},{kind:'advanced',id:'pbta_move',name:'PbtA',description:'Powered by the Apocalypse: 2d6+属性, 6-失败/7-9部分成功/10+完全成功',version:Q,builtin:!0,diceExpression:'2d6',attribute:{label:'属性值',placeholder:'留空=0',defaultValue:0,key:'属性'},dc:{hidden:!0,defaultValue:0},mod:{label:'临时加值',placeholder:'留空=0',defaultValue:0},outcomes:[{id:'strong_hit',name:'完全成功',condition:'$roll.total + $attr + $mod >= 10',priority:1,outputText:'PbtA:完全成功!'},{id:'weak_hit',name:'部分成功',condition:'$roll.total + $attr + $mod >= 7',priority:20,outputText:'PbtA:部分成功。'},{id:'miss',name:'失败',condition:'$roll.total + $attr + $mod < 7',priority:99,outputText:'PbtA:失败...'}],contestRule:{disabled:!0},outputTemplate:'<meta:检定结果>\n$outcomeText\n元叙事：$initiator 发起了 $attrName 检定，属性值$attrValue，临时加值$mod，$formula=$roll，总值=$roll+$attr+$mod，判定 $conditionExpr？$judgeResult，判定为【$outcomeName】\n</meta:检定结果>'},{kind:'advanced',id:'triangle_agency',name:'三角机构',description:'6d4统计3的个数；至少一个3成功，三个3为三重升华；无3失败',version:Q,builtin:!0,diceExpression:'6d4=3',attribute:{hidden:!0,defaultValue:0},dc:{hidden:!0,defaultValue:0},mod:{hidden:!0,defaultValue:0},derivedVars:[{id:'chaos',expr:'6 - $roll.total'}],outcomes:[{id:'triple_success',name:'三重升华',condition:'$roll.total === 3',priority:1,rank:3,outputText:'三角机构：三重升华！命中三个3，完美共鸣达成。'},{id:'success',name:'成功',condition:'$roll.total >= 1',priority:10,rank:1,outputText:'三角机构：成功。至少命中一个3，行动达成。'},{id:'failure',name:'失败',condition:'$roll.total === 0',priority:50,rank:0,outputText:'三角机构：失败。未能命中任何3，行动受阻。'}],contestRule:{disabled:!0},outputTemplate:'<meta:检定结果>\n$outcomeText\n元叙事：$initiator 的三角机构检定，$formula=$roll，命中3的个数：$roll.total，GM获得混沌：$chaos，判定为【$outcomeName】\n</meta:检定结果>'}],Ht=[{format:'acu_attr_preset_v1',version:Q,id:'coc7',name:'简化COC规则',builtin:!0,description:'基于克苏鲁的呼唤第7版规则的属性预设。包含9条基本属性和18条特殊属性。',baseAttributes:[{name:'力量',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'体质',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'体型',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'},{name:'敏捷',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'外貌',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'意志',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'幸运',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'智力',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'},{name:'教育',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'}],specialAttributes:[{name:'侦查',formula:'10+5d20',range:[15,95]},{name:'聆听',formula:'10+5d20',range:[15,95]},{name:'心理学',formula:'10+5d20',range:[15,95]},{name:'说服',formula:'5+4d20',range:[9,85]},{name:'话术',formula:'5+4d20',range:[9,85]},{name:'潜行',formula:'5+4d20',range:[9,85]},{name:'格斗',formula:'5+4d20',range:[9,85]},{name:'射击',formula:'5+4d20',range:[9,85]},{name:'信用评级',formula:'5+4d20',range:[9,85]},{name:'魅惑',formula:'5+3d20',range:[8,65]},{name:'恐吓',formula:'5+3d20',range:[8,65]},{name:'图书馆使用',formula:'5+3d20',range:[8,65]},{name:'急救',formula:'5+3d20',range:[8,65]},{name:'驾驶',formula:'5+3d20',range:[8,65]},{name:'神秘学',formula:'1+2d20',range:[3,41]},{name:'闪避',formula:'敏捷/2',range:[1,99]},{name:'SAN值',formula:'意志',range:[1,99]},{name:'克苏鲁神话',formula:'1d5',range:[1,5]}]},{format:'acu_attr_preset_v1',version:Q,id:'dnd5e',name:'简化DND规则',builtin:!0,description:'基于龙与地下城第5版规则的属性预设。包含6条基本属性和19条技能/派生属性。技能使用长尾分布：多数人为0或负值，少数专家可达+10以上。',baseAttributes:[{name:'力量',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'敏捷',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'体质',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'智力',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'感知',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'魅力',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'}],specialAttributes:[{name:'运动',formula:'4d8kl1-3',range:[-2,5]},{name:'杂技',formula:'4d8kl1-3',range:[-2,5]},{name:'巧手',formula:'4d8kl1-3',range:[-2,5]},{name:'隐匿',formula:'5d10kl1-4',range:[-3,6]},{name:'奥秘',formula:'3d6kl1-2',range:[-1,4]},{name:'历史',formula:'3d6kl1-2',range:[-1,4]},{name:'调查',formula:'4d8kl1-3',range:[-2,5]},{name:'自然',formula:'3d6kl1-2',range:[-1,4]},{name:'宗教',formula:'3d6kl1-2',range:[-1,4]},{name:'驯兽',formula:'3d6kl1-2',range:[-1,4]},{name:'洞悉',formula:'5d10kl1-4',range:[-3,6]},{name:'医药',formula:'3d6kl1-2',range:[-1,4]},{name:'察觉',formula:'5d10kl1-4',range:[-3,6]},{name:'求生',formula:'3d6kl1-2',range:[-1,4]},{name:'欺瞒',formula:'4d8kl1-3',range:[-2,5]},{name:'威吓',formula:'4d8kl1-3',range:[-2,5]},{name:'表演',formula:'3d6kl1-2',range:[-1,4]},{name:'游说',formula:'4d8kl1-3',range:[-2,5]},{name:'先攻',formula:'floor((敏捷-10)/2)',range:[-4,4]}]}],Xt=(()=>{let t=null;return{getAllPresets(){const n=fe.get(U,[]);let e=!1;return n.forEach(t=>{const n=t.version||'0.0.0';tt(n,Q)<0&&(console.log(`[DICE]AttributePresetManager 检测到预设 "${t.name}" 版本较旧 (${n})，自动更新到 ${Q}`),t.version=Q,e=!0)}),e&&(fe.set(U,n),t=null),!e&&t||(t=[...Ht,...n]),t},getActivePreset(){const t=fe.get(q,null);return t&&this.getAllPresets().find(n=>n.id===t)||null},setActivePreset(n){try{const e=''===n||void 0===n?null:n;return fe.set(q,e),t=null,console.log('[DICE]AttributePresetManager 切换预设:',e),setTimeout(()=>{'function'==typeof en&&en(e)},0),!0}catch(t){return console.error('[DICE]AttributePresetManager 设置预设失败:',t),!1}},createPreset(n){const e=fe.get(U,[]),a={...n,id:n.id||'custom_'+Date.now(),builtin:!1,version:n.version||Q,createdAt:(new Date).toISOString()};return e.push(a),fe.set(U,e),t=null,console.log('[DICE]AttributePresetManager 创建预设:',a.name),a},updatePreset(n,e){const a=fe.get(U,[]),o=a.findIndex(t=>t.id===n);return!(o<0)&&(a[o]={...a[o],...e},fe.set(U,a),t=null,console.log('[DICE]AttributePresetManager 更新预设:',n),!0)},deletePreset(n){const e=fe.get(U,[]),a=e.filter(t=>t.id!==n);return a.length!==e.length&&(fe.set(U,a),t=null,fe.get(q)===n&&fe.set(q,null),console.log('[DICE]AttributePresetManager 删除预设:',n),!0)},exportPreset(t){const n=this.getAllPresets().find(n=>n.id===t);if(!n)return null;const e={format:'acu_attr_preset_v1',version:Q,...n};return delete e.builtin,JSON.stringify(e,null,2)},importPreset(t,n=!1){try{const e=JSON.parse(t);if('acu_attr_preset_v1'!==e.format)throw new Error('不支持的预设格式');if(!e.name||!e.baseAttributes||!Array.isArray(e.baseAttributes))throw new Error('预设数据不完整');const a=e.version||'0.0.0',o=tt(a,Q)<0,i={...e,id:'imported_'+Date.now(),builtin:!1,version:n&&o?Q:a,createdAt:(new Date).toISOString()},r=this.createPreset(i);return r&&o&&!n&&console.warn(`[DICE]AttributePresetManager 导入的预设 "${r.name}" 版本较旧 (${a})，建议更新到 ${Q}`),r}catch(t){return console.error('[DICE]AttributePresetManager 导入失败:',t),null}},clearCache(){t=null}}})(),Kt='acu_active_advanced_preset',Gt=(()=>{let t=null;const n=()=>{const t=fe.get(H,{});return t&&'object'==typeof t?t:{}},e=()=>{const t=fe.get(X,{});return t&&'object'==typeof t?t:{}};return{getAllPresets(){const a=fe.get(J,[]);let o=!1;if(a.forEach(t=>{const n=t.version||'0.0.0';tt(n,Q)<0&&(console.log(`[DICE]AdvancedDicePresetManager 检测到预设 "${t.name}" 版本较旧 (${n})，自动更新到 ${Q}`),t.version=Q,o=!0)}),o&&(fe.set(J,a),t=null),!o&&t)return t;const i=n(),r=e(),c=Jt.map((t,n)=>({...t,visible:i[t.id]??t.visible??!0,order:r[t.id]??t.order??n})),s=a.map(t=>({...t,visible:t.visible??!1,order:t.order??999}));return t=[...c,...s],t},getActivePreset(){const t=fe.get(Kt,null);return t&&this.getAllPresets().find(n=>n.id===t)||null},setActivePreset(n){try{const e=''===n||void 0===n?null:n;return fe.set(Kt,e),t=null,console.log('[DICE]AdvancedDicePresetManager 切换预设:',e),!0}catch(t){return console.error('[DICE]AdvancedDicePresetManager 设置预设失败:',t),!1}},setBuiltinPresetVisibility(e,a){try{const o=n();return o[e]=a,fe.set(H,o),t=null,!0}catch(t){return console.error('[DICE]AdvancedDicePresetManager 设置内置预设显示状态失败:',t),!1}},setPresetOrder(n,a){try{if(Jt.some(t=>t.id===n)){const o=e();return o[n]=a,fe.set(X,o),t=null,!0}return this.updatePreset(n,{order:a})}catch(t){return console.error('[DICE]AdvancedDicePresetManager 设置预设排序失败:',t),!1}},createPreset(n){const e=fe.get(J,[]),a={...n,id:n.id||'custom_'+Date.now(),kind:'advanced',builtin:!1,version:n.version||Q,createdAt:(new Date).toISOString()};return e.push(a),fe.set(J,e),t=null,console.log('[DICE]AdvancedDicePresetManager 创建预设:',a.name),a},updatePreset(n,e){if(Jt.some(t=>t.id===n))throw console.error('[DICE]AdvancedDicePresetManager 不能修改内置预设:',n),new Error('不能修改内置预设');const a=fe.get(J,[]),o=a.findIndex(t=>t.id===n);return!(o<0)&&(a[o]={...a[o],...e,id:n},fe.set(J,a),t=null,console.log('[DICE]AdvancedDicePresetManager 更新预设:',n),!0)},deletePreset(n){if(Jt.some(t=>t.id===n))throw console.error('[DICE]AdvancedDicePresetManager 不能删除内置预设:',n),new Error('不能删除内置预设');const e=fe.get(J,[]),a=e.filter(t=>t.id!==n);return a.length!==e.length&&(fe.set(J,a),t=null,fe.get(Kt)===n&&fe.set(Kt,null),console.log('[DICE]AdvancedDicePresetManager 删除预设:',n),!0)},exportPreset(t){const n=this.getAllPresets().find(n=>n.id===t);if(!n)return null;const e={kind:'advanced',version:Q,...n};return delete e.builtin,JSON.stringify(e,null,2)},importPreset(t){try{const n=JSON.parse(t);if('advanced'!==n.kind)throw new Error('不支持的预设格式');if(!n.name||!n.diceExpression)throw new Error('预设数据不完整: 缺少名称或骰子表达式');if(!Array.isArray(n.outcomes)||0===n.outcomes.length)throw new Error('预设数据不完整: 缺少 outcomes 判定条件');const e=n.version||'0.0.0',a=tt(e,Q)<0;n.ui&&(n.ui.attributeLabel&&n.attribute&&(n.attribute.label=n.ui.attributeLabel),n.ui.dcLabel&&n.dc&&(n.dc.label=n.ui.dcLabel),delete n.ui);const o={...n,id:'imported_'+Date.now(),kind:'advanced',builtin:!1,version:Q,createdAt:(new Date).toISOString()},i=this.createPreset(o);return i&&a&&console.warn(`[DICE]AdvancedDicePresetManager 导入的预设 "${i.name}" 版本较旧 (${e})，已自动更新到 ${Q}`),i}catch(t){return console.error('[DICE]AdvancedDicePresetManager 导入失败:',t),null}},clearCache(){t=null},supportsContest(t){if(!t)return!0;const n='string'==typeof t?this.getAllPresets().find(n=>n.id===t):t;return!n||!(!0===n.contestRule?.disabled)}}})(),Zt=[0,100],Qt='爆裂魔法:85; 时间回溯:70; 超电磁炮:90',tn={id:'__default__',name:'六维属性百分制',baseAttributes:['力量','敏捷','体质','智力','感知','魅力'].map(t=>({name:t,formula:'3d6*5',range:[5,95],modifier:'1d10-5'})),specialAttributes:[]},nn=(t,n,e)=>{const a=new RegExp(`<${n}>[\\s\\S]*?</${n}>`,'g');return t.replace(a,`<${n}>\n${e}\n</${n}>`)},en=t=>{let n;if(null===t||'__default__'===t)n=tn;else{n=Xt.getAllPresets().find(n=>n.id===t)||tn}const e=Be(null===t||'__default__'===t?null:n);let a=0,o=100,i=0,r=100;if(n.baseAttributes&&n.baseAttributes.length>0){const t=n.baseAttributes.map(t=>t.range);a=Math.min(...t.map(t=>t[0])),o=Math.max(...t.map(t=>t[1]))}if(n.specialAttributes&&n.specialAttributes.length>0){const t=n.specialAttributes.map(t=>t.range);i=Math.min(...t.map(t=>t[0])),r=Math.max(...t.map(t=>t[1]))}const c=Object.entries(e.base),s=Object.entries(e.special),l=le().getDB();if(!l||'function'!=typeof l.getTableTemplate)return void console.warn('[DICE] updateTemplateForActivePreset: 数据库 API 不可用，跳过更新');const d=l.getTableTemplate();if(!d)return void console.warn('[DICE] updateTemplateForActivePreset: 无法获取表格模板，跳过更新');const u=((t,n)=>{const e=n-t,a=Math.floor(t+.1*e),o=Math.floor(t+.4*e),i=Math.floor(t+.6*e),r=Math.floor(t+.8*e),c=Math.floor(t+.9*e),s=(t,n)=>t===n?`${t}`:`${t}-${n}`;return`${[`${s(t,a)}:能力缺失`,`${s(a+1,o)}:弱项`,`${s(o+1,i)}:平均`,`${s(i+1,r)}:精英`,`${s(r+1,c)}:极限`,`${s(c+1,n)}:破格`].join(' | ')}。基准: 数值呈指数增长；分布呈长尾状(绝大多数聚集在${o+1}-${i}，${c+1}+呈断崖式稀缺)，依角色[身份背景]生成，当前值受[当前状态]修正。如:重伤→${s(t,a)}; 肾上腺素→${s(r+1,c)}`})(a,o),p=`[${a},${o}]`,f=s.length>0?`[${i},${r}]`:`[${Zt[0]},${Zt[1]}]`,g=`基础属性: "{基础属性}:{数值}"，数值范围${p}\n示例: "${c.length>0?c.map(([t,n])=>`${t}:${n}`).join('; '):'力量:35; 敏捷:50; 体质:52; 智力:35; 感知:40; 魅力:64'}"\n\n特有属性: 角色的特殊能力与技能，体现世界观特色与个体差异。\n格式: "{特有属性}:{数值}"，数值范围${f}，数值代表成功概率\n示例: "${s.length>0?s.map(([t,n])=>`${t}:${n}`).join('; '):Qt}"\n\n【属性标尺】\n${u}`;let m=!1;const b=(t,n)=>{t&&(t.includes('<属性规则>')||console.warn(`[DICE] ${n} 使用旧版模板格式，缺少 <属性规则> 标签。属性预设切换功能无法正常工作。请手动更新模板以添加 <属性规则>...</属性规则> 标签。`))};b(d.sheet_protagonist?.sourceData?.note,'主角信息表'),b(d.sheet_important_npc?.sourceData?.note,'重要人物表');const h=d.sheet_protagonist;if(h?.sourceData?.note){let t=h.sourceData.note;const n=t;t=nn(t,'属性规则',g),t!==n&&(h.sourceData.note=t,m=!0)}const v=d.sheet_important_npc;if(v?.sourceData?.note){let t=v.sourceData.note;const n=t;t=nn(t,'属性规则',g),t!==n&&(v.sourceData.note=t,m=!0)}m&&'function'==typeof l.importTemplateFromData?l.importTemplateFromData(d).then(n=>{n.success?console.log('[DICE] updateTemplateForActivePreset 已更新表格模板，预设:',t):console.error('[DICE] updateTemplateForActivePreset 保存模板失败:',n.message)}).catch(t=>{console.error('[DICE] updateTemplateForActivePreset 保存模板失败:',t)}):m?console.warn('[DICE] updateTemplateForActivePreset: importTemplateFromData 不可用，跳过保存'):console.log('[DICE] updateTemplateForActivePreset 无需更新（模板内容未变化），预设:',t)},an=[{format:'acu_action_preset_v1',version:Q,id:'__builtin_default__',name:'默认交互规则',builtin:!0,description:'基于表格类型的默认交互选项，包含地点、人物、物品、装备、技能、任务、势力等常用规则',rules:[{table_keywords:['地点','地图','Location','Map','世界','场所'],actions:[{label:'前往',template:'<user>前往{Name}。'},{label:'探索',template:'<user>探索{Name}。'},{label:'停留',template:'<user>在{Name}停留。'}]},{table_keywords:['人物','NPC','重要人物','角色','女主'],actions:[{label:'交谈',template:'<user>与{Name}交谈。'},{label:'观察',template:'<user>观察{Name}。'},{label:'战斗',template:'<user>与{Name}战斗。'}]},{table_keywords:['物品','背包','道具'],actions:[{label:'使用',template:'<user>使用了{Name}。'},{label:'查看',template:'<user>查看了{Name}。'},{label:'丢弃',template:'<user>丢弃了{Name}。'}]},{table_keywords:['装备','武器','防具'],actions:[{label:'装备',template:'<user>装备了{Name}。'},{label:'卸下',template:'<user>卸下了{Name}。'},{label:'卖出',template:'<user>卖出了{Name}。'}]},{table_keywords:['技能','能力'],actions:[{label:'使用',template:'<user>使用{Name}。'},{label:'练习',template:'<user>练习{Name}。'}]},{table_keywords:['备忘','任务','事项'],actions:[{label:'追踪',template:'<user>将{Name}设为当前追踪目标。'},{label:'整理',template:'<user>整理关于{Name}的信息。'},{label:'放弃',template:'<user>放弃了{Name}。'}]},{table_keywords:['势力','组织','阵营'],actions:[{label:'打探',template:'<user>打探{Name}的情报。'},{label:'加入',template:'<user>申请加入{Name}。'},{label:'合作',template:'<user>向{Name}请求合作。'}]}]}],on=(()=>{let t=null;return{getAllPresets(){if(t)return t;const n=fe.get(Y,[]);return t=[...an,...n],t},getPresetById(t){return this.getAllPresets().find(n=>n.id===t)||null},getActivePresetId(){const t=fe.get(W,'__builtin_default__');return null===t?'__builtin_default__':t},getActivePreset(){const t=this.getActivePresetId();return t&&'__none__'!==t?this.getPresetById(t):null},setActivePresetId(n){try{const e=''===n||null==n?'__none__':n;return fe.set(W,e),t=null,console.log('[DICE]ActionPresetManager 切换预设:',e),!0}catch(t){return console.error('[DICE]ActionPresetManager 设置预设失败:',t),!1}},createPreset(n){const e=fe.get(Y,[]),a={format:'acu_action_preset_v1',version:Q,...n,id:n.id||'custom_'+Date.now(),builtin:!1,createdAt:(new Date).toISOString()};return e.push(a),fe.set(Y,e),t=null,console.log('[DICE]ActionPresetManager 创建预设:',a.name),a},updatePreset(n,e){const a=fe.get(Y,[]),o=a.findIndex(t=>t.id===n);return!(o<0)&&(a[o]={...a[o],...e,version:Q},fe.set(Y,a),t=null,console.log('[DICE]ActionPresetManager 更新预设:',n),!0)},deletePreset(n){const e=fe.get(Y,[]),a=e.filter(t=>t.id!==n);return a.length!==e.length&&(fe.set(Y,a),t=null,fe.get(W)===n&&fe.set(W,null),console.log('[DICE]ActionPresetManager 删除预设:',n),!0)},exportPreset(t){const n=this.getPresetById(t);if(!n)return null;const e={format:'acu_action_preset_v1',version:Q,...n};return delete e.builtin,delete e.createdAt,JSON.stringify(e,null,2)},importPreset(t){try{const n=JSON.parse(t);if('acu_action_preset_v1'!==n.format)throw new Error('不支持的预设格式，需要 acu_action_preset_v1');if(!n.name||!n.rules||!Array.isArray(n.rules))throw new Error('预设数据不完整，需要 name 和 rules 字段');const e={...n,id:'imported_'+Date.now(),builtin:!1,version:Q,createdAt:(new Date).toISOString()};return this.createPreset(e)}catch(t){return console.error('[DICE]ActionPresetManager 导入失败:',t),null}},clearCache(){t=null}}})(),rn=()=>{const t=fe.get(G,null);return t?{...Z,...t}:{...Z}},cn=t=>{fe.set(G,t)},sn=()=>{const t=rn();if(!t.enabled)return!1;return 100*Math.random()<t.crazyLevel},ln=()=>{const t=rn(),n=Yn||pa();if(!n)return null;const e=_a(n||{}),a=yn.findTable(e,'player'),o=yn.findTable(e,'npc'),i=[];if(a?.data?.rows?.length>0){const n=zt()||'主角',e=Ue('<user>');i.push({name:n,attrs:e,isPlayer:!0,inScene:!0,weight:t.playerWeight})}if(o){yn.parseRows(o,'npc').forEach(n=>{if(!n.name)return;const e=String(n.inScene||'').toLowerCase(),a='true'===e||'在场'===e,o=Ue(n.name);i.push({name:n.name,attrs:o,isPlayer:!1,inScene:a,weight:a?t.inSceneNpcWeight:t.offSceneNpcWeight})})}return 0===i.length?null:(t=>{if(!t||0===t.length)return null;const n=t.reduce((t,n)=>t+(n.weight||1),0);let e=Math.random()*n;for(const n of t)if(e-=n.weight||1,e<=0)return n;return t[t.length-1]})(i)},dn=t=>{if(!t)return{name:'幸运',value:50};if(t.attrs&&t.attrs.length>0){const n=t.attrs[Math.floor(Math.random()*t.attrs.length)];return{name:n.name,value:n.value}}const n=Xt.getActivePreset();if(n){const t=[...n.baseAttributes||[],...n.specialAttributes||[]];if(t.length>0){const n=t[Math.floor(Math.random()*t.length)],e=n.range||[0,100],a=Math.floor((e[0]+e[1])/2);return{name:n.name,value:a}}}const e=je();if(e&&e.length>0){return{name:e[Math.floor(Math.random()*e.length)],value:50}}return{name:'幸运',value:50}},un=(t,n)=>{if(!t){const t=Math.floor(100*Math.random())+1;let e='失败';return t<=5?e='大成功':t>=96?e='大失败':t<=n&&(e='成功'),{roll:t,result:e,formula:'1d100'}}const e=t.diceExpression||'1d100',a=gn(e),o=a.total;if(t.outcomes&&t.outcomes.length>0){const i=t.id;if('dnd5e_check'===i){const t=Math.floor((n-10)/2),i=10,r=o+t;return a.rawDice&&20===a.rawDice[0]?{roll:o,result:'大成功',formula:e,total:r,dc:i,attrMod:t}:a.rawDice&&1===a.rawDice[0]?{roll:o,result:'大失败',formula:e,total:r,dc:i,attrMod:t}:r>=i?{roll:o,result:'成功',formula:e,total:r,dc:i,attrMod:t}:{roll:o,result:'失败',formula:e,total:r,dc:i,attrMod:t}}if('coc7_check'===i)return 1===o?{roll:o,result:'大成功',formula:e}:n<50&&o>=96||n>=50&&100===o?{roll:o,result:'大失败',formula:e}:o<=Math.floor(n/5)?{roll:o,result:'极难成功',formula:e}:o<=Math.floor(n/2)?{roll:o,result:'困难成功',formula:e}:o<=n?{roll:o,result:'成功',formula:e}:{roll:o,result:'失败',formula:e};if('fate_check'===i){const t=o+n,a=0;return t>=a+3?{roll:o,result:'大成功',formula:e,total:t}:t>=a?{roll:o,result:'成功',formula:e,total:t}:t>=a-2?{roll:o,result:'失败',formula:e,total:t}:{roll:o,result:'大失败',formula:e,total:t}}if('pbta_check'===i){const t=o+n;return t>=10?{roll:o,result:'完全成功',formula:e,total:t}:t>=7?{roll:o,result:'部分成功',formula:e,total:t}:{roll:o,result:'失败',formula:e,total:t}}}if(e.includes('d100')||e.includes('D100'))return o<=5?{roll:o,result:'大成功',formula:e}:o>=96?{roll:o,result:'大失败',formula:e}:o<=n?{roll:o,result:'成功',formula:e}:{roll:o,result:'失败',formula:e};if(e.includes('d20')||e.includes('D20')){return 20===o?{roll:o,result:'大成功',formula:e}:1===o?{roll:o,result:'大失败',formula:e}:o+n>=10?{roll:o,result:'成功',formula:e}:{roll:o,result:'失败',formula:e}}return o>=n?{roll:o,result:'成功',formula:e}:{roll:o,result:'失败',formula:e}},pn=()=>{const t=(t=>{if(t<50)return'normal';const n=t<=75?.3:.5;return Math.random()<n?'contest':'normal'})(rn().crazyLevel),n=Gt.getActivePreset();if('normal'===t){const t=ln();if(!t)return null;const e=dn(t),a=un(n,e.value);if(n){const o=n.name;return'dnd5e_check'===n.id&&void 0!==a.attrMod?`<meta:检定结果>\n元叙事：${t.name}发起了【${e.name}】检定(${o})，${a.formula}=${a.roll}，调整值${a.attrMod>=0?'+':''}${a.attrMod}，总计${a.total}，DC${a.dc}，【${a.result}】\n</meta:检定结果>`:void 0!==a.total?`<meta:检定结果>\n元叙事：${t.name}发起了【${e.name}】检定(${o})，${a.formula}=${a.roll}，总计${a.total}，【${a.result}】\n</meta:检定结果>`:`<meta:检定结果>\n元叙事：${t.name}发起了【${e.name}】检定(${o})，${a.formula}=${a.roll}，目标${e.value}，【${a.result}】\n</meta:检定结果>`}return`<meta:检定结果>\n元叙事：${t.name}发起了【${e.name}】检定，掷出${a.roll}，目标${e.value}，【${a.result}】\n</meta:检定结果>`}{const t=ln();if(!t)return null;let e=null;for(let n=0;n<5;n++){const n=ln();if(n&&n.name!==t.name){e=n;break}}if(!e){const e=dn(t),a=un(n,e.value);return n?`<meta:检定结果>\n元叙事：${t.name}发起了【${e.name}】检定(${n.name})，${a.formula}=${a.roll}，目标${e.value}，【${a.result}】\n</meta:检定结果>`:`<meta:检定结果>\n元叙事：${t.name}发起了【${e.name}】检定，掷出${a.roll}，目标${e.value}，【${a.result}】\n</meta:检定结果>`}const a=dn(t),o=dn(e),i=un(n,a.value),r=un(n,o.value),c=i.result,s=r.result;let l;if(!n||'dnd5e_check'!==n.id&&'pbta_check'!==n.id&&'fate_check'!==n.id){const n=a.value-i.roll,c=o.value-r.roll;l=n>c?`${t.name}胜出`:c>n?`${e.name}胜出`:'平局'}else{const n=void 0!==i.total?i.total:i.roll+a.value,c=void 0!==r.total?r.total:r.roll+o.value;l=n>c?`${t.name}胜出`:c>n?`${e.name}胜出`:'平局'}const d=n?`(${n.name})`:'';return`<meta:检定结果>\n元叙事：进行了一次【${t.name} ${a.name} vs ${e.name} ${o.name}】的对抗检定${d}。${t.name} ${a.name} (目标${a.value}) ${i.formula}=${i.roll}，判定为【${c}】；${e.name} ${o.name} (目标${o.value}) ${r.formula}=${r.roll}，判定为【${s}】。最终结果：【${l}】\n</meta:检定结果>`}},fn=t=>{const n=String(t),e=t=>Math.floor(Math.random()*t)+1,a=n.match(/^(\d*)d(\d+|F)([bp]\d+)?(r[o]?(?:[><!=]+)?\d*)?(!!?(?:[><!=]+\d+)?)?(kh\d+|kl\d+|dh\d+|dl\d+)?((?:[><!=]+)\d+)?$/i);if(!a)return{total:Number.NaN,rawDice:[],keptDice:[],formula:n,breakdown:n?`${n}=NaN`:'NaN',tags:[]};const[,o,i,r,c,s,l,d]=a,u=o?parseInt(o,10):1,p='F'===i.toUpperCase(),f=p?0:parseInt(i,10);let g=[];if(p)g=Array.from({length:u},()=>Math.floor(3*Math.random())-1);else{let t=null,n='=',a=1;if(c){const e=c.match(/^(r[o]?)([><!=]+)?(\d+)?$/i);e&&(t=e[1].toLowerCase(),e[2]&&(n=e[2]),e[3]?a=parseInt(e[3],10):e[2]||(a=1))}const o=e=>{if(!t)return!1;switch(n){case'>=':return e>=a;case'<=':return e<=a;case'=':case'==':default:return e===a;case'>':return e>a;case'<':return e<a;case'!=':case'<>':return e!==a}};let i=null,l='=',d=f;if(s){const t=s.match(/^(!!?)([><=!]+)?(\d+)?$/);t&&(i=t[1],t[2]&&(l=t[2]),t[3]&&(d=parseInt(t[3],10)))}const p=t=>{if(!i)return!1;switch(l){case'>=':return t>=d;case'<=':return t<=d;case'=':case'==':return t===d;case'>':return t>d;case'<':return t<d;case'!=':case'<>':return t!==d;default:return t===f}};let m=null,b=0;if(r&&100===f){const t=r.match(/^([bp])(\d+)$/i);t&&(m=t[1].toLowerCase(),b=parseInt(t[2],10))}for(let n=0;n<u;n++){let n=e(f);if(m){const t=n%10,e=[Math.floor((100===n?0:n)/10),...Array.from({length:b},()=>Math.floor(10*Math.random()))];let a;a='b'===m?Math.min(...e):Math.max(...e);const o=10*a+t;n=0===o?100:o}if(t){let a=0;for(;o(n)&&a<100&&(a++,n=e(f),'ro'!==t););}if(i){let t=n,a=n,o=0;for(;p(a)&&o<100;)o++,a=e(f),'!'===i?(g.push(t),t=a):t+=a;g.push(t)}else g.push(n)}}const m=[...g];let b=[...g];if(l){const t=l.toLowerCase(),n=parseInt(t.slice(2),10),e=[...b].sort((t,n)=>n-t);t.startsWith('kh')?b=e.slice(0,n):t.startsWith('kl')?b=e.slice(-n):t.startsWith('dh')?b=e.slice(n):t.startsWith('dl')&&(b=e.slice(0,-n))}let h=b.reduce((t,n)=>t+n,0);if(d){const t=d.match(/^([><!=]+)(\d+)$/);if(t){const n=t[1],e=parseInt(t[2],10),a=t=>{switch(n){case'>=':return t>=e;case'<=':return t<=e;case'=':case'==':return t===e;case'>':return t>e;case'<':return t<e;case'!=':case'<>':return t!==e;default:return!1}};h=b.filter(a).length}}const v=[];if(!p&&20===f){const t=b.length>0?b:m;t.some(t=>20===t)&&v.push('nat20'),t.some(t=>1===t)&&v.push('nat1')}const x=Number.isNaN(h)?'NaN':String(h),w=m.length>0?`[${m.join(',')}]`:'[]';return{total:h,rawDice:m,keptDice:b,formula:n,breakdown:1!==m.length||Boolean(l)||Boolean(d)?`${n}=${w}→${x}`:`${n}=${x}`,tags:v}},gn=t=>{const n=String(t).replace(/\s+/g,'');if(!n)return{total:Number.NaN,rawDice:[],keptDice:[],formula:'',breakdown:'NaN',tags:[]};const e=fn(n);if(!Number.isNaN(e.total))return e;const a=n.match(/[+-]?[^+-]+/g);if(!a)return{total:Number.NaN,rawDice:[],keptDice:[],formula:n,breakdown:`${n}=NaN`,tags:[]};let o=0;const i=[],r=[],c=[],s=[];for(const t of a){if(!t)continue;const e=t.startsWith('-')?-1:1,a=t.replace(/^[+-]/,'');if(!a)continue;const l=fn(a);if(!Number.isNaN(l.total)){o+=e*l.total,i.push(...l.rawDice),r.push(...l.keptDice),c.push(-1===e?`-${l.breakdown}`:c.length>0?`+${l.breakdown}`:l.breakdown),s.push(...l.tags);continue}const d=Number(a);if(!Number.isNaN(d)){o+=e*d;const t=e*d;c.push(t>=0&&c.length>0?`+${t}`:String(t));continue}return{total:Number.NaN,rawDice:[],keptDice:[],formula:n,breakdown:`${n}=NaN`,tags:[]}}return{total:o,rawDice:i,keptDice:r,formula:n,breakdown:`${c.join('')}=${o}`,tags:s}},mn=(t,n={})=>{if(!t)return 0;let e=String(t).trim();const a=Object.keys(n).sort((t,n)=>n.length-t.length);for(const t of a){const a=n[t];'number'!=typeof a||isNaN(a)||(e=e.split(t).join(`(${a})`))}if(e=e.replace(/\d*d(?:\d+|F)(?:[bp]\d+)?(?:r[o]?(?:[><!=]+)?\d*)?(?:!!?(?:[><!=]+\d+)?)?(?:kh\d+|kl\d+|dh\d+|dl\d+)?(?:(?:[><!=]+)\d+)?/gi,t=>{const n=fn(t);return Number.isNaN(n.total)?'0':String(n.total)}),!/^[\d\s+\-*/().]+$/.test(e))return console.warn('[DICE]evaluateFormula 公式包含非法字符:',t,'→',e),0;try{const t=new Function(`return (${e})`)();return Math.round(t)}catch(n){return console.error('[DICE]evaluateFormula 公式计算失败:',t,'→',e,n),0}},bn=(t,n={})=>{if(!t||'string'!=typeof t)return{success:!0,value:0};const e={abs:{minArgs:1,maxArgs:1,apply:t=>Math.abs(t[0])},floor:{minArgs:1,maxArgs:1,apply:t=>Math.floor(t[0])},min:{minArgs:2,maxArgs:Number.POSITIVE_INFINITY,apply:t=>Math.min(...t)},max:{minArgs:2,maxArgs:Number.POSITIVE_INFINITY,apply:t=>Math.max(...t)}};if(n&&n.$roll&&'object'==typeof n.$roll){const t=n.$roll;e['$roll.hastag']={minArgs:1,maxArgs:1,apply:n=>{const e=String(n[0]);return(t.tags??[]).includes(e)?1:0}}}function a(t){const n=t.match(/[^0-9+\-*/()><=!&| .]/g);if(n)return{success:!1,error:`包含非法字符: ${n.join('')}`};const e=[];let a=0;for(;a<t.length;){const n=t[a];if(/\s/.test(n)){a++;continue}if(/\d/.test(n)){let n='';for(;a<t.length&&/[\d.]/.test(t[a]);)n+=t[a++];e.push({type:'NUMBER',value:parseFloat(n)});continue}const o=t.substring(a,a+3);if(['===','!=='].includes(o)){e.push({type:'OPERATOR',value:o}),a+=3;continue}const i=t.substring(a,a+2);if(['>=','<=','==','!=','&&','||'].includes(i))e.push({type:'OPERATOR',value:i}),a+=2;else{if(!['+','-','*','/','%','>','<','(',')'].includes(n))return['=','!','&','|'].includes(n)?{success:!1,error:`语法错误: 孤立的操作符 "${n}"`}:{success:!1,error:`语法错误: 无法解析或孤立的字符 "${n}"`};if('-'===n||'+'===n){const o=e[e.length-1];if(!o||'OPERATOR'===o.type||'('===o.value){let o=n;for(a++;a<t.length&&/[\d.]/.test(t[a]);)o+=t[a++];if(o.length>1){e.push({type:'NUMBER',value:parseFloat(o)});continue}a--}}if('>'===n||'<'===n){if(t[a+1]===n)return{success:!1,error:`语法错误: 无法解析操作符 "${n}${n}"`}}e.push({type:'OPERATOR',value:n}),a++}}const o={'||':{prec:1,assoc:'L'},'&&':{prec:2,assoc:'L'},'==':{prec:3,assoc:'L'},'!=':{prec:3,assoc:'L'},'===':{prec:3,assoc:'L'},'!==':{prec:3,assoc:'L'},'>':{prec:4,assoc:'L'},'<':{prec:4,assoc:'L'},'>=':{prec:4,assoc:'L'},'<=':{prec:4,assoc:'L'},'+':{prec:5,assoc:'L'},'-':{prec:5,assoc:'L'},'*':{prec:6,assoc:'L'},'/':{prec:6,assoc:'L'},'%':{prec:6,assoc:'L'}},i=[],r=[];for(const t of e)if('NUMBER'===t.type)i.push(t);else if('('===t.value)r.push(t);else if(')'===t.value){for(;r.length>0&&'('!==r[r.length-1].value;)i.push(r.pop());if(0===r.length)return{success:!1,error:'括号不匹配'};r.pop()}else{const n=t.value;for(;r.length>0;){const t=r[r.length-1].value;if('('===t)break;if(!(o[t].prec>o[n].prec||o[t].prec===o[n].prec&&'L'===o[n].assoc))break;i.push(r.pop())}r.push(t)}for(;r.length>0;){const t=r.pop();if('('===t.value)return{success:!1,error:'括号不匹配'};i.push(t)}const c=[];for(const t of i)if('NUMBER'===t.type)c.push(t.value);else{const n=c.pop(),e=c.pop();let a;switch(t.value){case'+':a=e+n;break;case'-':a=e-n;break;case'*':a=e*n;break;case'/':a=e/n;break;case'%':a=e%n;break;case'>':a=e>n;break;case'<':a=e<n;break;case'>=':a=e>=n;break;case'<=':a=e<=n;break;case'==':a=e==n;break;case'!=':a=e!=n;break;case'===':a=e===n;break;case'!==':a=e!==n;break;case'&&':a=e&&n?1:0;break;case'||':a=e||n?1:0;break;default:return{success:!1,error:`未知操作符: ${t.value}`}}c.push(a)}return 1!==c.length?{success:!1,error:'无效的表达式'}:{success:!0,value:c[0]}}function o(t){const n=String(t);return t<0?`(0${n})`:`(${n})`}function i(t){const n=[];let e=0,a=0,o=!1;for(let i=0;i<t.length;i++){const r=t[i];'"'!==r&&'\''!==r||(o=!o),o||('('===r?e++:')'===r?e--:','===r&&0===e&&(n.push(t.slice(a,i).trim()),a=i+1))}return n.push(t.slice(a).trim()),n}function r(t,n){let e=0;for(let a=n;a<t.length;a++){const n=t[a];if('('===n&&e++,')'===n&&(e--,0===e))return a}return-1}function c(t){const e=t.trim();if(!e)return{success:!1,error:'函数参数不能为空'};if(e.startsWith('"')&&e.endsWith('"')||e.startsWith('\''))return{success:!0,value:e.slice(1,-1)};let o=e;o=o.replace(/\$[a-zA-Z_]\w*/g,t=>{const e=n[t];return'number'!=typeof e||isNaN(e)?'0':String(e)});const i=s(o);if(!i.success||void 0===i.expr)return{success:!1,error:i.error??'函数参数解析失败'};if(/\d*d(?:\d+|F)/i.test(i.expr)){const t=mn(i.expr,n);if('number'==typeof t&&Number.isFinite(t))return{success:!0,value:t}}const r=a(i.expr);if(!r.success||void 0===r.value)return{success:!1,error:r.error??'函数参数计算失败'};const c='boolean'==typeof r.value?r.value?1:0:r.value;return'number'!=typeof c||Number.isNaN(c)?{success:!1,error:'函数参数不是有效数字'}:{success:!0,value:c}}function s(t){let n='',a=0;const s=t=>/[a-zA-Z_]/.test(t),l=t=>/[a-zA-Z0-9_]/.test(t);for(;a<t.length;){const d=t[a];if(s(d)){let s=d;for(a++;a<t.length&&(l(t[a])||'.'===t[a]);)s+=t[a],a++;const u=s.toLowerCase();if('true'===u){n+='1';continue}if('false'===u){n+='0';continue}let p=a;for(;p<t.length&&/\s/.test(t[p]);)p++;if('('!==t[p])return{success:!1,error:`未知函数或标识符: ${s}`};const f=r(t,p);if(-1===f)return{success:!1,error:'括号不匹配'};const g=i(t.slice(p+1,f)),m=s.toLowerCase(),b=e[m];if(!b)return{success:!1,error:`不支持的函数: ${s}`};if(g.length<b.minArgs||g.length>b.maxArgs)return{success:!1,error:`函数 ${s} 参数数量不合法`};const h=[];for(const t of g){if(!t)return{success:!1,error:`函数 ${s} 参数不能为空`};const n=c(t);if(!n.success||void 0===n.value)return{success:!1,error:n.error??`函数 ${s} 参数计算失败`};h.push(n.value)}const v=b.apply(h);if(!Number.isFinite(v))return{success:!1,error:`函数 ${s} 结果无效`};n+=o(v),a=f+1;continue}n+=d,a++}return{success:!0,expr:n}}if(n&&n.$roll&&'object'==typeof n.$roll){const e=n.$roll;t=(t=t.replace(/\$roll\.total/g,String(e.total))).replace(/\$roll\.hasTag\s*\(\s*['"]([^'"]+)['"]\s*\)/gi,(t,n)=>(e.tags??[]).includes(n)?'1':'0')}let l=t.trim().replace(/\$[a-zA-Z_]\w*/g,t=>{const e=n[t];return'number'!=typeof e||isNaN(e)?'0':String(e)});const d=s(l);return d.success&&void 0!==d.expr?(l=d.expr,a(l)):{success:!1,error:d.error??'函数解析失败'}},hn=(t,n)=>{if(!t||0===t.length)return console.warn('[DICE] outcomes 数组为空,使用默认判定'),{id:'default',name:'判定结果',condition:'true',priority:99};const e=[...t].sort((t,n)=>t.priority-n.priority);for(const t of e)try{const e=bn(t.condition,n);if(!e.success){e.error&&console.warn(`[DICE] outcome "${t.name}" 条件评估失败:`,e.error);continue}if('number'==typeof e.value?0!==e.value:Boolean(e.value))return t}catch(n){console.warn(`[DICE] outcome "${t.name}" 条件评估失败:`,n);continue}return e[e.length-1]},vn=(t,n)=>{const e=new Set;let a=t.replace(/\$([a-zA-Z_]\w*\.[a-zA-Z_]\w*)/g,t=>{const a=t.slice(1),o=n[a];return null==o?(e.has(a)||(e.add(a),console.warn(`[DICE] formatOutputTemplate: 未定义变量 $${a}`)),''):String(o)});return a=a.replace(/\$([a-zA-Z_]\w*)(?=\W|$)/g,t=>{const a=t.slice(1),o=n[a];return null==o?(e.has(a)||(e.add(a),console.warn(`[DICE] formatOutputTemplate: 未定义变量 $${a}`)),''):String(o)}),a.replace(/\n\s*\n/g,'\n')},xn=(t,n,e)=>{let a=mn(t,e);return n&&Array.isArray(n)&&2===n.length&&(a=Math.max(n[0],Math.min(n[1],a))),a},wn={global:{tableKeywords:['全局数据表','全局数据','全局'],columns:{detailLocation:{keywords:['当前详细地点','详细地点','具体位置','当前位置'],fallbackIndex:null},currentLocation:{keywords:['当前次要地区','当前所在地点','当前地点','所在地点'],fallbackIndex:2}}},player:{tableKeywords:['主角信息','主角','玩家','角色信息','player','用户','user','<user>'],columns:{name:{keywords:['姓名','名称','人物名称','name'],fallbackIndex:1},status:{keywords:['状态关键词','状态关键字','状态标签','状态'],fallbackIndex:null},position:{keywords:['具体位置','位置','所在地'],fallbackIndex:null},attrs:{keywords:['基础属性','属性'],fallbackIndex:null,isMultiple:!0},money:{keywords:['金钱','资金','金币','货币','余额','灵石','积分','代币','信用点'],fallbackIndex:null},resources:{keywords:['资源数据','资源','resources'],fallbackIndex:null}}},location:{tableKeywords:['世界地图点','地图点','地图','地点','地点表','地图表','场景','区域','秘境','副本','洞府','空间','位面','界域'],columns:{name:{keywords:['详细地点','具体位置','当前地点','次要地区','主要地区','地区','地点名','名称'],fallbackIndex:1},description:{keywords:['环境描述','描述','说明','介绍','氛围描述'],fallbackIndex:null}}},npc:{tableKeywords:['重要人物表','重要人物','NPC','人物表','人物','角色表','角色','character','弟子','成员','队友','伙伴','宠物','灵宠'],columns:{name:{keywords:['姓名','名称'],fallbackIndex:1},status:{keywords:['自身状态','状态'],fallbackIndex:null},position:{keywords:['具体位置','位置','所在地点','所在'],fallbackIndex:null},inScene:{keywords:['在场状态','在场','是否离场','离场'],fallbackIndex:null}}},quest:{tableKeywords:['任务表','备忘事项','任务','事项','目标','待办','主线','支线','委托','悬赏'],columns:{name:{keywords:['事项名称','任务名','名称'],fallbackIndex:1},type:{keywords:['类型','分类','事项类型'],fallbackIndex:2},progress:{keywords:['进度','完成度','进度/结果'],fallbackIndex:5},status:{keywords:['状态'],fallbackIndex:6}},filters:{active:{column:'status',includes:['活跃','进行中','进行'],excludeColumn:'type',excludes:['规则']}}},bag:{tableKeywords:['背包物品','背包','物品','道具','库存','储物袋','空间戒指','持有物品表'],columns:{name:{keywords:['物品名称','名称','物品名'],fallbackIndex:1},type:{keywords:['类型','分类','物品类型'],fallbackIndex:2},count:{keywords:['数量','个数','持有数'],fallbackIndex:3}}},skill:{tableKeywords:['主角技能','技能表','技能','能力','魔法','超能力','异能','神通','道法','功法','血脉','天赋','义体改造','超凡能力','词条'],columns:{name:{keywords:['技能名称','名称','技能名'],fallbackIndex:1},type:{keywords:['类型','分类'],fallbackIndex:2},level:{keywords:['等级','级别','熟练度','lv'],fallbackIndex:3}}},equip:{tableKeywords:['装备表','装备','武器','防具','法宝','灵器','仙器','神器','义体','神装'],columns:{name:{keywords:['装备名称','名称','装备名'],fallbackIndex:1},type:{keywords:['类型','分类'],fallbackIndex:2},part:{keywords:['部位','装备部位','位置'],fallbackIndex:3},isEquipped:{keywords:['状态','是否装备','装备状态','装备中'],fallbackIndex:4}},filters:{equipped:{column:'isEquipped',includes:['已装备','装备中','true','是','yes','equipped']}}}},yn={findTable(t,n){const e=wn[n];if(!e)return console.info(`[DICE]仪表盘查找表格: 模块"${n}"配置不存在`),null;for(const a of e.tableKeywords)for(const o in t)if(o.includes(a))return console.info(`[DICE]仪表盘查找表格: 模块"${n}"找到表格"${o}" (关键词: "${a}")`),{data:t[o],name:o,key:t[o].key,config:e};return console.info(`[DICE]仪表盘查找表格: 模块"${n}"未找到匹配表格 (关键词: ${e.tableKeywords.join(', ')})`),null},findColumnIndex(t,n,e){const a=e.columns[n];if(!a)return-1;for(let n=0;n<t.length;n++){const e=String(t[n]||'').toLowerCase();if(a.keywords.some(t=>e.includes(t.toLowerCase())))return n}return a.fallbackIndex??-1},getValue(t,n,e,a){const o=this.findColumnIndex(n,e,a);return o<0||o>=t.length?null:t[o]},getColumnMap(t,n){const e=wn[n];if(!e)return{};const a={};for(const n in e.columns)a[n]=this.findColumnIndex(t,n,e);return a},parseRows(t,n){if(!t||!t.data)return console.info(`[DICE]仪表盘解析数据: 模块"${n}"无数据，跳过解析`),[];const{data:e,config:a}=t,o=e.headers||[],i=e.rows||[],r=this.getColumnMap(o,n),c=i.map((t,n)=>{const e={_rowIndex:n,_raw:t};for(const n in r){const a=r[n];e[n]=a>=0&&a<t.length?t[a]:null}return e});return console.info(`[DICE]仪表盘解析数据: 模块"${n}"解析完成，共${c.length}行`),c},applyFilter(t,n,e){const a=wn[e];if(!a||!a.filters||!a.filters[n])return t;const o=a.filters[n];return t.some(t=>null!==t[o.column]&&void 0!==t[o.column])?t.filter(t=>{const n=String(t[o.column]||'').toLowerCase(),e=o.includes.some(t=>n.includes(t.toLowerCase()));if(o.excludeColumn&&o.excludes){const n=String(t[o.excludeColumn]||'').toLowerCase(),a=o.excludes.some(t=>n.includes(t.toLowerCase()));return e&&!a}return e}):t}},$n={enabled:!0,diceSystem:'1d100',showDiceIcon:!0,autoSendPrompt:!0,action_groups:[{table_keywords:['地点','地图','Location','Map','世界','场所'],actions:[{label:'前往',icon:'fa-walking',type:'prompt',template:'<user>前往{Name}。',auto_send:!0},{label:'探索',icon:'fa-search',type:'prompt',template:'<user>探索{Name}。',auto_send:!0},{label:'停留',icon:'fa-clock',type:'prompt',template:'<user>在{Name}停留。',auto_send:!0}]},{table_keywords:['人物','NPC','重要人物','角色','女主'],actions:[{label:'交谈',icon:'fa-comments',type:'prompt',template:'<user>与{Name}交谈。',auto_send:!0},{label:'观察',icon:'fa-eye',type:'prompt',template:'<user>观察{Name}。',auto_send:!0},{label:'战斗',icon:'fa-hand-fist',type:'prompt',template:'<user>与{Name}战斗。',auto_send:!0}]},{table_keywords:['物品','背包','道具'],actions:[{label:'使用',icon:'fa-hand-pointer',type:'prompt',template:'<user>使用了{Name}。',auto_send:!0},{label:'查看',icon:'fa-eye',type:'prompt',template:'<user>查看了{Name}。',auto_send:!0},{label:'丢弃',icon:'fa-trash',type:'prompt',template:'<user>丢弃了{Name}。',auto_send:!0}]},{table_keywords:['装备','武器','防具'],actions:[{label:'装备',icon:'fa-shield-halved',type:'prompt',template:'<user>装备了{Name}。',auto_send:!0},{label:'卸下',icon:'fa-circle-xmark',type:'prompt',template:'<user>卸下了{Name}。',auto_send:!0},{label:'卖出',icon:'fa-coins',type:'prompt',template:'<user>卖出了{Name}。',auto_send:!0}]},{table_keywords:['技能','能力'],actions:[{label:'使用',icon:'fa-wand-magic-sparkles',type:'skill_check',template:'<user>使用{Name}。',auto_send:!0},{label:'练习',icon:'fa-dumbbell',type:'prompt',template:'<user>练习{Name}。',auto_send:!0}]},{table_keywords:['备忘','任务','事项'],actions:[{label:'追踪',icon:'fa-crosshairs',type:'prompt',template:'<user>将{Name}设为当前追踪目标。',auto_send:!0},{label:'整理',icon:'fa-list-check',type:'prompt',template:'<user>整理关于{Name}的信息。',auto_send:!0},{label:'放弃',icon:'fa-circle-xmark',type:'prompt',template:'<user>放弃了{Name}。',auto_send:!0}]},{table_keywords:['势力','组织','阵营'],actions:[{label:'打探',icon:'fa-ear-listen',type:'prompt',template:'<user>打探{Name}的情报。',auto_send:!0},{label:'加入',icon:'fa-user-plus',type:'prompt',template:'<user>申请加入{Name}。',auto_send:!0},{label:'合作',icon:'fa-handshake',type:'prompt',template:'<user>向{Name}请求合作。',auto_send:!0}]}]},kn=t=>{const n={critSuccess:'acu-result-badge acu-result-badge-crit-success',extremeSuccess:'acu-result-badge acu-result-badge-extreme-success',success:'acu-result-badge acu-result-badge-success',warning:'acu-result-badge acu-result-badge-warning',failure:'acu-result-badge acu-result-badge-failure',critFailure:'acu-result-badge acu-result-badge-crit-failure'};return n[t]||n.failure},_n={战斗:'fa-hand-fist',攻击:'fa-hand-fist',防御:'fa-shield',逃跑:'fa-person-running',交谈:'fa-comments',对话:'fa-comments',告别:'fa-hand',求爱:'fa-heart',邀约:'fa-calendar-check',赠送:'fa-gift',送礼:'fa-gift',观察:'fa-eye',查看:'fa-eye',检查:'fa-magnifying-glass',使用:'fa-hand-pointer',丢弃:'fa-trash',装备:'fa-shield-halved',卸下:'fa-circle-xmark',卖出:'fa-coins',购买:'fa-shopping-cart',前往:'fa-walking',探索:'fa-search',停留:'fa-clock',离开:'fa-door-open',练习:'fa-dumbbell',施展:'fa-wand-magic-sparkles',凝练:'fa-fire',追踪:'fa-crosshairs',整理:'fa-list-check',放弃:'fa-circle-xmark',完成:'fa-check',打探:'fa-ear-listen',加入:'fa-user-plus',合作:'fa-handshake',表演:'fa-music',演奏:'fa-guitar',唱歌:'fa-microphone'},Cn=t=>{const n=(()=>{const t=fe.get('acu_gm_engine_config_v1',$n);if('__none__'===on.getActivePresetId())return{...t,action_rules_disabled:!0};const n=on.getActivePreset();if(n&&n.rules&&n.rules.length>0){const e=n.rules.map(t=>({table_keywords:t.table_keywords||[],actions:(t.actions||[]).map(t=>({label:t.label,icon:t.icon||_n[t.label]||'fa-circle',type:'prompt',template:t.template||`<user>对{Name}执行互动:${t.label}。`,auto_send:!1}))}));return{...t,custom_action_groups:e}}return t})();if(!n.enabled)return[];if(n.action_rules_disabled)return[];const e=t.toLowerCase(),a=n.custom_action_groups||[];for(const t of a){if(t.table_keywords.some(t=>e.includes(t.toLowerCase())))return[...t.actions||[]]}const o=n.action_groups||[];for(const t of o){if(t.table_keywords.some(t=>e.includes(t.toLowerCase())))return[...t.actions||[]]}return[]},En=(t,n,e)=>{const a=[...Cn(t)],o=n.findIndex(t=>t&&String(t).includes('交互'));if(o<0||!e[o])return a;const i=['-','null','none','无','空','n/a','undefined','/'],r=String(e[o]).trim();if(!r||i.includes(r.toLowerCase()))return a;const c=r.split(/[,，、;；]/).map(t=>t.trim()).filter(t=>t&&!i.includes(t.toLowerCase()));if(0===c.length)return a;const s=a.map(t=>t.label.toLowerCase()),l=c.filter(t=>!s.includes(t.toLowerCase())).map(t=>({label:t,icon:_n[t]||'fa-hand-pointer',type:'prompt',template:`<user>对{Name}执行互动:${t}。`,auto_send:!0}));return[...a,...l]},An=t=>{if(null==t||''===t)return!1;const n=String(t).trim();return/^-?\d+(\.\d+)?%?$/.test(n)||/^\d+\/\d+$/.test(n)||/^[\u4e00-\u9fa5a-zA-Z]+[:\s：]\s*\d+/i.test(n)||/\d+/.test(n)},Sn=t=>{if(!t)return 0;const n=String(t).trim();if(/^\d+\/\d+$/.test(n))return parseInt(n.split('/')[0],10);if(n.endsWith('%'))return parseInt(n.replace('%',''),10);const e=n.match(/\d+/g);return e&&e.length>0?parseInt(e[e.length-1],10):0},In=t=>{if(!t)return[];const n=[],e=String(t).trim();if(e.startsWith('{')&&e.endsWith('}'))try{const t=JSON.parse(e);for(const e in t){const a=t[e];'number'==typeof a?n.push({name:e,value:a}):'string'==typeof a&&/^\d+$/.test(a)&&n.push({name:e,value:parseInt(a,10)})}if(n.length>0)return n}catch(t){}const a=e.split(/[,;，；\s]+/);for(const t of a){const e=t.match(/^"?([\u4e00-\u9fa5a-zA-Z_]+)"?[:\s：]\s*"?(-?\d+)"?/);e&&n.push({name:e[1],value:parseInt(e[2],10)})}return n},Dn=t=>{if(!t)return[];const n=[],e=String(t).trim().split(/[;；]/);for(const t of e){const e=t.trim();if(!e)continue;const a=e.match(/^与?(.+?)[:：](.+)$/);if(a){const t=a[1].trim(),e=a[2].trim();if(t&&e){n.push({name:t,relation:e});continue}}const o=e.match(/^([^(（]+)[(（]([^)）]+)[)）]$/);o?n.push({name:o[1].trim(),relation:o[2].trim()}):e.length>0&&n.push({name:e,relation:''})}return n},Mn=(t,n)=>{if(!t)return!1;const e=String(t).trim(),a=(n||'').toLowerCase();return!(!a.includes('关系')&&!a.includes('人际'))||/^[^(（;；]+[(（][^)）]+[)）]([;；][^(（;；]+[(（][^)）]+[)）])*$/.test(e)},zn=(t,n,e)=>{if(!t||!n)return t;let a=t;const o=n[1]||'未知';return a=a.replace(/\{Name\}/gi,o),a=a.replace(/\{RowIndex\}/gi,n[0]||'0'),e&&e.length>0&&e.forEach((t,e)=>{if(t&&e<n.length){const o=n[e]||'未知',i=new RegExp(`\\{${t}\\}`,'gi');a=a.replace(i,o)}}),a=a.replace(/\{[^}]+\}/g,'未知'),a},Tn=[{id:'acu-btn-open-editor',icon:'fa-database',title:'打开神-数据库'},{id:'acu-btn-open-visualizer',icon:'fa-table-columns',title:'打开可视化表格编辑'},{id:'acu-btn-collapse',icon:'fa-chevron-down',title:'收起面板'},{id:'acu-btn-refill',icon:'fa-bolt',title:'重新填表'},{id:'acu-btn-settings',icon:'fa-cog',title:'全能设置'}];let Nn=!1,Fn=!1,Pn=Promise.resolve(),jn=!1,Rn=!1;const Bn=[],On=(t,n)=>{Bn.push({name:t,show:n})},Vn=()=>{Bn.pop();const t=Bn.pop();return!!t&&(t.show(),!0)};let Ln=new Set,Un=null,qn=null,Yn=null,Wn=!1,Jn={};const Hn=()=>Jn;let Xn=!1,Kn={},Gn={},Zn=null,Qn=!1;const te='acu_scroll_v19_fixed';let ne={};try{const t=localStorage.getItem(te);t&&(ne=JSON.parse(t))}catch(t){console.warn('[DICE]ACU Error:',t)}const ee={_lastValidationCount:0,_isRollingBack:!1,handleUpdate:()=>{if(!ee._isRollingBack){try{const t=ke(),n=pa();if(t&&n){const e=yt.getEnabledRules(),a=Ct.checkTableRules(t,n,e);if(a.length>0){console.warn('[DICE]ACU 规则拦截触发，执行回滚:',a),ee._isRollingBack=!0;const n=le().getDB();if(n?.fillTable)try{n.fillTable(t),window.toastr&&window.toastr.error(a[0].message,'已回滚',{timeOut:5e3,positionClass:'toast-bottom-right'})}catch(t){console.error('[DICE]ACU fillTable 回滚失败:',t),window.toastr&&window.toastr.error(`规则拦截: ${a[0].message}（回滚操作失败，请手动刷新）`,'错误',{timeOut:7e3,positionClass:'toast-bottom-right'})}return void setTimeout(()=>{ee._isRollingBack=!1},500)}}}catch(t){console.error('[DICE]ACU 拦截检查失败:',t)}mo(),setTimeout(()=>{try{const t=Yn||pa();if(t){const n=Ct.validateAllData(t).length;ee._lastValidationCount,ee._lastValidationCount=n,ae(n)}}catch(t){console.error('[DICE]ACU 验证执行失败:',t)}},100)}}},ae=t=>{const{$}=le(),n=$('.acu-validation-indicator');t>0?n.length&&(n.find('.acu-validation-count').text(t),n.show()):n.hide()},oe=()=>{try{if('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId)return SillyTavern.getCurrentChatId();if('undefined'!=typeof SillyTavern&&SillyTavern.chatId)return SillyTavern.chatId;if(window.parent?.SillyTavern?.getCurrentChatId)return window.parent.SillyTavern.getCurrentChatId()}catch(t){console.warn('[DICE]ACU getCurrentContextFingerprint error:',t)}return'unknown_context'},ie={layout:'horizontal',collapseStyle:'bar',collapseAlign:'right',fontFamily:'default',theme:'retro',cardWidth:260,fontSize:13,highlightNew:!0,itemsPerPage:50,actionsPosition:'bottom',gridColumns:'auto',positionMode:'fixed',showOptionPanel:!0,clickOptionToAutoSend:!0,optionFontSize:12,muteDatabaseToasts:!1},re=[{id:'default',name:'系统默认 (Modern)',val:'\'Segoe UI\', \'Microsoft YaHei\', sans-serif'},{id:'hanchan',name:'寒蝉全圆体',val:'"寒蝉全圆体", sans-serif'},{id:'maple',name:'Maple Mono (代码风)',val:'"Maple Mono NF CN", monospace'},{id:'huiwen',name:'汇文明朝体 (Huiwen)',val:'"Huiwen-mincho", serif'},{id:'cooper',name:'Cooper正楷',val:'"CooperZhengKai", serif'},{id:'yffyt',name:'YFFYT (艺术体)',val:'"YFFYT", sans-serif'},{id:'fusion',name:'Fusion Pixel (像素风)',val:'"Fusion Pixel 12px M latin", monospace'},{id:'wenkai',name:'霞鹜文楷 (WenKai)',val:'"LXGW WenKai", serif'},{id:'notosans',name:'思源黑体 (Noto Sans)',val:'"Noto Sans CJK", sans-serif'},{id:'zhuque',name:'朱雀仿宋 (Zhuque)',val:'"Zhuque Fangsong (technical preview)", serif'}],ce=[{id:'retro',name:'复古羊皮 (Retro)',icon:'fa-scroll'},{id:'dark',name:'极夜深空 (Dark)',icon:'fa-moon'},{id:'modern',name:'现代清爽 (Modern)',icon:'fa-sun'},{id:'forest',name:'森之物语 (Forest)',icon:'fa-tree'},{id:'ocean',name:'深海幽蓝 (Ocean)',icon:'fa-water'},{id:'cyber',name:'赛博霓虹 (Cyber)',icon:'fa-bolt'},{id:'nightowl',name:'深蓝磨砂 (Night Owl)',icon:'fa-feather'},{id:'sakura',name:'暖粉手账 (Warm Pink)',icon:'fa-heart'},{id:'minepink',name:'量产地雷 (Mine Pink)',icon:'fa-skull'},{id:'galgame',name:'粉梦物语 (Galgame Pink)',icon:'fa-heart'},{id:'purple',name:'紫罗兰梦 (Purple)',icon:'fa-gem'},{id:'wechat',name:'绿色泡泡 (Green Bubble)',icon:'fa-weixin'},{id:'educational',name:'学习资料 (Educational)',icon:'fa-book'},{id:'vaporwave',name:'霓虹怀旧 (Vaporwave)',icon:'fa-palette'},{id:'classicpackaging',name:'经典包装 (Classic Packaging)',icon:'fa-box'},{id:'terminal',name:'终端绿屏 (Terminal)',icon:'fa-terminal'},{id:'dreamcore',name:'梦核迷离 (Dreamcore)',icon:'fa-cloud-moon'},{id:'aurora',name:'极光幻境 (Aurora)',icon:'fa-snowflake'},{id:'chouten',name:'幻夜霓虹 (Cyber Kawaii)',icon:'fa-star'}];let se=null;const le=()=>{const t=window.parent||window,$=window.jQuery||t.jQuery;if(se&&se.$)return se;const n={$,getDB:()=>t.AutoCardUpdaterAPI||window.AutoCardUpdaterAPI,clipboard:t.navigator.clipboard,ST:window.SillyTavern||t.SillyTavern||(()=>{try{return window.top?window.top.SillyTavern:null}catch(t){return null}})()};return $&&(se=n),n},de=()=>{const{$}=le(),t=$('#acu-btn-save-global'),n=t.find('i'),e=Hn();let a=!1;if(e)for(const t in e)if(e[t]&&e[t].length>0){a=!0;break}Wn||a?(n.addClass('acu-icon-breathe'),t.attr('title','你有未保存的手动修改或删除操作')):(n.removeClass('acu-icon-breathe'),t.attr('title','保存'),t.css('color',''))},ue=t=>{if(!t)return'fa-table';const n=t.toLowerCase();return n.includes('主角')||n.includes('角色')?'fa-user-circle':n.includes('通用')||n.includes('全局')?'fa-globe-asia':n.includes('装备')||n.includes('背包')?'fa-briefcase':n.includes('技能')||n.includes('武魂')?'fa-dragon':n.includes('关系')||n.includes('周边')?'fa-user-friends':n.includes('任务')||n.includes('日志')?'fa-scroll':n.includes('人物')||n.includes('关键人物')?'fa-address-book':n.includes('总结')||n.includes('大纲')?'fa-book-reader':n.includes('地图点')||n.includes('世界地图')?'fa-map-location-dot':n.includes('地图元素')||n.includes('机关')||n.includes('线索')?'fa-bullseye':n.includes('势力')||n.includes('阵营')?'fa-shield-halved':n.includes('物品')?'fa-gem':n.includes('情报')||n.includes('信息')?'fa-file-lines':n.includes('选项')?'fa-list-check':'fa-table'},pe=t=>{if(!t)return'';const n=String(t).trim();return/^[0-9]+%?$/.test(n)||/^Lv\.\d+$/.test(n)?'acu-badge-green':n.length<=6&&!n.includes('http')||['是','否','有','无','死亡','存活'].includes(n)?'acu-badge-neutral':''},fe={get:(t,n=null)=>{try{return JSON.parse(localStorage.getItem(t))??n}catch{return n}},set:(t,n)=>{try{localStorage.setItem(t,JSON.stringify(n))}catch(e){if('QuotaExceededError'===e.name||e.message.includes('quota')){console.warn('[DICE]ACU 存储空间已满，触发静默清理策略...');try{localStorage.removeItem(M),localStorage.setItem(t,JSON.stringify(n))}catch(t){console.error('[DICE]ACU Store 清理后依然失败',t),window.toastr&&!window._acuQuotaAlerted&&(window.toastr.warning('⚠️ 浏览器存储空间严重不足，配置保存失败'),window._acuQuotaAlerted=!0,setTimeout(()=>window._acuQuotaAlerted=!1,1e4))}}else console.error('[DICE]ACU Store',e)}}},ge=()=>fe.get(I),me=t=>fe.set(I,t),be=()=>{fe.set(F,!1),fe.set('acu_changes_panel_active',!1),fe.set('acu_favorites_panel_active',!1),me(null)};function he(){return ge()===Lt.MODULE_ID&&(!fe.get('acu_changes_panel_active',!1)&&(!fe.get('acu_favorites_panel_active',!1)&&!fe.get(F,!1)))}const ve=()=>fe.get(S),xe=t=>fe.set(S,t),we=()=>fe.get(T,!1),ye=t=>fe.set(T,t),$e=()=>fe.get(N,!1),ke=()=>{const t=fe.get(M);if(!t)return null;const n=oe();return t._contextId&&t._contextId!==n?null:t},_e=t=>{t&&('object'==typeof t&&(t._contextId=oe()),fe.set(M,t))},Ce=()=>fe.get(P,{}),Ee=t=>fe.set(P,t),Ae=()=>fe.get(j,{}),Se=()=>fe.get(R,[]),Ie=()=>fe.get(B,[]),De=t=>{const n=Ie(),e=n.indexOf(t);var a;e>=0?n.splice(e,1):n.push(t),a=n,fe.set(B,a),console.log('[DICE]ACU toggleTableReverse:',t,'reversed:',e<0)},Me=t=>{const n=Yn||pa();if(!n)return[];const e=!t||'<user>'===t||''===t.trim();for(const a in n){const o=n[a];if(!o||!o.name||!o.content)continue;const i=o.name;if(e&&(i.includes('主角')||i.includes('玩家')||i.toLowerCase().includes('player'))&&o.content[1]){const t=o.content[0]||[],n=o.content[1];let e=[];if(t.forEach((t,a)=>{if(t&&t.includes('属性')){In(n[a]||'').forEach(t=>{e.includes(t.name)||e.push(t.name)})}}),e.length>0)return e}if(!e&&(i.includes('人物')||i.includes('NPC')||i.includes('角色')||i.toLowerCase().includes('character'))){const n=o.content[0]||[];let e=1;for(let t=0;t<n.length;t++)if(n[t]&&(n[t].includes('姓名')||n[t].includes('名称')||n[t].toLowerCase().includes('name'))){e=t;break}for(let a=1;a<o.content.length;a++){const i=o.content[a];if(i&&i[e]===t){let t=[];return n.forEach((n,e)=>{if(n&&n.includes('属性')){In(i[e]||'').forEach(n=>{t.includes(n.name)||t.push(n.name)})}}),t}}}}return[]},ze=t=>t?String(t).trim().toLowerCase().replace(/[\s_:\-：]/g,'').replace(/值$/u,''):'',Te=(t,n,e=[])=>{const a=Ue(t).map(t=>t.name).filter(Boolean);if(0===a.length)return{name:n||null};const o=[n,...e].map(t=>String(t||'').trim()).filter(Boolean).filter((t,n,e)=>e.indexOf(t)===n);if(0===o.length)return{name:null,reason:'目标属性名为空'};for(const t of o)if(a.includes(t))return{name:t};const i=new Map;a.forEach(t=>{const n=t.toLowerCase();i.has(n)||i.set(n,t)});for(const t of o){const n=i.get(t.toLowerCase());if(n)return{name:n}}const r=new Map;a.forEach(t=>{const n=ze(t);if(!n)return;const e=r.get(n)||[];e.push(t),r.set(n,e)});for(const t of o){const n=ze(t);if(!n)continue;const e=r.get(n)||[];if(1===e.length)return{name:e[0]};if(e.length>1)return{name:null,reason:`属性别名冲突: ${t} 可匹配 ${e.join(', ')}`}}return{name:null,reason:`找不到属性: ${n}`}},Ne=(t,n)=>{const e=ze(t),a=ze(n);return Boolean(e)&&Boolean(a)&&e===a},Fe=(t,n,e=[])=>{const a=Yn||pa();if(!a||!n)return null;const o=!t||'<user>'===t||''===t.trim(),i=Te(t,n,e);if(!i.name)return null;const r=i.name;for(const n in a){const e=a[n];if(!e||!e.name||!e.content)continue;const i=e.name;if(o&&(i.includes('主角')||i.includes('玩家')||i.toLowerCase().includes('player'))&&e.content[1]){const t=e.content[0]||[],n=e.content[1];for(let e=0;e<t.length;e++){const a=t[e];if(a&&a.includes('属性')){const t=In(n[e]||'').find(t=>t.name===r);if(t)return t.value}}}if(!o&&(i.includes('人物')||i.includes('NPC')||i.includes('角色')||i.toLowerCase().includes('character'))){const n=e.content[0]||[];let a=1;for(let t=0;t<n.length;t++)if(n[t]&&(n[t].includes('姓名')||n[t].includes('名称')||n[t].toLowerCase().includes('name'))){a=t;break}for(let o=1;o<e.content.length;o++){const i=e.content[o];if(i&&i[a]===t)for(let t=0;t<n.length;t++){const e=n[t];if(e&&e.includes('属性')){const n=In(i[t]||'').find(t=>t.name===r);if(n)return n.value}}}}}return null},Pe=['力量','敏捷','体质','智力','感知','魅力'],je=()=>{try{const t=Xt.getActivePreset();if(t){const n=new Set;return t.baseAttributes&&Array.isArray(t.baseAttributes)&&t.baseAttributes.forEach(t=>{const e='string'==typeof t?t:t&&t.name;e&&n.add(e)}),t.specialAttributes&&Array.isArray(t.specialAttributes)&&t.specialAttributes.forEach(t=>{const e='string'==typeof t?t:t&&t.name;e&&n.add(e)}),Array.from(n)}const n=Xt.getAllPresets()||[],e=new Set(Re||[]);return Array.isArray(n)&&n.forEach(t=>{t&&(t.baseAttributes&&Array.isArray(t.baseAttributes)&&t.baseAttributes.forEach(t=>{const n='string'==typeof t?t:t&&t.name;n&&e.add(n)}),t.specialAttributes&&Array.isArray(t.specialAttributes)&&t.specialAttributes.forEach(t=>{const n='string'==typeof t?t:t&&t.name;n&&e.add(n)}))}),Array.from(e)}catch(t){return console.error('[DICE]ACU getRandomSkillPool 错误:',t),Re||[]}},Re=['杂技','特技','运动','格斗','斗殴','攀爬','健康','闪避','身法','驾驶','耐力','灵巧','巧手','戏法','跑酷','飞行','潜行','渗透','骑术','游泳','投掷','跳跃','体操','功夫','武术','行政','官僚','权威','命令','交易','掮客','欺诈','诱骗','谎言侦测','狂欢','交际','摆布','镇定','黑话','行话','礼节','礼仪','信誉','财力','戏剧','表演','共情','洞察','情感','团队精神','话术','博弈','赌博','阅人','小透明','审讯','恐吓','挑衅','领导','谈判','演说','精神分析','街头智慧','边缘知识','残酷真相','意志','决心','说服','魅惑','威吓','游说','交涉','察言观色','欺骗','洞悉','欺瞒','标新立异','脑内剧场','神游太虚','踩地雷','顾左右而言他','主角光环','厚颜无耻','甩锅','造假','废话文学','上头','破防','种草','社死','点子','惊世智慧','奶龙之力','狗屎运','天意','桃花运','建筑学','军械','枪械制造','工匠','技艺','生物科技','露营','化学','药理','创作','电脑','黑客','赛博技术','爆破','电子学','工程学','急救','伪造','信息安全','修补','捣鼓','开锁','机械','修理','医学','摄影','编程','锻造','编译','科技使用','机械维修','电气维修','锁匠','操作重型机械','药学','艺术','会计','人类学','智慧生物学','考古学','灵视','导航','方向','天文学','生物学','犯罪学','神话','禁忌知识','文化','习俗','法医','搜证','历史','人力情报','调查','搜索','语言','语言学','法律','图书馆使用','研究','学识','侦察','神秘学','物理','有备无患','信号情报','生存','战术','神学','通识','侦查','聆听','心理学','追踪','博物学','克苏鲁神话','地质学','气象学','奥秘','自然','宗教','察觉','求生','情报收集','估价','密语','读唇','手语','弓术','炮术','引导','召唤','信仰','奇迹','击剑','枪械','射击','重武器','先攻','神射','狙击','武艺','近战','兵器','预兆','运气','格挡','灵能','巫术','施法','茶道','破坏','剑术','斧术','鞭术','躲藏','乔装','隐匿','驯兽','医疗','催眠','伪装','时髦值'],Be=(t=void 0)=>{if('boolean'==typeof t){const n=t,e=t=>Math.floor(Math.random()*t)+1,a=()=>e(6)+e(6)+e(6),o=()=>{if(n){const t=a(),n=e(4)-2;return Math.max(3,Math.min(18,t+n))}{const t=5*a(),n=e(10)-5;return Math.max(5,Math.min(95,t+n))}},i={};return Pe.forEach(t=>{i[t]=o()}),i}const n=t||Xt.getActivePreset();if(!n){const t=t=>Math.floor(Math.random()*t)+1,n=()=>t(6)+t(6)+t(6),e={};return Pe.forEach(a=>{const o=5*n(),i=t(10)-5;e[a]=Math.max(5,Math.min(95,o+i))}),{base:e,special:{}}}const e={};n.baseAttributes.forEach(t=>{const n=t.modifier?`${t.formula}+${t.modifier}`:t.formula;e[t.name]=xn(n,t.range,{})});const a={};return n.specialAttributes&&Array.isArray(n.specialAttributes)&&n.specialAttributes.forEach(t=>{a[t.name]=xn(t.formula,t.range,e)}),{base:e,special:a}},Oe=async t=>{const n=Yn||pa();if(!n)return console.error('[DICE]ACU clearPresetAttributesForCharacter: 无法获取表格数据'),window.toastr&&window.toastr.error('无法获取表格数据'),{success:!1};const e=!t||'<user>'===t||''===t.trim();let a=null,o=-1,i=-1,r=-1,c=null;for(const s in n){const l=n[s];if(!l||!l.name||!l.content)continue;const d=l.name,u=l.content[0]||[];if(e&&(d.includes('主角')||d.includes('玩家')||d.toLowerCase().includes('player'))&&l.content[1]){a=l,o=1,c=s;for(let t=0;t<u.length;t++)u[t]&&u[t].includes('基础属性')?i=t:u[t]&&u[t].includes('特有属性')&&(r=t);if(i<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('属性')&&!u[t].includes('特有')){i=t;break}break}if(!e&&(d.includes('人物')||d.includes('NPC')||d.includes('角色')||d.toLowerCase().includes('character'))){let n=1;for(let t=0;t<u.length;t++)if(u[t]&&(u[t].includes('姓名')||u[t].includes('名称')||u[t].toLowerCase().includes('name'))){n=t;break}for(let e=1;e<l.content.length;e++){const d=l.content[e];if(d&&d[n]===t){a=l,o=e,c=s;for(let t=0;t<u.length;t++)u[t]&&u[t].includes('基础属性')?i=t:u[t]&&u[t].includes('特有属性')&&(r=t);if(i<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('属性')&&!u[t].includes('特有')){i=t;break}break}}if(o>0)break}}return!a||o<0?(console.error('[DICE]ACU clearPresetAttributesForCharacter: 找不到角色',t),window.toastr&&window.toastr.error(`找不到角色「${t||'<user>'}」`),{success:!1}):i<0?(console.error('[DICE]ACU clearPresetAttributesForCharacter: 找不到属性列'),window.toastr&&window.toastr.error('找不到属性列'),{success:!1}):(a.content[o][i]='',r>=0&&(a.content[o][r]=''),Yn=n,await $a(n,[c]),{success:!0})},Ve=async(t,n,e=!1,a=null)=>{const o=Yn||pa();if(!o)return console.error('[DICE]ACU writeAttributesToCharacter: 无法获取表格数据'),window.toastr&&window.toastr.error('无法获取表格数据'),{success:!1};const i=!t||'<user>'===t||''===t.trim();let r=null,c=-1,s=-1,l=-1,d=null;for(const n in o){const e=o[n];if(!e||!e.name||!e.content)continue;const a=e.name,u=e.content[0]||[];if(i&&(a.includes('主角')||a.includes('玩家')||a.toLowerCase().includes('player'))&&e.content[1]){r=e,c=1,d=n;for(let t=0;t<u.length;t++)u[t]&&u[t].includes('基础属性')?s=t:u[t]&&u[t].includes('特有属性')&&(l=t);if(s<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('属性')&&!u[t].includes('特有')){s=t;break}break}if(!i&&(a.includes('人物')||a.includes('NPC')||a.includes('角色')||a.toLowerCase().includes('character'))){let a=1;for(let t=0;t<u.length;t++)if(u[t]&&(u[t].includes('姓名')||u[t].includes('名称')||u[t].toLowerCase().includes('name'))){a=t;break}for(let o=1;o<e.content.length;o++){const i=e.content[o];if(i&&i[a]===t){r=e,c=o,d=n;for(let t=0;t<u.length;t++)u[t]&&u[t].includes('基础属性')?s=t:u[t]&&u[t].includes('特有属性')&&(l=t);if(s<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('属性')&&!u[t].includes('特有')){s=t;break}break}}if(c>0)break}}if(!r||c<0)return console.error('[DICE]ACU writeAttributesToCharacter: 找不到角色',t),window.toastr&&window.toastr.error(`找不到角色「${t||'<user>'}」`),{success:!1};if(s<0)return console.error('[DICE]ACU writeAttributesToCharacter: 找不到属性列'),window.toastr&&window.toastr.error('找不到属性列（需要包含"属性"关键词的列）'),{success:!1};const u=(()=>{const t=Xt.getActivePreset();return t&&t.baseAttributes?t.baseAttributes.map(t=>t.name):Pe})(),p=Xt.getActivePreset(),f=new Set;p&&p.specialAttributes&&p.specialAttributes.forEach(t=>f.add(t.name));const g=r.content[c][s]||'',m=In(g),b={};m.forEach(t=>{b[t.name]=t.value});let h=0;u.forEach(t=>{void 0!==b[t]&&h++});const v=h===u.length,x=[];m.forEach(t=>{u.includes(t.name)||f.has(t.name)||x.push({name:t.name,value:t.value})});const w=[];u.forEach(t=>{if(v){const e=void 0!==n[t]?n[t]:b[t];void 0!==e&&w.push(`${t}:${e}`)}else void 0!==b[t]?w.push(`${t}:${b[t]}`):void 0!==n[t]&&w.push(`${t}:${n[t]}`)}),l<0&&a&&Object.keys(a).forEach(t=>{v||!b[t]?w.push(`${t}:${a[t]}`):w.push(`${t}:${b[t]}`)}),x.forEach(t=>{w.push(`${t.name}:${t.value}`)});const y=w.join(';');r.content[c][s]=y;let k='';if(l>=0&&a&&Object.keys(a).length>0){const t=r.content[c][l]||'',n=In(t),e={};n.forEach(t=>{e[t.name]=t.value});const o=[];n.forEach(t=>{f.has(t.name)||o.push({name:t.name,value:t.value})});const i=[];p&&p.specialAttributes&&p.specialAttributes.forEach(t=>{const n=t.name;void 0!==a[n]?v||!e[n]?i.push(`${n}:${a[n]}`):i.push(`${n}:${e[n]}`):void 0!==e[n]&&i.push(`${n}:${e[n]}`)}),o.forEach(t=>{i.push(`${t.name}:${t.value}`)}),k=i.join(';'),r.content[c][l]=k}Yn=o,await $a(o,[d]);const C=[];return u.forEach(t=>{C.push({name:t,value:n[t]})}),{success:!0,attrs:C,attrString:y,specialAttrString:k,wasComplete:v}},Le=async(t,n,e,a,o)=>{const i=o?.dataOverride||Yn||pa();if(!i){const t='无法获取表格数据';return console.error(`[DICE] updateSingleAttribute: ${t}`),{success:!1,oldValue:0,newValue:0,error:t}}const r=!t||'<user>'===t||''===t.trim();let c=null,s=-1,l=-1,d=-1,u=[],p=null;for(const n in i){const e=i[n];if(!e||!e.name||!e.content)continue;const a=e.name,o=e.content[0]||[],f=()=>{const t=[];for(let n=0;n<o.length;n++)o[n]&&String(o[n]).includes('属性')&&t.push(n);return t},g=t=>{if(0===t.length)return-1;for(const n of t)if(String(o[n]).includes('基础属性'))return n;for(const n of t)if(String(o[n]).includes('特有属性'))return n;return t[0]};if(r&&(a.includes('主角')||a.includes('玩家')||a.toLowerCase().includes('player'))&&e.content[1]){c=e,s=1,p=n,u=f(),d=g(u),l=d;break}if(!r&&(a.includes('人物')||a.includes('NPC')||a.includes('角色')||a.toLowerCase().includes('character'))){let a=1;for(let t=0;t<o.length;t++)if(o[t]&&(String(o[t]).includes('姓名')||String(o[t]).includes('名称')||String(o[t]).toLowerCase().includes('name'))){a=t;break}for(let o=1;o<e.content.length;o++){const i=e.content[o];if(i&&i[a]===t){c=e,s=o,p=n,u=f(),d=g(u),l=d;break}}if(s>0)break}}if(!c||s<0){const n=`找不到角色: ${t||'<user>'}`;return console.error(`[DICE] updateSingleAttribute: ${n}`),{success:!1,oldValue:0,newValue:0,error:n}}if(l<0){const t='找不到属性列（需要包含"属性"关键词的列）';return console.error(`[DICE] updateSingleAttribute: ${t}`),{success:!1,oldValue:0,newValue:0,error:t}}const f=Te(t,n,o?.aliasCandidates||[]);if(!f.name){const t=f.reason||`属性 ${n} 不存在`;return console.warn(`[DICE] updateSingleAttribute: ${t}`),{success:!1,oldValue:0,newValue:0,error:t}}const g=f.name;for(const t of u){const n=String(c.content[s][t]||'');if(In(n).some(t=>t.name===g)){l=t;break}}l<0&&(l=d);const m=String(c.content[s][l]||''),b=In(m),h={};let v,x;if(b.forEach(t=>{h[t.name]=t.value}),void 0!==h[g])v=h[g];else{if(void 0===o?.initValue){const t=`属性 ${g} 不存在且未提供初始值`;return console.warn(`[DICE] updateSingleAttribute: ${t}`),{success:!1,oldValue:0,newValue:0,error:t}}v=o.initValue,console.info(`[DICE] updateSingleAttribute: 属性 ${g} 不存在，初始化为 ${v}`)}switch(e){case'add':x=v+a;break;case'subtract':x=v-a;break;case'set':x=a;break;default:const t=`不支持的操作类型: ${e}`;return console.error(`[DICE] updateSingleAttribute: ${t}`),{success:!1,oldValue:v,newValue:v,error:t}}const w=o?.min??0,y=o?.max??1/0;x=Math.max(w,Math.min(y,x)),console.info(`[DICE] updateSingleAttribute: ${t}.${g} ${v} → ${x} (${e} ${a})`),h[g]=x;const k=[],C=new Set;b.forEach(t=>{const n=h[t.name];void 0!==n&&(k.push(`${t.name}:${n}`),C.add(t.name))}),C.has(g)||k.push(`${g}:${x}`);const E=k.join(';');return c.content[s][l]=E,o?.skipSave||(Yn=i,await $a(i,[p])),console.info(`[DICE] updateSingleAttribute: 成功修改 ${t}.${g}`),{success:!0,oldValue:v,newValue:x,resolvedAttrName:g,modifiedSheetKey:p}},Ue=(t,n)=>{const e=n||Yn||pa();if(!e)return[];const a=!t||'<user>'===t||''===t.trim();let o=[];for(const n in e){const i=e[n];if(!i||!i.name||!i.content)continue;const r=i.name;if(a&&(r.includes('主角')||r.includes('玩家')||r.toLowerCase().includes('player'))&&i.content[1]){const t=i.content[0]||[],n=i.content[1];if(t.forEach((t,e)=>{if(t&&t.includes('属性')){In(n[e]||'').forEach(t=>{o.some(n=>n.name===t.name)||o.push(t)})}}),o.length>0)break}if(!a&&(r.includes('人物')||r.includes('NPC')||r.includes('角色')||r.toLowerCase().includes('character'))){const n=i.content[0]||[];let e=1;for(let t=0;t<n.length;t++)if(n[t]&&(n[t].includes('姓名')||n[t].includes('名称')||n[t].toLowerCase().includes('name'))){e=t;break}for(let a=1;a<i.content.length;a++){const r=i.content[a];if(r&&r[e]===t){n.forEach((t,n)=>{if(t&&t.includes('属性')){In(r[n]||'').forEach(t=>{o.some(n=>n.name===t.name)||o.push(t)})}});break}}if(o.length>0)break}}return o},qe=(t,n)=>{const{$}=le(),e=t.attr('id')||'dd_'+Math.random().toString(36).substr(2,9);t.attr('id',e),t.parent().find('.acu-dropdown-list').remove(),t.parent().hasClass('acu-dropdown-wrapper')||t.wrap('<div class="acu-dropdown-wrapper"></div>');const a=$(`<div class="acu-dropdown-list" data-for="${e}"></div>`);t.after(a);const o=(t='')=>{const e=t.toLowerCase(),o=n.filter(t=>t.toLowerCase().includes(e));0===o.length?a.html('<div class="acu-dropdown-empty">无匹配项</div>'):a.html(o.map(t=>`<div class="acu-dropdown-item" data-value="${h(t)}">${h(t)}</div>`).join(''))},i=()=>{a.removeClass('visible')};t.off('.acudd').on('focus.acudd click.acudd',function(n){n.stopPropagation(),$('.acu-dropdown-list').removeClass('visible'),o(t.val()),a.addClass('visible')}),t.on('input.acudd',function(){o($(this).val())}),a.on('click','.acu-dropdown-item',function(n){n.stopPropagation(),n.preventDefault();const e=$(this).data('value');t.val(e).trigger('change'),i()}),a.on('click',function(t){t.stopPropagation()}),t.closest('.acu-dice-panel, .acu-contest-panel').off('click.acudd_'+e).on('click.acudd_'+e,function(t){$(t.target).closest('.acu-dropdown-wrapper').length||i()})},Ye=(t,n)=>{const{$}=le();t.find(n).each(function(){const t=$(this);if(t.parent().hasClass('acu-input-wrapper'))return;t.wrap('<div class="acu-input-wrapper"></div>');const n=$('<button type="button" class="acu-clear-btn" title="清除"><i class="fa-solid fa-times"></i></button>');t.after(n),n.on('click',function(n){n.preventDefault(),n.stopPropagation(),t.val('').trigger('input').trigger('change').focus()})})},We=(t={})=>{const{$}=le();$('.acu-dice-panel, .acu-dice-overlay').remove();const n=ca(),e=qt();let a=e.lastDiceType||'1d100';Number.isNaN(gn(a).total)&&(a='1d100');const o=Yn||pa();let i=['<user>'],r=[];if(o)for(const t in o){const n=o[t];if(n&&n.name&&n.content){if('重要人物表'===n.name)for(let t=1;t<n.content.length;t++){const e=n.content[t];e&&e[1]&&i.push(e[1])}if('主角信息'===n.name&&n.content[1]){const t=n.content[1];(n.content[0]||[]).forEach((n,e)=>{if(n&&n.includes('属性')){In(t[e]||'').forEach(t=>{r.includes(t.name)||r.push(t.name)})}})}}}const{targetValue:c=null,targetName:s='',attrValue:l=null,diceType:d=a,successCriteria:f='lte',onResult:b=null,initiatorName:v='',fromMvu:x=!1,mvuPath:w=null,mvuParsedInfo:y=null}=t;let k=l,E=c;null!==l&&null===c&&(E='1d20'===d||'gte'===f?Math.max(0,20-l):l);const A=$('<div class="acu-dice-overlay"></div>');let S=f;'1d100'===d?S='lte':'1d20'===d&&(S='gte');const I=(()=>{const t=Gt.getAllPresets().filter(t=>!1!==t.visible).sort((t,n)=>(t.order||0)-(n.order||0));let n='<div class="acu-dice-quick-section" style="margin-bottom: 8px;">';return n+='<div class="acu-dice-section-title"><span><i class="fa-solid fa-sliders"></i> 检定规则<div id="dice-preset-quick-actions" class="acu-dice-preset-quick-actions"></div></span></div>',n+='<div class="acu-dice-quick-presets" id="dice-normal-presets">',n+='<button class="acu-dice-quick-preset-btn" data-id="__custom__">自定义</button>',t.forEach(t=>{n+=`<button class="acu-dice-quick-preset-btn" data-id="${h(t.id)}">${h(t.name)}</button>`}),n+='</div>',n+='<div id="dice-workflow-return-container" style="display: none;">\n        <button class="acu-dice-return-btn" id="dice-return-normal-btn">\n            <i class="fa-solid fa-arrow-left"></i> 返回常规检定\n        </button>\n      </div>',n+='</div>',n})(),D=$(`\n            <div class="acu-dice-panel acu-theme-${n.theme}">\n                <div class="acu-dice-panel-header">\n                    <div class="acu-dice-panel-title">\n                        <i class="fa-solid fa-dice-d20"></i> 普通检定\n                    </div>\n                    <div class="acu-dice-panel-actions">\n                        <button id="dice-switch-contest-top" title="切换到对抗检定"><i class="fa-solid fa-people-arrows"></i></button>\n                        <button id="dice-history-btn" title="检定历史"><i class="fa-solid fa-history"></i></button>\n                        <button class="acu-dice-config-btn" title="检定设置">\n                            <i class="fa-solid fa-cog"></i>\n                        </button>\n                        <button class="acu-dice-close">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="acu-dice-panel-body">\n                    ${I}\n\n                    \x3c!-- 快捷选择角色 --\x3e\n                    <div class="acu-dice-quick-section">\n                        <div class="acu-dice-section-title"><span><i class="fa-solid fa-user"></i> 快捷选择</span><div id="dice-char-buttons" class="acu-dice-quick-inline"></div></div>\n                    </div>\n\n                    \x3c!-- 第1行：名字 + 属性名 --\x3e\n                    <div class="acu-dice-form-row cols-2" id="dice-row-1">\n                        <div id="dice-name-wrapper">\n                            <div class="acu-dice-form-label">名字</div>\n                            <input type="text" id="dice-initiator-name" class="acu-dice-input" value="${h(v)}" placeholder="<user>">\n                        </div>\n                        <div id="dice-attr-name-wrapper">\n                            <div class="acu-dice-form-label" id="dice-attr-name-label">\n                                <span class="dice-attr-name-text">属性名</span>\n                                <button type="button" class="acu-random-skill-btn" id="dice-random-skill" title="随机技能">\n                                    <i class="fa-solid fa-dice"></i>\n                                </button>\n                            </div>\n                            <input type="text" id="dice-attr-name" class="acu-dice-input" value="${h(s||'')}" placeholder="自由检定">\n                        </div>\n                    </div>\n\n                    \x3c!-- 第2行：属性值 + 技能加值 + 目标值 --\x3e\n                    <div class="acu-dice-form-row cols-2" id="dice-row-2">\n                        <div id="dice-attr-wrapper">\n                            <div class="acu-dice-form-label" id="dice-attr-label">属性值</div>\n                            <input type="text" id="dice-attr-value" class="acu-dice-input" value="${null!==k?k:''}" placeholder="留空=50%最大值">\n                        </div>\n                        <div id="dice-skill-mod-wrapper" style="display: none;">\n                            <div class="acu-dice-form-label" id="dice-skill-mod-label">技能加值</div>\n                            <input type="text" id="dice-skill-mod" class="acu-dice-input" placeholder="留空=0">\n                        </div>\n                        <div id="dice-target-wrapper">\n                            <div class="acu-dice-form-label" id="dice-target-label">目标值</div>\n                            <input type="text" id="dice-target" class="acu-dice-input" value="${null!==E?E:''}" placeholder="留空=属性值">\n                        </div>\n                    </div>\n\n                    \x3c!-- 第3行：成功标准 + 难度等级 + 修正值 (基础模式) --\x3e\n                    <div class="acu-dice-form-row cols-3" id="dice-row-3">\n                        <div>\n                            <div class="acu-dice-form-label centered">成功标准</div>\n                            <select id="dice-success-criteria" class="acu-dice-select">\n                                ${[{id:'lte',name:'≤ (COC)'},{id:'gte',name:'≥ (DND)'}].map(t=>`<option value="${t.id}" ${t.id===S?'selected':''}>${t.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div id="dice-difficulty-wrapper">\n                            <div class="acu-dice-form-label centered">难度等级</div>\n                            <select id="dice-difficulty" class="acu-dice-select">\n                                <option value="normal" selected>普通</option>\n                                <option value="hard">困难</option>\n                                <option value="extreme">极难</option>\n                                <option value="critical">大成功</option>\n                            </select>\n                        </div>\n                        <div id="dice-mod-wrapper">\n                            <div class="acu-dice-form-label" id="dice-mod-label">修正值</div>\n                            <input type="text" id="dice-modifier" class="acu-dice-input" placeholder="留空=0">\n                        </div>\n                    </div>\n\n                    \x3c!-- [新增] 高级预设自定义字段区域 (在快捷属性上方) --\x3e\n                    <div id="dice-custom-fields-area"></div>\n\n                    \x3c!-- [新增] 自定义掷骰模式字段区 --\x3e\n                    <div id="acu-dice-custom-mode-fields" style="display: none; margin-top: 8px;">\n                        <div class="acu-dice-form-row cols-3">\n                            <div>\n                                <div class="acu-dice-form-label">骰子语法</div>\n                                <input type="text" id="custom-dice-expr" class="acu-dice-input" value="${h(e.customDiceExpr||'')}" placeholder="1d100,2d6+3...">\n                            </div>\n                            <div>\n                                <div class="acu-dice-form-label">成功条件</div>\n                                <select id="custom-judge-mode" class="acu-dice-select">\n                                    <option value=">=">>=</option>\n                                    <option value="<=" selected><=</option>\n                                    <option value=">">&gt;</option>\n                                    <option value="<">&lt;</option>\n                                    <option value="none">无判定</option>\n                                </select>\n                            </div>\n                            <div>\n                                <div class="acu-dice-form-label">目标值</div>\n                                <input type="text" id="custom-target-value" class="acu-dice-input" placeholder="留空=50%概率">\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 快捷选择属性（紧凑型） --\x3e\n                    <div id="dice-attr-buttons" class="acu-dice-quick-compact"></div>\n\n                    \x3c!-- 隐藏的骰子公式 --\x3e\n                    <input type="hidden" id="dice-formula" value="${d}">\n\n                    <button id="dice-roll-btn" class="acu-dice-roll-btn">\n                        <i class="fa-solid fa-dice"></i> 掷骰！\n                    </button>\n                </div>\n            </div>\n        `);A.append(D),$('body').append(A);const M='__acuEffectRunCleanerTimer';new Set;const T=t=>{const n=D.find('#dice-attr-buttons'),e=n.parent(),a=Ue(t);e.show();let o='';if(x&&y&&y.attrName){const n=y.attrName,e=Fe(t,n)||c||'';o+=e?`<button class="acu-dice-attr-btn acu-dice-attr-btn-mvu" data-name="${h(n)}" data-value="${e}" title="从变量路径提取: ${h(n)}">${h(n)}:${e}</button>`:`<button class="acu-dice-attr-btn acu-dice-attr-btn-mvu" data-name="${h(n)}" data-value="" title="从变量路径提取: ${h(n)}">${h(n)}</button>`}a.forEach(t=>{o+=`<button class="acu-dice-attr-btn" data-name="${h(t.name)}" data-value="${t.value}">${h(t.name)}:${t.value}</button>`}),o+='<button class="acu-dice-gen-attr-btn" title="为当前角色生成属性"><i class="fa-solid fa-dice"></i></button>',o+='<button class="acu-dice-clear-attr-btn" title="清空当前规则的属性（保留自定义属性）"><i class="fa-solid fa-trash-alt"></i></button>',n.html(o),n.find('.acu-dice-attr-btn').click(function(){const t=$(this).data('name'),n=$(this).data('value');D.find('#dice-attr-name').val(t).trigger('change');let e='#dice-attr-value';if(F?.attrTargetMapping)for(const[n,a]of Object.entries(F.attrTargetMapping))if(Array.isArray(a)&&a.includes(t)){'skillMod'===n?e='#dice-skill-mod':'mod'===n?e='#dice-modifier':'attribute'===n&&(e='#dice-attr-value');break}D.find(e).val(n),D.find('#acu-dice-custom-mode-fields').is(':visible')&&D.find('#custom-target-value').val(n),D.find(e).trigger('change')}),n.find('.acu-dice-gen-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const n=$(this);if(n.prop('disabled'))return;n.prop('disabled',!0).css('opacity','0.5');const e=n.html();n.html('<i class="fa-solid fa-spinner fa-spin"></i>');const a=ee.handleUpdate;ee.handleUpdate=()=>{console.log('[DICE]ACU 属性生成中，跳过自动刷新')};try{const t=D.find('#dice-initiator-name').val().trim()||'<user>';console.log('[DICE]ACU 生成属性 for:',t);const n=Be(),e=n.base||n,a=n.special||{};(await Ve(t,e,!1,a)).success&&T(t)}catch(t){console.error('[DICE]ACU 生成属性失败:',t),window.toastr&&window.toastr.error('生成属性失败')}finally{ee.handleUpdate=a,n.prop('disabled',!1).css('opacity','1').html(e)}}),n.find('.acu-dice-clear-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const n=$(this);if(n.prop('disabled'))return;const e=D.find('#dice-initiator-name').val().trim()||'<user>';n.prop('disabled',!0).css('opacity','0.5');const a=n.html();n.html('<i class="fa-solid fa-spinner fa-spin"></i>');const o=ee.handleUpdate;ee.handleUpdate=()=>{console.log('[DICE]ACU 清空属性中，跳过自动刷新')};try{console.log('[DICE]ACU 清空属性 for:',e);(await Oe(e)).success&&T(e)}catch(t){console.error('[DICE]ACU 清空属性失败:',t),window.toastr&&window.toastr.error('清空属性失败')}finally{ee.handleUpdate=o,n.prop('disabled',!1).css('opacity','1').html(a)}})};(()=>{const t=D.find('#dice-char-buttons');let n='';if(x&&y&&y.initiator){const t=y.initiator,e=t.length>4?t.substring(0,4)+'..':t;n+=`<button class="acu-dice-char-btn acu-dice-char-btn-mvu" data-char="${h(t)}" title="从变量路径提取: ${h(t)}">${h(e)}</button>`}i.forEach(t=>{const e='<user>'===t?t:Bt.resolve(String(t)),a='<user>'===e?zt():Tt(String(e)),o=a.length>4?a.substring(0,4)+'..':a;n+=`<button class="acu-dice-char-btn" data-char="${h(String(e))}" title="${h(a)}">${h(o)}</button>`}),x&&y&&y.candidates&&y.candidates.length>0&&y.candidates.forEach(t=>{if(y.initiator&&t===y.initiator)return;const e=t.length>4?t.substring(0,4)+'..':t;n+=`<button class="acu-dice-char-btn acu-dice-char-btn-mvu-candidate" data-char="${h(t)}" title="从变量路径提取: ${h(t)}">${h(e)}</button>`}),t.html(n||'<div class="acu-dice-empty-hint">无角色数据</div>'),t.find('.acu-dice-char-btn').click(function(){const t=$(this).data('char');D.find('#dice-initiator-name').val(t).trigger('change')})})(),T('<user>'),D.find('#dice-random-skill').click(function(t){t.preventDefault(),t.stopPropagation();const n=je(),e=n[Math.floor(Math.random()*n.length)];D.find('#dice-attr-name').val(e).trigger('change')}),qe(D.find('#dice-initiator-name'),i),qe(D.find('#dice-attr-name'),r),Ye(D,'#dice-initiator-name, #dice-attr-name, #dice-attr-value, #dice-skill-mod, #dice-target, #dice-modifier, #custom-dice-expr, #custom-target-value'),D.find('#dice-initiator-name').on('change.acuattr input.acuattr',function(){const t=$(this).val().trim()||'<user>',n=Me(t);qe(D.find('#dice-attr-name'),n.length>0?n:r),T(t)}),D.find('#dice-attr-name').on('change.acuval',function(){const t=D.find('#dice-initiator-name').val().trim()||'<user>',n=$(this).val().trim(),e=Fe(t,n);null!==e&&D.find('#dice-attr-value').val(e)});const N=()=>{const t='gte'===D.find('#dice-success-criteria').val(),n=D.find('#dice-target'),e=D.find('#dice-difficulty-wrapper'),a=D.find('#dice-row-3');t?(n.attr('placeholder','留空=10'),D.find('#dice-target-label').text('DC'),e.hide(),a.css('grid-template-columns','1fr 1fr')):(n.attr('placeholder','留空=属性值'),D.find('#dice-target-label').text('目标值'),e.show(),a.css('grid-template-columns','1fr 1fr 1fr'))};D.find('#dice-success-criteria').on('change',N),N();let F=null,P=null,j=[],R=null,B=null,O=0;const V=new Map,L=t=>t&&'quickActions'in t&&Array.isArray(t.quickActions)?t.quickActions.filter(t=>Boolean(t&&'string'==typeof t.id&&'string'==typeof t.kind)):[],U=t=>{if(!t.condition)return!0;const n=bn(t.condition,(()=>{const t=String(D.find('#dice-attr-value').val()||'').trim(),n=String(D.find('#dice-modifier').val()||'').trim(),e=String(D.find('#dice-target').val()||'').trim();return{$attr:''===t?0:parseFloat(t)||0,$mod:''===n?0:parseFloat(n)||0,$dc:''===e?0:parseFloat(e)||0}})());return!!n.success&&('number'==typeof n.value?0!==n.value:Boolean(n.value))},q=t=>{const n=D.find('#dice-preset-quick-actions');if(!n.length)return;const e=L(t).filter(U);if(0===e.length)return void n.empty().hide();let a='';e.forEach(t=>{const n=t.icon||'fa-bolt',e=t.tooltip||t.id;a+=`<button type="button" class="acu-dice-preset-action-btn" data-action-id="${h(t.id)}" title="${h(e)}"><i class="fa-solid ${h(n)}"></i></button>`}),n.html(a).show()},Y=t=>new Promise(n=>{setTimeout(n,t)}),W=async(t,n,e)=>0!==e.length&&(console.info(`[DICE][META] inject start: run=${n}, message=${t}, lines=${e.length}`),(async(t,n)=>{const e=(V.get(t)||Promise.resolve()).catch(()=>{}).then(n);V.set(t,e);try{return await e}finally{V.get(t)===e&&V.delete(t)}})(t,async()=>{const a=[0,120,280,500,900];for(let o=0;o<a.length;o++){const i=a[o];i>0&&await Y(i);const r=getChatMessages(t);if(0===r.length){console.info(`[DICE][META] inject retry=${o+1}/${a.length}: message not found, run=${n}, message=${t}`);continue}const c=r[0],s=c.role||'unknown',l=c.extra&&'object'==typeof c.extra?c.extra:{},d=l.acuEffectInjectedRuns,u=Array.isArray(d)?d.filter(t=>'string'==typeof t):[];if(u.includes(n))return console.info(`[DICE][META] inject skipped duplicated run: run=${n}, message=${t}`),!0;const p=String(c.message||''),f=['</meta:检定结果>','&lt;/meta:检定结果&gt;','&amp;lt;/meta:检定结果&amp;gt;'];let g=-1,m='';for(const t of f){const n=p.lastIndexOf(t);n>g&&(g=n,m=t)}if(-1===g){const e=p.includes('<meta:检定结果>'),i=p.includes('</meta:检定结果>'),r=p.includes('&lt;meta:检定结果&gt;'),c=p.includes('&lt;/meta:检定结果&gt;');console.info(`[DICE][META] inject retry=${o+1}/${a.length}: closing tag not found, run=${n}, message=${t}, role=${s}, length=${p.length}, rawOpen=${e}, rawClose=${i}, escapedOpen=${r}, escapedClose=${c}`);continue}const b=p.slice(0,g),h=b.length>0&&!b.endsWith('\n'),v=b+`${h?'\n':''}${e.join('\n')}`+'\n'+p.slice(g);console.info(`[DICE][META] inject apply: run=${n}, message=${t}, role=${s}, attempt=${o+1}, oldLen=${p.length}, newLen=${v.length}, closingIdx=${g}, closingTag=${m}`),await setChatMessages([{message_id:t,message:v,extra:{...l,acuEffectInjectedRuns:[...u,n]}}],{refresh:'affected'});const x=getChatMessages(t)[0],w=String(x?.message||''),y=e.filter(t=>w.includes(t)).length;return console.info(`[DICE][META] inject done: run=${n}, message=${t}, lineHit=${y}/${e.length}, finalLen=${w.length}`),!0}return console.warn(`[DICE][META] inject failed: run=${n}, message=${t}, reason=message_not_ready_or_meta_missing`),!1})),J=(t,n)=>{if(0===n.length)return!1;try{const{$}=le(),e=$('#send_textarea');if(0===e.length)return!1;const a=String(e.val()||'');if(!a.includes('meta:检定结果'))return!1;const o=n.filter(t=>!a.includes(t));if(0===o.length)return console.info(`[DICE][META] textarea inject skipped duplicated run=${t}`),!0;const i=['</meta:检定结果>','&lt;/meta:检定结果&gt;','&amp;lt;/meta:检定结果&amp;gt;'];let r=-1,c='';for(const t of i){const n=a.lastIndexOf(t);n>r&&(r=n,c=t)}if(-1===r)return console.warn(`[DICE][META] textarea inject failed: closing tag missing, run=${t}`),!1;const s=a.slice(0,r),l=s.length>0&&!s.endsWith('\n'),d=s+`${l?'\n':''}${o.join('\n')}`+'\n'+a.slice(r);return e.val(d).trigger('input').trigger('change'),console.info(`[DICE][META] textarea inject done: run=${t}, lines=${o.length}, closingTag=${c}`),!0}catch(n){return console.warn(`[DICE][META] textarea inject error: run=${t}`,n),!1}},H=()=>{try{const{$}=le(),t=$('#send_textarea');if(0===t.length)return!1;return String(t.val()||'').includes('meta:检定结果')}catch{return!1}},X=t=>{O+=1;return co('effect_run',{...t,seq:O}),O},G=t=>'all'===t?.secondaryTriggerMode?'all':'first',Z=(t,n)=>{if(t<0||t>=Qa.length)return null;const e=Qa[t],a={...n};var o,i;return a.effectStatus&&e.effectStatus&&(o=e.effectStatus,i=a.effectStatus,o&&i&&o!==i&&!({planned:['confirmed','cancelled','failed'],confirmed:['committed','failed','cancelled'],committed:[],failed:[],cancelled:[]}[o]||[]).includes(i))&&(console.warn(`[DICE] Invalid effect status transition blocked: ${e.effectStatus} -> ${a.effectStatus}`),delete a.effectStatus),Object.assign(e,a),e},Q=(t,n)=>{const e=(t=>{if(!t)return-1;for(let n=Qa.length-1;n>=0;n--)if(Qa[n].effectRunId===t)return n;return-1})(t.runId);return e>=0?Z(e,n):(console.warn(`[DICE] setHistoryEffectStateByRun skipped: runId not found (${t.runId})`),null)},tt=()=>{try{const t=getLastMessageId();if(!Number.isFinite(t)||t<0)return;const n=Math.max(0,t-12),e=getChatMessages(`${n}-${t}`,{role:'user'});for(let t=e.length-1;t>=0;t--){if(String(e[t].message||'').includes('meta:检定结果'))return e[t].message_id}}catch{}},nt=t=>{t.expiresAt||(t.expiresAt=Date.now()+6e4),j.push(t),console.info(`[DICE] Effect run queued: ${t.runId}, message=${t.messageId||'pending'}, expiresAt=${t.expiresAt}, pending=${j.length}`)},et=async t=>{const n=(t=>{if(null!=t){if('string'==typeof t||'number'==typeof t)return String(t);if('object'==typeof t){const n=t,e=[n.messageId,n.message_id,n.id,n.mid].find(t=>null!=t&&''!==String(t).trim());if(null!=e)return String(e)}}})(t);if(n&&console.info(`[DICE][META] MESSAGE_SENT captured id=${n}`),n&&R&&!R.messageId&&(R.messageId=n,console.info(`[DICE][META] bind activeConfirm run=${R.runId} message=${n}`)),0===j.length)return;const e=Date.now(),a=[],o=[];let i=!1,r=!1;for(const t of j){if(Boolean(t.expiresAt&&t.expiresAt<e)){const n='效果执行已过期，已自动取消';Q(t,{effectStatus:'cancelled',effectError:n,effectTrace:['已取消：超时未提交']});const a=X({runId:t.runId,status:'cancelled',characterName:t.context.characterName,attributeName:t.context.attributeName,historyIndex:t.historyIndex,effectResults:[],effectTrace:['已取消：超时未提交'],chainMode:G(t.preset),error:n,timestamp:e});Q(t,{effectEventSeq:a});continue}if(n){if(t.messageId&&t.messageId!==n){a.push(t);continue}i?a.push(t):(t.messageId||(t.messageId=n,console.info(`[DICE][META] bind queued run=${t.runId} message=${n}`)),o.push(t),i=!0);continue}const c=e-t.timestamp<=2500;if(c&&!r){if(!t.messageId){const n=tt();void 0!==n&&(t.messageId=String(n),console.warn(`[DICE][META] fallback guessed messageId: run=${t.runId}, message=${t.messageId}`))}t.messageId?(console.warn(`[DICE] Effect run ${t.runId}: fallback commit with bound messageId=${t.messageId}`),o.push(t),r=!0):H()?(console.warn(`[DICE][META] fallback commit by textarea meta presence: run=${t.runId}`),o.push(t),r=!0):(console.warn(`[DICE][META] fallback skipped: run=${t.runId} has no messageId yet`),a.push(t))}else c||r?a.push(t):(console.warn(`[DICE][META] timeout fallback commit without messageId: run=${t.runId}`),o.push(t),r=!0)}if(0===o.length)return j=a,void(j.length>0&&(B||(B=setTimeout(()=>{B=null,et()},220))));j=a;for(const t of o)try{const n=await u(t),e=n.some(t=>!t.success);if(!e){const e=n.filter(t=>t.success).slice().reverse().find(n=>n.target&&Ne(n.target,t.context.attributeName));e&&D.find('#dice-attr-value').val(String(e.newValue)),T(t.context.characterName)}Q(t,{effectStatus:e?'failed':'committed',effectResults:n,effectError:e?'部分效果执行失败':void 0,effectTrace:g(n)});const a=X({runId:t.runId,status:e?'failed':'committed',characterName:t.context.characterName,attributeName:t.context.attributeName,historyIndex:t.historyIndex,effectResults:n,effectTrace:g(n),chainMode:G(t.preset),error:e?'部分效果执行失败':void 0,timestamp:Date.now()});if(Q(t,{effectEventSeq:a}),e&&window.toastr&&window.toastr.warning('效果执行存在失败，已回滚本次全部效果','效果执行失败'),console.info(`[DICE] Effect run committed: ${t.runId}, total=${n.length}, success=${n.filter(t=>t.success).length}`),!e){const e=m(n,{branchReasonText:t.branchReasonText});if(e.length>0)try{if(t.messageId){const n=parseInt(t.messageId,10);if(!isNaN(n)&&n>=0){await W(n,t.runId,e)?console.info(`[DICE] Effect results injected into meta: ${e.length} line(s) in message ${n}`):console.warn(`[DICE][META] inject returned false: run=${t.runId}, rawMessageId=${t.messageId}, lines=${e.length}`)}else console.warn(`[DICE][META] invalid messageId for injection: run=${t.runId}, rawMessageId=${t.messageId}`)}else{J(t.runId,e)||console.warn(`[DICE][META] no messageId and textarea inject failed: run=${t.runId}`)}}catch(t){console.error('[DICE] Failed to inject effect results into meta:',t)}}}catch(n){const e=n instanceof Error?n.message:String(n);Q(t,{effectStatus:'failed',effectError:e,effectTrace:[`执行失败：${e}`]});const a=X({runId:t.runId,status:'failed',characterName:t.context.characterName,attributeName:t.context.attributeName,historyIndex:t.historyIndex,effectResults:[],effectTrace:[`执行失败：${e}`],chainMode:G(t.preset),error:e,timestamp:Date.now()});Q(t,{effectEventSeq:a}),console.error(`[DICE] Effect run failed: ${t.runId}`,n)}},at=window[M];'number'==typeof at&&window.clearInterval(at),window[M]=window.setInterval(()=>{(()=>{if(0===j.length)return;const t=Date.now(),n=[];for(const e of j){if(!Boolean(e.expiresAt&&e.expiresAt<t)){n.push(e);continue}const a='效果执行已过期，已自动取消';Q(e,{effectStatus:'cancelled',effectError:a,effectTrace:['已取消：超时']});const o=X({runId:e.runId,status:'cancelled',characterName:e.context.characterName,attributeName:e.context.attributeName,historyIndex:e.historyIndex,effectResults:[],effectTrace:['已取消：超时'],chainMode:G(e.preset),error:a,timestamp:t});Q(e,{effectEventSeq:o})}j=n})()},2e3);const ot=function(t,n,e,a){const o=n.parent();e?.hidden?o.hide():(o.show(),t.attr('placeholder',e?.placeholder||a.placeholder).prop('readonly',!1),n.text(e?.label||a.label))},it=(t,n)=>{if(!n)return!0;const e=t.trim().toLowerCase(),a=(t,n)=>n.some(n=>{const e=(t=>{const n=t.replace(/[.+^${}()|[\]\\]/g,'\\$&').replace(/\*/g,'.*').replace(/\?/g,'.');return new RegExp(`^${n}$`,'i')})(n);return e.test(t)});if(n.namePatterns?.exclude&&n.namePatterns.exclude.length>0&&a(e,n.namePatterns.exclude))return!1;if(n.namePatterns?.include&&n.namePatterns.include.length>0){if(!(1===n.namePatterns.include.length&&'*'===n.namePatterns.include[0])&&!a(e,n.namePatterns.include))return!1}return!0},rt=t=>{const n=D.find('#dice-mod-wrapper'),e=D.find('#dice-row-1'),a=D.find('#dice-row-2'),o=D.find('#dice-row-3'),i=D.find('#dice-custom-fields-area'),r=D.find('#dice-attr-wrapper'),c=D.find('#dice-target-wrapper'),s=D.find('#dice-skill-mod-wrapper'),l=D.find('#dice-name-wrapper'),d=D.find('#dice-attr-name-wrapper'),u=()=>{'dice-row-1'!==l.parent().attr('id')&&l.detach().prependTo(e),'dice-row-1'!==d.parent().attr('id')&&d.detach().appendTo(e),l.show(),d.show(),e.show(),e.removeClass('cols-2 cols-3').addClass('cols-2')},p=()=>{'dice-row-3'!==n.parent().attr('id')&&n.detach().appendTo(o),n.show(),D.find('#dice-mod-label').text('修正值'),D.find('#dice-modifier').attr('placeholder','留空=0')},f=()=>{'dice-row-2'!==r.parent().attr('id')&&r.detach().prependTo(a),'dice-row-2'!==s.parent().attr('id')&&s.detach().insertAfter(r),'dice-row-2'!==c.parent().attr('id')&&c.detach().appendTo(a),r.show(),s.hide(),c.show(),a.show()};if(!t||'__custom__'===t)return F=null,P=null,D.find('#acu-dice-custom-mode-fields').show(),u(),f(),p(),a.hide(),o.hide(),D.find('#dice-difficulty-wrapper').hide(),D.find('#dice-success-criteria').closest('div').hide(),i.empty(),D.find('.dice-attr-name-text').text('属性名'),ot(D.find('#dice-attr-value'),D.find('#dice-attr-label'),void 0,{label:'属性值',placeholder:'留空=50%最大值'}),ot(D.find('#dice-target'),D.find('#dice-target-label'),void 0,{label:'目标值',placeholder:'留空=属性值'}),D.find('.acu-dice-quick-preset-btn').removeClass('active'),D.find('.acu-dice-quick-preset-btn[data-id="__custom__"]').addClass('active'),D.find('#dice-normal-presets').show(),D.find('#dice-workflow-return-container').hide(),N(),void q(null);const g=Gt.getAllPresets().find(n=>n.id===t);if(!g)return console.warn('[DICE] 未找到预设:',t),void rt('__custom__');F=g,!1!==g.visible&&(P=g.id),D.find('.acu-dice-quick-preset-btn').removeClass('active'),D.find(`.acu-dice-quick-preset-btn[data-id="${h(g.id)}"]`).addClass('active'),D.find('#acu-dice-custom-mode-fields').hide(),D.find('#dice-formula').val(g.diceExpression),D.find('.dice-attr-name-text').text(g.attributeName?.label||'属性名'),u(),f(),p(),e.hide(),a.hide(),o.hide(),i.empty();const m=[];m.push(l),m.push(d),g.attribute?.hidden||(ot(D.find('#dice-attr-value'),D.find('#dice-attr-label'),g.attribute,{label:'属性值',placeholder:'留空=50%最大值'}),m.push(r)),g.skillMod&&!g.skillMod.hidden&&(ot(D.find('#dice-skill-mod'),D.find('#dice-skill-mod-label'),g.skillMod,{label:'技能加值',placeholder:'留空=0'}),m.push(s));const b=((t,n)=>{if(!t.effectsConfig)return[];if(!it(n,{namePatterns:{include:t.effectsConfig.triggerPatterns}}))return[];const e=[];t.outcomes&&Array.isArray(t.outcomes)&&t.outcomes.filter(t=>t.effects&&t.effects.length>0).forEach(n=>{const a=t.effectsConfig?.defaultValues?.[n.name]||n.effects&&n.effects[0]?.value||'',o=n.name;e.push(`\n            <div class="acu-effect-input-group">\n              <div class="acu-effect-input-label">\n                <span>${h(o)}效果</span>\n                <span class="acu-effect-preview-text" id="effect-preview-${h(n.name)}"></span>\n              </div>\n              <input type="text"\n                     class="acu-dice-input acu-effect-value-input"\n                     data-outcome="${h(n.name)}"\n                     value=""\n                     placeholder="${h(String(a||'输入效果值 (如 1d6)'))}">\n            </div>\n          `)});return e})(g,D.find('#dice-attr-name').val().trim());if(b.length>0&&m.push(...b),g.dc?.hidden||(ot(D.find('#dice-target'),D.find('#dice-target-label'),g.dc,{label:'目标值',placeholder:'留空=属性值'}),m.push(c)),!g.mod?.hidden){g.mod?.label&&D.find('#dice-mod-label').text(g.mod.label);const t=g.mod?.defaultValue;void 0!==t&&0!==t?D.find('#dice-modifier').attr('placeholder',`留空=${t}`):D.find('#dice-modifier').attr('placeholder','留空=0'),m.push(n)}if('customFields'in g&&Array.isArray(g.customFields)&&g.customFields.length>0){g.customFields.filter(t=>!t.hidden).forEach(t=>{let n='<div>';if('toggle'!==t.type?n+=`<div class="acu-dice-form-label">${h(t.label||t.id)}</div>`:n+='<div class="acu-dice-form-label">&nbsp;</div>','select'===t.type&&t.options)n+=`<select class="acu-dice-select acu-dice-custom-field" data-id="${h(t.id)}">`,t.options.forEach(e=>{const a=e.value===t.defaultValue?'selected':'';n+=`<option value="${h(String(e.value))}" ${a}>${h(e.label)}</option>`}),n+='</select>';else if('toggle'===t.type){const e=t.defaultValue?'checked':'';n+=`<label style="display: flex; align-items: center; cursor: pointer; height: 32px;">\n              <input type="checkbox" class="acu-dice-custom-field" data-id="${h(t.id)}" ${e} style="margin-right: 8px;">\n              ${h(t.label||t.id)}\n            </label>`}else{const e='number'===t.type?'number':'text',a=t.defaultValue,o=t.placeholder||(void 0!==a&&''!==a?`留空=${a}`:'');n+=`<input type="${e}" class="acu-dice-input acu-dice-custom-field" data-id="${h(t.id)}"\n              placeholder="${h(o)}">`}n+='</div>',m.push(n)})}const v=(t,n)=>{'string'==typeof n?t.append(n):(n.detach().appendTo(t),n.show())},x=t=>t<=0?[]:t<=2?[2]:3===t?[3]:4===t?[2,2]:5===t?[2,3]:6===t?[3,3]:[...x(t-3),3],w=x(m.length);let y=0;for(const t of w){const n=$(`<div class="acu-dice-form-row cols-${t}"></div>`);for(let e=0;e<t;e++)y<m.length?(v(n,m[y]),y++):n.append('<div></div>');i.append(n)}Ye(i,'.acu-dice-custom-field[type="text"], .acu-dice-custom-field[type="number"]'),q(g);const k=!1===g.visible,C=D.find('#dice-normal-presets'),E=D.find('#dice-workflow-return-container');k?(C.hide(),E.show(),E.find('button').html(`<i class="fa-solid fa-arrow-left"></i> 返回常规检定（退出${h(g.name)}）`)):(C.show(),E.hide()),console.log('[DICE] 应用高级预设:',g.name,k?'(工作流模式)':'')};D.find('#dice-attr-name').on('change',function(){F&&(D.data('updating-preset')||(D.data('updating-preset',!0),rt(F.id),D.data('updating-preset',!1)))}),D.find('#custom-dice-expr').on('input change',function(){if(!D.find('#acu-dice-custom-mode-fields').is(':visible'))return;const t=($(this).val()||'').toString().trim();Yt({customDiceExpr:t})}),D.find('.acu-dice-quick-preset-btn').click(function(){const t=$(this).data('id');'__custom__'===t?(Gt.setActivePreset(null),localStorage.setItem(K,'__custom__')):(Gt.setActivePreset(t),localStorage.setItem(K,t)),rt(t)}),D.on('click','#dice-return-normal-btn',function(t){t.preventDefault();let n=P;const e=Gt.getAllPresets(),a=e.find(t=>t.id===n);if(!a||!1===a.visible){const t=e.find(t=>!1!==t.visible);n=t?t.id:'__custom__'}'__custom__'===n?Gt.setActivePreset(null):Gt.setActivePreset(n),localStorage.setItem(K,n||'__custom__'),rt(n)}),D.on('click','.acu-dice-preset-action-btn',async function(t){t.preventDefault(),t.stopPropagation();const n=String($(this).data('action-id')||'').trim();if(!n)return;const e=$(this);if(!e.prop('disabled')){e.prop('disabled',!0).addClass('disabled');try{await ut(n)}finally{e.prop('disabled',!1).removeClass('disabled'),q(F)}}}),D.find('#dice-attr-value, #dice-modifier, #dice-target').on('input change',function(){q(F)});const ct=localStorage.getItem(K),st=Gt.getActivePreset();rt(st?st.id:ct&&'__custom__'!==ct?ct:'__custom__');const lt=function(t){if(!t||''===t.trim())return 0;const n=t.trim(),e=parseFloat(n);if(!isNaN(e)&&isFinite(e)&&n.match(/^-?\d+(\.\d+)?$/))return e;const a=gn(n);return Number.isNaN(a.total)?0:a.total},dt=t=>{const n=String(t.config.presetId||'').trim();if(!n)return void(window.toastr&&window.toastr.warning('快捷操作缺少目标预设'));if(!Gt.getAllPresets().find(t=>t.id===n))return void(window.toastr&&window.toastr.warning(`未找到预设: ${n}`));const e=!1!==t.config.carryInitiator,a=!1!==t.config.carryAttrName,o=!1!==t.config.carryAttrValue,i=!0===t.config.carryTarget,r=!0===t.config.carryModifier,c=!0===t.config.carrySkillMod,s={initiatorName:String(D.find('#dice-initiator-name').val()||'').trim(),attrName:String(D.find('#dice-attr-name').val()||'').trim(),attrValue:String(D.find('#dice-attr-value').val()||'').trim(),target:String(D.find('#dice-target').val()||'').trim(),modifier:String(D.find('#dice-modifier').val()||'').trim(),skillMod:String(D.find('#dice-skill-mod').val()||'').trim()};Gt.setActivePreset(n),localStorage.setItem(K,n),rt(n),e&&D.find('#dice-initiator-name').val(s.initiatorName),a?D.find('#dice-attr-name').val(s.attrName):void 0!==t.config.attrName&&D.find('#dice-attr-name').val(t.config.attrName),o&&D.find('#dice-attr-value').val(s.attrValue),i&&D.find('#dice-target').val(s.target),r&&D.find('#dice-modifier').val(s.modifier),c&&D.find('#dice-skill-mod').val(s.skillMod),t.config.customFieldValues&&Object.entries(t.config.customFieldValues).forEach(([t,n])=>{const e=D.find('.acu-dice-custom-field').filter((n,e)=>String($(e).data('id')||'')===t);e.length&&(e.is(':checkbox')?e.prop('checked',Boolean(n)):e.val(String(n)))}),D.find('#dice-attr-name').trigger('change'),D.find('#dice-attr-value, #dice-target, #dice-modifier, #dice-skill-mod').trigger('change')},ut=async t=>{const n=F;if(!n)return void(window.toastr&&window.toastr.warning('请先选择一个检定预设'));const e=L(n).find(n=>n.id===t);e?'workflow_shortcut'!==e.kind?'attr_shortcut'!==e.kind?window.toastr&&window.toastr.warning('暂不支持的快捷操作类型'):(t=>{const n=String(t.config.presetId||'').trim();if(!n)return void(window.toastr&&window.toastr.warning('属性快捷缺少目标预设'));const e=Gt.getAllPresets().find(t=>t.id===n);if(!e)return void(window.toastr&&window.toastr.warning(`属性快捷目标预设不存在: ${n}`));if(!1===e.visible)return void(window.toastr&&window.toastr.warning(`属性快捷目标预设不可用（工作流）: ${e.name}，已中止执行`));const a=Array.isArray(e.effectsConfig?.allowedTargets)?e.effectsConfig?.allowedTargets:[],o=Array.from(new Set([...t.config.attrAliasCandidates||[],...a].map(t=>String(t||'').trim()).filter(Boolean))),i={id:t.id,kind:'workflow_shortcut',icon:t.icon,tooltip:t.tooltip,condition:t.condition,config:{presetId:n,carryInitiator:t.config.carryInitiator,carryAttrName:!1,carryAttrValue:t.config.carryAttrValue,carryTarget:t.config.carryTarget,carryModifier:t.config.carryModifier,carrySkillMod:t.config.carrySkillMod}};dt(i);const r=String(D.find('#dice-initiator-name').val()||'').trim()||'<user>',c=o,s=String(t.config.fallbackAttrName||'').trim()||c[0]||'';if(!s)return;const l=Te(r,s,c).name||s;D.find('#dice-attr-name').val(l).trigger('change')})(e):dt(e):window.toastr&&window.toastr.warning('未找到快捷操作配置')},pt=(t,n)=>{const e=D.find('#dice-initiator-name').val().trim()||'<user>';Tt(e);let a=Fe(e,t.resourceName);if(null!=a)a=a||0,ft(t,e,a,n);else{if('幸运'===t.resourceName||'luck'===t.resourceName.toLowerCase()){const a=Math.floor(6*Math.random())+1,o=Math.floor(6*Math.random())+1,i=Math.floor(6*Math.random())+1,r=5*(a+o+i);return window.toastr&&window.toastr.info(`幸运值未设置，已随机生成: ${a}+${o}+${i}=${a+o+i} × 5 = ${r}`),void Le(e,t.resourceName,'set',r,{initValue:r}).then(e=>{e.success?pt(t,n):window.toastr&&window.toastr.error(`初始化幸运值失败: ${e.error}`)})}window.toastr&&window.toastr.error(`找不到属性: ${t.resourceName}`)}},ft=(t,e,a,o)=>{const i=`acu-theme-${n.theme}`;$('.acu-burner-overlay').remove();let r=1,c='';if(t.suggestedAmount){const n=bn(t.suggestedAmount,o);if(n.success&&'number'==typeof n.value&&n.value>0){const e=Math.ceil(n.value/t.ratio);if('add'===t.resourceOperation)r=Math.max(1,e),c=`建议: ${r} (刚好通过)`;else{r=Math.min(Math.max(1,e),a),c=e>a?`建议: ${r} (已达上限，仍无法通过)`:`建议: ${r} (刚好通过)`}}}const s='add'===t.resourceOperation,l=s?'增加':'消耗',d=s?'':`max="${a}"`,u=o['$roll.total']??o.$roll??0,p=o.$attr??0,f=$(`\n        <div class="acu-edit-overlay acu-burner-overlay">\n          <div class="acu-edit-dialog ${i}" style="max-width:350px;">\n            <div class="acu-edit-title">\n              <i class="fa-solid ${h(t.ui?.icon||'fa-fire')}" style="color:${h(t.ui?.color||'var(--acu-accent)')}"></i>\n              ${h(l)} ${h(t.resourceName)}\n            </div>\n            <div class="acu-settings-content" style="padding:15px;">\n              <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">\n                <div style="flex:1;">\n                  <label style="display:block;font-size:11px;color:var(--acu-text-sub);margin-bottom:4px;">${h(l)}数量</label>\n                  <input type="number" id="burner-amount" class="acu-input" value="${r}" min="1" ${d} style="width:100%;">\n                  ${c?`<div style="font-size:10px;color:var(--acu-accent);margin-top:2px;">${h(c)}</div>`:''}\n                </div>\n                <div style="flex:1;">\n                  <label style="display:block;font-size:11px;color:var(--acu-text-sub);margin-bottom:4px;">当前${s?'数值':'可用'}</label>\n                  <div style="font-size:18px;font-weight:bold;color:var(--acu-success-text);">${a}</div>\n                </div>\n              </div>\n              <div id="burner-preview" style="padding:10px;background:var(--acu-card-bg);border-radius:6px;font-size:12px;">\n                <div id="burner-before" style="color:var(--acu-text-sub);margin-bottom:6px;"></div>\n                <div id="burner-after" style="font-weight:bold;"></div>\n              </div>\n            </div>\n            <div class="acu-dialog-btns">\n              <button class="acu-dialog-btn" id="burner-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n              <button class="acu-dialog-btn acu-btn-confirm" id="burner-confirm"><i class="fa-solid fa-check"></i> 确认${h(l)}</button>\n            </div>\n          </div>\n        </div>\n      `);$('body').append(f);const g=()=>{const n=parseInt(f.find('#burner-amount').val(),10)||0,e=n*t.ratio;let a=u,o=p;'roll'===t.target?a='decrease'===t.direction?u-e:u+e:'attribute'===t.target&&(o='increase'===t.direction?p+e:p-e);const i=u<=p,r=a<=o,c=i?'var(--acu-success-text)':'var(--acu-error-text)',s=r?'var(--acu-success-text)':'var(--acu-error-text)';f.find('#burner-before').html(`当前: <span style="color:${c};font-weight:bold;">${u} &lt;= ${p} → ${i?'成功':'失败'}</span>`),f.find('#burner-after').html(`燃运后: <span style="color:${s}">${a} &lt;= ${o} → ${r?'成功':'失败'}</span><span style="color:var(--acu-text-sub);font-weight:normal;margin-left:8px;">(${l} ${n} 点${t.resourceName})</span>`)};g(),f.find('#burner-amount').on('input',g),f.on('click','#burner-cancel',()=>{f.remove()}),f.on('click','.acu-burner-overlay',t=>{$(t.target).hasClass('acu-burner-overlay')&&f.remove()}),f.on('click','#burner-confirm',()=>{const n=parseInt(f.find('#burner-amount').val(),10);if(isNaN(n)||n<=0)return void(window.toastr&&window.toastr.warning('请输入有效的正整数'));if(!s&&n>a)return void(window.toastr&&window.toastr.error(`资源不足: 需要 ${n}, 当前只有 ${a}`));f.remove();const o=s?'add':'subtract';Le(e,t.resourceName,o,n).then(a=>{a.success?(window.toastr&&window.toastr.success(`已${l} ${n} 点 ${t.resourceName}`),T(e),ht(t,n)):window.toastr&&window.toastr.error(`${l}资源失败: ${a.error}`)})}),f.find('#burner-amount').trigger('focus').trigger('select')},gt=t=>{const{preset:e,outcomeLabel:a,branchReasonText:o,effects:i,onConfirm:r,onCancel:c}=t,s=`acu-theme-${n.theme}`,l=e.effectConfirmUi||{},d=l.title||'确认效果执行',u=l.effectListTitle||'即将应用以下效果:',p=l.branchReasonLabel||'分支依据';$('.acu-confirm-overlay').remove();const f=$(`\n        <div class="acu-edit-overlay acu-confirm-overlay">\n          <div class="acu-edit-dialog ${s}" style="max-width:350px;">\n            <div class="acu-edit-title">\n              <i class="fa-solid fa-clipboard-check" style="color:var(--acu-accent)"></i>\n              ${h(d)}\n            </div>\n            <div class="acu-settings-content" style="padding:15px;">\n              <div style="margin-bottom:12px;font-weight:bold;font-size:14px;text-align:center;color:var(--acu-text-main);">\n                ${h(a)}\n              </div>\n              ${o?`<div style="margin-bottom:12px;padding:8px 10px;background:var(--acu-card-bg);border-radius:6px;font-size:12px;line-height:1.45;color:var(--acu-text-sub);"><span style="color:var(--acu-text-main);font-weight:bold;">${h(p)}:</span> ${h(o)}</div>`:''}\n\n              <div style="background:var(--acu-card-bg);border-radius:6px;padding:10px;margin-bottom:15px;max-height:200px;overflow-y:auto;">\n                <div style="font-size:12px;color:var(--acu-text-sub);margin-bottom:8px;">${h(u)}</div>\n                ${i.map(t=>`\n                  <div style="padding:8px 0;border-bottom:1px solid var(--acu-border);font-size:13px;display:grid;grid-template-columns:1fr auto;gap:6px 10px;align-items:start;">\n                    <div style="font-weight:bold;color:var(--acu-text-main);min-width:0;">${h(t.resolvedTarget||t.target)}</div>\n                    <div style="color:${t.computedValue>=0?'var(--acu-success-text)':'var(--acu-error-text)'};font-weight:bold;text-align:right;white-space:nowrap;">\n                      ${t.computedValue>0?'+':''}${t.computedValue}\n                    </div>\n                    <div style="grid-column:1 / -1;font-size:11px;color:var(--acu-text-sub);line-height:1.45;">\n                      算式: ${h(t.formula)} ｜ 掷值: ${h(String(t.rolledValue))}<br>\n                      数值: ${null===t.beforeValue||void 0===t.beforeValue?'未知':h(String(t.beforeValue))}\n                      →\n                      ${null===t.afterValue||void 0===t.afterValue?'未知':h(String(t.afterValue))}\n                      ${t.conditionSummary?`<br>条件: ${h(t.conditionSummary)}`:''}\n                    </div>\n                  </div>\n                `).join('')}\n              </div>\n            </div>\n            <div class="acu-dialog-btns">\n              <button class="acu-dialog-btn" id="confirm-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n              <button class="acu-dialog-btn acu-btn-confirm" id="confirm-ok"><i class="fa-solid fa-check"></i> 确认执行</button>\n            </div>\n          </div>\n        </div>\n      `);$('body').append(f),f.on('click','#confirm-cancel',()=>{f.remove(),c()}),f.on('click','.acu-confirm-overlay',t=>{$(t.target).hasClass('acu-confirm-overlay')&&(f.remove(),c())}),f.on('click','#confirm-ok',()=>{f.remove(),r()}),f.find('#confirm-ok').focus()},mt=(t,n,e)=>{if(!t.condition||''===t.condition.trim())return{conditionExpr:'',resolvedConditionExpr:'',conditionPassed:!0,conditionSummary:`命中【${e}】分支后直接生效`};const a=t.condition.trim(),o={$roll:n.roll,'$roll.total':n.roll,$attr:n.attributeValue,$mod:n.modifier,$dc:n.dc},i=bn(a,o),r=i.success&&('number'==typeof i.value?0!==i.value:Boolean(i.value)),c=a.replace(/\$roll\.total/g,String(n.roll)).replace(/\$roll/g,String(n.roll)).replace(/\$attr/g,String(n.attributeValue)).replace(/\$mod/g,String(n.modifier)).replace(/\$dc/g,String(n.dc));return{conditionExpr:a,resolvedConditionExpr:c,conditionPassed:r,conditionSummary:`命中【${e}】分支，条件 ${c}（原式:${a}）${r?'成立':'不成立'}`}},bt=async t=>{const{preset:n,matchedOutcome:e,context:a}=t;if(!e.effects||0===e.effects.length)return;if(R&&R.runId!==t.runId){const t=R;Q(t,{effectStatus:'cancelled',effectError:'确认弹窗被新的检定覆盖，自动取消',effectTrace:['已取消：被新操作覆盖']});const n=X({runId:t.runId,status:'cancelled',characterName:t.context.characterName,attributeName:t.context.attributeName,historyIndex:t.historyIndex,effectResults:[],effectTrace:['已取消：被新操作覆盖'],chainMode:G(t.preset),error:'确认弹窗被新的检定覆盖，自动取消',timestamp:Date.now()});Q(t,{effectEventSeq:n})}R=t;const o=e.effects.filter(t=>!1!==t.needsConfirm);if(0===o.length)return;const i=[...n.effectsConfig?.allowedTargets||[],a.attributeName].filter((t,n,e)=>Boolean(t)&&e.indexOf(t)===n),r=((t,n,e)=>{const a=[],o=D.find(`.acu-effect-value-input[data-outcome="${t}"]`),i=o.val()?.toString().trim()||'';for(const o of n){const n=p(i||String(o.value||'0'),`Confirm ${t}/${o.id}`);let r=n.finalValue;const c=n.rolledValue,s=n.valid?`${n.formulaText} → ${c}`:`${n.formulaText} → 解析失败(按0处理)`;'subtract'===o.operation&&(r=-Math.abs(r));const l=mt(o,e,t);a.push({effectId:o.id,target:o.target,computedValue:r,rolledValue:c,formula:n.formulaText,displayText:s,...l})}return a})(e.name,o,a).map(t=>{const n=Te(a.characterName,t.target,i).name,e=Fe(a.characterName,t.target,i),o=null==e?null:e+t.computedValue;return{...t,resolvedTarget:n||void 0,beforeValue:e,afterValue:o}});0!==r.length&&gt({preset:n,outcomeLabel:`${a.attributeName} 检定: ${e.name}`,branchReasonText:t.branchReasonText,effects:r,onConfirm:async()=>{const n={...t,effectOverrides:r,timestamp:Date.now()};nt(n),Q(t,{effectStatus:'confirmed'});const e=X({runId:t.runId,status:'confirmed',characterName:a.characterName,attributeName:a.attributeName,historyIndex:t.historyIndex,effectResults:[],effectTrace:['已确认，等待提交'],chainMode:G(t.preset),timestamp:Date.now()});Q(t,{effectEventSeq:e}),R?.runId===t.runId&&(R=null),console.info(`[DICE] Effect run confirmed: ${t.runId}`),n.messageId?await et(n.messageId):(console.info(`[DICE][META] confirm waiting MESSAGE_SENT for run=${n.runId}`),await et())},onCancel:()=>{Q(t,{effectStatus:'cancelled'});const n=X({runId:t.runId,status:'cancelled',characterName:a.characterName,attributeName:a.attributeName,historyIndex:t.historyIndex,effectResults:[],effectTrace:['已取消'],chainMode:G(t.preset),timestamp:Date.now()});Q(t,{effectEventSeq:n}),R?.runId===t.runId&&(R=null),console.info('[DICE] Effect execution cancelled by user')}})},ht=(t,n)=>{const e=n*t.ratio*('increase'===t.direction?1:-1);if('mod'===t.target){const t=D.find('#dice-modifier'),n=lt(t.val().trim())+e;t.val(n>=0?`+${n}`:String(n)),vt()}else if('dc'===t.target){const t=D.find('#dice-target'),n=parseInt(t.val().trim()||'0',10)+e;t.val(n),vt()}else if('attribute'===t.target){const t=D.find('#dice-attr-value'),n=parseInt(t.val().trim()||'0',10)+e;t.val(n),vt()}else if('roll'===t.target){const t=D.find('#dice-modifier'),n=lt(t.val().trim())+e;t.val(n>=0?`+${n}`:String(n)),vt()}},vt=async function(t){if(!F)return;const n=F,e=D.find('#dice-initiator-name').val().trim()||'<user>',a=D.find('#dice-attr-name').val().trim()||'自由检定',o=function(t,n){if(void 0===t)return 0;if('number'==typeof t)return t;const e=mn(t,n);return 0===e&&'0'!==t&&'0'!==String(t)&&window.toastr&&window.toastr.warning(`表达式 "${t}" 求值失败,使用默认值 0`),e||0};let i=0;const r=D.find('#dice-attr-value').val().trim();i=''!==r?parseInt(r,10)||0:'fixed'===n.attribute?.mode&&n.attribute?.key?Fe(e,n.attribute.key)||0:o(n.attribute?.defaultValue,{});let c=0;if(!n.dc?.hidden){const t=D.find('#dice-target').val().trim();c=''!==t?parseInt(t,10)||0:'fixed'===n.dc?.mode&&void 0!==n.dc?.value?n.dc.value:o(n.dc?.defaultValue,{$attr:i})}let s=0;if(!n.mod?.hidden){const t=D.find('#dice-modifier').val().trim();s=''!==t?lt(t):o(n.mod?.defaultValue,{$attr:i})}let l=0;if(n.skillMod&&!n.skillMod.hidden){const t=D.find('#dice-skill-mod').val().trim();l=''!==t?lt(t):o(n.skillMod?.defaultValue,{$attr:i})}let d=0;if('attribute'in n&&n.attribute?.computeModifier){const t=n.attribute.computeModifier;d=t.includes('floor')&&t.includes('$attr')?Math.floor((i-10)/2):o(t,{$attr:i})}const u={};if('customFields'in n&&Array.isArray(n.customFields)&&n.customFields.length>0){D.find('.acu-dice-custom-field').each(function(){const t=$(this),e=t.data('id'),a=n.customFields.find(t=>t.id===e);if(!a)return;let o;if('toggle'===a.type)o=t.prop('checked');else if('number'===a.type){const n=parseFloat(t.val());o=isNaN(n)?a.defaultValue:n}else if('select'===a.type){const n=t.val(),e=parseFloat(n);o=isNaN(e)?n:e}else{const n=String(t.val()??'').trim();o=''===n&&void 0!==a.defaultValue&&''!==a.defaultValue?a.defaultValue:n}u['$'+e]=o})}const p={$attr:i,$attrMod:d,$skillMod:l,$dc:c,$mod:s,...u},f={};'derivedVars'in n&&Array.isArray(n.derivedVars)&&n.derivedVars.length>0&&n.derivedVars.forEach(t=>{const n=t?.id?.trim();if(!n)return;const e=n.startsWith('$')?n:`$${n}`,a=bn(t.expr,{...p,...f});if(!a.success)return console.warn(`[DICE] 派生变量 ${e} 计算失败:`,a.error),void(f[e]=0);const o=a.value,i='number'==typeof o&&Number.isFinite(o)?o:o?1:0;f[e]=i});const g={...u,...f};let m=n.diceExpression;if('dicePatches'in n&&Array.isArray(n.dicePatches)&&n.dicePatches.length>0){const t={...p,...f},e=n=>n.replace(/\$[a-zA-Z_]\w*/g,n=>{const e=t[n];return'number'==typeof e&&Number.isFinite(e)?String(e):'0'});n.dicePatches.forEach(n=>{if(!n)return;if(n.when){const e=bn(n.when,t);if(!e.success)return void console.warn('[DICE] dicePatches 条件评估失败:',e.error);if(!('number'==typeof e.value?0!==e.value:Boolean(e.value)))return}const a=e(n.template??'');switch(n.op){case'append':m=`${m}${a}`;break;case'prepend':m=`${a}${m}`;break;case'replace':m=a}})}const v=gn(m),x=v.total,w={};if('derivedVars'in n&&Array.isArray(n.derivedVars)&&n.derivedVars.length>0){const t={$roll:v,'$roll.total':x,...p,...u};n.derivedVars.forEach(n=>{const e=n?.id?.trim();if(!e)return;const a=e.startsWith('$')?e:`$${e}`,o=bn(n.expr,{...t,...w});if(!o.success)return console.warn(`[DICE] 派生变量 ${a} (投骰后) 计算失败:`,o.error),void(w[a]=0);const i=o.value,r='number'==typeof i&&Number.isFinite(i)?i:i?1:0;w[a]=r})}const y=t?.isPushed??!1,k={$roll:v,'$roll.total':x,$isPushed:y?1:0,...p,...w};let E,A,S,I=!1,M='',N=!0,P='';if('outcomes'in n&&Array.isArray(n.outcomes)&&n.outcomes.length>0){S=hn(n.outcomes,k);const t=S;let e;if('minRank'===n.outcomePolicy?.kind){const t=n.outcomePolicy.requiredRankVarId,a=k[t.startsWith('$')?t:`$${t}`]??0,o=S.rank??0;if(a>0&&(e=n.outcomes.find(t=>t.rank===a)),o>=1&&o<a){const t=n.outcomePolicy.unmetOutcomeId,e=n.outcomes.find(n=>n.id===t);e&&(S=e)}}E=S.name||'判定完成';const a=S!==t&&e?e:S,o=a.displayExpr??a.condition;if(M=o,k.$roll&&'object'==typeof k.$roll){const t=k.$roll;M=M.replace(/\$roll\.hasTag\s*\(\s*['"]([^'"]+)['"]\s*\)/gi,(n,e)=>(t.tags??[]).includes(e)?'成立':'不成立')}M=M.replace(/\$roll\.total/g,String(x)).replace(/\$roll/g,String(x)).replace(/\$attrMod/g,String(d)).replace(/\$skillMod/g,String(l)).replace(/\$attr/g,String(i)).replace(/\$dc/g,String(c)).replace(/\$mod/g,String(s)),Object.keys(g).forEach(t=>{const n=t.replace('$','\\$'),e=new RegExp(n,'g');M=M.replace(e,String(g[t]))}),M=M.replace(/\s*\+\s*0(?=\s*[+\->=<]|\s*$)/g,'').replace(/^\s*0\s*\+\s*/g,'');const r=bn(o,k);N=r.success&&('number'==typeof r.value?0!==r.value:Boolean(r.value)),P=`命中【${S.name}】分支，分支判定式 ${M||o}，结果${N?'成立':'不成立'}`,S.priority<=10?(A='critSuccess',I=!0):S.priority<=30?(A='extremeSuccess',I=!0):S.priority<50?(A='success',I=!0):50===S.priority?(A='warning',I=!1):S.priority<90?(A='failure',I=!1):(A='critFailure',I=!1)}else E='未知',A='warning',P='未命中可识别分支，按默认路径处理',console.warn('[DICE] 预设缺少 outcomes');const j=kn(A),R=qt(),B=void 0!==R.hideDiceResultFromUser&&R.hideDiceResultFromUser,O=B?'？？':x,V=B?'':E,L=/(\&\&|\|\|)/.test(M)?'':M;const U=B?'':L,q=D.find('#dice-roll-btn');if(q.html(`\n        <div class="acu-dice-result-display">\n          <span class="acu-dice-result-value">${O}</span>\n          <span class="acu-dice-result-target" style="font-size: 11px;">${h(U)}</span>\n          ${V?`<span class="${j}">${V}</span>`:''}\n          <button class="dice-retry-btn acu-dice-retry-btn" title="重新投骰">\n            <i class="fa-solid fa-rotate-right"></i>\n          </button>\n        </div>\n      `),q.off('click','.dice-retry-btn').on('click','.dice-retry-btn',function(t){t.stopPropagation(),t.preventDefault(),vt()}),n.resourceBurners&&n.resourceBurners.length>0){const t={...k},e=((t,n,e,a)=>{if(!t.resourceBurners||!Array.isArray(t.resourceBurners)||0===t.resourceBurners.length)return'';let o='';return t.resourceBurners.forEach(t=>{if(a&&t.selector&&!it(a,t.selector))return;if(t.condition){const e=bn(t.condition,n);if(!e.success||('number'==typeof e.value?0===e.value:!e.value))return}const e=t.ui?.icon||'fa-fire',i=t.ui?.tooltip||`消耗 ${t.resourceName}`;o+=`<button class="acu-dice-burner-btn" data-id="${h(t.id)}" title="${h(i)}">\n          <i class="fa-solid ${h(e)}"></i>\n        </button>`}),o?`<div class="acu-dice-burners">${o}</div>`:''})(n,t,0,a);if(e){const a=$(e);q.find('.acu-dice-result-display').append(a),a.find('.acu-dice-burner-btn').on('click',function(e){e.stopPropagation(),e.preventDefault();const a=$(this).data('id'),o=n.resourceBurners?.find(t=>t.id===a);o&&pt(o,t)})}}if(n.pushedRoll?.enabled&&!y&&S&&!it(a,{namePatterns:{include:n.pushedRoll.excludePatterns??[]}})){const t=S.id,e=(n.pushedRoll.blockedOutcomes??(!1!==n.pushedRoll.blockOnCritFailure?['crit_failure']:[])).includes(t);if((n.pushedRoll.pushableOutcomes?n.pushedRoll.pushableOutcomes.includes(t):!I)&&!e){const t=$('\n           <button class="acu-dice-burner-btn" title="孤注一掷：重掷一次，失败后果更严重">\n             <i class="fa-solid fa-skull"></i>\n           </button>\n         ');let n=q.find('.acu-dice-burners');n.length||(n=$('<span class="acu-dice-burners"></span>'),q.find('.acu-dice-result-display').append(n)),n.append(t),t.on('click',function(t){t.stopPropagation(),t.preventDefault(),vt({isPushed:!0})})}}const Y=N?'成立':'不成立',W='outputTemplate'in n&&n.outputTemplate?n.outputTemplate:'<meta:检定结果>\n$outcomeText\n元叙事：$initiator 发起了 $attrName 检定，$formula=$roll，判定 $conditionExpr？$judgeResult，判定为【$outcomeName】\n</meta:检定结果>',H=y&&S?n.pushedRoll?.outcomeLabels?.[S.id]??n.pushedRoll?.outcomeLabels?.['*']??'':'',K=(H?H+'\n':'')+(S?.outputText??''),Q=d>=0?`+${d}`:String(d),tt=l>=0?`+${l}`:String(l),et=0!==l?`+技能加值${tt}`:'',at=0!==s?`+额外加值${s>=0?'+'+s:s}`:'',ot=0!==d?`(调整值${Q})`:'',rt={};Object.entries(w).forEach(([t,n])=>{const e=t.startsWith('$')?t.slice(1):t;rt[e]=n});const ct={};Object.entries(u).forEach(([t,n])=>{const e=t.startsWith('$')?t.slice(1):t;ct[e]=n});const st=function(t){if(!t||0===t.length)return{effectTarget:'',effectOperation:'',effectDelta:0,effectDeltaFormula:'',effectOldValue:0,effectNewValue:0,effectSummary:'',effectText:'',hasEffect:!1,effectCount:0,effectResults:'[]'};const n=t[0],e={add:'增加',subtract:'减少',set:'设置为'},a=e[n.operation]||n.operation,o=t.map(t=>{const n=e[t.operation]||t.operation;return`${t.target}: ${n} ${t.value}`});return{effectTarget:n.target,effectOperation:a,effectDelta:0,effectDeltaFormula:n.value,effectOldValue:0,effectNewValue:0,effectSummary:`${n.target} ${a} ${n.value}`,effectText:o.join('; '),hasEffect:!0,effectCount:t.length,effectResults:JSON.stringify(t.map(t=>({effectId:t.id,pending:!0})))}}(S?.effects),dt={initiator:e,attrName:`【${a}】`,attrValue:i,attrMod:Q,skillMod:tt,skillModText:et,modText:at,attrModText:ot,formula:m,roll:x,'roll.total':x,dc:c,mod:s,attr:i,conditionExpr:M,judgeResult:Y,outcomeName:E,outcomeText:K,...ct,...rt,...st};dt.outcomeText=vn(String(dt.outcomeText||''),dt);const ut=vn(W,dt);C(ut,'dice');const ft={success:I,total:x,target:c,outcomeText:E,attrName:a,criteria:'advanced',isAutoTarget:!1,formula:m},mt=`check_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,ht={...ft,timestamp:Date.now(),detailId:mt,initiatorName:e,historyType:'check',detailLines:[`发起者: ${e}`,`属性: ${a} (值=${i})`,`公式: ${m}`,`掷骰: ${x}`,`目标: ${c}`,`修正: attrMod=${Q}, skillMod=${tt}, mod=${s>=0?'+'+s:s}`,`判定: ${Y||E}`,`结果: ${E}`],...y?{isPushed:!0}:{}};Qa.push(ht),Qa.length>no&&Qa.shift(),co('check',ht);if(n.effectsConfig&&S&&S.effects&&S.effects.length>0&&it(a,{namePatterns:{include:n.effectsConfig.triggerPatterns}})){const t=Qa.length-1,o=`effect_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,r={characterName:e,attributeName:a,attributeValue:i,roll:v.total,modifier:s,dc:c},l={runId:o,historyIndex:t,preset:n,matchedOutcome:S,context:r,branchReasonText:P,timestamp:Date.now()};Z(t,{effectStatus:'planned',effectRunId:o,effectResults:[],effectError:void 0,effectTrace:void 0});const d=X({runId:o,status:'planned',characterName:e,attributeName:a,historyIndex:t,effectResults:[],effectTrace:['等待确认'],chainMode:G(n),timestamp:Date.now()});Z(t,{effectEventSeq:d});if(S.effects.some(t=>!1!==t.needsConfirm))bt(l),console.info(`[DICE] ${S.effects.length} effects pending user confirmation for ${e}`);else{nt(l),Z(t,{effectStatus:'confirmed'});const i=X({runId:o,status:'confirmed',characterName:e,attributeName:a,historyIndex:t,effectResults:[],effectTrace:['自动确认，等待提交'],chainMode:G(n),timestamp:Date.now()});Z(t,{effectEventSeq:i}),console.info(`[DICE] Queued ${S.effects.length} auto-execute effects for ${e}`)}}if(n.currentAttrAutoUpdate&&!1!==n.currentAttrAutoUpdate.enabled){const t=n.currentAttrAutoUpdate,o=t.when||'always';if('always'===o||'success'===o&&I||'failure'===o&&!I){const o={$roll:x,'$roll.total':x,$attr:i,$dc:c,$mod:s,$success:I?1:0,...u},r=((t,n)=>{let e=String(t||'0');return Object.entries(n).forEach(([t,n])=>{const a=t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');e=e.replace(new RegExp(a,'g'),String(n))}),e})(t.valueExpr,o),l=lt(r),d=t.aliasCandidates||[],p=Te(e,a,d).name||a,f=Fe(e,a,d),g=null==f?t.initValue??0:f;let m=g;m='add'===t.operation?g+l:'subtract'===t.operation?g-l:l;const b=t.min??0,h=t.max??1/0;m=Math.max(b,Math.min(h,m));const v=m-g,w={effectId:`auto_${t.operation}`,target:a,resolvedTarget:p,computedValue:v,rolledValue:l,formula:r||'0',displayText:`${r||'0'} → ${l}`,beforeValue:g,afterValue:m,conditionSummary:`命中【${S?.name||E}】分支后触发自动填表`};if(await new Promise(t=>{gt({preset:n,outcomeLabel:`${a} 检定: ${S?.name||E}`,branchReasonText:P,effects:[w],onConfirm:()=>t(!0),onCancel:()=>t(!1)})})){const n=await Le(e,a,t.operation,l,{initValue:t.initValue,min:t.min,max:t.max,aliasCandidates:d});if(n.success){const o=n.resolvedAttrName||a,i=n.newValue-n.oldValue,c=String(t.changeLabel||'').trim()||('add'===t.operation?'增加':'subtract'===t.operation?'减少':'设为'),s=String(r||'').trim(),d=String(l),u=s.replace(/\s+/g,''),p=s&&u!==d?`${s}=${d}`:s||d,f={attr:`【${o}】`,attrPlain:o,old:n.oldValue,new:n.newValue,delta:i,expr:s||d,rolled:l,operation:t.operation,changeLabel:c},g=String(t.outputTextTemplate||'').trim(),m=''!==g?vn(g,f).trim():`已填表：${o}从${n.oldValue}变为${n.newValue}，变化${c}${p}`,b=`autoupdate_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;J(b,[m])||C(m,'dice');const h=String(D.find('#dice-attr-name').val()||'').trim();h!==a&&h!==o||D.find('#dice-attr-value').val(String(n.newValue)).trigger('change'),T(e),window.toastr&&window.toastr.success(`已完成填表更新 ${o}: ${n.oldValue} -> ${n.newValue}`)}else window.toastr&&window.toastr.warning(`自动更新属性失败: ${n.error||'未知错误'}`)}else window.toastr&&window.toastr.info('已取消本次自动填表')}}b&&b(ft)},xt=function(){const t=D.find('#dice-roll-btn'),n=D.find('#custom-dice-expr').val().trim()||'1d100',e=D.find('#custom-judge-mode').val(),a=D.find('#custom-target-value').val().trim(),o=D.find('#dice-initiator-name').val().trim()||'<user>',i=D.find('#dice-attr-name').val().trim()||'自由检定',r=(t=>{const n=String(t).replace(/\s+/g,'');if(!n)return Number.NaN;const e=n.match(/[+-]?[^+-]+/g);if(!e)return Number.NaN;let a=0;for(const t of e){if(!t)continue;const n=t.startsWith('-')?-1:1,e=t.replace(/^[+-]/,'');if(!e)continue;const o=e.match(/^(\d*)d(\d+|F)([bp]\d+)?(r[o]?(?:[><!=]+)?\d*)?(!!?(?:[><!=]+\d+)?)?(kh\d+|kl\d+|dh\d+|dl\d+)?((?:[><!=]+)\d+)?$/i);if(o){const[,t,e,,,,i]=o,r=t?parseInt(t,10):1,c='F'===e.toUpperCase(),s=c?0:parseInt(e,10),l=c?0:(1+s)/2;let d=r;if(i){const t=i.slice(0,2),n=parseInt(i.slice(2),10);Number.isNaN(n)||('kh'===t||'kl'===t?d=Math.min(r,n):'dh'!==t&&'dl'!==t||(d=Math.max(0,r-n)))}a+=n*d*l;continue}const i=Number(e);if(Number.isNaN(i))return Number.NaN;a+=n*i}return a})(n),c=Number.isFinite(r)?Math.floor(r):null,s=''!==a?parseInt(a,10):c,l='none'!==e&&null!==s&&!isNaN(s),d=gn(n);if(isNaN(d.total))return void(window.toastr&&window.toastr.error(`骰子语法错误: ${n}`));const u=d.total;let p=!1,f='';if(l)switch(e){case'>=':p=u>=s,f=p?'成功':'失败';break;case'<=':p=u<=s,f=p?'成功':'失败';break;case'>':p=u>s,f=p?'成功':'失败';break;case'<':p=u<s,f=p?'成功':'失败';break;default:f=''}const g=Tt(o),m=i||'自由检定';let h;if(l){h=`<meta:检定结果>\n元叙事：${g} 发起了 【${m}】 检定，${n}=${u}，判定 ${`${u} ${e} ${s}`}？${p?'成立':'不成立'}，判定为【${f}】\n</meta:检定结果>`}else h=`<meta:检定结果>\n元叙事：${g} 发起了 【${m}】 检定，${n}=${u}\n</meta:检定结果>`;C(h,'dice');const v=l?p?'acu-dice-result-badge success':'acu-dice-result-badge failure':'',x=qt(),w=void 0!==x.hideDiceResultFromUser&&x.hideDiceResultFromUser,y=w?'？？':u,k=w?'':f;t.html(`\n        <div class="acu-dice-result-display">\n          <span class="acu-dice-result-value">${y}</span>\n          ${l&&k?`<span class="${v}">${k}</span>`:''}\n          <button class="dice-retry-btn acu-dice-retry-btn" title="重新投骰">\n            <i class="fa-solid fa-rotate-right"></i>\n          </button>\n        </div>\n      `),t.off('click','.dice-retry-btn').on('click','.dice-retry-btn',function(t){t.stopPropagation(),t.preventDefault(),xt()});const E={success:p,total:u,target:s??0,outcomeText:f,attrName:i,criteria:'custom',isAutoTarget:!1,formula:n},A=`check_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,S={...E,timestamp:Date.now(),detailId:A,initiatorName:o,historyType:'check',detailLines:[`发起者: ${o}`,`属性: ${i}`,`公式: ${n}`,`掷骰: ${u}`,l?`判定: ${u} ${e} ${s}`:'判定: 无',l?`结果: ${f}`:'结果: 仅掷骰']};Qa.push(S),Qa.length>no&&Qa.shift(),co('check',S),b&&b(E)};let wt=0;const yt=function(){const t=D.find('#dice-roll-btn'),n=Date.now();if(n-wt<100)return;if(wt=n,t.prop('disabled'))return;if(t.prop('disabled',!0).addClass('disabled'),setTimeout(()=>{t.prop('disabled',!1).removeClass('disabled')},100),F)return void vt();if(D.find('#acu-dice-custom-mode-fields').is(':visible'))return void xt();const e=D.find('#dice-formula').val().trim()||'1d100',a=D.find('#dice-modifier').val().trim()||'0',o=lt(a),i=D.find('#dice-attr-name').val().trim()||'自由检定',r=D.find('#dice-success-criteria').val()||'lte',c=D.find('#dice-difficulty').val()||'normal',s='gte'===r,l=qt(),d=l.difficultSuccessDiv||2,u=l.hardSuccessDiv||5,p=s?l.dndCritFail||1:l.critSuccessMax||5,f=s?l.dndCritSuccess||20:l.critFailMin||96;let g,m=D.find('#dice-target').val().trim(),h=D.find('#dice-attr-value').val().trim(),v=''!==h?parseInt(h,10):0,x=!1;const w=t=>{const n=t.match(/(\d+)d(\d+)/i);if(n){const t=parseInt(n[1],10)*parseInt(n[2],10);return Math.round(t/2)}return 50};if(''!==m){const t=parseInt(m,10);g=Number.isNaN(t)?w(e):t}else s?(g=10,x=!0):v>0?(g=v,x=!0):(g=w(e),x=!0);const y=(t=>{const n=gn(t).total;if(Number.isNaN(n))return{total:0,rolls:[],formula:t};const e=t.match(/^(\d*)d(\d+|F)/i),a=e&&e[1]?parseInt(e[1],10):1,o=e?e[2]:'100';return{total:n,rolls:[],sides:'F'===o.toUpperCase()?3:parseInt(o,10),count:a,modifier:0,formula:t}})(e),k=y.total+o;let E=g,A='',S=1;if(!s)switch(c){case'hard':E=Math.floor(g/d),A='困难',S=d;break;case'extreme':E=Math.floor(g/u),A='极难',S=u;break;case'critical':E=p,A='大成功';break;default:A=''}let I=!1,M=!1,T=!1,N='',P='';if(s?(I=k>=f,M=k<=p):(I=k<=p,M=k>=f),T=s?k>=E:k<=E,I)N='大成功！',P='success',T=!0;else if(M)N='大失败！',P='failure',T=!1;else if(T){if(s)N='成功';else if('hard'===c)N='困难成功';else if('extreme'===c)N='极难成功';else{const t=Math.floor(g/u),n=Math.floor(g/d);N=k<=t?'极难成功':k<=n?'困难成功':'成功'}P='success'}else N='失败',P='failure';const j=s?'≥':'≤',R=void 0!==l.hideDiceResultFromUser&&l.hideDiceResultFromUser,B=R?'？？':k,O=R?'':N;let V;V=I?'critSuccess':M?'critFailure':T?'extreme'===c||'normal'===c&&k<=Math.floor(g/u)?'extremeSuccess':'hard'===c||'normal'===c&&k<=Math.floor(g/d)?'success':'warning':'failure';const L=kn(V),U=R?'':W,q=D.find('#dice-roll-btn');q.html(`\n        <div class="acu-dice-result-display">\n          <span class="acu-dice-result-value">${B}</span>\n          ${U?`<span class="acu-dice-result-target">${U}</span>`:''}\n          ${O?`<span class="${L}">${O}</span>`:''}\n          <button class="dice-retry-btn acu-dice-retry-btn" title="重新投骰">\n            <i class="fa-solid fa-rotate-right"></i>\n          </button>\n        </div>\n      `),q.off('click','.dice-retry-btn').on('click','.dice-retry-btn',function(t){t.stopPropagation(),t.preventDefault(),yt()});const Y=D.find('#dice-initiator-name').val().trim()||'<user>';let W='';W=I?s?`${k}≥${f}`:`${k}≤${p}`:M?s?`${k}≤${p}`:`${k}≥${f}`:s?`${k}≥${E}`:`${k}≤${E}`;let J='';if(I)J=s?`${k}≥${f}`:`${k}≤${p}`;else if(M)J=s?`${k}≤${p}`:`${k}≥${f}`;else if(s)J=T?`需${j}${E}，${k}≥${E}`:`需${j}${E}，${k}<${E}`;else if('critical'===c)J=`需≤${p}，${k}>${p}`;else if('normal'!==c)J=T?`需≤${g}/${S}，${k}≤${E}`:`需≤${g}/${S}，${k}>${E}`;else if(T){const t=Math.floor(g/u),n=Math.floor(g/d);J=k<=t?`需≤${g}，${k}≤${g}/${u}`:k<=n?`需≤${g}，${k}≤${g}/${d}`:`需≤${g}，${k}≤${g}`}else J=`需≤${g}，${k}>${g}`;C(`<meta:检定结果>\n${`元叙事：${Y}发起了【${i}】检定，掷出${k}，${J}，【${N}】`}\n</meta:检定结果>`,'dice');const H={success:T,total:k,target:g,outcomeText:N,attrName:i,criteria:r,isAutoTarget:x,formula:e},X=`check_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,K={...H,timestamp:Date.now(),detailId:X,initiatorName:Y,historyType:'check',detailLines:[`发起者: ${Y}`,`属性: ${i}`,`公式: ${e}`,`掷骰+修正: ${y.total} ${o>=0?'+':''}${o} = ${k}`,`目标: ${E} (${x?'自动计算':'手动输入'})`,`成功标准: ${'gte'===r?'>=':'<='}${E}`,A?`难度: ${A}`:'难度: 普通',`判定详情: ${J}`,`结果: ${N}`]};Qa.push(K),Qa.length>no&&Qa.shift(),co('check',K),b&&b(H)};D.find('#dice-roll-btn').click(function(){yt()}),D.find('#dice-switch-contest-top').click(function(){D.find('#dice-target').val().trim();const t=D.find('#dice-attr-value').val().trim(),n=D.find('#dice-formula').val()||'1d100',e=D.find('#dice-initiator-name').val().trim();$t(),He({initiatorName:e&&'<user>'!==e?e:'',initiatorValue:''!==t?parseInt(t,10):void 0,diceType:n})}),D.find('#dice-history-btn').click(function(t){t.stopPropagation(),ro()});const $t=()=>{A.remove(),D.remove()};D.on('click',t=>{t.stopPropagation()}),A.click($t),D.find('.acu-dice-close').click($t),D.find('.acu-dice-config-btn').click(function(t){t.stopPropagation(),Ra({fromDicePanel:!0})})},Je=function(t,n,e){return 100===e?t<=5?{level:3,name:'大成功',color:'var(--acu-crit-success-text)'}:t>=96?{level:-1,name:'大失败',color:'var(--acu-crit-failure-text)'}:t<=Math.floor(n/5)?{level:2,name:'极难成功',color:'var(--acu-extreme-success-text)'}:t<=Math.floor(n/2)?{level:1,name:'困难成功',color:'var(--acu-success-text)'}:t<=n?{level:0,name:'普通成功',color:'var(--acu-warning-text)'}:{level:-1,name:'失败',color:'var(--acu-failure-text)'}:20===t?{level:3,name:'大成功',color:'var(--acu-crit-success-text)'}:1===t?{level:-1,name:'大失败',color:'var(--acu-crit-failure-text)'}:t>=n?{level:0,name:'成功',color:'var(--acu-success-text)'}:{level:-1,name:'失败',color:'var(--acu-failure-text)'}},He=(t={})=>{const{$}=le();$('.acu-dice-panel, .acu-dice-overlay, .acu-contest-panel, .acu-contest-overlay').remove();const n=ca();let e=qt().lastDiceType||'1d100';Number.isNaN(gn(e).total)&&(e='1d100');const a=t.opponentName||'',o=t.diceType||e,i=t.initiatorName||'',r=t.initiatorValue,c=t.opponentValue,s=Yn||pa();let l=[],d=[],u=['<user>'];if(s)for(const t in s){const n=s[t];if(n&&'重要人物表'===n.name&&n.content){for(let t=1;t<n.content.length;t++){const e=n.content[t];e&&e[1]&&u.push(e[1])}break}}let p=[];if(s)for(const t in s){const n=s[t];if(n&&'主角信息'===n.name&&n.content&&n.content[1]){const t=n.content[0]||[],e=n.content[1];t.forEach((t,n)=>{if(t&&t.includes('属性')){In(e[n]||'').forEach(t=>{p.includes(t.name)||p.push(t.name)})}});break}}if(s)for(const t in s){const n=s[t];if(n&&n.name&&n.content){if('主角信息'===n.name&&n.content[1]){const t=n.content[1][7]||'';l=In(t)}if('重要人物表'===n.name&&a)for(let t=1;t<n.content.length;t++){const e=n.content[t];if(e&&e[1]===a){const t=e[9]||'';d=In(t);break}}}}const f=(t,n)=>{let e='';for(let a=0;a<t.length;a++){const o=t[a];e+='<button class="acu-contest-attr-btn" data-val="'+o.value+'" data-aname="'+h(o.name)+'" data-type="'+n+'">'+h(o.name)+': '+o.value+'</button>'}return e+='<button class="acu-contest-gen-attr-btn" data-type="'+n+'" title="生成属性"><i class="fa-solid fa-dice"></i></button>',e+='<button class="acu-contest-clear-attr-btn" data-type="'+n+'" title="清空规则属性"><i class="fa-solid fa-trash-alt"></i></button>',e},g=Gt.getAllPresets().filter(t=>!1!==t.visible).filter(t=>Gt.supportsContest(t)).sort((t,n)=>(t.order||0)-(n.order||0)),m=Gt.getActivePreset(),b=m&&Gt.supportsContest(m)?m.id:null,v=$('<div class="acu-contest-overlay"></div>'),x='<div class="acu-contest-panel acu-theme-'+n.theme+'"><div class="acu-dice-panel-header"><div class="acu-dice-panel-title"><i class="fa-solid fa-people-arrows"></i> 对抗检定</div><div class="acu-dice-panel-actions"><button id="contest-switch-normal" class="acu-dice-panel-action-btn" title="切换到普通检定"><i class="fa-solid fa-dice-d20"></i></button><button id="contest-history-btn" class="acu-dice-panel-action-btn" title="检定历史"><i class="fa-solid fa-history"></i></button><button class="acu-contest-config-btn acu-dice-panel-action-btn" title="掷骰规则设置"><i class="fa-solid fa-cog"></i></button><button class="acu-contest-close acu-dice-panel-action-btn"><i class="fa-solid fa-times"></i></button></div></div><div class="acu-dice-panel-body"><div class="acu-dice-section-title"><span><i class="fa-solid fa-sliders"></i> 检定规则</span></div><div class="acu-dice-presets"><button class="acu-dice-quick-preset-btn" data-dice="custom" style="order: -999;">自定义</button>'+g.map(t=>'<button class="acu-dice-quick-preset-btn'+(t.id===b?' active':'')+'" data-dice="'+h(t.diceExpression||'1d100')+'" data-criteria="'+h(t.successCriteria||'lte')+'" data-preset-id="'+h(t.id)+'">'+h(t.name)+'</button>').join('')+'</div><input type="hidden" id="contest-dice-type" value="'+o+'"><div class="acu-dice-section-title"><span><i class="fa-solid fa-user"></i> 发起方</span><div id="contest-init-char-buttons" class="acu-dice-quick-inline"></div></div><div id="contest-init-primary-row" class="acu-dice-form-row cols-2"><div><div class="acu-dice-form-label">名字</div><input type="text" class="acu-dice-input" id="contest-init-display" value="" placeholder="<user>"></div><div><div class="acu-dice-form-label"><span class="contest-attr-name-text">属性名</span><button type="button" class="acu-random-skill-btn" id="contest-init-random-skill" title="随机技能"><i class="fa-solid fa-dice"></i></button></div><input type="text" class="acu-dice-input" id="contest-init-name" value="" placeholder="自由检定"></div></div><div id="contest-init-dice-syntax-row" class="acu-dice-form-row cols-2" style="display: none;"><div><div class="acu-dice-form-label">骰子语法</div><input type="text" id="contest-custom-dice-init" class="acu-dice-input" value="" placeholder="留空=1d100, 1d20+5..."></div><div></div></div><div id="contest-init-values-row" class="acu-dice-form-row cols-3"><div id="contest-init-attr-wrapper"><div class="acu-dice-form-label" id="contest-init-attr-label">属性值</div><input type="text" class="acu-dice-input" id="contest-init-value" value="'+(void 0!==r?r:'')+'" placeholder="留空=50%最大值"></div><div id="contest-init-skill-mod-wrapper" style="display:none;"><div class="acu-dice-form-label" id="contest-init-skill-mod-label">技能加值</div><input type="text" class="acu-dice-input" id="contest-init-skill-mod" placeholder="留空=0"></div><div id="contest-init-mod-wrapper"><div class="acu-dice-form-label" id="contest-init-mod-label">修正值</div><input type="text" class="acu-dice-input" id="contest-init-mod" placeholder="留空=0"></div><div id="contest-init-target-wrapper"><div class="acu-dice-form-label" id="contest-init-target-label">目标值</div><input type="text" class="acu-dice-input" id="contest-init-target" value="" placeholder="自动"></div></div><div id="contest-init-custom-fields"></div><div id="init-attr-buttons" class="acu-dice-quick-compact">'+f(l,'init')+'</div><div class="acu-dice-section-title"><span><i class="fa-solid fa-user"></i> 对抗方</span><div id="contest-opp-char-buttons" class="acu-dice-quick-inline"></div></div><div id="contest-opp-primary-row" class="acu-dice-form-row cols-2"><div><div class="acu-dice-form-label">名字</div><input type="text" class="acu-dice-input" id="contest-opponent-display" value="'+h(a)+'" placeholder="对手"></div><div><div class="acu-dice-form-label"><span class="contest-attr-name-text">属性名</span><button type="button" class="acu-random-skill-btn" id="contest-opp-random-skill" title="随机技能"><i class="fa-solid fa-dice"></i></button></div><input type="text" class="acu-dice-input" id="contest-opp-name" value="" placeholder="同发起方"></div></div><div id="contest-opp-dice-syntax-row" class="acu-dice-form-row cols-2" style="display: none;"><div><div class="acu-dice-form-label">骰子语法</div><input type="text" id="contest-custom-dice-opp" class="acu-dice-input" value="" placeholder="留空=同发起方"></div><div></div></div><div id="contest-opp-values-row" class="acu-dice-form-row cols-3"><div id="contest-opp-attr-wrapper"><div class="acu-dice-form-label" id="contest-opp-attr-label">属性值</div><input type="text" class="acu-dice-input" id="contest-opp-value" value="'+(void 0!==c?c:'')+'" placeholder="留空=50%最大值"></div><div id="contest-opp-skill-mod-wrapper" style="display:none;"><div class="acu-dice-form-label" id="contest-opp-skill-mod-label">技能加值</div><input type="text" class="acu-dice-input" id="contest-opp-skill-mod" placeholder="留空=0"></div><div id="contest-opp-mod-wrapper"><div class="acu-dice-form-label" id="contest-opp-mod-label">修正值</div><input type="text" class="acu-dice-input" id="contest-opp-mod" placeholder="留空=0"></div><div id="contest-opp-target-wrapper"><div class="acu-dice-form-label" id="contest-opp-target-label">目标值</div><input type="text" class="acu-dice-input" id="contest-opp-target" value="" placeholder="自动"></div></div><div id="contest-opp-custom-fields"></div><div id="opp-attr-buttons" class="acu-dice-quick-compact">'+f(d,'opp')+'</div><div id="contest-custom-judge-row" class="acu-dice-form-row cols-2" style="display: none; margin-top: 8px;"><div><div class="acu-dice-form-label">判定规则</div><select id="contest-custom-judge-rule" class="acu-dice-select"><option value="higher">值大者胜</option><option value="lower">值小者胜</option><option value="rank">成功等级比较</option><option value="none">仅显示结果</option></select></div><div><div class="acu-dice-form-label">平手规则</div><select id="contest-custom-tie-rule" class="acu-dice-select"><option value="initiator_lose">发起者失败</option><option value="tie" selected>平手</option><option value="initiator_win">发起者胜利</option></select></div></div><div id="contest-result-display" class="acu-contest-result-display"><div class="acu-contest-result-inner"><div id="contest-result-init" class="acu-contest-result-side"></div><span class="acu-contest-vs">VS</span><div id="contest-result-opp" class="acu-contest-result-side right"></div></div></div><button id="contest-roll-btn" class="acu-dice-roll-btn"><i class="fa-solid fa-dice"></i> 开始对抗！</button></div></div>',w=$(x);v.append(w),$('body').append(v);const y=t=>{const n='init'===t?'#contest-init-char-buttons':'#contest-opp-char-buttons',e=w.find(n);let a='';u.forEach(n=>{const e='<user>'===n?n:Bt.resolve(String(n)),o='<user>'===e?zt():Tt(String(e)),i=o.length>4?o.substring(0,4)+'..':o;a+='<button class="acu-dice-char-btn" data-char="'+h(String(e))+'" data-type="'+t+'" title="'+h(o)+'">'+h(i)+'</button>'}),e.html(a),e.find('.acu-dice-char-btn').click(function(t){t.preventDefault(),t.stopPropagation();const n=$(this).data('char');'init'===$(this).data('type')?w.find('#contest-init-display').val(n).trigger('change'):w.find('#contest-opponent-display').val(n).trigger('change')})},k=(t,n)=>{const e='init'===n?'#init-attr-buttons':'#opp-attr-buttons',a=w.find(e);a.show();let o='';t.length>0&&t.forEach(t=>{o+='<button class="acu-contest-attr-btn" data-val="'+t.value+'" data-aname="'+h(t.name)+'" data-type="'+n+'">'+h(t.name)+':'+t.value+'</button>'}),o+='<button class="acu-contest-gen-attr-btn" data-type="'+n+'" title="生成属性"><i class="fa-solid fa-dice"></i></button>',o+='<button class="acu-contest-clear-attr-btn" data-type="'+n+'" title="清空规则属性"><i class="fa-solid fa-trash-alt"></i></button>',a.html(o),a.find('.acu-contest-attr-btn').click(function(){const t=$(this).attr('data-val'),n=$(this).attr('data-aname');if('init'===$(this).attr('data-type')){const e=I('init',n||'');w.find(e).val(t),w.find('#contest-init-name').val(n),w.find(e).trigger('change')}else{const e=I('opp',n||'');w.find(e).val(t),w.find('#contest-opp-name').val(n),w.find(e).trigger('change')}}),a.find('.acu-contest-gen-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const n=$(this);if(n.prop('disabled'))return;const e=n.attr('data-type');n.prop('disabled',!0).css('opacity','0.5');const a=n.html();n.html('<i class="fa-solid fa-spinner fa-spin"></i>');const o=ee.handleUpdate;ee.handleUpdate=()=>{console.log('[DICE]ACU 对抗属性生成中，跳过自动刷新')};try{let t;if(t='init'===e?w.find('#contest-init-display').val().trim()||'<user>':w.find('#contest-opponent-display').val().trim(),!t)return void(window.toastr&&window.toastr.warning('请先选择角色'));console.log('[DICE]ACU 对抗面板生成属性 for:',t,'type:',e);const n=Be(),a=n.base||n,o=n.special||{};if((await Ve(t,a,!1,o)).success){const n=Ue(t);k(n,e)}}catch(t){console.error('[DICE]ACU 对抗面板生成属性失败:',t),window.toastr&&window.toastr.error('生成属性失败')}finally{ee.handleUpdate=o,n.prop('disabled',!1).css('opacity','1').html(a)}}),a.find('.acu-contest-clear-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const n=$(this);if(n.prop('disabled'))return;const e=n.attr('data-type');let a;if(a='init'===e?w.find('#contest-init-display').val().trim()||'<user>':w.find('#contest-opponent-display').val().trim(),!a)return void(window.toastr&&window.toastr.warning('请先选择角色'));n.prop('disabled',!0).css('opacity','0.5');const o=n.html();n.html('<i class="fa-solid fa-spinner fa-spin"></i>');const i=ee.handleUpdate;ee.handleUpdate=()=>{console.log('[DICE]ACU 清空属性中，跳过自动刷新')};try{console.log('[DICE]ACU 对抗面板清空属性 for:',a,'type:',e);if((await Oe(a)).success){const t=Ue(a);k(t,e)}}catch(t){console.error('[DICE]ACU 对抗面板清空属性失败:',t),window.toastr&&window.toastr.error('清空属性失败')}finally{ee.handleUpdate=i,n.prop('disabled',!1).css('opacity','1').html(o)}})};y('init'),y('opp'),w.find('#contest-init-random-skill').click(function(t){t.preventDefault(),t.stopPropagation();const n=je();var e=n[Math.floor(Math.random()*n.length)];w.find('#contest-init-name').val(e).trigger('change')}),w.find('#contest-opp-random-skill').click(function(t){t.preventDefault(),t.stopPropagation();const n=je();var e=n[Math.floor(Math.random()*n.length)];w.find('#contest-opp-name').val(e).trigger('change')});const E=Ue(i||'<user>');k(E,'init');const A=Ue(a||'');k(A,'opp'),qe(w.find('#contest-init-display'),u),qe(w.find('#contest-opponent-display'),u),qe(w.find('#contest-init-name'),p),qe(w.find('#contest-opp-name'),p),Ye(w,'#contest-init-display, #contest-init-name, #contest-init-value, #contest-init-skill-mod, #contest-init-mod, #contest-init-target, #contest-opponent-display, #contest-opp-name, #contest-opp-value, #contest-opp-skill-mod, #contest-opp-mod, #contest-opp-target, #contest-custom-dice-init, #contest-custom-dice-opp');let S=null;const I=(t,n)=>{let e='init'===t?'#contest-init-value':'#contest-opp-value';const a=S?.attrTargetMapping;if(!a||!n)return e;for(const[o,i]of Object.entries(a))if(Array.isArray(i)&&i.includes(n)){'skillMod'===o?e='init'===t?'#contest-init-skill-mod':'#contest-opp-skill-mod':'mod'===o?e='init'===t?'#contest-init-mod':'#contest-opp-mod':'attribute'===o&&(e='init'===t?'#contest-init-value':'#contest-opp-value');break}return e},D=t=>{const n=w.find('#contest-init-values-row'),e=w.find('#contest-opp-values-row'),a=w.find('#contest-init-primary-row'),o=w.find('#contest-opp-primary-row'),i=w.find('#contest-init-custom-fields'),r=w.find('#contest-opp-custom-fields'),c=w.find('#contest-init-attr-wrapper'),s=w.find('#contest-init-skill-mod-wrapper'),l=w.find('#contest-init-mod-wrapper'),d=w.find('#contest-init-target-wrapper'),u=w.find('#contest-opp-attr-wrapper'),p=w.find('#contest-opp-skill-mod-wrapper'),f=w.find('#contest-opp-mod-wrapper'),g=w.find('#contest-opp-target-wrapper'),m=w.find('#contest-init-attr-label'),b=w.find('#contest-init-skill-mod-label'),v=w.find('#contest-opp-attr-label'),x=w.find('#contest-opp-skill-mod-label'),y=w.find('#contest-init-target-label'),k=w.find('#contest-opp-target-label'),C=w.find('#contest-init-mod-label'),E=w.find('#contest-opp-mod-label'),A=w.find('#contest-init-value'),I=w.find('#contest-opp-value'),D=w.find('#contest-init-skill-mod'),M=w.find('#contest-opp-skill-mod'),T=w.find('#contest-init-mod'),N=w.find('#contest-opp-mod'),F=(t,n)=>{t.removeClass('cols-2 cols-3'),n<=2?t.addClass('cols-2'):t.addClass('cols-3')},P=(t,n,e='')=>{const a=String(t.id||''),o=String(t.label||a),i=String(t.type||'text');let r=`<div class="${e}">`;if(r+='toggle'!==i?`<div class="acu-dice-form-label">${h(o)}</div>`:'<div class="acu-dice-form-label">&nbsp;</div>','select'===i&&Array.isArray(t.options))r+=`<select class="acu-dice-select acu-dice-custom-field-contest" data-id="${h(a)}" data-party="${n}">`,t.options.forEach(n=>{const e=n,a=e.value,o=a===t.defaultValue?'selected':'';r+=`<option value="${h(String(a??''))}" ${o}>${h(String(e.label??a??''))}</option>`}),r+='</select>';else if('toggle'===i){const e=t.defaultValue?'checked':'';r+=`<label style="display: flex; align-items: center; cursor: pointer; height: 32px;">\n            <input type="checkbox" class="acu-dice-custom-field-contest" data-id="${h(a)}" data-party="${n}" ${e} style="margin-right: 8px;">\n            ${h(o)}\n          </label>`}else{const e='number'===i?'number':'text',o=t.defaultValue,c=String(t.placeholder||'')||(void 0!==o&&''!==o?`留空=${o}`:'');r+=`<input type="${e}" class="acu-dice-input acu-dice-custom-field-contest" data-id="${h(a)}" data-party="${n}" placeholder="${h(c)}">`}return r+='</div>',$(r)},j=(t,n,e)=>{if(t.empty(),!('customFields'in e)||!Array.isArray(e.customFields)||0===e.customFields.length)return;const a=e.customFields.map(t=>({...t,...t.contestOverride})).filter(t=>!t.hidden);if(0===a.length)return;const o=a.map(t=>P(t,n).prop('outerHTML')),i=t=>t<=0?[]:t<=2?[2]:3===t?[3]:4===t?[2,2]:5===t?[2,3]:6===t?[3,3]:[...i(t-3),3],r=i(o.length);let c=0;for(const n of r){const e=$(`<div class="acu-dice-form-row cols-${n}"></div>`);for(let t=0;t<n;t++)c<o.length?(e.append(o[c]),c++):e.append('<div></div>');t.append(e)}},R=()=>{m.text('属性值'),v.text('属性值'),b.text('技能加值'),x.text('技能加值'),y.text('目标值'),k.text('目标值'),C.text('修正值'),E.text('修正值'),w.find('.contest-attr-name-text').text('属性名'),c.show(),u.show(),s.hide(),p.hide(),d.show(),g.show(),l.show(),f.show(),A.attr('placeholder','留空=50%最大值'),I.attr('placeholder','留空=50%最大值'),D.attr('placeholder','留空=0'),M.attr('placeholder','留空=0'),T.attr('placeholder','留空=0'),N.attr('placeholder','留空=0');const t=(t,n,e,a,o)=>{t.children().not(n).not(e).not(a).not(o).remove(),n.parent()[0]!==t[0]&&n.detach().appendTo(t),e.parent()[0]!==t[0]&&e.detach().appendTo(t),a.parent()[0]!==t[0]&&a.detach().appendTo(t),o.parent()[0]!==t[0]&&o.detach().appendTo(t),t.append(n.detach()),t.append(e.detach()),t.append(a.detach()),t.append(o.detach())};t(n,c,s,l,d),t(e,u,p,f,g),F(n,3),F(e,3),a.find('.acu-contest-inline-custom').remove(),o.find('.acu-contest-inline-custom').remove(),F(a,2),F(o,2),i.empty(),r.empty()};if(!t)return S=null,void R();const B=Gt.getAllPresets().find(n=>n.id===t);if(!B)return console.warn('[DICE] 对抗检定未找到预设:',t),void R();S=B,R();const O=B.attribute?.label||'属性值',V=B.skillMod?.label||'技能加值',L=B.dc?.label||'目标值',U=B.mod?.label||'修正值',q=B.attribute?.placeholder||'留空=50%最大值',Y=B.skillMod?.placeholder||'留空=0',W=B.mod?.placeholder||'留空=0';m.text(O),v.text(O),b.text(V),x.text(V),y.text(L),k.text(L),C.text(U),E.text(U),w.find('.contest-attr-name-text').text(B.attributeName?.label||'属性名'),A.attr('placeholder',q),I.attr('placeholder',q),D.attr('placeholder',Y),M.attr('placeholder',Y),T.attr('placeholder',W),N.attr('placeholder',W);const J=!0===B.contestRule?.hideDc||!0===B.dc?.hidden,H=!0===B.contestRule?.hideMod||!0===B.mod?.hidden,X=!B.skillMod||!0===B.contestRule?.hideSkillMod||!0===B.skillMod.hidden;c.show(),u.show(),X?(s.hide(),p.hide()):(s.show(),p.show()),J?(d.hide(),g.hide()):(d.show(),g.show()),H?(l.hide(),f.hide()):(l.show(),f.show());const K='customFields'in B&&Array.isArray(B.customFields)?B.customFields.map(t=>({...t,...t.contestOverride})).filter(t=>!t.hidden):[],G=K.length;let Z=1;X||Z++,H||Z++,J||Z++;const Q=Z+G;if(1===G&&3===Z){const t=K[0],c=(n,e)=>{n.find('.acu-contest-inline-custom').remove(),F(n,3),n.append(P(t,e,'acu-contest-inline-custom'))};c(a,'init'),c(o,'opp'),F(n,3),F(e,3),i.empty(),r.empty()}else if(a.find('.acu-contest-inline-custom').remove(),o.find('.acu-contest-inline-custom').remove(),F(a,2),F(o,2),Q<=4&&G>0&&Z<3){i.empty(),r.empty();const t=(t,n)=>{const e='init'===n?c:u,a='init'===n?l:f,o='init'===n?d:g,m=[],b='init'===n?s:p;if([e,b,a,o].forEach(t=>{t.length>0&&t.parent().length>0&&t.detach()}),m.push(e),X||m.push(b),H||m.push(a),J||m.push(o),'customFields'in B&&Array.isArray(B.customFields)){B.customFields.map(t=>({...t,...t.contestOverride})).filter(t=>!t.hidden).forEach(t=>{let e='<div>';if('toggle'!==t.type?e+=`<div class="acu-dice-form-label">${h(t.label||t.id)}</div>`:e+='<div class="acu-dice-form-label">&nbsp;</div>','select'===t.type&&t.options)e+=`<select class="acu-dice-select acu-dice-custom-field-contest" data-id="${h(t.id)}" data-party="${n}">`,t.options.forEach(n=>{const a=n.value===t.defaultValue?'selected':'';e+=`<option value="${h(String(n.value))}" ${a}>${h(n.label)}</option>`}),e+='</select>';else if('toggle'===t.type){const a=t.defaultValue?'checked':'';e+=`<label style="display: flex; align-items: center; cursor: pointer; height: 32px;">\n                  <input type="checkbox" class="acu-dice-custom-field-contest" data-id="${h(t.id)}" data-party="${n}" ${a} style="margin-right: 8px;">\n                  ${h(t.label||t.id)}\n                </label>`}else{const a='number'===t.type?'number':'text',o=t.defaultValue,i=t.placeholder||(void 0!==o&&''!==o?`留空=${o}`:'');e+=`<input type="${a}" class="acu-dice-input acu-dice-custom-field-contest" data-id="${h(t.id)}" data-party="${n}"\n                  placeholder="${h(i)}">`}e+='</div>',m.push($(e))})}t.empty();const v='init'===n?i:r;v.empty();const x=t=>t<=0?[]:t<=2?[2]:3===t?[3]:4===t?[2,2]:5===t?[2,3]:6===t?[3,3]:[...x(t-3),3],w=(t,n)=>{n.parent().length>0?n.detach().appendTo(t):t.append(n)},y=x(m.length);let k=0;if(y.length>0){const n=y[0];for(let e=0;e<n;e++)k<m.length?(w(t,m[k]),k++):t.append('<div></div>');F(t,n);for(let t=1;t<y.length;t++){const n=y[t],e=$(`<div class="acu-dice-form-row cols-${n}"></div>`);for(let t=0;t<n;t++)k<m.length?(w(e,m[k]),k++):e.append('<div></div>');v.append(e)}}X&&(0!==b.parent().length&&b.parent()[0]===t[0]||b.detach().appendTo(t),b.hide()),H&&(0!==a.parent().length&&a.parent()[0]===t[0]||a.detach().appendTo(t),a.hide()),J&&(0!==o.parent().length&&o.parent()[0]===t[0]||o.detach().appendTo(t),o.hide())};t(n,'init'),t(e,'opp')}else F(n,Z),F(e,Z),j(i,'init',B),j(r,'opp',B);X||(0===s.parent().length&&s.appendTo(n),0===p.parent().length&&p.appendTo(e),s.show(),p.show()),H||(0===l.parent().length&&l.appendTo(n),0===f.parent().length&&f.appendTo(e),l.show(),f.show()),w.find('#contest-dice-type').val(B.diceExpression),w.find('#contest-custom-dice-init').val(B.diceExpression),w.find('#contest-custom-dice-opp').val(''),w.find('.acu-dice-quick-preset-btn').removeClass('active'),t&&w.find(`.acu-dice-quick-preset-btn[data-preset-id="${t}"]`).addClass('active'),Ye(i,'.acu-dice-custom-field-contest[type="text"], .acu-dice-custom-field-contest[type="number"]'),Ye(r,'.acu-dice-custom-field-contest[type="text"], .acu-dice-custom-field-contest[type="number"]'),Ye(n,'.acu-dice-custom-field-contest[type="text"], .acu-dice-custom-field-contest[type="number"]'),Ye(e,'.acu-dice-custom-field-contest[type="text"], .acu-dice-custom-field-contest[type="number"]'),Ye(a,'.acu-dice-custom-field-contest[type="text"], .acu-dice-custom-field-contest[type="number"]'),Ye(o,'.acu-dice-custom-field-contest[type="text"], .acu-dice-custom-field-contest[type="number"]'),console.log('[DICE] 对抗检定应用高级预设:',B.name,'总字段数:',Q,'基础字段:',Z,'customFields:',G)},M=Gt.getActivePreset(),T=M&&Gt.supportsContest(M)?M:null,N=g.length>0?g[0].id:null;if('__custom__'===localStorage.getItem(K))w.find('.acu-dice-quick-preset-btn').removeClass('active'),w.find('.acu-dice-quick-preset-btn[data-dice="custom"]').addClass('active'),w.find('#contest-init-dice-syntax-row').show(),w.find('#contest-opp-dice-syntax-row').show(),w.find('#contest-custom-judge-row').show(),w.find('#contest-init-values-row, #contest-opp-values-row').hide(),w.find('#contest-init-custom-fields, #contest-opp-custom-fields').hide(),D(null);else if(T){w.find('.acu-dice-quick-preset-btn').removeClass('active');const t=w.find(`.acu-dice-quick-preset-btn[data-preset-id="${T.id}"]`);t.length&&t.addClass('active'),D(T.id)}else if(N){w.find('.acu-dice-quick-preset-btn').removeClass('active');const t=w.find(`.acu-dice-quick-preset-btn[data-preset-id="${N}"]`);t.length&&(t.addClass('active'),w.find('#contest-dice-type').val(t.data('dice')||'1d100')),D(N)}w.find('#contest-init-display').on('change.acuattr input.acuattr',function(){const t=$(this).val().trim()||'<user>',n=Me(t);qe(w.find('#contest-init-name'),n.length>0?n:p);const e=Ue(t);k(e,'init')}),w.find('#contest-opponent-display').on('change.acuattr input.acuattr',function(){const t=$(this).val().trim(),n=Me(t);qe(w.find('#contest-opp-name'),n.length>0?n:p);const e=Ue(t);k(e,'opp')}),w.find('#contest-init-name').on('change.acuval',function(){const t=w.find('#contest-init-display').val().trim()||'<user>',n=$(this).val().trim(),e=Fe(t,n);if(null!==e){const t=I('init',n);w.find(t).val(e).trigger('change')}}),w.find('#contest-opp-name').on('change.acuval',function(){const t=w.find('#contest-opponent-display').val().trim(),n=$(this).val().trim(),e=Fe(t,n);if(null!==e){const t=I('opp',n);w.find(t).val(e).trigger('change')}}),w.find('.acu-dice-quick-preset-btn').click(function(){const t=$(this).data('dice');if('custom'===t)return;const n=$(this).data('preset-id');if(n&&!Gt.supportsContest(n)){const t=Gt.getAllPresets().find(t=>t.id===n);return void toastr.warning(`${t?.name||n} 规则不支持对抗检定`)}w.find('.acu-dice-quick-preset-btn').removeClass('active'),$(this).addClass('active'),w.find('#contest-dice-type').val(t),w.find('#contest-init-dice-syntax-row').hide(),w.find('#contest-opp-dice-syntax-row').hide(),w.find('#contest-custom-judge-row').hide(),w.find('#contest-init-values-row, #contest-opp-values-row').show(),w.find('#contest-init-custom-fields, #contest-opp-custom-fields').show(),n?(Gt.setActivePreset(n),D(n)):(Gt.setActivePreset(null),D(null)),Yt({lastDiceType:t})}),w.find('.acu-dice-quick-preset-btn[data-dice="custom"]').click(function(){w.find('.acu-dice-quick-preset-btn').removeClass('active'),$(this).addClass('active'),Gt.setActivePreset(null),localStorage.setItem(K,'__custom__'),D(null),w.find('#contest-init-dice-syntax-row').show(),w.find('#contest-opp-dice-syntax-row').show(),w.find('#contest-custom-judge-row').show(),w.find('#contest-init-values-row, #contest-opp-values-row').hide(),w.find('#contest-init-custom-fields, #contest-opp-custom-fields').hide()});const F=function(t){const n=gn(t).total;if(Number.isNaN(n))return{total:0,rolls:[],sides:100};const e=t.match(/^(\d*)d(\d+|F)/i),a=e?e[2]:'100';return{total:n,rolls:[],sides:'F'===a.toUpperCase()?3:parseInt(a,10)}},P=function(){const t=w.find('#contest-roll-btn'),n=w.find('#contest-custom-dice-init').val().trim()||'1d100',e=w.find('#contest-custom-dice-opp').val().trim()||n,a=w.find('#contest-custom-judge-rule').val(),o=w.find('#contest-custom-tie-rule').val()??'tie';try{const t=Yn||pa();t&&Bt.rebuild(_a(t||{}))}catch(t){console.warn('[DICE] 对抗别名映射刷新失败:',t)}const i=w.find('#contest-init-display').val().trim()||'<user>',r='<user>'===i?i:Bt.resolve(i),c=w.find('#contest-init-name').val().trim()||'自由检定',s=w.find('#contest-opponent-display').val().trim()||'对手',l='<user>'===s?s:Bt.resolve(s),d=w.find('#contest-opp-name').val().trim()||c,u=gn(n),p=gn(e);if(isNaN(u.total)||isNaN(p.total)){if(window.toastr){const t=isNaN(u.total)?n:e;window.toastr.error(`骰子语法错误: ${t}`)}return}const f=u.total,g=p.total;let m='tie';switch(a){case'higher':case'rank':f>g?m='initiator':g>f?m='opponent':'initiator_win'===o?m='initiator':'initiator_lose'===o&&(m='opponent');break;case'lower':f<g?m='initiator':g<f?m='opponent':'initiator_win'===o?m='initiator':'initiator_lose'===o&&(m='opponent')}const b='initiator'===m?`${Tt(r)} 获胜`:'opponent'===m?`${Tt(l)} 获胜`:'none'===a?'无判定':'平局';let v=`${f} ${'lower'===a?'<':'>'} ${g}`;'tie'!==m&&'none'!==a||(v=`${f} = ${g}`);const x=`<meta:检定结果>【${c===d?c:`${c} vs ${d}`}】对抗检定：${Tt(r)}(${n})=${f}，${Tt(l)}(${e})=${g}，判定 ${v}，${b}</meta:检定结果>`;C(x,'dice');const y=qt(),k=void 0!==y.hideDiceResultFromUser&&y.hideDiceResultFromUser,E=k?'？？':f,A=k?'？？':g,S='none'!==a&&!k,I=S?'tie'===m?'平局':'initiator'===m?'胜':'负':'',D=S?'tie'===m?'平局':'opponent'===m?'胜':'负':'';w.find('#contest-result-init').html(`\n        <div class="acu-contest-result-name">${h(Tt(r))}</div>\n        <div class="acu-contest-result-roll">${E}</div>\n        ${S?`<div class="acu-contest-result-outcome">${I}</div>`:''}\n      `),w.find('#contest-result-opp').html(`\n        <div class="acu-contest-result-name">${h(Tt(l))}</div>\n        <div class="acu-contest-result-roll">${A}</div>\n        ${S?`<div class="acu-contest-result-outcome">${D}</div>`:''}\n      `),w.find('#contest-result-init').removeClass('winner loser'),w.find('#contest-result-opp').removeClass('winner loser'),k||'none'===a||('initiator'===m?(w.find('#contest-result-init').addClass('winner'),w.find('#contest-result-opp').addClass('loser')):'opponent'===m&&(w.find('#contest-result-init').addClass('loser'),w.find('#contest-result-opp').addClass('winner'))),w.find('#contest-result-display').show(),t.html(`\n        <div class="acu-dice-result-display">\n          <span>${k?'？？':b}</span>\n          <button class="dice-retry-btn acu-dice-retry-btn" title="重新投骰">\n            <i class="fa-solid fa-rotate-right"></i>\n          </button>\n        </div>\n      `),t.off('click','.dice-retry-btn').on('click','.dice-retry-btn',function(t){t.stopPropagation(),t.preventDefault(),P()});const M={...{left:{name:r,attribute:c,roll:f,target:0,successLevel:'initiator'===m?1:'tie'===m?0:-1},right:{name:l,attribute:d,roll:g,target:0,successLevel:'opponent'===m?1:'tie'===m?0:-1},winner:'initiator'===m?'left':'opponent'===m?'right':'tie',message:b},timestamp:Date.now(),detailId:`contest_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,detailLines:[`发起方: ${r} / 对抗方: ${l}`,`属性: ${c} vs ${d}`,`公式: ${n} vs ${e}`,`掷骰: ${f} vs ${g}`,`判定规则: ${a}`,`平手规则: ${o}`,`判定表达式: ${v}`,`结果: ${b}`]};to.push(M),to.length>no&&to.shift(),co('contest',M)};let j=0;const R=function(){const t=w.find('#contest-roll-btn'),n=w.find('.acu-contest-result-row'),e=Date.now();if(e-j<100)return;if(j=e,t.prop('disabled')||n.hasClass('disabled'))return;if(t.prop('disabled',!0).addClass('disabled'),n.addClass('disabled').css('pointer-events','none'),setTimeout(()=>{t.prop('disabled',!1).removeClass('disabled'),n.removeClass('disabled').css('pointer-events','')},100),w.find('#contest-init-dice-syntax-row').is(':visible'))return void P();var a=w.find('#contest-dice-type').val()||'1d100';const o=S||Gt.getActivePreset(),i=!!o&&'outcomes'in o&&Array.isArray(o.outcomes)&&o.outcomes.length>0;try{const t=Yn||pa();t&&Bt.rebuild(_a(t||{}))}catch(t){console.warn('[DICE] 对抗别名映射刷新失败:',t)}var r=(w.find('#contest-init-display').val()||'').toString().trim()||'<user>',c='<user>'===r?r:Bt.resolve(r),s=(w.find('#contest-init-name').val()||'').toString().trim()||'自由检定',l=function(t){var n=t.match(/(\d+)d(\d+)/i);return n?Math.round(parseInt(n[1],10)*parseInt(n[2],10)/2):50};const d=function(t,n){if(void 0===t)return 0;if('number'==typeof t)return t;const e=mn(t,n);return 0===e&&'0'!==t&&'0'!==String(t)&&window.toastr&&window.toastr.warning(`表达式 "${t}" 求值失败,使用默认值 0`),e||0},u=function(t){if(!t||''===t.trim())return 0;const n=t.trim(),e=parseFloat(n);if(!isNaN(e)&&isFinite(e)&&n.match(/^-?\d+(\.\d+)?$/))return e;const a=gn(n);return Number.isNaN(a.total)?0:a.total};var p,f=(w.find('#contest-init-value').val()||'').toString().trim();p=''===f?i&&o&&'attribute'in o?d(o.attribute?.defaultValue,{}):l(a):parseInt(f,10)||l(a);var g,m=(w.find('#contest-init-target').val()||'').toString().trim();g=''!==m?parseInt(m,10):i&&o&&'dc'in o?d(o.dc?.defaultValue,{$attr:p}):p;var b,v=(w.find('#contest-opponent-display').val()||'').toString().trim()||'对手',x='<user>'===v?v:Bt.resolve(v),y=(w.find('#contest-opp-name').val()||'').toString().trim()||s,k=(w.find('#contest-opp-value').val()||'').toString().trim();b=''===k?i&&o&&'attribute'in o?d(o.attribute?.defaultValue,{}):l(a):parseInt(k,10)||l(a);var E,A=(w.find('#contest-opp-target').val()||'').toString().trim();E=''!==A?parseInt(A,10):i&&o&&'dc'in o?d(o.dc?.defaultValue,{$attr:b}):b;var I=(w.find('#contest-init-mod').val()||'').toString().trim(),D=(w.find('#contest-opp-mod').val()||'').toString().trim(),M=(w.find('#contest-init-skill-mod').val()||'').toString().trim(),T=(w.find('#contest-opp-skill-mod').val()||'').toString().trim(),N=''!==I?u(I):0,B=''!==D?u(D):0,O=0,V=0;const L=Gt.getAllPresets(),U=/d100/i.test(a)?'coc7_check':'dnd5e_check',q=L.find(t=>t.id===U),Y=o&&'outcomes'in o&&Array.isArray(o.outcomes)&&o.outcomes.length>0?o:q;if(!Y||!Array.isArray(Y.outcomes)||0===Y.outcomes.length)return void console.warn('[DICE] 对抗检定未找到可用预设或 outcomes');Y.mod?.hidden&&(N=0,B=0),Y.dc?.hidden&&(g=d(Y.dc?.defaultValue,{$attr:p}),E=d(Y.dc?.defaultValue,{$attr:b}));!(!Y.skillMod||!0===Y.contestRule?.hideSkillMod||!0===Y.skillMod.hidden)&&Y.skillMod&&(O=''!==M?u(M):d(Y.skillMod.defaultValue,{$attr:p}),V=''!==T?u(T):d(Y.skillMod.defaultValue,{$attr:b}));const W=t=>{const n={};if(!('customFields'in Y)||!Array.isArray(Y.customFields)||0===Y.customFields.length)return n;return w.find(`.acu-dice-custom-field-contest[data-party="${t}"]`).each(function(){const t=$(this),e=t.data('id'),a=Y.customFields.find(t=>t.id===e);if(!a)return;let o;if('toggle'===a.type)o=t.prop('checked');else if('number'===a.type){const n=parseFloat(t.val());o=isNaN(n)?a.defaultValue:n}else if('select'===a.type){const n=t.val(),e=parseFloat(n);o=isNaN(e)?n:e}else{const n=String(t.val()??'').trim();o=''===n&&void 0!==a.defaultValue&&''!==a.defaultValue?a.defaultValue:n}n['$'+e]=o}),n},J=(t,n,e,a)=>{const o={};if(!('derivedVars'in Y)||!Array.isArray(Y.derivedVars)||0===Y.derivedVars.length)return o;const i={$attr:n,$dc:a,$mod:e,...t};return Y.derivedVars.forEach(t=>{const n=t?.id?.trim();if(!n)return;const e=n.startsWith('$')?n:`$${n}`,a=bn(t.expr,{...i,...o});if(!a.success)return console.warn(`[DICE] 对抗检定派生变量 ${e} 计算失败:`,a.error),void(o[e]=0);const r=a.value,c='number'==typeof r&&Number.isFinite(r)?r:r?1:0;o[e]=c}),o},H=(t,n,e,a,o,i)=>{if(!('dicePatches'in Y)||!Array.isArray(Y.dicePatches)||0===Y.dicePatches.length)return t;const r={$attr:a,$dc:i,$mod:o,...n,...e};let c=t;return Y.dicePatches.forEach(t=>{if(!t)return;if(t.when){const n=bn(t.when,r);if(!n.success)return void console.warn('[DICE] 对抗检定 dicePatches 条件评估失败:',n.error);if(!('number'==typeof n.value?0!==n.value:Boolean(n.value)))return}const n=(t=>t.replace(/\$[a-zA-Z_]\w*/g,t=>{const n=r[t];return'number'==typeof n&&Number.isFinite(n)?String(n):'0'}))(t.template??'');switch(t.op){case'append':c=`${c}${n}`;break;case'prepend':c=`${n}${c}`;break;case'replace':c=n}}),c},X=W('init'),K=J(X,p,N,g),G=H(a,X,K,p,N,g),Z=W('opp'),Q=J(Z,b,B,E),tt=H(a,Z,Q,b,B,E);var nt=F(G),et=F(tt),at=nt.total,ot=et.total;console.log('[DICE] 对抗检定公式 - 发起方:',G,'对抗方:',tt);let it=0,rt=0;if('attribute'in Y&&Y.attribute?.computeModifier){const t=Y.attribute.computeModifier;'floor(($attr - 10) / 2)'===t?(it=Math.floor((p-10)/2),rt=Math.floor((b-10)/2)):(it=d(t,{$attr:p}),rt=d(t,{$attr:b}))}const ct={$roll:nt,$attr:p,$attrMod:it,$skillMod:O,$dc:g,$mod:N,...X,...K},st={$roll:et,$attr:b,$attrMod:rt,$skillMod:V,$dc:E,$mod:B,...Z,...Q},lt=hn(Y.outcomes,ct),dt=hn(Y.outcomes,st),ut=function(t,n,e,a,o,i,r){const c=t.contestRule;if(!c)return a>o?'initiator':o>a?'opponent':'tie';let s='tie';switch(c.mode??'custom'){case'rank':{const t=n.contestRank??50,a=e.contestRank??50;t>a?s='initiator':a>t&&(s='opponent');break}case'value':case'margin':a>o?s='initiator':o>a&&(s='opponent');break;case'custom':if(c.customExpr){const t={$initValue:a,$oppValue:o,$initRank:n.contestRank??50,$oppRank:e.contestRank??50},i=bn(c.customExpr,t);i.success?s=('number'==typeof i.value?0!==i.value:Boolean(i.value))?'initiator':'opponent':console.warn('[DICE] 对抗判定自定义表达式失败:',i.error)}}const l=Array.isArray(c.tieBreakers)&&c.tieBreakers.length>0?c.tieBreakers:c.tieBreaker?[c.tieBreaker]:[];if('tie'===s&&l.length>0)for(const t of l){if('tie'!==s)break;switch(t){case'higher_attr':i>r?s='initiator':r>i&&(s='opponent');break;case'initiator_wins':s='initiator'}}return s}(Y,lt,dt,at+it+O+N,ot+rt+V+B,p,b);let pt='平局',ft='warning';'initiator'===ut?(pt=c+' 胜利',ft='success'):'opponent'===ut&&(pt=x+' 胜利',ft='failure');var gt=qt(),mt=void 0!==gt.hideDiceResultFromUser&&gt.hideDiceResultFromUser,bt=mt?'？？':at,ht=mt?'？？':ot,vt=mt?'':lt.name,xt=mt?'':dt.name,wt=mt?'':pt;const yt=t=>t.priority<=10?'critSuccess':t.priority<=30?'extremeSuccess':t.priority<50?'success':50===t.priority?'warning':t.priority<90?'failure':'critFailure',$t=yt(lt),kt=yt(dt),_t=kn($t),Ct=kn(kt),Et='success'===ft?'acu-contest-winner-success':'warning'===ft?'acu-contest-winner-warning':'acu-contest-winner-failure',At=w.find('#contest-result-display'),St=w.find('#contest-result-init'),It=w.find('#contest-result-opp');St.html('<span class="acu-contest-result-name">'+h(c)+'</span><span class="acu-contest-result-value">'+bt+'</span>'+(vt?'<span class="'+_t+'">'+vt+'</span>':'')),It.html((xt?'<span class="'+Ct+'">'+xt+'</span>':'')+'<span class="acu-contest-result-value">'+ht+'</span><span class="acu-contest-result-name">'+h(x)+'</span>'),At.html('<div class="acu-contest-result-container" title="点击重新投骰"><div class="acu-contest-result-row"><div class="acu-contest-result-inner"><div id="contest-result-init" class="acu-contest-result-side"><span class="acu-contest-result-name">'+h(c)+'</span><span class="acu-contest-result-value">'+bt+'</span>'+(vt?'<span class="'+_t+'">'+vt+'</span>':'')+'</div><span class="acu-contest-vs">VS</span><div id="contest-result-opp" class="acu-contest-result-side right">'+(xt?'<span class="'+Ct+'">'+xt+'</span>':'')+'<span class="acu-contest-result-value">'+ht+'</span><span class="acu-contest-result-name">'+h(x)+'</span></div></div></div><div class="acu-contest-result-winner-row"><span class="acu-contest-winner-text '+Et+'">'+wt+'</span><i class="fa-solid fa-rotate-right acu-contest-reroll-icon"></i></div></div>'),At.show(),At.off('click').on('click',function(t){t.stopPropagation(),t.preventDefault(),R()});w.find('#contest-roll-btn').hide();const Dt=Y.contestOutputTemplate||'<meta:检定结果>\n元叙事：进行了一次【$initiator $initAttrName vs $opponent $oppAttrName】的对抗检定。\n$initiator $initAttrName：$formula=$initRoll，判定 $initConditionExpr？$initJudgeResult，判定为【$initSuccessName】；\n$opponent $oppAttrName：$formula=$oppRoll，判定 $oppConditionExpr？$oppJudgeResult，判定为【$oppSuccessName】。\n最终结果：【$winner】\n</meta:检定结果>',Mt=lt.displayExpr??lt.condition,zt=dt.displayExpr??dt.condition;let Tt=Mt.replace(/\$roll\.hasTag\s*\(\s*['"]([^'"]+)['"]\s*\)/gi,(t,n)=>(nt.tags??[]).includes(n)?'成立':'不成立');Tt=Tt.replace(/\$roll\.total/g,String(at)).replace(/\$roll/g,String(at)).replace(/\$attrMod/g,String(it)).replace(/\$skillMod/g,String(O)).replace(/\$attr/g,String(p)).replace(/\$dc/g,String(g)).replace(/\$mod/g,String(N));let Nt=zt.replace(/\$roll\.hasTag\s*\(\s*['"]([^'"]+)['"]\s*\)/gi,(t,n)=>(et.tags??[]).includes(n)?'成立':'不成立');Nt=Nt.replace(/\$roll\.total/g,String(ot)).replace(/\$roll/g,String(ot)).replace(/\$attrMod/g,String(rt)).replace(/\$skillMod/g,String(V)).replace(/\$attr/g,String(b)).replace(/\$dc/g,String(E)).replace(/\$mod/g,String(B));const Ft=bn(Mt,ct),Pt=bn(zt,st),jt=Ft.success&&('number'==typeof Ft.value?0!==Ft.value:Boolean(Ft.value))?'成立':'不成立',Rt=Pt.success&&('number'==typeof Pt.value?0!==Pt.value:Boolean(Pt.value))?'成立':'不成立',Ot=lt.outputText||lt.name||'判定完成',Vt=dt.outputText||dt.name||'判定完成',Lt=at+it+O+N,Ut=ot+rt+V+B,Yt=Lt-Ut,Wt=it>=0?`+${it}`:String(it),Jt=O>=0?`+${O}`:String(O),Ht=0!==it?`，调整值${Wt}`:'',Xt=0!==O?`+技能加值${Jt}`:'',Kt=0!==N?`+额外加值${N>=0?'+'+N:N}`:'',Zt=rt>=0?`+${rt}`:String(rt),Qt=V>=0?`+${V}`:String(V),tn=0!==rt?`，调整值${Zt}`:'',nn=0!==V?`+技能加值${Qt}`:'',en=0!==B?`+额外加值${B>=0?'+'+B:B}`:'',an={initiator:c,opponent:x,initAttrName:s,oppAttrName:y,initRoll:at,oppRoll:ot,initTarget:g,oppTarget:E,initSuccessName:lt.name,oppSuccessName:dt.name,winner:pt,outcomeText:Ot,outcomeName:lt.name,conditionExpr:Tt,judgeResult:jt,formula:a,roll:at,dc:g,mod:N,attr:p,attrName:`【${s}】`,initOutcomeText:Ot,oppOutcomeText:Vt,initConditionExpr:Tt,oppConditionExpr:Nt,initJudgeResult:jt,oppJudgeResult:Rt,initAttrMod:it,oppAttrMod:rt,initSkillMod:O,oppSkillMod:V,initMod:N,oppMod:B,initAttrModText:Ht,oppAttrModText:tn,initSkillModText:Xt,oppSkillModText:nn,initModText:Kt,oppModText:en,initTotal:Lt,oppTotal:Ut,margin:Yt,shifts:Yt,initAttr:p,oppAttr:b},on=vn(Dt,an);C(on,'dice');const rn=t=>t.priority<=10?3:t.priority<=30?2:t.priority<50?1:50===t.priority?0:-1,cn={left:{name:c,attribute:s,roll:at,target:g,successLevel:rn(lt)},right:{name:x,attribute:y,roll:ot,target:E,successLevel:rn(dt)},winner:'initiator'===ut?'left':'opponent'===ut?'right':'tie',message:pt},sn=`contest_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,ln={...cn,timestamp:Date.now(),detailId:sn,historyType:'contest',detailLines:[`发起方: ${c} / 对抗方: ${x}`,`属性: ${s} vs ${y}`,`公式: ${G} vs ${tt}`,`掷骰: ${at} vs ${ot}`,`总值: ${Lt} vs ${Ut}`,`判定: ${Tt} | ${Nt}`,`结果: ${pt}`]};to.push(ln),to.length>no&&to.shift(),co('contest',ln)};w.find('#contest-roll-btn').click(function(){R()}),w.find('#contest-switch-normal').click(function(){var t=w.find('#contest-init-value').val().trim(),n=w.find('#contest-init-name').val()||'',e=w.find('#contest-dice-type').val()||'1d100',a=w.find('#contest-init-display').val().trim();B(),We({attrValue:''!==t?parseInt(t,10):null,targetValue:null,targetName:n,diceType:e,initiatorName:a})}),w.find('#contest-history-btn').click(function(t){t.stopPropagation(),ro()}),w.find('.acu-contest-config-btn').click(function(t){t.stopPropagation(),Ra({fromDicePanel:!0})});var B=function(){v.remove(),w.remove()};w.on('click',function(t){t.stopPropagation()}),v.click(B),w.find('.acu-contest-close').click(B)},Xe=(t,n)=>{const e=String(t||'').trim().toLowerCase(),a=String(n||'').toLowerCase();return!!e&&(a.includes('离场')?'否'===e||'false'===e||'no'===e:e.startsWith('在场')||'true'===e||'是'===e||'yes'===e)},Ke=async()=>{const t=Yn||pa(),n=_a(t||{});if(Bt.rebuild(n),!t||0===Object.keys(n).length)return null;const e=yn.findTable(n,'global'),a=yn.findTable(n,'location'),o=yn.findTable(n,'npc'),i=yn.findTable(n,'player'),r=(()=>{const t=['地图元素','元素表','地图要素','机关','线索'];for(const e in n)if(t.some(t=>e.includes(t)))return{data:n[e],name:e,key:n[e].key};return null})(),c=e?.data?.headers||[],s=(e?.data?.rows||[])[0]||[],l=wn.global,d=yn.findColumnIndex(c,'detailLocation',l),u=yn.findColumnIndex(c,'currentLocation',l),p=d>=0?String(s[d]||'').trim():'',f=u>=0?String(s[u]||'').trim():'';if(!a?.data)return null;const g=(t,n,e=null)=>{for(let e=0;e<t.length;e++){const a=String(t[e]||'').toLowerCase();if(n.some(t=>a.includes(t.toLowerCase())))return e}return e??-1},m=new Map,b=a.data.headers||[],h=a.data.rows||[],v=g(b,['详细地点','具体位置','地点名','地点','名称'],1),x=g(b,['次要地区','次要区域','区域','地区'],null),w=g(b,['地点类型','地点类别','类型'],null),y=g(b,['环境描述','描述','说明','介绍','氛围描述'],null),k=g(b,['重要度','重要性'],null),C=g(b,['探索状态','探索进度','状态'],null),E=[];h.forEach(t=>{const n=String(t[v]||'').trim().replace(/[\u200B-\u200D\uFEFF]/g,'');n&&E.push(n)});const A=(t=>{const n=new Map;for(const e of t)n.set(e,Ot(e));const e=[...t].sort((t,n)=>t.length!==n.length?t.length-n.length:t.localeCompare(n)),a=new Set,o=new Map;for(const t of e){const e=n.get(t)||[],i=e.find(t=>!a.has(t));i?(o.set(t,i),a.add(i)):o.set(t,e.length>0?e[0]:null)}return o})(E);h.forEach((t,n)=>{const e=String(t[v]||'').trim().replace(/[\u200B-\u200D\uFEFF]/g,'');if(!e)return;const o={name:e,region:x>=0?String(t[x]||'').trim():'',locationType:w>=0&&t[w]||'',description:y>=0&&t[y]||'',importance:k>=0&&t[k]||'',exploreStatus:C>=0&&t[C]||'',emoji:A.get(e)??null,tableKey:a.key||'',rowIndex:n};m.set(e,o)});const S=new Map;if(r?.data){const t=r.data.headers||[],n=r.data.rows||[],e=g(t,['元素名称','名称','元素名'],1),a=g(t,['元素类型','类型','元素分类'],2),o=g(t,['所在地点','位置','地点'],3),i=g(t,['元素描述','描述','说明'],null),c=g(t,['状态','交互状态'],null),s=g(t,['交互选项','交互','互动','可交互'],null);n.forEach((t,n)=>{const l=String(t[e]||'').trim();if(!l)return;const d=String(t[o]||'').trim();if(!d)return;if(f&&m.size>0&&!m.has(d))return;const u=s>=0?t[s]:'',p=String(u||'').split(/[,，、;；]/).map(t=>t.trim()).filter(Boolean),g=a>=0&&t[a]||'';((t,n)=>{S.has(t)||S.set(t,[]),S.get(t).push(n)})(d,{name:l,type:g,location:d,description:i>=0&&t[i]||'',status:c>=0&&t[c]||'',interactions:p,emoji:Vt(l,g),tableKey:r.key||'',rowIndex:n})})}const I=new Map,D=async t=>{const n=await Ft.getAsync(t.name),e={...t,avatarUrl:n,avatarOffsetX:Ft.getOffsetX(t.name),avatarOffsetY:Ft.getOffsetY(t.name),avatarScale:Ft.getScale(t.name)};I.has(e.location)||I.set(e.location,[]),I.get(e.location).push(e)};let M='';if(i?.data){const t=wn.player,n=i.data.headers||[],e=(i.data.rows||[])[0]||[],a=yn.findColumnIndex(n,'name',t),o=yn.findColumnIndex(n,'position',t),r=a>=0?e[a]:Dt(),c=o>=0?e[o]:'',s=jt(String(r||'').trim());M=String(c||'').trim(),!M&&p&&(M=p),s&&M&&await D({name:s,location:M,isPlayer:!0,isInScene:!0,tableKey:i.key||'',rowIndex:0})}if(o?.data){const t=wn.npc,n=o.data.headers||[],e=o.data.rows||[],a=yn.findColumnIndex(n,'name',t),i=yn.findColumnIndex(n,'position',t),r=yn.findColumnIndex(n,'inScene',t);for(let t=0;t<e.length;t++){const c=e[t],s=jt(String(c[a]||'').trim());if(!s)continue;const l=String(c[i]||'').trim();if(!l)continue;if(f&&m.size>0&&!m.has(l))continue;const d=r>=0?c[r]:'',u=n[r]||'',p=Xe(d,u);await D({name:s,location:l,isPlayer:!1,isInScene:p,tableKey:o.key||'',rowIndex:t})}}const T=m.values().next().value,N=[...new Set(Array.from(m.values()).map(t=>t.region||'其他'))].sort(),F=N.indexOf('其他');F>-1&&(N.splice(F,1),N.push('其他'));const P=(()=>{if(p&&m.has(p))return p;if(M&&m.has(M))return M;const t=N[0];if(t){const n=(t=>{const n=t||'其他';return Array.from(m.values()).filter(t=>(t.region||'其他')===n).sort((t,n)=>{const e=(I.get(t.name)?.length||0)+(S.get(t.name)?.length||0);return(I.get(n.name)?.length||0)+(S.get(n.name)?.length||0)-e})})(t);if(n.length>0)return n[0].name}return T?T.name:''})();return{currentRegion:f||m.get(M)?.region||'其他',detailLocation:p,focusLocation:P,playerLocation:M,locations:m,elements:S,characters:I,allRegions:N}};let Ge=!1;const Ze=async()=>{const{$}=le();if(Ge)return;Ge=!0,$('.acu-map-overlay').remove();let t=await Ke();if(!t)return Ge=!1,void(window.toastr&&window.toastr.warning('未找到地图数据'));const n=ca(),e=new Map,a=t.detailLocation||'',o=t.playerLocation||'';let i='',r=t.currentRegion;if(a&&t.locations.has(a)){i=a;const n=t.locations.get(a);r=n?.region||t.currentRegion||'其他'}else if(o&&t.locations.has(o)){i=o;const n=t.locations.get(o);r=n?.region||t.currentRegion||'其他'}else if(t.focusLocation&&t.locations.has(t.focusLocation)){i=t.focusLocation;const n=t.locations.get(i);r=n?.region||t.currentRegion||'其他'}i&&(fe.set(et,i),e.set(r,i));const c=$(`\n            <div class="acu-map-overlay acu-theme-${n.theme}">\n                <div class="acu-map-container">\n                    <div class="acu-panel-header">\n                        <div class="acu-map-title">\n                            <i class="fa-solid fa-map-location-dot"></i>\n                            <span class="acu-map-region-name">地图</span>\n                        </div>\n                        <div class="acu-map-region-tabs"></div>\n                        <div class="acu-map-actions">\n                            <button class="acu-map-back-btn" title="回到当前地点"><i class="fa-solid fa-location-crosshairs"></i></button>\n                            <button class="acu-close-btn acu-map-close"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-map-body">\n                        <div class="acu-map-focus-area"></div>\n                        <div class="acu-map-thumbnails"></div>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(c);const s=c[0];s.style.setProperty('position','fixed','important'),s.style.setProperty('top','0','important'),s.style.setProperty('left','0','important'),s.style.setProperty('right','0','important'),s.style.setProperty('bottom','0','important'),s.style.setProperty('width','100vw','important'),s.style.setProperty('height','100vh','important'),s.style.setProperty('display','flex','important'),s.style.setProperty('justify-content','center','important'),s.style.setProperty('align-items','center','important'),s.style.setProperty('z-index','31100','important');const l=c.find('.acu-map-focus-area'),d=c.find('.acu-map-thumbnails'),u=t=>{if(t.startsWith('fa:')){return`<i class="fa-solid fa-${t.slice(3)} acu-theme-icon"></i>`}if(t.startsWith('ti:')){return`<i class="ti ti-${t.slice(3)} acu-theme-icon"></i>`}return t},p=t=>{const n=t.name||t.type||'元素',e=t.emoji?`<span class="acu-map-chip-emoji">${u(t.emoji)}</span>`:'';return`\n                 <div class="acu-map-element-chip acu-dash-preview-trigger" data-table-key="${h(t.tableKey||'')}" data-row-index="${t.rowIndex}">\n                     ${e}\n                     <span class="acu-map-chip-name" title="${h(n)}">${h(n)}</span>\n                 </div>\n             `},f=()=>{l.html(((t,n)=>{const e=t.locations.get(n);if(!e)return'<div class="acu-map-loading" style="grid-column: 1 / -1;"><div class="acu-map-spinner"></div></div>';const a=t.characters.get(n)||[],o=t.elements.get(n)||[],i=a.slice(0,Math.ceil(a.length/2)),r=a.slice(Math.ceil(a.length/2)),c=o.slice(0,Math.ceil(o.length/2)),s=o.slice(Math.ceil(o.length/2)),l=t=>{const n=Tt(t.name),e=t.avatarUrl?`background-image:url('${t.avatarUrl}');background-size:${t.avatarScale}%;background-position:${t.avatarOffsetX}% ${t.avatarOffsetY}%;`:'';return`\n            <div class="acu-map-avatar acu-dash-preview-trigger" data-table-key="${h(t.tableKey||'')}" data-row-index="${t.rowIndex}">\n                <div class="acu-map-avatar-circle" style="${e}">\n                    ${t.avatarUrl?'':`<span>${h(n.charAt(0))}</span>`}\n                </div>\n                <div class="acu-map-avatar-name" title="${h(n)}">${h(n.length>4?n.substring(0,4)+'..':n)}</div>\n            </div>\n        `},d=i.length?i.map(l).join(''):'',f=r.length?r.map(l).join(''):'',g=c.length?c.map(t=>p(t)).join(''):'',m=s.length?s.map(t=>p(t)).join(''):'',b=e.emoji?`<div class="acu-map-location-emoji">${u(e.emoji)}</div>`:`<div class="acu-map-location-text">${h(e.name.charAt(0)||'□')}</div>`;return`\n        <div class="acu-map-wing left">\n            <div class="acu-map-avatar-group acu-group-left">${d||''}</div>\n            <div class="acu-map-element-group acu-group-left">${g||''}</div>\n        </div>\n        <div class="acu-map-stage-center acu-dash-preview-trigger" data-table-key="${h(e.tableKey)}" data-row-index="${e.rowIndex}">\n            ${b}\n            <div class="acu-map-location-name" title="${h(e.name)}">${h(e.name)}</div>\n        </div>\n        <div class="acu-map-wing right">\n            <div class="acu-map-avatar-group acu-group-right">${f||''}</div>\n            <div class="acu-map-element-group acu-group-right">${m||''}</div>\n        </div>\n        <div class="acu-map-mobile-stack">\n            <div class="acu-map-mobile-avatars">${d||''}${f||''}</div>\n            <div class="acu-map-mobile-elements">${g||''}${m||''}</div>\n        </div>\n    `})(t,i));const n=Array.from(t.locations.values()).filter(t=>(t.region||'其他')===r).sort((n,e)=>{const a=(t.characters.get(n.name)?.length||0)+(t.elements.get(n.name)?.length||0);return(t.characters.get(e.name)?.length||0)+(t.elements.get(e.name)?.length||0)-a}).map(n=>((t,n,e)=>{const a=(t.characters.get(n.name)||[]).length+(t.elements.get(n.name)||[]).length,o=n.emoji?`<div class="acu-map-thumbnail-emoji">${u(n.emoji)}</div>`:`<div class="acu-map-thumbnail-placeholder">${h(n.name.charAt(0)||'□')}</div>`,i=a>0?`<div class="acu-map-thumbnail-badge">${a}</div>`:'';return`\n        <div class="acu-map-thumbnail ${e?'active':''}" data-location="${h(n.name)}">\n            ${i}\n            ${o}\n            <div class="acu-map-thumbnail-name" title="${h(n.name)}">${h(n.name.length>6?n.name.substring(0,6)+'..':n.name)}</div>\n        </div>\n    `})(t,n,n.name===i)).join('');var e,a;d.html(n||'<div class="acu-map-empty">该地区暂无其他地点</div>'),c.find('.acu-map-region-tabs').html((e=t.allRegions,a=r,e.length<=1?'':e.map(t=>`<button class="acu-map-region-tab ${t===a?'active':''}" data-region="${h(t)}">${h(t)}</button>`).join('')))};f(),c.data('refreshMapData',async()=>{const n=await Ke();if(n){if(t=n,!t.locations.has(i)){const n=t.detailLocation||'',a=t.playerLocation||'';let o='',c=r;const s=Array.from(t.locations.values()).filter(t=>(t.region||'其他')===r);if(s.length>0)o=s[0].name;else if(n&&t.locations.has(n)){o=n;const e=t.locations.get(n);c=e?.region||c}else if(a&&t.locations.has(a)){o=a;const n=t.locations.get(a);c=n?.region||c}else if(t.focusLocation&&t.locations.has(t.focusLocation)){o=t.focusLocation;const n=t.locations.get(o);c=n?.region||c}else{const n=Array.from(t.locations.values())[0];n&&(o=n.name,c=n.region||'其他')}o&&(i=o,r=c,fe.set(et,i),e.set(r,i))}f()}});c.find('.acu-map-close').on('click',t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),c.remove()}),c.on('click','.acu-map-region-tab',function(){const n=$(this).data('region');if(n===r)return;r=n;const a=Array.from(t.locations.values()).filter(t=>(t.region||'其他')===r);if(!a.find(t=>t.name===i)&&a.length>0){const n=e.get(r);if(n&&a.find(t=>t.name===n))i=n;else{const n=(n=>{const e=n||'其他';return Array.from(t.locations.values()).filter(t=>(t.region||'其他')===e).sort((n,e)=>{const a=(t.characters.get(n.name)?.length||0)+(t.elements.get(n.name)?.length||0);return(t.characters.get(e.name)?.length||0)+(t.elements.get(e.name)?.length||0)-a})})(r);i=n.length>0?n[0].name:a[0].name}fe.set(et,i)}f()}),y(c,'acu-map-overlay',()=>{c.remove()}),c.on('click','.acu-map-thumbnail',function(){const t=$(this).data('location');var n;t&&((n=t)&&(i=n,fe.set(et,i),e.set(r,i),f()))}),c.on('click','.acu-map-back-btn',()=>{const n=t.focusLocation,e=t.detailLocation||'',a=t.playerLocation||'';let o='';if(e&&t.locations.has(e)?o=e:a&&t.locations.has(a)?o=a:n&&t.locations.has(n)&&(o=n),!o)return;const c=t.locations.get(o),s=c?.region||t.currentRegion||'其他';s!==r&&(r=s),i=o,fe.set(et,i),f()}),Ge=!1},Qe=t=>{console.info('[DICE]开始抓取人物关系表数据...');const{$}=le();$('.acu-relation-graph-overlay').remove();const n=ca(),e=t.headers||[],o=t.rows||[],i=e.findIndex(t=>t&&(t.includes('姓名')||t.includes('名称')))||1,r=e.findIndex(t=>t&&t.includes('人际关系')),c=t.key||'';if(console.info(`[DICE]人物关系表查找: 表格"${c||'未知'}"，共${o.length}行数据`),r<0)return console.warn('[DICE]人物关系表查找: 未找到"人际关系"列'),void(window.toastr&&window.toastr.warning('未找到"人际关系"列'));const s=new Map,l=[],d=t=>(t=>{if(!t)return t;const n=Dt(),e=Mt(),a=['<user>','{{user}}'];!1!==qt().autoMergeProtagonist&&a.push('主角');const o=a.some(n=>t===n||t.toLowerCase()===n.toLowerCase()),i=e&&t===e,r=!!n&&(t===n||Ft.getPrimaryName(t)===n);return o||i||r?'{{user}}':Ft.getPrimaryName(t)})(jt(t)),u=Yn||pa();Bt.rebuild(_a(u||{}));let p='主角';if(u)for(const t in u){const n=u[t];if(n?.name?.includes('主角')&&n.content?.[1]){p=jt(n.content[1][1]||'主角');break}}const f=d(p),g=(()=>{for(const t in u)if(u[t]?.name?.includes('主角'))return t;return''})();s.set(f,{name:f,isPlayer:!0,x:0,y:0,tableKey:g,rowIndex:0});const m=e.findIndex(t=>t&&t.includes('在场'));o.forEach((t,n)=>{const a=t[i];if(!a)return;const u=d(a);let p=!1;if(m>0){const n=String(t[m]||'').trim().toLowerCase();p=String(e[m]||'').toLowerCase().includes('离场')?'否'===n||'false'===n||'no'===n:n.startsWith('在场')||'true'===n||'是'===n||'yes'===n}s.has(u)||s.set(u,{name:u,isPlayer:!1,x:0,y:0,tableKey:c,rowIndex:n,isInScene:p});const g=t[r]||'';Dn(g).forEach(t=>{if(!t.name)return;const n=d(t.name);if(n===u)return;if(!s.has(n)){let t=-1,a=!1;for(let r=0;r<o.length;r++)if(d(o[r][i])===n){if(t=r,m>0){const t=String(o[r][m]||'').trim().toLowerCase();a=String(e[m]||'').toLowerCase().includes('离场')?'否'===t||'false'===t||'no'===t:t.startsWith('在场')||'true'===t||'是'===t||'yes'===t}break}s.set(n,{name:n,isPlayer:n===f,x:0,y:0,tableKey:t>=0?c:'',rowIndex:t>=0?t:void 0,isInScene:a})}const a=(t=>{if(!t)return[];const n=String(t).split(/[,，、;；\/\|]+|\s*[和与&]\s*|\s{2,}|\n/).map(t=>t.trim()).filter(t=>t&&t.length<30),e=['恋人','情侣','夫妻','伴侣','爱人','男友','女友','前男友','前女友','朋友','好友','挚友','密友','闺蜜','死党','知己','损友','同学','校友','同窗','学长','学姐','学弟','学妹','前辈','后辈','同事','上司','下属','老板','员工','搭档','队友','战友','伙伴','师父','师傅','徒弟','弟子','老师','学生','导师','门生','父亲','母亲','儿子','女儿','兄弟','姐妹','哥哥','姐姐','弟弟','妹妹','爷爷','奶奶','外公','外婆','叔叔','阿姨','舅舅','姑姑','表哥','表姐','表弟','表妹','堂兄','堂弟','堂姐','堂妹','家人','亲人','亲戚','血亲','义父','义母','义兄','义妹','敌人','仇人','对手','劲敌','宿敌','情敌','死敌','冤家','邻居','室友','房东','租客','客户','商人','雇主','雇员','信徒','教徒','追随者','崇拜者','粉丝','陌生人','熟人','路人','过客'];return n.map(t=>{const n=(t=t.replace(/[（(][^）)]*[）)]/g,'').trim()).match(/^(.+)的(目标|对象)$/);if((t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=n?n[1]:t.replace(/^[\u4e00-\u9fa5]{2,4}的(?=[\u4e00-\u9fa5]{1,4}$)/,'')).replace(/^(?:属于|作为|身为|是其?|为其?|乃)/,'')).replace(/^(?:曾经是?|以前是?|原本是?|前)/,'前')).replace(/^(?:互为|彼此是?|相互是?)/,'')).replace(/关系$/,'')).replace(/对象$/,'')).replace(/目标$/,'')).replace(/^关系复杂$/,'复杂')).replace(/^关系不明$/,'不明')).replace(/^关系微妙$/,'微妙')).replace(/^关系紧张$/,'紧张')).replace(/^关系亲密$/,'亲密')).replace(/^关系疏远$/,'疏远')).replace(/^(?:不认识|不熟悉|陌生人?)$/,'陌生')).replace(/^(?:认识|熟人)$/,'熟人')).replace(/^(?:好朋友|挚友|密友|至交)$/,'挚友')).replace(/^(?:男朋友|男友)$/,'男友')).replace(/^(?:女朋友|女友)$/,'女友')).replace(/^(?:前男友|前男朋友)$/,'前男友')).replace(/^(?:前女友|前女朋友)$/,'前女友')).replace(/^(?:暗恋对象|暗恋)$/,'暗恋')).replace(/^(?:单相思|单恋)$/,'单恋')).replace(/^(?:青梅竹马|儿时玩伴|发小)$/,'青梅竹马')).replace(/^(?:同班同学|同级同学)$/,'同学')).replace(/^(?:工作伙伴|合作伙伴|搭档)$/,'搭档')).trim()).length>8){for(const n of e)if(t.endsWith(n))return n;const n=t.slice(-4);for(const t of e)if(n.includes(t))return t;return t.slice(-3)}return t}).filter(t=>t&&t.length>0&&t.length<=8)})(t.relation);0===a.length&&a.push('');let r=l.find(t=>t.source===u&&t.target===n||t.source===n&&t.target===u);if(r)if(r.source===u){const t=[...r.labelsFromSource||[],...a];r.labelsFromSource=[...new Set(t)].slice(0,2)}else{const t=[...r.labelsFromTarget||[],...a];r.labelsFromTarget=[...new Set(t)].slice(0,2)}else l.push({source:u,target:n,labelsFromSource:a.slice(0,2),labelsFromTarget:[]})})});const b=Array.from(s.values());console.info(`[DICE]人物关系表数据抓取完成，共${b.length}个节点，${l.length}条边`);const v=new Map;b.forEach(t=>v.set(t.name,0)),l.forEach(t=>{v.set(t.source,(v.get(t.source)||0)+1),v.set(t.target,(v.get(t.target)||0)+1)});const x=window.innerWidth<=768,w=x?22:28,k=x?38:50,C=x?28:35,E=x?2.5:3.5;let A=1,S=!1,I=!1;const D=(t,n)=>{const e=n?C:w,a=v.get(t)||0;return Math.min(k,e+Math.sqrt(a)*E)*A};b.forEach(t=>{t.radius=D(t.name,t.isPlayer)});const M=()=>`acu-relation-graph-layout-cache-${b.map(t=>t.name).sort().join('|')}`,T=()=>{try{const t=M(),n=localStorage.getItem(t);if(!n)return!1;const e=JSON.parse(n);let a=!0;for(const t of b)if(!e[t.name]){a=!1;break}return!!a&&(b.forEach(t=>{const n=e[t.name];n&&(t.x=n.x,t.y=n.y,t.vx=0,t.vy=0)}),!0)}catch(t){return console.warn('[DICE]关系图 加载布局缓存失败:',t),!1}},N=()=>{b.forEach(t=>{if(t.isPlayer)t.x=400,t.y=300,t.vx=0,t.vy=0;else{const n=2*Math.random()*Math.PI,e=50+100*Math.random();t.x=400+Math.cos(n)*e,t.y=300+Math.sin(n)*e,t.vx=0,t.vy=0}});const t=new Map;b.forEach(n=>t.set(n.name,n));for(let n=0;n<300;n++){for(let t=0;t<b.length;t++){const n=b[t];for(let e=t+1;e<b.length;e++){const t=b[e],a=t.x-n.x,o=t.y-n.y;let i=a*a+o*o;i<1&&(i=1);const r=Math.sqrt(i),c=2e4/i,s=a/r*c,l=o/r*c;n.isPlayer||(n.vx-=s,n.vy-=l),t.isPlayer||(t.vx+=s,t.vy+=l)}}l.forEach(n=>{const e=t.get(n.source),a=t.get(n.target);if(!e||!a)return;const o=a.x-e.x,i=a.y-e.y,r=Math.sqrt(o*o+i*i)||1,c=.02*(r-250),s=o/r*c,l=i/r*c;e.isPlayer||(e.vx+=s,e.vy+=l),a.isPlayer||(a.vx-=s,a.vy-=l)}),b.forEach(t=>{if(t.isPlayer)return;const n=400-t.x,e=300-t.y;t.vx+=.01*n,t.vy+=.01*e});const e=50*(1-n/300);b.forEach(t=>{if(t.isPlayer)return;t.vx*=.8,t.vy*=.8;const n=Math.sqrt(t.vx*t.vx+t.vy*t.vy);n>e&&(t.vx=t.vx/n*e,t.vy=t.vy/n*e),t.x+=.5*t.vx,t.y+=.5*t.vy})}(()=>{try{const t=M(),n={};b.forEach(t=>{n[t.name]={x:t.x,y:t.y}}),localStorage.setItem(t,JSON.stringify(n))}catch(t){console.warn('[DICE]关系图 保存布局缓存失败:',t)}})()};T()||N();let F=1,P=0,j=0;const R=$(`\n            <div class="acu-relation-graph-overlay acu-theme-${n.theme}">\n                <div class="acu-relation-graph-container">\n                    <div class="acu-panel-header">\n                        <div class="acu-graph-title">\n                            <i class="fa-solid fa-project-diagram"></i>\n                            <button class="acu-graph-btn acu-filter-toggle acu-graph-filter-btn ml-8" id="filter-in-scene" title="只显示主角和在场角色"><i class="fa-solid fa-map-marker-alt"></i></button>\n                            <button class="acu-graph-btn acu-filter-toggle acu-graph-filter-btn" id="filter-direct-only" title="只显示与主角直接相关"><i class="fa-solid fa-link"></i></button>\n                        </div>\n                        <div class="acu-graph-actions">\n                            <button class="acu-graph-btn" id="graph-relayout" title="重新布局（清除缓存并重新计算节点位置）"><i class="fa-solid fa-sync"></i></button>\n                            <button class="acu-graph-btn" id="graph-manage-avatar" title="管理头像"><i class="fa-solid fa-user-circle"></i></button>\n                            <button class="acu-graph-btn acu-graph-close" title="关闭"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-graph-canvas-wrapper">\n                        <svg class="acu-graph-svg" viewBox="0 0 800 600">\n                            <defs>\n                                <marker id="arrowhead-end" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 6 2.5, 0 5" />\n                                </marker>\n                                <marker id="arrowhead-start" markerWidth="6" markerHeight="5" refX="1" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="6 0, 0 2.5, 6 5" />\n                                </marker>\n                                <marker id="arrowhead-end-hl" markerWidth="7" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 7 3, 0 6" />\n                                </marker>\n                                <marker id="arrowhead-start-hl" markerWidth="7" markerHeight="6" refX="1" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="7 0, 0 3, 7 6" />\n                                </marker>\n                            </defs>\n                            <g class="acu-graph-transform">\n                                <g class="acu-graph-edges"></g>\n                                <g class="acu-graph-nodes"></g>\n                            </g>\n                        </svg>\n                        <div class="acu-node-size-slider-container">\n                            <div class="acu-slider-header">\n                                <span class="acu-slider-label">节点大小</span>\n                                <span id="slider-size-display" class="acu-slider-value">${Math.round(100*A)}%</span>\n                            </div>\n                            <input type="range" id="node-size-slider" min="0.5" max="2.0" step="0.1" value="${A}" class="acu-range-input" />\n                        </div>\n                    </div>\n                    <div class="acu-graph-legend">\n                        <button class="acu-graph-btn acu-graph-reset-btn" id="graph-zoom-reset" title="重置视图和节点大小"><i class="fa-solid fa-compress-arrows-alt"></i><span>重置</span></button>\n                        <div class="acu-node-size-stepper-wrapper acu-node-size-wrapper">\n                            <span style="font-size:11px;color:var(--acu-text-sub);white-space:nowrap;">节点:</span>\n                            <div class="acu-stepper acu-stepper-container" data-id="graph-node-size" data-min="50" data-max="200" data-step="10">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value acu-stepper-value-display" id="node-size-display">${Math.round(100*A)}%</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <span class="acu-zoom-display acu-zoom-info">\n                            <span>视图:</span>\n                            <span>${Math.round(100*F)}%</span>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(R);const B=R.find('.acu-graph-svg'),O=R.find('.acu-graph-transform'),V=R.find('.acu-graph-edges'),L=R.find('.acu-graph-nodes'),U=R.find('.acu-zoom-display span:last-child'),q=R.find('#node-size-display'),Y=R.find('.acu-graph-canvas-wrapper'),W=()=>{O.attr('transform',`translate(${P}, ${j}) scale(${F})`),U.text(`${Math.round(100*F)}%`)},J=()=>{q.length&&q.text(`${Math.round(100*A)}%`)},H=(t,n=400,e=300)=>{const a=F;F=Math.max(.3,Math.min(4,t));const o=F/a;P=n-(n-P)*o,j=e-(e-j)*o,W()},X=async()=>{const t=(()=>{if(!S&&!I)return b;let t=null;return I&&(t=new Set([f]),l.forEach(n=>{n.source===f&&t.add(n.target),n.target===f&&t.add(n.source)})),b.filter(n=>{const e=!S||n.isInScene||n.isPlayer,a=!I||t.has(n.name);return e&&a})})(),n=new Set(t.map(t=>t.name)),e=l.filter(t=>n.has(t.source)&&n.has(t.target));let o='';e.forEach((t,n)=>{const e=s.get(t.source),i=s.get(t.target);if(!e||!i)return;const r=i.x-e.x,c=i.y-e.y,l=Math.sqrt(r*r+c*c)||1,d=r/l,u=c/l,p=-u,f=d,g=t.labelsFromSource&&t.labelsFromSource.length>0&&t.labelsFromSource.some(t=>t),m=t.labelsFromTarget&&t.labelsFromTarget.length>0&&t.labelsFromTarget.some(t=>t),b=e.radius||28,v=i.radius||28,x=e.x+d*(b+10),w=e.y+u*(b+10),y=i.x-d*(v+10),k=i.y-u*(v+10);let C=(t.labelsFromSource||[]).filter(t=>t),E=(t.labelsFromTarget||[]).filter(t=>t);const A=new Set(C),S=new Set(E),I=[...A].filter(t=>S.has(t)),D=C.filter(t=>!I.includes(t)),M=E.filter(t=>!I.includes(t));let T='',N='';g&&(N='url(#arrowhead-end)'),m&&(T='url(#arrowhead-start)'),o+=`<line class="acu-graph-edge" x1="${x}" y1="${w}" x2="${y}" y2="${k}"\n                    ${N?`marker-end="${N}"`:''}\n                    ${T?`marker-start="${T}"`:''}\n                    data-edge-idx="${n}" />`;const F=(e.x+i.x)/2,P=(e.y+i.y)/2,j=Math.sqrt(r*r+c*c);if(g&&m&&I.length>0&&0===D.length&&0===M.length){const t=t=>t.startsWith('fa:')?`<i class="fa-solid fa-${t.slice(3)}" style="font-size:10px;margin-left:2px;opacity:0.8;"></i>`:t.startsWith('ti:')?`<i class="ti ti-${t.slice(3)}" style="font-size:10px;margin-left:2px;opacity:0.8;"></i>`:t,e=n=>{if(!n)return'';for(const e of a)for(const a of e.keywords)if(n.includes(a))return n+t(e.icon);return n};I.slice(0,2).forEach((t,a)=>{if(!t)return;const i=0===a?1:-1,r=6+10*a,c=F+p*i*r,s=P+f*i*r,l=e(t);l.includes('<i ')?o+=`<foreignObject x="${c-50}" y="${s-10}" width="100" height="20" style="overflow:visible;">\n                <div xmlns="http://www.w3.org/1999/xhtml" class="acu-graph-edge-label-html" data-edge-idx="${n}" style="\n                  display:flex;align-items:center;justify-content:center;\n                  font-size:11px;color:var(--acu-text-sub);white-space:nowrap;\n                  pointer-events:none;\n                ">${l}</div>\n              </foreignObject>`:o+=`<text class="acu-graph-edge-label" x="${c}" y="${s}" data-edge-idx="${n}">${h(t)}</text>`})}else{const t=Math.max(30,Math.min(.25*j,60)),e=t=>t.startsWith('fa:')?`<i class="fa-solid fa-${t.slice(3)}" style="font-size:10px;margin-left:2px;opacity:0.8;"></i>`:t.startsWith('ti:')?`<i class="ti ti-${t.slice(3)}" style="font-size:10px;margin-left:2px;opacity:0.8;"></i>`:t,i=t=>{if(!t)return'';for(const n of a)for(const a of n.keywords)if(t.includes(a))return t+e(n.icon);return t},r=(t,n=4)=>{if(!t)return'';const e=t.length>n?t.substring(0,n)+'..':t;return i(e)},c=(t,n,e,a,o=5)=>{const i=r(t,o);return i.includes('<i ')?`<foreignObject x="${n-50}" y="${e-10}" width="100" height="20" style="overflow:visible;">\n                <div xmlns="http://www.w3.org/1999/xhtml" class="acu-graph-edge-label-html" data-edge-idx="${a}" style="\n                  display:flex;align-items:center;justify-content:center;\n                  font-size:11px;color:var(--acu-text-sub);white-space:nowrap;\n                  pointer-events:none;\n                ">${i}</div>\n              </foreignObject>`:`<text class="acu-graph-edge-label" x="${n}" y="${e}" data-edge-idx="${a}">${h(i)}</text>`};if(I.length>0&&I.slice(0,1).forEach((t,e)=>{if(!t)return;o+=c(t,F+8*p,P+8*f-3,n,5)}),D.length>0||g&&!m&&0===I.length){const e=D.length>0?D:C,a=F-d*t,i=P-u*t;e.slice(0,2).forEach((t,e)=>{if(!t)return;const r=10*(0===e?1:-1);o+=c(t,a+p*r,i+f*r,n,5)})}if(M.length>0||m&&!g&&0===I.length){const e=M.length>0?M:E,a=F+d*t,i=P+u*t;e.slice(0,2).forEach((t,e)=>{if(!t)return;const r=10*(0===e?-1:1);o+=c(t,a+p*r,i+f*r,n,5)})}}}),V.html(o);let i='';for(const n of t){const t=await Ft.getAsync(n.name),e=(n.isPlayer,.22*n.radius),a=.62*n.radius,o=n.isInScene?`<circle class="acu-node-inscene-indicator" cx="${a}" cy="${a}" r="${e}" style="fill:var(--acu-accent);stroke:var(--acu-bg-panel);stroke-width:3;" />`:'',r=Tt(n.name);i+=`\n                <g class="acu-graph-node acu-dash-preview-trigger" data-name="${h(n.name)}" data-table-key="${n.tableKey||''}" data-row-index="${void 0!==n.rowIndex?n.rowIndex:''}" transform="translate(${n.x}, ${n.y})">\n                    <circle class="acu-node-bg" r="${n.radius}" />\n                    ${t?(()=>{const e=Ft.getOffsetX(n.name),a=Ft.getOffsetY(n.name),o=Ft.getScale(n.name),i=2*(n.radius-2),r=i+8,c=r/2;return`<foreignObject x="${-c}" y="${-c}" width="${r}" height="${r}">\n                            <div class="acu-node-avatar" xmlns="http://www.w3.org/1999/xhtml" style="\n                                width: ${i}px;\n                                height: ${i}px;\n                                margin: 4px;\n                                border-radius: 50%;\n                                background-image: url('${t}');\n                                background-size: ${o}%;\n                                background-position: ${e}% ${a}%;\n                                background-repeat: no-repeat;\n                            "></div>\n                        </foreignObject>`})():`<text class="acu-node-char" dy="0.35em">${h(r.charAt(0))}</text>`}\n                    ${o}\n                    <text class="acu-node-label" dy="${n.radius+14}">${h(r)}</text>\n                </g>\n            `}L.html(i)},K=t=>{B.addClass('highlighting'),L.find('.acu-graph-node').each(function(){$(this).data('name')===t&&$(this).addClass('highlighted')});const n=new Set([t]);l.forEach(e=>{if(e.source===t||e.target===t){const a=e.source===t?e.target:e.source;n.add(a)}}),L.find('.acu-graph-node').each(function(){n.has($(this).data('name'))&&$(this).addClass('highlighted')});const e=new Set;l.forEach((n,a)=>{n.source!==t&&n.target!==t||e.add(a)}),V.find('.acu-graph-edge').each(function(){const t=parseInt($(this).attr('data-edge-idx'),10);e.has(t)&&($(this).addClass('highlighted'),$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end-hl)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start-hl)'))}),V.find('.acu-graph-edge-label').each(function(){const t=parseInt($(this).attr('data-edge-idx'),10);e.has(t)&&$(this).addClass('highlighted')})},G=()=>{B.removeClass('highlighting'),L.find('.highlighted').removeClass('highlighted'),V.find('.highlighted').removeClass('highlighted'),V.find('.acu-graph-edge').each(function(){$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start)')})};if(!window.matchMedia('(pointer: fine)').matches){let t=null;L.on('pointerdown','.acu-graph-node',function(n){const e=$(this),a=e.data('name'),o=n.clientX,i=n.clientY,r=Date.now();let c=!1,s=!1;if(t)return G(),t=null,n.preventDefault(),void n.stopPropagation();const l=setTimeout(()=>{!c&&a&&(s=!0,t=a,K(a),navigator.vibrate&&navigator.vibrate(30))},300);$(document).on('pointermove.mobilenode',t=>{const n=Math.abs(t.clientX-o),e=Math.abs(t.clientY-i);(n>8||e>8)&&(c=!0,clearTimeout(l))}),$(document).on('pointerup.mobilenode pointercancel.mobilenode',()=>{$(document).off('pointermove.mobilenode pointerup.mobilenode pointercancel.mobilenode'),clearTimeout(l);const t=Date.now()-r;if(!s&&!c&&t<300){const t=e.data('name'),n=Ft.getPrimaryName(t),a=e.data('table-key');let o=e.data('row-index');if(!a||''===o||void 0===o){const t=Yn||pa();if(t)for(const e in t){const a=t[e];if(!a?.content||!a.name?.includes('NPC'))continue;const o=(a.content[0]||[]).findIndex(t=>t&&(t.includes('姓名')||t.includes('名称')||t.includes('名字')));if(!(o<0))for(let t=1;t<a.content.length;t++){const i=String(a.content[t][o]||'').trim();if(i===n||Ft.getPrimaryName(i)===n){const n=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',e).data('row-index',t-1);return $('body').append(n),n.trigger('click.acu_dash_preview'),void n.remove()}}}return void(window.toastr&&window.toastr.info(`「${n}」暂无详细资料`,'',{timeOut:2e3}))}const i=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',a).data('row-index',parseInt(o,10));$('body').append(i),i.trigger('click.acu_dash_preview'),i.remove()}})}),Y.on('pointerup.mobileclear',function(n){t&&!$(n.target).closest('.acu-graph-node').length&&(G(),t=null)})}else L.on('pointerenter.pchover','.acu-graph-node',function(){const t=$(this).data('name');t&&K(t)}),L.on('pointerleave.pchover','.acu-graph-node',function(){G()}),L.on('click.pcclick','.acu-graph-node',function(t){t.stopPropagation();const n=$(this),e=n.data('name'),a=Ft.getPrimaryName(e),o=n.data('table-key');let i=n.data('row-index');if(!o||''===i||void 0===i){const t=Yn||pa();if(t)for(const n in t){const e=t[n];if(!e?.content||!e.name?.includes('NPC'))continue;const o=(e.content[0]||[]).findIndex(t=>t&&(t.includes('姓名')||t.includes('名称')||t.includes('名字')));if(!(o<0))for(let t=1;t<e.content.length;t++){const i=String(e.content[t][o]||'').trim();if(i===a||Ft.getPrimaryName(i)===a){const e=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',n).data('row-index',t-1);return $('body').append(e),e.trigger('click.acu_dash_preview'),void e.remove()}}}return void(window.toastr&&window.toastr.info(`「${a}」暂无详细资料`,'',{timeOut:2e3}))}const r=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',o).data('row-index',parseInt(i,10));$('body').append(r),r.trigger('click.acu_dash_preview'),r.remove()});X().then(()=>{W()});let Z=!1,Q=0,tt=0,nt=0,et=0,at=0,ot=null;const it=Y[0],rt=B[0];it.onpointerdown=function(t){0===t.button&&($(t.target).closest('.acu-graph-node').length||$(t.target).closest('.acu-node-size-slider-container').length||(t.preventDefault(),it.setPointerCapture(t.pointerId),ot=t.pointerId,Z=!0,Q=t.clientX,tt=t.clientY,nt=P,et=j,rt.style.cursor='grabbing'))},it.onpointermove=function(t){if(!Z||t.pointerId!==ot)return;const n=t.clientX-Q,e=t.clientY-tt,a=rt.getBoundingClientRect();P=nt+n/a.width*800,j=et+e/a.height*600,W()},it.onpointerup=function(t){t.pointerId===ot&&(it.releasePointerCapture(t.pointerId),Z=!1,ot=null,rt.style.cursor='grab')},it.onpointercancel=function(t){t.pointerId===ot&&(Z=!1,ot=null,rt.style.cursor='grab')},it.onwheel=function(t){t.preventDefault();const n=t.deltaY>0?-.15:.15;H(F+n)},it.addEventListener('touchstart',function(t){2===t.touches.length&&(t.preventDefault(),Z=!1,at=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY))},{passive:!1}),it.addEventListener('touchmove',function(t){if(2===t.touches.length){t.preventDefault();const n=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY);at>0&&H(F*(n/at)),at=n}},{passive:!1}),it.addEventListener('touchend',function(t){t.touches.length<2&&(at=0)});const ct=R.find('#node-size-slider'),st=R.find('#slider-size-display'),lt=R.find('.acu-node-size-slider-container'),dt=R.find('#node-size-display-trigger');R.find('.acu-graph-legend');let ut=!1,pt=null;const ft=()=>{ut&&(pt&&(clearTimeout(pt),pt=null),ut=!1,lt.hide())},gt=()=>{pt&&clearTimeout(pt),pt=setTimeout(()=>{ft()},4e3)};R.on('click','#node-size-display-trigger, #node-size-display-trigger *',function(t){t.stopPropagation(),ut?ft():(()=>{if(ut)return;pt&&(clearTimeout(pt),pt=null),ut=!0;const t=dt[0].getBoundingClientRect(),n=Y[0].getBoundingClientRect(),e=n.height-60-10,a=t.left-n.left;lt.css({display:'block',top:`${e}px`,left:`${a}px`}),gt()})()}),ct.on('input mousedown touchstart',function(t){t.stopPropagation(),ut&&gt()}),lt.on('pointerdown mousedown touchstart',function(t){t.stopPropagation()}),$(document).on('click.slider-hide',function(t){!ut||lt.is(t.target)||0!==lt.has(t.target).length||dt.is(t.target)||0!==dt.has(t.target).length||ft()}),ct.on('input',function(){A=parseFloat($(this).val()),st.text(Math.round(100*A)+'%'),J(),b.forEach(t=>{t.radius=D(t.name,t.isPlayer)}),X(),gt()});const mt=R.find('#filter-in-scene'),bt=R.find('#filter-direct-only'),ht=()=>{mt.toggleClass('active',S),bt.toggleClass('active',I)};ht(),mt.click(function(t){t.stopPropagation(),S=!S,ht(),X()}),bt.click(function(t){t.stopPropagation(),I=!I,ht(),X()}),R.find('#graph-zoom-reset').click(()=>{F=1,P=0,j=0,W(),A=1,ct.val(1),st.text('100%'),J();const t=R.find('.acu-stepper[data-id="graph-node-size"]');t.length&&t.find('.acu-stepper-value').text('100%'),b.forEach(t=>{t.radius=D(t.name,t.isPlayer)}),T()||N(),X()});const vt=R.find('.acu-stepper[data-id="graph-node-size"]');if(vt.length){const t=parseInt(vt.data('min')),n=parseInt(vt.data('max')),e=parseInt(vt.data('step')),a=vt.find('.acu-stepper-value'),o=e=>{e=Math.max(t,Math.min(n,e)),A=e/100,a.text(`${e}%`),J(),b.forEach(t=>{t.radius=D(t.name,t.isPlayer)}),X()},i=()=>{const t=a.text().replace(/[^\d]/g,'');return parseInt(t)||100};vt.find('.acu-stepper-dec').on('click',function(){o(i()-e)}),vt.find('.acu-stepper-inc').on('click',function(){o(i()+e)})}R.find('#graph-relayout').click(()=>{(()=>{try{const t=M();localStorage.removeItem(t)}catch(t){console.warn('[DICE]关系图 清除布局缓存失败:',t)}})(),b.forEach(t=>{t.radius=D(t.name,t.isPlayer)}),N(),X()}),R.find('#graph-manage-avatar').click(()=>{na(b,()=>{b.forEach(t=>{t.radius=D(t.name,t.isPlayer)}),X()})});const xt=()=>{it.onpointerdown=null,it.onpointermove=null,it.onpointerup=null,it.onpointercancel=null,it.onwheel=null,pt&&(clearTimeout(pt),pt=null),$(document).off('click.slider-hide'),R.remove()};R.find('.acu-graph-close').click(xt),y(R,'acu-relation-graph-overlay',xt)},ta=(t,n,e)=>{const{$}=le();$('.acu-crop-modal-overlay').remove();const a=ca();let o=150,i=50,r=50;const c=Ft.getAll()[n];c&&(o=c.scale??150,i=c.offsetX??50,r=c.offsetY??50);const s=`\n            <div class="acu-crop-modal-overlay acu-theme-${a.theme}">\n                <div class="acu-crop-modal">\n                    <div class="acu-crop-header">\n                        <span><i class="fa-solid fa-crop-simple"></i> 调整头像 - ${h(n)}</span>\n                        <button class="acu-crop-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-crop-body">\n                        <div class="acu-crop-container">\n                            <div class="acu-crop-image" style="\n                                background-image: url('${t}');\n                                background-size: ${o}%;\n                                background-position: ${i}% ${r}%;\n                            "></div>\n                            <div class="acu-crop-mask"></div>\n                        </div>\n                        <div class="acu-crop-hint">拖拽移动 · 滚轮/双指缩放</div>\n                    </div>\n                    <div class="acu-crop-footer">\n                        <label class="acu-crop-btn acu-crop-reupload" title="重新上传">\n                            <i class="fa-solid fa-camera"></i>\n                            <input type="file" accept="image/*" class="acu-crop-file-input" />\n                        </label>\n                        <button class="acu-crop-btn acu-crop-cancel">取消</button>\n                        <button class="acu-crop-btn acu-crop-confirm"><i class="fa-solid fa-check"></i> 确定</button>\n                    </div>\n                </div>\n            </div>\n        `,l=$(s);$('body').append(l);const d=l.find('.acu-crop-image'),u=l.find('.acu-crop-container')[0],p=d[0],f=()=>{p.style.backgroundSize=`${o}%`,p.style.backgroundPosition=`${i}% ${r}%`};let g=!1,m=0,b=0,v=0,x=0,w=null;p.addEventListener('pointerdown',t=>{null===w&&(t.preventDefault(),t.stopPropagation(),g=!0,w=t.pointerId,m=t.clientX,b=t.clientY,v=i,x=r,p.setPointerCapture(t.pointerId),p.style.cursor='grabbing')}),p.addEventListener('pointermove',t=>{if(!g||t.pointerId!==w)return;t.preventDefault(),t.stopPropagation();const n=t.clientX-m,e=t.clientY-b,a=100/o;i=Math.max(0,Math.min(100,v-n*a)),r=Math.max(0,Math.min(100,x-e*a)),f()}),p.addEventListener('pointerup',t=>{t.pointerId===w&&(g=!1,w=null,p.releasePointerCapture(t.pointerId),p.style.cursor='grab')}),p.addEventListener('pointercancel',t=>{t.pointerId===w&&(g=!1,w=null,p.style.cursor='grab')}),u.addEventListener('wheel',t=>{t.preventDefault(),t.stopPropagation();const n=t.deltaY>0?-10:10;o=Math.max(100,Math.min(300,o+n)),f()},{passive:!1});let k=0,C=o;u.addEventListener('touchstart',t=>{2===t.touches.length&&(t.preventDefault(),k=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY),C=o)},{passive:!1}),u.addEventListener('touchmove',t=>{if(2===t.touches.length){t.preventDefault();const n=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY);if(k>0){const t=n/k;o=Math.max(100,Math.min(300,C*t)),f()}}},{passive:!1}),u.addEventListener('touchend',t=>{t.touches.length<2&&(k=0,C=o)}),l.find('.acu-crop-file-input').on('change',async function(e){const a=e.target.files[0];if(a)if(a.type.startsWith('image/'))if(a.size>5242880)window.toastr&&window.toastr.warning('图片大小不能超过 5MB');else{try{if(await Ft.saveLocalAvatar(n,a)){const e=await Et.get(n);t=e,o=150,i=50,r=50,d.css('background-image',`url('${e}')`),f()}}catch(t){console.error('[DICE]ACU 重新上传失败:',t),window.toastr&&window.toastr.error('上传失败')}$(this).val('')}else window.toastr&&window.toastr.warning('请选择图片文件')}),l.find('.acu-crop-close, .acu-crop-cancel').on('click',()=>{l.remove()}),l.find('.acu-crop-confirm').on('click',()=>{e({scale:o,offsetX:i,offsetY:r}),l.remove()}),y(l,'acu-crop-modal-overlay',()=>{l.remove()})},na=(t,n)=>{try{const{$}=le();$('.acu-avatar-manager-overlay').remove();const e=ca(),a=Ft.getAll();let o='chat',i='name',r='asc',c='';const s=new Set;let l=!0;const d=t=>{if(!t)return t;const n=Dt(),e=Mt(),a=['<user>','{{user}}'];!1!==qt().autoMergeProtagonist&&a.push('主角');const o=a.some(n=>t===n||t.toLowerCase()===n.toLowerCase()),i=e&&t===e,r=(()=>{if(!n)return!1;if(t===n)return!0;return Ft.getPrimaryName(t)===n})();return o||i||r?'{{user}}':Ft.getPrimaryName(t)},u=async()=>{let n='';const e=Ft.getAll();let u=[];if('chat'===o)u=t.map(t=>({name:t.name,isPlayer:t.isPlayer}));else{const n=new Set,a=[];for(const e of t)n.has(e.name)||(n.add(e.name),a.push({name:e.name,isPlayer:e.isPlayer}));for(const t of Object.keys(e))n.has(t)||(n.add(t),a.push({name:t,isPlayer:!1}));u=a}const p=u.find(t=>'{{user}}'===d(t.name));let f=u.filter(t=>'{{user}}'!==d(t.name));if(c){const t=c.toLowerCase();f=f.filter(n=>{const a=n.name.toLowerCase().includes(t),o=(e[n.name]?.aliases||[]).some(n=>n.toLowerCase().includes(t));return a||o})}const g=new Map;if('source'===i)for(const t of f){const n=await Ft.hasLocalAvatar(t.name),a=!!e[t.name]?.url;g.set(t.name,{hasLocal:n,hasUrl:a})}if('source'===i){const t=t=>{const n=g.get(t);return n?.hasLocal?0:n?.hasUrl?1:2};f.sort((n,e)=>{const a=t(n.name)-t(e.name);return'asc'===r?a:-a})}else'name'===i?f.sort((t,n)=>{const e=t.name.localeCompare(n.name,'zh-CN');return'asc'===r?e:-e}):f.sort((t,n)=>{const a=e[t.name]?.createdAt??0,o=e[n.name]?.createdAt??0;return'asc'===r?a-o:o-a});if('global'===o&&0===u.length)return'\n            <div class="acu-avatar-empty-state">\n              <i class="fa-solid fa-images"></i>\n              <p>暂无角色数据。请确保数据库正确启动并包含主角信息或重要人物表数据。</p>\n            </div>\n          ';if('chat'===o&&0===u.length)return'\n            <div class="acu-avatar-empty-state">\n              <i class="fa-solid fa-user-slash"></i>\n              <p>当前聊天中没有找到角色数据。请先在仪表盘中添加主角或NPC。</p>\n            </div>\n          ';if(p){const t={...p,name:'{{user}}'},e=a[t.name]||{};let o=e.url||'';const i=await Ft.hasLocalAvatar(t.name);let r='',c='';i?(r=await Et.get(t.name),c='<span class="acu-avatar-source acu-source-local">本地</span>'):o&&(r=o,c='<span class="acu-avatar-source acu-source-url">URL</span>');(e.aliases||[]).join(', ');const d=!!r;!l||d||e.url||s.add(t.name);const u=s.has(t.name);n+=`\n                    <div class="acu-avatar-item ${u?'expanded':''}" data-name="${h(t.name)}" data-has-local="${i}" data-display-url="${h(r)}">\n                        \x3c!-- 折叠态 --\x3e\n                        <div class="acu-avatar-row-collapsed">\n                            <div class="acu-avatar-preview-wrap">\n                                <div class="acu-avatar-preview ${d?'has-image':''}" data-avatar-url="${h(r)}" data-avatar-x="${e.offsetX??50}" data-avatar-y="${e.offsetY??50}" data-avatar-scale="${e.scale??150}">\n                                    ${d?'':`<span>${h(t.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                                </div>\n                                ${c}\n                            </div>\n                            <div class="acu-avatar-info-summary">\n                                <div class="acu-avatar-name">${h(t.name)}<button class="acu-protagonist-toggle ${!1!==qt().autoMergeProtagonist?'active':''}" title="自动将&quot;主角&quot;合并为{{user}}的别名"><i class="fa-solid ${!1!==qt().autoMergeProtagonist?'fa-link':'fa-link-slash'}"></i></button></div>\n                                <div class="acu-avatar-url-preview">${h(o||'无头像设置')}</div>\n                            </div>\n                            <div class="acu-avatar-actions-collapsed">\n                                <button class="acu-btn-action acu-btn-edit" title="编辑"><i class="fa-solid ${u?'fa-chevron-up':'fa-pencil'}"></i></button>\n                                <button class="acu-btn-action acu-btn-delete acu-avatar-clear-btn" title="清除"><i class="fa-solid fa-trash"></i></button>\n                            </div>\n                        </div>\n\n                        \x3c!-- 展开态 --\x3e\n                        <div class="acu-avatar-row-expanded">\n                            <div class="acu-avatar-details">\n                                <div class="acu-input-group">\n                                    <label class="acu-input-group-label">URL</label>\n                                    <div class="acu-url-container">\n                                        <input type="text" class="acu-input acu-avatar-url" placeholder="粘贴图片链接..." value="${h(o)}" />\n                                    </div>\n                                </div>\n                                <div class="acu-input-group">\n                                    <label class="acu-input-group-label">别名</label>\n                                    <div class="acu-alias-tags-container">\n                                        ${(e.aliases||[]).map(t=>`<span class="acu-alias-tag" data-alias="${h(t)}">${h(t)} <i class="fa-solid fa-xmark"></i></span>`).join('')}\n                                        <input type="text" class="acu-alias-input" placeholder="输入别名，逗号分隔..." />\n                                    </div>\n                                </div>\n                                <div class="acu-avatar-expanded-footer">\n                                    <button class="acu-btn-action acu-avatar-clear-all-btn" title="清除头像"><i class="fa-solid fa-user-slash"></i></button>\n                                    <button class="acu-btn-action acu-avatar-clear-alias-btn" title="清空别名"><i class="fa-solid fa-tags"></i></button>\n                                    <label class="acu-avatar-upload-trigger">\n                                        <i class="fa-solid fa-cloud-arrow-up"></i> 本地上传\n                                        <input type="file" accept="image/*" class="acu-avatar-file-input" style="display:none" />\n                                    </label>\n                                    <button class="acu-btn-action acu-btn-save acu-avatar-save-btn" title="保存"><i class="fa-solid fa-check"></i>&nbsp;保存</button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `}for(const t of f){const e=a[t.name]||{};let o=e.url||'';const i=await Ft.hasLocalAvatar(t.name);let r='',c='';i?(r=await Et.get(t.name),c='<span class="acu-avatar-source acu-source-local">本地</span>'):o&&(r=o,c='<span class="acu-avatar-source acu-source-url">URL</span>');(e.aliases||[]).join(', ');const d=!!r;!l||d||e.url||s.add(t.name);const u=s.has(t.name);n+=`\n                    <div class="acu-avatar-item ${u?'expanded':''}" data-name="${h(t.name)}" data-has-local="${i}" data-display-url="${h(r)}">\n                        \x3c!-- 折叠态 --\x3e\n                        <div class="acu-avatar-row-collapsed">\n                            <div class="acu-avatar-preview-wrap">\n                                <div class="acu-avatar-preview ${d?'has-image':''}" data-avatar-url="${h(r)}" data-avatar-x="${e.offsetX??50}" data-avatar-y="${e.offsetY??50}" data-avatar-scale="${e.scale??150}">\n                                    ${d?'':`<span>${h(t.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                                </div>\n                                ${c}\n                            </div>\n                            <div class="acu-avatar-info-summary">\n                                <div class="acu-avatar-name">${h(t.name)}</div>\n                                <div class="acu-avatar-url-preview">${h(o||'无头像设置')}</div>\n                            </div>\n                            <div class="acu-avatar-actions-collapsed">\n                                <button class="acu-btn-action acu-btn-edit" title="编辑"><i class="fa-solid ${u?'fa-chevron-up':'fa-pencil'}"></i></button>\n                                <button class="acu-btn-action acu-btn-delete acu-avatar-clear-btn" title="清除"><i class="fa-solid fa-trash"></i></button>\n                            </div>\n                        </div>\n\n                        \x3c!-- 展开态 --\x3e\n                        <div class="acu-avatar-row-expanded">\n                            <div class="acu-avatar-details">\n                                <div class="acu-input-group">\n                                    <label class="acu-input-group-label">URL</label>\n                                    <div class="acu-url-container">\n                                        <input type="text" class="acu-input acu-avatar-url" placeholder="粘贴图片链接..." value="${h(o)}" />\n                                    </div>\n                                </div>\n                                <div class="acu-input-group">\n                                    <label class="acu-input-group-label">别名</label>\n                                    <div class="acu-alias-tags-container">\n                                        ${(e.aliases||[]).map(t=>`<span class="acu-alias-tag" data-alias="${h(t)}">${h(t)} <i class="fa-solid fa-xmark"></i></span>`).join('')}\n                                        <input type="text" class="acu-alias-input" placeholder="输入别名，逗号分隔..." />\n                                    </div>\n                                </div>\n                                <div class="acu-avatar-expanded-footer">\n                                    <button class="acu-btn-action acu-avatar-clear-all-btn" title="清除头像"><i class="fa-solid fa-user-slash"></i></button>\n                                    <button class="acu-btn-action acu-avatar-clear-alias-btn" title="清空别名"><i class="fa-solid fa-tags"></i></button>\n                                    <label class="acu-avatar-upload-trigger">\n                                        <i class="fa-solid fa-cloud-arrow-up"></i> 本地上传\n                                        <input type="file" accept="image/*" class="acu-avatar-file-input" style="display:none" />\n                                    </label>\n                                    <button class="acu-btn-action acu-btn-save acu-avatar-save-btn" title="保存"><i class="fa-solid fa-check"></i>&nbsp;保存</button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                `}return n},p=t=>{t.find('.acu-avatar-preview').each(function(){const t=$(this),n=t.attr('data-avatar-url');if(!n)return;const e=Number(t.attr('data-avatar-x')||50),a=Number(t.attr('data-avatar-y')||50),o=Number(t.attr('data-avatar-scale')||150);t.css({'--acu-avatar-image':`url('${n}')`,'--acu-avatar-x':`${e}%`,'--acu-avatar-y':`${a}%`,'--acu-avatar-scale':`${o}%`})})},f=`\n            <div class="acu-avatar-manager-overlay acu-theme-${e.theme}">\n                <div class="acu-avatar-manager">\n                    <div class="acu-panel-header">\n                        <div class="acu-avatar-title"><i class="fa-solid fa-user-circle"></i> 头像管理</div>\n                        <div class="acu-avatar-header-actions">\n                            <button class="acu-btn-icon acu-avatar-import-btn" title="导入"><i class="fa-solid fa-file-import"></i></button>\n                            <button class="acu-btn-icon acu-avatar-export-btn" title="导出"><i class="fa-solid fa-file-export"></i></button>\n                            <button class="acu-avatar-close"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-avatar-toolbar">\n                        \x3c!-- 左侧:切换视图、排序、搜索 --\x3e\n                        <div class="acu-toolbar-group left">\n                            <button class="acu-btn-icon acu-view-toggle" title="当前聊天 / 全局头像库" data-view="chat">\n                                <i class="fa-solid fa-comments"></i>\n                            </button>\n                            <div class="acu-select-wrapper sort-field">\n                                <select class="acu-toolbar-select acu-sort-field" title="排序方式">\n                                    <option value="name">名字</option>\n                                    <option value="date">日期</option>\n                                    <option value="source">来源</option>\n                                </select>\n                            </div>\n                            <button class="acu-btn-icon acu-sort-order" title="排序方向" data-dir="asc">\n                                <i class="fa-solid fa-arrow-down-a-z"></i>\n                            </button>\n                            <div class="acu-search-wrapper">\n                                <i class="fa-solid fa-magnifying-glass acu-search-icon"></i>\n                                <input type="text" class="acu-avatar-search" placeholder="搜索..." autocomplete="off">\n                                <i class="fa-solid fa-xmark acu-search-clear" style="display:none;"></i>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="acu-avatar-list" id="acu-avatar-list-container">\n                        <div class="acu-import-empty">\n                            <i class="fa-solid fa-spinner fa-spin"></i> 加载中...\n                        </div>\n                    </div>\n                </div>\n                <input type="file" id="acu-avatar-file-input" accept=".json" />\n            </div>\n        `,g=$(f);$('body').append(g),u().then(t=>{g.find('#acu-avatar-list-container').html(t),p(g),C()});const m=async t=>{const n=g.find(`.acu-avatar-item[data-name="${t}"]`);if(!n.length)return;const e=Ft.getAll()[t]||{},a=await Ft.hasLocalAvatar(t);let o='',i='';a?(o=await Et.get(t),i='<span class="acu-avatar-source acu-source-local">本地</span>'):e.url&&(o=e.url,i='<span class="acu-avatar-source acu-source-url">URL</span>');const r=n.find('.acu-avatar-preview');n.find('.acu-avatar-source').remove(),o?(r.addClass('has-image').attr('data-avatar-url',o).attr('data-avatar-x',e.offsetX??50).attr('data-avatar-y',e.offsetY??50).attr('data-avatar-scale',e.scale??150).css({'--acu-avatar-image':`url('${o}')`,'--acu-avatar-x':`${e.offsetX??50}%`,'--acu-avatar-y':`${e.offsetY??50}%`,'--acu-avatar-scale':`${e.scale??150}%`}).find('span').remove(),n.find('.acu-avatar-preview-wrap').append(i),n.find('.acu-avatar-url-preview').text(e.url||'本地图片')):(r.removeClass('has-image').attr('data-avatar-url','').attr('data-avatar-x',50).attr('data-avatar-y',50).attr('data-avatar-scale',150).css({'--acu-avatar-image':'','--acu-avatar-x':'','--acu-avatar-y':'','--acu-avatar-scale':''}).html(`<span>${h(t.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`),n.find('.acu-avatar-url-preview').text('无头像设置')),n.attr('data-has-local',a),n.attr('data-display-url',o)},b=async()=>{const t=await u();g.find('#acu-avatar-list-container').html(t),p(g),l=!1},v=t=>{try{const n='function'==typeof pa?pa():null;if(!n)return null;const e=Ft.getAll()[t],a=[t,...e?.aliases||[]].map(t=>t.toLowerCase());for(const[t,e]of Object.entries(n)){if(!e||'object'!=typeof e)continue;const n=e.rows;if(Array.isArray(n))for(let e=0;e<n.length;e++){const o=n[e];if(!o)continue;const i=['名字','角色名','姓名','name','Name','名称'];for(const n of i){const i=o[n];if(i&&'string'==typeof i&&a.includes(i.toLowerCase()))return{tableKey:t,rowIndex:e,row:o}}}}return null}catch(t){return console.error('[DICE] findCharacterInTable 错误:',t),null}},x=(t,n=[])=>{const e=[];try{const a='function'==typeof pa?pa():null;if(!a)return e;const o=[t,...n].map(t=>t.toLowerCase());for(const[t,n]of Object.entries(a)){if(!t.startsWith('sheet_'))continue;if(!n||'object'!=typeof n)continue;const a=n;if(!Array.isArray(a.content)||a.content.length<2)continue;const i=a.content[0],r=a.name||t.replace('sheet_',''),c=['名字','角色名','姓名','name','Name','名称'];let s=-1;for(const t of c){const n=i.findIndex(n=>n===t);if(-1!==n){s=n;break}}const l=i.findIndex(t=>'人际关系'===t);if(-1!==l)for(let t=1;t<a.content.length;t++){const n=a.content[t];if(!Array.isArray(n))continue;let i='';if(-1!==s){const t=n[s];t&&'string'==typeof t&&(i=t)}const c=n[l];if(c&&'string'==typeof c){const n=c.split(/[;；]/);for(const a of n){const n=a.split(/[:：]/),s=n[0],l=n[1]||'';if(s&&o.includes(s.trim().toLowerCase())){e.push({tableName:r,rowIndex:t-1,characterName:i||`行${t}`,relationText:c,matchedRelation:l.trim()});break}}}}}}catch(t){console.error('[DICE] findRelationshipReferences 错误:',t)}return e},w=(t,n,a)=>{const{name:o,tableRow:i,relationships:r}=t,c=Ft.getAll()[o]||{},s=c.aliases||[],l=c.offsetX??50,d=c.offsetY??50,u=c.scale??150,p=c.url||t.avatarUrl,f=[];if(s.length>0)try{const t='function'==typeof pa?pa():null;if(t){const n=s.map(t=>t.toLowerCase());for(const[e,a]of Object.entries(t)){if(!e.startsWith('sheet_'))continue;if(!a||'object'!=typeof a)continue;const t=a;if(!Array.isArray(t.content)||t.content.length<2)continue;const o=t.content[0],i=['名字','角色名','姓名','name','Name','名称'];let r=-1;for(const t of i){const n=o.findIndex(n=>n===t);if(-1!==n){r=n;break}}if(-1!==r)for(let a=1;a<t.content.length;a++){const o=t.content[a];if(!Array.isArray(o))continue;const i=o[r];i&&'string'==typeof i&&n.includes(i.toLowerCase())&&f.push({tableKey:e.replace('sheet_',''),alias:i})}}}}catch(t){console.warn('[DeleteModal] Alias scan failed',t)}const g=`\n          <div class="acu-delete-confirm-overlay acu-theme-${e.theme}">\n            <div class="acu-delete-confirm-modal redesign">\n\n              \x3c!-- 头部 --\x3e\n              <div class="acu-delete-header destruct">\n                <i class="fa-solid fa-triangle-exclamation"></i>\n                删除角色确认\n                <button class="acu-delete-close-btn" title="关闭">\n                  <i class="fa-solid fa-xmark"></i>\n                </button>\n              </div>\n\n              <div class="acu-delete-content">\n\n                \x3c!-- 核心身份 (红色区域) --\x3e\n                <div class="acu-del-section destruct">\n                  <div class="acu-del-section-head">\n                    <i class="fa-solid fa-id-card"></i> 将永久删除\n                  </div>\n                  <div class="acu-del-card main-identity">\n                    <div class="acu-del-avatar-box">\n                      <div class="acu-avatar-preview ${p?'has-image':''}"\n                           data-avatar-url="${h(p||'')}"\n                           data-avatar-x="${l}"\n                           data-avatar-y="${d}"\n                           data-avatar-scale="${u}">\n                        ${p?'':`<span>${h(o.charAt(0))}</span>`}\n                      </div>\n                    </div>\n                    <div class="acu-del-info">\n                      <div class="acu-del-name">${h(o)}</div>\n                      <div class="acu-del-meta">头像配置与映射记录</div>\n                    </div>\n                  </div>\n                </div>\n\n                \x3c!-- 关联数据 (橙色区域) --\x3e\n                ${i||s.length>0?`\n                <div class="acu-del-section warning">\n                  <div class="acu-del-section-head">\n                    <i class="fa-solid fa-database"></i> 关联数据清理\n                  </div>\n                  <ul class="acu-del-list">\n                    ${i?`\n                      <li>\n                        <i class="fa-solid fa-table"></i>\n                        <span>主数据行: <strong>${h(i.tableKey)}</strong></span>\n                      </li>\n                    `:''}\n                    ${s.length>0?`\n                      <li class="sub-group">\n                        <div class="group-title"><i class="fa-solid fa-tags"></i> 别名 (${s.length}个)</div>\n                        <div class="group-content">${s.map(t=>`<span class="tag">${h(t)}</span>`).join('')}</div>\n                        ${f.length>0?`\n                          <div class="group-warning">\n                            <i class="fa-solid fa-trash-can"></i> 将删除 ${f.length} 行别名数据\n                            <span class="detail">(${f.map(t=>t.tableKey).slice(0,3).join(', ')}${f.length>3?'...':''})</span>\n                          </div>\n                        `:''}\n                      </li>\n                    `:''}\n                  </ul>\n                </div>\n                `:''}\n\n                \x3c!-- 关系引用 (橙色区域 - 与关联数据清理一致) --\x3e\n                ${r.length>0?`\n                <div class="acu-del-section warning">\n                  <div class="acu-del-section-head">\n                    <i class="fa-solid fa-link"></i> 人际关系清除\n                  </div>\n                  <div class="acu-del-summary">\n                    将从 <strong>${r.length}</strong> 处人际关系中移除此角色\n                  </div>\n                  <ul class="acu-del-list compact">\n                    ${r.slice(0,5).map(t=>`\n                      <li>\n                        <i class="fa-solid fa-user-tag"></i>\n                        <span>${h(t.tableName)}.${h(t.characterName)}${t.matchedRelation?` <span class="relation-tag">${h(t.matchedRelation)}</span>`:''}</span>\n                      </li>\n                    `).join('')}\n                    ${r.length>5?`<li class="more">... 以及其他 ${r.length-5} 处</li>`:''}\n                  </ul>\n                </div>\n                `:''}\n\n                <div class="acu-del-final-warn">\n                  此操作 <strong>不可撤销</strong>，请确认是否继续？\n                </div>\n              </div>\n\n              \x3c!-- 底部按钮 --\x3e\n              <div class="acu-delete-actions">\n                <button class="acu-delete-cancel-btn">\n                  取消\n                </button>\n                <button class="acu-delete-confirm-btn destruct">\n                  <i class="fa-solid fa-trash"></i> 确认永久删除\n                </button>\n              </div>\n            </div>\n          </div>\n        `,m=$(g);$('body').append(m),m.find('.acu-avatar-preview').each(function(){const t=$(this),n=t.attr('data-avatar-url');if(!n)return;const e=Number(t.attr('data-avatar-x')||50),a=Number(t.attr('data-avatar-y')||50),o=Number(t.attr('data-avatar-scale')||150);t.css({'--acu-avatar-image':`url('${n}')`,'--acu-avatar-x':`${e}%`,'--acu-avatar-y':`${a}%`,'--acu-avatar-scale':`${o}%`})});const b=()=>{m.addClass('closing'),setTimeout(()=>{m.remove(),a?.()},200)},v=t=>{'Escape'===t.key&&(b(),$(document).off('keydown',v))};$(document).on('keydown',v),m.on('click',function(t){$(t.target).hasClass('acu-delete-confirm-overlay')&&b()}),m.find('.acu-delete-cancel-btn').on('click',b),m.find('.acu-delete-close-btn').on('click',b),m.find('.acu-delete-confirm-btn').on('click',()=>{m.find('.acu-delete-confirm-btn').prop('disabled',!0).html('<i class="fa-solid fa-spinner fa-spin"></i> 删除中...'),setTimeout(()=>{b(),n()},50)})},k=async e=>{try{const a=Ft.getAll()[e],o=a?.aliases||[];await Ft.deleteLocalAvatar(e),Ft.remove(e);const i=new Set;let r='function'==typeof pa?pa():null;if(r||console.warn('[DICE] 无法获取表格数据，跳过表格行删除'),r){const t=[e,...o].map(t=>t.toLowerCase());for(const[n,e]of Object.entries(r)){if(!n.startsWith('sheet_'))continue;if(!e||'object'!=typeof e)continue;const a=e;if(!Array.isArray(a.content)||a.content.length<2)continue;const o=a.content[0],r=['名字','角色名','姓名','name','Name','名称'];let c=-1;for(const t of r){const n=o.findIndex(n=>n===t);if(-1!==n){c=n;break}}if(-1!==c)for(let e=a.content.length-1;e>=1;e--){const o=a.content[e];if(!Array.isArray(o))continue;const r=o[c];r&&'string'==typeof r&&t.includes(r.toLowerCase())&&(a.content.splice(e,1),i.add(n),console.log(`[DICE] 已从表格 ${n} 删除角色行 [${e}]: ${r}`))}}}if(r){const t=[e,...o].map(t=>t.toLowerCase());for(const[n,e]of Object.entries(r)){if(!n.startsWith('sheet_'))continue;if(!e||'object'!=typeof e)continue;const a=e;if(!Array.isArray(a.content)||a.content.length<2)continue;const o=a.content[0].findIndex(t=>'人际关系'===t);if(-1!==o)for(let e=1;e<a.content.length;e++){const r=a.content[e];if(!Array.isArray(r))continue;const c=r[o];if('string'!=typeof c||!c)continue;const s=c.split(/[;；]/),l=s.filter(n=>{const[e]=n.split(/[:：]/);return!e||!t.includes(e.trim().toLowerCase())}).join(';');l!==c&&(r[o]=l,i.add(n))}}}r&&i.size>0&&(await $a(r,Array.from(i)),'function'==typeof mo&&mo());const c=t.findIndex(t=>t.name===e);-1!==c&&t.splice(c,1),await b(),window.toastr&&window.toastr.success(`已删除角色 "${e}"`),n?.()}catch(t){console.error('[DICE] 删除角色失败:',t),window.toastr&&window.toastr.error('删除失败')}},C=()=>{g.on('click','.acu-view-toggle',async function(){const t=$(this),n='chat'===t.attr('data-view')?'global':'chat';t.attr('data-view',n),o=n;const e=t.find('i');'global'===n?(e.removeClass('fa-comments').addClass('fa-globe'),t.addClass('active')):(e.removeClass('fa-globe').addClass('fa-comments'),t.removeClass('active')),await b()});const e=_.debounce(async()=>{await b()},300);g.on('input','.acu-avatar-search',function(){c=$(this).val().trim();g.find('.acu-search-clear').toggle(!!c),e()}),g.on('click','.acu-search-clear',async function(){c='',g.find('.acu-avatar-search').val(''),$(this).hide(),await b()}),g.on('change','.acu-sort-field',async function(){i=$(this).val(),await b()}),g.on('click','.acu-sort-order',async function(){const t=$(this),n='asc'===t.attr('data-dir')?'desc':'asc';t.attr('data-dir',n),r=n;const e=t.find('i');'desc'===n?e.removeClass('fa-arrow-down-a-z').addClass('fa-arrow-up-a-z'):e.removeClass('fa-arrow-up-a-z').addClass('fa-arrow-down-a-z'),await b()}),g.on('click','.acu-avatar-preview',async function(t){t.stopPropagation();const e=$(this).closest('.acu-avatar-item'),a=e.data('name'),o=e.attr('data-display-url');o?ta(o,a,async t=>{const e=Ft.getAll()[a]||{};Ft.set(a,e.url||'',t.offsetX,t.offsetY,t.scale,e.aliases||[]),await m(a),n&&n()}):e.find('.acu-avatar-file-input').click()}),g.on('click','.acu-btn-edit',function(t){t.stopPropagation();const n=$(this).closest('.acu-avatar-item'),e=n.data('name');n.hasClass('expanded')?(n.removeClass('expanded'),s.delete(e),$(this).find('i').removeClass('fa-chevron-up').addClass('fa-pencil')):(n.addClass('expanded'),s.add(e),$(this).find('i').removeClass('fa-pencil').addClass('fa-chevron-up'))}),g.on('keydown','.acu-alias-input',function(t){if('Enter'===t.key||','===t.key){t.preventDefault();const n=$(this).val().trim();if(n){const t=$(this).closest('.acu-alias-tags-container');let e=!1;if(t.find('.acu-alias-tag').each(function(){$(this).data('alias')===n&&(e=!0)}),!e){const t=`<span class="acu-alias-tag" data-alias="${h(n)}">${h(n)} <i class="fa-solid fa-xmark"></i></span>`;$(this).before(t)}$(this).val('')}}else'Backspace'!==t.key||$(this).val()||$(this).prev('.acu-alias-tag').remove()}),g.on('input','.acu-alias-input',function(t){const n=$(this).val();if(n.includes(',')||n.includes('，')){const t=n.split(/[,，]/),e=t.pop(),a=$(this).closest('.acu-alias-tags-container');t.forEach(t=>{const n=t.trim();if(n){let t=!1;if(a.find('.acu-alias-tag').each(function(){$(this).data('alias')===n&&(t=!0)}),!t){const t=`<span class="acu-alias-tag" data-alias="${h(n)}">${h(n)} <i class="fa-solid fa-xmark"></i></span>`;$(this).before(t)}}}),$(this).val(e)}}),g.on('paste','.acu-alias-input',function(t){t.preventDefault();const n=(t.originalEvent||t).clipboardData.getData('text');if(!n)return;const e=n.split(/[,，\n]/),a=$(this).closest('.acu-alias-tags-container');e.forEach(t=>{const n=t.trim();if(n){let t=!1;if(a.find('.acu-alias-tag').each(function(){$(this).data('alias')===n&&(t=!0)}),!t){const t=`<span class="acu-alias-tag" data-alias="${h(n)}">${h(n)} <i class="fa-solid fa-xmark"></i></span>`;$(this).before(t)}}})}),g.on('click','.acu-alias-tag i',function(){$(this).parent().remove()}),g.on('click','.acu-alias-tags-container',function(t){t.target===this&&$(this).find('.acu-alias-input').focus()}),g.on('change','.acu-avatar-file-input',async function(t){const e=t.target.files[0];if(!e)return;if(!e.type.startsWith('image/'))return void(window.toastr&&window.toastr.warning('请选择图片文件'));if(e.size>5242880)return void(window.toastr&&window.toastr.warning('图片大小不能超过 5MB'));const a=$(this).closest('.acu-avatar-item').data('name');try{if(await Ft.saveLocalAvatar(a,e)){const t=await Et.get(a);await m(a),ta(t,a,async t=>{const e=Ft.getAll()[a]||{};Ft.set(a,e.url||'',t.offsetX,t.offsetY,t.scale,e.aliases||[]),await m(a),n&&n()})}}catch(t){console.error('[DICE]ACU 上传头像失败:',t),window.toastr&&window.toastr.error('上传失败')}$(this).val('')}),g.on('click','.acu-protagonist-toggle',function(){const t=$(this),n=!1===qt().autoMergeProtagonist;Yt({autoMergeProtagonist:n}),t.toggleClass('active',n),t.find('i').attr('class','fa-solid '+(n?'fa-link':'fa-link-slash')),window.toastr&&window.toastr.info(n?'已开启自动合并"主角"':'已关闭自动合并"主角"')}),g.on('click','.acu-avatar-save-btn',async function(){const t=$(this).closest('.acu-avatar-item'),e=t.data('name'),a=t.find('.acu-avatar-url').val().trim(),o=[];t.find('.acu-alias-tag').each(function(){o.push($(this).data('alias'))});const i=t.find('.acu-alias-input').val().trim();i&&!o.includes(i)&&o.push(i);const r=Ft.getAll()[e]||{};Ft.set(e,a,r.offsetX??50,r.offsetY??50,r.scale??150,o);const c='true'===t.attr('data-has-local');a&&!c?(await m(e),ta(a,e,async t=>{Ft.set(e,a,t.offsetX,t.offsetY,t.scale,o),await m(e),n&&n()})):(await m(e),n&&n())}),g.on('click','.acu-avatar-clear-all-btn',async function(){const t=$(this).closest('.acu-avatar-item'),e=t.data('name');t.find('.acu-avatar-url').val('');await Ft.hasLocalAvatar(e)&&await Et.delete(e);const a=Ft.getAll()[e]||{};Ft.set(e,'',a.offsetX??50,a.offsetY??50,a.scale??150,a.aliases||[]),await m(e),n&&n()}),g.on('click','.acu-avatar-clear-alias-btn',function(){const t=$(this).closest('.acu-avatar-item');t.find('.acu-alias-tag').remove(),t.find('.acu-alias-input').val('')}),g.on('click','.acu-avatar-clear-btn',async function(){const t=$(this).closest('.acu-avatar-item').data('name');if('{{user}}'===t)return void(window.toastr&&window.toastr.warning('无法删除主角'));const n=Ft.getAll()[t],e=n?.aliases||[],a=v(t),o=x(t,e);let i='';await Ft.hasLocalAvatar(t)?i=await Et.get(t)||'':n?.url&&(i=n.url),w({name:t,avatarUrl:i,tableRow:a,relationships:o},()=>k(t))}),g.on('click','.acu-avatar-export-btn',function(){const t=Ft.exportData(),n=JSON.stringify(t,null,2),e=new Blob([n],{type:'application/json'}),a=URL.createObjectURL(e),o=document.createElement('a');o.href=a,o.download=`avatar-config-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}),g.on('click','.acu-avatar-import-btn',function(){g.find('#acu-avatar-file-input').click()}),g.on('change','#acu-avatar-file-input',function(e){const a=e.target.files[0];if(!a)return;const o=new FileReader;o.onload=function(e){try{const a=JSON.parse(e.target.result),o=Ft.analyzeImport(a);if(!o.valid)return void(window.toastr&&window.toastr.error(o.error));oa(a,o,()=>{g.remove(),na(t,n),n&&n()})}catch(t){console.error('[DICE]ACU 导入解析失败:',t),window.toastr&&window.toastr.error('文件解析失败')}},o.readAsText(a),$(this).val('')})},E=()=>g.remove();g.on('click','.acu-avatar-close',E),y(g,'acu-avatar-manager-overlay',E)}catch(t){if(console.error('头像管理器错误:',t),window.toastr){const n=t instanceof Error?t.message:'未知错误';window.toastr.error(`头像管理器加载失败: ${n}`)}$('.acu-avatar-manager-overlay').remove()}},ea=async()=>{if('caches'in window)try{const t=await caches.keys(),n=['jsdelivr.net/gh/jerryzmtz/my-tavern-scripts','/dist/骰子系统/'];for(const e of t){const t=await caches.open(e),a=await t.keys();for(const e of a){const a=e.url;n.some(t=>a.includes(t))&&(await t.delete(e),console.log('[DICE] 已清理缓存:',a))}}console.log('[DICE] 脚本缓存清理完成')}catch(t){console.warn('[DICE] 缓存清理失败:',t)}else console.log('[DICE] Cache API 不可用，直接刷新')},aa=t=>{const{$}=le();$('.acu-manual-update-overlay').remove();const n=ca(),e=t?.title||'手动更新',a=t?.iconClass||'fa-rotate',o=t?.description||'将清理脚本缓存并刷新页面，以获取最新版本。',i=t?.safeTitle||'数据安全',r=t?.safeDescription||'您的自定义规则、预设、正则转换、黑名单等数据存储在本地游览器中，不会受到影响。',c=t?.confirmText||'立即更新',s=t?.loadingText||'更新中...',l=t?.onConfirm,d=t?.isDanger||!1,u=t?.safeIconClass||(d?'fa-triangle-exclamation':'fa-shield-check'),p=$(`\n    <div class="acu-manual-update-overlay acu-theme-${n.theme}">\n      <div class="acu-manual-update-dialog" style="background:var(--acu-bg-panel);border-color:var(--acu-border);max-width:420px;box-shadow:0 8px 24px rgba(0,0,0,0.3);">\n        <div class="acu-manual-update-header" style="background:var(--acu-table-head);color:var(--acu-text-main);border-bottom:1px solid var(--acu-border);padding:12px 16px;font-weight:bold;font-size:1.1em;display:flex;align-items:center;gap:8px;">\n          <i class="fa-solid ${h(a)}" style="font-size:1.1em;"></i> ${h(e)}\n        </div>\n        <div class="acu-manual-update-body" style="color:var(--acu-text-main);padding:20px 16px;">\n          <p style="color:var(--acu-text-main);margin-bottom:16px;line-height:1.5;">${h(o)}</p>\n          <div class="acu-manual-update-safe-box" style="background:var(--acu-btn-bg);border:1px solid var(--acu-border);border-radius:6px;padding:12px;display:flex;gap:12px;align-items:flex-start;">\n            <i class="fa-solid ${h(u)}" style="color:var(--acu-accent);font-size:1.2em;margin-top:2px;"></i>\n            <div class="safe-text" style="display:flex;flex-direction:column;gap:4px;">\n              <strong style="color:var(--acu-text-main);font-size:0.95em;">${h(i)}</strong>\n              <span style="color:var(--acu-text-sub);font-size:0.85em;line-height:1.4;">${h(r)}</span>\n            </div>\n          </div>\n        </div>\n        <div class="acu-manual-update-footer" style="background:var(--acu-table-head);border-top:1px solid var(--acu-border);padding:12px 16px;display:flex;justify-content:flex-end;gap:10px;">\n          <button class="acu-manual-update-cancel-btn" style="background:transparent;color:var(--acu-text-sub);border:1px solid var(--acu-border);padding:6px 16px;border-radius:4px;cursor:pointer;transition:all 0.2s;">取消</button>\n          <button class="acu-manual-update-confirm-btn" style="background:var(--acu-accent);color:var(--acu-btn-active-text, #fff);border:none;padding:6px 20px;border-radius:4px;cursor:pointer;font-weight:bold;box-shadow:0 2px 4px rgba(0,0,0,0.2);transition:all 0.2s;">${h(c)}</button>\n        </div>\n      </div>\n    </div>\n  `);$('body').append(p);const f=p[0];p.find('.acu-manual-update-cancel-btn').on('click',()=>{p.remove()}),p.find('.acu-manual-update-confirm-btn').on('click',async()=>{const t=p.find('.acu-manual-update-confirm-btn');t.prop('disabled',!0).html(`<i class="fa-solid fa-spinner fa-spin"></i> ${h(s)}`);try{if(l)return await l(),void p.remove();await ea(),window.parent!==window?window.parent.location.reload():window.location.reload()}catch(n){console.error('[DICE] 手动弹窗操作失败:',n),window.toastr&&window.toastr.error('操作失败，请查看控制台日志'),t.prop('disabled',!1).html(h(c))}}),p.on('click',t=>{t.target===f&&p.remove()})},oa=(t,n,e)=>{const{$}=le();$('.acu-import-confirm-overlay').remove();const a=ca(),o=n.conflicts.length>0,i=n.conflicts.length>0?`<div style="max-height:80px;overflow-y:auto;background:rgba(0,0,0,0.1);border-radius:4px;padding:6px 8px;margin-top:6px;font-size:11px;color:var(--acu-text-sub);">${n.conflicts.map(t=>h(t)).join(', ')}</div>`:'',r=$(`\n            <div class="acu-import-confirm-overlay acu-theme-${a.theme}">\n                <div class="acu-import-confirm-dialog">\n                    <div class="acu-import-confirm-header">\n                        <span class="acu-import-confirm-title"><i class="fa-solid fa-file-import"></i> 导入头像配置</span>\n                        <button class="acu-import-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-import-confirm-body">\n                        <div class="acu-import-stats">\n                            <div class="acu-import-stat">\n                                <span class="acu-stat-num">${n.total}</span>\n                                <span class="acu-stat-label">总计</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-new">\n                                <span class="acu-stat-num">${n.newItems.length}</span>\n                                <span class="acu-stat-label">新增</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-conflict">\n                                <span class="acu-stat-num">${n.conflicts.length}</span>\n                                <span class="acu-stat-label">冲突</span>\n                            </div>\n                        </div>\n\n                        ${o?`\n                            <div class="acu-import-conflict-section">\n                                <div class="acu-import-warning">\n                                    <i class="fa-solid fa-exclamation-triangle"></i> 以下角色已存在：\n                                </div>\n                                ${i}\n                                <div class="acu-import-conflict-options">\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="overwrite" checked />\n                                        <span>用导入的覆盖本地</span>\n                                    </label>\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="skip" />\n                                        <span>保留本地的不变</span>\n                                    </label>\n                                </div>\n                            </div>\n                        `:'\n                            <div class="acu-import-success">\n                                <i class="fa-solid fa-check-circle"></i> 无冲突，可直接导入\n                            </div>\n                        '}\n                    </div>\n                    <div class="acu-import-confirm-footer">\n                        <button class="acu-import-cancel-btn">取消</button>\n                        <button class="acu-import-confirm-btn">确认导入</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(r);r[0].style.cssText='\n            position: fixed !important;\n            top: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            bottom: 0 !important;\n            width: 100vw !important;\n            height: 100vh !important;\n            background: rgba(0,0,0,0.6) !important;\n            z-index: 31300 !important;\n            display: flex;\n            justify-content: center !important;\n            align-items: center !important;\n            padding: 16px;\n            box-sizing: border-box !important;\n        ';const c=()=>r.remove();r.find('.acu-import-cancel-btn').click(c),r.find('.acu-import-close-btn').click(c),y(r,'acu-import-confirm-overlay',c),r.find('.acu-import-confirm-btn').click(function(){const n='skip'!==r.find('input[name="conflict-mode"]:checked').val();try{Ft.importData(t,n);c(),e&&e()}catch(t){console.error('[DICE]ACU 导入失败:',t),window.toastr&&window.toastr.error('导入失败：'+t.message)}})},ia=(t,n,e,a,o)=>{const{$}=le(),i=ca();let r=Yn||pa()||ke(),c=t;r&&r[o]&&r[o]?.content?.[a+1]&&(c=r[o]?.content?.[a+1]);const s=c.map((t,e)=>{if(0===e)return'';const a=n[e]||`列 ${e}`,o=t||'';return`\n                <div class="acu-card-edit-field">\n                    <label class="acu-card-edit-label">${h(a)}</label>\n                    <textarea class="acu-card-edit-input acu-card-edit-textarea" data-col="${e}" spellcheck="false" rows="1">${h(o)}</textarea>\n                </div>`}).join(''),l=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${i.theme}">\n                    <div class="acu-edit-title">整体编辑 (#${a+1} - ${h(e)})</div>\n                    <div class="acu-settings-content acu-settings-content-scroll">\n                        ${s}\n                    </div>\n                     <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-card-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-card-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(l);const d=t=>{t.style.height='auto';const n=t.scrollHeight+2;t.style.height=Math.min(n,500)+'px',t.style.overflowY=n>500?'auto':'hidden'};requestAnimationFrame(()=>{l.find('textarea').each(function(){d(this)})}),l.find('textarea').on('input',function(){d(this)});const u=()=>l.remove();l.find('#dlg-card-cancel').click(u),l.find('#dlg-card-save').click(async()=>{let t=Yn||pa()||ke();if(t&&t[o]){const n=t[o]?.content?.[a+1];if(!n)return void u();let e=!1;if(l.find('textarea').each(function(){const t=parseInt($(this).data('col')),a=$(this).val();String(n[t])!==String(a)&&(e=!0,n[t]=a)}),e)try{await ka(o,a,[...n]),mo()}catch(t){return void console.error('[DICE]ACU 保存失败:',t)}}u()}),y(l,'acu-edit-overlay',u),l.on('click',function(t){$(t.target).closest('#dlg-close-x, #dlg-close, .acu-close-btn').length&&u()})};let ra=null;const ca=()=>(ra||(ra={...ie,...fe.get(D,{})}),ra),sa=t=>{ra={...ca(),...t},fe.set(D,ra);const n=da(ra);i(ra.theme,n),c(!0===ra.muteDatabaseToasts)},la=t=>{const n=ke(),e=new Set;if(!n)return e;for(const a in t){const o=t[a],i=n[a];if(!o||!o.name)continue;const r=o.name;if(!i){o.content&&o.content.forEach((t,n)=>{n>0&&e.add(`${r}-row-${n-1}`)});continue}const c=o.content||[],s=i.content||[],l=new Map;s.forEach((t,n)=>{if(0===n)return;const e=String(t[1]??'').trim();e&&(l.has(e)||l.set(e,[]),l.get(e).push({index:n,row:t}))});const d=new Set;c.forEach((t,n)=>{if(0===n)return;const a=String(t[1]??'').trim();let o=null;if(a&&l.has(a)){const t=l.get(a);if(t.length>0){const n=t.shift();o=n.row,d.add(n.index),0===t.length&&l.delete(a)}}if(!o&&!a){const t=s[n];t&&!d.has(n)&&(o=t,d.add(n))}o?t.forEach((t,a)=>{if(0===a)return;const i=o[a];String(t??'')!==String(i??'')&&e.add(`${r}-${n-1}-${a}`)}):e.add(`${r}-row-${n-1}`)})}return e},da=t=>{const{$}=le(),n=$('.acu-wrapper'),e=re.find(n=>n.id===t.fontFamily)?.val||re[0].val,a=$('#acu-dynamic-font');if(a.data('font-id')!==t.fontFamily){a.remove();const n='\n                @import url("https://fontsapi.zeoseven.com/3/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/442/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/256/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/482/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/446/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/570/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/292/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/69/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/7/main/result.css");\n            ';$('head').append(`\n                <style id="acu-dynamic-font" data-font-id="${t.fontFamily}">\n                    ${n}\n                    .acu-wrapper, .acu-edit-dialog, .acu-cell-menu, .acu-nav-container, .acu-data-card, .acu-panel-title, .acu-settings-label, .acu-btn-block, .acu-nav-btn, .acu-edit-textarea,\n                    .acu-dice-panel, .acu-contest-panel, .acu-dice-config-dialog,\n                    .acu-relation-graph-container, .acu-avatar-manager, .acu-import-confirm-dialog,\n                    .acu-embedded-options-container, .acu-option-panel, .acu-opt-btn {\n                        font-family: ${e} !important;\n                    }\n                </style>\n            `)}const o={'--acu-card-width':`${t.cardWidth}px`,'--acu-font-size':`${t.fontSize}px`,'--acu-opt-font-size':`${t.optionFontSize||12}px`,'--acu-grid-cols':t.gridColumns};n.length&&(n.removeClass((t,n)=>(n.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),n.addClass(`acu-theme-${t.theme}`),n.css(o));const i=$('.acu-embedded-options-container');return i.length&&(i.removeClass((t,n)=>(n.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),i.addClass(`acu-theme-${t.theme}`),i.css(o)),e},ua=()=>{if(window._acuStylesInjected&&$(`#${t}-styles`).length)return;window._acuStylesInjected=!0;const{$}=le();$('#tabler-icons-css').length||$('head').append('<link id="tabler-icons-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">'),$('style').each(function(){this.id&&this.id.startsWith('acu_')&&this.id.endsWith('-styles')&&this.id!==`${t}-styles`&&$(this).remove()}),$(`#${t}-styles`).remove();const n=`<style id="${t}-styles">\n    /* ========== 核心隔离层 ========== */\n    .acu-wrapper,\n    .acu-wrapper *:not(i[class*="fa-"]),\n    .acu-edit-overlay,\n    .acu-edit-overlay *:not(i[class*="fa-"]),\n    .acu-cell-menu,\n    .acu-cell-menu *:not(i[class*="fa-"]),\n    .acu-dice-panel,\n    .acu-dice-panel *:not(i[class*="fa-"]),\n    .acu-contest-panel,\n    .acu-contest-panel *:not(i[class*="fa-"]),\n    .acu-relation-graph-overlay,\n    .acu-relation-graph-overlay *:not(i[class*="fa-"]),\n    .acu-avatar-manager-overlay,\n    .acu-avatar-manager-overlay *:not(i[class*="fa-"]),\n    .acu-preview-overlay,\n    .acu-preview-overlay *:not(i[class*="fa-"]),\n    .acu-import-confirm-overlay,\n    .acu-import-confirm-overlay *:not(i[class*="fa-"]),\n    .acu-embedded-options-container,\n    .acu-embedded-options-container *:not(i[class*="fa-"]) {\n        box-sizing: border-box;\n        -webkit-tap-highlight-color: transparent;\n        -webkit-font-smoothing: antialiased;\n    }\n    /* ========== 基础样式 ========== */\n    .acu-wrapper,\n    .acu-edit-overlay,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-embedded-options-container,\n    .acu-cell-menu {\n        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;\n        font-size: 13px;\n        line-height: 1.5;\n        color: var(--acu-text-main);\n    }\n    /* 投骰面板统一样式 (需要 !important 覆盖 SillyTavern 全局样式和内联样式) */\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    .acu-dice-panel input[type="text"],\n    .acu-dice-panel input[type="number"],\n    .acu-dice-panel input:not([type]),\n    .acu-dice-panel select,\n    .acu-contest-panel input[type="text"],\n    .acu-contest-panel input[type="number"],\n    .acu-contest-panel input:not([type]),\n    .acu-contest-panel select,\n    .acu-dice-config-dialog input[type="text"],\n    .acu-dice-config-dialog input[type="number"],\n    .acu-dice-config-dialog input:not([type]),\n    .acu-dice-config-dialog select {\n        width: 100%;\n        text-align: center;\n        padding: 6px;\n        background: var(--acu-input-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 4px;\n        color: var(--acu-input-text, var(--acu-text-main)) !important;\n        font-size: 12px;\n        height: 30px;\n        line-height: 1;\n        box-sizing: border-box;\n    }\n    /* select 需要额外处理以匹配 input 尺寸 */\n    .acu-dice-panel select,\n    .acu-contest-panel select,\n    .acu-dice-config-dialog select {\n        -webkit-appearance: none;\n        -moz-appearance: none;\n        appearance: none;\n        padding: 0 6px;\n        margin: 0;\n        text-align-last: center;\n        display: block;\n    }\n    /* 隐藏number类型输入框的步数器 */\n    .acu-dice-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-outer-spin-button {\n        -webkit-appearance: none;\n        margin: 0;\n    }\n    .acu-dice-panel input[type="number"],\n    .acu-contest-panel input[type="number"],\n    .acu-dice-config-dialog input[type="number"] {\n        -moz-appearance: textfield;\n        text-align: center;\n        box-sizing: border-box;\n    }\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-dice-config-dialog input::placeholder {\n        color: var(--acu-input-placeholder, var(--acu-text-sub)) !important;\n        opacity: 0.7;\n        text-align: center;\n    }\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-dice-config-dialog input:focus,\n    .acu-dice-config-dialog select:focus {\n        outline: none;\n        border-color: var(--acu-accent) !important;\n    }\n    .acu-dice-panel select option,\n    .acu-contest-panel select option,\n    .acu-dice-config-dialog select option {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    /* 搜索框样式 */\n    .acu-wrapper .acu-search-input {\n        background-color: var(--acu-input-bg) !important;\n        color: var(--acu-text-main) !important;\n        border: 1px solid var(--acu-border);\n    }\n    .acu-wrapper .acu-search-input:focus {\n        outline: none;\n        border-color: var(--acu-accent);\n        box-shadow: none !important;\n    }\n    .acu-wrapper .acu-search-input::placeholder {\n        color: var(--acu-text-sub) !important;\n        opacity: 0.7;\n    }\n    /* ========== 通用组件基类 ========== */\n    /* 按钮基类 */\n    .acu-wrapper button,\n    .acu-edit-overlay button,\n    .acu-dice-panel button,\n    .acu-contest-panel button,\n    .acu-relation-graph-overlay button,\n    .acu-avatar-manager-overlay button,\n    .acu-preview-overlay button,\n    .acu-embedded-options-container button:not(.acu-opt-btn) {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        cursor: pointer;\n        border: 1px solid var(--acu-border);\n        border-radius: 6px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        transition: all 0.2s ease;\n        outline: none;\n    }\n    .acu-wrapper button:hover,\n    .acu-edit-overlay button:hover,\n    .acu-dice-panel button:hover,\n    .acu-contest-panel button:hover,\n    .acu-relation-graph-overlay button:hover,\n    .acu-avatar-manager-overlay button:hover,\n    .acu-preview-overlay button:hover,\n    .acu-embedded-options-container button:not(.acu-opt-btn):hover {\n        background: var(--acu-btn-hover);\n    }\n    .acu-wrapper button:focus,\n    .acu-edit-overlay button:focus,\n    .acu-dice-panel button:focus,\n    .acu-contest-panel button:focus,\n    .acu-relation-graph-overlay button:focus,\n    .acu-avatar-manager-overlay button:focus,\n    .acu-preview-overlay button:focus,\n    .acu-embedded-options-container button:not(.acu-opt-btn):focus {\n        outline: none;\n        box-shadow: none;\n    }\n\n    /* 输入框基类 */\n    .acu-wrapper input,\n    .acu-wrapper textarea,\n    .acu-wrapper select,\n    .acu-edit-overlay input,\n    .acu-edit-overlay textarea,\n    .acu-edit-overlay select,\n    .acu-dice-panel input,\n    .acu-dice-panel select,\n    .acu-contest-panel input,\n    .acu-contest-panel select,\n    .acu-avatar-manager-overlay input.acu-input {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        border: 1px solid var(--acu-border);\n        border-radius: 4px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        outline: none;\n        transition: border-color 0.2s;\n    }\n    .acu-wrapper input:focus,\n    .acu-wrapper textarea:focus,\n    .acu-wrapper select:focus,\n    .acu-edit-overlay input:focus,\n    .acu-edit-overlay textarea:focus,\n    .acu-edit-overlay select:focus,\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-avatar-manager-overlay input.acu-input:focus {\n        border-color: var(--acu-accent);\n        box-shadow: none;\n        outline: none;\n    }\n    .acu-wrapper input::placeholder,\n    .acu-wrapper textarea::placeholder,\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-avatar-manager-overlay input.acu-input::placeholder {\n        color: var(--acu-text-sub);\n        opacity: 0.7;\n    }\n\n    /* 确保重要人物表（卡片）和 MVU 面板中的输入框始终有高对比度 */\n    .acu-data-card input,\n    .acu-data-card textarea,\n    .acu-mvu-panel input,\n    .acu-mvu-panel textarea {\n        color: var(--SillyTavern-text-color, #e0e0e0) !important;\n        background-color: var(--SillyTavern-bar-color, #0b0b0b) !important;\n    }\n    .acu-data-card input::placeholder,\n    .acu-data-card textarea::placeholder,\n    .acu-mvu-panel input::placeholder,\n    .acu-mvu-panel textarea::placeholder {\n        color: var(--SillyTavern-text-color, #e0e0e0) !important;\n        opacity: 0.7 !important;\n    }\n\n    /* 弹窗遮罩层基类 */\n    .acu-edit-overlay,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-crop-modal-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0,0,0,0.6);\n        z-index: 31010;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 16px;\n        backdrop-filter: blur(2px);\n    }\n    /* 骰子面板遮罩层 - 需要在 preview-overlay(31100) 之上，属于编辑层(31200) */\n    .acu-dice-overlay,\n    .acu-contest-overlay,\n    .acu-dice-config-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0,0,0,0.6);\n        z-index: 31200 !important;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 16px;\n        backdrop-filter: blur(2px);\n    }\n\n    /* 弹窗容器基类 */\n    .acu-edit-dialog,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-container,\n    .acu-avatar-manager,\n    .acu-import-confirm-dialog,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        border: 1px solid var(--acu-border);\n        border-radius: 12px;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.4);\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n    }\n\n    /* ========== 骰子面板专用样式 ========== */\n    /* 骰子面板 - 属于编辑层(31200+)，需要在 preview-overlay(31100) 之上 */\n    .acu-dice-panel,\n    .acu-contest-panel {\n        position: relative;\n        z-index: 31201 !important;\n        width: 340px;\n        max-width: calc(100vw - 32px);\n        max-height: calc(100vh - 32px);\n        max-height: calc(100dvh - 32px);\n    }\n    .acu-dice-panel-header {\n        padding: 12px 15px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n    }\n    .acu-dice-panel-title {\n        font-size: 15px;\n        font-weight: bold;\n        color: var(--acu-accent);\n        display: flex;\n        align-items: center;\n        gap: 8px;\n    }\n    .acu-dice-panel-actions {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n    }\n    .acu-dice-panel-actions button {\n        background: none;\n        border: none;\n        color: var(--acu-text-sub);\n        cursor: pointer;\n        font-size: 14px;\n        padding: 4px;\n        transition: all 0.2s;\n    }\n    .acu-dice-panel-actions button:hover {\n        color: var(--acu-accent);\n    }\n    .acu-dice-panel-body {\n        padding: 15px;\n        flex: 1;\n        min-height: 0;\n        overflow-y: auto;\n        overscroll-behavior: contain;\n        -webkit-overflow-scrolling: touch;\n    }\n    .acu-dice-presets {\n        display: flex;\n        gap: 6px;\n        flex-wrap: wrap;\n        margin-bottom: 12px;\n        align-items: center;\n    }\n    /* 预设快捷按钮区 */\n    .acu-dice-quick-presets {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 8px;\n        margin-bottom: 10px;\n        align-items: center;\n        max-height: 72px; /* 约两行高度: (28px + 8px) * 2 */\n        overflow-y: auto;\n        overflow-x: hidden;\n    }\n\n    .acu-dice-return-btn {\n        width: 100%;\n        padding: 8px;\n        background: var(--acu-btn-bg);\n        border: 1px dashed var(--acu-accent);\n        border-radius: 6px;\n        color: var(--acu-accent);\n        font-size: 13px;\n        font-weight: bold;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        margin-bottom: 8px;\n        transition: all 0.2s;\n    }\n    .acu-dice-return-btn:hover {\n        background: var(--acu-btn-hover);\n        filter: brightness(1.1);\n    }\n    .acu-dice-return-btn i {\n        font-size: 14px;\n    }\n    .acu-dice-quick-preset-btn {\n        padding: 2px 8px;\n        background: var(--acu-btn-bg);\n        border: 1px solid var(--acu-border);\n        border-radius: 6px;\n        color: var(--acu-text-main);\n        font-size: 10px;\n        cursor: pointer;\n        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n        max-width: 150px;\n        text-overflow: ellipsis;\n        overflow: hidden;\n        white-space: nowrap;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        line-height: 1.4;\n        user-select: none;\n    }\n    .acu-dice-quick-preset-btn:hover:not(.active) {\n        background: var(--acu-btn-hover);\n        border-color: var(--acu-accent);\n        color: var(--acu-accent);\n    }\n    .acu-dice-quick-preset-btn.active,\n    .acu-dice-quick-preset-btn.active:hover {\n        background: var(--acu-accent);\n        color: var(--acu-button-text-on-accent, #fff);\n        border-color: var(--acu-accent);\n        font-weight: 500;\n        box-shadow: 0 2px 6px rgba(var(--acu-accent-rgb, 128, 128, 128), 0.3);\n    }\n    .acu-dice-quick-preset-btn.active:hover {\n        filter: brightness(0.92);\n        box-shadow: 0 3px 8px rgba(var(--acu-accent-rgb, 128, 128, 128), 0.4);\n    }\n    .acu-dice-form-row {\n        display: grid;\n        gap: 6px;\n        margin-bottom: 6px;\n    }\n    .acu-dice-form-row.cols-2 { grid-template-columns: 1fr 1fr; }\n    .acu-dice-form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }\n    .acu-dice-form-label {\n        font-size: 10px;\n        color: var(--acu-text-sub);\n        margin-bottom: 2px;\n        min-height: 18px;\n        display: flex;\n        align-items: center;\n    }\n    .acu-dice-form-label.center { justify-content: center; }\n    /* Section Title (Party A/B, Quick Select) */\n    .acu-dice-section-title {\n        display: flex;\n        align-items: flex-start;\n        justify-content: space-between;\n        flex-wrap: wrap;\n        margin-bottom: 6px;\n        min-height: 24px;\n    }\n    .acu-dice-section-title > span {\n        font-size: 12px;\n        font-weight: bold;\n        color: var(--acu-accent);\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        white-space: nowrap;\n    }\n    .acu-dice-preset-quick-actions {\n        display: inline-flex;\n        align-items: center;\n        gap: 4px;\n        margin-left: 6px;\n    }\n    .acu-dice-preset-action-btn {\n        width: 20px;\n        height: 20px;\n        padding: 0;\n        border-radius: 4px;\n        border: 1px solid var(--acu-border);\n        background: var(--acu-btn-bg);\n        color: var(--acu-accent);\n        cursor: pointer;\n        display: inline-flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n    }\n    .acu-dice-preset-action-btn:hover {\n        background: var(--acu-btn-hover);\n        border-color: var(--acu-accent);\n    }\n    .acu-dice-preset-action-btn i {\n        font-size: 10px;\n    }\n    .acu-dice-preset-action-btn.disabled {\n        opacity: 0.6;\n        cursor: default;\n    }\n    .acu-dice-quick-section {\n        margin-bottom: 10px;\n    }\n    .acu-dice-quick-title {\n        font-size: 10px;\n        color: var(--acu-text-sub);\n        font-weight: bold;\n        margin-bottom: 4px;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n    }\n    .acu-dice-quick-buttons {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 4px;\n        max-height: 60px;\n        overflow-y: auto;\n    }\n    .acu-dice-quick-inline {\n        display: flex;\n        gap: 4px;\n        margin-left: 0;\n        margin-top: 4px;\n        flex: 1 1 100%;\n        align-content: flex-start;\n        min-width: 0;\n        max-width: 100%;\n        max-height: 63px;\n        overflow-x: hidden;\n        overflow-y: auto;\n        white-space: normal;\n        align-items: flex-start;\n        flex-wrap: wrap;\n        -webkit-overflow-scrolling: touch;\n    }\n    .acu-dice-quick-inline::-webkit-scrollbar { width: 6px; }\n    .acu-dice-quick-compact {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 3px;\n        margin-bottom: 8px;\n        max-height: 63px;\n        overflow-y: auto;\n        align-content: flex-start;\n    }\n    .acu-dice-panel .acu-dice-char-btn,\n    .acu-contest-panel .acu-dice-char-btn,\n    .acu-dice-panel .acu-dice-attr-btn,\n    .acu-contest-panel .acu-dice-attr-btn,\n    .acu-dice-panel .acu-dice-gen-attr-btn,\n    .acu-dice-panel .acu-dice-clear-attr-btn,\n    .acu-contest-panel .acu-contest-attr-btn,\n    .acu-contest-panel .acu-contest-gen-attr-btn,\n    .acu-contest-panel .acu-contest-clear-attr-btn {\n        padding: 1px 5px;\n        background: var(--acu-btn-bg);\n        border: 1px solid var(--acu-border);\n        border-radius: 4px;\n        color: var(--acu-text-main);\n        font-size: 11px;\n        cursor: pointer;\n        transition: all 0.2s;\n        white-space: nowrap;\n        flex-shrink: 0;\n        line-height: 1.3;\n        -webkit-tap-highlight-color: transparent;\n        touch-action: manipulation;\n    }\n    /* [修复] 覆盖酒馆全局触控优化样式 - 防止移动端按钮被强制放大 */\n    /* 酒馆全局规则: @media (hover: none) and (pointer: coarse) { button { min-width: 44px; min-height: 44px; } } */\n    /* 使用通配符一次性禁用所有骰子系统容器内的按钮，避免逐个添加 */\n    @media (hover: none) and (pointer: coarse) {\n        [class^="acu-"] button,\n        [class*=" acu-"] button,\n        [class^="acu-"] button[class],\n        [class*=" acu-"] button[class],\n        [id^="shujuku"] button {\n            min-width: unset !important;\n            min-height: unset !important;\n        }\n    }\n    .acu-dice-panel .acu-dice-char-btn:hover,\n    .acu-contest-panel .acu-dice-char-btn:hover,\n    .acu-dice-panel .acu-dice-attr-btn:hover,\n    .acu-contest-panel .acu-dice-attr-btn:hover,\n    .acu-dice-panel .acu-dice-gen-attr-btn:hover,\n    .acu-dice-panel .acu-dice-clear-attr-btn:hover,\n    .acu-contest-panel .acu-contest-attr-btn:hover,\n    .acu-contest-panel .acu-contest-gen-attr-btn:hover,\n    .acu-contest-panel .acu-contest-clear-attr-btn:hover {\n        background: var(--acu-btn-hover);\n    }\n    .acu-dice-panel .acu-dice-char-btn.active,\n    .acu-contest-panel .acu-dice-char-btn.active,\n    .acu-dice-panel .acu-dice-attr-btn.active,\n    .acu-contest-panel .acu-dice-attr-btn.active {\n        background: var(--acu-accent);\n        color: var(--acu-button-text-on-accent, #fff);\n        border-color: var(--acu-accent);\n    }\n    .acu-dice-roll-btn {\n        width: 100%;\n        padding: 12px;\n        background: var(--acu-accent);\n        border: none;\n        border-radius: 8px;\n        color: var(--acu-button-text, #fff);\n        font-size: 15px;\n        font-weight: bold;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        transition: all 0.2s;\n    }\n    .acu-dice-roll-btn:hover {\n        filter: brightness(1.1);\n    }\n    .acu-random-skill-btn {\n        width: 18px;\n        height: 18px;\n        padding: 0;\n        background: transparent;\n        border: 1px dashed var(--acu-accent);\n        border-radius: 4px;\n        color: var(--acu-accent);\n        font-size: 9px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n    }\n    .acu-random-skill-btn:hover {\n        background: var(--acu-btn-hover);\n    }\n\n    /* 弹窗头部基类 - 统一使用 .acu-panel-header */\n    .acu-panel-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 15px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        flex-shrink: 0;\n    }\n\n    /* 关闭按钮基类 - 所有关闭按钮统一使用 .acu-close-btn */\n    .acu-close-btn {\n        background: none !important;\n        border: none !important;\n        outline: none !important;\n        box-shadow: none !important;\n        color: var(--acu-text-sub);\n        cursor: pointer;\n        font-size: 16px;\n        padding: 4px;\n        border-radius: 4px;\n        transition: all 0.2s;\n    }\n    .acu-close-btn:hover {\n        background: none !important;\n        color: var(--acu-accent);\n    }\n\n    /* 滚动条全局隐藏 */\n    [class^="acu-"], [class^="acu-"] * { scrollbar-width: none; -ms-overflow-style: none; }\n    [class^="acu-"] *::-webkit-scrollbar { display: none !important; }\n\n    /* ========== 主题变量定义 ========== */\n    .acu-theme-retro { --acu-bg-nav: #e6e2d3; --acu-bg-panel: #e6e2d3; --acu-border: #dcd0c0; --acu-text-main: #5e4b35; --acu-text-sub: #999; --acu-btn-bg: #dcd0c0; --acu-btn-hover: #cbbba8; --acu-btn-active-bg: #8d7b6f; --acu-btn-active-text: #fdfaf5; --acu-accent: #7a695f; --acu-table-head: #efebe4; --acu-table-hover: #f0ebe0; --acu-opt-hover: #f7f3ed; --acu-opt-bg: #fffef9; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #fffef9; --acu-badge-bg: #efebe4; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #27ae60; --acu-success-bg: rgba(39, 174, 96, 0.15); --acu-scrollbar-track: #e6e2d3; --acu-scrollbar-thumb: #cbbba8; --acu-input-bg: #f5f2eb;--acu-hl-manual: #d35400; --acu-hl-manual-bg: rgba(211, 84, 0, 0.15); --acu-hl-diff: #2980b9; --acu-hl-diff-bg: rgba(41, 128, 185, 0.15); --acu-error-text: #e74c3c; --acu-error-bg: rgba(231, 76, 60, 0.15); --acu-error-border: rgba(231, 76, 60, 0.5); --acu-warning-icon: #e67e22; --acu-warning-text: #f39c12; --acu-warning-bg: rgba(243, 156, 18, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #5e4b35; --acu-gray-bg: rgba(128,128,128,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-dark { --acu-bg-nav: #2b2b2b; --acu-bg-panel: #252525; --acu-border: #444; --acu-text-main: #eee; --acu-text-sub: #aaa; --acu-btn-bg: #3a3a3a; --acu-btn-hover: #4a4a4a; --acu-btn-active-bg: #6a5acd; --acu-btn-active-text: #fff; --acu-accent: #9b8cd9; --acu-table-head: #333333; --acu-table-hover: #3a3a3a; --acu-opt-hover: rgba(255, 255, 255, 0.1); --acu-opt-bg: rgba(255, 255, 255, 0.05); --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #2d3035; --acu-badge-bg: #3a3f4b; --acu-menu-bg: #333; --acu-menu-text: #eee; --acu-success-text: #4cd964; --acu-success-bg: rgba(76, 217, 100, 0.2); --acu-scrollbar-track: #2b2b2b; --acu-scrollbar-thumb: #555; --acu-hl-manual: #ff6b81; --acu-hl-manual-bg: rgba(255, 107, 129, 0.2); --acu-hl-diff: #00d2d3; --acu-hl-diff-bg: rgba(0, 210, 211, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-overlay-bg: rgba(0,0,0,0.75); --acu-overlay-bg-light: rgba(0,0,0,0.65); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255,255,255,0.05); --acu-very-light-bg: rgba(255,255,255,0.02); --acu-button-text: #fff; --acu-gray-bg: rgba(255,255,255,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-modern { --acu-bg-nav: #ffffff; --acu-bg-panel: #f8f9fa; --acu-border: #e0e0e0; --acu-text-main: #333; --acu-text-sub: #666; --acu-btn-bg: #f1f3f5; --acu-btn-hover: #e9ecef; --acu-btn-active-bg: #007bff; --acu-btn-active-text: #fff; --acu-accent: #007bff; --acu-table-head: #f8f9fa; --acu-table-hover: #f1f3f5; --acu-opt-hover: #f1f3f5; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #f1f3f5; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #28a745; --acu-success-bg: rgba(40, 167, 69, 0.15); --acu-scrollbar-track: #fff; --acu-scrollbar-thumb: #ccc; --acu-hl-manual: #fd7e14; --acu-hl-manual-bg: rgba(253, 126, 20, 0.15); --acu-hl-diff: #0d6efd; --acu-hl-diff-bg: rgba(13, 110, 253, 0.15); --acu-error-text: #dc3545; --acu-error-bg: rgba(220, 53, 69, 0.15); --acu-error-border: rgba(220, 53, 69, 0.5); --acu-warning-icon: #fd7e14; --acu-warning-text: #ffc107; --acu-warning-bg: rgba(255, 193, 7, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #333; --acu-gray-bg: rgba(128,128,128,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-forest { --acu-bg-nav: #e8f5e9; --acu-bg-panel: #e8f5e9; --acu-border: #c8e6c9; --acu-text-main: #2e7d32; --acu-text-sub: #81c784; --acu-btn-bg: #c8e6c9; --acu-btn-hover: #a5d6a7; --acu-btn-active-bg: #43a047; --acu-btn-active-text: #fff; --acu-accent: #4caf50; --acu-table-head: #dcedc8; --acu-table-hover: #f1f8e9; --acu-opt-hover: #f1f8e9; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #dcedc8; --acu-menu-bg: #fff; --acu-menu-text: #2e7d32; --acu-success-text: #2e7d32; --acu-success-bg: rgba(46, 125, 50, 0.2); --acu-scrollbar-track: #e8f5e9; --acu-scrollbar-thumb: #a5d6a7; --acu-hl-manual: #e67e22; --acu-hl-manual-bg: rgba(230, 126, 34, 0.15); --acu-hl-diff: #1e8449; --acu-hl-diff-bg: rgba(30, 132, 73, 0.2); --acu-error-text: #c0392b; --acu-error-bg: rgba(192, 57, 43, 0.15); --acu-error-border: rgba(192, 57, 43, 0.5); --acu-warning-icon: #e67e22; --acu-warning-text: #e67e22; --acu-warning-bg: rgba(230, 126, 34, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(76, 175, 80, 0.1); --acu-very-light-bg: rgba(76, 175, 80, 0.02); --acu-button-text: #2e7d32; --acu-gray-bg: rgba(76, 175, 80, 0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-ocean { --acu-bg-nav: #e3f2fd; --acu-bg-panel: #e3f2fd; --acu-border: #90caf9; --acu-text-main: #1565c0; --acu-text-sub: #64b5f6; --acu-btn-bg: #bbdefb; --acu-btn-hover: #90caf9; --acu-btn-active-bg: #1976d2; --acu-btn-active-text: #fff; --acu-accent: #2196f3; --acu-table-head: #bbdefb; --acu-table-hover: #e1f5fe; --acu-opt-hover: #e1f5fe; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #e3f2fd; --acu-menu-bg: #fff; --acu-menu-text: #1565c0; --acu-success-text: #0288d1; --acu-success-bg: rgba(2, 136, 209, 0.15); --acu-scrollbar-track: #e3f2fd; --acu-scrollbar-thumb: #90caf9; --acu-hl-manual: #ff4757; --acu-hl-manual-bg: rgba(255, 71, 87, 0.15); --acu-hl-diff: #0277bd; --acu-hl-diff-bg: rgba(2, 119, 189, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #1565c0; --acu-gray-bg: rgba(128,128,128,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-cyber { --acu-bg-nav: #000000; --acu-bg-panel: #0a0a0a; --acu-border: #333; --acu-text-main: #00ffcc; --acu-text-sub: #ff00ff; --acu-btn-bg: #111; --acu-btn-hover: #222; --acu-btn-active-bg: #ff00ff; --acu-btn-active-text: #000; --acu-accent: #00ffcc; --acu-table-head: #050505; --acu-table-hover: #111; --acu-opt-hover: rgba(0, 255, 204, 0.15); --acu-opt-bg: rgba(0, 255, 204, 0.08); --acu-shadow: 0 0 15px rgba(0,255,204,0.15); --acu-card-bg: #050505; --acu-badge-bg: #1a1a1a; --acu-menu-bg: #111; --acu-menu-text: #00ffcc; --acu-success-text: #0f0; --acu-success-bg: rgba(0, 255, 0, 0.15); --acu-scrollbar-track: #000; --acu-scrollbar-thumb: #333; --acu-hl-manual: #ff9f43; --acu-hl-manual-bg: rgba(255, 159, 67, 0.2); --acu-hl-diff: #0abde3; --acu-hl-diff-bg: rgba(10, 189, 227, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-overlay-bg: rgba(0,0,0,0.85); --acu-overlay-bg-light: rgba(0,0,0,0.75); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(0, 255, 204, 0.08); --acu-very-light-bg: rgba(0, 255, 204, 0.02); --acu-button-text-on-accent: #000; --acu-input-text: #ff00ff; --acu-input-placeholder: #ff00ff; }\n    .acu-theme-cyber .acu-nav-btn { border-color: #222; }\n    .acu-theme-cyber .acu-data-card { border-color: #222; }\n    .acu-theme-nightowl { --acu-bg-nav: #0a2133; --acu-bg-panel: #011627; --acu-border: #132e45; --acu-text-main: #e0e6f2; --acu-text-sub: #a6b8cc; --acu-btn-bg: #1f3a52; --acu-btn-hover: #2a4a68; --acu-btn-active-bg: #7fdbca; --acu-btn-active-text: #011627; --acu-accent: #7fdbca; --acu-table-head: #0a2133; --acu-table-hover: #01294a; --acu-opt-hover: rgba(127, 219, 202, 0.15); --acu-opt-bg: rgba(127, 219, 202, 0.08); --acu-shadow: rgba(0,0,0,0.5); --acu-card-bg: #0a2133; --acu-badge-bg: #1f3a52; --acu-menu-bg: #011627; --acu-menu-text: #e0e6f2; --acu-success-text: #addb67; --acu-success-bg: rgba(173, 219, 103, 0.15); --acu-scrollbar-track: #011627; --acu-scrollbar-thumb: #1f3a52; --acu-hl-manual: #ff8f66; --acu-hl-manual-bg: rgba(255, 143, 102, 0.2); --acu-hl-diff: #82aaff; --acu-hl-diff-bg: rgba(130, 170, 255, 0.2); --acu-error-text: #ef5350; --acu-error-bg: rgba(239, 83, 80, 0.2); --acu-error-border: rgba(239, 83, 80, 0.5); --acu-warning-icon: #ffcb6b; --acu-warning-text: #ffcb6b; --acu-warning-bg: rgba(255, 203, 107, 0.2); --acu-overlay-bg: rgba(1, 22, 39, 0.85); --acu-overlay-bg-light: rgba(1, 22, 39, 0.75); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(127, 219, 202, 0.08); --acu-very-light-bg: rgba(127, 219, 202, 0.02); --acu-button-text: #e0e6f2; --acu-gray-bg: rgba(127, 219, 202, 0.08); --acu-button-text-on-accent: #011627; }\n    .acu-theme-sakura { --acu-bg-nav: #F9F0EF; --acu-bg-panel: #F9F0EF; --acu-border: #EBDCD9; --acu-text-main: #6B5552; --acu-text-sub: #C08D8D; --acu-btn-bg: #EBDCD9; --acu-btn-hover: #D8C7C4; --acu-btn-active-bg: #C08D8D; --acu-btn-active-text: #F9F0EF; --acu-accent: #C08D8D; --acu-table-head: #F9F0EF; --acu-table-hover: #F5EAE8; --acu-opt-hover: #F5EAE8; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #F9F0EF; --acu-menu-bg: #fff; --acu-menu-text: #6B5552; --acu-success-text: #6B5552; --acu-success-bg: rgba(192, 141, 141, 0.12); --acu-scrollbar-track: #F9F0EF; --acu-scrollbar-thumb: #EBDCD9; --acu-hl-manual: #A68A7A; --acu-hl-manual-bg: rgba(166, 138, 122, 0.12); --acu-hl-diff: #9B7A7A; --acu-hl-diff-bg: rgba(155, 122, 122, 0.2); --acu-error-text: #9B7A7A; --acu-error-bg: rgba(155, 122, 122, 0.12); --acu-error-border: rgba(155, 122, 122, 0.4); --acu-warning-icon: #A68A7A; --acu-warning-text: #A68A7A; --acu-warning-bg: rgba(166, 138, 122, 0.12); --acu-overlay-bg: rgba(107, 85, 82, 0.6); --acu-overlay-bg-light: rgba(107, 85, 82, 0.5); --acu-shadow-bg: rgba(107, 85, 82, 0.3); --acu-light-bg: rgba(192, 141, 141, 0.08); --acu-very-light-bg: rgba(192, 141, 141, 0.02); --acu-button-text: #6B5552; --acu-gray-bg: rgba(192, 141, 141, 0.08); --acu-button-text-on-accent: #F9F0EF; }\n    .acu-theme-minepink { --acu-bg-nav: #1a1a1a; --acu-bg-panel: #1a1a1a; --acu-border: #333333; --acu-text-main: #ffb3d9; --acu-text-sub: #ff80c1; --acu-btn-bg: #2a2a2a; --acu-btn-hover: #3a3a3a; --acu-btn-active-bg: #ff80c1; --acu-btn-active-text: #1a1a1a; --acu-accent: #ff80c1; --acu-table-head: #252525; --acu-table-hover: #2a2a2a; --acu-opt-hover: rgba(255, 128, 193, 0.15); --acu-opt-bg: rgba(255, 128, 193, 0.08); --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #222222; --acu-badge-bg: #2a2a2a; --acu-menu-bg: #1a1a1a; --acu-menu-text: #ffb3d9; --acu-success-text: #ff80c1; --acu-success-bg: rgba(255, 128, 193, 0.2); --acu-scrollbar-track: #1a1a1a; --acu-scrollbar-thumb: #333333; --acu-hl-manual: #ffa726; --acu-hl-manual-bg: rgba(255, 167, 38, 0.2); --acu-hl-diff: #ff80c1; --acu-hl-diff-bg: rgba(255, 128, 193, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-overlay-bg: rgba(0,0,0,0.8); --acu-overlay-bg-light: rgba(0,0,0,0.7); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255, 128, 193, 0.1); --acu-very-light-bg: rgba(255, 128, 193, 0.02); --acu-button-text: #1a1a1a; --acu-gray-bg: rgba(255, 128, 193, 0.1); --acu-button-text-on-accent: #1a1a1a; }\n    .acu-theme-purple { --acu-bg-nav: #f3e5f5; --acu-bg-panel: #f3e5f5; --acu-border: #ce93d8; --acu-text-main: #6a1b9a; --acu-text-sub: #9c27b0; --acu-btn-bg: #e1bee7; --acu-btn-hover: #ce93d8; --acu-btn-active-bg: #9c27b0; --acu-btn-active-text: #fff; --acu-accent: #9c27b0; --acu-table-head: #f8e1f5; --acu-table-hover: #fce4ec; --acu-opt-hover: #fce4ec; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #f8e1f5; --acu-menu-bg: #fff; --acu-menu-text: #6a1b9a; --acu-success-text: #6a1b9a; --acu-success-bg: rgba(106, 27, 154, 0.15); --acu-scrollbar-track: #f3e5f5; --acu-scrollbar-thumb: #ce93d8; --acu-hl-manual: #f57c00; --acu-hl-manual-bg: rgba(245, 124, 0, 0.15); --acu-hl-diff: #6a1b9a; --acu-hl-diff-bg: rgba(106, 27, 154, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(156, 39, 176, 0.1); --acu-very-light-bg: rgba(156, 39, 176, 0.02); --acu-button-text: #6a1b9a; --acu-gray-bg: rgba(156, 39, 176, 0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-wechat { --acu-bg-nav: #F7F7F7; --acu-bg-panel: #F7F7F7; --acu-border: #E5E5E5; --acu-text-main: #333333; --acu-text-sub: #666666; --acu-btn-bg: #E5E5E5; --acu-btn-hover: #D5D5D5; --acu-btn-active-bg: #09B83E; --acu-btn-active-text: #FFFFFF; --acu-accent: #09B83E; --acu-table-head: #F0F0F0; --acu-table-hover: #EBEBEB; --acu-opt-hover: #EBEBEB; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #F0F0F0; --acu-menu-bg: #fff; --acu-menu-text: #333333; --acu-success-text: #09B83E; --acu-success-bg: rgba(9, 184, 62, 0.12); --acu-scrollbar-track: #F7F7F7; --acu-scrollbar-thumb: #E5E5E5; --acu-hl-manual: #FF9500; --acu-hl-manual-bg: rgba(255, 149, 0, 0.12); --acu-hl-diff: #09B83E; --acu-hl-diff-bg: rgba(9, 184, 62, 0.2); --acu-error-text: #E53E3E; --acu-error-bg: rgba(229, 62, 62, 0.12); --acu-error-border: rgba(229, 62, 62, 0.5); --acu-warning-icon: #FF9500; --acu-warning-text: #FF9500; --acu-warning-bg: rgba(255, 149, 0, 0.12); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.2); --acu-light-bg: rgba(9, 184, 62, 0.08); --acu-very-light-bg: rgba(9, 184, 62, 0.02); --acu-button-text: #333333; --acu-gray-bg: rgba(9, 184, 62, 0.08); --acu-button-text-on-accent: #fff; }\n    .acu-theme-educational { --acu-bg-nav: #000000; --acu-bg-panel: #000000; --acu-border: #1B1B1B; --acu-text-main: #FFFFFF; --acu-text-sub: #CCCCCC; --acu-btn-bg: #1B1B1B; --acu-btn-hover: #2B2B2B; --acu-btn-active-bg: #FF9900; --acu-btn-active-text: #000000; --acu-accent: #FF9900; --acu-table-head: #1B1B1B; --acu-table-hover: #2B2B2B; --acu-opt-hover: rgba(255, 153, 0, 0.18); --acu-opt-bg: rgba(255, 153, 0, 0.1); --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #1B1B1B; --acu-badge-bg: #1B1B1B; --acu-menu-bg: #000000; --acu-menu-text: #FFFFFF; --acu-success-text: #FF9900; --acu-success-bg: rgba(255, 153, 0, 0.15); --acu-scrollbar-track: #000000; --acu-scrollbar-thumb: #1B1B1B; --acu-input-bg: #1B1B1B; --acu-hl-manual: #FF9900; --acu-hl-manual-bg: rgba(255, 153, 0, 0.15); --acu-hl-diff: #FFB84D; --acu-hl-diff-bg: rgba(255, 184, 77, 0.2); --acu-error-text: #FF6B6B; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #FFAA00; --acu-warning-text: #FFAA00; --acu-warning-bg: rgba(255, 170, 0, 0.2); --acu-overlay-bg: rgba(0,0,0,0.8); --acu-overlay-bg-light: rgba(0,0,0,0.7); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255, 153, 0, 0.1); --acu-very-light-bg: rgba(255, 153, 0, 0.02); --acu-button-text: #FFFFFF; --acu-gray-bg: rgba(255, 255, 255, 0.1); --acu-button-text-on-accent: #000; }\n    .acu-theme-vaporwave { --acu-bg-nav: #191970; --acu-bg-panel: #191970; --acu-border: rgba(0, 255, 255, 0.3); --acu-text-main: #00FFFF; --acu-text-sub: #FF00FF; --acu-btn-bg: rgba(25, 25, 112, 0.8); --acu-btn-hover: rgba(0, 255, 255, 0.2); --acu-btn-active-bg: #FF00FF; --acu-btn-active-text: #191970; --acu-accent: #00FFFF; --acu-table-head: rgba(25, 25, 112, 0.9); --acu-table-hover: rgba(0, 255, 255, 0.1); --acu-opt-hover: rgba(0, 255, 255, 0.18); --acu-opt-bg: rgba(0, 255, 255, 0.1); --acu-shadow: 0 0 15px rgba(0, 255, 255, 0.3); --acu-card-bg: rgba(25, 25, 112, 0.95); --acu-badge-bg: rgba(25, 25, 112, 0.8); --acu-menu-bg: #191970; --acu-menu-text: #00FFFF; --acu-success-text: #00FFFF; --acu-success-bg: rgba(0, 255, 255, 0.15); --acu-scrollbar-track: #191970; --acu-scrollbar-thumb: rgba(0, 255, 255, 0.3); --acu-input-bg: rgba(25, 25, 112, 0.6); --acu-hl-manual: #00FFFF; --acu-hl-manual-bg: rgba(0, 255, 255, 0.2); --acu-hl-diff: #FF00FF; --acu-hl-diff-bg: rgba(255, 0, 255, 0.2); --acu-error-text: #FF00FF; --acu-error-bg: rgba(255, 0, 255, 0.2); --acu-error-border: rgba(255, 0, 255, 0.5); --acu-warning-icon: #FF00FF; --acu-warning-text: #FF00FF; --acu-warning-bg: rgba(255, 0, 255, 0.15); --acu-overlay-bg: rgba(25, 25, 112, 0.85); --acu-overlay-bg-light: rgba(25, 25, 112, 0.75); --acu-shadow-bg: rgba(0, 255, 255, 0.3); --acu-light-bg: rgba(0, 255, 255, 0.05); --acu-very-light-bg: rgba(0, 255, 255, 0.02); --acu-button-text: #F0F8FF; --acu-gray-bg: rgba(0, 255, 255, 0.1); --acu-button-text-on-accent: #191970; --acu-input-text: #00FFFF; --acu-input-placeholder: #FF00FF; }\n    .acu-theme-vaporwave .acu-nav-btn { border-color: rgba(0, 255, 255, 0.3); }\n    .acu-theme-vaporwave .acu-data-card { border-color: rgba(0, 255, 255, 0.3); }\n    .acu-theme-classicpackaging { --acu-bg-nav: #000000; --acu-bg-panel: #000000; --acu-border: #FFFF00; --acu-text-main: #FFFF00; --acu-text-sub: #CCCC00; --acu-btn-bg: #FF0000; --acu-btn-hover: #CC0000; --acu-btn-active-bg: #0000FF; --acu-btn-active-text: #FFFF00; --acu-accent: #FF0000; --acu-table-head: #1a1a1a; --acu-table-hover: #2a2a2a; --acu-opt-hover: rgba(255, 255, 0, 0.15); --acu-opt-bg: rgba(255, 255, 0, 0.08); --acu-shadow: rgba(255,255,0,0.3); --acu-card-bg: #1a1a1a; --acu-badge-bg: #FF0000; --acu-menu-bg: #000000; --acu-menu-text: #FFFF00; --acu-success-text: #0000FF; --acu-success-bg: rgba(0, 0, 255, 0.2); --acu-scrollbar-track: #000000; --acu-scrollbar-thumb: #FFFF00; --acu-input-bg: #1a1a1a; --acu-hl-manual: #FF0000; --acu-hl-manual-bg: rgba(255, 0, 0, 0.2); --acu-hl-diff: #0000FF; --acu-hl-diff-bg: rgba(0, 0, 255, 0.2); --acu-error-text: #FF0000; --acu-error-bg: rgba(255, 0, 0, 0.2); --acu-error-border: rgba(255, 0, 0, 0.8); --acu-warning-icon: #FF0000; --acu-warning-text: #FF0000; --acu-warning-bg: rgba(255, 0, 0, 0.15); --acu-overlay-bg: rgba(0,0,0,0.9); --acu-overlay-bg-light: rgba(0,0,0,0.8); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255,255,0,0.1); --acu-very-light-bg: rgba(255,255,0,0.02); --acu-button-text: #FFFF00; --acu-gray-bg: rgba(255,255,0,0.1); --acu-button-text-on-accent: #FFFF00; --acu-input-text: #FFFF00; --acu-input-placeholder: #666600; }\n    .acu-theme-classicpackaging .acu-nav-btn { border-color: #FFFF00; border-width: 2px; font-weight: bold; }\n    .acu-theme-classicpackaging .acu-data-card { border-color: #FFFF00; border-width: 2px; }\n    .acu-theme-galgame { --acu-bg-nav: #FFF0F5; --acu-bg-panel: #FFF0F5; --acu-border: #F0D4E4; --acu-text-main: #6B4A5A; --acu-text-sub: #B08A9A; --acu-btn-bg: #FFE4E9; --acu-btn-hover: #FFD4E4; --acu-btn-active-bg: #E8B4D9; --acu-btn-active-text: #6B4A5A; --acu-accent: #E8B4D9; --acu-table-head: #FFF5F9; --acu-table-hover: #FFF0F8; --acu-opt-hover: #FFF0F8; --acu-opt-bg: #ffffff; --acu-shadow: rgba(232, 180, 217, 0.25); --acu-card-bg: #ffffff; --acu-badge-bg: #FFF5F9; --acu-menu-bg: #fff; --acu-menu-text: #6B4A5A; --acu-success-text: #D4A5C8; --acu-success-bg: rgba(212, 165, 200, 0.15); --acu-scrollbar-track: #FFF0F5; --acu-scrollbar-thumb: #F0D4E4; --acu-input-bg: #FFF8FA; --acu-hl-manual: #D4A5A5; --acu-hl-manual-bg: rgba(212, 165, 165, 0.15); --acu-hl-diff: #E8B4D9; --acu-hl-diff-bg: rgba(232, 180, 217, 0.2); --acu-error-text: #C88A9A; --acu-error-bg: rgba(200, 138, 154, 0.15); --acu-error-border: rgba(200, 138, 154, 0.4); --acu-warning-icon: #D4A5A5; --acu-warning-text: #D4A5A5; --acu-warning-bg: rgba(212, 165, 165, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(232, 180, 217, 0.25); --acu-light-bg: rgba(232, 180, 217, 0.08); --acu-very-light-bg: rgba(232, 180, 217, 0.02); --acu-button-text: #6B4A5A; --acu-button-text-on-accent: #6B4A5A; --acu-gray-bg: rgba(232, 180, 217, 0.1); }\n    .acu-theme-galgame .acu-nav-btn { border-radius: 8px; transition: all 0.3s ease; }\n    .acu-theme-galgame .acu-data-card { border-radius: 12px; box-shadow: 0 4px 12px rgba(232, 180, 217, 0.15); transition: all 0.3s ease; }\n    .acu-theme-galgame .acu-data-card:hover { box-shadow: 0 6px 20px rgba(232, 180, 217, 0.25); transform: translateY(-2px); }\n    .acu-theme-galgame .acu-nav-btn:hover { box-shadow: 0 2px 8px rgba(232, 180, 217, 0.2); }\n    .acu-theme-terminal { --acu-bg-nav: #0c0c0c; --acu-bg-panel: #0c0c0c; --acu-border: #00ff00; --acu-text-main: #00ff00; --acu-text-sub: #00cc00; --acu-btn-bg: #1a1a1a; --acu-btn-hover: #2a2a2a; --acu-btn-active-bg: #00ff00; --acu-btn-active-text: #0c0c0c; --acu-accent: #00ff00; --acu-table-head: #0a0a0a; --acu-table-hover: #1a1a1a; --acu-opt-hover: rgba(0, 255, 0, 0.12); --acu-opt-bg: rgba(0, 255, 0, 0.06); --acu-shadow: rgba(0,255,0,0.2); --acu-card-bg: #0c0c0c; --acu-badge-bg: #1a1a1a; --acu-menu-bg: #0c0c0c; --acu-menu-text: #00ff00; --acu-success-text: #00ff00; --acu-success-bg: rgba(0, 255, 0, 0.15); --acu-scrollbar-track: #0c0c0c; --acu-scrollbar-thumb: #00ff00; --acu-input-bg: #0c0c0c; --acu-hl-manual: #ffff00; --acu-hl-manual-bg: rgba(255, 255, 0, 0.15); --acu-hl-diff: #00ffff; --acu-hl-diff-bg: rgba(0, 255, 255, 0.15); --acu-error-text: #ff0000; --acu-error-bg: rgba(255, 0, 0, 0.15); --acu-error-border: rgba(255, 0, 0, 0.5); --acu-warning-icon: #ffff00; --acu-warning-text: #ffff00; --acu-warning-bg: rgba(255, 255, 0, 0.15); --acu-overlay-bg: rgba(0,0,0,0.9); --acu-overlay-bg-light: rgba(0,0,0,0.8); --acu-shadow-bg: rgba(0,0,0,0.7); --acu-light-bg: rgba(0,255,0,0.05); --acu-very-light-bg: rgba(0,255,0,0.02); --acu-button-text: #0c0c0c; --acu-gray-bg: rgba(0,255,0,0.05); --acu-button-text-on-accent: #0c0c0c; font-family: 'Courier New', 'Consolas', 'Monaco', monospace; --acu-input-text: #00ff00; --acu-input-placeholder: #008800; }\n    .acu-theme-terminal .acu-nav-btn { border-color: #00ff00; text-shadow: 0 0 5px rgba(0,255,0,0.5); }\n    .acu-theme-terminal .acu-data-card { border-color: #00ff00; text-shadow: 0 0 2px rgba(0,255,0,0.3); }\n    .acu-theme-dreamcore { --acu-bg-nav: #F4F1EA; --acu-bg-panel: #F4F1EA; --acu-border: #D6D2C4; --acu-text-main: #5C5869; --acu-text-sub: #9490A0; --acu-btn-bg: #E6E1D5; --acu-btn-hover: #DBD8CC; --acu-btn-active-bg: #8A9AC6; --acu-btn-active-text: #FFFFFF; --acu-accent: #8A9AC6; --acu-table-head: #EBE7DE; --acu-table-hover: #F8F6F0; --acu-opt-hover: #F8F6F0; --acu-opt-bg: #FFFFFF; --acu-shadow: rgba(92, 88, 105, 0.15); --acu-card-bg: #FFFFFF; --acu-badge-bg: #EBE7DE; --acu-menu-bg: #FCFAF5; --acu-menu-text: #5C5869; --acu-success-text: #4A7A68; --acu-success-bg: rgba(74, 122, 104, 0.18); --acu-scrollbar-track: #F4F1EA; --acu-scrollbar-thumb: #D6D2C4; --acu-input-bg: #FFFFFF; --acu-hl-manual: #8A7040; --acu-hl-manual-bg: rgba(138, 112, 64, 0.18); --acu-hl-diff: #8A9AC6; --acu-hl-diff-bg: rgba(138, 154, 198, 0.18); --acu-error-text: #B85C5C; --acu-error-bg: rgba(184, 92, 92, 0.15); --acu-error-border: rgba(184, 92, 92, 0.4); --acu-warning-icon: #E0C080; --acu-warning-text: #8A7040; --acu-warning-bg: rgba(138, 112, 64, 0.18); --acu-overlay-bg: rgba(244, 241, 234, 0.85); --acu-overlay-bg-light: rgba(255, 255, 255, 0.4); --acu-shadow-bg: rgba(92, 88, 105, 0.15); --acu-light-bg: rgba(138, 154, 198, 0.08); --acu-very-light-bg: rgba(138, 154, 198, 0.03); --acu-button-text: #5C5869; --acu-gray-bg: rgba(92, 88, 105, 0.08); --acu-button-text-on-accent: #fff; }\n    .acu-theme-dreamcore .acu-nav-btn { border-color: #D6D2C4; }\n    /* 极光幻境 (Aurora) 主题：深邃星空与极光渐变 */\n    .acu-theme-aurora {\n        --acu-bg-nav: linear-gradient(135deg, #0f172a, #1e293b);\n        --acu-bg-panel: linear-gradient(180deg, #0f172a 0%, #334155 100%);\n        --acu-border: #38bdf8;\n        --acu-text-main: #e2e8f0;\n        --acu-text-sub: #94a3b8;\n        --acu-btn-bg: linear-gradient(135deg, #162a3d, #25224d);\n        --acu-btn-hover: linear-gradient(135deg, #1e3a5f, #312e81);\n        --acu-btn-active-bg: linear-gradient(135deg, #38bdf8, #a855f7);\n        --acu-btn-active-text: #fff;\n        --acu-accent: #38bdf8;\n        --acu-table-head: linear-gradient(90deg, #0f172a, #1e293b);\n        --acu-table-hover: rgba(56, 189, 248, 0.08);\n        --acu-opt-hover: rgba(56, 189, 248, 0.15);\n        --acu-opt-bg: rgba(56, 189, 248, 0.08);\n        --acu-shadow: 0 8px 32px rgba(56, 189, 248, 0.15), 0 4px 16px rgba(168, 85, 247, 0.1);\n        --acu-card-bg: linear-gradient(145deg, #1e293b, #0f172a);\n        --acu-badge-bg: rgba(56, 189, 248, 0.2);\n        --acu-menu-bg: #1e293b;\n        --acu-menu-text: #e2e8f0;\n        --acu-success-text: #4ade80;\n        --acu-success-bg: rgba(74, 222, 128, 0.15);\n        --acu-scrollbar-track: #0f172a;\n        --acu-scrollbar-thumb: #38bdf8;\n        --acu-input-bg: #0f172a;\n        --acu-hl-manual: #f97316;\n        --acu-hl-manual-bg: rgba(249, 115, 22, 0.2);\n        --acu-hl-diff: #38bdf8;\n        --acu-hl-diff-bg: rgba(56, 189, 248, 0.2);\n        --acu-error-text: #f87171;\n        --acu-error-bg: rgba(248, 113, 113, 0.2);\n        --acu-error-border: rgba(248, 113, 113, 0.5);\n        --acu-warning-icon: #fbbf24;\n       \n       \n        --acu-warning-text: #fbbf24;\n        --acu-warning-bg: rgba(251, 191, 36, 0.2);\n       \n       \n       \n       \n       \n       \n        --acu-overlay-bg: rgba(15, 23, 42, 0.98);\n        --acu-overlay-bg-light: rgba(30, 41, 59, 0.95);\n        --acu-shadow-bg: rgba(56, 189, 248, 0.2);\n        --acu-light-bg: rgba(56, 189, 248, 0.08);\n        --acu-very-light-bg: rgba(56, 189, 248, 0.03);\n        --acu-button-text: #e2e8f0;\n        --acu-gray-bg: rgba(148, 163, 184, 0.1);\n        --acu-button-text-on-accent: #fff;\n    }\n    .acu-theme-aurora .acu-nav-btn { border-color: rgba(56, 189, 248, 0.3); }\n    .acu-theme-aurora .acu-data-card { border-color: rgba(56, 189, 248, 0.3); box-shadow: 0 4px 20px rgba(56, 189, 248, 0.1), 0 2px 10px rgba(168, 85, 247, 0.08); }\n    .acu-theme-aurora .acu-dice-panel input::placeholder,\n    .acu-theme-aurora .acu-contest-panel input::placeholder {\n        color: #94a3b8 !important;\n        opacity: 0.7;\n    }\n    .acu-theme-aurora .acu-dice-panel input[type="text"],\n    .acu-theme-aurora .acu-dice-panel input[type="number"],\n    .acu-theme-aurora .acu-dice-panel input:not([type]),\n    .acu-theme-aurora .acu-contest-panel input[type="text"],\n    .acu-theme-aurora .acu-contest-panel input[type="number"],\n    .acu-theme-aurora .acu-contest-panel input:not([type]) {\n        color: #e2e8f0 !important;\n    }\n    /* 极光幻境：导航栏 - 极光渐变光效 */\n    .acu-theme-aurora .acu-nav-container {\n        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%) !important;\n        border: 1px solid #38bdf8 !important;\n        box-shadow: 0 0 30px rgba(56, 189, 248, 0.1), 0 0 60px rgba(168, 85, 247, 0.05), inset 0 0 20px rgba(56, 189, 248, 0.05) !important;\n        overflow: visible !important;\n    }\n    /* 极光顶部渐变光条 */\n    .acu-theme-aurora .acu-nav-container::before {\n        content: '';\n        position: absolute;\n        top: -1px; left: -1px; right: -1px; bottom: -1px;\n        background: linear-gradient(90deg, #38bdf8, #a855f7, #22d3ee, #38bdf8);\n        background-size: 300% 100%;\n        z-index: -1;\n        border-radius: 14px;\n        animation: aurora-glow 6s ease-in-out infinite;\n        opacity: 0.6;\n    }\n    @keyframes aurora-glow {\n        0% { background-position: 0% 50%; opacity: 0.4; }\n        50% { background-position: 100% 50%; opacity: 0.7; }\n        100% { background-position: 0% 50%; opacity: 0.4; }\n    }\n    /* 极光幻境：按钮样式 */\n    .acu-theme-aurora .acu-nav-btn {\n        border: 1px solid rgba(56, 189, 248, 0.2) !important;\n        background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(168, 85, 247, 0.1)) !important;\n        border-radius: 8px;\n        color: #e2e8f0;\n        transition: all 0.3s ease;\n    }\n    .acu-theme-aurora .acu-nav-btn:hover {\n        background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(168, 85, 247, 0.2)) !important;\n        border-color: rgba(56, 189, 248, 0.5) !important;\n        box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2);\n        transform: translateY(-2px);\n    }\n    .acu-theme-aurora .acu-nav-btn.active {\n        background: linear-gradient(135deg, #38bdf8, #a855f7) !important;\n        border-color: transparent !important;\n        color: #ffffff !important;\n        box-shadow: 0 4px 20px rgba(56, 189, 248, 0.4), 0 2px 10px rgba(168, 85, 247, 0.3);\n        font-weight: bold;\n    }\n    /* 极光幻境：数据卡片 */\n    .acu-theme-aurora .acu-data-card:hover {\n        border-color: rgba(56, 189, 248, 0.5) !important;\n        box-shadow: 0 8px 30px rgba(56, 189, 248, 0.15), 0 4px 15px rgba(168, 85, 247, 0.1);\n        transform: translateY(-3px);\n    }\n    .acu-theme-dreamcore .acu-data-card { border-color: #D6D2C4; box-shadow: 0 2px 8px rgba(92, 88, 105, 0.1); }\n    .acu-theme-dreamcore .acu-dice-panel input::placeholder,\n    .acu-theme-dreamcore .acu-contest-panel input::placeholder {\n        color: #B0ACC0 !important;\n        opacity: 0.9;\n    }\n    .acu-theme-dreamcore .acu-dice-panel input[type="text"],\n    .acu-theme-dreamcore .acu-dice-panel input[type="number"],\n    .acu-theme-dreamcore .acu-dice-panel input:not([type]),\n    .acu-theme-dreamcore .acu-contest-panel input[type="text"],\n    .acu-theme-dreamcore .acu-contest-panel input[type="number"],\n    .acu-theme-dreamcore .acu-contest-panel input:not([type]) {\n        color: #4A4652 !important;\n    }\n    /* 超天酱 (Choutenちゃん) 主题：電脳カワイイ・オーバードライブ */\n    .acu-theme-chouten {\n        --acu-bg-nav: linear-gradient(135deg, rgba(26, 10, 46, 0.95) 0%, rgba(45, 27, 78, 0.95) 50%, rgba(26, 10, 46, 0.95) 100%);\n        --acu-bg-panel: rgba(26, 10, 46, 0.95);\n        --acu-border: #FF7EB6;\n        --acu-text-main: #FFFFFF;\n        --acu-text-sub: #D0BFFF;\n        --acu-btn-bg: rgba(255, 255, 255, 0.1);\n        --acu-btn-hover: rgba(255, 107, 157, 0.3);\n        --acu-btn-active-bg: linear-gradient(90deg, #FF6B9D, #B388FF);\n        --acu-btn-active-text: #FFFFFF;\n        --acu-accent: #7FFFD4;\n        --acu-table-head: rgba(255, 107, 157, 0.15);\n        --acu-table-hover: linear-gradient(90deg, rgba(255, 107, 157, 0.2), rgba(127, 255, 212, 0.2));\n        --acu-opt-hover: linear-gradient(90deg, rgba(255, 107, 157, 0.15), rgba(127, 255, 212, 0.15)); --acu-opt-bg: transparent;\n        --acu-shadow: rgba(255, 107, 157, 0.5);\n        --acu-card-bg: rgba(20, 10, 35, 0.7);\n        --acu-badge-bg: rgba(127, 255, 212, 0.2);\n        --acu-menu-bg: #2D1B4E;\n        --acu-menu-text: #FFE4F0;\n        --acu-success-text: #7FFFD4;\n        --acu-success-bg: rgba(127, 255, 212, 0.15);\n        --acu-scrollbar-track: #1A0A2E;\n        --acu-scrollbar-thumb: #FF6B9D;\n        --acu-input-bg: rgba(0, 0, 0, 0.3);\n        --acu-hl-manual: #FFD93D;\n        --acu-hl-manual-bg: rgba(255, 217, 61, 0.2);\n        --acu-hl-diff: #7FFFD4;\n        --acu-hl-diff-bg: rgba(127, 255, 212, 0.2);\n        --acu-error-text: #FF6B6B;\n        --acu-error-bg: rgba(255, 107, 107, 0.2);\n        --acu-error-border: #FF6B6B;\n        --acu-warning-icon: #FFD93D;\n       \n       \n        --acu-warning-text: #FFD93D;\n        --acu-warning-bg: rgba(255, 217, 61, 0.2);\n       \n       \n       \n       \n       \n       \n        --acu-overlay-bg: rgba(26, 10, 46, 0.95);\n        --acu-overlay-bg-light: rgba(45, 27, 78, 0.85);\n        --acu-shadow-bg: rgba(255, 107, 157, 0.3);\n        --acu-light-bg: rgba(255, 107, 157, 0.1);\n        --acu-very-light-bg: rgba(179, 136, 255, 0.05);\n        --acu-button-text: #FFFFFF;\n        --acu-button-text-on-accent: #1A0A2E;\n        --acu-gray-bg: rgba(255, 255, 255, 0.05);\n    }\n\n    /* Badge 颜色从主题色自动推导，无需每个主题单独维护 */\n    [class*="acu-theme-"] {\n      --acu-failure-text: var(--acu-error-text);\n      --acu-failure-bg: var(--acu-error-bg);\n      --acu-crit-failure-text: var(--acu-error-text);\n      --acu-crit-failure-bg: var(--acu-error-bg);\n      --acu-crit-success-text: var(--acu-accent);\n      --acu-crit-success-bg: var(--acu-success-bg);\n      --acu-extreme-success-text: var(--acu-hl-diff);\n      --acu-extreme-success-bg: var(--acu-hl-diff-bg);\n    }\n\n    .acu-theme-retro { --acu-opt-bright-bg: #fffef9; }\n    .acu-theme-modern,\n    .acu-theme-forest,\n    .acu-theme-ocean,\n    .acu-theme-sakura,\n    .acu-theme-purple,\n    .acu-theme-wechat,\n    .acu-theme-galgame,\n    .acu-theme-dreamcore { --acu-opt-bright-bg: #ffffff; }\n    .acu-theme-dark { --acu-opt-bright-bg: rgba(255, 255, 255, 0.05); }\n    .acu-theme-cyber { --acu-opt-bright-bg: rgba(0, 255, 204, 0.08); }\n    .acu-theme-nightowl { --acu-opt-bright-bg: rgba(127, 219, 202, 0.08); }\n    .acu-theme-minepink { --acu-opt-bright-bg: rgba(255, 128, 193, 0.08); }\n    .acu-theme-educational { --acu-opt-bright-bg: rgba(255, 153, 0, 0.1); }\n    .acu-theme-vaporwave { --acu-opt-bright-bg: rgba(0, 255, 255, 0.1); }\n    .acu-theme-aurora { --acu-opt-bright-bg: rgba(56, 189, 248, 0.1); }\n    .acu-theme-classicpackaging { --acu-opt-bright-bg: rgba(255, 255, 0, 0.08); }\n    .acu-theme-terminal { --acu-opt-bright-bg: rgba(0, 255, 0, 0.06); }\n    .acu-theme-chouten { --acu-opt-bright-bg: transparent; }\n\n    /* 超天酱：导航栏 - 偶像舞台光效 */\n    .acu-theme-chouten .acu-nav-container {\n        background: linear-gradient(180deg, rgba(45, 27, 78, 0.95) 0%, rgba(26, 10, 46, 0.98) 100%) !important;\n        border: 1px solid rgba(255, 107, 157, 0.5) !important;\n        box-shadow: 0 0 20px rgba(179, 136, 255, 0.2), inset 0 0 30px rgba(255, 107, 157, 0.1) !important;\n        backdrop-filter: blur(10px);\n        overflow: visible !important;\n    }\n    /* 顶部彩虹光条 */\n    .acu-theme-chouten .acu-nav-container::before {\n        content: '';\n        position: absolute;\n        top: -2px; left: -2px; right: -2px; bottom: -2px;\n        background: linear-gradient(90deg, #FF6B9D, #B388FF, #7FFFD4, #FF6B9D);\n        background-size: 300% 100%;\n        z-index: -1;\n        border-radius: 12px;\n        animation: chouten-rainbow-border 4s linear infinite;\n        opacity: 0.8;\n    }\n    @keyframes chouten-rainbow-border {\n        0% { background-position: 0% 50%; }\n        50% { background-position: 100% 50%; }\n        100% { background-position: 0% 50%; }\n    }\n\n    /* 超天酱：按钮 - 糖果霓虹 */\n    .acu-theme-chouten .acu-nav-btn {\n        border: 1px solid rgba(255, 255, 255, 0.2) !important;\n        background: rgba(255, 255, 255, 0.05) !important;\n        border-radius: 8px;\n        color: #FFE4F0;\n        transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n        position: relative;\n        overflow: hidden;\n    }\n    .acu-theme-chouten .acu-nav-btn:hover {\n        background: rgba(255, 107, 157, 0.2) !important;\n        border-color: #FF6B9D !important;\n        text-shadow: 0 0 8px #FF6B9D;\n        transform: translateY(-2px) scale(1.02);\n        box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);\n    }\n    .acu-theme-chouten .acu-nav-btn.active {\n        background: linear-gradient(135deg, #FF6B9D 0%, #B388FF 100%) !important;\n        border-color: #FFFFFF !important;\n        color: #FFFFFF !important;\n        box-shadow: 0 0 20px rgba(255, 107, 157, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.3);\n        font-weight: bold;\n        text-shadow: 0 1px 2px rgba(0,0,0,0.3);\n    }\n    /* 按钮激活时的闪烁粒子效果 (模拟) */\n    .acu-theme-chouten .acu-nav-btn.active::after {\n        content: '✦';\n        position: absolute;\n        top: 2px;\n        right: 4px;\n        font-size: 10px;\n        color: #7FFFD4;\n        animation: chouten-sparkle 1.5s infinite;\n    }\n\n    /* 超天酱：数据卡片 - 赛博光晕 */\n    .acu-theme-chouten .acu-data-card {\n        border: 1px solid rgba(179, 136, 255, 0.3) !important;\n        background: linear-gradient(160deg, rgba(30, 15, 50, 0.85) 0%, rgba(20, 8, 40, 0.9) 100%) !important;\n        backdrop-filter: blur(5px);\n        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(179, 136, 255, 0.05);\n        position: relative;\n    }\n    .acu-theme-chouten .acu-data-card::after {\n        content: '';\n        position: absolute;\n        top: 0; left: 0; right: 0; height: 1px;\n        background: linear-gradient(90deg, transparent, #7FFFD4, transparent);\n        opacity: 0.5;\n    }\n    .acu-theme-chouten .acu-data-card:hover {\n        border-color: #7FFFD4 !important;\n        box-shadow: 0 8px 30px rgba(127, 255, 212, 0.15), 0 0 15px rgba(127, 255, 212, 0.1);\n        transform: translateY(-2px);\n    }\n\n    /* 超天酱：输入框 - 浮空全息 */\n    .acu-theme-chouten .acu-dice-panel input::placeholder,\n    .acu-theme-chouten .acu-contest-panel input::placeholder {\n        color: rgba(179, 136, 255, 0.6) !important;\n    }\n    .acu-theme-chouten .acu-dice-panel input,\n    .acu-theme-chouten .acu-contest-panel input {\n        background: rgba(0, 0, 0, 0.4) !important;\n        border: 1px solid rgba(255, 107, 157, 0.3) !important;\n        border-radius: 4px;\n        color: #7FFFD4 !important;\n        transition: all 0.3s ease;\n    }\n    .acu-theme-chouten .acu-dice-panel input:focus,\n    .acu-theme-chouten .acu-contest-panel input:focus {\n        border-color: #7FFFD4 !important;\n        box-shadow: 0 0 10px rgba(127, 255, 212, 0.4), inset 0 0 10px rgba(127, 255, 212, 0.1) !important;\n        background: rgba(0, 0, 0, 0.6) !important;\n    }\n\n    /* 超天酱：滚动条 */\n    .acu-theme-chouten ::-webkit-scrollbar-thumb {\n        background: linear-gradient(180deg, #FF6B9D, #B388FF) !important;\n        border: 1px solid rgba(255, 255, 255, 0.2);\n    }\n    .acu-theme-chouten ::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.2) !important;\n    }\n\n    /* 超天酱：表格行 - 悬停高亮 */\n    .acu-theme-chouten .acu-card-row {\n        border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n    }\n    .acu-theme-chouten .acu-card-row:hover {\n        background: linear-gradient(90deg, rgba(255, 107, 157, 0.2), rgba(179, 136, 255, 0.1)) !important;\n        box-shadow: inset 2px 0 0 #FF6B9D;\n    }\n\n    /* 超天酱：徽章闪烁动画 */\n    .acu-theme-chouten .acu-badge-green {\n        background: rgba(127, 255, 212, 0.15) !important;\n        color: #7FFFD4 !important;\n        border: 1px solid rgba(127, 255, 212, 0.4);\n        box-shadow: 0 0 10px rgba(127, 255, 212, 0.2);\n        animation: chouten-badge-pulse 2s infinite;\n    }\n    @keyframes chouten-badge-pulse {\n        0%, 100% { box-shadow: 0 0 5px rgba(127, 255, 212, 0.2); opacity: 0.9; }\n        50% { box-shadow: 0 0 15px rgba(127, 255, 212, 0.5); opacity: 1; }\n    }\n    @keyframes chouten-sparkle {\n        0%, 100% { opacity: 0.4; transform: scale(0.8); }\n        50% { opacity: 1; transform: scale(1.2); }\n    }\n    /* Night Owl主题：数据验证和表格管理框框使用更暗的边框 */\n    .acu-theme-nightowl .acu-table-manager-item,\n    .acu-theme-nightowl .acu-validation-rule-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-table-manager-item:hover,\n    .acu-theme-nightowl .acu-validation-rule-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    /* Night Owl主题：预设卡片框框使用更暗的边框 */\n    .acu-theme-nightowl .acu-preset-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-preset-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    .acu-wrapper { position: relative; width: 100%; margin: 15px 0; z-index: 31000 !important; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column-reverse; }\n    .acu-wrapper.acu-mode-embedded { position: relative !important; width: 100% !important; margin-top: 8px !important; z-index: 31001 !important; clear: both; display: flex; flex-direction: column-reverse !important; padding: 0; }\n    .acu-wrapper.acu-mode-embedded .acu-nav-container { position: relative !important; z-index: 31002 !important; }\n    .acu-wrapper.acu-mode-embedded .acu-data-display { position: absolute !important; bottom: 100% !important; left: 0 !important; right: 0 !important; width: 100% !important; box-shadow: 0 -10px 30px rgba(0,0,0,0.25) !important; border: 1px solid var(--acu-border); margin-bottom: 5px; z-index: 31010 !important; max-height: 70vh !important; overflow-y: auto !important; }\n    .acu-nav-container { display: grid; grid-template-columns: repeat(var(--acu-grid-cols, 3), 1fr); gap: 4px; padding: 6px; background: var(--acu-bg-nav); border: 1px solid var(--acu-border); border-radius: 10px; align-items: center; box-shadow: 0 2px 6px var(--acu-shadow); position: relative; z-index: 31001 !important; }\n    .acu-nav-btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 3px; padding: 4px 2px; border: 1px solid transparent; border-radius: 6px; background: var(--acu-btn-bg); color: var(--acu-text-main); font-weight: 600; font-size: 11px; cursor: pointer; transition: all 0.2s ease; user-select: none; overflow: hidden; height: 28px; }\n    .acu-nav-btn span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-top: 1px; }\n    .acu-nav-btn:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n    .acu-nav-btn:focus, .acu-nav-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n    /* [新增] 移植功能样式 */\n/* --- 1. 外层容器：防止误触边缘 --- */\n.acu-height-control {\n    display: flex;\n    align-items: center;\n    margin-right: 8px;\n    cursor: ns-resize;\n    padding: 4px;\n    border-radius: 4px;\n    color: var(--acu-text-sub);\n    transition: all 0.2s;\n    /* 关键属性：禁止在此区域触发浏览器默认手势 */\n    touch-action: none;\n}\n\n/* 交互反馈 */\n.acu-height-control:hover, .acu-height-control.active {\n    color: var(--acu-accent);\n    background: var(--acu-table-hover);\n}\n\n/* --- 2. [加保险] 内部图标：这是事件绑定的主体，必须禁止触摸 --- */\n.acu-height-drag-handle {\n    cursor: ns-resize;\n    /* 双重保险：确保直接按在图标上也不会触发滚动 */\n    touch-action: none;\n}\n\n            /* 视图切换样式 */\n            .acu-view-btn { background: transparent !important; border: none; color: var(--acu-text-main) !important; cursor: pointer; padding: 4px; margin-right: 5px; font-size: 14px; opacity: 0.7; }\n            .acu-view-btn:hover { opacity: 1; color: var(--acu-accent) !important; background: var(--acu-table-hover) !important; border-radius: 4px; }\n            .acu-view-btn.acu-reverse-btn.active, .acu-reverse-btn[data-reversed="true"] { color: var(--acu-accent) !important; opacity: 1; }\n            /* Grid 视图 (双列) */\n            .acu-card-body.view-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }\n            /* 修复版：强制 Grid 模式使用 Flex 布局并允许高度自适应 */\n.acu-card-body.view-grid .acu-card-row { display: flex; height: auto !important; min-height: fit-content; border: 1px solid var(--acu-border); border-radius: 6px; padding: 4px 6px; flex-direction: column !important; align-items: flex-start !important; background: rgba(0,0,0,0.02); box-sizing: border-box; }\n            .acu-card-body.view-grid .acu-card-row.acu-grid-span-full { grid-column: 1 / -1; }\n            .acu-card-body.view-grid .acu-card-label { width: 100% !important; font-size: 0.85em; opacity: 0.8; margin-bottom: 2px; }\n            .acu-card-body.view-grid .acu-card-value { width: 100% !important; }\n\n            /* List 视图 (单列 - 原版增强) */\n            .acu-nav-btn.active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); outline: none; border-color: transparent; }\n            .acu-nav-btn.active:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); transform: none; }\n            .acu-nav-btn.active:focus, .acu-nav-btn.active:focus-visible { outline: none; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2) !important; }\n            .acu-nav-btn.has-validation-errors { border-color: rgba(231, 76, 60, 0.5); }\n            .acu-nav-btn .acu-nav-warning-icon { color: var(--acu-error-text, #e74c3c); font-size: 10px; margin-left: 2px; animation: pulse 1.5s infinite; }\n            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }\n            .acu-action-btn { flex: 1; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--acu-btn-bg); border-radius: 8px; color: var(--acu-text-sub); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; margin: 0; }\n            .acu-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }\n            .acu-action-btn:focus, .acu-action-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n            #acu-btn-save-global { color: var(--acu-btn-active-bg); } #acu-btn-save-global:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); }\n\n            .acu-data-display { position: absolute; bottom: calc(100% + 10px); left: 0; right: 0; max-height: 80vh; height: auto; background: var(--acu-bg-panel); border: 1px solid var(--acu-border); border-radius: 8px; box-shadow: 0 8px 30px var(--acu-shadow); display: flex; flex-direction: column; z-index: 31002 !important; opacity: 0; visibility: hidden; transition: opacity 0.2s ease-out, visibility 0s linear 0.2s; pointer-events: none; }\n            .acu-data-display.visible { opacity: 1; visibility: visible; transition: opacity 0.2s ease-in, visibility 0s linear 0s; pointer-events: auto; }\n            @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }\n            @keyframes highlightFlash { 0%, 100% { box-shadow: none; } 50% { box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.6); } }\n            .acu-highlight-flash { animation: highlightFlash 0.5s ease-in-out 3; }\n\n            .acu-panel-header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); border-radius: 8px 8px 0 0; }\n            /* 核心修改：增加了 flex: 1 和 min-width: 0，强制标题在空间不足时自动变短显示省略号 */\n/* --- 新的标题布局：纵向排列 --- */\n.acu-panel-title {\n    display: flex;\n    flex-direction: column; /* 垂直堆叠 */\n    justify-content: center;\n    align-items: flex-start;\n    flex: 1; /* 占据剩余空间 */\n    min-width: 0; /* 允许压缩 */\n    margin-right: 8px;\n    overflow: hidden;\n}\n\n/* 第一行：标题主体 (加粗，稍大) */\n.acu-title-main {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    width: 100%;\n    font-size: 13px; /* 你要求的：字体变小一点，但保持加粗 */\n    font-weight: bold;\n    color: var(--acu-text-main);\n    line-height: 1.2;\n}\n\n/* 标题文字本身 (溢出省略) */\n.acu-title-text {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n/* 第二行：页码信息 (灰色，更小) */\n.acu-title-sub {\n    font-size: 10px;\n    color: var(--acu-text-sub);\n    font-weight: normal;\n    opacity: 0.8;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    width: 100%;\n    line-height: 1.2;\n    margin-top: 1px;\n}\n            /* 增加了 flex-shrink: 0; 防止被标题挤压 */\n/* 核心修改：flex-shrink: 0 确保这一块区域永远不会被压缩 */\n.acu-header-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }\n            .acu-search-wrapper { position: relative; display: flex; align-items: center; }\n            .acu-wrapper input.acu-search-input { background: var(--acu-btn-bg) !important; border: 1px solid var(--acu-border) !important; color: var(--acu-text-main) !important; padding: 4px 8px 4px 24px; border-radius: 12px; font-size: 12px; width: 120px; transition: width 0.2s, border-color 0.2s; }\n            .acu-wrapper input.acu-search-input::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            .acu-wrapper input.acu-search-input:focus { width: 160px; outline: none !important; border-color: var(--acu-accent) !important; box-shadow: none !important; }\n            .acu-search-input::placeholder { color: var(--acu-text-sub) ; opacity: 0.7; }\n            .acu-search-icon { position: absolute; left: 8px; font-size: 10px; color: var(--acu-text-sub); pointer-events: none; }\n            /* 增加了 min-width 和 flex-shrink: 0 */\n            .acu-panel-content { flex: 1; overflow-x: auto; overflow-y: hidden; padding: 15px; background: transparent; scrollbar-width: thin; scrollbar-color: var(--acu-scrollbar-thumb) var(--acu-scrollbar-track); overscroll-behavior-x: contain; overscroll-behavior-y: auto; touch-action: pan-x pan-y; -webkit-overflow-scrolling: touch; }\n            /* 增加了 height: 100%; 让网格容器填满面板的高度 */\n.acu-card-grid { display: flex; flex-wrap: nowrap; gap: 12px; align-items: flex-start; }\n            .acu-layout-vertical .acu-panel-content { overflow-x: hidden !important; overflow-y: auto !important; overscroll-behavior: auto; touch-action: manipulation; min-height: 0; }\n            /* 竖向布局时恢复 auto 高度 */\n.acu-layout-vertical .acu-card-grid { flex-wrap: wrap !important; justify-content: center; padding-bottom: 20px; height: auto; }\n.acu-wrapper:not(.acu-layout-vertical) .acu-manual-mode .acu-card-grid { height: 100%; } .acu-manual-mode .acu-data-card { max-height: 100% !important; overscroll-behavior-y: auto; } .acu-data-card { flex: 0 0 var(--acu-card-width, 260px); width: var(--acu-card-width, 260px); background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; height: auto; max-height: 60vh; overflow-y: auto; overscroll-behavior-y: auto; touch-action: manipulation; transition: all 0.2s ease; display: flex; flex-direction: column; position: relative; }\n            .acu-data-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--acu-shadow); border-color: var(--acu-accent); }\n            .acu-data-card.pending-deletion { opacity: 0.6; border: 1px dashed var(--acu-error-text, #e74c3c); }\n            .acu-data-card.pending-deletion::after { content: "待删除"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--acu-error-text, #e74c3c); font-size: 24px; font-weight: bold; border: 2px solid var(--acu-error-text, #e74c3c); padding: 5px 10px; border-radius: 8px; opacity: 0.8; pointer-events: none; }\n            .acu-data-card.acu-card-locked { border: 2px solid var(--acu-accent); box-shadow: 0 0 8px rgba(var(--acu-accent-rgb, 59, 130, 246), 0.3); position: relative; }\n            .acu-data-card.acu-card-locked::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, rgba(var(--acu-accent-rgb, 59, 130, 246), 0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; border-radius: 8px; }\n            .acu-row-lock-badge { color: var(--acu-accent); font-size: 14px; opacity: 0.9; margin-left: 4px; flex-shrink: 0; }\n            @keyframes pulse-highlight { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }\n            .acu-highlight-manual { color: var(--acu-hl-manual) !important; background-color: var(--acu-hl-manual-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-highlight-diff { color: var(--acu-hl-diff) !important; background-color: var(--acu-hl-diff-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-editable-title.acu-highlight-manual, .acu-editable-title.acu-highlight-diff { width: auto; display: inline-block; }\n            .acu-card-header { flex: 0 0 auto; padding: 8px 10px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); font-weight: bold; color: var(--acu-text-main); font-size: 14px; display: flex; flex-direction: row !important; align-items: center !important; justify-content: flex-start !important; gap: 8px; min-height: 40px; height: auto !important; position: relative; }\n            .acu-editable-title { flex: 1; width: auto !important; cursor: pointer; border-bottom: 1px dashed transparent; transition: all 0.2s; white-space: pre-wrap !important; overflow: visible !important; word-break: break-word !important; text-align: center; line-height: 1.3; margin: 0; }\n            .acu-editable-title:hover { border-bottom-color: var(--acu-accent); color: var(--acu-accent); }\n            .acu-card-index { position: static !important; transform: none !important; margin: 0; flex-shrink: 0; font-size: 11px; color: var(--acu-text-sub); font-weight: normal; background: var(--acu-badge-bg); padding: 2px 6px; border-radius: 4px; }\n            .acu-bookmark-icon { position: absolute; top: 8px; right: 8px; color: var(--acu-accent); cursor: pointer; font-size: 16px; opacity: 0.3; transition: opacity 0.2s, color 0.2s, transform 0.2s; z-index: 10; }\n            .acu-bookmark-icon:hover { opacity: 0.6; transform: scale(1.1); }\n            .acu-bookmark-icon.bookmarked { color: var(--acu-accent); opacity: 1; }\n            .acu-card-body { padding: 6px 12px; display: flex; flex-direction: column; gap: 0; font-size: var(--acu-font-size, 13px); flex: 1; }\n            .acu-card-row { display: block; padding: 6px 0; border-bottom: 1px dashed var(--acu-border); cursor: pointer; overflow: hidden; }\n            .acu-card-row:last-child { border-bottom: none; }\n            .acu-card-actions { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 10px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); }\n            .acu-action-item { padding: 4px 10px; font-size: 11px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.15s; white-space: nowrap; }\n            .acu-action-item:hover { background: var(--acu-btn-hover); border-color: var(--acu-accent); color: var(--acu-accent); transform: translateY(-1px); }\n            .acu-action-item:active { transform: translateY(0); }\n            .acu-action-item.check-type { border-style: dashed; }\n            .acu-action-item i { font-size: 10px; opacity: 0.7; }\n            .acu-card-row:hover { background: var(--acu-table-hover); }\n            .acu-card-label { float: left !important; clear: left; width: auto !important; margin-right: 8px !important; color: var(--acu-text-sub); font-size: 0.9em; line-height: 1.5; padding-top: 0; }\n            .acu-hide-label .acu-card-label { display: none; }\n            .acu-hide-label .acu-card-value { width: 100% !important; }\n            .acu-inline-dice-btn:hover { opacity: 1 !important; transform: scale(1.2); }\n            .acu-card-value { display: block; width: auto !important; margin: 0; text-align: left !important; word-break: break-all !important; white-space: pre-wrap !important; line-height: 1.5 !important; color: var(--acu-text-main); font-size: 1em; }\n            .acu-tag-container { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; margin-top: 2px; }\n            .acu-multi-attr-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 8px; }\n            .acu-badge { display: inline-block; padding: 1px 8px; border-radius: 12px; font-size: 0.9em; font-weight: 500; line-height: 1.2; }\n            .acu-badge-green { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-neutral { background: var(--acu-badge-bg); color: var(--acu-text-main); border: 1px solid var(--acu-border); }\n            .acu-panel-footer { flex: 0 0 auto; padding: 8px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); display: flex; justify-content: center; align-items: center; gap: 5px; flex-wrap: wrap; }\n            .acu-page-btn { padding: 4px 10px; min-width: 32px; height: 28px; border-radius: 4px; border: 1px solid var(--acu-border); background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }\n            .acu-page-btn:hover:not(.disabled):not(.active) { background: var(--acu-btn-hover); transform: translateY(-1px); }\n            .acu-page-btn.active { background: var(--acu-accent); color: var(--acu-button-text-on-accent, #fff); border-color: var(--acu-accent); font-weight: bold; }\n            .acu-page-btn.disabled { opacity: 0.5; cursor: not-allowed; }\n            .acu-page-info { font-size: 12px; color: var(--acu-text-sub); margin: 0 10px; }\n            /* --- [重设计] 行动选项面板样式 - 叙事书页风 --- */\n            .acu-option-panel {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                padding: 4px;\n                background: var(--acu-opt-panel-bg, var(--acu-bg-nav));\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                margin-top: 0;\n                margin-bottom: 4px;\n                width: 100%;\n                box-sizing: border-box;\n                z-index: 31001;\n                animation: acuFadeIn 0.3s ease;\n                backdrop-filter: blur(5px);\n            }\n\n            .acu-embedded-options-container {\n                width: 100%;\n                max-width: 100%;\n                margin: 12px 0;\n                padding: 0;\n                clear: both;\n                box-sizing: border-box;\n                animation: acuFadeIn 0.3s ease;\n            }\n\n            .acu-opt-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                font-size: 11px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                padding: 8px 0;\n                border-bottom: 1px solid var(--acu-border);\n                margin-bottom: 8px;\n                cursor: pointer;\n                user-select: none;\n                transition: color 0.2s;\n            }\n            .acu-opt-header:hover {\n                color: var(--acu-text-main);\n            }\n\n            /* --- [重设计] 叙事条目风格按钮 --- */\n            .acu-opt-btn {\n                background: var(--acu-opt-bright-bg, #ffffff);\n                border: 1px solid transparent;\n                padding: 3px 6px;\n                border-radius: 4px;\n                cursor: pointer;\n                color: var(--acu-text-main);\n                font-size: var(--acu-opt-font-size, 12px) !important;\n                transition: all 0.15s;\n                font-weight: normal;\n                text-align: left;\n                white-space: pre-wrap;\n                word-break: break-word;\n                min-height: 22px;\n                line-height: 1.3;\n                display: flex;\n                align-items: center;\n                justify-content: flex-start;\n                opacity: 1;\n            }\n            .acu-opt-btn:last-child {\n                border-bottom: none;\n            }\n            .acu-opt-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n                transform: translateX(3px);\n            }\n            .acu-opt-btn:active {\n                background: var(--acu-btn-active-bg);\n                color: var(--acu-btn-active-text);\n            }\n\n            /* --- [新增] 折叠态样式 --- */\n            .acu-option-panel.collapsed .acu-opt-btn {\n                display: none;\n            }\n            .acu-option-panel.collapsed .acu-opt-header {\n                border-bottom: none;\n                margin-bottom: 0;\n            }\n            @keyframes acuFadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }\n\n            /* [新增] 骰子结果隐藏动画：消除闪烁 */\n            .acu-dice-result-revealing {\n                opacity: 0 !important;\n                transform: translateY(3px) !important;\n                transition: opacity 0.18s ease-out, transform 0.18s ease-out !important;\n            }\n            .acu-dice-result-revealed {\n                opacity: 1 !important;\n                transform: translateY(0) !important;\n            }\n            /* 移动端性能优化：减少动画时长 */\n            @media (max-width: 768px) {\n                .acu-dice-result-revealing {\n                    transition: opacity 0.15s ease-out, transform 0.15s ease-out !important;\n                }\n            }\n            /* 尊重用户的减弱动画偏好设置 */\n            @media (prefers-reduced-motion: reduce) {\n                .acu-dice-result-revealing {\n                    transition: none !important;\n                    opacity: 1 !important;\n                    transform: none !important;\n                }\n            }\n\n            .acu-menu-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: transparent; z-index: 31110 !important; }\n            /* 1. 菜单容器：背景色、边框、阴影全部跟随主题变量 */\n.acu-cell-menu {\n    position: fixed !important;\n    background: var(--acu-menu-bg) !important;\n    border: 1px solid var(--acu-border);\n    box-shadow: 0 6px 20px var(--acu-shadow) !important;\n    z-index: 31111 !important;\n    border-radius: 8px;\n    overflow: hidden;\n    min-width: 150px;\n    color: var(--acu-menu-text);\n}\n\n/* 2. 菜单项：文字颜色跟随主题 */\n.acu-cell-menu-item {\n    padding: 12px 16px;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    gap: 12px;\n    align-items: center;\n    color: var(--acu-menu-text);\n    font-weight: 500;\n    background: transparent;\n    transition: background 0.2s;\n}\n\n/* 3. 悬停效果：使用主题定义的通用悬停色 */\n.acu-cell-menu-item:hover {\n    background: var(--acu-table-hover);\n}\n\n/* 4. 特殊按钮优化 */\n            .acu-cell-menu-item#act-delete { color: var(--acu-error-text, #e74c3c); }\n            .acu-cell-menu-item#act-delete:hover { background: var(--acu-error-bg, rgba(231, 76, 60, 0.1)); } /* 红色半透明背景，任何主题都适配 */\n            .acu-cell-menu-item#act-close { border-top: 1px dashed var(--acu-border); color: var(--acu-text-sub); }\n\n/* 5. 匹配状态标签 */\n            .acu-match-full { color: var(--acu-success-text, #27ae60); }\n            .acu-match-partial { color: var(--acu-warning-text, #f39c12); }\n\n/* 6. 布局编辑完成按钮 */\n            .acu-btn-finish-sort {\n                background: rgba(255,255,255,0.2);\n                color: var(--acu-button-text-on-accent, #fff);\n                border: 1px solid rgba(255,255,255,0.4);\n                padding: 4px 14px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 12px;\n                transition: all 0.2s;\n                white-space: nowrap;\n            }\n            .acu-btn-finish-sort:hover, .acu-btn-finish-sort.hover {\n                background: var(--acu-button-text-on-accent, #fff);\n                color: var(--acu-accent);\n            }\n\n            .acu-edit-overlay { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.75) !important; z-index: 31200 !important; display: flex; justify-content: center !important; align-items: center !important; backdrop-filter: blur(2px); }\n            .acu-edit-dialog { background: var(--acu-bg-panel); width: 95%; max-width: 500px; max-height: 95vh; padding: 16px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 15px 50px rgba(0,0,0,0.6); color: var(--acu-text-main); border: 1px solid var(--acu-border); overflow: hidden; flex-shrink: 0; }\n            @media (min-width: 768px) { .acu-edit-dialog { max-width: 900px; width: 90%; } .acu-edit-dialog.acu-settings-dialog { max-width: 400px; width: 400px; } }\n            .acu-edit-title { margin: 0; font-size: 16px; font-weight: bold; color: var(--acu-text-main); padding-bottom: 8px; border-bottom: 1px solid var(--acu-border); }\n            .acu-edit-icon-muted { opacity: 0.7; }\n            .acu-edit-content { background: var(--acu-bg-panel); }\n            .acu-settings-content-scroll { flex: 1; overflow-y: auto; padding: 15px; }\n            .acu-card-edit-field { margin-bottom: 10px; }\n            .acu-card-edit-label { display: block; font-size: 12px; color: var(--acu-accent); font-weight: bold; margin-bottom: 4px; }\n            .acu-card-edit-input { width: 100% !important; padding: 10px !important; border: 1px solid var(--acu-border) !important; border-radius: 6px !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box !important; font-size: 14px !important; line-height: 1.5 !important; appearance: none; -webkit-appearance: none; }\n            .acu-card-edit-input:focus { outline: none !important; border-color: var(--acu-accent) !important; box-shadow: none !important; }\n            .acu-edit-dialog select { padding: 6px 10px !important; border: 1px solid var(--acu-border) !important; border-radius: 6px !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-size: 13px !important; appearance: none; -webkit-appearance: none; cursor: pointer; }\n            .acu-edit-dialog select:focus { outline: none !important; border-color: var(--acu-accent) !important; }\n            .acu-edit-dialog select option { background: var(--acu-bg-panel) !important; color: var(--acu-text-main) !important; }\n            .acu-edit-dialog input[type="text"], .acu-edit-dialog input[type="number"], .acu-edit-dialog input[type="search"], .acu-edit-dialog input:not([type]) { padding: 6px 10px !important; border: 1px solid var(--acu-border) !important; border-radius: 6px !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-size: 13px !important; box-sizing: border-box !important; }\n            .acu-edit-dialog input:focus { outline: none !important; border-color: var(--acu-accent) !important; }\n            .acu-edit-dialog input::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            .acu-card-edit-textarea { min-height: 40px; max-height: 500px; resize: none; overflow-y: hidden; }\n            .acu-edit-textarea { width: 100%; height: auto; padding: 12px; border: 1px solid var(--acu-border) !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; line-height: 1.6; overflow-y: auto !important; }\n            .acu-edit-textarea:focus { outline: none; border-color: var(--acu-accent) !important; }\n            .acu-edit-textarea::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            @media (min-width: 768px) { .acu-edit-textarea { height: auto !important; font-size: 15px !important; } }\n            .acu-edit-textarea:focus { outline: 1px solid #aaa; }\n            .acu-dialog-btns { display: flex; justify-content: flex-end; gap: 20px; margin-top: 10px; }\n            .acu-dialog-btn { background: none; border: none; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 6px; color: var(--acu-text-sub); transition: color 0.2s; }\n            .acu-dialog-btn:hover { color: var(--acu-text-main); } .acu-btn-confirm { color: var(--acu-success-text); } .acu-btn-confirm:hover { opacity: 0.8; }\n            /* --- [UI Optimization] PC-First Edit Mode Styles --- */\n            .acu-order-controls { grid-column: 1 / -1; order: -2; display: none; width: 100%; text-align: left; background: var(--acu-accent); color: var(--acu-button-text-on-accent, var(--acu-text-main)); padding: 6px 12px; margin: 0 0 8px 0; border-radius: 4px; font-weight: bold; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }\n            .acu-order-controls.visible { display: flex; align-items: center; justify-content: space-between; }\n\n            .acu-nav-container.editing-order { border: 2px solid var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-nav-container.editing-order .acu-nav-btn, .acu-nav-container.editing-order .acu-action-btn { opacity: 1 !important; cursor: grab !important; border: 1px solid var(--acu-border); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }\n            .acu-nav-container.editing-order .acu-nav-btn:hover, .acu-nav-container.editing-order .acu-action-btn:hover { border-color: var(--acu-accent); transform: translateY(-1px); }\n\n            .acu-swap-selected { background-color: var(--acu-accent) !important; color: var(--acu-button-text-on-accent, var(--acu-text-main)) !important; border-color: var(--acu-accent); box-shadow: 0 0 0 2px rgba(255,255,255,0.5), 0 4px 12px rgba(0,0,0,0.2); transform: scale(1.05); z-index: 10; }\n            .acu-drag-over { border: 2px dashed var(--acu-accent); opacity: 0.5; transform: scale(0.95); background: rgba(var(--acu-accent-rgb), 0.1); }\n\n            /* --- [PC Style] Unused Pool Optimization (工具架样式) --- */\n            .acu-unused-pool {\n                grid-column: 1 / -1;\n                display: none;\n                flex-wrap: wrap;\n                gap: 8px;\n                background: var(--acu-table-head); /* 使用表头背景色，更融合 */\n                border: 1px dashed var(--acu-border); /* 虚线框表示这是编辑区域 */\n                padding: 10px 15px;\n                margin: 0 0 10px 0;\n                border-radius: 8px;\n                justify-content: flex-start;\n                align-items: center;\n                min-height: 50px;\n                box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);\n            }\n            .acu-unused-pool.visible { display: flex; animation: acuFadeIn 0.2s ease-out; }\n\n            /* PC端清晰的文字引导 */\n            .acu-unused-pool::before {\n                content: "备选功能池 (拖拽图标到下方启用 ↘)";\n                display: flex;\n                align-items: center;\n                height: 32px;\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                margin-right: 15px;\n                padding-right: 15px;\n                border-right: 1px solid var(--acu-border);\n                white-space: nowrap;\n                opacity: 0.8;\n            }\n\n            .acu-actions-group { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 4px; border-top: 1px dashed var(--acu-border); padding-top: 8px; margin-top: 4px; min-height: 36px; transition: all 0.2s; }\n\n            /* [修复] 移动端顶部布局适配：强制提升顺序 */\n            .acu-pos-top .acu-actions-group { order: -1; border-top: none; border-bottom: 1px dashed var(--acu-border); margin-top: 0; margin-bottom: 6px; padding-top: 0; padding-bottom: 8px; }\n\n            /* [修复] 编辑模式下，备选池也跟随置顶 */\n            .acu-pos-top .acu-unused-pool { order: -1; margin-bottom: 10px; border-bottom: 1px dashed var(--acu-border); }\n            .acu-actions-group.dragging-over { background: rgba(127, 127, 127, 0.05); box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }\n\n            /* 仪表盘横向滚动模式 */\n                .acu-dash-body.acu-dash-horizontal {\n                    display: flex;\n                    flex-wrap: nowrap;\n                    gap: 15px;\n                    overflow-x: auto;\n                    overflow-y: hidden;\n                    padding-bottom: 10px;\n                }\n                .acu-dash-body.acu-dash-horizontal > div {\n                    flex: 0 0 280px;\n                    min-width: 280px;\n                    max-height: 60vh;\n                    overflow-y: auto;\n                }\n                @media (min-width: 769px) {\n                    .acu-dash-body.acu-dash-horizontal > div {\n                        flex: 0 0 320px;\n                        min-width: 320px;\n                    }\n                }\n            /* Mobile adjustments to keep it usable there */\n            @media (max-width: 768px) {\n                .acu-unused-pool { justify-content: center; background: rgba(0,0,0,0.05); border: 1px dashed var(--acu-border); border-bottom: none; margin: 0 0 8px 0; border-radius: 6px; }\n                .acu-unused-pool::before { display: block; width: 100%; text-align: center; margin-bottom: 4px; content: "可选功能池 (拖拽或点击)"; }\n                .acu-order-controls { flex-direction: column; gap: 6px; text-align: center; }\n            }\n            .acu-actions-group.dragging-over { background: rgba(var(--acu-accent-rgb), 0.1); border-color: var(--acu-accent); }\n            .acu-settings-item { margin-bottom: 15px; }\n            .acu-settings-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #ccc; }\n            .acu-settings-val { float: right; color: #4cd964; font-size: 12px; }\n            .acu-slider { width: 100%; height: 4px; background: #555; border-radius: 2px; outline: none; -webkit-appearance: none; }\n            .acu-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; }\n            .acu-select { width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; border-radius: 4px; outline: none; }\n            .acu-edit-overlay input[type="checkbox"].acu-checkbox { margin-right: 10px; accent-color: var(--acu-accent) !important; background: transparent !important; background-color: transparent !important; }\n            .acu-btn-block { width: 100%; padding: 10px; background: #444; color: #eee; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }\n            .acu-btn-block:hover { background: #555; color: #fff; }\n            .acu-expand-trigger { background: var(--acu-bg-nav); border: 1px solid var(--acu-border); box-shadow: 0 2px 6px var(--acu-shadow); cursor: pointer; color: var(--acu-text-main); font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 31005 !important; }\n            .acu-expand-trigger:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n            .acu-col-bar { width: 100%; justify-content: center; padding: 8px 10px; border-radius: 6px; }\n            .acu-col-pill { width: auto !important; padding: 6px 16px; border-radius: 50px; }\n            .acu-col-mini { width: 40px !important; height: 40px !important; padding: 0; justify-content: center; border-radius: 50%; }\n            .acu-col-mini span { display: none; }\n            /* [优化] 小眼睛图标悬停效果 */\n            .acu-nav-toggle-btn:hover { opacity: 1 !important; transform: translateY(-50%) scale(1.2); color: var(--acu-accent); }\n            .acu-align-right { margin-left: auto; align-self: flex-end; }\n            .acu-align-center { \n                margin-left: auto !important; \n                margin-right: auto !important; \n            }\n            .acu-align-left { margin-right: auto; margin-left: 0; align-self: flex-start; }\n            .acu-nav-container.acu-left-mode .acu-actions-group { order: -1; margin-left: 0; margin-right: 10px; }\n            #acu-btn-collapse { color: var(--acu-text-sub); }\n            #acu-btn-collapse:hover { color: var(--acu-text-main); background: rgba(0,0,0,0.05); }\n            @keyframes acu-breathe { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.85); color: #ff7e67; } 100% { opacity: 1; transform: scale(1); } } .acu-icon-breathe { animation: acu-breathe 3s infinite ease-in-out !important; display: inline-block; }\n\n            @media (min-width: 768px) {\n                .acu-wrapper.acu-mode-embedded .acu-nav-container { width: fit-content !important; min-width: 300px; max-width: 100%; margin: 0 auto; border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; border: 1px solid var(--acu-border); padding: 6px 20px; background: var(--acu-bg-nav) !important; }\n                .acu-wrapper.acu-mode-embedded .acu-data-display { bottom: calc(100% + 12px) !important; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important; }\n                .acu-nav-container { display: flex; flex-wrap: wrap !important; gap: 6px !important; padding: 6px 10px; grid-template-columns: none !important; flex-direction: row !important; justify-content: flex-start !important; align-items: center !important; height: auto !important; }\n                .acu-nav-container .acu-nav-btn { width: fit-content !important; flex: 0 0 auto !important; height: 32px !important; padding: 0 12px; font-size: 13px !important; min-width: auto !important; }\n                .acu-nav-btn span { max-width: 200px; }\n                .acu-action-btn { flex: 0 0 32px !important; width: 32px !important; height: 32px !important; background: transparent !important; color: var(--acu-text-sub) !important; border-radius: 6px; border: 1px solid transparent; }\n                .acu-action-btn:hover { background: var(--acu-btn-hover) !important; color: var(--acu-text-main) !important; transform: scale(1.1); box-shadow: none; }\n                #acu-btn-save-global { color: var(--acu-accent) !important; }\n                #acu-btn-save-global:hover { background: var(--acu-accent) !important; color: var(--acu-btn-active-text) !important; }\n                .acu-order-controls { margin: 0 0 8px 0; padding: 4px; }\n                .acu-actions-group { width: auto !important; margin-left: auto !important; border-top: none !important; border-bottom: none !important; padding: 0; margin-top: 0 !important; margin-bottom: 0 !important; gap: 4px !important; background: transparent; justify-content: flex-end; order: 9999 !important; display: flex; }\n                .acu-pos-top .acu-actions-group { order: -1 !important; margin-left: 0 !important; margin-right: 10px !important; justify-content: flex-start !important; }\n            }\n            @media (max-width: 768px) {\n                .acu-panel-content { -webkit-overflow-scrolling: touch !important; overscroll-behavior-y: auto; }\n                .acu-data-card { box-shadow: none !important; border: 1px solid var(--acu-border); transform: translateZ(0); }\n                .acu-data-card:hover { transform: none !important; box-shadow: none !important; }\n                .acu-nav-btn:hover { transform: none !important; }\n            }\n            /* === 移动端投骰面板适配 === */\n            @media (max-width: 768px) {\n                .acu-dice-panel, .acu-contest-panel {\n                    position: relative !important;\n                    top: auto !important;\n                    left: auto !important;\n                    transform: none !important;\n                    width: 92vw !important;\n                    max-width: 400px !important;\n                    max-height: calc(100vh - 32px) !important;\n                    max-height: calc(100dvh - 32px) !important;\n                }\n                .acu-dice-overlay, .acu-contest-overlay {\n                    align-items: center !important;\n                    padding: 16px !important;\n                }\n            }\n                /* === 仪表盘新增样式：可展开地点列表 === */\n                .acu-dash-body {\n                    display: grid;\n                    grid-template-columns: 1fr 1.2fr 1fr;\n                    gap: 15px;\n                    margin: 8px 0;\n                }\n\n                .acu-dash-locations {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-locations h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-location-group {\n                    margin-bottom: 8px;\n                    border-radius: 6px;\n                    overflow: hidden;\n                    background: var(--acu-card-bg);\n                    border: 1px solid transparent;\n                    transition: all 0.2s;\n                }\n\n                .acu-location-group.expanded {\n                    border-color: var(--acu-accent);\n                }\n\n                .acu-location-header {\n                    padding: 8px 10px;\n                    cursor: pointer;\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                    background: var(--acu-table-head);\n                    transition: all 0.2s;\n                    user-select: none;\n                }\n\n                .acu-location-header:hover {\n                    background: var(--acu-table-hover);\n                }\n\n                .acu-expand-icon {\n                    font-size: 10px;\n                    transition: transform 0.2s;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-group.expanded .acu-expand-icon {\n                    transform: rotate(90deg);\n                    color: var(--acu-accent);\n                }\n\n                .acu-region-name {\n                    flex: 1;\n                    font-weight: bold;\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-location-count {\n                    font-size: 11px;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-list {\n                    max-height: 0;\n                    overflow: hidden;\n                    transition: max-height 0.3s ease;\n                }\n\n                .acu-location-group.expanded .acu-location-list {\n                    max-height: 500px;\n                }\n\n                .acu-location-item {\n                    padding: 6px 10px 6px 26px;\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                    font-size: 12px;\n                    border-bottom: 1px dashed rgba(0,0,0,0.05);\n                    transition: all 0.15s;\n                }\n\n                /* 仪表盘地点名称单行省略样式 */\n                .acu-dash-locations .acu-location-item {\n                    padding: 4px 8px !important;\n                    min-width: 0; /* 允许flex子元素收缩 */\n                    overflow: hidden; /* 防止内容溢出 */\n                    align-items: center;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child {\n                    display: flex !important;\n                    align-items: center;\n                    gap: 6px;\n                    flex: 1;\n                    min-width: 0; /* 允许flex子元素收缩 */\n                    overflow: hidden;\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child i {\n                    flex-shrink: 0; /* 图标不收缩 */\n                    font-size: 9px;\n                    opacity: 0.4;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-dash-locations .acu-location-item > i {\n                    margin-left: auto;\n                    width: 14px;\n                    text-align: center;\n                    font-size: 10px;\n                    opacity: 0.4;\n                    color: var(--acu-text-sub);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    line-height: 1;\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child > span {\n                    white-space: nowrap;\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    flex: 1;\n                    min-width: 0; /* 允许flex子元素收缩 */\n                }\n\n                .acu-location-item:last-child {\n                    border-bottom: none;\n                }\n\n                .acu-location-item:hover {\n                    background: var(--acu-table-hover);\n                    transform: translateX(4px);\n                }\n\n                .acu-location-item.current {\n                    background: var(--acu-hl-diff-bg);\n                }\n\n                .acu-location-item i {\n                    font-size: 10px;\n                    opacity: 0.6;\n                }\n\n                .acu-current-badge {\n                    margin-left: auto;\n                    font-size: 10px;\n                    padding: 2px 6px;\n                    background: var(--acu-btn-active-bg);\n                    color: var(--acu-btn-active-text);\n                    border-radius: 3px;\n                    font-weight: bold;\n                }\n                /* === 仪表盘核心样式（补充） === */\n                .acu-dash-context {\n                    background: linear-gradient(135deg, var(--acu-table-head), var(--acu-bg-panel));\n                    padding: 15px;\n                    border-radius: 8px;\n                    margin-bottom: 15px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-location {\n                    font-size: 18px;\n                    font-weight: bold;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                }\n\n                .acu-dash-location-desc {\n                    font-size: 13px;\n                    color: var(--acu-text-sub);\n                    margin-top: 6px;\n                    line-height: 1.5;\n                }\n\n                .acu-dash-player, .acu-dash-intel {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-player h3, .acu-dash-intel h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-player-status {\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-task-item {\n                    padding: 8px;\n                    margin-bottom: 6px;\n                    background: rgba(0,0,0,0.03);\n                    border-radius: 6px;\n                    border-left: 3px solid var(--acu-border);\n                }\n\n                .acu-task-name {\n                    font-size: 13px;\n                    font-weight: 500;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-empty-hint {\n                    font-size: 11px;\n                    color: var(--acu-text-sub);\n                    text-align: center;\n                    padding: 15px;\n                    opacity: 0.7;\n                    grid-column: 1 / -1;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                }\n                /* 仪表盘中有固定高度容器的空状态居中 */\n                .acu-player-status .acu-empty-hint,\n                .acu-dash-locations > div .acu-empty-hint {\n                    height: 100%;\n                    min-height: inherit;\n                }\n                /* 审核面板空状态居中 */\n                .acu-changes-content .acu-empty-hint {\n                    flex: 1;\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    justify-content: center;\n                    min-height: 200px;\n                }\n\n                .acu-dashboard-content {\n                    padding: 8px 15px;\n                    overflow-y: auto !important;\n                    overflow-x: hidden !important;\n                    -webkit-overflow-scrolling: touch !important;\n                    touch-action: pan-y !important;\n                    overscroll-behavior-y: contain;\n                    max-height: calc(80vh - 60px);\n                }\n\n                /* === 仪表盘交互按钮优化 === */\n                h3.acu-dash-table-link,\n                h4.acu-dash-table-link {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    padding: 2px 4px;\n                    margin: -2px -4px;\n                    border-radius: 4px;\n                }\n                h3.acu-dash-table-link:hover,\n                h4.acu-dash-table-link:hover {\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                }\n\n                /* 仪表盘操作图标 - 统一放大+增加点击热区 */\n                .acu-dash-dice-btn,\n                .acu-dash-goto-btn,\n                .acu-dash-use-item-btn,\n                .acu-dash-use-skill-btn,\n                .acu-dash-track-task-btn,\n                .acu-dash-msg-btn,\n                .acu-dash-contest-btn,\n                .acu-dash-dice-free,\n                .acu-dash-relation-graph-btn,\n                .acu-dash-avatar-manager-btn {\n                    cursor: pointer;\n                    color: var(--acu-text-sub);\n                    opacity: 0.5;\n                    font-size: 14px !important;\n                    padding: 6px;\n                    margin: -4px;\n                    border-radius: 4px;\n                    transition: all 0.15s;\n                    display: inline-flex;\n                    align-items: center;\n                    justify-content: center;\n                    min-width: 28px;\n                    min-height: 28px;\n                }\n                .acu-dash-dice-btn:hover,\n                .acu-dash-goto-btn:hover,\n                .acu-dash-use-item-btn:hover,\n                .acu-dash-use-skill-btn:hover,\n                .acu-dash-track-task-btn:hover,\n                .acu-dash-msg-btn:hover,\n                .acu-dash-contest-btn:hover,\n                .acu-dash-dice-free:hover {\n                    opacity: 1;\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                    transform: scale(1.1);\n                }\n\n                /* 仪表盘可点击项 - 增强反馈 */\n                .acu-dash-clickable {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    border-radius: 4px;\n                }\n                .acu-dash-clickable:hover {\n                    background: var(--acu-table-hover);\n                }\n                .acu-dash-clickable:active {\n                    transform: scale(0.98);\n                }\n\n                @media (max-width: 768px) {\n                    .acu-dash-body:not(.acu-dash-horizontal) {\n                        grid-template-columns: 1fr;\n                        max-height: none;\n                        overflow: visible;\n                    }\n\n                    .acu-dashboard-content {\n                        max-height: calc(50vh - 40px) !important;\n                        padding: 8px 10px !important;\n                        padding-bottom: 8px !important;\n                    }\n\n                    .acu-dash-body.acu-dash-horizontal {\n                        gap: 10px;\n                        padding-bottom: 6px;\n                    }\n\n                    .acu-dash-player,\n                    .acu-dash-locations,\n                    .acu-dash-intel {\n                        padding: 10px;\n                    }\n\n                    /* 移动端进一步放大操作按钮 */\n                    .acu-dash-dice-btn,\n                    .acu-dash-goto-btn,\n                    .acu-dash-use-item-btn,\n                    .acu-dash-use-skill-btn,\n                    .acu-dash-track-task-btn,\n                    .acu-dash-msg-btn,\n                    .acu-dash-contest-btn,\n                    .acu-dash-dice-free {\n                        font-size: 16px !important;\n                        padding: 8px;\n                        min-width: 36px;\n                        min-height: 36px;\n                    }\n                }\n            /* === 仪表盘预览卡片样式 === */\n            .acu-preview-overlay {\n                z-index: 31100 !important;\n                backdrop-filter: blur(3px);\n                animation: acuFadeIn 0.2s ease;\n            }\n\n                .acu-preview-overlay .acu-data-card {\n                    width: 90vw;\n                    max-width: 400px;\n                    flex: none;\n                }\n                @media (min-width: 768px) {\n                    .acu-preview-overlay .acu-data-card {\n                        max-width: 550px;\n                    }\n                }\n\n            .acu-preview-close:hover {\n                background: var(--acu-error-bg, rgba(231, 76, 60, 0.1));\n                color: var(--acu-error-text, #e74c3c);\n            }\n\n            .acu-dash-clickable {\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n\n            .acu-dash-clickable:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-current-location span {\n                color: inherit;\n                font-weight: inherit;\n            }\n            .acu-current-location i {\n                color: inherit;\n            }\n            .acu-current-location > span:first-child > span {\n                font-weight: 600;\n            }\n            /* === 自定义下拉菜单样式 === */\n            .acu-dropdown-wrapper { position: relative; width: 100%; }\n            .acu-dropdown-list {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                max-height: 150px;\n                overflow-y: auto;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                z-index: 31105;\n                display: none;\n            }\n            .acu-dropdown-list.visible { display: block; }\n            .acu-dropdown-item {\n                padding: 6px 10px;\n                font-size: 12px;\n                cursor: pointer;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                background: transparent;\n                color: var(--acu-text-main);\n                transition: background 0.1s;\n            }\n            .acu-dropdown-item:hover {\n                background: var(--acu-table-head);\n            }\n            .acu-dropdown-empty {\n                padding: 8px 10px;\n                font-size: 12px;\n                text-align: center;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            /* === 输入框清除按钮样式 === */\n            .acu-input-wrapper { position: relative; display: flex; align-items: center; width: 100%; }\n            .acu-input-wrapper input { padding-right: 24px !important; }\n            .acu-clear-btn { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background: transparent !important; border: none !important; font-size: 12px; cursor: pointer; padding: 4px; line-height: 1; opacity: 0.5; transition: opacity 0.2s, color 0.2s; z-index: 5; color: var(--acu-text-sub); }\n            .acu-clear-btn:hover { background: transparent !important; border: none !important; opacity: 1 !important; color: var(--acu-accent) !important; }\n\n            /* === 结果徽章样式 === */\n            .acu-result-badge {\n                padding: 3px 8px;\n                border-radius: 6px;\n                font-size: 11px;\n                font-weight: bold;\n                white-space: nowrap;\n                display: inline-flex;\n                align-items: center;\n                border: 1px solid transparent;\n            }\n            .acu-result-badge-crit-success { background-color: var(--acu-success-bg); color: var(--acu-text-main); border-color: var(--acu-accent); }\n            .acu-result-badge-extreme-success { background-color: var(--acu-hl-diff-bg); color: var(--acu-text-main); border-color: var(--acu-hl-diff); }\n            .acu-result-badge-success { background-color: var(--acu-success-bg); color: var(--acu-text-main); border-color: var(--acu-success-text); }\n            .acu-result-badge-warning { background-color: var(--acu-warning-bg); color: var(--acu-text-main); border-color: var(--acu-warning-text); }\n            .acu-result-badge-failure { background-color: var(--acu-error-bg); color: var(--acu-text-main); border-color: var(--acu-error-text); }\n            .acu-result-badge-crit-failure { background-color: var(--acu-error-bg); color: var(--acu-text-main); border-color: var(--acu-error-text); }\n\n\n            /* === 骰子结果显示区域 === */\n            .acu-dice-result-display {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 100%;\n                gap: 8px;\n            }\n            .acu-dice-result-value {\n                font-size: 22px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-dice-result-target {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                opacity: 0.9;\n            }\n            .acu-dice-retry-btn {\n                background: transparent !important;\n                border: none !important;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                padding: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                opacity: 0.8;\n                transition: opacity 0.2s;\n            }\n            .acu-dice-retry-btn:hover {\n                opacity: 1;\n                color: var(--acu-accent);\n            }\n\n            /* === 资源消耗器按钮 (燃运等) === */\n            .acu-dice-burners {\n                display: inline-flex;\n                align-items: center;\n                gap: 4px;\n                margin-left: 4px;\n            }\n            .acu-dice-burner-btn {\n                background: transparent !important;\n                border: none !important;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                padding: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                opacity: 0.8;\n                transition: opacity 0.2s;\n            }\n            .acu-dice-burner-btn:hover {\n                opacity: 1;\n                color: var(--acu-accent);\n            }\n            .acu-dice-burner-btn i {\n                font-size: 14px;\n            }\n\n            /* === 对战结果显示区域 === */\n            .acu-contest-result-display {\n                display: none;\n                margin-bottom: 10px;\n            }\n            .acu-contest-result-container {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                cursor: pointer;\n            }\n            .acu-contest-result-row {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 12px;\n                padding: 12px 16px;\n                background: var(--acu-light-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                transition: all 0.2s;\n            }\n            .acu-contest-result-row:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-accent);\n            }\n            .acu-contest-result-winner-row {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                padding: 10px 16px;\n                background: var(--acu-light-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                transition: all 0.2s;\n            }\n            .acu-contest-result-winner-row:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-accent);\n            }\n            .acu-contest-reroll-icon {\n                font-size: 14px;\n                color: var(--acu-text-sub);\n                transition: all 0.2s;\n            }\n            .acu-contest-result-winner-row:hover .acu-contest-reroll-icon {\n                color: var(--acu-accent);\n                transform: rotate(90deg);\n            }\n            .acu-contest-result-inner {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 12px;\n                flex: 1;\n            }\n            .acu-contest-result-side {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-contest-result-side.right {\n                flex-direction: row-reverse;\n            }\n            .acu-contest-vs {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                padding: 0 4px;\n            }\n            .acu-contest-result-name {\n                font-size: 10px;\n                color: var(--acu-text-main);\n                opacity: 0.9;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                max-width: 4em;\n                text-align: center;\n            }\n            .acu-contest-result-value {\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-contest-winner-text {\n                font-size: 14px;\n                font-weight: bold;\n            }\n            .acu-contest-winner-success { color: var(--acu-success-text); }\n            .acu-contest-winner-warning { color: var(--acu-warning-text); }\n            .acu-contest-winner-failure { color: var(--acu-failure-text); }\n\n            /* === 关系图滑块容器 === */\n            .acu-node-size-slider-container {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n            }\n            .acu-node-size-slider-container .acu-slider-label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                white-space: nowrap;\n            }\n            .acu-node-size-slider-container .acu-slider-value {\n                font-size: 11px;\n                color: var(--acu-accent);\n                font-weight: bold;\n                min-width: 35px;\n                text-align: right;\n            }\n            .acu-node-size-slider-container input[type="range"] {\n                background: var(--acu-btn-bg);\n            }\n\n            /* === 关系图过滤按钮 === */\n            .acu-graph-filter-btn {\n                transition: all 0.15s;\n            }\n            .acu-graph-filter-btn.active {\n                background: var(--acu-accent) !important;\n                color: var(--acu-button-text-on-accent, #fff) !important;\n                border-color: var(--acu-accent) !important;\n            }\n\n            /* === 关系图箭头标记 - 使用 CSS 变量 === */\n            .acu-graph-svg #arrowhead-end polygon,\n            .acu-graph-svg #arrowhead-start polygon {\n                fill: var(--acu-text-sub);\n            }\n            .acu-graph-svg #arrowhead-end-hl polygon,\n            .acu-graph-svg #arrowhead-start-hl polygon {\n                fill: var(--acu-accent);\n            }\n\n            /* === 导入提示样式 === */\n            .acu-import-empty {\n                text-align: center;\n                padding: 20px;\n                color: var(--acu-text-sub);\n            }\n            .acu-import-warning {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-import-warning i {\n                color: var(--acu-warning-icon, #f39c12);\n            }\n            .acu-import-success {\n                text-align: center;\n                padding: 10px;\n                color: var(--acu-success-text);\n            }\n\n            /* ========== 人物关系图样式 ========== */\n            .acu-relation-graph-overlay {\n                background: rgba(0,0,0,0.8);\n                z-index: 31100;\n                backdrop-filter: blur(4px);\n            }\n            .acu-relation-graph-container {\n                width: 95%;\n                max-width: 900px;\n                height: 85vh;\n                max-height: 700px;\n            }\n            .acu-graph-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-graph-actions {\n                display: flex;\n                gap: 8px;\n            }\n            .acu-graph-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-graph-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-graph-canvas-wrapper {\n                flex: 1;\n                overflow: hidden;\n                position: relative;\n                min-height: 0;\n            }\n            .acu-graph-svg {\n                width: 100%;\n                height: 100%;\n                cursor: grab;\n            }\n            .acu-graph-svg:active { cursor: grabbing; }\n            .acu-graph-edge {\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                opacity: 0.6;\n            }\n            .acu-graph-edge-label {\n                font-size: 11px;\n                fill: var(--acu-text-sub);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-graph-node { cursor: grab; }\n            .acu-graph-node:active { cursor: grabbing; }\n            .acu-node-bg {\n                fill: var(--acu-btn-bg);\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                transition: all 0.2s;\n            }\n            .acu-node-bg.player {\n                fill: var(--acu-accent);\n                stroke: var(--acu-btn-active-text);\n            }\n            .acu-graph-node:hover .acu-node-bg {\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n                filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));\n            }\n            .acu-graph-node:hover .acu-node-avatar {\n                box-shadow: 0 0 0 2px var(--acu-accent);\n            }\n            .acu-graph-svg.highlighting .acu-graph-node {\n                opacity: 0.2;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted {\n                opacity: 1;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted .acu-node-bg {\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted .acu-node-avatar {\n                box-shadow: 0 0 0 2px var(--acu-accent);\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge.highlighted {\n                opacity: 1;\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label.highlighted {\n                opacity: 1;\n                fill: var(--acu-accent);\n                font-weight: bold;\n            }\n            .acu-node-char {\n                font-size: 16px;\n                font-weight: bold;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-bg.player + text.acu-node-char,\n            .acu-node-bg.player ~ text.acu-node-char {\n                fill: var(--acu-btn-active-text);\n            }\n            .acu-node-label {\n                font-size: 12px;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-inscene-indicator {\n                fill: var(--acu-accent);\n                stroke: var(--acu-bg-panel);\n                stroke-width: 2;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));\n            }\n            .acu-graph-legend {\n                display: flex;\n                gap: 16px;\n                justify-content: center;\n                padding: 10px;\n                border-top: 1px solid var(--acu-border);\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n            }\n            .acu-graph-legend span {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-zoom-display {\n                background: var(--acu-btn-bg);\n                padding: 2px 8px;\n                border-radius: 4px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                min-width: 45px;\n                text-align: center;\n            }\n            .acu-node-size-slider-container input[type="range"] {\n                -webkit-appearance: none;\n                appearance: none;\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n                outline: none;\n                cursor: pointer;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb {\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-track {\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n            }\n            @media (max-width: 768px) {\n                .acu-relation-graph-container {\n                    width: 100%;\n                    height: 80vh;\n                    max-height: none;\n                    border-radius: 12px;\n                }\n                .acu-graph-legend {\n                    gap: 8px;\n                    flex-wrap: nowrap;\n                    padding: 8px 6px;\n                }\n            }\n\n            /* ========== 地图可视化样式 ========== */\n            .acu-map-overlay {\n                background: rgba(0,0,0,0.8);\n                z-index: 31100;\n                backdrop-filter: blur(4px);\n            }\n            .acu-map-container {\n                width: 95%;\n                max-width: 500px;\n                max-height: 85vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n                box-shadow: 0 10px 40px rgba(0,0,0,0.45);\n            }\n            .acu-map-title {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                white-space: nowrap;\n                flex-shrink: 0;\n            }\n            .acu-map-actions {\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-map-actions button {\n                width: 28px !important;\n                height: 28px !important;\n                min-width: unset !important;\n                min-height: unset !important;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n            }\n            .acu-map-actions button:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n            .acu-map-back-btn {\n                width: 28px !important;\n                height: 28px !important;\n                min-width: unset !important;\n                min-height: unset !important;\n            }\n            .acu-map-body {\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                padding: 12px;\n                overflow: hidden;\n            }\n            /* 焦点区域 - 3列Grid布局 */\n            .acu-map-focus-area {\n                display: grid;\n                grid-template-columns: 1fr auto 1fr;\n                gap: 12px;\n                align-items: center;\n                border: 1px dashed var(--acu-border);\n                border-radius: 12px;\n                padding: 16px;\n                background: var(--acu-btn-bg);\n            }\n\n            /* 侧翼 */\n            .acu-map-wing {\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                min-width: 0;\n                align-self: flex-start; /* 侧翼顶部对齐 */\n            }\n            .acu-map-wing.left { align-items: flex-end; text-align: right; }\n            .acu-map-wing.right { align-items: flex-start; text-align: left; }\n\n            .acu-map-mobile-stack {\n                display: none;\n            }\n\n            /* 头像组 */\n            .acu-map-avatar-group {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 6px;\n                align-items: flex-start; /* 顶部对齐 */\n                min-height: 70px; /* 确保有最小高度 */\n            }\n            .acu-map-wing.left .acu-map-avatar-group { justify-content: flex-end; }\n            .acu-map-wing.right .acu-map-avatar-group { justify-content: flex-start; }\n\n            /* 头像智能堆叠 */\n            .acu-map-wing.left .acu-map-avatar:not(:last-child) { margin-right: -12px; }\n            .acu-map-wing.right .acu-map-avatar:not(:first-child) { margin-left: -12px; }\n            .acu-map-avatar:hover { transform: scale(1.1); z-index: 10; position: relative; }\n\n            .acu-map-avatar {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 4px;\n                min-width: 56px;\n                cursor: pointer;\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            .acu-map-avatar-circle {\n                width: 46px;\n                height: 46px;\n                border-radius: 50%;\n                border: 2px solid var(--acu-accent);\n                background: var(--acu-btn-bg);\n                background-size: cover;\n                background-position: center;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--acu-text-sub);\n                font-weight: bold;\n                font-size: 16px;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n            .acu-map-avatar-name {\n                font-size: 11px;\n                color: var(--acu-text-main);\n                text-shadow: 0 1px 2px rgba(0,0,0,0.3);\n            }\n\n            /* 元素组 */\n            .acu-map-element-group {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                max-width: 140px;\n            }\n            .acu-map-element-chip {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                padding: 4px 8px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-bg-panel);\n                font-size: 11px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                transition: all 0.15s;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-map-element-chip:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n                transform: translateX(2px);\n            }\n\n            /* 中央舞台 */\n            .acu-map-stage-center {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                min-width: 100px;\n                z-index: 2;\n                cursor: pointer;\n            }\n\n            /* 透明背景大号Emoji */\n            .acu-map-location-emoji {\n                background: transparent;\n                border: none;\n                width: auto;\n                height: auto;\n                font-size: 4rem;\n                line-height: 1;\n                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));\n                transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            .acu-map-location-emoji:hover { transform: scale(1.1) rotate(5deg); }\n\n            /* FA图标主题色继承 */\n            .acu-map-location-emoji .acu-theme-icon,\n            .acu-map-chip-emoji .acu-theme-icon,\n            .acu-map-thumbnail-emoji .acu-theme-icon {\n                color: var(--acu-accent);\n                font-size: inherit;\n            }\n\n            /* 无emoji时的文字占位 */\n            .acu-map-location-text {\n                width: 64px;\n                height: 64px;\n                border-radius: 12px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 28px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n            }\n\n            /* 地点名 */\n            .acu-map-location-name {\n                margin-top: 8px;\n                font-weight: 700;\n                font-size: 1.1em;\n                max-width: 140px;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                color: var(--acu-text-main);\n            }\n\n            /* 缩略图样式 */\n            .acu-map-thumbnails {\n                display: grid;\n                grid-template-columns: repeat(3, minmax(0, 1fr));\n                gap: 12px;\n                max-height: 50vh;\n                overflow-y: auto;\n                overflow-x: hidden;\n                padding: 12px;\n                box-sizing: border-box;\n            }\n            .acu-map-thumbnail {\n                position: relative;\n                border: 1px solid var(--acu-border);\n                border-radius: 10px;\n                padding: 8px;\n                background: var(--acu-btn-bg);\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 4px;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-map-thumbnail.active {\n                border-color: var(--acu-accent);\n                box-shadow: 0 0 0 1px var(--acu-accent);\n            }\n            .acu-map-thumbnail:hover {\n                border-color: var(--acu-accent);\n                transform: translateY(-2px);\n            }\n            .acu-map-thumbnail-emoji {\n                width: 36px;\n                height: 36px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 24px;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));\n            }\n            .acu-map-thumbnail-placeholder {\n                width: 36px;\n                height: 36px;\n                border-radius: 8px;\n                background: var(--acu-bg-panel);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                border: 1px solid var(--acu-border);\n            }\n            .acu-map-thumbnail-name { font-size: 11px; color: var(--acu-text-main); }\n\n            /* 角标 */\n            .acu-map-thumbnail-badge {\n                position: absolute;\n                top: -8px;\n                right: -8px;\n                min-width: 22px;\n                height: 22px;\n                padding: 0 6px;\n                border-radius: 99px;\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                font-size: 0.75rem;\n                font-weight: 800;\n                font-variant-numeric: tabular-nums;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                box-shadow: 0 3px 6px rgba(0,0,0,0.25);\n                border: 3px solid var(--acu-btn-bg);\n                z-index: 10;\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n\n            .acu-map-thumbnail:hover .acu-map-thumbnail-badge {\n                transform: scale(1.1);\n            }\n\n            /* 地区标签页 */\n            .acu-map-region-tabs {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 4px;\n                margin-left: auto;\n                margin-right: 8px;\n            }\n            .acu-map-region-tab {\n                padding: 4px 10px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-map-region-tab.active,\n            .acu-map-region-tab:hover {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n            }\n\n            .acu-map-empty {\n                text-align: center;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                padding: 8px 0;\n            }\n            .acu-map-loading {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                padding: 40px;\n                width: 100%;\n            }\n            .acu-map-spinner {\n                width: 32px;\n                height: 32px;\n                border: 3px solid var(--acu-border);\n                border-top-color: var(--acu-accent);\n                border-radius: 50%;\n                animation: acu-map-spin 0.8s linear infinite;\n            }\n            @keyframes acu-map-spin { to { transform: rotate(360deg); } }\n            @media (max-width: 768px) {\n                .acu-map-container {\n                    width: 96%;\n                    max-height: 92vh;\n                }\n                .acu-map-focus-area {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 12px;\n                    padding: 16px 12px;\n                    background: var(--acu-btn-bg);\n                }\n                .acu-map-stage-center {\n                    width: 100%;\n                    margin-bottom: 4px;\n                    flex-direction: row;\n                    justify-content: center;\n                    gap: 12px;\n                }\n                .acu-map-location-emoji {\n                    font-size: 2.5rem;\n                    width: 48px;\n                    height: 48px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                }\n                .acu-map-location-text {\n                    width: 48px;\n                    height: 48px;\n                    font-size: 20px;\n                }\n                .acu-map-location-name {\n                    margin-top: 0;\n                    font-size: 1.25rem;\n                    max-width: none;\n                    text-align: left;\n                    align-self: center;\n                }\n                .acu-map-wing {\n                    display: none;\n                }\n                .acu-map-mobile-stack {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 10px;\n                    width: 100%;\n                }\n                .acu-map-mobile-avatars,\n                .acu-map-mobile-elements {\n                    display: flex;\n                    flex-wrap: wrap;\n                    justify-content: center;\n                    gap: 8px;\n                    max-height: 168px;\n                    overflow-y: auto;\n                    padding: 2px 4px;\n                }\n                .acu-map-mobile-avatars:empty,\n                .acu-map-mobile-elements:empty {\n                    display: none;\n                }\n                .acu-map-avatar {\n                    min-width: auto;\n                    width: 52px;\n                }\n                .acu-map-avatar-circle {\n                    width: 42px;\n                    height: 42px;\n                }\n                .acu-map-element-chip {\n                    font-size: 12px;\n                    padding: 6px 10px;\n                    background: var(--acu-bg-panel);\n                }\n                .acu-map-thumbnails {\n                    grid-template-columns: repeat(3, minmax(0, 1fr));\n                    gap: 10px;\n                }\n            }\n\n            /* ========== 头像管理弹窗样式 ========== */\n            .acu-avatar-manager-overlay {\n                background: rgba(0,0,0,0.7);\n                z-index: 31300;\n            }\n            .acu-avatar-manager {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n            }\n            .acu-avatar-title {\n                font-size: 15px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-avatar-header-actions {\n                display: flex;\n                gap: 4px;\n                align-items: center;\n            }\n            .acu-avatar-list {\n                flex: 1;\n                overflow-y: auto;\n                padding: 12px;\n                min-height: 0;\n            }\n            .acu-avatar-file-input,\n            #acu-avatar-file-input {\n                display: none;\n            }\n            .acu-avatar-item {\n                display: flex;\n                flex-direction: column;\n                padding: 10px;\n                border-bottom: 1px dashed var(--acu-border);\n                transition: background-color 0.2s ease;\n            }\n            .acu-avatar-item:last-child { border-bottom: none; }\n            .acu-avatar-item.expanded {\n                background-color: rgba(127, 127, 127, 0.05);\n            }\n\n            /* --- 折叠状态行 --- */\n            .acu-avatar-row-collapsed {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n                width: 100%;\n            }\n\n            /* 头像预览部分 (复用原样式但稍作调整) */\n            .acu-avatar-preview {\n                width: 48px;\n                height: 48px;\n                border-radius: 50%;\n                background: var(--acu-btn-bg);\n                background-size: cover;\n                background-position: center;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                border: 2px solid var(--acu-border);\n                flex-shrink: 0;\n                position: relative;\n                cursor: pointer;\n                transition: border-color 0.2s;\n            }\n            .acu-avatar-preview:hover {\n                border-color: var(--acu-accent);\n            }\n            .acu-avatar-preview.has-image {\n                background-image: var(--acu-avatar-image);\n                background-position: var(--acu-avatar-x, 50%) var(--acu-avatar-y, 50%);\n                background-size: var(--acu-avatar-scale, 150%);\n                background-repeat: no-repeat;\n            }\n            .acu-avatar-preview span {\n                font-size: 18px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-camera-hint {\n                position: absolute;\n                bottom: 2px;\n                right: 2px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                opacity: 0.5;\n                pointer-events: none;\n            }\n            .acu-avatar-preview:hover .acu-avatar-camera-hint {\n                opacity: 0.8;\n                color: var(--acu-accent);\n            }\n\n            /* 角色信息摘要 */\n            .acu-avatar-info-summary {\n                flex: 1;\n                min-width: 0;\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n            }\n            .acu-avatar-name {\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 2px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-avatar-url-preview {\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                max-width: 300px;\n                opacity: 0.8;\n            }\n            /* 操作按钮区 (折叠态) */\n            .acu-avatar-actions-collapsed {\n                display: flex;\n                gap: 6px;\n                flex-shrink: 0;\n            }\n\n            /* --- 展开状态行 --- */\n            .acu-avatar-row-expanded {\n                max-height: 0;\n                overflow: hidden;\n                opacity: 0;\n                transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;\n                margin-top: 0;\n                padding-top: 0;\n            }\n            .acu-avatar-item.expanded .acu-avatar-row-expanded {\n                max-height: 200px; /* 足够容纳输入框 */\n                opacity: 1;\n                margin-top: 10px;\n                padding-top: 4px;\n                border-top: 1px solid var(--acu-border);\n            }\n            \n            .acu-avatar-details {\n                padding-top: 8px;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .acu-protagonist-toggle {\n                background: transparent;\n                border: none;\n                color: var(--acu-text-sub);\n                opacity: 0.5;\n                cursor: pointer;\n                padding: 4px;\n                border-radius: 4px;\n                transition: all 0.2s ease;\n            }\n            .acu-protagonist-toggle:hover {\n                opacity: 0.8;\n                background: var(--acu-bg-hover);\n            }\n            .acu-protagonist-toggle.active {\n                opacity: 1;\n                color: var(--acu-accent);\n            }\n            \n            /* 输入行布局 */\n            .acu-input-group {\n                display: flex;\n                gap: 8px;\n                align-items: flex-start;\n            }\n            .acu-input-group-label {\n                width: 32px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                text-align: right;\n                flex-shrink: 0;\n                line-height: 36px;\n            }\n            \n            /* URL容器 - 与别名容器统一样式 */\n            .acu-url-container {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                padding: 4px 8px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-input-bg);\n                min-height: 36px;\n                box-sizing: border-box;\n                transition: border-color 0.2s ease;\n            }\n            .acu-url-container:focus-within {\n                border-color: var(--acu-accent);\n            }\n            \n            /* URL输入框 - 无边框融入容器 */\n            .acu-avatar-manager-overlay .acu-url-container > input.acu-avatar-url,\n            .acu-avatar-manager-overlay .acu-url-container > input.acu-avatar-url:focus {\n                border: 0 !important;\n                background: transparent !important;\n                padding: 0 !important;\n                font-size: 11px !important;\n                color: var(--acu-text-main) !important;\n                flex: 1;\n                min-width: 0;\n                outline: none !important;\n                box-shadow: none !important;\n                height: 26px !important;\n                line-height: 26px !important;\n                border-radius: 0 !important;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n            }\n            .acu-url-container input::placeholder {\n                color: var(--acu-text-sub);\n                opacity: 0.6;\n            }\n\n            /* 上传按钮美化 */\n            .acu-avatar-upload-trigger {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                padding: 0 12px;\n                height: 28px;\n                margin: 0;\n                box-sizing: border-box;\n                font-size: 12px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-avatar-upload-trigger:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n            }\n\n            /* 底部操作栏 */\n            .acu-avatar-expanded-footer {\n                display: flex;\n                justify-content: flex-end;\n                align-items: center;\n                gap: 8px;\n                margin-top: 4px;\n            }\n\n            .acu-btn-action {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-sub) !important;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-btn-action:hover {\n                background: var(--acu-btn-hover) !important;\n                color: var(--acu-accent) !important;\n            }\n            \n            /* 保存按钮 - 完全匹配本地上传按钮样式 */\n            .acu-btn-save { \n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                padding: 0 12px !important;\n                height: 28px !important;\n                font-size: 12px !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-main) !important;\n                cursor: pointer;\n                transition: all 0.2s;\n                white-space: nowrap;\n                width: auto !important;\n            }\n            .acu-btn-save:hover {\n                background: var(--acu-btn-hover) !important;\n                border-color: var(--acu-accent) !important;\n                color: var(--acu-accent) !important;\n            }\n            \n            .acu-btn-delete:hover { color: var(--acu-error-text, #e74c3c) !important; border-color: var(--acu-error-text, #e74c3c) !important; }\n\n            /* 头像来源标签 */\n            .acu-avatar-source {\n                position: absolute;\n                bottom: -10px;\n                left: 50%;\n                transform: translateX(-50%);\n                font-size: 9px;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-weight: bold;\n                white-space: nowrap;\n            }\n            .acu-avatar-preview-wrap {\n                position: relative;\n                flex-shrink: 0;\n            }\n            .acu-source-local,\n            .acu-source-url,\n            .acu-source-auto {\n                background: var(--acu-badge-bg);\n                color: var(--acu-text-sub);\n            }\n            \n            /* Tag Input Container - 与URL容器和搜索框统一样式 */\n            .acu-alias-tags-container {\n                flex: 1;\n                display: flex;\n                flex-wrap: wrap;\n                gap: 6px;\n                padding: 4px 8px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-input-bg);\n                min-height: 36px;\n                cursor: text;\n                box-sizing: border-box;\n                align-items: center;\n                transition: border-color 0.2s ease;\n            }\n            .acu-alias-tags-container:focus-within {\n                border-color: var(--acu-accent);\n            }\n\n            /* Tag Item - 透明边框风格，与URL输入统一 */\n            .acu-alias-tag {\n                display: inline-flex;\n                align-items: center;\n                gap: 4px;\n                padding: 2px 8px;\n                background: transparent;\n                color: var(--acu-text-main);\n                border-radius: 4px;\n                font-size: 11px;\n                line-height: 1.4;\n                border: 1px solid var(--acu-border);\n                user-select: none;\n                transition: all 0.2s ease;\n                max-width: 100%;\n                animation: acu-slide-in 0.2s cubic-bezier(0.2, 0, 0.2, 1) forwards;\n            }\n            .acu-alias-tag:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n            }\n\n            /* Tag Delete Icon - 简洁风格 */\n            .acu-alias-tag i {\n                cursor: pointer;\n                opacity: 0.4;\n                font-size: 10px;\n                width: 14px;\n                height: 14px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                border-radius: 50%;\n                transition: all 0.2s;\n                margin-right: -2px;\n            }\n            .acu-alias-tag i:hover {\n                opacity: 1;\n                color: var(--acu-error-text, #e74c3c);\n            }\n\n            /* 别名输入框 - 无边框无背景，融入容器 */\n            .acu-avatar-manager-overlay .acu-alias-tags-container > input.acu-alias-input,\n            .acu-avatar-manager-overlay .acu-alias-tags-container > input.acu-alias-input:focus {\n                border: 0 !important;\n                background: transparent !important;\n                padding: 0 !important;\n                margin: 2px 0;\n                font-size: 12px !important;\n                color: var(--acu-text-main) !important;\n                flex: 1;\n                min-width: 80px;\n                outline: none !important;\n                box-shadow: none !important;\n                height: 24px;\n                line-height: 24px;\n                border-radius: 0 !important;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n            }\n            .acu-alias-input::placeholder {\n                color: var(--acu-text-sub);\n                opacity: 0.6;\n            }\n\n            /* Animation - 进场动画 */\n            @keyframes acu-slide-in {\n                from { opacity: 0; transform: scale(0.95) translateY(2px); }\n                to { opacity: 1; transform: scale(1) translateY(0); }\n            }\n\n            /* Mobile Optimization - 触控友好适配 */\n            @media (hover: none) and (pointer: coarse) {\n                .acu-alias-tags-container {\n                    padding: 6px 8px;\n                    gap: 6px;\n                    min-height: 40px;\n                }\n                .acu-alias-tag {\n                    padding: 4px 10px;\n                    font-size: 12px;\n                    border-radius: 4px;\n                }\n                .acu-alias-tag i {\n                    width: 18px;\n                    height: 18px;\n                    font-size: 11px;\n                    margin-right: -4px;\n                }\n                .acu-alias-input {\n                    height: 28px;\n                    font-size: 12px;\n                }\n            }\n\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 12px;\n                transition: all 0.2s;\n            }\n            .acu-avatar-import-btn:hover,\n            .acu-avatar-export-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-avatar-crop-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-top: 6px;\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-crop-row.hidden { display: none; }\n            .acu-avatar-manager-overlay .acu-avatar-scale {\n                flex: 1;\n                height: 6px !important;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n                margin: 0 8px;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-runnable-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer !important;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;\n                margin-top: -5px !important;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-thumb {\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                border: 2px solid var(--acu-bg-panel);\n                cursor: pointer !important;\n            }\n            @media (max-width: 768px) {\n                .acu-avatar-manager {\n                    width: 95%;\n                    max-height: 85vh;\n                }\n            }\n\n            /* ========== 头像管理器视图切换与排序 ========== */\n/* ========== 头像管理器工具栏 v3 ========== */\n\n            /* 标题栏操作按钮区域 */\n            .acu-avatar-header-actions {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n\n            /* 标题栏中的按钮统一样式 */\n            .acu-avatar-header-actions .acu-btn-icon {\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                background-color: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                color: var(--acu-text-sub);\n                transition: all 0.2s ease;\n                flex-shrink: 0;\n            }\n\n            .acu-avatar-header-actions .acu-btn-icon:hover {\n                background-color: var(--acu-btn-hover);\n                color: var(--acu-text-main);\n            }\n\n            /* 关闭按钮与其他按钮对齐 */\n            .acu-avatar-header-actions .acu-avatar-close {\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                background-color: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                color: var(--acu-text-sub);\n                transition: all 0.2s ease;\n                flex-shrink: 0;\n            }\n\n            .acu-avatar-header-actions .acu-avatar-close:hover {\n                background-color: var(--acu-btn-hover);\n                color: var(--acu-text-main);\n            }\n\n            /* 工具栏中的搜索框 */\n            .acu-toolbar-group .acu-search-wrapper {\n                position: relative;\n                display: flex;\n                align-items: center;\n                width: 100px;\n                transition: width 0.2s ease;\n                flex-shrink: 0;\n            }\n\n            .acu-toolbar-group .acu-search-wrapper:focus-within {\n                width: 140px;\n            }\n\n            .acu-toolbar-group .acu-search-icon {\n                position: absolute;\n                left: 8px;\n                color: var(--acu-text-sub);\n                pointer-events: none;\n                font-size: 11px;\n                z-index: 1;\n            }\n\n            .acu-toolbar-group .acu-avatar-search {\n                width: 100%;\n                height: 32px !important;\n                min-height: 32px !important;\n                max-height: 32px !important;\n                padding: 0 24px 0 26px !important;\n                margin: 0 !important;\n                background: var(--acu-input-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 11px !important;\n                box-shadow: none !important;\n                outline: none !important;\n                box-sizing: border-box !important;\n                line-height: 30px !important;\n            }\n\n            .acu-toolbar-group .acu-avatar-search:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n                box-shadow: none !important;\n            }\n\n            .acu-toolbar-group .acu-avatar-search::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7;\n            }\n\n            .acu-toolbar-group .acu-search-clear {\n                position: absolute;\n                right: 6px;\n                cursor: pointer;\n                color: var(--acu-text-sub);\n                font-size: 10px;\n            }\n\n            .acu-toolbar-group .acu-search-clear:hover {\n                color: var(--acu-text-main);\n            }\n\n            /* 旧样式保留以防兼容问题 */\n            .acu-avatar-header-actions .acu-search-wrapper {\n                position: relative;\n                display: flex;\n                align-items: center;\n                width: 100px;\n                transition: width 0.2s ease;\n            }\n\n            .acu-avatar-header-actions .acu-search-wrapper:focus-within {\n                width: 140px;\n            }\n\n            .acu-avatar-header-actions .acu-search-icon {\n                position: absolute;\n                left: 8px;\n                color: var(--acu-text-sub);\n                pointer-events: none;\n                font-size: 11px;\n            }\n\n            .acu-avatar-header-actions .acu-avatar-search {\n                width: 100%;\n                height: 28px;\n                padding: 0 24px 0 26px !important;\n                background: var(--acu-input-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 11px !important;\n                box-shadow: none !important;\n                outline: none !important;\n            }\n\n            .acu-avatar-header-actions .acu-avatar-search:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n                box-shadow: none !important;\n            }\n\n            .acu-avatar-header-actions .acu-avatar-search::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7;\n            }\n\n            .acu-avatar-header-actions .acu-search-clear {\n                position: absolute;\n                right: 6px;\n                cursor: pointer;\n                color: var(--acu-text-sub);\n                font-size: 10px;\n            }\n\n            .acu-avatar-header-actions .acu-search-clear:hover {\n                color: var(--acu-text-main);\n            }\n\n            /* 工具栏 */\n            .acu-avatar-toolbar {\n                display: flex;\n                flex-wrap: nowrap;\n                gap: 8px;\n                padding: 8px 12px;\n                background-color: var(--acu-bg-panel);\n                border-bottom: 1px solid var(--acu-border);\n                align-items: center;\n                justify-content: space-between;\n            }\n\n            .acu-toolbar-group {\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n\n            .acu-toolbar-group.left {\n                flex-shrink: 0;\n            }\n\n            .acu-toolbar-group.right {\n                flex-shrink: 0;\n            }\n\n            /* 图标按钮 */\n            .acu-avatar-manager-overlay .acu-btn-icon {\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                background-color: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                color: var(--acu-text-sub);\n                transition: all 0.2s ease;\n                flex-shrink: 0;\n            }\n\n            .acu-avatar-manager-overlay .acu-btn-icon:hover {\n                background-color: var(--acu-btn-hover);\n                color: var(--acu-text-main);\n            }\n\n            .acu-avatar-manager-overlay .acu-btn-icon.active {\n                background-color: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n            }\n\n            /* 下拉框 */\n            .acu-select-wrapper {\n                position: relative;\n                display: flex;\n                align-items: center;\n            }\n\n            .acu-avatar-manager-overlay .acu-toolbar-select {\n                height: 32px !important;\n                min-height: 32px !important;\n                max-height: 32px !important;\n                padding: 0 24px 0 8px !important;\n                margin: 0 !important;\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 11px !important;\n                cursor: pointer;\n                appearance: none !important;\n                -webkit-appearance: none !important;\n                -moz-appearance: none !important;\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cpath fill='%23888' d='M0 2l4 4 4-4z'/%3E%3C/svg%3E") !important;\n                background-repeat: no-repeat !important;\n                background-position: right 8px center !important;\n                box-shadow: none !important;\n                outline: none !important;\n                box-sizing: border-box !important;\n                line-height: 30px !important;\n            }\n\n            .acu-avatar-manager-overlay .acu-toolbar-select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n\n            .acu-avatar-manager-overlay .acu-toolbar-select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n                box-shadow: none !important;\n            }\n\n            .acu-select-wrapper.sort-field .acu-toolbar-select {\n                min-width: 60px;\n            }\n\n            /* 移动端响应式 - 搜索框更紧凑 */\n            @media (max-width: 500px) {\n                .acu-avatar-header-actions .acu-search-wrapper {\n                    width: 80px;\n                }\n                .acu-avatar-header-actions .acu-search-wrapper:focus-within {\n                    width: 100px;\n                }\n            }\n\n            /* ========== 删除确认弹窗样式 ========== */\n            .acu-delete-confirm-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                width: 100vw;\n                height: 100vh;\n                background: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 31500;\n                backdrop-filter: blur(4px);\n                padding: 16px;\n                box-sizing: border-box;\n            }\n\n            .acu-delete-confirm-modal {\n                width: 90%;\n                max-width: 420px;\n                max-height: calc(100vh - 32px);\n                max-height: calc(100dvh - 32px);\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n                overflow: hidden;\n                animation: acu-modal-pop 0.2s ease-out;\n                display: flex;\n                flex-direction: column;\n            }\n\n            @keyframes acu-modal-pop {\n                from {\n                    opacity: 0;\n                    transform: scale(0.9);\n                }\n                to {\n                    opacity: 1;\n                    transform: scale(1);\n                }\n            }\n\n            .acu-delete-header {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                color: var(--acu-accent);\n                font-size: 14px;\n                font-weight: bold;\n                flex-shrink: 0;\n            }\n\n            .acu-delete-header i {\n                font-size: 16px;\n            }\n\n            .acu-delete-content {\n                padding: 20px;\n                flex: 1;\n                min-height: 0;\n                overflow-y: auto;\n            }\n\n            .acu-delete-character-info {\n                display: flex;\n                align-items: center;\n                gap: 14px;\n                padding: 12px;\n                background: var(--acu-table-head);\n                border-radius: 8px;\n                margin-bottom: 16px;\n            }\n\n            .acu-delete-avatar {\n                width: 50px;\n                height: 50px;\n                border-radius: 50%;\n                background: var(--acu-btn-bg);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 20px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                overflow: hidden;\n                flex-shrink: 0;\n            }\n\n            .acu-delete-avatar.has-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .acu-delete-name {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n\n            .acu-delete-section-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                margin-bottom: 8px;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            }\n\n            .acu-delete-section-title i {\n                font-size: 11px;\n            }\n\n            .acu-delete-table-preview {\n                margin-bottom: 16px;\n            }\n\n            .acu-delete-table-row {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 8px;\n                padding: 10px;\n                background: var(--acu-btn-bg);\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n            }\n\n            .acu-delete-cell {\n                font-size: 12px;\n                color: var(--acu-text-sub);\n            }\n\n            .acu-delete-cell strong {\n                color: var(--acu-text-main);\n            }\n\n            .acu-delete-relationships {\n                margin-bottom: 16px;\n            }\n\n            .acu-delete-ref-list {\n                list-style: none;\n                padding: 0;\n                margin: 0;\n                background: var(--acu-btn-bg);\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                padding: 8px 12px;\n            }\n\n            .acu-delete-ref-list li {\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                padding: 4px 0;\n                border-bottom: 1px solid var(--acu-border);\n            }\n\n            .acu-delete-ref-list li:last-child {\n                border-bottom: none;\n            }\n\n            .acu-delete-ref-list li strong {\n                color: var(--acu-text-main);\n            }\n\n            .acu-delete-warning {\n                display: flex;\n                align-items: flex-start;\n                gap: 10px;\n                padding: 12px;\n                background: var(--acu-warning-bg, rgba(243, 156, 18, 0.15));\n                border: 1px solid var(--acu-warning-text, #f39c12);\n                border-radius: 8px;\n                font-size: 12px;\n                color: var(--acu-warning-text, #f39c12);\n            }\n\n            .acu-delete-warning i {\n                font-size: 14px;\n                flex-shrink: 0;\n                margin-top: 1px;\n            }\n\n            .acu-delete-actions {\n                display: flex;\n                justify-content: flex-end;\n                gap: 10px;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-top: 1px solid var(--acu-border);\n                flex-shrink: 0;\n            }\n\n            .acu-delete-cancel-btn,\n            .acu-delete-confirm-btn {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s ease;\n            }\n\n            .acu-delete-cancel-btn {\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-text-sub);\n                color: var(--acu-text-sub);\n            }\n\n            .acu-delete-cancel-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-text-main);\n            }\n\n            .acu-delete-confirm-btn {\n                background: var(--acu-accent);\n                border: none;\n                color: var(--acu-button-text-on-accent, #fff);\n            }\n\n            .acu-delete-confirm-btn:hover {\n                filter: brightness(1.1);\n                transform: translateY(-1px);\n                color: var(--acu-button-text-on-accent, #fff);\n            }\n\n            /* ========== [Redesign] 删除确认弹窗新样式 ========== */\n            .acu-delete-confirm-modal.redesign {\n                width: 400px;\n                max-width: 95vw;\n                border-radius: 12px;\n                overflow: hidden;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-bg-panel);\n                box-shadow: 0 24px 48px rgba(0,0,0,0.6);\n\n                /* 语义化变量映射：使用主题变量 */\n                --c-destruct: var(--acu-error-text, #e74c3c);\n                --c-destruct-bg: var(--acu-error-bg, rgba(231, 76, 60, 0.15));\n                --c-warning: var(--acu-hl-manual, #e67e22);\n                --c-warning-bg: var(--acu-hl-manual-bg, rgba(230, 126, 34, 0.15));\n                --c-caution: var(--acu-warning-text, #f1c40f);\n                --c-caution-bg: var(--acu-warning-bg, rgba(241, 196, 15, 0.15));\n            }\n\n            /* 头部 - destruct 样式 */\n            .acu-delete-header.destruct {\n                background: var(--c-destruct-bg);\n                color: var(--c-destruct);\n                border-bottom: 1px solid var(--c-destruct-bg);\n                font-size: 15px;\n                padding: 16px 20px;\n                position: relative;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            /* 关闭按钮 (×) */\n            .acu-delete-close-btn {\n                position: absolute;\n                right: 12px;\n                top: 50%;\n                transform: translateY(-50%);\n                width: 28px;\n                height: 28px;\n                border: none;\n                background: transparent;\n                color: var(--c-destruct);\n                font-size: 16px;\n                cursor: pointer;\n                border-radius: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n                opacity: 0.7;\n            }\n\n            .acu-delete-close-btn:hover {\n                opacity: 1;\n                background: var(--c-destruct-bg);\n            }\n\n            /* 分区卡片通用 */\n            .acu-del-section {\n                border-radius: 8px;\n                border: 1px solid var(--acu-border);\n                overflow: hidden;\n            }\n\n            .acu-del-section-head {\n                padding: 8px 12px;\n                font-size: 12px;\n                font-weight: bold;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                color: var(--acu-text-sub);\n            }\n\n            /* 状态色修饰 */\n            .acu-del-section.destruct { border-color: var(--c-destruct-bg); }\n            .acu-del-section.destruct .acu-del-section-head {\n                color: var(--c-destruct);\n                background: var(--c-destruct-bg);\n                border-bottom-color: var(--c-destruct-bg);\n            }\n\n            .acu-del-section.warning { border-color: var(--c-warning-bg); }\n            .acu-del-section.warning .acu-del-section-head {\n                color: var(--c-warning);\n                background: var(--c-warning-bg);\n                border-bottom-color: var(--c-warning-bg);\n            }\n\n            .acu-del-section.caution { border-color: var(--c-caution-bg); }\n            .acu-del-section.caution .acu-del-section-head {\n                color: var(--c-caution);\n                background: var(--c-caution-bg);\n                border-bottom-color: var(--c-caution-bg);\n            }\n\n            /* 核心身份卡片 */\n            .acu-del-card {\n                padding: 12px;\n                display: flex;\n                align-items: center;\n                gap: 12px;\n                background: var(--acu-btn-bg);\n            }\n\n            .acu-del-avatar-box {\n                width: 56px;\n                height: 56px;\n                border-radius: 50%;\n                border: 2px solid var(--c-destruct);\n                overflow: hidden;\n                flex-shrink: 0;\n                background: var(--acu-bg-panel);\n            }\n\n            .acu-del-avatar-box .acu-avatar-preview {\n                width: 100%;\n                height: 100%;\n                border: none;\n                border-radius: 0;\n            }\n\n            .acu-del-name {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n\n            .acu-del-meta {\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                margin-top: 2px;\n            }\n\n            .acu-del-info {\n                flex: 1;\n                min-width: 0;\n            }\n\n            /* 列表样式 */\n            .acu-del-list {\n                list-style: none;\n                padding: 0;\n                margin: 0;\n                background: var(--acu-btn-bg);\n            }\n\n            .acu-del-list li {\n                padding: 8px 12px;\n                font-size: 13px;\n                color: var(--acu-text-main);\n                border-bottom: 1px solid var(--acu-border);\n                display: flex;\n                align-items: flex-start;\n                gap: 10px;\n            }\n\n            .acu-del-list li:last-child { border-bottom: none; }\n\n            .acu-del-list li i {\n                margin-top: 3px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                width: 16px;\n                text-align: center;\n            }\n\n            .acu-del-list li strong { color: var(--acu-accent); }\n\n            /* 别名子分组 */\n            .acu-del-list li.sub-group {\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .acu-del-list .group-title {\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n\n            .acu-del-list .group-content {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 4px;\n            }\n\n            .acu-del-list .tag {\n                font-size: 11px;\n                padding: 2px 6px;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                color: var(--acu-text-sub);\n            }\n\n            .acu-del-list .group-warning {\n                font-size: 12px;\n                color: var(--c-warning);\n                margin-top: 4px;\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n\n            .acu-del-list .group-warning .detail {\n                opacity: 0.8;\n                font-size: 11px;\n            }\n\n            /* 引用摘要 */\n            .acu-del-summary {\n                padding: 8px 12px;\n                font-size: 12px;\n                color: var(--acu-text-main);\n                background: var(--acu-btn-bg);\n                border-bottom: 1px solid var(--acu-border);\n            }\n\n            .acu-del-list.compact li {\n                padding: 6px 12px;\n                font-size: 12px;\n            }\n\n            .acu-del-list.compact li.more {\n                color: var(--acu-text-sub);\n                font-style: italic;\n                padding-left: 38px;\n            }\n\n            /* 关系标签 */\n            .acu-del-list .relation-tag {\n                display: inline-block;\n                font-size: 10px;\n                padding: 1px 6px;\n                background: var(--c-warning-bg);\n                color: var(--c-warning);\n                border-radius: 3px;\n                margin-left: 4px;\n                font-weight: normal;\n            }\n\n            /* 最终警告 */\n            .acu-del-final-warn {\n                font-size: 13px;\n                color: var(--acu-text-sub);\n                text-align: center;\n                margin-top: 4px;\n            }\n\n            .acu-del-final-warn strong {\n                color: var(--c-destruct);\n            }\n\n            /* 按钮 - destruct 样式 */\n            .acu-delete-confirm-btn.destruct {\n                background: var(--c-destruct);\n                color: var(--acu-btn-active-text, #fff);\n                border: 1px solid transparent;\n            }\n\n            .acu-delete-confirm-btn.destruct:hover {\n                filter: brightness(0.9);\n            }\n\n            .acu-delete-confirm-btn.destruct:disabled {\n                opacity: 0.7;\n                cursor: not-allowed;\n                filter: grayscale(0.5);\n            }\n\n            /* 退出动画 */\n            .acu-delete-confirm-overlay.closing .acu-delete-confirm-modal {\n                transform: scale(0.9);\n                opacity: 0;\n                transition: all 0.2s ease-in;\n            }\n\n            /* ========== 导入确认弹窗样式 ========== */\n            .acu-import-confirm-overlay {\n                z-index: 31400;\n            }\n            .acu-import-confirm-dialog {\n                width: 90%;\n                max-width: 360px;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n                overflow: hidden;\n            }\n            .acu-import-confirm-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                gap: 10px;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-import-confirm-header i {\n                font-size: 16px;\n            }\n            .acu-import-confirm-body {\n                padding: 20px;\n            }\n            .acu-import-stats {\n                display: flex;\n                justify-content: space-around;\n                margin-bottom: 16px;\n            }\n            .acu-import-stat {\n                text-align: center;\n            }\n            .acu-stat-num {\n                display: block;\n                font-size: 24px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-stat-label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-stat-new .acu-stat-num { color: var(--acu-success-text); }\n            .acu-stat-conflict .acu-stat-num { color: var(--acu-hl-manual); }\n            .acu-import-conflict-section {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-import-cancel-btn,\n            .acu-import-confirm-btn {\n                flex: 1;\n                padding: 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: bold;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-import-cancel-btn {\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid var(--acu-text-sub) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-import-cancel-btn:hover {\n                background: var(--acu-btn-hover) !important;\n            }\n            .acu-import-confirm-btn {\n                background: var(--acu-accent) !important;\n                border: none !important;\n                color: var(--acu-btn-active-text) !important;\n            }\n            .acu-import-confirm-btn:hover {\n                opacity: 0.85 !important;\n                background: var(--acu-accent) !important;\n            }\n            /* ========== 预设导入警告样式 ========== */\n            .acu-import-warning-container {\n                text-align: center;\n                padding: 16px 12px 20px;\n                color: var(--acu-text-main);\n            }\n            .acu-import-warning-icon {\n                display: block;\n                width: 48px;\n                height: 48px;\n                margin: 0 auto 12px;\n                line-height: 48px;\n                border-radius: 50%;\n                background: rgba(243, 156, 18, 0.15);\n                color: var(--acu-warning-icon, #f39c12);\n                font-size: 22px;\n            }\n            .acu-import-warning-title {\n                font-size: 15px;\n                font-weight: bold;\n                margin-bottom: 8px;\n                color: var(--acu-text-main);\n            }\n            .acu-import-warning-message {\n                font-size: 13px;\n                color: var(--acu-text-sub);\n                line-height: 1.5;\n            }\n            .acu-import-conflict-options {\n                margin-top: 16px;\n                padding-top: 16px;\n                border-top: 1px dashed var(--acu-border);\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n            .acu-import-radio {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 10px 12px;\n                border-radius: 8px;\n                cursor: pointer;\n                font-size: 13px;\n                color: var(--acu-text-main) !important;\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid transparent !important;\n                transition: all 0.2s ease;\n            }\n            .acu-import-radio:hover {\n                border-color: var(--acu-border) !important;\n                background: var(--acu-btn-hover) !important;\n            }\n            .acu-import-radio input {\n                accent-color: var(--acu-accent);\n                width: 16px;\n                height: 16px;\n            }\n            .acu-import-confirm-footer {\n                display: flex;\n                gap: 12px;\n                padding: 16px 20px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            /* ========== 头像导入/导出相关样式 ========== */\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n            }\n\n            /* ========== 统一骰子设置面板样式 ========== */\n            .acu-dice-config-dialog {\n                width: 320px;\n                max-width: 92vw;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 15px 40px rgba(0,0,0,0.4);\n                overflow: hidden;\n            }\n            .acu-dice-cfg-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 14px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-dice-cfg-header .acu-config-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                font-size: 14px;\n                padding: 4px;\n            }\n            .acu-dice-cfg-header .acu-config-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-body {\n                padding: 12px;\n            }\n            .acu-dice-cfg-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n            .acu-dice-cfg-row.acu-cfg-full-row {\n                grid-template-columns: 1fr;\n            }\n            .acu-dice-cfg-item {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n            .acu-dice-cfg-item label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: 500;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item {\n                flex-direction: row;\n                align-items: center;\n                justify-content: space-between;\n                padding: 8px 0;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item > label {\n                margin: 0;\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input,\n            .acu-dice-cfg-item select {\n                width: 100%;\n                padding: 7px 8px;\n                background: var(--acu-input-bg) !important;\n                border: 1px solid var(--acu-border);\n                border-radius: 5px;\n                color: var(--acu-text-main) !important;\n                font-size: 13px;\n                text-align: center;\n                box-sizing: border-box;\n            }\n            .acu-dice-cfg-item input::placeholder {\n                color: var(--acu-text-sub);\n                opacity: 0.6;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item select {\n                text-align: left;\n                cursor: pointer;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input:focus,\n            .acu-dice-cfg-item select:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .acu-cfg-hint {\n                font-size: 9px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n                text-align: center;\n            }\n            .acu-dice-cfg-actions {\n                display: flex;\n                gap: 8px;\n                margin-top: 12px;\n                padding: 10px 12px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-dice-cfg-actions button {\n                flex: 1;\n                padding: 9px 12px;\n                border-radius: 6px;\n                font-size: 12px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid var(--acu-text-sub);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-actions button:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-dice-cfg-actions button.primary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-btn-bg);\n                color: var(--acu-button-text);\n            }\n            .acu-dice-cfg-actions button.primary:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-btn-hover);\n            }\n            /* ========== 新版设置面板样式 ========== */\n            .acu-settings-dialog {\n                width: 380px;\n                max-width: 380px;\n                max-height: 85vh;\n                padding: 0;\n                gap: 0;\n            }\n            @media (max-width: 768px) {\n                .acu-settings-dialog {\n                    width: 92vw;\n                    max-width: 92vw;\n                    max-height: 85vh;\n                }\n                .acu-settings-body {\n                    max-height: calc(85vh - 110px);\n                    -webkit-overflow-scrolling: touch;\n                }\n                .acu-table-manager-list {\n                    max-height: 40vh;\n                    -webkit-overflow-scrolling: touch;\n                }\n            }\n            .acu-settings-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 14px 16px;\n                border-bottom: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-settings-title-group {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n            }\n            .acu-settings-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-header-actions {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-version-badge {\n                display: inline-flex;\n                align-items: center;\n                line-height: 1.2;\n                white-space: nowrap;\n                letter-spacing: 0.5px;\n                background: var(--acu-badge-bg, rgba(0, 0, 0, 0.05));\n                color: var(--acu-text-sub);\n                border-radius: 4px;\n                padding: 2px 6px;\n                font-size: 10px;\n                font-weight: normal;\n                margin-left: 6px;\n                opacity: 0.8;\n            }\n            .acu-help-btn {\n                background: none !important;\n                border: none !important;\n                box-shadow: none !important;\n                outline: none !important;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                font-size: 16px;\n                padding: 6px;\n                margin: 0;\n                border-radius: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-help-btn:hover {\n                color: var(--acu-text-main);\n                background: var(--acu-table-hover) !important;\n            }\n            /* 手动更新按钮 - 纯图标，透明背景，与版本号大小一致 */\n            .acu-manual-update-btn {\n                display: inline-flex;\n                align-items: center;\n                justify-content: center;\n                background: transparent;\n                color: var(--acu-text-sub);\n                border: none;\n                padding: 0;\n                margin-left: 6px;\n                font-size: 11px;\n                opacity: 0.6;\n                cursor: pointer;\n                transition: all 0.2s;\n                vertical-align: middle;\n                line-height: 1;\n            }\n            .acu-manual-update-btn:hover {\n                opacity: 1;\n                color: var(--acu-accent, #3b82f6);\n                background: transparent;\n            }\n            /* 手动更新确认弹窗样式 */\n            .acu-manual-update-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                width: 100vw;\n                height: 100vh;\n                background: rgba(0, 0, 0, 0.6);\n                z-index: 31400;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                padding: 16px;\n                box-sizing: border-box;\n            }\n            .acu-manual-update-dialog {\n                background: var(--acu-panel-bg, #ffffff);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 100%;\n                max-width: 360px;\n                max-height: calc(100vh - 32px);\n                max-height: calc(100dvh - 32px);\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n                overflow: hidden;\n                position: relative;\n                z-index: 1;\n                display: flex;\n                flex-direction: column;\n            }\n            .acu-manual-update-header {\n                padding: 14px 16px;\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                flex-shrink: 0;\n            }\n            .acu-manual-update-body {\n                padding: 16px;\n                color: var(--acu-text-main) !important;\n                font-size: 13px;\n                line-height: 1.6;\n                flex: 1;\n                min-height: 0;\n                overflow-y: auto;\n                overscroll-behavior: contain;\n                -webkit-overflow-scrolling: touch;\n            }\n            .acu-manual-update-body p {\n                margin: 0 0 12px 0;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-manual-update-safe-box {\n                background: var(--acu-card-bg, rgba(34, 197, 94, 0.1));\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                padding: 10px 12px;\n                display: flex;\n                align-items: flex-start;\n                gap: 8px;\n            }\n            .acu-manual-update-safe-box i {\n                color: var(--acu-accent, #22c55e);\n                margin-top: 2px;\n            }\n            .acu-manual-update-safe-box .safe-text {\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                line-height: 1.5;\n            }\n            .acu-manual-update-safe-box .safe-text strong {\n                color: var(--acu-text-main);\n                display: block;\n                margin-bottom: 2px;\n            }\n            .acu-manual-update-footer {\n                padding: 12px 16px;\n                display: flex;\n                justify-content: flex-end;\n                gap: 8px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n                flex-shrink: 0;\n            }\n            .acu-manual-update-cancel-btn,\n            .acu-manual-update-confirm-btn {\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s;\n                border: none;\n            }\n            .acu-manual-update-cancel-btn {\n                background: var(--acu-card-bg);\n                color: var(--acu-text-sub);\n                border: 1px solid var(--acu-text-sub);\n            }\n            .acu-manual-update-cancel-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-text-main);\n            }\n            .acu-manual-update-confirm-btn {\n                background: var(--acu-accent, #3b82f6);\n                color: #fff;\n            }\n            .acu-manual-update-confirm-btn:hover {\n                filter: brightness(1.1);\n            }\n            .acu-manual-update-confirm-btn:disabled {\n                opacity: 0.7;\n                cursor: not-allowed;\n            }\n            .acu-settings-body {\n                flex: 1;\n                min-height: 0;\n                overflow-y: auto;\n                overflow-x: hidden;\n                padding: 8px;\n                -webkit-overflow-scrolling: touch;\n            }\n            .acu-settings-group {\n                background: var(--acu-card-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 8px;\n                overflow: hidden;\n            }\n            .acu-settings-group-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 12px 14px;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: var(--acu-table-head);\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.15s;\n            }\n            .acu-settings-group-title:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-group-chevron {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                width: 12px;\n                transition: transform 0.2s;\n            }\n            .acu-settings-group-body {\n                padding: 4px 12px 8px;\n            }\n            .acu-settings-group.collapsed .acu-settings-group-body {\n                display: none;\n            }\n            .acu-settings-group-body.acu-animating {\n                display: block !important;\n                overflow: hidden;\n            }\n            .acu-settings-group:last-child {\n                margin-bottom: 0;\n            }\n            .acu-setting-row {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 0;\n                border-bottom: 1px dashed var(--acu-border);\n                gap: 12px;\n                min-height: 44px;\n            }\n            .acu-setting-row:last-child {\n                border-bottom: none;\n            }\n            .acu-setting-row-slider {\n                flex-direction: column;\n                align-items: stretch;\n            }\n            .acu-setting-info {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-setting-label {\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-setting-hint {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-setting-value {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                margin-left: auto;\n            }\n            .acu-setting-select {\n                padding: 6px 10px;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px;\n                min-width: 120px;\n                cursor: pointer;\n                -webkit-appearance: none;\n                appearance: none;\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L2 4h8z'/%3E%3C/svg%3E");\n                background-repeat: no-repeat;\n                background-position: right 8px center;\n                padding-right: 28px;\n            }\n            .acu-setting-select:focus {\n                outline: none;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-setting-select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-select-short {\n                min-width: 80px;\n            }\n            .acu-setting-slider {\n                width: 100%;\n                height: 6px;\n                margin-top: 8px;\n                -webkit-appearance: none;\n                appearance: none;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n            }\n            .acu-setting-slider::-webkit-slider-runnable-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n            }\n            .acu-setting-slider::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n                margin-top: -6px;\n            }\n            .acu-setting-slider::-moz-range-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-setting-slider::-moz-range-thumb {\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n            }\n            .acu-setting-slider:focus {\n                outline: none;\n            }\n            .acu-setting-mini-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 11px;\n                flex-shrink: 0;\n                transition: all 0.15s;\n            }\n            .acu-setting-mini-btn:hover, .acu-setting-mini-btn.active {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n            }\n\n            /* ========== 属性预设管理面板样式 ========== */\n            .acu-preset-item {\n                display: grid;\n                grid-template-columns: 32px minmax(0, 1fr) auto 28px;\n                column-gap: 12px;\n                align-items: center;\n                padding: 10px 12px;\n                background: var(--acu-card-bg);\n                border: 1px solid rgba(var(--acu-accent-rgb, 128, 128, 128), 0.15);\n                border-radius: 12px;\n                margin-bottom: 10px;\n                transition: all 0.14s ease-out;\n                position: relative;\n            }\n            /* 简化布局：仅有 info + actions 两列的面板 */\n            #acu-presets-list .acu-preset-item,\n            #acu-action-presets-list .acu-preset-item {\n                display: flex;\n                gap: 12px;\n            }\n            #acu-presets-list .acu-preset-info,\n            #acu-action-presets-list .acu-preset-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-preset-item.acu-preset-hidden {\n                opacity: 0.6;\n                border-color: var(--acu-border);\n            }\n            .acu-preset-item:hover {\n                background: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.04);\n                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n                border-color: var(--acu-accent);\n                transform: translateY(-1px);\n                z-index: 1;\n            }\n            .acu-preset-check {\n                width: 30px;\n                height: 30px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                border-radius: 10px;\n                color: var(--acu-accent);\n                transition: all 0.14s;\n            }\n            .acu-preset-check:hover {\n                background: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.1);\n            }\n            .acu-preset-item.acu-preset-hidden .acu-preset-check {\n                color: var(--acu-text-sub);\n                opacity: 0.5;\n            }\n            .acu-preset-info {\n                min-width: 0;\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n            }\n            .acu-preset-name {\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 2px;\n                letter-spacing: 0.2px;\n                line-height: 1.15;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-preset-desc {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-bottom: 2px;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                opacity: 0.8;\n            }\n            .acu-preset-stats {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-preset-actions {\n                display: flex;\n                gap: 6px;\n                flex-shrink: 0;\n                align-items: center;\n            }\n            .acu-preset-btn {\n                width: 30px;\n                height: 30px;\n                border: 1px solid transparent;\n                border-radius: 10px;\n                background: transparent;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 13px;\n                transition: all 0.14s;\n                opacity: 0.7;\n            }\n            .acu-preset-btn:hover {\n                background: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.1);\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-preset-btn:active {\n                transform: translateY(1px);\n            }\n            .acu-preset-btn:focus-visible {\n                outline: 2px solid var(--acu-accent);\n                outline-offset: 1px;\n            }\n            .acu-preset-btn.acu-preset-delete:hover {\n                background: rgba(231, 76, 60, 0.15);\n                color: #e74c3c;\n            }\n            .acu-preset-handle {\n                width: 28px;\n                height: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: grab;\n                color: var(--acu-text-sub);\n                opacity: 0.55;\n                transition: opacity 0.2s;\n            }\n            .acu-preset-item:hover .acu-preset-handle {\n                opacity: 0.95;\n            }\n            .acu-preset-handle:active {\n                cursor: grabbing;\n            }\n            /* 预设编辑器输入框样式（防止被主题覆盖） */\n            .acu-preset-editor-input,\n            .acu-preset-editor-textarea {\n                background: var(--acu-input-bg) !important;\n                color: var(--acu-text-main) !important;\n                border: 1px solid var(--acu-border) !important;\n            }\n            .acu-preset-editor-input:focus,\n            .acu-preset-editor-textarea:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n                box-shadow: 0 0 0 2px rgba(var(--acu-accent-rgb, 100, 150, 200), 0.2) !important;\n            }\n            .acu-preset-editor-textarea {\n                font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;\n            }\n            /* Toggle 开关 */\n            .acu-toggle {\n                position: relative;\n                width: 44px;\n                height: 24px;\n                flex-shrink: 0;\n            }\n            .acu-toggle input {\n                opacity: 0;\n                width: 0;\n                height: 0;\n            }\n            .acu-toggle-slider {\n                position: absolute;\n                cursor: pointer;\n                top: 0; left: 0; right: 0; bottom: 0;\n                background: rgba(120, 120, 128, 0.16);\n                border: none;\n                border-radius: 24px;\n                transition: all 0.3s ease;\n            }\n            .acu-toggle-slider:before {\n                position: absolute;\n                content: "";\n                height: 20px;\n                width: 20px;\n                left: 2px;\n                top: 2px;\n                background: #fff;\n                border-radius: 50%;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.15);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider {\n                background: var(--acu-accent);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider:before {\n                transform: translateX(20px);\n                box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n            }\n            /* Range Slider 滑条样式 */\n            .acu-range-slider {\n                -webkit-appearance: none;\n                appearance: none;\n                flex: 1;\n                height: 6px;\n                border-radius: 3px;\n                background: rgba(120, 120, 128, 0.3);\n                outline: none;\n                cursor: pointer;\n                transition: background 0.2s ease;\n            }\n            .acu-range-slider::-webkit-slider-runnable-track {\n                height: 6px;\n                border-radius: 3px;\n                background: transparent;\n            }\n            .acu-range-slider::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                width: 18px !important;\n                height: 18px !important;\n                border-radius: 50% !important;\n                background: #fff !important;\n                border: 1px solid rgba(0,0,0,0.1) !important;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.25) !important;\n                cursor: pointer !important;\n                margin-top: -6px !important;\n                transition: all 0.2s ease;\n            }\n            .acu-range-slider:hover::-webkit-slider-thumb {\n                transform: scale(1.05) !important;\n                background: #e8e8e8 !important;\n                box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;\n            }\n            .acu-range-slider:active::-webkit-slider-thumb {\n                transform: scale(0.95) !important;\n                background: #d0d0d0 !important;\n                box-shadow: 0 1px 4px rgba(0,0,0,0.15) !important;\n            }\n            .acu-range-slider::-moz-range-track {\n                height: 6px;\n                border-radius: 3px;\n                background: rgba(120, 120, 128, 0.16);\n            }\n            .acu-range-slider::-moz-range-thumb {\n                width: 18px !important;\n                height: 18px !important;\n                border-radius: 50% !important;\n                background: #fff !important;\n                border: 1px solid rgba(0,0,0,0.1) !important;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.25) !important;\n                cursor: pointer !important;\n                transition: all 0.2s ease;\n            }\n            .acu-range-slider:hover::-moz-range-thumb {\n                transform: scale(1.05) !important;\n                background: #e8e8e8 !important;\n                box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;\n            }\n            .acu-range-slider:active::-moz-range-thumb {\n                transform: scale(0.95) !important;\n                background: #d0d0d0 !important;\n                box-shadow: 0 1px 4px rgba(0,0,0,0.15) !important;\n            }\n            .acu-range-value {\n                min-width: 45px;\n                text-align: right;\n                font-weight: 600;\n                font-size: 13px;\n                color: var(--acu-accent, var(--SmartThemeBodyColor, #d4a574));\n            }\n            /* 疯狂程度按钮组样式 */\n            .acu-crazy-btn {\n                padding: 4px 12px;\n                font-size: 12px;\n                border: 1px solid var(--acu-border, rgba(0,0,0,0.1));\n                border-radius: 4px;\n                background: var(--acu-btn-bg, rgba(0,0,0,0.05));\n                color: var(--acu-text, inherit);\n                cursor: pointer;\n                transition: all 0.2s ease;\n                font-weight: 500;\n            }\n            .acu-crazy-btn:hover {\n                background: var(--acu-btn-hover, rgba(0,0,0,0.1));\n            }\n            .acu-crazy-btn.active {\n                background: var(--acu-accent, #d4a574);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent, #d4a574);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.15);\n            }\n            /* Debug控制台过滤样式 - 增加优先级防止被酒馆样式覆盖 */\n            .acu-debug-console-dialog .acu-debug-filter,\n            .acu-debug-console-dialog label input.acu-debug-filter {\n                cursor: pointer !important;\n                width: auto !important;\n                height: auto !important;\n                margin: 0 !important;\n                padding: 0 !important;\n                appearance: checkbox !important;\n                -webkit-appearance: checkbox !important;\n                -moz-appearance: checkbox !important;\n            }\n            .acu-debug-console-dialog label {\n                display: flex !important;\n                align-items: center !important;\n                gap: 4px !important;\n                cursor: pointer !important;\n                font-size: 12px !important;\n            }\n            .acu-setting-action-btn {\n                width: 100%;\n                padding: 10px 14px;\n                margin-bottom: 6px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: all 0.15s;\n            }\n            /* Stepper 步进器 */\n            .acu-stepper {\n                display: flex;\n                align-items: center;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                overflow: hidden;\n                background: transparent !important;\n                flex-shrink: 0;\n            }\n            .acu-stepper-btn {\n                width: 36px;\n                height: 34px;\n                border: none !important;\n                background: transparent !important;\n                background-color: transparent !important;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n            }\n            .acu-stepper-btn:hover {\n                background: var(--acu-table-hover) !important;\n                color: var(--acu-accent);\n            }\n            .acu-stepper-btn:active {\n                transform: scale(0.95);\n                background: var(--acu-accent) !important;\n                color: var(--acu-button-text);\n            }\n            .acu-stepper-value {\n                min-width: 60px;\n                height: 34px;\n                line-height: 34px;\n                text-align: center;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: transparent !important;\n                border-left: 1px solid var(--acu-border);\n                border-right: 1px solid var(--acu-border);\n            }\n            /* ========== 变更审核面板样式 ========== */\n            .acu-changes-content {\n                padding: 10px;\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                -webkit-overflow-scrolling: touch !important;\n                touch-action: pan-y !important;\n                overscroll-behavior-y: contain;\n            }\n            /* ========== 验证错误消息样式 ========== */\n            .acu-validation-error-msg {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 0;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n            /* 数据验证模式提示 - 固定在面板顶部，不参与横向滚动 */\n            .acu-validation-mode-hint {\n                padding: 8px 12px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                border-radius: 6px;\n                margin: 0 0 10px 0;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            /* 审核面板横向滚动模式 */\n            .acu-changes-content.acu-changes-horizontal {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                align-items: flex-start !important;\n                gap: 12px;\n                overflow-x: auto !important;\n                overflow-y: visible !important;\n                touch-action: pan-x pan-y !important;\n                padding-bottom: 5px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-x: contain;\n                overscroll-behavior-y: auto;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-list {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                gap: 12px;\n                align-items: flex-start;\n                min-width: max-content;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                flex: 0 0 280px;\n                min-width: 280px;\n                max-width: 280px;\n                max-height: none;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: auto;\n                overscroll-behavior-y: auto;\n            }\n            @media (min-width: 769px) {\n                .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                    flex: 0 0 320px;\n                    min-width: 320px;\n                    max-width: 320px;\n                }\n            }\n            .acu-changes-list { display: flex; flex-direction: column; gap: 10px; }\n            .acu-changes-group { background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; overflow: hidden; }\n            .acu-changes-group-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--acu-table-head); font-weight: bold; font-size: 13px; color: var(--acu-text-main); }\n            .acu-changes-count { margin-left: auto; background: var(--acu-accent); color: var(--acu-btn-active-text); font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: normal; }\n            .acu-changes-group-body { padding: 6px; display: flex; flex-direction: column; gap: 4px; }\n            .acu-change-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 6px; font-size: 12px; background: rgba(0,0,0,0.02); flex-wrap: wrap; transition: all 0.15s; }\n            .acu-change-item:hover { background: var(--acu-table-hover); }\n            .acu-change-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }\n            .acu-badge-added { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-deleted { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); }\n            .acu-badge-modified { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); }\n            .acu-change-title { color: var(--acu-text-main); font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-field { color: var(--acu-text-sub); font-size: 11px; flex-shrink: 0; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-diff { display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0; overflow: hidden; }\n            .acu-diff-old { color: var(--acu-hl-manual); text-decoration: line-through; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            .acu-diff-arrow { color: var(--acu-text-sub); flex-shrink: 0; }\n            .acu-diff-new { color: var(--acu-success-text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            /* 变更操作按钮 */\n            .acu-change-actions { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }\n            .acu-change-action-btn { width: 24px; height: 24px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; transition: all 0.15s; padding: 0; }\n            .acu-change-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: scale(1.1); }\n            .acu-action-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-action-reject:hover, .acu-action-restore:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-action-edit:hover { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); border-color: var(--acu-hl-diff); }\n            /* 批量操作按钮 - 增强深色主题下的对比度 */\n            .acu-changes-batch-btn { width: 32px; height: 32px; border: 1.5px solid rgba(255,255,255,0.4); border-radius: 6px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.85); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: all 0.15s; }\n            .acu-changes-batch-btn:hover { background: rgba(255,255,255,0.2); color: #fff; border-color: rgba(255,255,255,0.6); }\n            .acu-batch-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-batch-reject:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-simple-mode-toggle.active { background: var(--acu-accent); color: var(--acu-btn-active-text); border-color: var(--acu-accent); }\n            .acu-simple-mode-toggle:hover { background: var(--acu-accent); color: var(--acu-btn-active-text); border-color: var(--acu-accent); }\n            .acu-changes-group.collapsed .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group:not(.collapsed) .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group-header:hover { background: var(--acu-table-hover); }\n            /* 变更对比编辑弹窗样式 */\n            .acu-diff-section { margin-bottom: 12px; }\n            .acu-diff-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }\n            .acu-diff-readonly { padding: 10px 12px; background: var(--acu-table-head); border: 1px dashed var(--acu-border); border-radius: 6px; color: var(--acu-text-main); font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; max-height: 150px; overflow-y: auto; opacity: 0.8; }\n            .acu-diff-arrow-down { text-align: center; color: var(--acu-text-sub); font-size: 14px; margin: 8px 0; opacity: 0.5; }\n            /* 可编辑区域高亮样式 */\n            .acu-diff-new-section { padding: 12px; background: var(--acu-input-bg); border: 2px solid var(--acu-accent); border-radius: 6px; box-shadow: 0 0 0 3px rgba(127, 127, 255, 0.1); }\n            .acu-diff-new-section .acu-diff-label { color: var(--acu-accent); font-weight: 600; }\n            .acu-diff-new-section textarea,\n            .acu-diff-new-section input { background: var(--acu-input-bg) !important; border-color: var(--acu-border) !important; }\n            .acu-diff-new-section textarea:focus,\n            .acu-diff-new-section input:focus { border-color: var(--acu-accent) !important; box-shadow: 0 0 0 2px rgba(127, 127, 255, 0.15); }\n            /* 单字段编辑弹窗按钮优化 */\n            .acu-edit-dialog .acu-dialog-btns {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n                margin: 0 -16px -16px -16px;\n                border-radius: 0 0 12px 12px;\n            }\n            .acu-edit-dialog .acu-dialog-btn {\n                flex: 1;\n                padding: 10px 12px;\n                border: 1px solid var(--acu-text-sub);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                white-space: nowrap;\n                transition: all 0.15s;\n            }\n            .acu-edit-dialog .acu-dialog-btn:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-edit-dialog .acu-btn-confirm {\n                background: var(--acu-accent);\n                border-color: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .acu-edit-dialog .acu-btn-confirm:hover {\n                background: var(--acu-accent);\n                opacity: 0.9;\n            }\n            @media (max-width: 768px) {\n                .acu-edit-dialog .acu-dialog-btns {\n                    flex-wrap: nowrap;\n                }\n                .acu-edit-dialog .acu-dialog-btn {\n                    padding: 10px 8px;\n                    font-size: 12px;\n                    min-width: 0;\n                }\n                .acu-edit-dialog .acu-dialog-btn i {\n                    font-size: 11px;\n                }\n            }\n            @media (max-width: 768px) {\n                .acu-change-item { padding: 8px 6px; }\n                .acu-change-diff { flex-basis: 100%; margin-top: 4px; order: 10; }\n                .acu-change-actions { order: 5; }\n                .acu-diff-old, .acu-diff-new { max-width: 100px; }\n                .acu-change-action-btn { width: 28px; height: 28px; }\n            }\n            .acu-change-field-count { font-size: 11px; color: var(--acu-text-sub); margin-left: 4px; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            /* 多字段整体编辑弹窗样式 */\n            .acu-row-edit-field { margin-bottom: 12px; padding: 10px; background: var(--acu-table-head); border-radius: 6px; border: 1px solid transparent; }\n            .acu-row-edit-field.acu-field-changed { border-color: var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-row-edit-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }\n            .acu-changed-badge { font-size: 10px; padding: 1px 6px; background: var(--acu-accent); color: var(--acu-btn-active-text); border-radius: 3px; font-weight: normal; }\n            .acu-row-edit-old { font-size: 12px; color: var(--acu-text-sub); padding: 6px 8px; background: var(--acu-table-head); border-radius: 4px; margin-bottom: 6px; text-decoration: line-through; opacity: 0.7; white-space: pre-wrap; word-break: break-word; }\n            .acu-row-edit-input { width: 100%; min-height: 36px; max-height: 200px; padding: 8px; resize: none; }\n            .acu-empty-val { opacity: 0.5; font-style: italic; }\n            /* ========== 表格管理列表样式 ========== */\n            .acu-table-manager-list {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                max-height: 300px;\n                overflow-y: auto;\n                padding: 4px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-y: contain;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                cursor: default;\n                transition: all 0.15s;\n                user-select: none;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-table-manager-item.hidden-table {\n                opacity: 0.5;\n                border-color: var(--acu-border);\n                border-style: dashed;\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-name {\n                text-decoration: line-through;\n            }\n            .acu-table-item-check {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                color: var(--acu-accent);\n                border-radius: 4px;\n                transition: all 0.15s;\n            }\n            .acu-table-item-check:hover {\n                background: var(--acu-table-hover);\n                transform: scale(1.1);\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-check {\n                color: var(--acu-text-sub);\n            }\n            .acu-table-item-icon {\n                width: 20px;\n                text-align: center;\n                color: var(--acu-accent);\n                font-size: 12px;\n            }\n            .acu-table-item-name {\n                flex: 1;\n                font-size: 13px;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-table-item-handle {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--acu-text-sub);\n                cursor: grab;\n                opacity: 0.4;\n                transition: all 0.15s;\n                border-radius: 4px;\n            }\n            .acu-table-item-handle:hover {\n                opacity: 1;\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n            }\n            .acu-dragging {\n                cursor: grabbing;\n            }\n            .acu-drag-ghost {\n                position: fixed;\n                pointer-events: none;\n                z-index: 10000;\n                opacity: 0.9;\n                box-shadow: 0 8px 24px rgba(0,0,0,0.3);\n                transform: rotate(2deg);\n            }\n            .acu-drag-placeholder {\n                opacity: 0.3;\n                border: 2px dashed var(--acu-border);\n                background: var(--acu-table-hover);\n            }\n            .acu-drag-indicator {\n                height: 3px;\n                background: var(--acu-accent);\n                border-radius: 2px;\n                margin: 4px 0;\n            }\n            @media (max-width: 768px) {\n                .acu-table-item-handle {\n                    opacity: 0.6;\n                }\n            }\n            /* 特殊按钮样式（投骰/审核/变量） */\n            .acu-table-manager-item.acu-special-item {\n                background: linear-gradient(135deg, rgba(var(--acu-accent-rgb, 128, 128, 128), 0.08), transparent);\n                border-style: dashed;\n                border-color: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.3);\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-icon {\n                color: var(--acu-accent);\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-name {\n                font-weight: 500;\n            }\n            /* ========== 数据验证规则样式 ========== */\n            .acu-validation-rules-list {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                max-height: 280px;\n                overflow-y: auto;\n                padding: 2px;\n            }\n            .acu-validation-rule-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                transition: all 0.2s ease;\n            }\n            .acu-validation-rule-item.disabled {\n                opacity: 0.5;\n            }\n            .acu-validation-rule-item:hover {\n                border-color: var(--acu-accent);\n            }\n            .acu-rule-toggle {\n                cursor: pointer;\n                font-size: 18px;\n                color: var(--text-sub);\n                transition: all 0.2s;\n                flex-shrink: 0;\n                background: none;\n                border: none;\n                border-radius: 4px;\n                padding: 4px 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-rule-toggle:hover {\n                opacity: 0.8;\n            }\n            .acu-rule-toggle.active {\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-rule-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-rule-name {\n                font-size: 12px;\n                font-weight: 500;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-rule-target {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                margin-top: 2px;\n            }\n            .acu-rule-type-icon {\n                width: 20px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n                text-align: center;\n                background: none !important;\n            }\n            .acu-rule-delete {\n                background: none;\n                border: none;\n                color: var(--text-sub);\n                cursor: pointer;\n                padding: 4px;\n                opacity: 0.6;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-delete:hover {\n                color: #e74c3c;\n                opacity: 1;\n            }\n            .acu-rule-edit {\n                background: none;\n                border: none;\n                color: var(--text-sub);\n                cursor: pointer;\n                padding: 4px;\n                opacity: 0.6;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-edit:hover {\n                color: var(--accent-color);\n                opacity: 1;\n            }\n            .acu-rule-delete:hover {\n                color: #e74c3c;\n                opacity: 1;\n            }\n            .acu-rule-intercept {\n                cursor: pointer;\n                font-size: 14px;\n                color: var(--acu-text-sub);\n                padding: 4px 6px;\n                border-radius: 4px;\n                opacity: 0.5;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-intercept:hover {\n                opacity: 0.8;\n                background: var(--acu-hover-bg);\n            }\n            .acu-rule-intercept.active {\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-add-rule-btn {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                width: 100%;\n                padding: 10px;\n                margin-top: 8px;\n                background: var(--acu-btn-bg);\n                border: 1px dashed var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-add-rule-btn:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n                background: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.1);\n            }\n            /* 验证规则弹窗 */\n            .acu-validation-modal-overlay {\n                z-index: 31320;\n            }\n            .acu-validation-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 420px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-validation-modal-body {\n                padding: 16px;\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                max-height: 60vh;\n                overflow-y: auto;\n            }\n            .acu-validation-modal-body .acu-setting-row {\n                flex-wrap: wrap;\n            }\n            .acu-validation-modal-body .acu-panel-input,\n            .acu-validation-modal input[type="text"],\n            .acu-validation-modal input[type="number"],\n            .acu-validation-modal select {\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                padding: 8px 10px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n            }\n            .acu-validation-modal-body .acu-panel-input:focus,\n            .acu-validation-modal input[type="text"]:focus,\n            .acu-validation-modal input[type="number"]:focus,\n            .acu-validation-modal select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-validation-modal-body .acu-panel-input::placeholder,\n            .acu-validation-modal input[type="text"]::placeholder,\n            .acu-validation-modal input[type="number"]::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-validation-modal select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-validation-modal select option[value=""] {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-rule-config-section {\n                padding: 8px 0;\n            }\n            .acu-validation-modal-footer {\n                display: flex;\n                justify-content: center;\n                gap: 12px;\n                padding: 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-validation-modal-footer .acu-btn {\n                flex: 1;\n                padding: 10px 12px !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n            }\n            /* 智能修改弹窗样式 */\n            .acu-smart-fix-meta {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 0 !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-separator {\n                color: var(--acu-border) !important;\n                opacity: 0.5 !important;\n            }\n            .acu-smart-fix-diff {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                padding: 6px 0 !important;\n                margin: 4px 0 !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-diff-old-text {\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n                font-size: 13px !important;\n                white-space: nowrap !important;\n                overflow: hidden !important;\n                text-overflow: ellipsis !important;\n                max-width: 150px !important;\n            }\n            .acu-smart-fix-diff-arrow {\n                color: var(--acu-text-sub) !important;\n                flex-shrink: 0 !important;\n            }\n            .acu-smart-fix-empty {\n                opacity: 0.5 !important;\n                font-style: italic !important;\n            }\n            .acu-smart-fix-diff-input-wrapper {\n                flex: 1 !important;\n                min-width: 120px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input,\n            .acu-smart-fix-diff-input-wrapper select {\n                width: 100% !important;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                padding: 4px 8px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n                -moz-appearance: none !important;\n                appearance: none !important;\n                min-height: 26px !important;\n                line-height: 1.3 !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input:focus,\n            .acu-smart-fix-diff-input-wrapper select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select {\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23666' d='M5 7L1 3h8z'/%3E%3C/svg%3E") !important;\n                background-repeat: no-repeat !important;\n                background-position: right 6px center !important;\n                padding-right: 24px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select option {\n                background: var(--acu-card-bg) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-suggest {\n                padding: 10px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-suggest-label {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                margin-bottom: 6px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 4px !important;\n            }\n            .acu-smart-fix-suggest-label i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-suggest-value {\n                font-size: 13px !important;\n                color: var(--acu-success-text) !important;\n                font-weight: 500 !important;\n                padding: 6px 8px !important;\n                background: var(--acu-success-bg) !important;\n                border-radius: 4px !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-suggest-value:hover {\n                background: var(--acu-success-text) !important;\n                color: white !important;\n            }\n            .acu-smart-fix-suggest-options {\n                display: flex !important;\n                flex-wrap: wrap !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-suggest-options-scroll {\n                max-height: 120px !important;\n                overflow-y: auto !important;\n                padding-right: 4px !important;\n            }\n            .acu-smart-fix-option {\n                display: inline-block !important;\n                font-size: 12px !important;\n                padding: 4px 10px !important;\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                color: var(--acu-text-main) !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-option:hover {\n                background: var(--acu-btn-hover) !important;\n                border-color: var(--acu-accent) !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-option-current {\n                background: var(--acu-hl-manual-bg) !important;\n                border-color: var(--acu-hl-manual) !important;\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n            }\n            .acu-smart-fix-error-hint {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-card-bg) !important;\n                border-radius: 4px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-error-hint i {\n                color: var(--acu-accent) !important;\n                flex-shrink: 0 !important;\n            }\n            @media (max-width: 600px) {\n                .acu-smart-fix-diff {\n                    flex-direction: column !important;\n                    align-items: stretch !important;\n                }\n                .acu-smart-fix-diff-arrow {\n                    transform: rotate(90deg) !important;\n                }\n            }\n            .acu-btn {\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid transparent;\n            }\n            .acu-btn-secondary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-text-sub);\n                color: var(--acu-text-main);\n            }\n            .acu-btn-secondary:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-btn-primary {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .acu-btn-primary:hover {\n                opacity: 0.9;\n            }\n            /* 智能修改弹窗新增样式 */\n            .acu-smart-fix-rule-info {\n                padding: 10px 12px !important;\n                background: var(--acu-table-head) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-left: 3px solid var(--acu-accent) !important;\n                border-radius: 4px !important;\n                margin-bottom: 12px !important;\n            }\n            .acu-smart-fix-rule-header {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                font-size: 13px !important;\n                font-weight: 600 !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-rule-header i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-rule-desc {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                line-height: 1.4 !important;\n            }\n            .acu-smart-fix-suggest-section {\n                margin-top: 12px !important;\n            }\n            .acu-smart-fix-suggest code {\n                background: var(--acu-table-head) !important;\n                padding: 2px 6px !important;\n                border-radius: 3px !important;\n                font-size: 11px !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-quick-btn {\n                display: inline-flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                padding: 6px 12px !important;\n                background: var(--acu-accent) !important;\n                color: var(--acu-btn-active-text) !important;\n                border: 1px solid var(--acu-accent) !important;\n                border-radius: 4px !important;\n                font-size: 12px !important;\n                font-weight: 500 !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-quick-btn:hover {\n                background: var(--acu-btn-active-bg) !important;\n                color: var(--acu-btn-active-text) !important;\n                border-color: var(--acu-btn-active-bg) !important;\n            }\n            .acu-smart-fix-table-summary {\n                padding: 12px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n            }\n            .acu-smart-fix-stat {\n                font-size: 13px !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 8px !important;\n            }\n            .acu-smart-fix-stat strong {\n                color: var(--acu-hl-manual) !important;\n            }\n            .acu-smart-fix-change-list {\n                max-height: 150px !important;\n                overflow-y: auto !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-change-item {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 3px !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-hint {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 4px !important;\n                margin-top: 8px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-hint i {\n                color: var(--acu-accent) !important;\n            }\n            /* ========== 头像裁剪弹窗样式 ========== */\n            .acu-crop-modal-overlay {\n                z-index: 31330;\n            }\n            .acu-crop-file-input {\n                display: none;\n            }\n            .acu-crop-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 360px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-crop-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-crop-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                font-size: 16px;\n                cursor: pointer;\n                padding: 4px;\n            }\n            .acu-crop-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-crop-body {\n                padding: 20px;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 12px;\n            }\n            .acu-crop-container {\n                position: relative;\n                width: 200px;\n                height: 200px;\n                border-radius: 50%;\n                overflow: hidden;\n                touch-action: none;\n                user-select: none;\n            }\n            .acu-crop-image {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-repeat: no-repeat;\n                cursor: grab;\n            }\n            .acu-crop-mask {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                border: 3px solid var(--acu-accent);\n                border-radius: 50%;\n                pointer-events: none;\n                box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);\n            }\n            .acu-crop-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-crop-footer {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-top: 1px solid var(--acu-border);\n            }\n            .acu-crop-btn {\n                flex: 1;\n                padding: 10px 16px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-crop-cancel {\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-text-sub);\n                color: var(--acu-text-main);\n            }\n            .acu-crop-cancel:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-crop-confirm {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .acu-crop-confirm:hover {\n                opacity: 0.9;\n            }\n            .acu-crop-reupload {\n                flex: 0 0 auto;\n                padding: 10px 14px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-crop-reupload:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n\n            /* ========== 收藏夹面板样式 ========== */\n            .acu-favorites-overlay,\n            .acu-fav-edit-overlay,\n            .acu-fav-new-overlay,\n            .acu-fav-send-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.6);\n                z-index: 31300;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                backdrop-filter: blur(2px);\n            }\n            .acu-favorites-panel {\n                width: 90%;\n                max-width: 800px;\n                max-height: 85vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n            .acu-favorites-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n            }\n            .acu-favorites-header h3 {\n                margin: 0;\n                font-size: 16px;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-favorites-header-actions {\n                display: flex;\n                gap: 8px;\n            }\n            .acu-fav-header-btn {\n                padding: 6px 12px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                font-size: 12px;\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-header-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-header-btn.acu-fav-close {\n                background: transparent;\n                border: none;\n                font-size: 16px;\n            }\n            .acu-favorites-filter {\n                display: flex;\n                gap: 10px;\n                padding: 12px 18px;\n                border-bottom: 1px solid var(--acu-border);\n                background: var(--acu-bg-main);\n            }\n            .acu-favorites-filter select,\n            .acu-favorites-filter input {\n                flex: 1;\n                padding: 8px 12px;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 13px;\n            }\n            .acu-favorites-filter select {\n                max-width: 200px;\n            }\n            .acu-favorites-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 16px;\n            }\n            .acu-favorites-empty {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n                padding: 60px 20px;\n                color: var(--acu-text-muted);\n                text-align: center;\n            }\n            .acu-favorites-group {\n                margin-bottom: 20px;\n            }\n            .acu-favorites-group-title {\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 10px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-favorites-group-cards {\n                display: grid;\n                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));\n                gap: 12px;\n            }\n            .acu-favorites-card {\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                padding: 12px;\n                transition: all 0.2s ease;\n            }\n            .acu-favorites-card:hover {\n                border-color: var(--acu-accent);\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n            }\n            .acu-favorites-card-header {\n                margin-bottom: 8px;\n            }\n            .acu-favorites-card-preview {\n                font-size: 12px;\n                color: var(--acu-text-main);\n                line-height: 1.5;\n            }\n            .acu-fav-preview-item {\n                display: block;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n            .acu-fav-preview-item b {\n                color: var(--acu-accent);\n            }\n            .acu-favorites-card-source {\n                font-size: 11px;\n                color: var(--acu-text-muted);\n                margin-top: 4px;\n            }\n            .acu-favorites-card-tags {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 4px;\n                margin-bottom: 8px;\n            }\n            .acu-favorites-tag {\n                padding: 2px 8px;\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-radius: 10px;\n                font-size: 10px;\n                font-weight: 500;\n            }\n            .acu-favorites-card-actions {\n                display: flex;\n                gap: 6px;\n                justify-content: flex-end;\n            }\n            .acu-fav-btn {\n                width: 28px;\n                height: 28px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 12px;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-delete:hover {\n                color: #e74c3c;\n            }\n            .acu-fav-send:hover {\n                color: #27ae60;\n            }\n\n            /* ========== 收藏夹标签过滤可折叠区域 ========== */\n            .acu-fav-tag-filter-collapsible {\n                border-bottom: 1px solid var(--acu-border);\n            }\n            .acu-fav-tag-filter-header {\n                position: sticky;\n                top: 0;\n                z-index: 1;\n                padding: 6px 12px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                user-select: none;\n            }\n            .acu-fav-tag-filter-header span {\n                font-size: calc(var(--acu-font-size, 13px) * 0.85);\n                color: var(--acu-text-sub);\n                font-weight: 500;\n            }\n            .acu-fav-tag-toggle-icon {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                transition: transform 0.2s;\n            }\n            .acu-fav-tag-filter-body {\n                padding: 8px 12px;\n                background: var(--acu-table-head);\n                display: flex;\n                flex-wrap: wrap;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-fav-tag-filter-body.horizontal {\n                display: grid;\n                grid-auto-flow: column;\n                grid-template-rows: repeat(auto-fill, minmax(28px, 1fr));\n                gap: 6px;\n                overflow-x: auto;\n            }\n            .acu-fav-tag-filter-collapsible.collapsed .acu-fav-tag-filter-body {\n                display: none;\n            }\n            .acu-fav-tag-filter-collapsible.collapsed .acu-fav-tag-toggle-icon {\n                transform: rotate(-90deg);\n            }\n            .acu-fav-tag-btn {\n                padding: 0 10px;\n                height: 28px;\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: calc(var(--acu-font-size, 13px) * 0.85);\n                transition: all 0.2s ease;\n                opacity: 0.5;\n                white-space: nowrap;\n            }\n            .acu-fav-tag-btn:hover {\n                opacity: 0.8;\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n            }\n            .acu-fav-tag-btn.active {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n                opacity: 1;\n            }\n\n            /* 编辑弹窗 */\n            .acu-fav-edit-modal,\n            .acu-fav-new-modal,\n            .acu-fav-send-modal {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n            .acu-fav-edit-modal-header,\n            .acu-fav-new-modal-header,\n            .acu-fav-send-modal-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n            }\n            .acu-fav-edit-modal-header h4,\n            .acu-fav-new-modal-header h4,\n            .acu-fav-send-modal-header h4 {\n                margin: 0;\n                font-size: 15px;\n                color: var(--acu-accent);\n            }\n            .acu-fav-edit-close,\n            .acu-fav-new-close,\n            .acu-fav-send-close {\n                background: transparent !important;\n                border: none !important;\n                color: var(--acu-text-main) !important;\n                cursor: pointer;\n                font-size: 16px;\n            }\n            .acu-fav-edit-close:hover,\n            .acu-fav-new-close:hover,\n            .acu-fav-send-close:hover {\n                background: transparent !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-fav-edit-modal-body,\n            .acu-fav-new-modal-body,\n            .acu-fav-send-modal-body {\n                flex: 1;\n                overflow-y: auto;\n                padding: 16px;\n            }\n            .acu-fav-edit-tags-section {\n                margin-bottom: 16px;\n            }\n            .acu-fav-edit-tags-section label {\n                display: block;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                margin-bottom: 6px;\n            }\n            .acu-fav-edit-tags-section input {\n                width: 100%;\n                padding: 8px 12px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 13px;\n            }\n            .acu-fav-edit-rows {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 12px;\n            }\n            .acu-fav-edit-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n            .acu-fav-edit-header {\n                flex: 0 0 120px;\n                padding: 8px 10px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-accent);\n                font-size: 12px;\n                font-weight: 600;\n            }\n            .acu-fav-edit-value {\n                flex: 1;\n                padding: 8px 10px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 12px;\n            }\n            .acu-fav-edit-remove {\n                width: 28px;\n                height: 28px;\n                background: transparent !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px;\n                color: var(--acu-text-sub) !important;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-fav-edit-remove:hover {\n                color: #e74c3c !important;\n                border-color: #e74c3c !important;\n                background: transparent !important;\n            }\n            .acu-fav-edit-add-col {\n                padding: 8px 12px;\n                background: var(--acu-btn-bg);\n                border: 1px dashed var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                font-size: 12px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-edit-add-col:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n            }\n            .acu-fav-edit-modal-footer,\n            .acu-fav-new-modal-footer,\n            .acu-fav-send-modal-footer {\n                display: flex;\n                justify-content: flex-end;\n                gap: 10px;\n                padding: 14px 18px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-bg-main);\n            }\n            .acu-fav-edit-cancel,\n            .acu-fav-new-cancel,\n            .acu-fav-send-cancel {\n                padding: 8px 16px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-text-sub);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n            }\n            .acu-fav-edit-save,\n            .acu-fav-new-create {\n                padding: 8px 16px;\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                border-radius: 6px;\n                color: var(--acu-btn-active-text);\n                cursor: pointer;\n            }\n            .acu-fav-edit-save:hover,\n            .acu-fav-new-create:hover {\n                opacity: 0.9;\n            }\n\n            /* 发送选择弹窗 */\n            .acu-fav-send-option {\n                padding: 12px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 8px;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-send-option:hover {\n                border-color: var(--acu-accent);\n                background: var(--acu-btn-hover);\n            }\n            .acu-fav-send-option-name {\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-fav-send-option-mode {\n                font-size: 12px;\n            }\n            .acu-fav-send-unmatched {\n                font-size: 11px;\n                color: var(--acu-text-muted);\n                margin-top: 4px;\n            }\n\n            /* 新建模板选择 */\n            .acu-fav-new-modal-body label {\n                display: block;\n                font-size: 13px;\n                color: var(--acu-text-main);\n                margin-bottom: 10px;\n            }\n            .acu-fav-new-modal-body select {\n                width: 100%;\n                padding: 10px 12px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 14px;\n            }\n\n            @media (max-width: 768px) {\n                .acu-favorites-panel {\n                    width: 95%;\n                    max-height: 90vh;\n                }\n                .acu-favorites-group-cards {\n                    grid-template-columns: 1fr;\n                }\n                .acu-favorites-header-actions {\n                    flex-wrap: wrap;\n                }\n                .acu-fav-header-btn span {\n                    display: none;\n                }\n            }\n\n            /* ========== 收藏夹面板样式 (新增) ========== */\n            /* [修复] 收藏夹外层容器必须限制高度和溢出，防止卡片超出面板范围 */\n            .acu-fav-wrapper {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n                max-height: 100%;\n                overflow: hidden;\n            }\n            .acu-fav-panel-content {\n                padding: 12px;\n                overflow-y: auto;\n                overflow-x: auto;\n                flex: 1;\n                min-height: 0; /* 关键：允许 flex 子元素收缩 */\n                /* 滚动条样式 - Firefox */\n                scrollbar-width: thin;\n                scrollbar-color: var(--acu-btn-bg) var(--acu-bg-nav);\n                overscroll-behavior: contain;\n            }\n            /* 收藏夹面板滚动条 - Webkit (Chrome/Safari/Edge) */\n            .acu-fav-panel-content::-webkit-scrollbar {\n                width: 8px;\n                height: 8px;\n            }\n            .acu-fav-panel-content::-webkit-scrollbar-track {\n                background: var(--acu-bg-nav);\n                border-radius: 4px;\n            }\n            .acu-fav-panel-content::-webkit-scrollbar-thumb {\n                background: var(--acu-btn-bg);\n                border-radius: 4px;\n                border: 2px solid var(--acu-bg-nav);\n            }\n            .acu-fav-panel-content::-webkit-scrollbar-thumb:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-fav-panel-content::-webkit-scrollbar-corner {\n                background: var(--acu-bg-nav);\n            }\n            /* [已废弃] 工具栏已移至Header，保留样式以防回退 */\n            /*\n            .acu-fav-toolbar {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 12px;\n                flex-wrap: wrap;\n            }\n            */\n            .acu-fav-select,\n            .acu-fav-input {\n                padding: 6px 10px !important;\n                background: var(--acu-bg-panel) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                height: auto !important;\n                box-shadow: none !important;\n            }\n            .acu-fav-select {\n                min-width: 120px;\n            }\n            .acu-fav-input {\n                flex: 1;\n                min-width: 150px;\n            }\n            .acu-fav-toolbar-btn {\n                padding: 6px 10px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                font-size: 12px;\n            }\n            .acu-fav-toolbar-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-grid {\n                display: flex;\n                flex-direction: column;\n                gap: 16px;\n            }\n            .acu-fav-group-title {\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-accent);\n                margin-bottom: 8px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-fav-group-cards {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 10px;\n            }\n            /* 收藏夹卡片 - 复用 acu-data-card 宽度，保持与普通表格一致 */\n            .acu-fav-card {\n                flex: 0 0 var(--acu-card-width, 260px);\n                width: var(--acu-card-width, 260px);\n                cursor: pointer;\n            }\n            /* [修复] 收藏夹卡片来源标签 - 放在底部与tags一起 */\n            .acu-fav-card-source {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: normal;\n                background: var(--acu-badge-bg);\n                padding: 2px 8px;\n                border-radius: 4px;\n            }\n            .acu-fav-card-tags {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 4px;\n                padding: 6px 12px 8px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-fav-tag {\n                padding: 2px 6px;\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-radius: 8px;\n                font-size: 10px;\n            }\n            /* [已废弃] 操作按钮已改为单击菜单，保留样式以防回退 */\n            /*\n            .acu-fav-card-actions {\n                display: flex;\n                justify-content: flex-end;\n                gap: 4px;\n                padding: 8px 12px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-bg-main);\n            }\n            .acu-fav-action-btn {\n                width: 28px;\n                height: 28px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 11px;\n            }\n            .acu-fav-action-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-delete:hover {\n                color: #e74c3c;\n            }\n            */\n            .acu-fav-empty {\n                text-align: center;\n                padding: 40px 20px;\n                color: var(--acu-text-muted);\n            }\n            .acu-fav-empty i {\n                font-size: 36px;\n                opacity: 0.3;\n                margin-bottom: 12px;\n            }\n            .acu-fav-empty p {\n                margin: 4px 0;\n            }\n\n            /* 编辑弹窗 - 保留弹窗形式，添加移动端适配 */\n            .acu-fav-edit-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.6);\n                z-index: 31300;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-fav-edit-modal {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n            @media (max-width: 768px) {\n                .acu-fav-edit-modal {\n                    position: fixed !important;\n                    top: 5% !important;\n                    left: 50% !important;\n                    transform: translateX(-50%) !important;\n                    width: 92vw !important;\n                    max-height: 88vh !important;\n                }\n                .acu-fav-edit-overlay {\n                    align-items: flex-start !important;\n                    padding-top: 5vh !important;\n                }\n                .acu-fav-group-cards {\n                    grid-template-columns: 1fr !important;\n                }\n            }\n            /* 编辑弹窗输入框样式覆盖 */\n            .acu-fav-edit-modal input {\n                padding: 8px 10px !important;\n                background: var(--acu-bg-panel) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                height: auto !important;\n                box-shadow: none !important;\n            }\n\n    /* Cleaned up Inline Styles */\n    #dice-custom-input { width: 60px; }\n    \n    .acu-mvu-dice-icon {\n        cursor: pointer;\n        color: var(--acu-accent);\n        opacity: 0.6;\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        flex-shrink: 0;\n    }\n    \n    .acu-mvu-level-toggle {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        cursor: pointer;\n        padding: 2px 6px;\n        border-radius: 4px;\n        border: 1px solid var(--acu-border);\n        transition: all 0.2s;\n        background: transparent;\n        color: var(--acu-text-sub);\n        opacity: 0.5;\n    }\n    .acu-mvu-level-toggle.active {\n        background: var(--acu-accent);\n        color: var(--acu-btn-active-text);\n        border-color: var(--acu-accent);\n        opacity: 1;\n    }\n    \n    .acu-mvu-header {\n        padding: 6px 8px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        user-select: none;\n    }\n    \n    .acu-mvu-body {\n        padding: 8px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        display: flex;\n        flex-wrap: wrap;\n        gap: 6px;\n        align-items: center;\n    }\n    \n    .acu-mvu-item {\n        display: flex;\n        align-items: center;\n        padding: 6px 8px;\n        margin-bottom: 4px;\n        background: var(--acu-table-hover);\n        border-radius: 4px;\n        border-left: 3px solid var(--acu-accent);\n    }\n    \n    .acu-mvu-path {\n        font-size: calc(var(--acu-font-size, 13px) * 0.77);\n        color: var(--acu-text-sub);\n        margin-bottom: 2px;\n    }\n    \n    .acu-mvu-val {\n        font-size: var(--acu-font-size, 13px);\n        color: var(--acu-accent);\n        font-weight: bold;\n        cursor: pointer;\n    }\n    \n    .acu-mvu-list {\n        padding: 0 8px;\n    }\n\n    .acu-mvu-toggle-icon {\n        font-size: 10px;\n        color: var(--acu-text-sub);\n        transition: transform 0.2s;\n    }\n    .acu-mvu-header-text {\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        color: var(--acu-text-sub);\n    }\n    .acu-mvu-item-content {\n        flex: 1;\n        min-width: 0;\n    }\n    .acu-mvu-item-row {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n    }\n    .acu-mvu-attr-name {\n        font-size: calc(var(--acu-font-size, 13px) * 0.92);\n        color: var(--acu-text-main);\n        font-weight: bold;\n    }\n    .acu-order-first {\n        order: -1;\n    }\n    .acu-text-sub-small {\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        color: var(--acu-text-sub);\n    }\n    .acu-ml-6 {\n        margin-left: 6px;\n    }\n\n    /* Graph & Node Size Controls */\n    .acu-graph-filter-btn {\n        padding: 4px 6px;\n        font-size: 12px;\n    }\n    .acu-graph-filter-btn.ml-8 {\n        margin-left: 8px;\n    }\n    .acu-node-size-slider-container {\n        position: absolute;\n        display: none;\n        width: 200px;\n        padding: 10px;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        z-index: 10;\n        background: var(--acu-bg-panel);\n        border: 1px solid var(--acu-border);\n    }\n    .acu-slider-header {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin-bottom: 6px;\n    }\n    .acu-range-input {\n        width: 100%;\n        height: 8px;\n        border-radius: 4px;\n        outline: none;\n        cursor: pointer;\n        -webkit-appearance: none;\n        background: var(--acu-input-bg);\n        margin: 0;\n    }\n    .acu-range-input::-webkit-slider-thumb {\n        -webkit-appearance: none;\n        width: 16px;\n        height: 16px;\n        border-radius: 50%;\n        background: var(--acu-accent);\n        cursor: pointer;\n        margin-top: -4px; /* Adjust for track height if needed, usually 0 or negative for center */\n    }\n    .acu-range-input::-webkit-slider-runnable-track {\n        width: 100%;\n        height: 8px;\n        cursor: pointer;\n        background: var(--acu-input-bg);\n        border-radius: 4px;\n    }\n    .acu-graph-reset-btn {\n        width: auto;\n        height: auto;\n        padding: 4px 10px;\n        font-size: 11px;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n    }\n    .acu-node-size-wrapper {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n    }\n    .acu-stepper-container {\n        display: flex;\n        align-items: center;\n    }\n    .acu-stepper-value-display {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    .acu-zoom-info {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        color: var(--acu-text-sub);\n        font-size: 11px;\n    }\n\n    /* 锁定图标 - CSS-only */\n    [data-locked="true"]::after {\n        content: "\\f023";\n        font-family: "Font Awesome 6 Free";\n        font-weight: 900;\n        font-size: 10px;\n        color: var(--acu-accent);\n        opacity: 0.7;\n        margin-left: 4px;\n        pointer-events: none;\n        display: inline;\n    }\n\n    /* 标题锁图标略大 */\n    .acu-editable-title[data-locked="true"]::after {\n        font-size: 11px;\n        opacity: 0.8;\n    }\n\n    /* ========== 导入确认弹窗样式 ========== */\n    .acu-import-confirm-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0, 0, 0, 0.6);\n        z-index: 31300;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 16px;\n        box-sizing: border-box;\n    }\n\n    .acu-import-confirm-dialog {\n        width: 90%;\n        max-width: 420px;\n        max-height: calc(100vh - 32px);\n        background: var(--acu-bg-panel);\n        border: 1px solid var(--acu-border);\n        border-radius: 12px;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n        overflow: hidden;\n        animation: acu-modal-pop 0.2s ease-out;\n        display: flex;\n        flex-direction: column;\n    }\n\n    .acu-import-confirm-title {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n    }\n\n    .acu-import-close-btn {\n        width: 28px;\n        height: 28px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: var(--acu-btn-bg);\n        border: 1px solid var(--acu-border);\n        border-radius: 6px;\n        color: var(--acu-text-sub);\n        cursor: pointer;\n        transition: all 0.2s ease;\n        flex-shrink: 0;\n    }\n\n    .acu-import-close-btn:hover {\n        background: var(--acu-btn-hover);\n        color: var(--acu-text-main);\n    }\n\n    .acu-import-warning {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        padding: 10px 12px;\n        background: var(--acu-hl-manual-bg, rgba(230, 126, 34, 0.15));\n        border-radius: 6px;\n        color: var(--acu-hl-manual, #e67e22);\n        font-size: 13px;\n        margin-bottom: 12px;\n    }\n\n    .acu-import-conflict-list {\n        max-height: 120px;\n        overflow-y: auto;\n        padding: 10px 12px;\n        background: var(--acu-table-hover);\n        border-radius: 6px;\n        font-size: 12px;\n        color: var(--acu-text-main);\n        line-height: 1.6;\n        margin-bottom: 12px;\n    }\n\n    .acu-import-conflict-options {\n        display: flex;\n        flex-direction: column;\n        gap: 8px;\n    }\n\n    .acu-import-radio {\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        padding: 12px 14px;\n        background: var(--acu-btn-bg);\n        border: 1px solid var(--acu-border);\n        border-radius: 8px;\n        cursor: pointer;\n        transition: all 0.2s ease;\n    }\n\n    .acu-import-radio:hover {\n        background: var(--acu-btn-hover);\n        border-color: var(--acu-accent);\n    }\n\n    .acu-import-radio input[type="radio"] {\n        accent-color: var(--acu-accent);\n    }\n\n    .acu-import-success {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        padding: 12px 14px;\n        background: var(--acu-success-bg, rgba(39, 174, 96, 0.15));\n        border-radius: 6px;\n        color: var(--acu-success-text, #27ae60);\n        font-size: 13px;\n    }\n\n    .acu-import-confirm-footer {\n        display: flex;\n        gap: 10px;\n        padding: 14px 18px;\n        border-top: 1px solid var(--acu-border);\n        background: var(--acu-table-head);\n    }\n\n    .acu-import-cancel-btn,\n    .acu-import-confirm-btn {\n        flex: 1;\n        padding: 10px 16px;\n        border-radius: 8px;\n        font-size: 13px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.2s ease;\n    }\n\n    .acu-import-cancel-btn {\n        background: var(--acu-btn-bg);\n        border: 1px solid var(--acu-text-sub);\n        color: var(--acu-text-main);\n    }\n\n    .acu-import-cancel-btn:hover {\n        background: var(--acu-btn-hover);\n    }\n\n    .acu-import-confirm-btn {\n        background: var(--acu-accent);\n        border: 1px solid var(--acu-accent);\n        color: var(--acu-btn-active-text);\n    }\n\n    .acu-import-confirm-btn:hover {\n        filter: brightness(1.1);\n    }\n\n    /* ========================================\n     * Debug Console - 移动端优化 & 美化\n     * ======================================== */\n    \n    /* 主弹窗容器 - 移动端全屏，PC端居中 */\n    .acu-debug-console-dialog {\n        width: 100% !important;\n        max-width: 100vw !important;\n        height: 100% !important;\n        max-height: 100vh !important;\n        border-radius: 0 !important;\n        margin: 0 !important;\n        background: var(--acu-bg-panel) !important;\n        animation: debugSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) !important;\n    }\n    \n    @media (min-width: 768px) {\n        .acu-debug-console-dialog {\n            width: 90vw !important;\n            max-width: 900px !important;\n            height: 85vh !important;\n            max-height: 700px !important;\n            border-radius: 16px !important;\n            animation: debugFadeScale 0.25s cubic-bezier(0.16, 1, 0.3, 1) !important;\n        }\n    }\n    \n    @keyframes debugSlideUp {\n        from {\n            transform: translateY(100%);\n            opacity: 0;\n        }\n        to {\n            transform: translateY(0);\n            opacity: 1;\n        }\n    }\n    \n    @keyframes debugFadeScale {\n        from {\n            transform: scale(0.95);\n            opacity: 0;\n        }\n        to {\n            transform: scale(1);\n            opacity: 1;\n        }\n    }\n    \n    /* Header 样式美化 */\n    .acu-debug-console-dialog .acu-settings-header {\n        background: linear-gradient(135deg, var(--acu-table-head) 0%, var(--acu-bg-panel) 100%) !important;\n        border-bottom: 1px solid var(--acu-border) !important;\n        padding: 16px 20px !important;\n        position: relative !important;\n    }\n    \n    .acu-debug-console-dialog .acu-settings-title {\n        font-size: 16px !important;\n        font-weight: 700 !important;\n        display: flex !important;\n        align-items: center !important;\n        gap: 10px !important;\n        color: var(--acu-text-main) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-settings-title i {\n        font-size: 18px !important;\n        color: var(--acu-accent) !important;\n        animation: debugPulse 2s ease-in-out infinite !important;\n    }\n    \n    @keyframes debugPulse {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.6; }\n    }\n    \n    /* 工具栏 - 移动端垂直布局 */\n    .acu-debug-console-dialog .acu-debug-toolbar {\n        padding: 12px 16px !important;\n        border-bottom: 1px solid var(--acu-border) !important;\n        background: var(--acu-card-bg) !important;\n        display: flex !important;\n        flex-direction: column !important;\n        gap: 12px !important;\n    }\n    \n    @media (min-width: 768px) {\n        .acu-debug-console-dialog .acu-debug-toolbar {\n            flex-direction: row !important;\n            align-items: center !important;\n            padding: 14px 20px !important;\n        }\n    }\n    \n    /* Console 抓取开关 */\n    .acu-debug-console-dialog .acu-debug-capture-row {\n        display: flex !important;\n        align-items: center !important;\n        gap: 12px !important;\n        padding: 10px 14px !important;\n        background: var(--acu-table-hover) !important;\n        border-radius: 10px !important;\n        border: 1px solid var(--acu-border) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-capture-label {\n        font-size: 13px !important;\n        color: var(--acu-text-sub) !important;\n        flex: 1 !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-capture-status {\n        font-size: 12px !important;\n        padding: 4px 10px !important;\n        border-radius: 20px !important;\n        font-weight: 600 !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-capture-status.enabled {\n        background: var(--acu-success-bg) !important;\n        color: var(--acu-success-text) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-capture-status.disabled {\n        background: var(--acu-badge-bg) !important;\n        color: var(--acu-text-sub) !important;\n    }\n    \n    /* 过滤器按钮组 - 移动端横向滚动 */\n    .acu-debug-console-dialog .acu-debug-filter-group {\n        display: flex !important;\n        gap: 8px !important;\n        overflow-x: auto !important;\n        -webkit-overflow-scrolling: touch !important;\n        scrollbar-width: none !important;\n        padding: 4px 0 !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-filter-group::-webkit-scrollbar {\n        display: none !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-filter-btn {\n        flex-shrink: 0 !important;\n        padding: 8px 14px !important;\n        border-radius: 20px !important;\n        font-size: 12px !important;\n        font-weight: 600 !important;\n        border: 1px solid var(--acu-border) !important;\n        background: var(--acu-btn-bg) !important;\n        color: var(--acu-text-sub) !important;\n        transition: all 0.2s ease !important;\n        cursor: pointer !important;\n        display: flex !important;\n        align-items: center !important;\n        gap: 6px !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-filter-btn:active {\n        transform: scale(0.95) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-filter-btn.active {\n        background: var(--acu-accent) !important;\n        color: var(--acu-button-text-on-accent, #fff) !important;\n        border-color: var(--acu-accent) !important;\n        box-shadow: 0 2px 8px rgba(var(--acu-accent-rgb, 59, 130, 246), 0.3) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-filter-btn .count {\n        font-size: 10px !important;\n        padding: 2px 6px !important;\n        border-radius: 10px !important;\n        background: rgba(255, 255, 255, 0.2) !important;\n        min-width: 18px !important;\n        text-align: center !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-filter-btn.active .count {\n        background: rgba(0, 0, 0, 0.15) !important;\n    }\n    \n    /* 日志类型指示器颜色 */\n    .acu-debug-console-dialog .acu-debug-filter-btn[data-filter-type="log"] .indicator { color: var(--acu-text-sub) !important; }\n    .acu-debug-console-dialog .acu-debug-filter-btn[data-filter-type="info"] .indicator { color: var(--acu-hl-diff) !important; }\n    .acu-debug-console-dialog .acu-debug-filter-btn[data-filter-type="warn"] .indicator { color: var(--acu-warning-text) !important; }\n    .acu-debug-console-dialog .acu-debug-filter-btn[data-filter-type="error"] .indicator { color: var(--acu-error-text) !important; }\n    \n    /* 操作按钮组 */\n    .acu-debug-console-dialog .acu-debug-actions {\n        display: flex !important;\n        gap: 8px !important;\n        margin-top: 8px !important;\n    }\n    \n    @media (min-width: 768px) {\n        .acu-debug-console-dialog .acu-debug-actions {\n            margin-top: 0 !important;\n            margin-left: auto !important;\n        }\n    }\n    \n    .acu-debug-console-dialog .acu-debug-action-btn {\n        flex: 1 !important;\n        padding: 10px 12px !important;\n        border-radius: 10px !important;\n        font-size: 12px !important;\n        font-weight: 600 !important;\n        border: 1px solid var(--acu-border) !important;\n        background: var(--acu-btn-bg) !important;\n        color: var(--acu-text-main) !important;\n        cursor: pointer !important;\n        transition: all 0.2s ease !important;\n        display: flex !important;\n        align-items: center !important;\n        justify-content: center !important;\n        gap: 6px !important;\n    }\n    \n    @media (min-width: 768px) {\n        .acu-debug-console-dialog .acu-debug-action-btn {\n            flex: none !important;\n            padding: 8px 14px !important;\n        }\n    }\n    \n    .acu-debug-console-dialog .acu-debug-action-btn:hover {\n        background: var(--acu-btn-hover) !important;\n        border-color: var(--acu-accent) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-action-btn:active {\n        transform: scale(0.95) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-action-btn.primary {\n        background: var(--acu-accent) !important;\n        color: var(--acu-button-text-on-accent, #fff) !important;\n        border-color: var(--acu-accent) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-action-btn.danger {\n        color: var(--acu-error-text) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-action-btn.danger:hover {\n        background: var(--acu-error-bg) !important;\n        border-color: var(--acu-error-text) !important;\n    }\n    \n    /* 日志滚动区域 */\n    .acu-debug-console-dialog .acu-debug-log-scroll {\n        flex: 1 !important;\n        overflow-y: auto !important;\n        overflow-x: hidden !important;\n        background: var(--acu-card-bg) !important;\n        -webkit-overflow-scrolling: touch !important;\n    }\n    \n    /* 日志容器 */\n    .acu-debug-console-dialog .acu-debug-log-container {\n        padding: 0 !important;\n    }\n    \n    /* 单条日志项 - 移动端优化 */\n    .acu-debug-console-dialog .acu-debug-log-item {\n        padding: 12px 16px !important;\n        border-bottom: 1px solid var(--acu-border) !important;\n        font-family: 'SF Mono', 'Menlo', 'Monaco', 'Consolas', monospace !important;\n        font-size: 12px !important;\n        line-height: 1.6 !important;\n        transition: background 0.15s ease !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-item:hover {\n        background: var(--acu-table-hover) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-item:active {\n        background: var(--acu-btn-hover) !important;\n    }\n    \n    /* 日志头部 - 移动端垂直布局 */\n    .acu-debug-console-dialog .acu-debug-log-header {\n        display: flex !important;\n        flex-wrap: wrap !important;\n        align-items: center !important;\n        gap: 8px !important;\n        margin-bottom: 6px !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-time {\n        font-size: 10px !important;\n        color: var(--acu-text-sub) !important;\n        opacity: 0.8 !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-type {\n        font-size: 10px !important;\n        font-weight: 700 !important;\n        text-transform: uppercase !important;\n        padding: 2px 8px !important;\n        border-radius: 4px !important;\n        letter-spacing: 0.5px !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-type.log {\n        background: var(--acu-badge-bg) !important;\n        color: var(--acu-text-sub) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-type.info {\n        background: var(--acu-hl-diff-bg) !important;\n        color: var(--acu-hl-diff) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-type.warn {\n        background: var(--acu-warning-bg) !important;\n        color: var(--acu-warning-text) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-log-type.error {\n        background: var(--acu-error-bg) !important;\n        color: var(--acu-error-text) !important;\n    }\n    \n    /* 日志内容 */\n    .acu-debug-console-dialog .acu-debug-log-content {\n        color: var(--acu-text-main) !important;\n        word-break: break-word !important;\n        white-space: pre-wrap !important;\n        font-size: 12px !important;\n        line-height: 1.5 !important;\n    }\n    \n    /* 堆栈信息 */\n    .acu-debug-console-dialog .acu-debug-log-stack {\n        margin-top: 8px !important;\n        padding: 10px 12px !important;\n        background: rgba(0, 0, 0, 0.05) !important;\n        border-radius: 8px !important;\n        font-size: 11px !important;\n        color: var(--acu-text-sub) !important;\n        white-space: pre-wrap !important;\n        word-break: break-all !important;\n        border-left: 3px solid var(--acu-error-text) !important;\n    }\n    \n    /* 空状态 */\n    .acu-debug-console-dialog .acu-debug-empty {\n        display: flex !important;\n        flex-direction: column !important;\n        align-items: center !important;\n        justify-content: center !important;\n        padding: 60px 20px !important;\n        color: var(--acu-text-sub) !important;\n        text-align: center !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-empty i {\n        font-size: 48px !important;\n        margin-bottom: 16px !important;\n        opacity: 0.5 !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-empty-text {\n        font-size: 14px !important;\n        margin-bottom: 8px !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-empty-hint {\n        font-size: 12px !important;\n        opacity: 0.7 !important;\n    }\n    \n    /* 底部状态栏 */\n    .acu-debug-console-dialog .acu-debug-footer {\n        padding: 12px 16px !important;\n        border-top: 1px solid var(--acu-border) !important;\n        background: var(--acu-table-head) !important;\n        display: flex !important;\n        align-items: center !important;\n        justify-content: space-between !important;\n        font-size: 12px !important;\n        color: var(--acu-text-sub) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-stats {\n        display: flex !important;\n        align-items: center !important;\n        gap: 12px !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-stat {\n        display: flex !important;\n        align-items: center !important;\n        gap: 4px !important;\n    }\n    \n    .acu-debug-console-dialog .acu-debug-stat-value {\n        font-weight: 700 !important;\n        color: var(--acu-accent) !important;\n    }\n    \n    /* 关闭按钮优化 */\n    .acu-debug-console-dialog .acu-close-btn {\n        width: 36px !important;\n        height: 36px !important;\n        border-radius: 50% !important;\n        display: flex !important;\n        align-items: center !important;\n        justify-content: center !important;\n        background: var(--acu-btn-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        color: var(--acu-text-sub) !important;\n        transition: all 0.2s ease !important;\n        cursor: pointer !important;\n    }\n    \n    .acu-debug-console-dialog .acu-close-btn:hover {\n        background: var(--acu-error-bg) !important;\n        color: var(--acu-error-text) !important;\n        border-color: var(--acu-error-text) !important;\n        transform: rotate(90deg) !important;\n    }\n    \n    /* Toggle 开关美化 */\n    .acu-debug-console-dialog .acu-toggle {\n        position: relative !important;\n        display: inline-block !important;\n        width: 44px !important;\n        height: 24px !important;\n        flex-shrink: 0 !important;\n    }\n    \n    .acu-debug-console-dialog .acu-toggle input {\n        opacity: 0 !important;\n        width: 0 !important;\n        height: 0 !important;\n    }\n    \n    .acu-debug-console-dialog .acu-toggle-slider {\n        position: absolute !important;\n        cursor: pointer !important;\n        top: 0 !important;\n        left: 0 !important;\n        right: 0 !important;\n        bottom: 0 !important;\n        background: var(--acu-btn-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 24px !important;\n        transition: all 0.3s ease !important;\n    }\n    \n    .acu-debug-console-dialog .acu-toggle-slider::before {\n        position: absolute !important;\n        content: "" !important;\n        height: 18px !important;\n        width: 18px !important;\n        left: 2px !important;\n        bottom: 2px !important;\n        background: var(--acu-text-sub) !important;\n        border-radius: 50% !important;\n        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-toggle input:checked + .acu-toggle-slider {\n        background: var(--acu-accent) !important;\n        border-color: var(--acu-accent) !important;\n    }\n    \n    .acu-debug-console-dialog .acu-toggle input:checked + .acu-toggle-slider::before {\n        transform: translateX(20px) !important;\n        background: var(--acu-button-text-on-accent, #fff) !important;\n    }\n/* ========== 效果输入区域样式 ========== */\n    .acu-effect-inputs-area {\n        margin-top: 10px;\n        padding-top: 10px;\n        border-top: 1px dashed var(--acu-border);\n    }\n    .acu-effect-input-group {\n        display: flex;\n        flex-direction: column;\n        gap: 4px;\n        margin-bottom: 6px;\n    }\n    .acu-effect-input-label {\n        font-size: 11px;\n        color: var(--acu-text-sub);\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n    }\n    .acu-effect-preview-text {\n        font-size: 10px;\n        color: var(--acu-text-sub);\n        opacity: 0.8;\n        margin-top: 2px;\n        text-align: right;\n    }\n    .acu-effect-preview-text span {\n        margin-left: 8px;\n    }\n    .acu-effect-preview-text span.positive { color: var(--acu-success-text); }\n    .acu-effect-preview-text span.negative { color: var(--acu-failure-text); }\n</style>`;$('head').append(n)},pa=()=>{const t=le().getDB();if(!t||!t.exportTableAsJson)return console.warn('[DICE]数据库 API 不可用，无法获取表格数据'),null;try{const n=t.exportTableAsJson();if(n){const t=Object.keys(n).filter(t=>t.startsWith('sheet_')).length;console.info(`[DICE]已加载表格数据，包含 ${t} 个工作表`)}return n}catch(t){return console.error('[DICE]获取表格数据失败:',t),null}},fa=()=>{const t=window.SillyTavern||window.parent?.SillyTavern,n=t?.chat;return Array.isArray(n)?n:null},ga=t=>{if(!t)return null;if('string'==typeof t){try{const n=JSON.parse(t);if(n&&'object'==typeof n)return n}catch{return null}return null}return'object'==typeof t?t:null},ma=t=>!(!t||'object'!=typeof t)&&Object.keys(t).some(t=>t.startsWith('sheet_')),ba=t=>{if(ma(t.TavernDB_ACU_IndependentData))return!0;if(ma(t.TavernDB_ACU_Data))return!0;if(ma(t.TavernDB_ACU_SummaryData))return!0;const n=ga(t.TavernDB_ACU_IsolatedData);return!!n&&Object.values(n).some(t=>{if(!t||'object'!=typeof t)return!1;const n=t.independentData;return ma(n)})},ha=(t=!1)=>{const n=fa();if(!n)return-1;for(let e=n.length-1;e>=0;e--){const a=n[e];if((t||!a?.is_user)&&ba(a))return e}return-1},va=async t=>{if(t<0)return;const n=fa();if(!n||t>=n.length)return;const e=ha(!0);if(e<0||e===t)return;const a=n[e],o=n[t];if(!a||!o)return;if(o.is_user&&!ba(o))return;let i=!1;const r=ga(a.TavernDB_ACU_IsolatedData);if(r){const t=ga(o.TavernDB_ACU_IsolatedData)||{},n=((t,n)=>{if('string'==typeof t?.TavernDB_ACU_Identity){const e=t.TavernDB_ACU_Identity;if(n&&Object.prototype.hasOwnProperty.call(n,e))return e}if(n&&Object.prototype.hasOwnProperty.call(n,''))return'';if(n){const t=Object.keys(n);if(1===t.length)return t[0]}return null})(a,r);if(null!==n){if(Object.prototype.hasOwnProperty.call(r,n)){t[n]=r[n];const e={...r};delete e[n],Object.keys(e).length>0?a.TavernDB_ACU_IsolatedData=e:delete a.TavernDB_ACU_IsolatedData,o.TavernDB_ACU_IsolatedData=t,i=!0}}else o.TavernDB_ACU_IsolatedData=r,delete a.TavernDB_ACU_IsolatedData,i=!0}void 0!==a.TavernDB_ACU_Identity&&(o.TavernDB_ACU_Identity=a.TavernDB_ACU_Identity,delete a.TavernDB_ACU_Identity,i=!0),void 0!==a.TavernDB_ACU_IndependentData&&(o.TavernDB_ACU_IndependentData=a.TavernDB_ACU_IndependentData,delete a.TavernDB_ACU_IndependentData,i=!0),void 0!==a.TavernDB_ACU_ModifiedKeys&&(o.TavernDB_ACU_ModifiedKeys=a.TavernDB_ACU_ModifiedKeys,delete a.TavernDB_ACU_ModifiedKeys,i=!0),void 0!==a.TavernDB_ACU_UpdateGroupKeys&&(o.TavernDB_ACU_UpdateGroupKeys=a.TavernDB_ACU_UpdateGroupKeys,delete a.TavernDB_ACU_UpdateGroupKeys,i=!0),void 0!==a.TavernDB_ACU_Data&&(o.TavernDB_ACU_Data=a.TavernDB_ACU_Data,delete a.TavernDB_ACU_Data,i=!0),void 0!==a.TavernDB_ACU_SummaryData&&(o.TavernDB_ACU_SummaryData=a.TavernDB_ACU_SummaryData,delete a.TavernDB_ACU_SummaryData,i=!0),i&&await triggerSlash('savechat')},xa=async(t,n=!1,e=!1)=>{if(Fn)return void console.warn('[DICE]保存操作正在进行中，跳过重复请求');console.info('[DICE]开始保存数据到数据库...'),Fn=!0;const{$}=le(),a=$('#acu-btn-save-global');!n&&a.length&&(a.find('i').removeClass('fa-save').addClass('fa-spinner fa-spin'),a.prop('disabled',!0));try{const a={};if(t.mate?a.mate=t.mate:a.mate={type:'chatSheets',version:1},Object.keys(t).forEach(n=>{n.startsWith('sheet_')&&(a[n]=t[n])}),e){const t=Hn();Object.keys(t).forEach(n=>{a[n]&&a[n].content&&t[n].sort((t,n)=>n-t).forEach(t=>{a[n].content[t+1]&&a[n].content.splice(t+1,1)})})}let o;try{o=JSON.stringify(a);const t=new Blob([o]).size/1048576;if(t>10)throw new Error(`数据太大 (${t.toFixed(2)}MB)，超过 10MB 限制`);console.info(`[DICE]数据序列化完成，大小: ${t.toFixed(2)}MB`)}catch(t){throw console.error('[DICE]ACU JSON 序列化失败:',t),new Error(`数据序列化失败: ${t.message||t}`)}const i=le().getDB();if(!i||!i.importTableAsJson)throw new Error('数据库 API 不可用');const r=ha();try{if(!1===await i.importTableAsJson(o))throw new Error('数据导入失败（返回 false）');await va(r),console.info('[DICE]数据已成功保存到数据库')}catch(t){console.error('[DICE]ACU API 保存失败:',t);const n=t.message||String(t);if(n.includes('Settings could not be saved')||n.includes('server connection')||n.includes('data loss'))throw new Error('保存失败：服务器连接问题或数据过大，请检查网络连接或减少数据量');throw new Error(`保存到数据库失败: ${n}`)}Yn=a,_e(a),Wn=!1,Ln=new Set,window.acuModifiedSet&&window.acuModifiedSet.clear(),console.info('[DICE]本地状态已更新，未保存更改已清除'),n||mo()}catch(t){const n=t.message||'保存出错，请检查数据格式和大小';throw console.error('[DICE]保存数据失败:',{error:t,message:n,stack:t.stack}),window.toastr?window.toastr.error(n,'保存失败',{timeOut:5e3}):alert(`保存失败: ${n}`),t}finally{Fn=!1,console.info('[DICE]保存操作完成'),!n&&a.length&&(a.find('i').removeClass('fa-spinner fa-spin').addClass('fa-save'),a.prop('disabled',!1))}},wa=async(t,n)=>{try{const n={};let e;t.mate?n.mate=t.mate:n.mate={type:'chatSheets',version:1},Object.keys(t).forEach(e=>{e.startsWith('sheet_')&&(n[e]=t[e])});try{e=JSON.stringify(n);const t=new Blob([e]).size/1048576;if(t>10)throw new Error(`数据太大 (${t.toFixed(2)}MB)，超过 10MB 限制`)}catch(t){throw console.error('[DICE]ACU JSON 序列化失败:',t),new Error(`数据序列化失败: ${t.message||t}`)}const a=le().getDB();if(!a||!a.importTableAsJson)throw new Error('数据库 API 不可用');const o=ha();try{if(!1===await a.importTableAsJson(e))throw new Error('数据导入失败（返回 false）');await va(o)}catch(t){console.error('[DICE]ACU API 保存失败:',t);const n=t.message||String(t);if(n.includes('Settings could not be saved')||n.includes('server connection')||n.includes('data loss'))throw new Error('保存失败：服务器连接问题或数据过大，请检查网络连接或减少数据量');throw new Error(`保存到数据库失败: ${n}`)}return Yn=n,n}catch(t){throw console.error('[DICE]ACU saveDataOnly error:',t,n?{modifiedSheetKeys:n}:void 0),t}},ya=async t=>{const n=Pn.catch(t=>{console.warn('[DICE]ACU runInSaveQueue previous step failed, continue next task:',t)}).then(t);return Pn=n.then(()=>{}).catch(t=>{console.error('[DICE]ACU runInSaveQueue error:',t)}),n},$a=async(t,n)=>ya(()=>wa(t,n)),ka=async(t,n,e)=>{try{const a=Yn||pa();if(!a||!a[t])throw new Error(`表格 "${t}" 不存在`);if(!a[t].content)throw new Error(`表格 "${t}" 内容为空`);a[t].content[n+1]=e,await $a(a,[t]);const o=ke();o&&o[t]&&o[t].content&&(o[t].content[n+1]=[...e],_e(o))}catch(t){const n=t instanceof Error?t.message:String(t);throw console.error('[DICE]ACU saveRowInstantly error:',t),toastr.error(`保存失败: ${n}`),t}},_a=t=>{const n={};if(!t||'object'!=typeof t)return n;for(const e in t)if(t[e]?.name){const a=t[e];n[a.name]={key:e,headers:a.content&&a.content[0]||[],rows:a.content?a.content.slice(1):[],rawContent:a.content||[],exportConfig:a.exportConfig||{},updateConfig:a.updateConfig||{},...a}}return n};const Ca=()=>{const{$}=le(),t=$('.acu-settings-dialog');if(!t.length)return;const n=t.find('#regex-rules-list');if(!n.length)return;const e=$t.getAllRules().map(t=>{const n='global'===t.scope.type?'fa-globe':'table'===t.scope.type?'fa-table':'fa-columns',e='global'===t.scope.type?'全局':'table'===t.scope.type?t.scope.tableNames?.join(','):`${t.scope.tableNames?.join(',')}.${t.scope.columnNames?.join(',')}`;return`\n          <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${h(t.id)}">\n              <div class="acu-rule-type-icon" title="作用域: ${h(t.scope.type)}">\n                  <i class="fa-solid ${n}"></i>\n              </div>\n              <div class="acu-rule-info">\n                  <div class="acu-rule-name">${h(t.name)}</div>\n                  <div class="acu-rule-target" style="font-size:10px;">${h(e)} | ${h(t.operation)}</div>\n              </div>\n              <button class="acu-rule-edit" data-rule-id="${h(t.id)}" title="编辑此规则" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n              <div class="acu-rule-toggle ${t.enabled?'active':''}" title="点击切换启用/禁用">\n                  <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n              </div>\n              <button class="acu-rule-delete" data-rule-id="${h(t.id)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n          </div>\n      `}).join('');n.html(e)},Ea=(t,n)=>{const{$}=le(),e=`acu-theme-${ca().theme}`,a=Yn||pa(),o=_a(a||{}),i=Object.keys(o),r=!!n,c=r?yt.getRule(n):null,s=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay" ${r?'style="opacity:0;transition:opacity 0.15s ease-in;"':''}>\n        <div class="acu-edit-dialog acu-validation-modal ${e}">\n          <div class="acu-dice-cfg-header">\n            <span><i class="fa-solid ${r?'fa-pen':'fa-plus'}"></i> ${r?'编辑验证规则':'添加自定义验证规则'}</span>\n            <button class="acu-config-close" id="dlg-rule-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-validation-modal-body">\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">规则名称</span></div>\n              <input type="text" id="rule-name" class="acu-panel-input" placeholder="如：物品数量限制" style="flex:1;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">目标表格</span></div>\n              <select id="rule-table" class="acu-setting-select">\n                <option value="">请选择...</option>\n                ${i.map(t=>`<option value="${h(t)}">${h(t)}</option>`).join('')}\n              </select>\n            </div>\n            <div class="acu-setting-row" id="row-column">\n              <div class="acu-setting-info"><span class="acu-setting-label">目标列</span></div>\n              <select id="rule-column" class="acu-setting-select" disabled>\n                <option value="">请先选择表格...</option>\n              </select>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">规则类型</span></div>\n              <select id="rule-type" class="acu-setting-select">\n                <optgroup label="── 表级规则 ──">\n                  <option value="tableReadonly">表级只读（禁止修改）</option>\n                  <option value="rowLimit">行数限制</option>\n                  <option value="sequence">序列递增</option>\n                </optgroup>\n                <optgroup label="── 字段级规则 ──">\n                  <option value="required">必填</option>\n                  <option value="format">格式验证（正则）</option>\n                  <option value="enum">枚举验证（可选值）</option>\n                  <option value="numeric">数值范围</option>\n                  <option value="relation">关联验证（引用其他表）</option>\n                  <option value="keyValue">键值对验证</option>\n                </optgroup>\n              </select>\n            </div>\n            \x3c!-- 表级只读无需配置 --\x3e\n            <div class="acu-rule-config-section" id="config-tableReadonly">\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> 启用后,该表将不允许任何修改\n              </div>\n            </div>\n            \x3c!-- 行数限制配置 --\x3e\n            <div class="acu-rule-config-section" id="config-rowLimit" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">最少行数</span></div>\n                <input type="number" id="cfg-row-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">最多行数</span></div>\n                <input type="number" id="cfg-row-max" class="acu-panel-input" placeholder="不限" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- 序列递增配置 --\x3e\n            <div class="acu-rule-config-section" id="config-sequence" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">编码前缀</span></div>\n                <input type="text" id="cfg-sequence-prefix" class="acu-panel-input" placeholder="如：AM" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">起始数字</span></div>\n                <input type="number" id="cfg-sequence-start" class="acu-panel-input" placeholder="1" value="1" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">配对表（可选）</span></div>\n                <select id="cfg-sequence-paired-table" class="acu-setting-select" style="flex:1;">\n                  <option value="">无（单表修复）</option>\n                  ${i.map(t=>`<option value="${h(t)}">${h(t)}</option>`).join('')}\n                </select>\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> 检查指定列的值是否从"前缀+起始数字"开始严格递增(如AM0001, AM0002, AM0003...),不可跳号或重复。需要指定目标列。<br>\n                <i class="fa-solid fa-link" style="margin-top:4px;display:block;color:var(--acu-warning-icon);margin-right:6px;"></i> 如果设置了配对表,修复时会同时修复两个表的编码,确保相同编码值修复后仍然相同。\n              </div>\n            </div>\n            \x3c!-- 必填无需配置 --\x3e\n            <div class="acu-rule-config-section" id="config-required" style="display:none;">\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> 该字段不能为空\n              </div>\n            </div>\n            \x3c!-- 格式验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-format" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">正则表达式</span></div>\n                <input type="text" id="cfg-pattern" class="acu-panel-input" placeholder="如：^AM\\d{3}$" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- 枚举验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-enum" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">允许的值</span></div>\n                <input type="text" id="cfg-values" class="acu-panel-input" placeholder="用逗号分隔，如：进行中,已完成,已失败" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- 数值范围配置 --\x3e\n            <div class="acu-rule-config-section" id="config-numeric" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">最小值</span></div>\n                <input type="number" id="cfg-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">最大值</span></div>\n                <input type="number" id="cfg-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- 关联验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-relation" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">关联表格</span></div>\n                <select id="cfg-ref-table" class="acu-setting-select">\n                  <option value="">请选择...</option>\n                  ${i.map(t=>`<option value="${h(t)}">${h(t)}</option>`).join('')}\n                </select>\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">关联列</span></div>\n                <select id="cfg-ref-column" class="acu-setting-select" multiple style="flex:1;min-height:80px;">\n                  <option value="">请先选择关联表格...</option>\n                </select>\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> 可选择多列,任一列匹配即通过验证(OR 逻辑)。使用 Ctrl/Cmd 键可选择多个列。\n              </div>\n            </div>\n            \x3c!-- 键值对验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-keyValue" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">值类型</span></div>\n                <select id="cfg-keyvalue-type" class="acu-setting-select">\n                  <option value="text">文本型（只验证格式）</option>\n                  <option value="numeric">数值型（验证格式和数值范围）</option>\n                </select>\n              </div>\n              <div class="acu-setting-row" id="row-keyvalue-range" style="display:none;">\n                <div class="acu-setting-info"><span class="acu-setting-label">最小值</span></div>\n                <input type="number" id="cfg-keyvalue-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">最大值</span></div>\n                <input type="number" id="cfg-keyvalue-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> 格式:键:值;键:值(使用英文标点,自动去除空格)。数值型会验证每个值的范围。\n              </div>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">错误提示</span></div>\n              <input type="text" id="rule-error-msg" class="acu-panel-input" placeholder="验证失败时显示的提示信息" style="flex:1;">\n            </div>\n          </div>\n          <div class="acu-dice-cfg-actions">\n            <button id="dlg-rule-cancel">取消</button>\n            <button id="dlg-rule-save">${r?'保存':'添加'}</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(s);const l=t=>{const n=t.val();n&&''!==n?(t.css('color','var(--acu-text-main)'),t.css('opacity','1')):(t.css('color','var(--acu-text-sub)'),t.css('opacity','0.7'))};s.find('select').each(function(){l($(this)),$(this).on('change',function(){l($(this))})}),s.find('#rule-table').on('change',function(){const t=$(this).val(),n=s.find('#rule-column'),e=s.find('#cfg-sequence-paired-table');if(l($(this)),e.length>0){const n=e.val();e.empty(),e.append('<option value="">无（单表修复）</option>'),i.filter(n=>n!==t).forEach(t=>{e.append(`<option value="${h(t)}">${h(t)}</option>`)}),n&&n!==t&&e.val(n),l(e)}if(!t||!o[t])return n.html('<option value="">请先选择表格...</option>').prop('disabled',!0),void l(n);const a=(o[t].headers||[]).filter((t,n)=>n>0&&t).map(t=>`<option value="${h(t)}">${h(t)}</option>`).join('');n.html('<option value="">请选择...</option>'+a).prop('disabled',!1),l(n)}),s.find('#cfg-ref-table').on('change',function(){const t=$(this).val(),n=s.find('#cfg-ref-column');if(l($(this)),!t||!o[t])return n.html('<option value="">请先选择关联表格...</option>').prop('disabled',!0),void l(n);const e=(o[t].headers||[]).filter((t,n)=>n>0&&t).map(t=>`<option value="${h(t)}">${h(t)}</option>`).join('');n.html(e).prop('disabled',!1),l(n)}),s.find('#rule-type').on('change',function(){const t=$(this).val(),n=pt[t],e='table'===n?.scope;l($(this)),s.find('.acu-rule-config-section').hide(),s.find('#config-'+t).show(),e&&'sequence'!==t?(s.find('#row-column').hide(),s.find('#rule-column').val('').prop('disabled',!0)):(s.find('#row-column').show(),s.find('#rule-table').val()&&s.find('#rule-column').prop('disabled',!1))}),s.find('#cfg-keyvalue-type').on('change',function(){'numeric'===$(this).val()?s.find('#row-keyvalue-range').show():s.find('#row-keyvalue-range').hide()});const d=()=>s.remove();s.on('click','#dlg-rule-close, #dlg-rule-cancel',function(t){t.stopPropagation(),d()}),y(s,'acu-validation-modal-overlay',()=>{d()}),s.find('#dlg-rule-save').on('click',function(){const e=s.find('#rule-name').val()?.trim(),a=s.find('#rule-table').val(),o=s.find('#rule-column').val(),i=s.find('#rule-type').val(),l=s.find('#rule-error-msg').val()?.trim(),u=pt[i],p='table'===u?.scope;if(!e)return void(window.toastr&&window.toastr.warning('请输入规则名称'));if(!a)return void(window.toastr&&window.toastr.warning('请选择目标表格'));if(!(p&&'sequence'!==i||o))return void(window.toastr&&window.toastr.warning('请选择目标列'));const f={};if('tableReadonly'===i);else if('rowLimit'===i){const t=s.find('#cfg-row-min').val(),n=s.find('#cfg-row-max').val();''!==t&&(f.min=parseInt(t,10)),''!==n&&(f.max=parseInt(n,10))}else if('required'===i);else if('format'===i){const t=s.find('#cfg-pattern').val()?.trim();if(!t)return void(window.toastr&&window.toastr.warning('请输入正则表达式'));try{new RegExp(t)}catch(t){return void(window.toastr&&window.toastr.error('正则表达式无效'))}f.pattern=t}else if('enum'===i){const t=s.find('#cfg-values').val()?.trim();if(!t)return void(window.toastr&&window.toastr.warning('请输入允许的值'));f.values=t.split(',').map(t=>t.trim()).filter(t=>t)}else if('numeric'===i){const t=s.find('#cfg-min').val(),n=s.find('#cfg-max').val();''!==t&&(f.min=parseFloat(t)),''!==n&&(f.max=parseFloat(n))}else if('relation'===i){const t=s.find('#cfg-ref-table').val(),n=s.find('#cfg-ref-column').val();if(!t)return void(window.toastr&&window.toastr.warning('请选择关联表格'));const e=Array.isArray(n)?n:n?[n]:[];if(0===e.length||1===e.length&&!e[0])return void(window.toastr&&window.toastr.warning('请至少选择一列作为关联列'));f.refTable=t,f.refColumn=1===e.length?e[0]:e}else if('keyValue'===i){const t=s.find('#cfg-keyvalue-type').val();if(f.valueType=t||'text','numeric'===t){const t=s.find('#cfg-keyvalue-min').val(),n=s.find('#cfg-keyvalue-max').val();''!==t&&(f.valueMin=parseFloat(t)),''!==n&&(f.valueMax=parseFloat(n))}}else if('sequence'===i){const t=s.find('#cfg-sequence-prefix').val()?.trim()||'',n=s.find('#cfg-sequence-start').val(),e=s.find('#cfg-sequence-paired-table').val()?.trim()||null;if(f.prefix=t,f.startFrom=''!==n?parseInt(n,10):1,isNaN(f.startFrom))return void(window.toastr&&window.toastr.warning('起始数字必须是有效数字'));e&&(f.pairedTable=e)}const g=r?n:'custom_'+Date.now()+'_'+Math.random().toString(36).substr(2,6),m={id:g,name:e,description:c?.description||'',targetTable:a,targetColumn:p&&'sequence'!==i?'':o,ruleType:i,config:f,errorMessage:l||u?.desc||'数据验证失败',intercept:c?.intercept??!1,enabled:c?.enabled??!0};let b=!1;if(b=r?yt.updateCustomRule(n,m):yt.addCustomRule(m),b){d(),yt.clearCache();const c=t.find('#validation-rules-list');if(r){const t=c.find(`.acu-validation-rule-item[data-rule-id="${h(n)}"]`);if(t.length){const n=m.enabled;t.find('.acu-rule-name').text(e),t.find('.acu-rule-target').text(`${a}${p&&'sequence'!==i?' (整表)':'.'+o}`),t.find('.acu-rule-type-icon').attr('title',`${u?.name||i}${p?' (表级)':''}`).find('i').attr('class',`fa-solid ${u?.icon||'fa-question'}`),t.toggleClass('disabled',!n)}}else{const t=`\n          <div class="acu-validation-rule-item" data-rule-id="${h(g)}">\n            <div class="acu-rule-type-icon" title="${h(u?.name||i)}${p?' (表级)':''}">\n              <i class="fa-solid ${u?.icon||'fa-question'}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${h(e)}</div>\n              <div class="acu-rule-target">${h(a)}${p&&'sequence'!==i?' (整表)':'.'+h(o)}</div>\n            </div>\n            <div class="acu-rule-intercept" data-rule-id="${h(g)}" title="点击启用拦截（违反时回滚）"><i class="fa-solid fa-shield-halved"></i></div>\n            <button class="acu-rule-edit" data-rule-id="${h(g)}" title="编辑此规则" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n            <div class="acu-rule-toggle active" title="点击切换启用/禁用">\n              <i class="fa-solid fa-toggle-on"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${h(g)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n          </div>\n        `;c.append(t)}}else window.toastr&&window.toastr.error(r?'规则更新失败':'规则添加失败')}),r&&c&&(s.find('#rule-name').val(c.name||''),s.find('#rule-error-msg').val(c.errorMessage||''),s.find('#rule-table').val(c.targetTable||'').trigger('change'),s.find('#rule-type').val(c.ruleType||'required').trigger('change'),setTimeout(()=>{c.targetColumn&&(s.find('#rule-column').val(c.targetColumn),l(s.find('#rule-column')));const t=c.config||{},n=c.ruleType;if('rowLimit'===n)void 0!==t.min&&s.find('#cfg-row-min').val(t.min),void 0!==t.max&&s.find('#cfg-row-max').val(t.max);else if('sequence'===n)s.find('#cfg-sequence-prefix').val(t.prefix||''),s.find('#cfg-sequence-start').val(t.startFrom??1),t.pairedTable&&(s.find('#cfg-sequence-paired-table').val(t.pairedTable),l(s.find('#cfg-sequence-paired-table')));else if('format'===n)s.find('#cfg-pattern').val(t.pattern||'');else if('enum'===n)s.find('#cfg-values').val((t.values||[]).join(','));else if('numeric'===n)void 0!==t.min&&s.find('#cfg-min').val(t.min),void 0!==t.max&&s.find('#cfg-max').val(t.max);else if('relation'===n){if(t.refTable)return s.find('#cfg-ref-table').val(t.refTable).trigger('change'),void setTimeout(()=>{const n=Array.isArray(t.refColumn)?t.refColumn:t.refColumn?[t.refColumn]:[];s.find('#cfg-ref-column').val(n),l(s.find('#cfg-ref-column')),s.css('opacity','1')},100)}else'keyValue'===n&&(s.find('#cfg-keyvalue-type').val(t.valueType||'text').trigger('change'),void 0!==t.valueMin&&s.find('#cfg-keyvalue-min').val(t.valueMin),void 0!==t.valueMax&&s.find('#cfg-keyvalue-max').val(t.valueMax));s.css('opacity','1')},100))},Aa=t=>{if(!t||!t.rule)return void(window.toastr&&window.toastr.warning('无法获取规则信息'));const{$}=le(),n=`acu-theme-${ca().theme}`,e=t.rule,a=t.ruleType||e.ruleType,o=pt[a]||{name:a,icon:'fa-question'},i='table'===o?.scope,r=Yn||pa(),c=ke();if(!t.rowTitle&&t.rowIndex>=0&&r&&t.tableName)for(const n in r)if(r[n]?.name===t.tableName){const e=r[n].content?.[t.rowIndex+1];e&&(t.rowTitle=e[1]||e[0]||`行 ${t.rowIndex+1}`);break}let s='';if(!i&&c&&t.tableName&&void 0!==t.columnName)for(const n in c)if(c[n]?.name===t.tableName){const e=(c[n].content?.[0]||[]).indexOf(t.columnName),a=t.rowIndex+1;e>=0&&c[n].content?.[a]&&(s=c[n].content[a][e]??'');break}const l=''!==s&&String(s)!==String(t.currentValue||'');if(i)return void Ma(t,e,a,r,c,n);let d='';d=('enum'===a&&e.config?.values||'relation'===a&&e.config?.refTable&&e.config?.refColumn||'numeric'===a||'format'===a&&e.config,`<textarea id="smart-fix-value" class="acu-edit-textarea" spellcheck="false"\n        style="width:100%;min-height:60px;max-height:200px;resize:none;">${h(t.currentValue||'')}</textarea>`);let u='';if('required'===a){const n=function(t,n,e,a,o=5){const i=new Set;if(!t||!n||!a)return[];for(const o in a)if(a[o]?.name===t){const t=a[o].content?.[0]||[],r=a[o].content?.slice(1)||[],c=t.indexOf(n);c>=0&&r.forEach((t,n)=>{if(n!==e){const n=t?.[c];null!=n&&''!==String(n).trim()&&i.add(String(n).trim())}});break}return Array.from(i).slice(0,o)}(t.tableName,t.columnName,t.rowIndex,r,5);n.length>0&&(u=`\n          <div class="acu-smart-fix-suggest">\n            <div class="acu-smart-fix-suggest-label">\n              <i class="fa-solid fa-lightbulb"></i> 同列示例值:\n            </div>\n            <div class="acu-smart-fix-suggest-options">\n              ${n.map(t=>`\n                <span class="acu-smart-fix-option" data-value="${h(t)}" title="点击填充">\n                  ${h(t.length>20?t.substring(0,20)+'...':t)}\n                </span>\n              `).join('')}\n            </div>\n          </div>\n        `)}else if('enum'===a&&e.config?.values){u=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-list"></i> 允许的值 (点击选择):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll">\n            ${e.config.values.map(n=>`\n              <span class="acu-smart-fix-option ${t.currentValue===n?'acu-smart-fix-option-current':''}"\n                    data-value="${h(n)}" title="${t.currentValue===n?'当前值（无效）':'点击选择'}">\n                ${h(n)}\n              </span>\n            `).join('')}\n          </div>\n        </div>\n      `}else if('format'===a&&e.config?.pattern){let n=null;if(r&&t.tableName)for(const e in r)if(r[e]?.name===t.tableName){n=r[e];break}const a=function(t,n,e=[],a=null){if(!t||void 0===n||n<0)return null;try{const e=t.match(/^\^?([A-Za-z]+)\\d\{(\d+)\}\$?$/);if(e){const t=e[1],o=parseInt(e[2],10);if(a&&('总结表'===a.name||'总体大纲'===a.name)){const n=a.content?.[0]||[],e=a.content?.slice(1)||[],i=n.indexOf('编码索引');if(i>=0){const n=[];e.forEach(e=>{const a=e?.[i];if(a&&'string'==typeof a){const e=a.match(new RegExp(`^${t}(\\d+)$`));if(e){const t=parseInt(e[1],10);isNaN(t)||n.push(t)}}});const a=n.length>0?Math.max(...n):0,r=String(a+1).padStart(o,'0');return t+r}}const i=String(n+1).padStart(o,'0');return t+i}const o=t.match(/^\^?\\d\{(\d+)\}\$?$/);if(o){const t=parseInt(o[1],10);return String(n+1).padStart(t,'0')}}catch(t){console.error('[DICE]ACU 格式推算失败:',t)}return null}(e.config.pattern,t.rowIndex,[],n);u=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-font"></i> 格式要求: <code>${h(e.config.pattern)}</code>\n          </div>\n          ${a?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-suggest-label" style="margin-bottom:4px;display:block;">\n                <i class="fa-solid fa-lightbulb"></i> 推荐值:\n              </span>\n              <span class="acu-smart-fix-quick-btn" data-value="${h(a)}">\n                <i class="fa-solid fa-magic"></i> ${h(a)}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('numeric'===a){const n=e.config?.min,a=e.config?.max,o=parseFloat(t.currentValue),i=!isNaN(o)&&(void 0!==n&&o<n||void 0!==a&&o>a),r=i?function(t,n,e){const a=parseFloat(t);return isNaN(a)?void 0!==n?n:0:void 0!==n&&a<n?n:void 0!==e&&a>e?e:a}(t.currentValue,n,a):null;u=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-hashtag"></i> 允许范围: ${void 0!==n?n:'-∞'} ~ ${void 0!==a?a:'+∞'}\n          </div>\n          ${i&&null!==r?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${r}">\n                <i class="fa-solid fa-arrow-right"></i> 修正为 ${r}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('relation'===a&&e.config?.refTable&&e.config?.refColumn){const n=function(t,n,e){const a=new Set;if(!t||!n||!e)return Array.from(a);const o=Array.isArray(n)?n:[n];for(const n in e)if(e[n]?.name===t){const t=e[n].content?.[0]||[],i=e[n].content?.slice(1)||[];o.forEach(n=>{const e=t.indexOf(n);e>=0&&i.forEach(t=>{const n=t?.[e];null!=n&&''!==String(n).trim()&&a.add(String(n).trim())})});break}return Array.from(a).sort()}(e.config.refTable,e.config.refColumn,r),a=Array.isArray(e.config.refColumn)?e.config.refColumn:[e.config.refColumn],o=a.length>1,i=String(t.currentValue||'').trim(),c=function(t,n,e,a){if(!(t&&n&&e&&a))return!1;if(''===String(t).trim())return!1;const o=Array.isArray(e)?e:[e],i=String(t).trim();for(const t in a)if(a[t]?.name===n){const n=a[t].content?.[0]||[],e=a[t].content?.slice(1)||[];for(const t of o){const a=n.indexOf(t);if(-1!==a)for(let t=0;t<e.length;t++){const n=e[t]?.[a];if(null!=n&&String(n).trim()===i)return!0}}break}return!1}(i,e.config.refTable,e.config.refColumn,r);let s='';n.length>0&&(s=`\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-link"></i> 关联表 "${h(e.config.refTable)}" 可用值 (${n.length}项):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll" id="smart-fix-options-container">\n            ${n.map(n=>`\n              <span class="acu-smart-fix-option ${t.currentValue===n?'acu-smart-fix-option-current':''}"\n                    data-value="${h(n)}" title="${t.currentValue===n?'当前值（无效）':'点击选择'}">\n                ${h(n)}\n              </span>\n            `).join('')}\n          </div>\n        `);let l='';i&&!c&&(l=o?`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--acu-border);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> 反向写入到关联表:\n              </div>\n              <div style="margin-top:8px;">\n                <select id="smart-fix-reverse-column" class="acu-edit-select" style="width:100%;margin-bottom:8px;">\n                  ${a.map(t=>`<option value="${h(t)}">${h(t)}</option>`).join('')}\n                </select>\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> 将 "${h(i.length>30?i.substring(0,30)+'...':i)}" 写入到 "${h(e.config.refTable)}"\n                </button>\n              </div>\n            </div>\n          `:`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--acu-border);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> 反向写入到关联表:\n              </div>\n              <div style="margin-top:8px;">\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" data-column="${h(a[0])}" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> 将 "${h(i.length>30?i.substring(0,30)+'...':i)}" 写入到 "${h(e.config.refTable)}.${h(a[0])}"\n                </button>\n              </div>\n            </div>\n          `),(s||l)&&(u=`\n          <div class="acu-smart-fix-suggest">\n            ${s}\n            ${l}\n          </div>\n        `)}else if('keyValue'===a){const n=e.config?.valueType||'text',a=e.config?.valueMin,o=e.config?.valueMax;let i=String(t.currentValue||'');i=i.replace(/：/g,':').replace(/；/g,';').replace(/，/g,';').replace(/\s+/g,'');const r=i.split(';').filter(t=>t.trim()),c=[],s=[];for(const t of r){const e=t.indexOf(':');if(-1===e||0===e||e===t.length-1){c.push({pair:t,error:'格式错误：缺少冒号或键/值为空'});continue}const i=t.substring(0,e),r=t.substring(e+1);if(!i||!r){c.push({pair:t,error:'键或值不能为空'});continue}let l=r,d=!1;if('numeric'===n){const n=parseFloat(r);isNaN(n)?(c.push({pair:t,error:`"${r}" 不是有效数字`}),d=!0):null!=a&&n<a?(l=String(a),c.push({pair:t,error:`数值 ${n} 小于最小值 ${a}`}),d=!0):null!=o&&n>o&&(l=String(o),c.push({pair:t,error:`数值 ${n} 大于最大值 ${o}`}),d=!0)}s.push({key:i,val:l,originalVal:r,hasIssue:d})}const l=s.map(t=>`${t.key}:${t.val}`).join(';'),d=c.length>0||s.some(t=>t.hasIssue);let p='';d&&(p=`\n          <div class="acu-smart-fix-suggest-label" style="margin-bottom:8px;">\n            <i class="fa-solid fa-exclamation-triangle"></i> 问题列表:\n          </div>\n          <div style="margin-bottom:8px;">\n            ${c.map(t=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">❌</span> ${h(t.pair)} - ${h(t.error)}\n              </div>\n            `).join('')}\n            ${s.filter(t=>t.hasIssue).map(t=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">⚠️</span> ${h(t.key)}:${h(t.originalVal)} → ${h(t.val)}\n              </div>\n            `).join('')}\n          </div>\n        `),u=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-key"></i> 格式要求: 键:值;键:值（使用英文标点，自动去除空格）\n          </div>\n          ${'numeric'===n?`\n            <div class="acu-smart-fix-suggest-label" style="margin-top:8px;">\n              <i class="fa-solid fa-hashtag"></i> 数值范围: ${void 0!==a?a:'-∞'} ~ ${void 0!==o?o:'+∞'}\n            </div>\n          `:''}\n          ${p}\n          ${d?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${h(l)}">\n                <i class="fa-solid fa-magic"></i> 一键修正所有问题\n              </span>\n            </div>\n            <div style="margin-top:8px;padding:8px;background:var(--acu-card-bg);border-radius:4px;font-size:11px;color:var(--acu-text-sub);">\n              <div style="margin-bottom:4px;"><strong>修正后预览:</strong></div>\n              <code style="color:var(--acu-success-text);">${h(l)}</code>\n            </div>\n          `:'\n            <div style="margin-top:8px;padding:8px;background:var(--acu-success-bg);border-radius:4px;font-size:11px;color:var(--acu-success-text);">\n              <i class="fa-solid fa-check-circle"></i> 格式正确\n            </div>\n          '}\n        </div>\n      `}const p=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${n}" style="max-width:450px;">\n          <div class="acu-edit-title">智能修改: ${h(t.tableName||'')} - ${h(t.columnName||'')}</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            \x3c!-- 规则说明 --\x3e\n            <div class="acu-smart-fix-rule-info">\n              <div class="acu-smart-fix-rule-header">\n                <i class="fa-solid ${o.icon}"></i>\n                <span>${h(t.ruleName||e.name||'')}</span>\n              </div>\n              <div class="acu-smart-fix-rule-desc">${h(t.errorMessage||e.errorMessage||o.desc||'')}</div>\n            </div>\n\n            \x3c!-- 快照值（只读） --\x3e\n            ${l?`\n              <div class="acu-diff-section acu-diff-old-section">\n                <div class="acu-diff-label">\n                  <i class="fa-solid fa-clock-rotate-left"></i> 快照值（原始）\n                </div>\n                <div class="acu-diff-readonly">${h(s)}</div>\n              </div>\n              <div class="acu-diff-arrow-down"><i class="fa-solid fa-arrow-down"></i></div>\n            `:''}\n\n            \x3c!-- 当前值（可编辑） --\x3e\n            <div class="acu-diff-section acu-diff-new-section">\n              ${t.rowTitle&&t.rowIndex>=0?`<div style="font-size:12px;color:var(--acu-text-sub);margin-bottom:8px;padding:4px 8px;background:var(--acu-bg-sub);border-radius:4px;">\n                <i class="fa-solid fa-tag" style="margin-right:4px;"></i>${h(t.rowTitle)}\n              </div>`:''}\n              <div class="acu-diff-label">\n                <i class="fa-solid fa-pen"></i> 当前值（可编辑）\n              </div>\n              ${d}\n            </div>\n\n            \x3c!-- 智能建议 --\x3e\n            ${u?`\n              <div class="acu-smart-fix-suggest-section">\n                ${u}\n              </div>\n            `:''}\n          </div>\n          <div class="acu-dialog-btns">\n            <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n            ${l?'<button class="acu-dialog-btn acu-btn-revert" id="smart-fix-revert"><i class="fa-solid fa-rotate-left"></i> 恢复快照值</button>':''}\n            <button class="acu-dialog-btn acu-btn-clear" id="smart-fix-clear"><i class="fa-solid fa-eraser"></i> 清空当前值</button>\n            <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-confirm"><i class="fa-solid fa-check"></i> 保存</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(p),p.on('click','.acu-smart-fix-option, .acu-smart-fix-quick-btn',function(){if('smart-fix-reverse-write-btn'===$(this).attr('id'))return;if($(this).hasClass('acu-smart-fix-option-current'))return;const t=$(this).data('value')||$(this).text().trim();p.find('#smart-fix-value').val(t).trigger('input')}),p.on('click','#smart-fix-reverse-write-btn',async function(){const n=String(t.currentValue||'').trim();if(!n)return void(window.toastr&&window.toastr.warning('无法写入空值'));let o;if('relation'===a&&e.config?.refColumn){{const t=Array.isArray(e.config.refColumn)?e.config.refColumn:[e.config.refColumn];o=t.length>1?p.find('#smart-fix-reverse-column').val():$(this).data('column')||t[0]}if(o&&e.config?.refTable)try{const t=Yn||pa();let a=null,i=null;for(const n in t)if(t[n]?.name===e.config.refTable){a=t[n],i=n;break}if(!a||!a.content)return void(window.toastr&&window.toastr.error(`找不到关联表 "${e.config.refTable}"`));const r=a.content[0]||[],c=r.indexOf(o);if(-1===c)return void(window.toastr&&window.toastr.error(`关联表中不存在列 "${o}"`));const s=new Array(r.length).fill('');s[c]=n,a.content.push(s),await xa(t,!1,!1),f(),mo()}catch(t){console.error('[DICE]ACU 反向写入失败:',t),window.toastr&&window.toastr.error('反向写入失败: '+(t.message||'未知错误'))}else window.toastr&&window.toastr.error('无法确定目标表或列')}else window.toastr&&window.toastr.error('无法确定目标列')}),p.on('click','#smart-fix-revert',function(){p.find('#smart-fix-value').val(s)}),p.on('click','#smart-fix-clear',function(){p.find('#smart-fix-value').val('').trigger('input')});const f=()=>p.remove();p.on('click','#smart-fix-close, #smart-fix-cancel',f),y(p,'acu-validation-modal-overlay',f),p.find('#smart-fix-confirm').on('click',async function(){const n=p.find('#smart-fix-value').val()?.trim()||'';if(''!==n||'required'!==a)try{const e=Yn||pa();let a=!1;for(const o in e)if(e[o]?.name===t.tableName){const i=e[o],r=i.content?.[0]||[];if(t.rowIndex>=0&&t.columnName){const e=r.indexOf(t.columnName),o=t.rowIndex+1;if(e>=0&&i.content&&i.content[o]){i.content[o][e]=n,a=!0;break}}}a?(await xa(e,!1,!1),f(),mo()):window.toastr&&window.toastr.error('无法找到目标单元格')}catch(t){console.error('[DICE]ACU 更新单元格失败:',t),window.toastr&&window.toastr.error('更新失败: '+(t.message||'未知错误'))}else window.toastr&&window.toastr.warning('必填字段不能为空')})};function Sa(t,n,e){if(!t||!t.content||t.content.length<2)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const a=t.content[0]||[],o=t.content.slice(1)||[],i=a.indexOf(n);if(i<0)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const r=new Map,c=new Set,s=new Map;for(let t=0;t<o.length;t++){const n=o[t]?.[i];if(null==n||''===n)continue;const a=String(n).trim();if(!a)continue;let r=!1;if(e){a.match(new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(r=!0)}else{const t=parseInt(a,10);isNaN(t)||(r=!0)}r&&(c.add(a),s.has(a)||s.set(a,[]),s.get(a).push(t))}return{codes:r,allCodes:c,codeToRows:s}}function Ia(t,n,e,a){const o=new Set([...t,...n]),i=[];for(const t of o){let n=null;if(e){const a=t.match(new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));a&&(n=parseInt(a[1],10))}else n=parseInt(t,10);isNaN(n)||i.push({code:t,num:n})}i.sort((t,n)=>t.num-n.num);const r=new Map;for(let t=0;t<i.length;t++){const n=i[t].code,o=e+String(a+t).padStart(4,'0');r.set(n,o)}return r}function Da(t,n,e,a,o,i,r,c,s){if(!t||!e)return{fixedCount1:0,fixedCount2:0};const l=t.content[0]||[],d=t.content.slice(1)||[],u=l.indexOf(o),p=e.content[0]||[],f=e.content.slice(1)||[],g=p.indexOf(o);if(u<0||g<0)return{fixedCount1:0,fixedCount2:0};let m=0,b=0;const h=new Map;for(const[t,n]of i.entries())h.set(n,t);const v=Array.from(i.values()).sort((t,n)=>parseInt(t.replace(r,''),10)-parseInt(n.replace(r,''),10)),x=(t,n)=>{const e=[],a=[];for(let o=0;o<t.length;o++){const i=t[o]?.[n],c=null==i?'':String(i).trim();let s=!1;if(c&&r){c.match(new RegExp(`^${r.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(s=!0)}else if(c){const t=parseInt(c,10);isNaN(t)||(s=!0)}s?e.push({rowIndex:o,oldCode:c,row:t[o]}):a.push({rowIndex:o,row:t[o],prevOldCode:null,nextOldCode:null})}for(const t of a){let n=null,a=null;for(const o of e)if(o.rowIndex<t.rowIndex&&(n=o.oldCode),o.rowIndex>t.rowIndex&&null===a){a=o.oldCode;break}t.prevOldCode=n,t.nextOldCode=a}return{codeRows:e,emptyRows:a}},w=x(d,u),y=x(f,g),k=(t,n,e,a)=>{const o=[],r=new Map;for(const n of t.codeRows)r.set(n.oldCode,n.row);for(const t of v){const a=h.get(t);if(r.has(a)){const n=r.get(a).map(t=>t);n[e]=t,o.push({newCode:t,row:n,isCodeRow:!0})}else{const a=new Array(n.length).fill(null);a[e]=t,o.push({newCode:t,row:a,isCodeRow:!0,isInserted:!0})}}const c=[];let s=0;for(const n of t.emptyRows)if(null===n.prevOldCode&&null!==n.nextOldCode){const t=i.get(n.nextOldCode);for(;s<o.length&&o[s].newCode!==t;)c.push(o[s].row),s++;c.push(n.row)}else null===n.prevOldCode&&null===n.nextOldCode&&c.push(n.row);for(;s<o.length;s++){c.push(o[s].row);const n=o[s].newCode,e=h.get(n);for(const n of t.emptyRows)n.prevOldCode===e&&c.push(n.row)}for(const n of t.emptyRows)null!==n.prevOldCode&&n.nextOldCode;return c},C=k(w,l,u,new Set(w.codeRows.map(t=>t.oldCode))),E=k(y,p,g,new Set(y.codeRows.map(t=>t.oldCode))),A=(t,n,e)=>{let a=0;const o=new Set(t.codeRows.map(t=>t.oldCode)),r=new Set;for(const t of n){const n=t[e];n&&r.add(n)}for(const[t,n]of i.entries())o.has(t)&&t!==n&&a++;for(const t of v){const n=h.get(t);o.has(n)||a++}return a};return m=A(w,C,u),b=A(y,E,g),t.content=[l,...C],e.content=[p,...E],{fixedCount1:m,fixedCount2:b}}const Ma=(t,n,e,a,o,i)=>{const{$}=le();let r='',c='';if('tableReadonly'===e){let n=0,e=[];if(o&&a)for(const i in a)if(a[i]?.name===t.tableName&&o[i]){const t=a[i].content?.slice(1)||[],r=o[i].content?.slice(1)||[];if(t.forEach((t,a)=>{const o=r[a];if(o){for(let i=0;i<t.length;i++)if(String(t[i]||'')!==String(o[i]||'')){e.push(`第${a+1}行: 有修改`),n++;break}}else e.push(`第${a+1}行: 新增`),n++}),r.length>t.length)for(let a=t.length;a<r.length;a++)e.push(`第${a+1}行: 已删除`),n++;break}r=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-lock"></i>\n            <span>表只读保护</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">此表被设置为只读，但检测到有修改。</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            检测到 <strong>${n}</strong> 处修改\n          </div>\n          ${e.length>0?`\n            <div class="acu-smart-fix-change-list">\n              ${e.slice(0,10).map(t=>`<div class="acu-smart-fix-change-item">${h(t)}</div>`).join('')}\n              ${e.length>10?`<div class="acu-smart-fix-change-item">... 还有 ${e.length-10} 处</div>`:''}\n            </div>\n          `:''}\n        </div>\n      `,c='\n        <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n        <button class="acu-dialog-btn acu-btn-revert" id="smart-fix-restore-table"><i class="fa-solid fa-rotate-left"></i> 恢复整表</button>\n      '}else if('rowLimit'===e){const e=n.config?.min,o=n.config?.max;let i=0,s=[];for(const n in a)if(a[n]?.name===t.tableName){i=(a[n].content?.length||1)-1;break}const l=void 0!==o&&i>o,d=void 0!==e&&i<e;if(l)for(let t=o+1;t<=i;t++)s.push(t);r=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-arrows-up-down"></i>\n            <span>行数限制</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${h(t.errorMessage||n.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            当前行数: <strong>${i}</strong> 行\n            ${void 0!==e||void 0!==o?` | 限制: ${void 0!==e?e:0} ~ ${void 0!==o?o:'∞'} 行`:''}\n          </div>\n          ${l&&s.length>0?`\n            <div class="acu-smart-fix-excess-rows">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-trash"></i> 需删除的行 (第 ${s[0]} 行及之后):\n              </div>\n              <div class="acu-smart-fix-change-list">\n                ${s.slice(0,10).map(t=>`<div class="acu-smart-fix-change-item">第 ${t} 行</div>`).join('')}\n                ${s.length>10?`<div class="acu-smart-fix-change-item">... 共 ${s.length} 行</div>`:''}\n              </div>\n            </div>\n          `:''}\n          ${d?`\n            <div class="acu-smart-fix-hint">\n              <i class="fa-solid fa-info-circle"></i> 需要添加 ${e-i} 行才能满足最小行数要求\n            </div>\n          `:''}\n        </div>\n      `,c=l&&s.length>0?`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-delete-rows" data-start="${o}" data-table="${h(t.tableName)}">\n            <i class="fa-solid fa-trash"></i> 删除多余的 ${s.length} 行\n          </button>\n        `:'<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 关闭</button>'}else if('sequence'===e&&n.targetColumn){const e=n.config?.prefix||'',o=void 0!==n.config?.startFrom?n.config?.startFrom:1;let i=null,s=[],l=[];for(const n in a)if(a[n]?.name===t.tableName){i=a[n];break}if(i&&i.content&&i.content.length>1){const t=i.content[0]||[],a=i.content.slice(1)||[],r=Ct.findColumnIndex(t,n.targetColumn);if(r>=0){const t=[];for(let n=0;n<a.length;n++){const o=a[n]?.[r];if(null==o||''===o)continue;const i=String(o).trim();if(!i)continue;let c=null;if(e){const t=i.match(new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));t&&(c=parseInt(t[1],10))}else c=parseInt(i,10);isNaN(c)||t.push({rowIndex:n,value:i,num:c,originalRowIndex:n+2})}t.sort((t,n)=>t.rowIndex-n.rowIndex);const n=new Map,i=[],c=[],d=[];for(let e=0;e<t.length;e++){const a=t[e].num;n.has(a)||n.set(a,[]),n.get(a).push(e)}for(let e=0;e<t.length;e++){const a=o+e,r=t[e].num,s=t[e].originalRowIndex,l=n.get(r)||[];l.length>1&&l[0]===e&&i.push({rowNum:s,value:t[e].value,num:r,expectedNum:a,count:l.length}),r!==a&&(r<a?d.push({rowNum:s,value:t[e].value,num:r,expectedNum:a}):c.push({rowNum:s,value:t[e].value,num:r,expectedNum:a}))}for(let n=0;n<t.length;n++){const a=o+n,r=t[n].num,c=t[n].originalRowIndex,s=t[n].value,d=e+String(a).padStart(4,'0');(r!==a||i.some(t=>t.num===r&&t.rowNum===c))&&l.push({rowNum:c,currentValue:s,fixedValue:d,reason:r<a?'重复或顺序错误':r>a?'跳号':'重复'})}const u=new Set;i.forEach(t=>{u.add(`第${t.rowNum}行: "${t.value}" 重复 (出现${t.count}次)`)}),c.forEach(t=>{u.add(`第${t.rowNum}行: "${t.value}" 应为 "${e}${String(t.expectedNum).padStart(4,'0')}" (跳号)`)}),d.forEach(t=>{u.add(`第${t.rowNum}行: "${t.value}" 应为 "${e}${String(t.expectedNum).padStart(4,'0')}" (顺序错误)`)}),s=Array.from(u)}}if(r=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-sort-numeric-up"></i>\n            <span>序列递增验证</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${h(t.errorMessage||n.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            检测到 <strong>${s.length}</strong> 个问题\n          </div>\n          ${s.length>0?`\n            <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n              ${s.slice(0,20).map(t=>`<div class="acu-smart-fix-change-item">${h(t)}</div>`).join('')}\n              ${s.length>20?`<div class="acu-smart-fix-change-item">... 还有 ${s.length-20} 个问题</div>`:''}\n            </div>\n          `:''}\n          ${l.length>0?`\n            <div class="acu-smart-fix-suggest" style="margin-top:12px;">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-lightbulb"></i> 修复建议:\n              </div>\n              <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n                ${l.slice(0,20).map(t=>`\n                  <div class="acu-smart-fix-change-item">\n                    <span style="color:var(--acu-text-sub);">第${t.rowNum}行:</span>\n                    <span style="color:var(--acu-hl-manual);">${h(t.currentValue)}</span>\n                    <span style="color:var(--acu-text-sub);"> → </span>\n                    <span style="color:var(--acu-hl-auto);">${h(t.fixedValue)}</span>\n                    <span style="color:var(--acu-text-sub);font-size:11px;"> (${h(t.reason)})</span>\n                  </div>\n                `).join('')}\n                ${l.length>20?`<div class="acu-smart-fix-change-item">... 还有 ${l.length-20} 处需要修复</div>`:''}\n              </div>\n            </div>\n          `:''}\n        </div>\n      `,l.length>0){const a=n.config?.pairedTable||('总结表'===t.tableName?'总体大纲':'总体大纲'===t.tableName?'总结表':null),i=a?`data-paired-table="${h(a)}"`:'';c=`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-fix-sequence" data-table="${h(t.tableName)}" data-column="${h(n.targetColumn)}" data-prefix="${h(e)}" data-start="${o}" ${i}>\n            <i class="fa-solid fa-magic"></i> 自动修复 ${l.length} 处\n          </button>\n        `}else c='<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 关闭</button>'}const s=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${i}" style="max-width:450px;">\n          <div class="acu-edit-title">智能修改: ${h(t.tableName||'')} (表级规则)</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            ${r}\n          </div>\n          <div class="acu-dialog-btns">\n            ${c}\n          </div>\n        </div>\n      </div>\n    `);$('body').append(s);const l=()=>s.remove();s.on('click','#smart-fix-cancel',l),y(s,'acu-validation-modal-overlay',l),s.on('click','#smart-fix-restore-table',async function(){if(o)try{for(const n in a)if(a[n]?.name===t.tableName&&o[n]){a[n]=JSON.parse(JSON.stringify(o[n]));break}await xa(a,!1,!1),l(),mo()}catch(t){console.error('[DICE]ACU 恢复表失败:',t),window.toastr&&window.toastr.error('恢复失败: '+(t.message||'未知错误'))}else window.toastr&&window.toastr.warning('无快照数据')}),s.on('click','#smart-fix-fix-sequence',async function(){const t=$(this),n=t.data('table'),e=t.data('column'),o=t.data('prefix')||'',i=parseInt(t.data('start')||'1',10),r=t.data('paired-table')||null;try{t.prop('disabled',!0).html('<i class="fa-solid fa-spinner fa-spin"></i> 修复中...');let c=null,s=null;for(const t in a)if(a[t]?.name===n){c=a[t],s=t;break}if(!c||!c.content||c.content.length<2)return window.toastr&&window.toastr.warning('未找到目标表'),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');const d=c.content[0]||[],u=c.content.slice(1)||[],p=d.indexOf(e);if(p<0)return window.toastr&&window.toastr.warning('未找到目标列'),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');if(r){let n=null,s=null;for(const t in a)if(a[t]?.name===r){n=a[t],s=t;break}if(!n||!n.content||n.content.length<1)return window.toastr&&window.toastr.warning(`未找到配对表: ${r}`),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');const d=n.content[0]||[];if(d.indexOf(e)<0)return window.toastr&&window.toastr.warning(`配对表中未找到目标列: ${e}`),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');const u=Sa(c,e,o),p=Sa(n,e,o),f=Ia(u.allCodes,p.allCodes,o,i),{fixedCount1:g,fixedCount2:m}=Da(c,0,n,0,e,f,o);await xa(a,!1,!1),l(),mo()}else{const t=[];for(let n=0;n<u.length;n++){const e=u[n]?.[p];if(null==e||''===e)continue;const a=String(e).trim();if(!a)continue;let i=null;if(o){const t=a.match(new RegExp(`^${o.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));t&&(i=parseInt(t[1],10))}else i=parseInt(a,10);isNaN(i)||t.push({rowIndex:n,value:a,num:i})}t.sort((t,n)=>t.rowIndex-n.rowIndex);let n=0;for(let e=0;e<t.length;e++){const a=i+e,r=t[e].num,c=t[e].rowIndex;if(r!==a){const t=o+String(a).padStart(4,'0');u[c][p]=t,n++}}await xa(a,!1,!1),l(),mo()}}catch(n){console.error('[DICE]ACU 修复序列递增失败:',n),window.toastr&&window.toastr.error('修复失败: '+(n.message||'未知错误')),t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复')}}),s.on('click','#smart-fix-delete-rows',async function(){const t=parseInt($(this).data('start'),10),n=$(this).data('table');try{for(const e in a)if(a[e]?.name===n){a[e].content=a[e].content.slice(0,t+1);break}await xa(a,!1,!1),l(),mo()}catch(t){console.error('[DICE]ACU 删除行失败:',t),window.toastr&&window.toastr.error('删除失败: '+(t.message||'未知错误'))}})},za=()=>{const{$}=le(),t=ca();$('.acu-blacklist-manager-overlay').remove();ht.getBlacklist();const n=$(`\n      <div class="acu-blacklist-manager-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="max-width: 600px; width: 90%;">\n          <div class="acu-edit-title" style="position: relative;">\n            <i class="fa-solid fa-filter"></i> 变量过滤黑名单管理\n            <button class="acu-close-btn" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--acu-text-main); cursor: pointer; font-size: 18px; z-index: 10;">\n              <i class="fa-solid fa-times"></i>\n            </button>\n          </div>\n          <div class="acu-settings-content" style="flex: 1; overflow-y: auto; padding: 20px;">\n            <div style="margin-bottom: 15px;">\n              <div style="margin-bottom: 8px; font-size: 12px; color: var(--acu-text-sub);">\n                黑名单中的关键词对应的最下层变量名或列名将不会显示快捷骰子图标\n              </div>\n              <textarea id="blacklist-textarea" style="width: 100%; min-height: 120px; max-height: 300px; padding: 10px !important; border: 1px solid var(--acu-border) !important; border-radius: 4px !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-size: 13px !important; box-sizing: border-box !important; resize: vertical; font-family: monospace; line-height: 1.5;" placeholder="输入关键词，用逗号分隔（支持中英文逗号）"></textarea>\n              <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: nowrap;">\n                <input type="text" id="blacklist-input" placeholder="输入关键词..." style="flex: 1; min-width: 0; padding: 8px !important; border: 1px solid var(--acu-border) !important; border-radius: 4px !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-size: 13px !important; box-sizing: border-box !important;">\n                <button id="blacklist-add-btn" style="padding: 8px 16px; background: var(--acu-accent); color: var(--acu-btn-active-text); border: none; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap; flex-shrink: 0;">\n                  <i class="fa-solid fa-plus"></i> 添加\n                </button>\n              </div>\n            </div>\n            <div style="display: flex; gap: 8px; margin-top: 15px;">\n              <button id="blacklist-reset-btn" style="flex: 1; padding: 10px; background: var(--acu-btn-bg); color: var(--acu-text-main); border: 1px solid var(--acu-text-sub); border-radius: 4px; cursor: pointer; font-size: 13px;">\n                <i class="fa-solid fa-undo"></i> 重置为默认\n              </button>\n              <button id="blacklist-close-btn" style="flex: 1; padding: 10px; background: var(--acu-accent); color: var(--acu-btn-active-text); border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">\n                <i class="fa-solid fa-check"></i> 完成\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(n),n.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',background:'rgba(0,0,0,0.6)','z-index':'31300',display:'flex','align-items':'center','justify-content':'center',padding:'20px','box-sizing':'border-box'});const e=()=>{const t=ht.getBlacklist();n.find('#blacklist-textarea').val(t.join('，'))};e(),n.find('#blacklist-textarea').on('input',function(){(()=>{const t=n.find('#blacklist-textarea').val().trim();if(!t)return void ht.setBlacklist([]);const a=t.split(/[，,]/).map(t=>t.trim()).filter(t=>t.length>0),o=[...new Set(a)];ht.setBlacklist(o),o.length!==a.length&&e()})()}),n.find('#blacklist-add-btn').click(function(){const t=n.find('#blacklist-input'),a=t.val().trim();if(!a)return;const o=a.split(/[，,]/).map(t=>t.trim()).filter(t=>t.length>0);if(0===o.length)return;const i=ht.getBlacklist(),r=new Set(i),c=[];o.forEach(t=>{r.has(t)||(i.push(t),r.add(t),c.push(t))}),0!==c.length?(ht.setBlacklist(i),t.val(''),e()):window.toastr&&window.toastr.warning('所有项已存在')}),n.find('#blacklist-input').on('keypress',function(t){13===t.which&&n.find('#blacklist-add-btn').click()}),n.find('#blacklist-reset-btn').click(function(){confirm('确定要重置黑名单为默认值吗？')&&(ht.resetToDefault(),e())});const a=()=>{n.remove(),mo()};n.find('#blacklist-close-btn, .acu-close-btn').click(a),y(n,'acu-blacklist-manager-overlay',a)},Ta=()=>{const{$}=le();$('.acu-edit-overlay').remove(),On('showAttributePresetManager',Ta);const t=ca(),n=Xt.getAllPresets(),e=fe.get(q,null),a=`\n      <div class="acu-preset-item" data-id="__default__">\n        <div class="acu-preset-info">\n          <div class="acu-preset-name">\n            六维属性百分制\n            <span style="font-size: 10px; color: var(--acu-text-sub); margin-left: 6px;">(默认)</span>\n          </div>\n          <div class="acu-preset-desc">使用百分制生成六维基础属性（力量、敏捷、体质、智力、感知、魅力），范围5-95</div>\n          <div class="acu-preset-stats">\n            基础属性: 6 | 特别属性: 0\n          </div>\n        </div>\n<div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n            <label class="acu-toggle" style="margin: 0;">\n              <input type="checkbox" class="acu-preset-toggle" data-id="__default__" ${null===e?'checked':''}>\n              <span class="acu-toggle-slider"></span>\n            </label>\n            <button class="acu-preset-btn acu-preset-copy" data-id="__default__" title="复制为自定义预设"><i class="fa-solid fa-copy"></i></button>\n            <button class="acu-preset-btn acu-preset-export" data-id="__default__" title="导出"><i class="fa-solid fa-download"></i></button>\n          </div>\n        </div>\n    `+n.map(t=>{const n=t.id===e,a=t.builtin;return`\n        <div class="acu-preset-item" data-id="${t.id}">\n          <div class="acu-preset-info">\n            <div class="acu-preset-name">\n              ${h(t.name)}\n              ${a?'<span style="font-size: 10px; color: var(--acu-text-sub); margin-left: 6px;">(内置)</span>':''}\n            </div>\n            ${t.description?`<div class="acu-preset-desc">${h(t.description)}</div>`:''}\n            <div class="acu-preset-stats">\n              基础属性: ${t.baseAttributes.length} | 特别属性: ${t.specialAttributes?.length||0}\n            </div>\n          </div>\n          <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n            <label class="acu-toggle" style="margin: 0;">\n              <input type="checkbox" class="acu-preset-toggle" data-id="${t.id}" ${n?'checked':''}>\n              <span class="acu-toggle-slider"></span>\n            </label>\n            ${a?`<button class="acu-preset-btn acu-preset-copy" data-id="${t.id}" title="复制为自定义预设"><i class="fa-solid fa-copy"></i></button>`:`<button class="acu-preset-btn acu-preset-edit" data-id="${t.id}" title="编辑"><i class="fa-solid fa-pen"></i></button>`}\n            <button class="acu-preset-btn acu-preset-export" data-id="${t.id}" title="导出"><i class="fa-solid fa-download"></i></button>\n            ${a?'':`<button class="acu-preset-btn acu-preset-delete" data-id="${t.id}" title="删除" style="color: var(--acu-error-text);"><i class="fa-solid fa-trash"></i></button>`}\n          </div>\n        </div>\n      `}).join(''),o=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="width: 600px; max-width: 92vw; max-height: 80vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-dice-d20"></i> 自定义属性规则管理\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div id="acu-presets-list">\n              ${a||'<div style="text-align: center; padding: 40px; color: var(--acu-text-sub);">暂无预设</div>'}\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="acu-preset-new" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-plus"></i> 新建预设\n            </button>\n            <button id="acu-preset-import" style="flex: 1; padding: 10px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-file-import"></i> 导入\n            </button>\n            <button id="acu-preset-back" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-arrow-left"></i> 返回\n            </button>\n          </div>\n\n          <input type="file" id="acu-preset-file-input" accept=".json" style="display: none;" />\n        </div>\n      </div>\n    `);$('body').append(o),o.find('.acu-close-btn, #acu-preset-back').on('click',()=>{o.remove(),Vn()}),o.on('change','.acu-preset-toggle',function(){const t=$(this),n=t.data('id');if(t.is(':checked')){const t='__default__'===n?null:n;Xt.setActivePreset(t),o.find('.acu-preset-toggle').each(function(){const t=$(this);t.data('id')!==n&&t.prop('checked',!1)})}else Xt.setActivePreset(null)}),o.on('click','.acu-preset-edit',function(){const t=$(this).data('id');o.remove(),Na(t)}),o.on('click','.acu-preset-export',function(){const t=$(this).data('id');let e,a;if('__default__'===t){const t={format:'acu_attr_preset_v1',version:Q,id:'default_percentile',name:'六维属性百分制',description:'使用百分制生成六维基础属性（力量、敏捷、体质、智力、感知、魅力），范围5-95',baseAttributes:['力量','敏捷','体质','智力','感知','魅力'].map(t=>({name:t,formula:'3d6*5',range:[15,90],modifier:'1d10-5'})),specialAttributes:[]};e=JSON.stringify(t,null,2),a=`acu_preset_六维属性百分制_${Date.now()}.json`}else{if(e=Xt.exportPreset(t),!e)return void(window.toastr&&window.toastr.error('导出失败'));const o=n.find(n=>n.id===t);a=`acu_preset_${o?.name||t}_${Date.now()}.json`}const o=new Blob([e],{type:'application/json'}),i=URL.createObjectURL(o),r=document.createElement('a');r.href=i,r.download=a,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}),o.on('click','.acu-preset-delete',function(){const t=$(this).data('id'),e=n.find(n=>n.id===t);if(confirm(`确定要删除预设「${e?.name}」吗？`)){Xt.deletePreset(t)?(o.remove(),Ta()):window.toastr&&window.toastr.error('删除失败')}}),o.on('click','.acu-preset-copy',function(){const t=$(this).data('id');let e;if('__default__'===t){e={name:'六维属性百分制 (副本)',description:'使用百分制生成六维基础属性（力量、敏捷、体质、智力、感知、魅力），范围5-95',baseAttributes:['力量','敏捷','体质','智力','感知','魅力'].map(t=>({name:t,formula:'3d6*5',range:[15,90],modifier:'1d10-5'})),specialAttributes:[]}}else{const a=n.find(n=>n.id===t);if(!a)return;e={name:a.name+' (副本)',description:a.description||'',baseAttributes:JSON.parse(JSON.stringify(a.baseAttributes)),specialAttributes:JSON.parse(JSON.stringify(a.specialAttributes||[]))}}const a=Xt.createPreset(e);a&&(window.toastr&&window.toastr.success(`已创建副本：${a.name}`),o.remove(),Ta())}),o.find('#acu-preset-new').on('click',()=>{o.remove(),Na()}),o.find('#acu-preset-import').on('click',()=>{o.find('#acu-preset-file-input').click()}),o.find('#acu-preset-file-input').on('change',function(t){const n=t.target.files[0];if(!n)return;const e=new FileReader;e.onload=t=>{try{const n=t.target.result;if(!n?.trim())return;let e;try{e=JSON.parse(n.trim())}catch{return void(window.toastr&&window.toastr.error('JSON格式无效'))}const a=e?.name||'导入的预设',i=Xt.getAllPresets(),r=i.map(t=>t.name),c=r.includes(a),s=(t,r)=>{let s=n.trim();if(r&&(e.name=r,e.id=`attr_preset_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=JSON.stringify(e)),t&&c){const t=i.find(t=>t.name===a);t&&!t.builtin&&Xt.deletePreset(t.id)}Xt.importPreset(s)?(o.remove(),Ta()):window.toastr&&window.toastr.error('导入失败：格式不正确')};c?k({presetName:a,presetType:'属性规则',existingNames:r,onOverwrite:()=>s(!0),onRename:t=>s(!1,t),onCancel:()=>{}}):s(!1)}catch(t){console.error('[DICE]ACU 导入预设失败:',t),window.toastr&&window.toastr.error('导入失败')}},e.readAsText(n),$(this).val('')}),y(o,'acu-edit-overlay',()=>{o.remove(),Vn()})},Na=(t=null)=>{const{$}=le();$('.acu-edit-overlay').remove(),On('showAttributePresetEditor',()=>Na(t));const n=ca(),e=!!t,a=e?Xt.getAllPresets().find(n=>n.id===t):null,o={name:a?.name||'新规则预设',description:a?.description||'',baseAttributes:a?.baseAttributes||[{name:'力量',formula:'3d6',range:[3,18]},{name:'敏捷',formula:'3d6',range:[3,18]},{name:'体质',formula:'3d6',range:[3,18]},{name:'智力',formula:'3d6',range:[3,18]},{name:'感知',formula:'3d6',range:[3,18]},{name:'魅力',formula:'3d6',range:[3,18]}],specialAttributes:a?.specialAttributes||[]},i=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${n.theme}" style="width: 650px; max-width: 95vw; max-height: 85vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-pen"></i> ${e?'编辑':'新建'}规则预设\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">预设名称</label>\n              <input id="preset-name" type="text" value="${h(o.name)}" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">描述</label>\n              <input id="preset-desc" type="text" value="${h(o.description)}" placeholder="可选" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 8px;">\n                JSON配置 <span style="font-size: 10px; color: var(--acu-text-sub);">(支持直接编辑或导入)</span>\n              </label>\n              <textarea id="preset-json" class="acu-preset-editor-textarea" style="width: 100%; height: 320px; padding: 10px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-family: 'Consolas', 'Monaco', monospace !important; font-size: 12px; resize: vertical; box-sizing: border-box;"></textarea>\n            </div>\n\n            <div style="font-size: 11px; color: var(--acu-text-sub); padding: 8px; background: var(--acu-table-head); border-radius: 6px; line-height: 1.6;">\n              <strong>配置格式说明：</strong><br/>\n              • baseAttributes: 基本属性数组，每项包含 name、formula、range、modifier(可选)<br/>\n              • specialAttributes: 特别属性数组，每项包含 name、formula、range(可选)<br/>\n              • 公式支持: 3d6, 4d6kh3, 变量引用(力量/2), 数学运算(+、-、*、/)\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="preset-save" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px; font-weight: bold;">\n              <i class="fa-solid fa-check"></i> 保存\n            </button>\n            <button id="preset-cancel" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-times"></i> 取消\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(i);const r=i.find('#preset-json');(()=>{const t={baseAttributes:o.baseAttributes,specialAttributes:o.specialAttributes};r.val(JSON.stringify(t,null,2))})(),i.find('.acu-close-btn, #preset-cancel').on('click',()=>{i.remove(),Vn()}),i.find('#preset-save').on('click',()=>{try{const n=i.find('#preset-name').val().trim(),a=i.find('#preset-desc').val().trim(),o=r.val().trim();if(!n)return void(window.toastr&&window.toastr.warning('请输入预设名称'));const c=JSON.parse(o);if(!c.baseAttributes||!Array.isArray(c.baseAttributes)||0===c.baseAttributes.length)return void(window.toastr&&window.toastr.error('基本属性不能为空'));const s={format:'acu_attr_preset_v1',version:1,id:t||`custom_${Date.now()}`,name:n,description:a,baseAttributes:c.baseAttributes,specialAttributes:c.specialAttributes||[]};e?Xt.updatePreset(t,s):Xt.createPreset(s),i.remove(),Vn()}catch(t){console.error('[DICE]ACU 保存预设失败:',t),window.toastr&&window.toastr.error('保存失败：'+(t.message||'JSON格式错误'))}}),y(i,'acu-edit-overlay',()=>{i.remove(),Vn()})},Fa=t=>{const n=t.container instanceof HTMLElement?t.container:t.container[0];if(!n)return;const e=t.ghostClass??'acu-drag-ghost',a=t.dragClass??'acu-dragging',o=t.placeholderClass??'acu-drag-placeholder',i=t.indicatorClass??'acu-drag-indicator',r=t.longPressDelay??350,c={isDragging:!1,draggedItem:null,ghost:null,indicator:null,timer:null,startX:0,startY:0,pointerId:null,offsetX:0,offsetY:0,startOrder:[]},s=()=>{const e=[];return n.querySelectorAll(t.itemSelector).forEach(n=>{const a=t.getItemId(n);a&&e.push(a)}),e},l=()=>{c.timer&&(window.clearTimeout(c.timer),c.timer=null)},d=()=>{c.ghost&&c.ghost.parentElement&&c.ghost.parentElement.removeChild(c.ghost),c.ghost=null},u=()=>{c.indicator&&c.indicator.parentElement&&c.indicator.parentElement.removeChild(c.indicator),c.indicator=null},p=(t,n)=>{c.ghost&&(c.ghost.style.left=t-c.offsetX+'px',c.ghost.style.top=n-c.offsetY+'px')},f=e=>{if(!c.draggedItem)return;const a=Array.from(n.querySelectorAll(t.itemSelector)).filter(t=>t!==c.draggedItem);let o=null,r=!0;for(const t of a){const n=t.getBoundingClientRect();if(e<n.top+n.height/2){o=t,r=!0;break}e>=n.top&&e<=n.bottom&&(o=t,r=!1)}const s=(()=>{if(!c.indicator){const t=document.createElement('div');t.className=i,c.indicator=t}return c.indicator})();o?r?n.insertBefore(s,o):n.insertBefore(s,o.nextSibling):n.appendChild(s)},g=(t,n,i,r,l)=>{if(c.isDragging)return;c.isDragging=!0,c.draggedItem=t,c.pointerId=r,c.startOrder=s();const d=t.getBoundingClientRect();c.offsetX=n-d.left,c.offsetY=i-d.top;const u=t.cloneNode(!0);u.classList.add(e),u.style.width=`${d.width}px`,u.style.height=`${d.height}px`,u.style.left=`${d.left}px`,u.style.top=`${d.top}px`,u.style.position='fixed',u.style.margin='0',u.style.pointerEvents='none',document.body.appendChild(u),c.ghost=u,t.classList.add(o),t.classList.add(a),p(n,i),f(i),l.setPointerCapture&&l.setPointerCapture(r)},m=()=>{if(!c.isDragging||!c.draggedItem)return l(),u(),void d();c.indicator&&c.indicator.parentElement===n&&n.replaceChild(c.draggedItem,c.indicator);const e=c.draggedItem.getBoundingClientRect(),i=c.draggedItem,r=c.ghost;r&&(r.style.transition='left 0.18s ease, top 0.18s ease, opacity 0.18s ease',r.style.left=`${e.left}px`,r.style.top=`${e.top}px`,r.style.opacity='0',window.setTimeout(()=>{r.parentElement&&r.parentElement.removeChild(r)},180)),window.setTimeout(()=>{i.classList.remove(o),i.classList.remove(a)},180),u(),r||d();const p=s(),f=c.startOrder.join('|')!==p.join('|');c.isDragging=!1,c.draggedItem=null,c.pointerId=null,c.startOrder=[],l(),f&&t.onOrderChange(p)};n.addEventListener('pointerdown',n=>{const e=n.target;if(!e)return;if(t.cancelSelector&&e.closest(t.cancelSelector))return;const a=e.closest(t.itemSelector);if(!a)return;const o=t.handleSelector?e.closest(t.handleSelector):null;return o?(n.preventDefault(),void g(a,n.clientX,n.clientY,n.pointerId,o)):t.handleSelector?(c.startX=n.clientX,c.startY=n.clientY,c.pointerId=n.pointerId,l(),void(c.timer=window.setTimeout(()=>{g(a,c.startX,c.startY,c.pointerId??n.pointerId,a)},r))):(n.preventDefault(),void g(a,n.clientX,n.clientY,n.pointerId,a))},{passive:!1}),n.addEventListener('pointermove',t=>{c.timer&&(Math.abs(t.clientY-c.startY)>8||Math.abs(t.clientX-c.startX)>8)&&l(),c.isDragging&&c.draggedItem&&(t.preventDefault(),p(t.clientX,t.clientY),f(t.clientY))},{passive:!1}),n.addEventListener('pointerup',m),n.addEventListener('pointercancel',m),n.addEventListener('touchmove',t=>{c.isDragging&&t.preventDefault()},{passive:!1})},Pa=()=>{const{$}=le(),t=$('.acu-dice-panel');if(0===t.length)return;const n=Gt.getAllPresets().filter(t=>!1!==t.visible).sort((t,n)=>(t.order||0)-(n.order||0));let e='<button class="acu-dice-quick-preset-btn" data-id="__custom__">自定义</button>';n.forEach(t=>{e+=`<button class="acu-dice-quick-preset-btn" data-id="${h(t.id)}">${h(t.name)}</button>`}),t.find('.acu-dice-quick-presets').html(e)},ja=(t={})=>{const{$}=le();$('.acu-edit-overlay').remove();const n=ca(),e=Gt.getAllPresets(),a=!0===t.fromDicePanel;On('showPresetListDialog',()=>ja(t));const o=e.sort((t,n)=>(t.order??999)-(n.order??999)).map(t=>{const n=t.builtin,e=!1!==t.visible;return`\n        <div class="acu-preset-item${e?'':' acu-preset-hidden'}" data-id="${t.id}" draggable="false">\n           <div class="acu-preset-check" title="点击切换显示/隐藏" style="padding: 8px; cursor: pointer; color: var(--acu-text-sub); display: flex; align-items: center; justify-content: center; width: 30px;">\n            <i class="fa-solid ${e?'fa-eye':'fa-eye-slash'}" style="${e?'':'opacity: 0.6;'}"></i>\n          </div>\n          <div class="acu-preset-info" style="flex: 1;">\n            <div class="acu-preset-name">\n              ${h(t.name)}\n              ${n?'<span style="font-size: 10px; color: var(--acu-text-sub); margin-left: 6px;">(内置)</span>':''}\n            </div>\n            ${t.description?`<div class="acu-preset-desc">${h(t.description)}</div>`:''}\n            <div class="acu-preset-stats">\n              骰子: ${h(t.diceExpression)} | 判定分支: ${t.outcomes?.length||0}个\n            </div>\n          </div>\n          <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n            ${n?`<button class="acu-preset-btn acu-advanced-preset-copy" data-id="${t.id}" title="复制为自定义预设"><i class="fa-solid fa-copy"></i></button>`:`<button class="acu-preset-btn acu-advanced-preset-edit" data-id="${t.id}" title="编辑"><i class="fa-solid fa-pen"></i></button>`}\n            <button class="acu-preset-btn acu-advanced-preset-export" data-id="${t.id}" title="导出"><i class="fa-solid fa-download"></i></button>\n            ${n?'':`<button class="acu-preset-btn acu-advanced-preset-delete" data-id="${t.id}" title="删除" style="color: var(--acu-error-text);"><i class="fa-solid fa-trash"></i></button>`}\n          </div>\n          <div class="acu-preset-handle" title="拖拽排序" style="cursor: grab; padding: 4px; color: var(--acu-text-sub); touch-action: none; display: flex; align-items: center; justify-content: center; width: 22px;">\n            <i class="fa-solid fa-grip-vertical"></i>\n          </div>\n        </div>\n      `}).join(''),i=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${n.theme}" style="width: 600px; max-width: 92vw; max-height: 85vh; display: flex; flex-direction: column;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border); flex-shrink: 0;">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-sliders"></i> 检定预设管理\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div class="acu-table-manager-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n              <i class="fa-solid fa-info-circle"></i> 点击眼睛图标切换显示，拖拽条目或手柄排序\n            </div>\n            <div id="acu-advanced-presets-list" style="display: flex; flex-direction: column; gap: 8px;">\n              ${o||'<div style="text-align: center; padding: 40px; color: var(--acu-text-sub);">暂无预设</div>'}\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border); flex-shrink: 0;">\n            <button id="acu-advanced-preset-new" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-plus"></i> 新建预设\n            </button>\n            <button id="acu-advanced-preset-import" style="flex: 1; padding: 10px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-file-import"></i> 导入\n            </button>\n            <button id="acu-advanced-preset-back" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-arrow-left"></i> 返回\n            </button>\n          </div>\n\n          <input type="file" id="acu-advanced-preset-file-input" accept=".json" style="display: none;" />\n        </div>\n      </div>\n    `);$('body').append(i),i.find('.acu-close-btn, #acu-advanced-preset-back').on('click',()=>{i.remove(),Vn()}),i.on('click','.acu-preset-check',function(t){t.stopPropagation();const n=$(this).closest('.acu-preset-item').data('id'),o=e.find(t=>t.id===n);if(!o)return;const i=!1!==o.visible;o.builtin?Gt.setBuiltinPresetVisibility(n,!i):Gt.updatePreset(n,{visible:!i}),ja({fromDicePanel:a}),Pa()}),i.on('click','.acu-advanced-preset-edit',function(){const t=$(this).data('id');i.remove(),Ba(t)}),i.on('click','.acu-advanced-preset-copy',function(){const t=$(this).data('id'),n=e.find(n=>n.id===t);if(!n)return;const o={...n,name:n.name+' (副本)',id:void 0,builtin:!1};Gt.createPreset(o),i.remove(),ja({fromDicePanel:a}),Pa()}),i.on('click','.acu-advanced-preset-export',function(){const t=$(this).data('id'),n=Gt.exportPreset(t);if(!n)return void(window.toastr&&window.toastr.error('导出失败'));const a=e.find(n=>n.id===t),o=`acu_advanced_preset_${a?.name||t}_${Date.now()}.json`,i=new Blob([n],{type:'application/json'}),r=URL.createObjectURL(i),c=document.createElement('a');c.href=r,c.download=o,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}),i.on('click','.acu-advanced-preset-delete',function(){const t=$(this).data('id'),n=e.find(n=>n.id===t);if(confirm(`确定要删除预设「${n?.name}」吗？`))try{Gt.deletePreset(t),i.remove(),ja({fromDicePanel:a}),Pa()}catch(t){window.toastr&&window.toastr.error('删除失败: '+t.message)}}),i.find('#acu-advanced-preset-new').on('click',()=>{i.remove(),Ba()}),i.find('#acu-advanced-preset-import').on('click',()=>{i.find('#acu-advanced-preset-file-input').trigger('click')});const r=i.find('#acu-advanced-presets-list');Fa({container:r,itemSelector:'.acu-preset-item',handleSelector:'.acu-preset-handle',cancelSelector:'.acu-preset-actions button, .acu-toggle, .acu-preset-check',getItemId:t=>{const n=$(t).data('id');return'string'==typeof n?n:null!=n?String(n):null},onOrderChange:t=>{t.forEach((t,n)=>{Gt.setPresetOrder(t,n)}),Pa()}}),i.find('#acu-advanced-preset-file-input').on('change',function(t){const n=t.target.files?.[0];if(!n)return;const e=new FileReader;e.onload=t=>{try{const n=t.target?.result;Gt.importPreset(n)?(i.remove(),ja({fromDicePanel:a}),Pa()):window.toastr&&window.toastr.error('导入失败: 格式错误')}catch(t){window.toastr&&window.toastr.error('导入失败: '+(t.message||'未知错误'))}},e.readAsText(n)}),y(i,'acu-edit-overlay',()=>{i.remove(),Vn()})},Ra=(t={})=>{const{$}=le();$('.acu-edit-overlay').remove(),On('showAdvancedPresetManager',()=>Ra(t));const n=ca(),e=qt(),a=!0===t.fromDicePanel,o=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${n.theme}" style="width: 600px; max-width: 92vw; max-height: 85vh; display: flex; flex-direction: column;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border); flex-shrink: 0;">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-dice-d20"></i> 检定设置\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n           <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n              <div class="acu-setting-row">\n                  <div class="acu-setting-info">\n                      <span class="acu-setting-label"><i class="fa-solid fa-sliders"></i> 检定预设</span>\n                  </div>\n                  <button id="acu-open-preset-list" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                      <i class="fa-solid fa-cog"></i> 管理\n                  </button>\n              </div>\n              <div class="acu-setting-row" style="margin-top: 12px;">\n                  <div class="acu-setting-info">\n                      <span class="acu-setting-label"><i class="fa-solid fa-gem"></i> 自定义属性预设</span>\n                  </div>\n                  <button id="acu-open-attr-preset" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                      <i class="fa-solid fa-cog"></i> 管理\n                  </button>\n              </div>\n              <div class="acu-setting-row" style="margin-top: 12px;">\n                  <div class="acu-setting-info">\n                      <span class="acu-setting-label"><i class="fa-solid fa-fire"></i> 疯狂模式</span>\n                  </div>\n                  <select id="cfg-crazy-mode" class="acu-setting-select" style="width: 90px; min-width: 90px; text-align: center; text-align-last: center;">\n                      <option value="0">○ 关闭</option>\n                      <option value="25">◔ 低</option>\n                      <option value="50">◑ 中</option>\n                      <option value="75">◕ 高</option>\n                      <option value="100">● 极限</option>\n                  </select>\n              </div>\n              <div style="padding-top: 12px; border-top: 1px solid var(--acu-border);">\n                <div class="acu-setting-row acu-setting-row-toggle" style="margin-bottom: 8px;">\n                    <div class="acu-setting-info">\n                        <span class="acu-setting-label">隐藏输入栏中的检定结果</span>\n                    </div>\n                    <label class="acu-toggle">\n                        <input type="checkbox" id="cfg-hide-dice-result" ${e.hideDiceResultFromUser?'checked':''}>\n                        <span class="acu-toggle-slider"></span>\n                    </label>\n                </div>\n                 <div class="acu-setting-row acu-setting-row-toggle">\n                    <div class="acu-setting-info">\n                        <span class="acu-setting-label">隐藏聊天记录中的检定结果</span>\n                    </div>\n                    <label class="acu-toggle">\n                        <input type="checkbox" id="cfg-hide-dice-result-chat" ${e.hideDiceResultInChat?'checked':''}>\n                        <span class="acu-toggle-slider"></span>\n                    </label>\n                </div>\n            </div>\n           </div>\n         </div>\n      </div>\n    `);$('body').append(o),o.find('.acu-close-btn').on('click',()=>{o.remove(),Vn()}),o.find('#acu-open-preset-list').on('click',()=>{o.remove(),ja({fromDicePanel:a})}),o.find('#acu-open-attr-preset').on('click',()=>{o.remove(),Ta()});(()=>{const t=rn(),n=t.enabled?t.crazyLevel:0;o.find('#cfg-crazy-mode').val(n),o.find('#cfg-crazy-mode').on('change',function(){const t=parseInt($(this).val(),10);cn(0===t?{enabled:!1,crazyLevel:50}:{enabled:!0,crazyLevel:t})})})(),o.find('#cfg-hide-dice-result').on('change',function(){const t=$(this).is(':checked');Yt({hideDiceResultFromUser:t}),console.info('[DICE]应用投骰结果隐藏/显示设置(输入栏)...',t),Wt()}),o.find('#cfg-hide-dice-result-chat').on('change',function(){const t=$(this).is(':checked');Yt({hideDiceResultInChat:t}),console.info('[DICE]应用投骰结果隐藏/显示设置(聊天记录)...',t)}),y(o,'acu-edit-overlay',()=>{o.remove(),Vn()})},Ba=(t=null)=>{const{$}=le();$('.acu-edit-overlay').remove(),On('showAdvancedPresetEditor',()=>Ba(t));const n=ca(),e=!!t,a=e?Gt.getAllPresets().find(n=>n.id===t):null,o=a?JSON.parse(JSON.stringify(a)):{name:'新检定预设',description:'自定义检定规则示例',diceExpression:'1d20',attribute:{label:'属性值',placeholder:'留空=10',defaultValue:10,key:'属性值'},dc:{label:'难度等级(DC)',placeholder:'留空=10',defaultValue:10},mod:{label:'修正值',placeholder:'留空=0',defaultValue:0},customFields:[{id:'advantage',type:'select',label:'优势/劣势',defaultValue:0,options:[{label:'正常',value:0},{label:'优势',value:1},{label:'劣势',value:-1}]}],derivedVars:[{id:'attrMod',expr:'floor(($attr - 10) / 2)'}],dicePatches:[{when:'$advantage > 0',op:'replace',template:'2d20kh1'},{when:'$advantage < 0',op:'replace',template:'2d20kl1'}],outcomes:[{id:'crit_success',name:'大成功',condition:'$roll.hasTag(\'nat20\')',priority:1,rank:3,contestRank:100},{id:'success',name:'成功',condition:'$roll.total + $attrMod + $mod >= $dc',priority:10,rank:1,contestRank:60},{id:'failure',name:'失败',condition:'$roll.total + $attrMod + $mod < $dc',displayExpr:'$roll.total + $attrMod + $mod >= $dc',priority:50,rank:0,contestRank:40},{id:'crit_failure',name:'大失败',condition:'$roll.hasTag(\'nat1\')',priority:2,rank:-1,contestRank:20}],contestRule:{mode:'rank',tieBreakers:['higher_roll','initiator_wins']},outputTemplate:'<meta:检定结果>\n$outcomeText\n元叙事：$initiator 发起了 $attrName 检定，$formula=$roll，判定 $conditionExpr？$judgeResult，判定为【$outcomeName】\n</meta:检定结果>',contestOutputTemplate:'',secondaryTriggerMode:'first',secondaryMaxDepth:3,secondaryEffects:[]},i=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${n.theme}" style="width: 650px; max-width: 95vw; max-height: 85vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-pen"></i> ${e?'编辑':'新建'}检定设置\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">预设名称</label>\n              <input id="advanced-preset-name" type="text" value="${h(o.name)}" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">描述</label>\n              <input id="advanced-preset-desc" type="text" value="${h(o.description)}" placeholder="可选" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 8px;">\n                JSON配置 <span style="font-size: 10px; color: var(--acu-text-sub);">(支持直接编辑或导入)</span>\n              </label>\n              <textarea id="advanced-preset-json" class="acu-preset-editor-textarea" style="width: 100%; height: 400px; padding: 10px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-family: 'Consolas', 'Monaco', monospace !important; font-size: 12px; resize: vertical; box-sizing: border-box;"></textarea>\n            </div>\n\n            <div style="font-size: 11px; color: var(--acu-text-sub); padding: 8px; background: var(--acu-table-head); border-radius: 6px; line-height: 1.6;">\n              <strong>配置格式说明：</strong><br/>\n              <strong>骰子表达式 (diceExpression)</strong><br/>\n              • 基础: "1d20", "3d6", "4dF" (Fate骰)<br/>\n              • 保留/舍弃: "4d6kh3" (保留最高3个), "2d20kl1" (保留最低1个)<br/>\n              • 成功计数: "4d6=3" (统计=3的个数), "6d10>=7" (统计≥7的个数)<br/>\n              • CoC奖惩骰: "1d100b1" (奖励骰), "1d100p2" (2个惩罚骰)<br/>\n              • 爆炸骰: "4d6!" (最大值爆炸), "4d6!!" (累加爆炸)<br/>\n              <br/>\n              <strong>$roll 对象属性</strong><br/>\n              • $roll.total: 骰子结果总和（或成功计数）<br/>\n              • $roll.hasTag('nat20'): 检查是否有自然20（仅d20）<br/>\n              • $roll.hasTag('nat1'): 检查是否有自然1（仅d20）<br/>\n              <br/>\n              <strong>输入字段配置</strong><br/>\n              • attribute: 属性值 { label, placeholder, defaultValue, hidden, key? }<br/>\n              • dc: 目标值 { label, placeholder, defaultValue, hidden }<br/>\n              • mod: 修正值 { label, placeholder, defaultValue, hidden }<br/>\n              <br/>\n              <strong>判定结果 (outcomes)</strong><br/>\n              • 数组，每项: { id, name, condition, priority, rank?, contestRank? }<br/>\n              • condition: 表达式如 "$roll.total >= $dc", "$roll.total == 4"<br/>\n              • priority: 数字越小越优先匹配<br/>\n              <br/>\n              <strong>高级功能</strong><br/>\n              • customFields: 自定义字段 [{ id, type, label, defaultValue, options? }]<br/>\n              • derivedVars: 派生变量 [{ id, expr }] 如 { id: "mod", expr: "floor(($attr-10)/2)" }<br/>\n              • dicePatches: 条件骰子 [{ when?, op, template }]<br/>\n              • contestRule: 对抗规则 { disabled?, mode, tieBreakers }<br/>\n              <br/>\n              <strong>输出模板变量</strong><br/>\n              • $roll, $attr, $dc, $mod, $outcomeName, $formula, $initiator 等<br/>\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="advanced-preset-save" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px; font-weight: bold;">\n              <i class="fa-solid fa-check"></i> 保存\n            </button>\n            <button id="advanced-preset-cancel" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-times"></i> 取消\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(i);const r=i.find('#advanced-preset-json');r.val(JSON.stringify(o,null,2)),i.find('.acu-close-btn, #advanced-preset-cancel').on('click',()=>{i.remove(),Vn()}),i.find('#advanced-preset-save').on('click',()=>{try{const n=i.find('#advanced-preset-name').val().trim(),o=i.find('#advanced-preset-desc').val().trim(),c=r.val().trim();if(!n)return void(window.toastr&&window.toastr.warning('请输入预设名称'));const s=JSON.parse(c);if(!s.diceExpression||!s.outcomes||!Array.isArray(s.outcomes)||0===s.outcomes.length)return void(window.toastr&&window.toastr.error('骰子表达式和判定结果列表(outcomes)不能为空'));for(const t of s.outcomes)if(!t.id||!t.name||void 0===t.condition||void 0===t.priority)return void(window.toastr&&window.toastr.error(`判定结果 "${t.name||t.id||'未知'}" 缺少必填字段(id, name, condition, priority)`));const l={...e&&a?a:{},...e?{}:{builtin:!1},...s,kind:'advanced',version:Q,id:t||`custom_${Date.now()}`,name:n,description:o};e?Gt.updatePreset(t,l):Gt.createPreset(l),i.remove(),Vn(),Pa()}catch(t){console.error('[DICE]ACU 保存高级预设失败:',t);const n=t.message||'';n.includes('JSON')||n.includes('position')||n.includes('token')?window.toastr&&window.toastr.error('JSON格式错误：请确保所有键名和字符串值都用双引号包裹，例如 "name": "值"'):window.toastr&&window.toastr.error('保存失败：'+(n||'未知错误'))}}),y(i,'acu-edit-overlay',()=>{i.remove(),Vn()})},Oa=()=>{const{$}=le();$('.acu-edit-overlay').remove(),On('showActionPresetManager',Oa);const t=ca(),n=on.getAllPresets(),e=on.getActivePresetId(),a=0===n.length?'<div style="text-align: center; padding: 40px; color: var(--acu-text-sub);">暂无自定义规则，点击下方按钮创建</div>':n.map(t=>{const n=t.id===e,a=!0===t.builtin,o=(t.rules||[]).flatMap(t=>t.table_keywords||[]).slice(0,3).join('、')||'无',i=(t.rules||[]).flatMap(t=>(t.actions||[]).map(t=>t.label)).slice(0,4).join('、')||'无';return`\n          <div class="acu-preset-item" data-id="${t.id}">\n            <div class="acu-preset-info">\n              <div class="acu-preset-name">${h(t.name)}${a?'<span style="font-size: 10px; color: var(--acu-text-sub); margin-left: 6px;">(内置)</span>':''}</div>\n              ${t.description?`<div class="acu-preset-desc">${h(t.description)}</div>`:''}\n              <div class="acu-preset-stats" style="font-size: 11px; color: var(--acu-text-sub);">\n                关键词: ${h(o)} | 动作: ${h(i)}\n              </div>\n            </div>\n            <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n              <label class="acu-toggle" style="margin: 0;">\n                <input type="checkbox" class="acu-action-preset-toggle" data-id="${t.id}" ${n?'checked':''}>\n                <span class="acu-toggle-slider"></span>\n              </label>\n              ${a?`<button class="acu-preset-btn acu-action-preset-copy" data-id="${t.id}" title="复制为自定义规则"><i class="fa-solid fa-copy"></i></button>`:`<button class="acu-preset-btn acu-action-preset-edit" data-id="${t.id}" title="编辑"><i class="fa-solid fa-pen"></i></button>`}\n              <button class="acu-preset-btn acu-action-preset-export" data-id="${t.id}" title="导出"><i class="fa-solid fa-download"></i></button>\n              ${a?'':`<button class="acu-preset-btn acu-action-preset-delete" data-id="${t.id}" title="删除" style="color: var(--acu-error-text);"><i class="fa-solid fa-trash"></i></button>`}\n            </div>\n          </div>\n        `}).join(''),o=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="width: 600px; max-width: 92vw; max-height: 80vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-wand-magic-sparkles"></i> 自定义交互规则管理\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div id="acu-action-presets-list">\n              ${a}\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="acu-action-preset-new" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-plus"></i> 新建规则\n            </button>\n            <button id="acu-action-preset-import" style="flex: 1; padding: 10px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-file-import"></i> 导入\n            </button>\n            <button id="acu-action-preset-back" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-arrow-left"></i> 返回\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(o),o.find('.acu-close-btn, #acu-action-preset-back').on('click',()=>{o.remove(),Vn()}),o.on('change','.acu-action-preset-toggle',function(){const t=$(this),n=t.data('id');t.is(':checked')?(on.setActivePresetId(n),o.find('.acu-action-preset-toggle').each(function(){$(this).data('id')!==n&&$(this).prop('checked',!1)})):on.getActivePresetId()===n&&(on.setActivePresetId(null),window.toastr&&window.toastr.info('所有交互规则已禁用'))}),o.on('click','.acu-action-preset-edit',function(){const t=$(this).data('id');o.remove(),Va(t)}),o.on('click','.acu-action-preset-export',function(){const t=$(this).data('id'),e=n.find(n=>n.id===t),a=on.exportPreset(t);if(!a)return void(window.toastr&&window.toastr.error('导出失败'));const o=new Blob([a],{type:'application/json'}),i=URL.createObjectURL(o),r=document.createElement('a');r.href=i,r.download=`${e?.name||'交互规则'}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),window.toastr&&window.toastr.success('已导出文件')}),o.on('click','.acu-action-preset-copy',function(){const t=$(this).data('id'),e=n.find(n=>n.id===t);if(!e)return;const a={name:e.name+' (副本)',description:e.description||'',rules:JSON.parse(JSON.stringify(e.rules))},i=on.createPreset(a);i&&(window.toastr&&window.toastr.success(`已创建副本：${i.name}，包含 ${i.rules.length} 个规则组`),o.remove(),Oa())}),o.on('click','.acu-action-preset-delete',function(){const t=$(this).data('id'),e=n.find(n=>n.id===t);if(confirm(`确定要删除规则「${e?.name}」吗？`)){on.deletePreset(t)?(o.remove(),Oa()):window.toastr&&window.toastr.error('删除失败')}}),o.find('#acu-action-preset-new').on('click',()=>{o.remove(),Va()}),o.find('#acu-action-preset-import').on('click',()=>{const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=()=>{const n=t.files?.[0];if(!n)return;const e=new FileReader;e.onload=t=>{const n=t.target?.result;if(!n?.trim())return void(window.toastr&&window.toastr.error('文件内容为空'));const e=on.importPreset(n.trim());e?(window.toastr&&window.toastr.success(`导入成功：${e.name}`),o.remove(),Oa()):window.toastr&&window.toastr.error('导入失败，请检查JSON格式')},e.onerror=()=>{window.toastr&&window.toastr.error('文件读取失败')},e.readAsText(n)},t.click()}),y(o,'acu-edit-overlay',()=>{o.remove(),Vn()})},Va=t=>{const{$}=le();$('.acu-edit-overlay').remove(),On('showActionPresetEditor',()=>Va(t));const n=ca(),e=!!t,a=e?on.getPresetById(t):null,o={name:a?.name||'新交互规则',description:a?.description||'',rules:a?.rules||[{table_keywords:['地点（输入表格名关键词，表名中包含关键词的表格将应用此规则）','场所'],actions:[{label:'前往（按钮显示的文字）',template:'<user>对{Name}执行互动:前往。（点击按钮后发送的内容，{Name}会替换为表格第一列的列名，一般为名称）'},{label:'调查',template:'<user>仔细调查了{Name}的情况。'}]},{table_keywords:['魔法','奥术'],actions:[{label:'学习',template:'<user>尝试学习{Name}。'},{label:'释放',template:'<user>释放了{Name}！'}]}]},i=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${n.theme}" style="width: 700px; max-width: 95vw; max-height: 85vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-wand-magic-sparkles"></i> ${e?'编辑':'新建'}交互规则\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">预设名称</label>\n              <input id="action-preset-name" type="text" value="${h(o.name)}" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">描述</label>\n              <input id="action-preset-desc" type="text" value="${h(o.description)}" placeholder="可选" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 8px;">\n                JSON配置 <span style="font-size: 10px; color: var(--acu-text-sub);">(必须使用标准JSON格式：键名和字符串值都要用双引号)</span>\n              </label>\n              <textarea id="action-preset-json" class="acu-preset-editor-textarea" style="width: 100%; height: 300px; padding: 10px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; resize: vertical; box-sizing: border-box;"></textarea>\n            </div>\n\n            <div style="font-size: 11px; color: var(--acu-text-sub); padding: 8px; background: var(--acu-table-head); border-radius: 6px; line-height: 1.6;">\n              <strong>配置格式说明：</strong><br/>\n              • 每个规则包含 table_keywords（表名关键词数组）和 actions（动作数组）<br/>\n              • 动作包含 label（按钮文字）和 template（发送模板，{Name}为行名称）<br/>\n              • 示例: { "table_keywords": ["人物"], "actions": [{ "label": "交谈", "template": "<user>与{Name}交谈。" }] }\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="action-preset-save" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px; font-weight: bold;">\n              <i class="fa-solid fa-check"></i> 保存\n            </button>\n            <button id="action-preset-cancel" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-text-sub); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-times"></i> 取消\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(i);const r=i.find('#action-preset-json');r.val(JSON.stringify(o.rules,null,2)),i.find('.acu-close-btn, #action-preset-cancel').on('click',()=>{i.remove(),Vn()}),i.find('#action-preset-save').on('click',()=>{try{const n=i.find('#action-preset-name').val().trim(),a=i.find('#action-preset-desc').val().trim(),o=r.val().trim();if(!n)return void(window.toastr&&window.toastr.warning('请输入预设名称'));const c=JSON.parse(o);if(!Array.isArray(c)||0===c.length)return void(window.toastr&&window.toastr.error('规则不能为空，需要至少一个规则'));for(let t=0;t<c.length;t++){const n=c[t];if(!n.table_keywords||!Array.isArray(n.table_keywords)||0===n.table_keywords.length)return void(window.toastr&&window.toastr.error(`规则 ${t+1} 缺少 table_keywords`));if(!n.actions||!Array.isArray(n.actions)||0===n.actions.length)return void(window.toastr&&window.toastr.error(`规则 ${t+1} 缺少 actions`))}e&&t?(on.updatePreset(t,{name:n,description:a,rules:c}),window.toastr&&window.toastr.success('规则已更新')):(on.createPreset({name:n,description:a,rules:c}),window.toastr&&window.toastr.success('规则已创建')),i.remove(),Vn()}catch(t){window.toastr&&window.toastr.error('JSON 格式错误: '+t.message)}}),y(i,'acu-edit-overlay',()=>{i.remove(),Vn()})},La=()=>{const{$}=le();$('.acu-edit-overlay').not(':has(.acu-debug-console-dialog)').remove();const t=`acu-theme-${ca().theme}`,n=fe.get('acu_debug_filters',{log:!0,info:!0,warn:!0,error:!0});at.setFilters(n);const e=()=>{const t=at.getFilteredLogs(),n=a.find('.acu-debug-log-container');n.empty(),0!==t.length?t.forEach(t=>{const e=$(`\n          <div class="acu-debug-log-item" data-type="${t.type}">\n            <div class="acu-debug-log-header">\n              <span class="acu-debug-log-time">${t.timeStr}</span>\n              <span class="acu-debug-log-type ${t.type}">${t.type.toUpperCase()}</span>\n            </div>\n            <div class="acu-debug-log-content">${h(t.content)}</div>\n            ${t.stack?`<div class="acu-debug-log-stack">${h(t.stack)}</div>`:''}\n          </div>\n        `);n.append(e)}):n.html('\n          <div class="acu-debug-empty">\n            <i class="fa-solid fa-inbox"></i>\n            <div class="acu-debug-empty-text">暂无日志</div>\n            <div class="acu-debug-empty-hint">开启 Console 抓取后，日志将显示在这里</div>\n          </div>\n        ')},a=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-debug-console-dialog ${t}">\n          <div class="acu-settings-header">\n            <div class="acu-settings-title"><i class="fa-solid fa-bug"></i> Debug控制台</div>\n            <button class="acu-close-btn" id="debug-console-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">\n            \x3c!-- 工具栏 --\x3e\n            <div class="acu-debug-toolbar">\n              \x3c!-- Console抓取开关 --\x3e\n              <div class="acu-debug-capture-row">\n                <span class="acu-debug-capture-label">Console 抓取</span>\n                <label class="acu-toggle">\n                  <input type="checkbox" id="debug-console-capture-toggle" ${at.enabled?'checked':''}>\n                  <span class="acu-toggle-slider"></span>\n                </label>\n                <span id="debug-console-capture-status" class="acu-debug-capture-status ${at.enabled?'enabled':'disabled'}">${at.enabled?'已启用':'已关闭'}</span>\n              </div>\n              \x3c!-- 过滤按钮组 --\x3e\n              <div class="acu-debug-filter-group">\n                <button class="acu-debug-filter-btn ${n.log?'active':''}" data-filter-type="log">\n                  <i class="fa-solid fa-circle indicator"></i> Log\n                </button>\n                <button class="acu-debug-filter-btn ${n.info?'active':''}" data-filter-type="info">\n                  <i class="fa-solid fa-info-circle indicator"></i> Info\n                </button>\n                <button class="acu-debug-filter-btn ${n.warn?'active':''}" data-filter-type="warn">\n                  <i class="fa-solid fa-exclamation-triangle indicator"></i> Warn\n                </button>\n                <button class="acu-debug-filter-btn ${n.error?'active':''}" data-filter-type="error">\n                  <i class="fa-solid fa-exclamation-circle indicator"></i> Error\n                </button>\n              </div>\n              \x3c!-- 操作按钮 --\x3e\n              <div class="acu-debug-actions">\n                <button class="acu-debug-action-btn danger" id="debug-console-clear">\n                  <i class="fa-solid fa-trash"></i> <span class="btn-text">清空</span>\n                </button>\n                <button class="acu-debug-action-btn" id="debug-console-copy">\n                  <i class="fa-solid fa-copy"></i> <span class="btn-text">复制</span>\n                </button>\n                <button class="acu-debug-action-btn primary" id="debug-console-export">\n                  <i class="fa-solid fa-download"></i> <span class="btn-text">导出</span>\n                </button>\n              </div>\n            </div>\n\n            \x3c!-- 日志显示区域 --\x3e\n            <div class="acu-debug-log-scroll">\n              <div class="acu-debug-log-container"></div>\n            </div>\n\n            \x3c!-- 底部状态栏 --\x3e\n            <div class="acu-debug-footer">\n              <div class="acu-debug-stats">\n                <div class="acu-debug-stat">\n                  <span>总计</span>\n                  <span class="acu-debug-stat-value" id="debug-total-count">0</span>\n                </div>\n                <div class="acu-debug-stat">\n                  <span>显示</span>\n                  <span class="acu-debug-stat-value" id="debug-filtered-count">0</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(a);const o=()=>{const t=at.logs.length,n=at.getFilteredLogs().length;a.find('#debug-total-count').text(t),a.find('#debug-filtered-count').text(n)};e(),o(),a.find('#debug-console-capture-toggle').on('change',function(){const t=$(this).is(':checked'),n=a.find('#debug-console-capture-status');t?(at.enable(),n.text('已启用').removeClass('disabled').addClass('enabled'),console.log('[DICE]Debug控制台抓取模式已开启')):(at.disable(),n.text('已关闭').removeClass('enabled').addClass('disabled'))}),a.find('.acu-debug-filter-btn').on('click',function(){const t=$(this).data('filter-type'),n=!$(this).hasClass('active');n?$(this).addClass('active'):$(this).removeClass('active'),at.setFilters({[t]:n}),fe.set('acu_debug_filters',at.filters),e(),o()}),a.find('#debug-console-clear').on('click',()=>{at.clear(),e(),o()}),a.find('#debug-console-copy').on('click',async()=>{const t=at.getFilteredLogs();if(0===t.length)return void(window.toastr&&window.toastr.warning('没有可复制的日志'));const n=t.map(t=>{let n=`[${t.timeStr}] [${t.type.toUpperCase()}] ${t.content}`;return t.stack&&(n+='\n'+t.stack),n}).join('\n');try{if(window.TavernHelper&&window.TavernHelper.triggerSlash){const t=n.replace(/\"/g,'\\"').replace(/\}/g,'\\}');return void await window.TavernHelper.triggerSlash(`/clipboard-set "${t}"`)}if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(n);else{const t=document.createElement('textarea');t.value=n,t.style.position='fixed',t.style.left='-9999px',t.style.top='0',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999);const e=document.execCommand('copy');if(document.body.removeChild(t),!e)throw new Error('execCommand failed')}}catch(t){console.error('[DICE]DebugConsole 复制失败:',t),window.toastr&&window.toastr.error('复制失败')}}),a.find('#debug-console-export').on('click',()=>{const t=at.getFilteredLogs();if(0===t.length)return void(window.toastr&&window.toastr.warning('没有可导出的日志'));const n=t.map(t=>{let n=`[${t.timeStr}] [${t.type.toUpperCase()}] ${t.content}`;return t.stack&&(n+='\n'+t.stack),n}).join('\n\n'),e=new Blob([n],{type:'text/plain;charset=utf-8'}),a=URL.createObjectURL(e),o=document.createElement('a');o.href=a,o.download=`debug-console-${(new Date).toISOString().slice(0,19).replace(/:/g,'-')}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a)}),a.find('#debug-console-close, .acu-edit-overlay').on('click',function(t){(t.target===this||$(t.target).closest('.acu-close-btn').length)&&a.remove()});const i=setInterval(()=>{a.length&&a.is(':visible')&&(e(),o())},500);a.on('remove',()=>{clearInterval(i)})},Ua=t=>{const{$}=le(),n=`acu-theme-${ca().theme}`,e=t?$t.getRule(t):null,a=Yn||pa(),o=(Object.keys(a||{}).filter(t=>t.startsWith('sheet_')).map(t=>a[t]?.name||t).sort(),$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${n}">\n          <div class="acu-dice-cfg-header">\n            <span><i class="fa-solid fa-magic"></i> ${e?'编辑':'添加'}正则转换规则</span>\n            <button class="acu-config-close" id="acu-close-regex-rule"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-validation-modal-body">\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">规则名称 *</span></div>\n              <input type="text" id="rule-name" class="acu-panel-input" value="${e?h(e.name):''}" placeholder="例如: 清理多余空格" style="flex:1;" required>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">规则描述</span></div>\n              <textarea id="rule-description" class="acu-panel-input" placeholder="输入规则介绍" style="flex:1; resize: none; overflow-wrap: break-word; overflow-y: hidden; min-height: 34px; height: 34px; line-height: 1.4;">${e?h(e.description||''):''}</textarea>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">匹配模式 *</span></div>\n              <input type="text" id="rule-pattern" class="acu-panel-input" value="${e?h(e.pattern):''}" placeholder="例如: \\s+ 或 /test/g" style="flex:1; font-family: monospace;" required>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">替换内容</span></div>\n              <input type="text" id="rule-replacement" class="acu-panel-input" value="${e?h(e.replacement||''):''}" placeholder="留空表示删除,或使用 $1, $2 等捕获组" style="flex:1; font-family: monospace;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">作用范围 *</span></div>\n              <select id="rule-scope-type" class="acu-setting-select" style="width:120px;">\n                <option value="global" ${'global'===e?.scope?.type?'selected':''}>全局</option>\n                <option value="table" ${'table'===e?.scope?.type?'selected':''}>表级</option>\n                <option value="column" ${'column'===e?.scope?.type?'selected':''}>列级</option>\n              </select>\n            </div>\n            <div class="acu-setting-row" id="field-table-names" style="display: ${'global'===e?.scope?.type?'none':'flex'};">\n              <div class="acu-setting-info"><span class="acu-setting-label">表格名 (多个用逗号分隔)</span></div>\n              <input type="text" id="rule-table-names" class="acu-panel-input" value="${e?.scope?.tableNames?.join(',')||''}" placeholder="例如: 物品表,装备表" style="flex:1;">\n            </div>\n            <div class="acu-setting-row" id="field-column-names" style="display: ${'column'===e?.scope?.type?'flex':'none'};">\n              <div class="acu-setting-info"><span class="acu-setting-label">列名 (多个用逗号分隔)</span></div>\n              <input type="text" id="rule-column-names" class="acu-panel-input" value="${e?.scope?.columnNames?.join(',')||''}" placeholder="例如: 品质,描述" style="flex:1;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">优先级</span></div>\n              <input type="number" id="rule-priority" class="acu-panel-input" value="${e?.priority||50}" min="1" max="100" style="width:80px;">\n            </div>\n\n          </div>\n          <div class="acu-dice-cfg-actions">\n            <button id="acu-regex-rule-cancel">取消</button>\n            <button id="acu-regex-rule-confirm">保存</button>\n          </div>\n        </div>\n      </div>\n    `));o.find('#rule-scope-type').on('change',()=>{const t=o.find('#rule-scope-type').val();'global'===t?o.find('#field-table-names, #field-column-names').hide():'table'===t?(o.find('#field-table-names').css('display','flex').show(),o.find('#field-column-names').hide()):'column'===t&&o.find('#field-table-names, #field-column-names').css('display','flex').show()});const i=o.find('#rule-description');i.on('input',()=>{i.css('height','34px');const t=i[0].scrollHeight;i.css('height',Math.max(34,t)+'px')}),o.find('#acu-regex-rule-confirm').on('click',async function(){const n=o.find('#rule-name').val(),e=o.find('#rule-pattern').val(),a=o.find('#rule-scope-type').val();if(!n||!e)return void toastr.error('请填写规则名称和匹配模式');const i={type:a};if('global'!==a){const t=o.find('#rule-table-names').val();t&&(i.tableNames=String(t).split(',').map(t=>t.trim()).filter(t=>t))}if('column'===a){const t=o.find('#rule-column-names').val();t&&(i.columnNames=String(t).split(',').map(t=>t.trim()).filter(t=>t))}const r=String(e),{flags:c,patternWithoutFlags:s}=_t._extractFlags(r);try{new RegExp(s)}catch(t){const n=t instanceof Error?t.message:String(t);return void toastr.error(`正则表达式无效: ${n}`,'保存失败')}const l=o.find('#flag-global'),d=o.find('#flag-ignorecase'),u=o.find('#flag-multiline'),p={global:l.length>0&&l.is(':checked'),caseInsensitive:d.length>0&&d.is(':checked'),multiline:u.length>0&&u.is(':checked')},f=s!==r?s:r,g=s!==r?{...p,...c}:p,m={name:String(n),description:o.find('#rule-description').val(),operation:'replace',pattern:f,flags:g,replacement:o.find('#rule-replacement').val(),scope:i,enabled:!0,priority:parseInt(o.find('#rule-priority').val(),10),executeMode:'auto'};if(t)$t.updateRule(t,m);else{const n=$t.addCustomRule(m);n&&(t=n.id)}o.remove(),$(document).off('keydown.regex-rule-modal'),Ca()});const r=()=>{o.remove(),$(document).off('keydown.regex-rule-modal')};o.find('#acu-regex-rule-cancel, #acu-close-regex-rule').on('click',function(t){t.stopPropagation(),r()}),y(o,'acu-edit-overlay',r),$(document).on('keydown.regex-rule-modal',function(t){'Escape'===t.key&&o.length&&o.is(':visible')&&(t.preventDefault(),r(),$(document).off('keydown.regex-rule-modal'))}),$('body').append(o),requestAnimationFrame(()=>{const t=o.find('#rule-description');t.length&&t[0].scrollHeight>34&&t.css('height',t[0].scrollHeight+'px')})};window.showAddRegexRuleModal=Ua,window.showDebugConsoleModal=La;const qa=(()=>{try{return window.top??window}catch(t){return window}})(),Ya=[];let Wa=!1;const Ja=t=>{try{t()}catch(t){console.error('[AcuDice] onReady 回调出错',t)}},Ha=t=>{'AcuDice'in t||Object.defineProperty(t,'AcuDice',{value:so,writable:!1,configurable:!1})},Xa=t=>{try{t.dispatchEvent(new CustomEvent('acudice:ready'))}catch(t){console.warn('[AcuDice] ready 事件触发失败',t)}},Ka=new Map,Ga=qa;Ga.__AcuDiceHistoryStore__||(Ga.__AcuDiceHistoryStore__={checkHistory:[],contestHistory:[],maxHistory:100});const Za=Ga.__AcuDiceHistoryStore__,Qa=Za.checkHistory,to=Za.contestHistory,no=Za.maxHistory,eo=new Set;let ao='all',oo='',io='chat';const ro=()=>{$('.acu-dice-history-overlay').remove();const t=`acu-theme-${ca().theme}`,n=new Map,e=()=>{n.clear();const t=[...Qa.map(t=>({...t,historyType:'check'})),...to.map(t=>({...t,historyType:'contest'}))].sort((t,n)=>n.timestamp-t.timestamp).filter(t=>{if('all'!==ao){const n=String(t.effectStatus||'');if(!n||n!==ao)return!1}const n=oo.trim().toLowerCase();if(!n)return!0;const e=t,a=e.left||{},o=e.right||{};return[e.attrName,e.message,e.outcomeText,e.initiatorName,a.name,o.name,e.effectStatus].map(t=>String(t||'').toLowerCase()).join(' ').includes(n)}).slice(0,80);if(0===t.length)return'<div style="padding:20px 12px; color:var(--acu-text-sub); text-align:center; display:flex; flex-direction:column; gap:8px; align-items:center;"><i class="fa-solid fa-dice-d20" style="font-size:20px; opacity:.35;"></i><span>暂无检定历史</span></div>';const e={planned:'待执行',confirmed:'已确认',committed:'已提交',failed:'失败',cancelled:'已取消'},a={planned:'var(--acu-text-sub)',confirmed:'var(--acu-accent)',committed:'var(--acu-success-text)',failed:'var(--acu-error-text)',cancelled:'var(--acu-text-sub)'};return t.map(t=>{const o=t,i='contest'===t.historyType,r=o.left||{},c=o.right||{},s=String(o.effectStatus||''),l=s?e[s]||s:'',d=s&&a[s]||'var(--acu-text-sub)',u=String(o.detailId||o.effectRunId||`${t.historyType}-${t.timestamp}`),p=Array.isArray(o.detailLines)?o.detailLines:[],f=Array.isArray(o.effectTrace)?o.effectTrace:[],g=p.map(t=>String(t||'').trim()).filter(Boolean),m=f.map(t=>String(t||'').trim()).filter(Boolean),b=g.length>0||m.length>0,v=b&&eo.has(u);let x=String(o.attrName||'检定'),w=String(o.outcomeText||(o.success?'成功':'失败')),y=o.success?'var(--acu-success-text)':'var(--acu-error-text)',k=`${String(o.total??'-')}/${String(o.target??'-')}`,C='普通';if(i){C='对抗',x=`${String(r.name||'发起方')} vs ${String(c.name||'对抗方')}`,w=String(o.message||'对抗检定');y='tie'===String(o.winner||'tie')?'var(--acu-text-sub)':'var(--acu-accent)',k=`${String(r.roll??'-')} : ${String(c.roll??'-')}`}else{const t=String(o.initiatorName||'').trim();t&&(x=`${t} · ${x}`)}const E=o.isPushed?'<i class="fa-solid fa-skull" style="font-size:10px;color:var(--acu-text-sub);margin-left:4px;" title="孤注一掷"></i>':'',A=[];if(g.length>0&&A.push(`<div><div style="font-weight:700; color:var(--acu-text-main); margin-bottom:4px;">检定详情</div>${g.map(t=>h(t)).join('<br>')}</div>`),m.length>0&&A.push(`<div><div style="font-weight:700; color:var(--acu-text-main); margin-bottom:4px;">效果链路</div>${m.map(t=>h(t)).join('<br>')}</div>`),b){const e=[`[${C}] ${x}`,`时间: ${new Date(t.timestamp).toLocaleString('zh-CN')}`];w&&e.push(`结果: ${w}`),k&&e.push(`数值: ${k}`),g.length>0&&e.push('--- 检定详情 ---',...g),m.length>0&&e.push('--- 效果链路 ---',...m),n.set(u,e.join('\n'))}const S=b&&v?`<div style="margin-top:8px; padding:9px 10px; background: color-mix(in srgb, var(--acu-card-bg) 72%, transparent); border:1px solid var(--acu-border); border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:11px; line-height:1.45; color:var(--acu-text-sub); white-space: normal;">${A.join('<div style="height:1px; background:var(--acu-border); margin:8px 0;"></div>')}</div>`:'';return`\n            <div style="padding:10px 12px; border:1px solid var(--acu-border); border-radius:10px; margin-bottom:8px; background:var(--acu-bg-panel);">\n              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">\n                <div style="min-width:0; flex:1;">\n                  <div style="display:flex; align-items:center; gap:6px;">\n                    <span style="font-size:10px; color:var(--acu-text-sub); border:1px solid var(--acu-border); border-radius:999px; padding:1px 7px;">${C}</span>\n                    <span style="font-weight:700; color:var(--acu-text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${h(x)}${E}</span>\n                    ${b?`<button class="acu-history-detail-copy" data-detail-id="${h(u)}" title="复制详情" style="border:1px solid var(--acu-border); background:var(--acu-btn-bg); color:var(--acu-text-sub); border-radius:6px; width:24px; height:24px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0;"><i class="fa-solid fa-copy"></i></button>`:''}\n                  </div>\n                  <div style="margin-top:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap; font-size:12px;">\n                    <span style="color:${y}; font-weight:700;">${h(w)}</span>\n                    <span style="color:var(--acu-text-sub); font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">${h(k)}</span>\n                    ${l?`<span style="color:${d}; border:1px solid color-mix(in srgb, ${d} 40%, transparent); border-radius:999px; padding:1px 7px; font-size:11px;">效果:${l}</span>`:''}\n                  </div>\n                </div>\n                <div style="display:flex; align-items:center; gap:5px; flex-shrink:0;">\n                  <span style="font-size:12px; color:var(--acu-text-sub);">${new Date(t.timestamp).toLocaleTimeString('zh-CN',{hour12:!1})}</span>\n                  ${b?`<button class="acu-history-trace-toggle" data-run-id="${h(u)}" style="border:none;background:transparent;color:var(--acu-text-sub);cursor:pointer;padding:2px 4px;font-size:13px;" title="${v?'收起详情':'展开详情'}">${v?'▼':'▶'}</button>`:''}\n                </div>\n              </div>\n              ${S}\n            </div>\n          `}).join('')},a=$(`\n      <div class="acu-edit-overlay acu-dice-history-overlay">\n        <div class="acu-edit-dialog ${t}" style="max-width:600px; width:min(94vw,600px); max-height:82vh; display:flex; flex-direction:column; padding:14px;">\n          <div style="display:flex; justify-content:space-between; align-items:center; padding-bottom:8px; border-bottom:1px solid var(--acu-border);">\n            <div style="font-size:19px; color:var(--acu-text-main); font-weight:700; display:flex; align-items:center; gap:8px;"><i class="fa-solid fa-clock-rotate-left" style="color:var(--acu-accent);"></i> 检定历史</div>\n            <button class="acu-close-btn acu-history-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px; margin-top:6px; align-items:center;">\n            <select id="acu-history-scope-filter" class="acu-dice-select" style="width:100%; min-width:0;">\n              <option value="chat">本聊天</option>\n              <option value="character">本角色卡</option>\n              <option value="global">全局</option>\n            </select>\n            <select id="acu-history-status-filter" class="acu-dice-select" style="width:100%; min-width:0;">\n              <option value="all">全部状态</option>\n              <option value="planned">待执行</option>\n              <option value="confirmed">已确认</option>\n              <option value="committed">已提交</option>\n              <option value="failed">失败</option>\n              <option value="cancelled">已取消</option>\n            </select>\n            <div style="position:relative; min-width:0;">\n              <i class="fa-solid fa-search" style="position:absolute; left:11px; top:50%; transform:translateY(-50%); font-size:12px; color:var(--acu-text-sub); pointer-events:none;"></i>\n              <input id="acu-history-search" class="acu-dice-input" style="width:100%; padding-left:34px !important;" placeholder="搜索" value="${h(oo)}">\n            </div>\n          </div>\n          <div id="acu-dice-history-stats" style="margin-top:2px; padding:9px; border:1px solid var(--acu-border); border-radius:8px; background:var(--acu-card-bg);"></div>\n          <div id="acu-dice-history-list" style="margin-top:8px; overflow-y:auto; flex:1; min-height:220px; max-height:52vh; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; touch-action:pan-y;">\n            ${e()}\n          </div>\n          <div style="display:flex; justify-content:flex-end; gap:8px; padding-top:10px; border-top:1px solid var(--acu-border); margin-top:8px;">\n            <button class="acu-dialog-btn" id="acu-history-clear" style="background:var(--acu-btn-bg); border-color:var(--acu-border);"><i class="fa-solid fa-trash"></i> 清理历史</button>\n            <button class="acu-dialog-btn acu-history-close"><i class="fa-solid fa-times"></i> 关闭</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(a);const o=async()=>{const t=a.find('#acu-dice-history-stats');if(0===t.length)return;const n=await St.getDashboardStats(),e=n[io],o=Nt(),i=window.innerWidth<=640,r='chat'===io&&'unknown_chat'===o.chatId||'character'===io&&'unknown_character'===o.characterId;t.html(`\n        <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:${i?'6px':'8px'}; margin-bottom:8px;">\n          <div style="padding:${i?'6px':'8px'}; border:1px solid var(--acu-border); border-radius:6px;"><div style="font-size:${i?'10px':'11px'}; color:var(--acu-text-sub);">本聊天检定数</div><div style="font-size:${i?'16px':'18px'}; font-weight:700; color:var(--acu-text-main);">${n.chat.total}</div></div>\n          <div style="padding:${i?'6px':'8px'}; border:1px solid var(--acu-border); border-radius:6px;"><div style="font-size:${i?'10px':'11px'}; color:var(--acu-text-sub);">本角色卡检定数</div><div style="font-size:${i?'16px':'18px'}; font-weight:700; color:var(--acu-text-main);">${n.character.total}</div></div>\n          <div style="padding:${i?'6px':'8px'}; border:1px solid var(--acu-border); border-radius:6px;"><div style="font-size:${i?'10px':'11px'}; color:var(--acu-text-sub);">全局检定数</div><div style="font-size:${i?'16px':'18px'}; font-weight:700; color:var(--acu-text-main);">${n.global.total}</div></div>\n        </div>\n        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; font-size:${i?'11px':'12px'};">\n          <div style="color:var(--acu-text-sub);">当前统计范围：${{chat:'本聊天',character:'本角色卡',global:'全局'}[io]}</div>\n          <div style="display:flex; gap:8px; flex-wrap:wrap;">\n            <span style="color:var(--acu-text-main);">总数：<b>${e.total}</b></span>\n            <span style="color:var(--acu-text-main);">普通：<b>${e.checks}</b></span>\n            <span style="color:var(--acu-text-main);">对抗：<b>${e.contests}</b></span>\n            <span style="color:var(--acu-text-main);">成功率：<b style="color:var(--acu-success-text);">${e.checkSuccessRate}%</b></span>\n          </div>\n        </div>\n        ${r?'<div style="margin-top:6px; font-size:11px; color:var(--acu-text-sub);">当前环境未识别到该范围ID，仅显示可识别范围数据。</div>':''}\n      `)},i=()=>{a.find('#acu-dice-history-list').html(e()),o()};a.find('#acu-history-status-filter').val(ao),a.find('#acu-history-scope-filter').val(io);const r=()=>i(),c=Boolean(window.AcuDice&&'function'==typeof window.AcuDice.on);c&&(window.AcuDice.on('check',r),window.AcuDice.on('contest',r),window.AcuDice.on('effect_run',r)),o(),a.on('change','#acu-history-scope-filter',function(){const t=String($(this).val()||'chat');io='character'===t||'global'===t?t:'chat',o()}),a.on('change','#acu-history-status-filter',function(){ao=String($(this).val()||'all'),i()}),a.on('input','#acu-history-search',function(){oo=String($(this).val()||''),i()}),a.on('touchstart touchmove','#acu-dice-history-list',function(t){t.stopPropagation()}),a.on('click','.acu-history-trace-toggle',function(t){t.preventDefault(),t.stopPropagation();const n=String($(this).data('run-id')||'');n&&(eo.has(n)?eo.delete(n):eo.add(n),i())}),a.on('click','.acu-history-detail-copy',async function(t){t.preventDefault(),t.stopPropagation();const e=String($(this).data('detail-id')||''),a=(n.get(e)||'').trim();if(!a)return void(window.toastr&&window.toastr.warning('没有可复制的详情'));const o=await(async t=>{try{if(window.TavernHelper&&window.TavernHelper.triggerSlash){const n=t.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\{/g,'\\{').replace(/\}/g,'\\}');return await window.TavernHelper.triggerSlash(`/clipboard-set "${n}"`),!0}}catch(t){console.warn('[DICE] history copy via TavernHelper failed:',t)}try{if(navigator.clipboard&&window.isSecureContext)return await navigator.clipboard.writeText(t),!0}catch(t){console.warn('[DICE] history copy via navigator.clipboard failed:',t)}try{const n=document.createElement('textarea');n.value=t,n.style.position='fixed',n.style.left='-9999px',n.style.top='0',n.setAttribute('readonly',''),document.body.appendChild(n),n.select(),n.setSelectionRange(0,99999);const e=document.execCommand('copy');return document.body.removeChild(n),e}catch(t){return console.error('[DICE] history copy fallback failed:',t),!1}})(a);window.toastr&&(o?window.toastr.success('详情已复制'):window.toastr.error('复制失败'))}),a.on('click','#acu-history-clear',async function(t){t.preventDefault(),t.stopPropagation();window.confirm('确定清理检定历史吗？此操作会清空当前会话内历史和统计库记录。')&&(Qa.length=0,to.length=0,eo.clear(),await St.clear(),i(),window.toastr&&window.toastr.success('检定历史已清理'))});const s=()=>{c&&(window.AcuDice.off('check',r),window.AcuDice.off('contest',r),window.AcuDice.off('effect_run',r)),a.remove()};a.on('click','.acu-history-close',s),y(a,'acu-dice-history-overlay',s)};function co(t,n){'check'!==t&&'contest'!==t||St.recordEvent(t,n);const e=Ka.get(t);e&&e.forEach(t=>{try{t(n)}catch(t){console.error('[AcuDice] Event handler error:',t)}})}const so={version:'1.2.0',roll(t){if(!t||'string'!=typeof t)throw new Error('[AcuDice] roll() 需要一个有效的骰子表达式字符串');const n=/\d*d(\d+|F)/i.test(t),e=/^[\d\s+\-*/().]+$/.test(t.trim());if(!n&&!e)throw new Error(`[AcuDice] 无效的骰子表达式: ${t}`);const a=mn(t,{});return{total:a,formula:t,breakdown:`${t} = ${a}`}},async check(t={}){const n=qt(),e=t.diceType||n.lastDiceType||'1d100',a='gte'===(t.successCriteria||('1d20'===e?'gte':'lte')),o=t.modifier||0;let i=t.targetValue;if(void 0===i&&(t.attribute||t.skill)){const n=t.attribute||t.skill||'',e=Yn||pa();if(e)for(const t in e){const a=e[t];if('主角信息'===a?.name&&a.content?.[1]){const t=a.content[0]||[],e=a.content[1];for(let a=0;a<t.length;a++){const o=t[a];if(o&&(o.includes('属性')||o.includes('技能'))){const t=In(e[a]||'').find(t=>t.name===n);if(t){i=t.value;break}}}if(void 0!==i)break}}if(void 0===i)throw new Error(`[AcuDice] 未找到属性或技能: ${n}`)}if(void 0===i)throw new Error('[AcuDice] check() 需要 targetValue 或有效的 attribute/skill 名称');const r=gn(e);if(Number.isNaN(r.total))throw new Error(`[AcuDice] 无效的骰子表达式: ${e}`);const c=r.total+o,s=i;let l=!1,d=!1,u=!1,p='';if(a)l=c>=s,d=r.total===n.dndCritSuccess,u=r.total===n.dndCritFail,d?(l=!0,p=`大成功！掷出 ${r.total}${o?` + ${o}`:''} = ${c}，DC ${s}`):u?(l=!1,p=`大失败！掷出 ${r.total}${o?` + ${o}`:''} = ${c}，DC ${s}`):p=l?`成功！掷出 ${c} >= DC ${s}`:`失败！掷出 ${c} < DC ${s}`;else if(l=c<=s,d=c<=n.critSuccessMax,u=c>=n.critFailMin,d)l=!0,p=`大成功！掷出 ${c}，目标 ${s}`;else if(u)l=!1,p=`大失败！掷出 ${c}，目标 ${s}`;else if(l){const t=c<=Math.floor(s/n.hardSuccessDiv);p=c<=Math.floor(s/n.difficultSuccessDiv)?`极难成功！掷出 ${c} <= ${Math.floor(s/n.difficultSuccessDiv)}`:t?`困难成功！掷出 ${c} <= ${Math.floor(s/n.hardSuccessDiv)}`:`成功！掷出 ${c} <= ${s}`}else p=`失败！掷出 ${c} > ${s}`;const f={success:l,total:c,target:s,outcomeText:p,attrName:t.attribute||t.skill||'',formula:e,criteria:a?'gte':'lte',isAutoTarget:void 0===t.targetValue},g=`check_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,m=t.attribute||t.skill||'未指定',b={...f,timestamp:Date.now(),detailId:g,initiatorName:'API',historyType:'check',detailLines:['发起者: API',`属性: ${m} (值=${s})`,`公式: ${e}`,`掷骰: ${c}`,`目标: ${s}`,...o?[`修正: ${o>=0?'+'+o:o}`]:[],`结果: ${p}`]};return Qa.push(b),Qa.length>no&&Qa.shift(),co('check',b),{success:l,roll:c,target:s,margin:a?c-s:s-c,criticalSuccess:d,criticalFailure:u,message:p,diceType:e,rule:a?'dnd':'coc'}},onReady(t){'function'==typeof t?Wa?Ja(t):Ya.push(t):console.warn('[AcuDice] onReady() 需要一个函数')},on(t,n){Ka.has(t)||Ka.set(t,new Set),Ka.get(t).add(n)},off(t,n){const e=Ka.get(t);e&&e.delete(n)},getLatestCheck:()=>Qa.length>0?Qa[Qa.length-1]:null,getLatestContest:()=>to.length>0?to[to.length-1]:null,getHistory(t){const n=t?.limit,e=t?.type;let a=[];return e&&'check'!==e||(a=a.concat(Qa.map(t=>({...t,_type:'check'})))),e&&'contest'!==e||(a=a.concat(to.map(t=>({...t,_type:'contest'})))),a.sort((t,n)=>n.timestamp-t.timestamp),n&&n>0&&(a=a.slice(0,n)),a},listPresets:()=>on.getAllPresets().map(t=>({id:t.id,name:t.name,description:t.description||'',builtin:!!t.builtin})),getActivePresetId(){const t=on.getActivePresetId();return'__none__'===t?null:t},getPresetSummary(t){const n=on.getPresetById(t);return n?{id:n.id,name:n.name,description:n.description||'',builtin:!!n.builtin}:null},listCharacters(){const t=Yn||pa();if(!t)return[];const n=_a(t||{}),e=[],a=yn.findTable(n,'player');a?.data?.rows?.length>0&&e.push('<user>');const o=yn.findTable(n,'npc');if(o){yn.parseRows(o,'npc').forEach(t=>{t.name&&'string'==typeof t.name&&e.push(t.name)})}return e},getCharacterAttributes(t){if(!t||'string'!=typeof t)throw new Error('[AcuDice] getCharacterAttributes() 需要一个有效的角色名');return Ue(t)},getAttributeValue(t,n){if(!t||'string'!=typeof t)throw new Error('[AcuDice] getAttributeValue() 需要一个有效的角色名');if(!n||'string'!=typeof n)throw new Error('[AcuDice] getAttributeValue() 需要一个有效的属性名');return Fe(t,n)},async checkByCharacter(t){if(!t||!t.name||!t.attribute)throw new Error('[AcuDice] checkByCharacter() 需要 name 和 attribute 参数');const n=Fe(t.name,t.attribute);if(null===n)throw new Error(`[AcuDice] 未找到角色 "${t.name}" 的属性 "${t.attribute}"`);return this.check({attribute:t.attribute,targetValue:n,modifier:t.modifier,diceType:t.diceType,successCriteria:t.successCriteria})},async contest(t){const n=t?.left||t?.attacker,e=t?.right||t?.defender;if(!n?.name||!n?.attribute)throw new Error('[AcuDice] contest() 需要 left.name 和 left.attribute 参数');if(!e?.name||!e?.attribute)throw new Error('[AcuDice] contest() 需要 right.name 和 right.attribute 参数');try{const t=Yn||pa();t&&Bt.rebuild(_a(t||{}))}catch(t){console.warn('[AcuDice] contest() 别名映射刷新失败',t)}const a='<user>'===n.name?n.name:Bt.resolve(n.name),o='<user>'===e.name?e.name:Bt.resolve(e.name);let i=n.targetValue??null;if(null===i&&(i=Fe(a,n.attribute),null===i))throw new Error(`[AcuDice] 未找到角色 "${a}" 的属性 "${n.attribute}"`);let r=e.targetValue??null;if(null===r&&(r=Fe(o,e.attribute),null===r))throw new Error(`[AcuDice] 未找到角色 "${o}" 的属性 "${e.attribute}"`);const c=qt(),s=c.lastDiceType||'1d100',l=gn(s).total,d=gn(s).total;if(Number.isNaN(l)||Number.isNaN(d))throw new Error(`[AcuDice] 无效的骰子公式: ${s}`);const u=s.match(/\d+d(\d+)/i),p=u?parseInt(u[1],10):100,f=Je(l,i,p),g=Je(d,r,p);let m,b;if(f.level>g.level)m='left',b=`${a} 胜利！(${f.name} 胜过 ${g.name})`;else if(f.level<g.level)m='right',b=`${o} 胜利！(${g.name} 胜过 ${f.name})`;else{const n=t.rule||c.contestTieRule||'initiator_lose';b=`双方平手！(均为 ${f.name})`,'initiator_win'===n?(m='left',b+=` - ${a} 判胜`):'tie'===n?m='tie':(m='right',b+=` - ${a} 判负`)}const h={left:{name:a,attribute:n.attribute,roll:l,target:i,successLevel:f.level},right:{name:o,attribute:e.attribute,roll:d,target:r,successLevel:g.level},winner:m,message:b};return co('contest',h),to.push({...h,timestamp:Date.now(),detailId:`contest_${Date.now()}_${Math.random().toString(36).slice(2,8)}`,detailLines:[`发起方: ${h.left.name} / 对抗方: ${h.right.name}`,`属性: ${h.left.attribute} vs ${h.right.attribute}`,`掷骰: ${h.left.roll} vs ${h.right.roll}`,`目标: ${h.left.target} vs ${h.right.target}`,`胜者: ${'left'===h.winner?h.left.name:'right'===h.winner?h.right.name:'平局'}`,`说明: ${h.message}`]}),to.length>no&&to.shift(),h}};if(Ha(window),qa!==window)try{Ha(qa)}catch(t){console.warn('[AcuDice] 无法写入顶层窗口，可能跨域',t)}(()=>{if(!Wa){Wa=!0;for(const t of Ya)Ja(t);Ya.length=0}})(),Xa(window),qa!==window&&Xa(qa),console.info('[AcuDice] API v1.2.0 已加载');const lo=(t,n)=>{const{$}=le();$('.acu-fav-edit-overlay').remove();const e=`\n      <div class="acu-fav-edit-overlay acu-theme-${ca().theme}">\n        <div class="acu-fav-edit-modal">\n          <div class="acu-fav-edit-modal-header">\n            <h4>编辑收藏</h4>\n            <button class="acu-fav-edit-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-fav-edit-modal-body">\n            <div class="acu-fav-edit-tags-section">\n              <label>标签 (逗号分隔):</label>\n              <input type="text" id="acu-fav-edit-tags" value="${h(t.tags.join(', '))}" />\n            </div>\n            <div class="acu-fav-edit-rows">\n              ${a=t.header,o=t.rowData,a.map((t,n)=>`\n        <div class="acu-fav-edit-row" data-index="${n}">\n          <input type="text" class="acu-fav-edit-header" value="${h(t)}" placeholder="列名" />\n          <input type="text" class="acu-fav-edit-value" value="${h(String(o[n]||''))}" placeholder="值" />\n          <button class="acu-fav-edit-remove" title="删除列"><i class="fa-solid fa-minus"></i></button>\n        </div>\n      `).join('')}\n            </div>\n            <button class="acu-fav-edit-add-col"><i class="fa-solid fa-plus"></i> 添加列</button>\n          </div>\n          <div class="acu-fav-edit-modal-footer">\n            <button class="acu-fav-edit-cancel">取消</button>\n            <button class="acu-fav-edit-save">保存</button>\n          </div>\n        </div>\n      </div>\n    `;var a,o;$('body').append(e);const i=$('.acu-fav-edit-overlay'),r=i.find('.acu-fav-edit-modal'),c=()=>i.remove();i.on('click',t=>{$(t.target).hasClass('acu-fav-edit-overlay')&&c()}),r.find('.acu-fav-edit-close, .acu-fav-edit-cancel').on('click',c),r.on('click','.acu-fav-edit-remove',function(){$(this).closest('.acu-fav-edit-row').remove()}),r.find('.acu-fav-edit-add-col').on('click',()=>{const t=`\n        <div class="acu-fav-edit-row" data-index="${r.find('.acu-fav-edit-row').length}">\n          <input type="text" class="acu-fav-edit-header" value="" placeholder="列名" />\n          <input type="text" class="acu-fav-edit-value" value="" placeholder="值" />\n          <button class="acu-fav-edit-remove" title="删除列"><i class="fa-solid fa-minus"></i></button>\n        </div>\n      `;r.find('.acu-fav-edit-rows').append(t)}),r.find('.acu-fav-edit-save').on('click',()=>{const t=[],e=[];r.find('.acu-fav-edit-row').each(function(){const n=$(this).find('.acu-fav-edit-header').val(),a=$(this).find('.acu-fav-edit-value').val();n.trim()&&(t.push(n.trim()),e.push(a))});const a=(r.find('#acu-fav-edit-tags').val()||'').split(',').map(t=>t.trim()).filter(t=>t.length>0);n({header:t,rowData:e,tags:a}),c()})},uo=(t,n,e,a)=>{const{$}=le();$('.acu-fav-send-overlay').remove();const o=ca(),i=n.map(n=>{const e='strict'===n.mode?'<span class="acu-match-full">✓ 完全匹配</span>':`<span class="acu-match-partial">⚠ 部分匹配 (${n.matchedCols.length}/${t.header.length}列)</span>`,a=n.unmatchedCols.length>0?`<div class="acu-fav-send-unmatched">未匹配: ${n.unmatchedCols.join(', ')}</div>`:'';return`\n        <div class="acu-fav-send-option" data-uid="${h(n.tableUid)}" data-mode="${n.mode}">\n          <div class="acu-fav-send-option-name">${h(n.tableName)}</div>\n          <div class="acu-fav-send-option-mode">${e}</div>\n          ${a}\n        </div>\n      `}).join(''),r=`\n      <div class="acu-fav-send-overlay acu-theme-${o.theme}">\n        <div class="acu-fav-send-modal">\n          <div class="acu-fav-send-modal-header">\n            <h4>选择目标表格</h4>\n            <button class="acu-fav-send-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-fav-send-modal-body">\n            ${i}\n          </div>\n          <div class="acu-fav-send-modal-footer">\n            <button class="acu-fav-send-cancel">取消</button>\n          </div>\n        </div>\n      </div>\n    `;$('body').append(r);const c=$('.acu-fav-send-overlay'),s=c.find('.acu-fav-send-modal'),l=()=>c.remove();c.on('click',t=>{$(t.target).hasClass('acu-fav-send-overlay')&&l()}),s.find('.acu-fav-send-close, .acu-fav-send-cancel').on('click',l),s.on('click','.acu-fav-send-option',async function(){const n=$(this).data('uid'),o=$(this).data('mode'),i=e[n];if(!i||!i.content)return void toastr.error('无法获取目标表格');const r=i.content[0].slice(1).map(t=>String(t||'')),c=It.mapRowToTable(t,r);i.content.push(c);const s=Yn||pa();if(s&&s[n]?.content){s[n].content=i.content,Yn=s;try{await $a(s,[n]),console.log('[DICE]FavoritesManager 发送成功，已写入数据库')}catch(t){return console.error('[DICE]FavoritesManager 写入数据库失败:',t),void toastr.error('写入数据库失败: '+(t.message||t))}if('loose'===o){const n=t.header.filter(t=>!r.includes(t)).length;n>0&&toastr.info(`${n}列未匹配，已填充空值`)}l(),a()}else toastr.error('无法获取目标表格数据')})},po=()=>{const{$}=le();$('.acu-edit-overlay').not(':has(.acu-settings-dialog)').remove(),Bn.length=0,On('showSettingsModal',po),Rn=!0;const t=ca(),n=`acu-theme-${t.theme}`,e=fe.get('acu_settings_expanded',['appearance']),a=t=>e.includes(t),o=[{key:'__dice__',name:'投骰',icon:'fa-dice-d20'},{key:'__changes__',name:'变更审核',icon:'fa-code-compare'},{key:'__mvu__',name:'MVU变量',icon:'fa-code-branch'},{key:'__favorites__',name:'收藏夹',icon:'fa-star'}],i=(()=>{const t=Yn||pa(),n=_a(t||{}),e=ve()||[],a=Se();let i=[];if(o.forEach(t=>{i.push({key:t.key,name:t.name,icon:t.icon,isSpecial:!0})}),Object.keys(n).forEach(t=>{i.push({key:t,name:t,icon:ue(t),isSpecial:!1})}),e.length>0){const t=new Map(e.map((t,n)=>[t,n]));i.sort((n,e)=>(t.has(n.key)?t.get(n.key):9999)-(t.has(e.key)?t.get(e.key):9999))}return i.map(t=>{const n=a.includes(t.key),e=t.isSpecial?' acu-special-item':'',o=t.name;return'<div class="acu-table-manager-item'+e+(n?' hidden-table':'')+'" data-table-name="'+h(t.key)+'" draggable="false"><div class="acu-table-item-check" title="点击切换显示/隐藏"><i class="fa-solid '+(n?'fa-eye-slash':'fa-eye')+'"></i></div><div class="acu-table-item-icon"><i class="fa-solid '+t.icon+'"></i></div><div class="acu-table-item-name">'+h(o)+'</div><div class="acu-table-item-handle" title="拖拽排序"><i class="fa-solid fa-grip-vertical"></i></div></div>'}).join('')})(),r=t=>a(t)?'fa-chevron-down':'fa-chevron-right',c=$(`\n        <div class="acu-edit-overlay">\n            <div class="acu-edit-dialog acu-settings-dialog ${n}">\n                <div class="acu-settings-header">\n                    <div class="acu-settings-title">\n                        <span class="acu-settings-text">\n                            <i class="fa-solid fa-cog"></i> 设置\n                            <span class="acu-version-badge">v4.00</span><button class="acu-manual-update-btn" id="acu-manual-update-btn" title="清理缓存并刷新以获取最新版本"><i class="fa-solid fa-rotate"></i></button>\n                        </span>\n                    </div>\n                    <div class="acu-header-actions">\n                        <button class="acu-help-btn" id="acu-help-btn" title="查看使用文档"><i class="fa-solid fa-question-circle"></i></button>\n                        <button class="acu-close-btn" id="dlg-close-x"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                </div>\n\n                <div class="acu-settings-body">\n                \x3c!-- 外观样式 --\x3e\n                <div class="acu-settings-group ${a('appearance')?'':'collapsed'}" data-group="appearance">                    <div class="acu-settings-group-title">\n                        <i class="fa-solid ${r('appearance')} acu-group-chevron"></i>\n                        <i class="fa-solid fa-palette"></i> 外观样式\n                    </div>\n                    <div class="acu-settings-group-body">\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">背景主题</span>\n                            </div>\n                            <select id="cfg-theme" class="acu-setting-select">\n                                ${ce.map(n=>`<option value="${n.id}" ${n.id===t.theme?'selected':''}>${n.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">字体风格</span>\n                            </div>\n                            <select id="cfg-font-family" class="acu-setting-select">\n                                ${re.map(n=>`<option value="${n.id}" ${n.id===t.fontFamily?'selected':''}>${n.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">字体大小 (界面)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-main" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${t.fontSize}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">字体大小 (选项)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-opt" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${t.optionFontSize||12}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row acu-setting-row-toggle">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">高亮变化内容</span>\n                            </div>\n                            <label class="acu-toggle">\n                                <input type="checkbox" id="cfg-new" ${t.highlightNew?'checked':''}>\n                                <span class="acu-toggle-slider"></span>\n                            </label>\n                        </div>\n                    </div>\n                </div>\n\n                    \x3c!-- 布局设置 --\x3e\n                    <div class="acu-settings-group ${a('layout')?'':'collapsed'}" data-group="layout">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${r('layout')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-th-large"></i> 布局设置\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">卡片宽度</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-width" data-min="200" data-max="500" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${t.cardWidth}px</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">布局模式</span>\n                                </div>\n                                <select id="cfg-layout" class="acu-setting-select">\n                                    <option value="horizontal" ${'vertical'!==t.layout?'selected':''}>横向滚动</option>\n                                    <option value="vertical" ${'vertical'===t.layout?'selected':''}>竖向滚动</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">底部按钮列数</span>\n                                    <span class="acu-setting-hint">仅移动端</span>\n                                </div>\n                                <select id="cfg-grid-cols" class="acu-setting-select acu-select-short">\n                                    <option value="2" ${2==t.gridColumns?'selected':''}>2列</option>\n                                    <option value="3" ${3==t.gridColumns?'selected':''}>3列</option>\n                                    <option value="4" ${4==t.gridColumns?'selected':''}>4列</option>\n                                    <option value="auto" ${'auto'===t.gridColumns?'selected':''}>自动</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">每页显示条数</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-per-page" data-min="10" data-max="200" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${t.itemsPerPage}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n\n                    \x3c!-- 位置与交互 --\x3e\n                    <div class="acu-settings-group ${a('position')?'':'collapsed'}" data-group="position">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${r('position')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-arrows-alt"></i> 位置与交互\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">面板位置</span>\n                                </div>\n                                <select id="cfg-position" class="acu-setting-select">\n                                    <option value="fixed" ${'embedded'!==t.positionMode?'selected':''}>悬浮底部</option>\n                                    <option value="embedded" ${'embedded'===t.positionMode?'selected':''}>跟随消息</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">功能按钮位置</span>\n                                </div>\n                                <select id="cfg-action-pos" class="acu-setting-select acu-select-short">\n                                    <option value="bottom" ${'top'!==t.actionsPosition?'selected':''}>底部</option>\n                                    <option value="top" ${'top'===t.actionsPosition?'selected':''}>顶部</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">收起样式</span>\n                                </div>\n                                <select id="cfg-col-style" class="acu-setting-select acu-select-short">\n                                    <option value="bar" ${'bar'===t.collapseStyle?'selected':''}>长条</option>\n                                    <option value="pill" ${'pill'===t.collapseStyle?'selected':''}>胶囊</option>\n                                    <option value="mini" ${'mini'===t.collapseStyle?'selected':''}>圆钮</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row" id="cfg-col-align-row" style="${'bar'===t.collapseStyle?'display:none;':''}">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">收起位置</span>\n                                </div>\n                                <select id="cfg-col-align" class="acu-setting-select acu-select-short">\n                                    <option value="right" ${'right'===t.collapseAlign?'selected':''}>靠右</option>\n                                    <option value="left" ${'left'===t.collapseAlign?'selected':''}>靠左</option>\n                                    <option value="center" ${'center'===t.collapseAlign?'selected':''}>居中</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 行动选项 --\x3e\n                    <div class="acu-settings-group ${a('options')?'':'collapsed'}" data-group="options">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${r('options')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-gamepad"></i> 行动选项\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row acu-setting-row-toggle">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">显示行动选项面板</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-show-opt" ${!1!==t.showOptionPanel?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                            <div class="acu-setting-row acu-setting-row-toggle" id="row-auto-send" style="${!1!==t.showOptionPanel?'':'display:none;'}">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">点击选项直接发送</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-auto-send" ${!1!==t.clickOptionToAutoSend?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                    </div>\n\n                \x3c!-- 表格管理 --\x3e\n                    <div class="acu-settings-group ${a('tables')?'':'collapsed'}" data-group="tables">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${r('tables')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-table"></i> 表格管理\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-table-manager-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> 点击切换显示，长按拖拽排序\n                            </div>\n                            <div class="acu-table-manager-list" id="table-manager-list">\n                                ${i}\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 数据验证规则 --\x3e\n                    <div class="acu-settings-group ${a('validation')?'':'collapsed'}" data-group="validation">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${r('validation')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-clipboard-check"></i> 数据验证规则\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- 预设选择器 --\x3e\n                            <div class="acu-setting-row" style="margin-bottom:8px;">\n                                <span>当前预设</span>\n                                <select class="acu-setting-select" id="preset-select" style="flex:1;max-width:160px;">\n                                    ${wt.getAllPresets().map(t=>`<option value="${h(t.id)}" ${t.id===wt.getActivePreset()?.id?'selected':''}>${h(t.name)}${'default'===t.id?` v${Q}`:t.builtin?' (内置)':''}</option>`).join('')}\n                                </select>\n                            </div>\n                            \x3c!-- 预设操作按钮 --\x3e\n                            <div style="display:flex;gap:6px;margin-bottom:10px;">\n                                <button class="acu-action-btn" id="btn-preset-dup" title="复制预设" style="flex:1;height:28px;"><i class="fa-solid fa-copy"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-new" title="新建预设" style="flex:1;height:28px;"><i class="fa-solid fa-plus"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-del" title="删除预设" style="flex:1;height:28px;"><i class="fa-solid fa-trash"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-export" title="导出" style="flex:1;height:28px;"><i class="fa-solid fa-file-export"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-import" title="导入" style="flex:1;height:28px;"><i class="fa-solid fa-file-import"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-reset" title="恢复默认预设规则" style="flex:1;height:28px;"><i class="fa-solid fa-rotate-left"></i></button>\n                            </div>\n                            <div class="acu-validation-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> 验证规则用于检测数据合法性，<i class="fa-solid fa-shield-halved"></i> 表示启用拦截\n                            </div>\n                            <div class="acu-validation-rules-list" id="validation-rules-list">\n                                ${yt.getAllRules().map(t=>{const n=pt[t.ruleType]||{name:t.ruleType,icon:'fa-question'},e='table'===n.scope,a=t.intercept;return`\n                                    <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${h(t.id)}">\n                                        <div class="acu-rule-type-icon" title="${h(n.name)}${e?' (表级)':''}">\n                                            <i class="fa-solid ${n.icon}"></i>\n                                        </div>\n                                        <div class="acu-rule-info">\n                                            <div class="acu-rule-name">${h(t.name)}</div>\n                                            <div class="acu-rule-target">${h(t.targetTable)}${t.targetColumn?'.'+h(t.targetColumn):e?' (整表)':''}</div>\n                                        </div>\n                                        <div class="acu-rule-intercept ${a?'active':''}" data-rule-id="${h(t.id)}" title="${a?'点击关闭拦截':'点击启用拦截（违反时回滚）'}"><i class="fa-solid fa-shield-halved"></i></div>\n                                        <button class="acu-rule-edit" data-rule-id="${h(t.id)}" title="编辑此规则" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n                                        <div class="acu-rule-toggle ${t.enabled?'active':''}" title="点击切换启用/禁用">\n                                            <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n                                        </div>\n                                        <button class="acu-rule-delete" data-rule-id="${h(t.id)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n                                    </div>\n                                `}).join('')}\n                            </div>\n                            <button class="acu-add-rule-btn" id="btn-add-validation-rule">\n                                <i class="fa-solid fa-plus"></i> 添加自定义验证规则\n                            </button>\n                        </div>\n                    </div>\n\n                    \x3c!-- 正则转换规则 - Phase 4.1 --\x3e\n                    <div class="acu-settings-group ${a('regex')?'':'collapsed'}" data-group="regex">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${r('regex')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-wand-magic-sparkles"></i> 正则转换规则\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- 预设选择器 --\x3e\n                            <div class="acu-setting-row" style="margin-bottom:8px;">\n                                <span>当前预设</span>\n                                <select class="acu-setting-select" id="regex-preset-select" style="flex:1;max-width:160px;">\n                                    ${kt.getAllPresets().map(t=>`<option value="${h(t.id)}" ${t.id===kt.getActivePreset()?.id?'selected':''}>${h(t.name)}${'regex_default'===t.id?` v${Q}`:''}</option>`).join('')}\n                                </select>\n                            </div>\n                            \x3c!-- 预设操作按钮 --\x3e\n                            <div style="display:flex;gap:6px;margin-bottom:10px;">\n                                <button class="acu-action-btn" id="btn-regex-preset-dup" title="复制预设" style="flex:1;height:28px;"><i class="fa-solid fa-copy"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-new" title="新建预设" style="flex:1;height:28px;"><i class="fa-solid fa-plus"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-del" title="删除预设" style="flex:1;height:28px;"><i class="fa-solid fa-trash"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-export" title="导出" style="flex:1;height:28px;"><i class="fa-solid fa-file-export"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-import" title="导入" style="flex:1;height:28px;"><i class="fa-solid fa-file-import"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-reset" title="恢复默认预设" style="flex:1;height:28px;"><i class="fa-solid fa-rotate-left"></i></button>\n                            </div>\n                            <div class="acu-validation-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> 正则转换规则用于自动修改数据库表格内容\n                            </div>\n                            \x3c!-- 规则列表 --\x3e\n                            <div class="acu-validation-rules-list" id="regex-rules-list">\n                                ${$t.getAllRules().map(t=>{const n='global'===t.scope.type?'fa-globe':'table'===t.scope.type?'fa-table':'fa-columns',e='global'===t.scope.type?'全局':'table'===t.scope.type?t.scope.tableNames?.join(','):`${t.scope.tableNames?.join(',')}.${t.scope.columnNames?.join(',')}`;return`\n                                    <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${h(t.id)}">\n                                        <div class="acu-rule-type-icon" title="作用域: ${h(t.scope.type)}">\n                                            <i class="fa-solid ${n}"></i>\n                                        </div>\n                                        <div class="acu-rule-info">\n                                            <div class="acu-rule-name">${h(t.name)}</div>\n                                            <div class="acu-rule-target" style="font-size:10px;">${h(e)} | ${h(t.operation)}</div>\n                                        </div>\n                                        <button class="acu-rule-edit" data-rule-id="${h(t.id)}" title="编辑此规则" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n                                        <div class="acu-rule-toggle ${t.enabled?'active':''}" title="点击切换启用/禁用">\n                                            <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n                                        </div>\n                                        <button class="acu-rule-delete" data-rule-id="${h(t.id)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n                                    </div>\n                                `}).join('')}\n                            </div>\n                            <div style="display:flex;gap:8px;margin-top:8px;">\n                                <button class="acu-add-rule-btn" id="btn-add-regex-rule" style="flex:1;">\n                                    <i class="fa-solid fa-plus"></i> 添加转换规则\n                                </button>\n                                <button class="acu-add-rule-btn" id="btn-import-tavern-regex" style="flex:1;">\n                                    <i class="fa-solid fa-file-import"></i> 导入酒馆正则\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 高级设置 --\x3e\n                    <div class="acu-settings-group ${a('advanced')?'':'collapsed'}" data-group="advanced">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${r('advanced')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-sliders-h"></i> 高级设置\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-dice-d20"></i> 自定义属性规则</span>\n                                </div>\n                                <button id="cfg-attr-preset-manage" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> 管理\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-dice"></i> 检定设置</span>\n                                </div>\n                                <button id="cfg-advanced-preset-manage" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> 管理\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-wand-magic-sparkles"></i> 自定义交互规则</span>\n                                </div>\n                                <button id="cfg-action-preset-manage" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> 管理\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-filter"></i> 变量过滤黑名单</span>\n                                </div>\n                                <button id="cfg-blacklist-manage" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> 管理\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-bug"></i> Debug控制台</span>\n                                </div>\n                                <button id="btn-open-debug-console" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-terminal"></i> 打开\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-trash-can"></i> 清空本地缓存</span>\n                                </div>\n                                <button id="cfg-clear-local-cache" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-eraser"></i> 清空\n                                </button>\n                            </div>\n                            <div class="acu-setting-row acu-setting-row-toggle">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-bell-slash"></i> 屏蔽神-数据库弹窗</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-db-toast-mute" ${t.muteDatabaseToasts?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                </div>\x3c!-- 关闭 .acu-settings-body --\x3e\n            </div>\n        </div>\n    `);$('body').append(c),c.find('.acu-settings-group-title').on('click',function(){const t=$(this).closest('.acu-settings-group'),n=t.find('.acu-settings-group-body');if(n.hasClass('acu-animating'))return;const e=t.data('group'),a=$(this).find('.acu-group-chevron');let o=fe.get('acu_settings_expanded',['appearance']);if(t.hasClass('collapsed')){t.removeClass('collapsed'),a.removeClass('fa-chevron-right').addClass('fa-chevron-down'),o.includes(e)||o.push(e),n.addClass('acu-animating').show();const i=n.prop('scrollHeight');n.css('height',0).animate({height:i},180,function(){$(this).css('height','').removeClass('acu-animating')})}else{t.addClass('collapsed'),a.removeClass('fa-chevron-down').addClass('fa-chevron-right'),o=o.filter(t=>t!==e);const i=n.outerHeight();n.addClass('acu-animating').css('height',i).animate({height:0},180,function(){$(this).hide().css('height','').removeClass('acu-animating')})}fe.set('acu_settings_expanded',o)}),c.find('#cfg-theme').on('change',function(){const t=$(this).val();sa({theme:t}),c.find('.acu-edit-dialog').removeClass(ce.map(t=>`acu-theme-${t.id}`).join(' ')).addClass(`acu-theme-${t}`)}),c.find('#cfg-font-family').on('change',function(){sa({fontFamily:$(this).val()})}),c.find('#cfg-attr-preset-manage').on('click',function(t){t.preventDefault(),t.stopPropagation(),c.remove(),Rn=!1,Ta()}),c.find('#cfg-action-preset-manage').on('click',function(t){t.stopPropagation(),c.remove(),Rn=!1,Oa()}),c.find('#cfg-advanced-preset-manage').on('click',function(t){t.stopPropagation(),c.remove(),Rn=!1,Ra()}),c.find('#cfg-db-toast-mute').on('change',function(){sa({muteDatabaseToasts:$(this).is(':checked')})}),c.find('#cfg-blacklist-manage').on('click',function(t){t.preventDefault(),t.stopPropagation(),za()}),c.find('#cfg-layout').on('change',function(){sa({layout:$(this).val()}),mo()}),c.find('#cfg-grid-cols').on('change',function(){sa({gridColumns:$(this).val()})}),c.find('#cfg-position').on('change',function(){sa({positionMode:$(this).val()}),mo()}),c.find('#cfg-action-pos').on('change',function(){sa({actionsPosition:$(this).val()}),mo()}),c.find('#cfg-col-style').on('change',function(){const t=$(this).val();sa({collapseStyle:t});const n=c.find('#cfg-col-align-row');'bar'===t?n.hide():n.show(),mo()}),c.find('#cfg-col-align').on('change',function(){sa({collapseAlign:$(this).val()}),mo()}),c.find('#cfg-show-opt').on('change',function(){const t=$(this).is(':checked');sa({showOptionPanel:t}),t?c.find('#row-auto-send').slideDown(200):c.find('#row-auto-send').slideUp(200),mo()}),c.find('#cfg-auto-send').on('change',function(){sa({clickOptionToAutoSend:$(this).is(':checked')})}),c.find('#cfg-new').on('change',function(){sa({highlightNew:$(this).is(':checked')}),mo()}),c.find('.acu-table-item-check').on('click',function(t){t.stopPropagation();const n=$(this).closest('.acu-table-manager-item'),e=n.data('table-name');let a=Se();const o=$(this).find('i');var i;a.includes(e)?(a=a.filter(t=>t!==e),n.removeClass('hidden-table'),o.removeClass('fa-eye-slash').addClass('fa-eye')):(a.push(e),n.addClass('hidden-table'),o.removeClass('fa-eye').addClass('fa-eye-slash')),i=a,fe.set(R,i),mo()});const s=c.find('#table-manager-list');Fa({container:s,itemSelector:'.acu-table-manager-item',handleSelector:'.acu-table-item-handle',cancelSelector:'.acu-table-item-check',getItemId:t=>{const n=$(t).data('table-name');return'string'==typeof n?n:null!=n?String(n):null},onOrderChange:t=>{xe(t)}}),c.find('.acu-stepper').each(function(){const t=$(this),n=t.data('id'),e=parseInt(t.data('min')),a=parseInt(t.data('max')),o=parseInt(t.data('step')),i=t.find('.acu-stepper-value'),r=t=>{t=Math.max(e,Math.min(a,t));const o='cfg-per-page'===n?'':'px';i.text(t+o),'cfg-width'===n?($('.acu-wrapper').css('--acu-card-width',t+'px'),sa({cardWidth:t})):'cfg-font-main'===n?($('.acu-wrapper').css('--acu-font-size',t+'px'),sa({fontSize:t})):'cfg-font-opt'===n?($('.acu-wrapper, .acu-embedded-options-container').css('--acu-opt-font-size',t+'px'),sa({optionFontSize:t})):'cfg-per-page'===n&&sa({itemsPerPage:t})},c=()=>{const t=i.text().replace(/[^\d]/g,'');return parseInt(t)||e};t.find('.acu-stepper-dec').on('click',function(){r(c()-o)}),t.find('.acu-stepper-inc').on('click',function(){r(c()+o)})}),c.on('click','.acu-rule-toggle',function(t){t.stopPropagation();const n=$(this),e=n.closest('.acu-validation-rule-item'),a=e.data('rule-id'),o=n.find('i'),i=n.hasClass('active');yt.toggleRuleEnabled(a,!i),i?(n.removeClass('active'),o.removeClass('fa-toggle-on').addClass('fa-toggle-off'),e.addClass('disabled')):(n.addClass('active'),o.removeClass('fa-toggle-off').addClass('fa-toggle-on'),e.removeClass('disabled'))}),c.on('click','#validation-rules-list .acu-rule-edit',function(t){t.stopPropagation();const n=$(this).data('rule-id');yt.getRule(n)&&Ea(c,n)}),c.on('click','#validation-rules-list .acu-rule-delete',function(t){t.stopPropagation();const n=$(this).data('rule-id'),e=$(this).closest('.acu-validation-rule-item');confirm('确定要删除这条自定义规则吗？')&&yt.removeCustomRule(n)&&e.fadeOut(200,function(){$(this).remove()})}),c.on('click','.acu-rule-intercept',function(t){t.stopPropagation();const n=$(this),e=n.data('rule-id'),a=n.hasClass('active');yt.toggleRuleIntercept(e,!a)&&(a?n.removeClass('active').attr('title','点击启用拦截（违反时回滚）'):n.addClass('active').attr('title','点击关闭拦截'))});const l=()=>{yt.clearCache();const t=yt.getAllRules();let n='';t.forEach(t=>{const e=pt[t.ruleType]||{name:t.ruleType,icon:'fa-question'},a='table'===e.scope,o=t.intercept;n+=`\n          <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${h(t.id)}">\n            <div class="acu-rule-type-icon" title="${h(e.name)}${a?' (表级)':''}">\n              <i class="fa-solid ${e.icon}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${h(t.name)}</div>\n              <div class="acu-rule-target">${h(t.targetTable)}${t.targetColumn?'.'+h(t.targetColumn):a?' (整表)':''}</div>\n            </div>\n            <div class="acu-rule-intercept ${o?'active':''}" data-rule-id="${h(t.id)}" title="${o?'点击关闭拦截':'点击启用拦截（违反时回滚）'}"><i class="fa-solid fa-shield-halved"></i></div>\n            <button class="acu-rule-edit" data-rule-id="${h(t.id)}" title="编辑此规则" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n            <div class="acu-rule-toggle ${t.enabled?'active':''}" title="点击切换启用/禁用">\n              <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${h(t.id)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n          </div>`}),c.find('#validation-rules-list').html(n)};c.find('#preset-select').on('change',function(){wt.setActivePreset($(this).val())&&l()}),c.find('#btn-preset-dup').on('click',function(){const t=wt.getActivePreset();if(!t)return;const n=wt.duplicatePreset(t.id);n&&(c.find('#preset-select').append(`<option value="${h(n.id)}">${h(n.name)}</option>`),c.find('#preset-select').val(n.id).trigger('change'))}),c.find('#btn-preset-new').on('click',function(){const t=prompt('请输入新预设名称:','我的预设');if(!t?.trim())return;const n=wt.createPreset(t.trim());n&&(c.find('#preset-select').append(`<option value="${h(n.id)}">${h(n.name)}</option>`),c.find('#preset-select').val(n.id).trigger('change'))}),c.find('#btn-preset-del').on('click',function(){const t=wt.getActivePreset();t&&('default'!==t.id?confirm(`确定删除预设"${t.name}"吗？`)&&wt.deletePreset(t.id)&&(c.find(`#preset-select option[value="${t.id}"]`).remove(),c.find('#preset-select').val('default').trigger('change')):window.toastr&&window.toastr.warning('默认预设不能删除'))}),c.find('#btn-preset-export').on('click',function(){const t=wt.getActivePreset();if(!t)return;const n=wt.exportPreset(t.id);if(n)try{const e=`acu_validation_preset_${t.name||t.id}_${Date.now()}.json`,a=new Blob([n],{type:'application/json'}),o=URL.createObjectURL(a),i=document.createElement('a');i.href=o,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}catch(t){navigator.clipboard.writeText(n).then(()=>{}).catch(()=>{prompt('复制以下内容:',n)})}}),c.find('#btn-preset-import').on('click',function(){const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=async t=>{const n=t.target.files?.[0];if(n)try{const t=await n.text();if(!t?.trim())return;let e;try{e=JSON.parse(t.trim())}catch{return void(window.toastr&&window.toastr.error('JSON格式无效'))}const a=e?.preset?.name||'导入的预设',o=wt.getAllPresets(),i=o.map(t=>t.name),r=i.includes(a),s=(n,i)=>{let s=t.trim();if(i&&e?.preset&&(e.preset.name=i,e.preset.id=`preset_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=JSON.stringify(e)),n&&r){const t=o.find(t=>t.name===a);t&&'default'!==t.id&&(wt.deletePreset(t.id),c.find(`#preset-select option[value="${t.id}"]`).remove())}const d=wt.importPreset(s,!1);if(d&&d.preset){const t=d.preset;c.find('#preset-select').append(`<option value="${h(t.id)}">${h(t.name)}</option>`),c.find('#preset-select').val(t.id).trigger('change'),d.needsMerge&&confirm('检测到预设版本较旧，是否要合并新版本的默认值？\n\n这将保留您的自定义规则，并添加新版本中的新规则。')&&(wt.mergePresetWithDefaults(t.id)?l():window.toastr&&window.toastr.error('合并失败'))}else window.toastr&&window.toastr.error('导入失败，请检查格式')};r?k({presetName:a,presetType:'数据验证',existingNames:i,onOverwrite:()=>s(!0),onRename:t=>s(!1,t),onCancel:()=>{}}):s(!1)}catch(t){console.error('[DICE]PresetManager 导入失败:',t),window.toastr&&window.toastr.error('导入失败: '+t.message)}},t.click()}),c.find('#btn-preset-reset').on('click',function(){confirm('确定要将默认预设恢复为初始状态吗？\n这将删除所有对默认预设的修改。')&&(wt.resetDefaultPreset()?'default'===wt.getActivePreset()?.id&&l():window.toastr&&window.toastr.error('恢复失败'))}),c.on('click','#regex-rules-list .acu-rule-toggle',function(){const t=$(this).closest('.acu-validation-rule-item').data('rule-id'),n=$t.getAllRules().find(n=>n.id===t)?.enabled,e=!n;$t.getRule(t);$t.toggleRuleEnabled(t,e),e||toastr.info('规则已禁用'),Ca()}),c.on('click','#regex-rules-list .acu-rule-edit',function(){const t=$(this).closest('.acu-validation-rule-item').data('rule-id');$t.getRule(t)&&Ua(t)}),c.on('click','#regex-rules-list .acu-rule-delete',function(){const t=$(this).closest('.acu-validation-rule-item').data('rule-id'),n=$t.getRule(t);n&&confirm(`确定要删除规则"${n.name}"吗？`)&&($t.removeRule(t),Ca())}),c.find('#regex-preset-select').on('change',function(){const t=$(this).val();kt.setActivePreset(String(t)),Ca()}),c.find('#btn-regex-preset-dup').on('click',function(){const t=kt.getActivePreset();if(!t)return;const n=prompt('请输入新预设名称:',`${t.name} (副本)`);if(!n)return;const e=kt.createPreset(n,t.id);if(e){const t=c.find('#regex-preset-select');t.append(`<option value="${h(e.id)}">${h(e.name)}</option>`),t.val(e.id),Ca()}else toastr.error('预设名称已存在')}),c.find('#btn-regex-preset-new').on('click',function(){const t=prompt('请输入预设名称:');if(!t)return;const n=kt.createPreset(t,null);if(n){kt.setActivePreset(n.id);const t=c.find('#regex-preset-select');t.append(`<option value="${h(n.id)}">${h(n.name)}</option>`),t.val(n.id),Ca()}else toastr.error('预设名称已存在')}),c.find('#btn-regex-preset-del').on('click',function(){const t=kt.getActivePreset();if(t&&confirm(`确定要删除预设"${t.name}"吗？`)){if(kt.deletePreset(t.id)){const n=c.find('#regex-preset-select');n.find(`option[value="${t.id}"]`).remove();const e=kt.getActivePreset()?.id;e&&n.val(e),Ca()}else toastr.error('不能删除最后一个预设')}}),c.find('#btn-regex-preset-export').on('click',function(){const t=kt.getActivePreset();if(!t)return;const n=kt.exportPreset(t.id);if(n){const e=new Blob([n],{type:'application/json'}),a=URL.createObjectURL(e),o=document.createElement('a');o.href=a,o.download=`regex-preset-${t.name}-${Date.now()}.json`,o.click(),URL.revokeObjectURL(a)}}),c.find('#btn-regex-preset-import').on('click',function(){const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=async t=>{const n=t.target.files?.[0];if(n)try{const t=await n.text();if(!t?.trim())return;let e;try{e=JSON.parse(t.trim())}catch{return void toastr.error('JSON格式无效')}const a=e?.name||'导入的预设',o=kt.getAllPresets(),i=o.map(t=>t.name),r=i.includes(a),s=(n,i)=>{let s=t.trim();if(i&&(e.name=i,e.id=`regex_preset_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=JSON.stringify(e)),n&&r){const t=o.find(t=>t.name===a);t&&o.length>1&&(kt.deletePreset(t.id),c.find(`#regex-preset-select option[value="${t.id}"]`).remove())}const l=kt.importPreset(s);if(l){const t=c.find('#regex-preset-select');t.append(`<option value="${h(l.id)}">${h(l.name)}</option>`),t.val(l.id),kt.setActivePreset(l.id),fe.set(it,l.rules||[]),$t.clearCache(),Ca()}else toastr.error('预设格式无效')};r?k({presetName:a,presetType:'正则转换',existingNames:i,onOverwrite:()=>s(!0),onRename:t=>s(!1,t),onCancel:()=>{}}):s(!1)}catch(t){toastr.error('导入失败: '+t.message)}},t.click()}),c.find('#btn-regex-preset-reset').on('click',function(){if(!confirm('确定要恢复默认预设吗？\n\n此操作将清除当前所有正则规则，并恢复为系统内置的默认规则。'))return;const t=kt.getAllPresets();let n=t.find(t=>'regex_default'===t.id);n?(n.rules=JSON.parse(JSON.stringify(lt.map(t=>({...t,builtin:!0})))),n.version=Q,n.updatedAt=Date.now()):(n={id:'regex_default',name:'默认预设',description:'系统默认的正则转换规则预设',version:Q,rules:JSON.parse(JSON.stringify(lt.map(t=>({...t,builtin:!0})))),createdAt:Date.now(),updatedAt:Date.now()},t.unshift(n)),kt._save(t),fe.set(ct,'regex_default'),fe.set(it,JSON.parse(JSON.stringify(lt.map(t=>({...t,builtin:!0}))))),$t.clearCache();const e=c.find('#regex-preset-select');e.empty(),kt.getAllPresets().forEach(t=>{const n='regex_default'===t.id?` v${Q}`:'';e.append(`<option value="${h(t.id)}">${h(t.name)}${n}</option>`)}),e.val('regex_default'),Ca(),toastr.success(`已恢复默认预设，包含 ${lt.length} 条内置规则`)}),c.find('#btn-add-regex-rule').on('click',function(){Ua()}),c.find('#btn-import-tavern-regex').on('click',function(){const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=async t=>{const n=t.target.files?.[0];if(n)try{const t=await n.text();if(!t?.trim())return;let e;try{e=JSON.parse(t.trim())}catch{return void toastr.error('JSON格式无效')}const a=Array.isArray(e)?e:[e];if(!a.every(t=>t.scriptName&&t.findRegex))return void toastr.error('不是有效的酒馆正则格式（需要 scriptName 和 findRegex 字段）');const o=$t.getAllRules().map(t=>t.name);let i=0,r=0;const c=t=>{if(t>=a.length)return Ca(),void(r>0?toastr.info(`导入完成: ${i} 条成功, ${r} 条跳过`):i>0&&toastr.success(`成功导入 ${i} 条酒馆正则规则`));const n=function(t){const{pattern:n,flags:e}=function(t){const n=t.match(/^\/(.+)\/([gimsuy]*)$/s);if(n){const[,t,e]=n;return{pattern:t,flags:{global:e.includes('g'),caseInsensitive:e.includes('i'),multiline:e.includes('m'),unicode:e.includes('u'),sticky:e.includes('y')}}}return{pattern:t,flags:{global:!0}}}(t.findRegex),a=[];t.placement?.length&&a.push(`placement: [${t.placement.join(',')}]`),t.markdownOnly&&a.push('markdownOnly'),t.promptOnly&&a.push('promptOnly'),null!=t.minDepth&&a.push(`minDepth: ${t.minDepth}`),null!=t.maxDepth&&a.push(`maxDepth: ${t.maxDepth}`);const o=a.length>0?`[从酒馆正则导入] ${a.join(', ')}`:'[从酒馆正则导入]';return{id:`tavern_import_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t.scriptName,description:o,operation:'replace',pattern:n,flags:e,replacement:t.replaceString||'',scope:{type:'global'},enabled:!t.disabled,priority:50,executeMode:t.runOnEdit?'auto':'manual',security:{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4},createdAt:Date.now(),updatedAt:Date.now()}}(a[t]);o.includes(n.name)?k({presetName:n.name,presetType:'酒馆正则规则',existingNames:o,onOverwrite:()=>{const e=$t.getAllRules().find(t=>t.name===n.name);e&&$t.removeRule(e.id),$t.addCustomRule(n),o.push(n.name),i++,c(t+1)},onRename:e=>{n.name=e,n.id=`tavern_import_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,$t.addCustomRule(n),o.push(e),i++,c(t+1)},onCancel:()=>{r++,c(t+1)}}):($t.addCustomRule(n),o.push(n.name),i++,c(t+1))};c(0)}catch(t){toastr.error('导入失败: '+t.message)}},t.click()}),c.find('#btn-add-validation-rule').on('click',function(){Ea(c)}),c.find('#btn-open-debug-console').on('click',function(t){t.preventDefault(),t.stopPropagation(),c.remove(),Rn=!1,La()}),c.find('#cfg-clear-local-cache').on('click',function(t){t.preventDefault(),t.stopPropagation(),aa({title:'清空本地缓存',iconClass:'fa-trash-can',description:'您确定要清空本地缓存数据吗？此操作主要用于解决缓存冲突或空间不足问题。',safeTitle:'高风险操作',safeDescription:'注意：此操作将永久删除本地保存的所有配置（包括主题色、布局、规则设置等）。',confirmText:'确认清空',loadingText:'正在清理...',isDanger:!0,safeIconClass:'fa-triangle-exclamation',onConfirm:async()=>{const t=await(async()=>{let t=0;for(let n=localStorage.length-1;n>=0;n--){const e=localStorage.key(n);e&&e.startsWith('acu_')&&(localStorage.removeItem(e),t++)}return await Promise.allSettled([Et.clearAll(),At.clear(),St.clear()]),await ea(),t})();window.toastr&&window.toastr.success(`本地缓存已清理（localStorage ${t} 项，含 IndexedDB/脚本缓存）。建议刷新页面以重新初始化设置。`)}})});const d=()=>{Rn=!1,c.remove(),mo()};c.on('click','#dlg-close-x, .acu-settings-header .acu-close-btn',d),c.on('click','#acu-help-btn',function(t){t.stopPropagation(),window.open('https://jerryzmtz.github.io/DiceSystemManual//','_blank')}),c.on('click','#acu-manual-update-btn',function(t){t.stopPropagation(),aa()}),y(c,'acu-edit-overlay',d)};let fo=null,go=!1;const mo=()=>{Rn?go||(console.info('[DICE]设置面板打开中，跳过界面渲染'),go=!0):(Mo(),fo&&clearTimeout(fo),fo=setTimeout(()=>{fo=null,go=!1,bo()},50))},bo=()=>{console.info('[DICE]开始渲染界面...');const{$}=le();if(!Un&&$('#chat').length){const t=$('#chat');let n=!1;Un=new MutationObserver(()=>{n||(n=!0,requestAnimationFrame(()=>{if('embedded'===ca().positionMode)return void(n=!1);const e=t.children().last()[0],a=$('.acu-wrapper')[0];a&&e&&e!==a&&($(e).hasClass('mes')||$(e).hasClass('message-body'))&&t.append(a);const o=qt();if(o&&o.hideDiceResultInChat){const n=t.children().last();(n.hasClass('mes')||n.hasClass('message-body'))&&n.addClass('acu-dice-result-revealing'),requestAnimationFrame(()=>{Wt(),requestAnimationFrame(()=>{n.removeClass('acu-dice-result-revealing').addClass('acu-dice-result-revealed'),setTimeout(()=>{n.removeClass('acu-dice-result-revealed')},200)})})}n=!1}))}),Un.observe(t[0],{childList:!0})}let t,n=!1;if(Wn&&Yn)t=Yn;else{if(t=pa(),n=!0,t&&!Xn&&n)try{const n=$t.getEnabledRules();if(n.length>0){console.info(`[DICE]检测到数据更新，应用 ${n.length} 条规则...`),Xn=!0;const e=_t.applyToTable(t,n);e.totalApplied>0&&(console.info(`[DICE]自动替换完成，共影响 ${e.totalApplied} 处数据`),$a(t,e.modifiedSheetKeys).catch(t=>{console.warn('[DICE]自动转换后保存数据失败:',t)})),e.errors.length>0?console.warn(`[DICE]自动转换遇到 ${e.errors.length} 个错误:`,e.errors):0===e.totalApplied&&console.info('[DICE]自动转换执行完成，但没有匹配到需要转换的数据'),Xn=!1}else Xn=!1}catch(t){Xn=!1;t instanceof Error?t.message:String(t);console.error('[DICE]自动转换失败:',t)}if(t){Yn='function'==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t));const n=ke(),e=oe(),a=n&&Object.keys(n).some(t=>t.startsWith('sheet_'));n&&a?n._contextId?n._contextId!==e&&(Yn._contextId=e,_e(Yn)):_e({...n,_contextId:e}):_e({...Yn,_contextId:e})}}const e=$('.acu-search-input');if($('.acu-wrapper').length&&e.is(':focus')&&t){Fn||(Ln=la(t));const n=_a(t),e=ge(),a=e&&n[e]?e:null;if(a&&n[a]){const t=Do(n[a],a),e=$('<div>').html(t);return $('.acu-card-grid').replaceWith(e.find('.acu-card-grid')),$('.acu-panel-title').html(e.find('.acu-panel-title').html()),No(n),void vo()}}let a=0,o=0;const i=$('.acu-panel-content');i.length&&(a=i.scrollLeft(),o=i.scrollTop()),$('.acu-wrapper').remove();const r=_a(t||{});Ln=Fn?new Set:la(t);const c=ve();let s=Object.keys(r);c&&(s=c.filter(t=>r[t]).concat(s.filter(t=>!c.includes(t))));const l=Se();s=s.filter(t=>!l.includes(t));const d=ge();let u=d&&r[d]&&!l.includes(d)?d:null;const p=ca(),f=we(),g='vertical'===p.layout?'acu-layout-vertical':'',m=`acu-mode-${p.positionMode||'fixed'}`;let b=p.gridColumns;if('auto'===b){const t=s.length;if(t<=4)b=t<2?2:t;else{const n=3*Math.ceil(t/3)-t;b=4*Math.ceil(t/4)-t<=n?4:3}}let v='',w=null;if(!1!==p.showOptionPanel){const t=[];if(Object.keys(r).forEach(n=>{n.includes('选项')&&t.push(r[n])}),t.length>0){const n=$e(),e=n?'fa-chevron-right':'fa-chevron-down',a=n?'collapsed':'';let o=0,i=!1,r=[];t.forEach(t=>{t.rows&&t.rows.forEach(t=>{t.forEach((t,n)=>{n>0&&t&&String(t).trim()&&o++})})});let c=`\n                    <div class="acu-opt-header" data-action="toggle-options">\n                        <span>\n                            <i class="fa-solid ${e}" style="margin-right:6px;font-size:10px;"></i>\n                            行动选项 (${o})\n                        </span>\n                    </div>`;t.forEach(t=>{t.rows&&t.rows.forEach(t=>{t.forEach((t,n)=>{if(n>0&&t&&String(t).trim()){const n=String(t).trim();c+=`<button class="acu-opt-btn" data-val="${x(n)}">${h(n)}</button>`,r.push(n),i=!0}})})}),i&&(v=`<div class="acu-option-panel acu-theme-${p.theme} ${a}">${c}</div>`,w=r.join('|||')+(n?'_collapsed':'_expanded')+`_theme_${p.theme}`+`_optSize_${p.optionFontSize||12}`)}}const y=w!==Zn;null!==w&&(Qn=!0),Zn=w;let k=`<div class="acu-wrapper ${m} acu-theme-${p.theme} ${g}" style="--acu-card-width:${p.cardWidth}px; --acu-font-size:${p.fontSize}px; --acu-opt-font-size:${p.optionFontSize||12}px; --acu-grid-cols:${b}">`;if('embedded'===p.positionMode&&v&&Qn&&(k+=v),f){const t=`acu-col-${p.collapseStyle||'bar'}`,n=`acu-align-${p.collapseAlign||'right'}`;k+=`\n                <div class="acu-expand-trigger ${t} ${n}" id="acu-btn-expand">\n                    <i class="fa-solid fa-table"></i> <span>数据库助手 (${Object.keys(r).length})</span>\n                </div>\n            `}else{const n=u?Ce()[u]:null,e=fe.get(F,!1),a=fe.get('acu_changes_panel_active',!1),o=ge()===Lt.MODULE_ID,i=(o?Ce()[Lt.MODULE_ID]:null)||n;k+=`\n                <div class="acu-data-display ${e||a||o||u?'visible':''} ${i?'acu-manual-mode':''}" id="acu-data-area" style="${i?'height:'+i+'px;':''}">\n                    ${a?wo(t):e?Ao(r):o?'<div class="acu-mvu-panel">'+Lt.renderPanel()+'</div>':u?Do(r[u],u):''}\n                </div>\n                `;const c=`grid-template-columns: repeat(${b}, 1fr);`;k+=`\n                <div class="acu-nav-container ${'top'===p.actionsPosition?'acu-pos-top':''}" id="acu-nav-bar" style="${c}">\n                    <div class="acu-order-controls" id="acu-order-hint"><i class="fa-solid fa-arrows-alt"></i> 拖动调整顺序，完成后点击保存退出</div>\n            `;const l=fe.get('acu_changes_panel_active',!1),d=fe.get('acu_favorites_panel_active',!1),f=fe.get(ut,!1);let g=0,m=0;if(t){const n=ke();if(n){for(const e in t){if(!e.startsWith('sheet_'))continue;const a=t[e],o=n[e];if(!a?.content)continue;const i=a.content.slice(1),r=o?.content?.slice(1)||[],c=new Map;r.forEach((t,n)=>{const e=String(t[1]??'').trim();c.has(e)||c.set(e,[]),c.get(e).push({index:n,row:t})}),i.forEach((t,n)=>{const e=String(t[1]??'').trim();let a;if(e&&c.has(e)){const t=c.get(e);if(t.length>0){const n=t.shift();a=n.row}}else e||(a=r[n]);if(a){let n=!1;t.forEach((t,e)=>{0!==e&&String(t??'')!==String(a[e]??'')&&(n=!0)}),n&&g++}else g++});const s=new Map,l=new Map;i.forEach(t=>{const n=String(t[1]??'').trim();n&&s.set(n,(s.get(n)||0)+1)}),r.forEach(t=>{const n=String(t[1]??'').trim();n&&l.set(n,(l.get(n)||0)+1)}),l.forEach((t,n)=>{const e=s.get(n)||0;t>e&&(g+=t-e)});const d=r.filter(t=>!String(t[1]??'').trim()).length,u=i.filter(t=>!String(t[1]??'').trim()).length;d>u&&(g+=d-u)}for(const e in n)e.startsWith('sheet_')&&!t[e]&&g++}m=Ct.getErrorCount(t)}const v=f?m:g,x=f&&m>0,w=Se(),y=ve()||[],C=[{key:'__dice__',icon:'fa-dice-d20',label:'掷骰',id:'acu-btn-dice-nav',extraClass:'acu-dice-nav-btn'},{key:'__changes__',icon:'fa-code-compare',label:'审核'+(v>0?'('+v+')':''),id:'acu-btn-changes',extraClass:'acu-changes-btn'+(x?' has-validation-errors':''),isActive:l,warningIcon:x},{key:'__mvu__',icon:'fa-code-branch',label:'变量',id:'acu-btn-mvu',extraClass:'acu-mvu-btn',isActive:ge()===Lt.MODULE_ID},{key:'__favorites__',icon:'fa-star',label:'收藏夹',id:'acu-btn-favorites',extraClass:'acu-favorites-btn',isActive:d}];let E=[];if(C.forEach(t=>{w.includes(t.key)||'__mvu__'!==t.key&&t.checkAvailable&&!t.checkAvailable()||E.push({...t,isSpecial:!0})}),s.forEach(t=>{E.push({key:t,icon:ue(t),label:t,isSpecial:!1,isActive:!e&&!l&&u===t})}),y.length>0){const t=new Map(y.map((t,n)=>[t,n]));E.sort((n,e)=>(t.has(n.key)?t.get(n.key):9999)-(t.has(e.key)?t.get(e.key):9999))}k+=`<button class="acu-nav-btn acu-dashboard-btn ${e?'active':''}" id="acu-btn-dashboard" style="order: 1;">\n                <i class="fa-solid fa-chart-line"></i><span>仪表盘</span>\n            </button>`,E.forEach((t,n)=>{const e=t.isActive?'active':'',a=t.extraClass||'',o=n+2;if(t.isSpecial){const n=t.warningIcon?'<i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>':'';k+=`<button class="acu-nav-btn ${a} ${e}" id="${t.id}" style="order: ${o};">\n                        <i class="fa-solid ${t.icon}"></i><span>${h(t.label)}</span>${n}\n                    </button>`}else k+=`<button class="acu-nav-btn ${e}" data-table="${h(t.key)}" style="order: ${o};">\n                        <i class="fa-solid ${t.icon}"></i><span>${h(t.label)}</span>\n                    </button>`}),k+='<div class="acu-actions-group" id="acu-active-actions" style="order: 9999;">',Tn.forEach(t=>{k+=`<button class="acu-action-btn" id="${t.id}" title="${t.title}"><i class="fa-solid ${t.icon}"></i></button>`}),k+='</div>',k+='</div>'}k+='</div>';const C=$('.acu-wrapper');if(C.length?C.replaceWith(k):xo(k),'embedded'!==p.positionMode&&v&&Qn)if(y)ho(v);else{const t=$('.acu-embedded-options-container');if(0===t.length)ho(v);else{const n=$('#chat .mes').filter(function(){const t=$(this);return'true'!==t.attr('is_user')&&'true'!==t.attr('is_system')&&!t.hasClass('sys_mes')&&('System'!==t.find('.name_text').text().trim()&&'true'!==t.attr('data-is-system')&&(0!==t.find('.mes_text').length&&'none'!==t.css('display')))}).last();if(n.length>0&&n.find('.acu-embedded-options-container').length>0){const n=t.is(':visible'),e=t.css('display'),a=t.html()?.length||0;n&&'none'!==e&&0!==a||ho(v)}else ho(v)}}else p.positionMode,$('.acu-embedded-options-container').remove();if(No(r),vo(),de(),fe.get('acu_changes_panel_active',!1)&&yo(),he()){const t=$('#acu-data-area');t.length&&(t.html('<div class="acu-mvu-panel">'+Lt.renderPanel()+'</div>'),Lt.bindEvents(t),Lt.getDataWithRetry(5,800).then(n=>{n&&he()&&(t.html('<div class="acu-mvu-panel">'+Lt.renderPanel()+'</div>'),Lt.bindEvents(t))}).catch(n=>{console.error('[DICE]MvuModule Error getting data:',n),he()&&(t.html('<div class="acu-mvu-panel">'+Lt.renderPanel()+'</div>'),Lt.bindEvents(t))}))}setTimeout(()=>{const t=$('.acu-panel-content'),n=ge(),e=ne[n];t.length&&(e?(t.scrollTop(e.top),t.scrollLeft(e.left)):(o>0&&t.scrollTop(o),a>0&&t.scrollLeft(a)),e&&e.inner&&Object.keys(e.inner).forEach(n=>{const a=e.inner[n],o=t.find(`.acu-editable-title[data-row="${n}"]`);if(o.length){const t=o.closest('.acu-data-card');t.scrollTop(a),t.find('.acu-card-body').scrollTop(a)}}))},0),console.info('[DICE]界面渲染完成')},ho=t=>{const{$}=le();$('.acu-embedded-options-container').remove();const n=(()=>{const t=$('#chat .mes').filter(function(){const t=$(this);return'true'!==t.attr('is_user')&&'true'!==t.attr('is_system')&&!t.hasClass('sys_mes')&&('System'!==t.find('.name_text').text().trim()&&'true'!==t.attr('data-is-system')&&(0!==t.find('.mes_text').length&&'none'!==t.css('display')))});if(0===t.length)return null;const n=t.last(),e=n.find('.mes_text'),a=n.find('.mes_block');return e.length?e:a.length?a:n})();if(n&&n.length){const e=ca(),a=$(`<div class="acu-embedded-options-container acu-theme-${e.theme}" style="--acu-opt-font-size:${e.optionFontSize||12}px;"></div>`);a.html(t),n.after(a)}},vo=()=>{const{$}=le();$('body').off('click.acu_opt').on('click.acu_opt','.acu-opt-btn',async function(t){t.preventDefault(),t.stopPropagation();const n=ca(),e=w($(this).data('val'));if(!n.clickOptionToAutoSend)return C(e,'action'),void $('#send_textarea').focus();if(window.TavernHelper)try{if(window.TavernHelper.createChatMessages)return await window.TavernHelper.createChatMessages([{role:'user',message:e}],{refresh:'affected'}),void(window.TavernHelper.triggerSlash&&await window.TavernHelper.triggerSlash('/trigger'))}catch(t){console.warn('[DICE]ACU TavernHelper 发送失败，尝试备用方案',t)}const a=window.SillyTavern||window.parent?.SillyTavern;if(a&&a.executeSlashCommandsWithOptions)try{const t=`/send raw=true "${e.replace(/\\/g,'\\\\').replace(/"/g,'\\"')}"`,n=await a.executeSlashCommandsWithOptions(t);if(!n.isError&&!n.isAborted)return void await a.executeSlashCommandsWithOptions('/trigger');console.warn('[DICE]ACU ST接口 send 失败:',n)}catch(t){console.warn('[DICE]ACU ST接口失败，尝试按钮模拟',t)}const o=$('#send_textarea');if(o.length){o.val(e),o.trigger('input').trigger('change'),await new Promise(t=>setTimeout(t,50));const t=$('#send_but').filter(':visible');if(t.length)t[0].click();else{const t=$.Event('keydown',{keyCode:13,which:13,bubbles:!0});o.trigger(t)}}})},xo=t=>{const{$}=le();if('embedded'===ca().positionMode){$('.acu-wrapper').remove();const n=(()=>{const t=$('#chat .mes').filter(function(){const t=$(this);if('true'===t.attr('is_user'))return!1;if('true'===t.attr('is_system'))return!1;if(t.hasClass('sys_mes'))return!1;if('System'===t.find('.name_text').text().trim())return!1;if('none'===t.css('display'))return!1;const n=t.find('.mes_text');if(0===n.length)return!1;const e=n.text().trim(),a=n.find('img').length>0;return!(0===e.length&&!a)});if(0===t.length)return $('#chat');let n=t.length-1;const e=t.eq(n),a=e.find('.mes_block');return a.length?a:e})();return void(n.length?n.hasClass('mes_block')||n.hasClass('mes')?0===n.find('.acu-wrapper').length?n.append(t):n.find('.acu-wrapper').replaceWith(t):0===$('#chat').find('.acu-wrapper').length&&n.append(t):$('body').append(t))}const n=$('#chat'),e=$('.acu-wrapper');e.length?e.replaceWith(t):n.length?n.append(t):$('body').append(t)},wo=t=>{const n=ke(),e=ca(),a=t?Ct.validateAllData(t):[];if(!(n&&t||0!==a.length))return'\n                <div class="acu-panel-header">\n                    <div class="acu-panel-title">\n                        <div class="acu-title-main"><i class="fa-solid fa-code-compare"></i> <span class="acu-title-text">更新审核</span></div>\n                        <div class="acu-title-sub">对比上次保存的快照</div>\n                    </div>\n                    <div class="acu-header-actions">\n                        <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                </div>\n                <div class="acu-panel-content" style="display:flex;align-items:center;justify-content:center;">\n                    <div class="acu-empty-hint">暂无快照数据</div>\n                </div>';const o=[];for(const e in t){if(!e.startsWith('sheet_'))continue;const a=t[e],i=n[e];if(!a?.name||!a?.content)continue;const r=a.name,c=a.content[0]||[],s=a.content.slice(1),l=i?.content?.slice(1)||[],d=new Map;l.forEach((t,n)=>{const e=String(t[1]??'').trim();d.has(e)||d.set(e,[]),d.get(e).push({index:n,row:t})}),s.forEach((t,n)=>{const a=String(t[1]??'').trim();let i,s;if(a&&d.has(a)){const t=d.get(a);if(t.length>0){const n=t.shift();i=n.row,s=n.index}}else a||(i=l[n],s=n);if(i){const a=[];if(t.forEach((t,n)=>{if(0===n)return;const e=String(i[n]??''),o=String(t??'');e!==o&&a.push({colIndex:n,header:c[n]||`列${n}`,oldValue:e,newValue:o})}),1===a.length){const i=a[0];o.push({type:'cell_modified',tableName:r,tableKey:e,rowIndex:n,colIndex:i.colIndex,header:i.header,oldValue:i.oldValue,newValue:i.newValue,rowTitle:t[1]||`行 ${n+1}`})}else a.length>1&&o.push({type:'row_modified',tableName:r,tableKey:e,rowIndex:n,headers:c,row:t,oldRow:i,changedFields:a,rowTitle:t[1]||`行 ${n+1}`})}else o.push({type:'row_added',tableName:r,tableKey:e,rowIndex:n,headers:c,row:t,title:t[1]||`行 ${n+1}`})});const u=new Map;s.forEach((t,n)=>{const e=String(t[1]??'').trim();e&&u.set(e,(u.get(e)||0)+1)});const p=new Map;l.forEach((t,n)=>{const e=String(t[1]??'').trim();e&&p.set(e,(p.get(e)||0)+1)});const f=new Set;l.forEach((t,n)=>{const a=String(t[1]??'').trim();if(a){if(!f.has(a)){f.add(a);const t=(p.get(a)||0)-(u.get(a)||0);if(t>0){l.map((t,n)=>({row:t,index:n})).filter(t=>String(t.row[1]??'').trim()===a).slice(-t).forEach(t=>{o.push({type:'row_deleted',tableName:r,tableKey:e,rowIndex:t.index,headers:c,row:t.row,title:a})})}}}else n>=s.length&&o.push({type:'row_deleted',tableName:r,tableKey:e,rowIndex:n,headers:c,row:t,title:`行 ${n+1}`})})}for(const e in n)if(e.startsWith('sheet_')&&!t[e]){const t=n[e];o.push({type:'table_deleted',tableName:t?.name||e,tableKey:e})}const i=fe.get(ut,!1);let r=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n                    <div class="acu-title-main"><i class="fa-solid ${i?'fa-shield-halved':'fa-code-compare'}"></i> <span class="acu-title-text">${i?'数据验证':'完整审核'}</span></div>\n                </div>\n                <div class="acu-header-actions">\n                    ${i?'':'<button class="acu-changes-batch-btn acu-batch-accept" title="接受全部变更"><i class="fa-solid fa-check-double"></i></button>'}\n                    <button class="acu-changes-batch-btn acu-batch-reject" title="${i?'全部回滚':'拒绝全部变更'}"><i class="fa-solid fa-rotate-left"></i></button>\n                    <button class="acu-changes-batch-btn acu-simple-mode-toggle ${i?'active':''}" title="${i?'切换到完整审核模式':'切换到数据验证模式'}">\n                        <i class="fa-solid ${i?'fa-filter-circle-xmark':'fa-filter'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="审核面板" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                    </div>\n                    <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>`;if(r+=`<div class="acu-panel-content acu-changes-content ${'horizontal'===e.layout?'acu-changes-horizontal':''}">`,i)if(0===a.length)r+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                数据验证通过，无违规项\n            </div>';else{const t=Ct.groupErrorsByTable(a),n=fe.get('acu_validation_collapsed_groups',[]);r+='<div class="acu-changes-list">';for(const e in t){const a=t[e],o=n.includes(e);r+=`<div class="acu-changes-group ${o?'collapsed':''}">\n                    <div class="acu-changes-group-header acu-validation-group-header" data-table="${h(e)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${o?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${ue(e)}"></i> ${h(e)}\n                        <span class="acu-changes-count" style="background:var(--acu-error-text);">${a.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${o?'display:none;':''}">`,a.forEach(t=>{const n=t.rule?h(JSON.stringify({ruleId:t.ruleId,ruleType:t.ruleType,tableName:t.tableName,rowIndex:t.rowIndex,columnName:t.columnName||'',currentValue:t.currentValue||'',rowTitle:t.rowTitle||'',rule:t.rule})):'';r+=`<div class="acu-change-item acu-validation-error-item"\n                         data-table="${h(t.tableName)}"\n                         data-row="${t.rowIndex}"\n                         data-column="${h(t.columnName||'')}"\n                         data-rule-id="${h(t.ruleId||'')}"\n                         data-rule-type="${h(t.ruleType||'')}"\n                         data-rule-data="${n}">\n                        <span class="acu-change-badge" style="background:var(--acu-hl-manual-bg);color:var(--acu-hl-manual);">!</span>\n                        ${t.rowTitle&&t.rowIndex>=0?`<div class="acu-validation-row-title" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:2px;">${h(t.rowTitle)}</div>`:''}\n                        <span class="acu-change-title">${h(t.columnName||'整行')}${t.currentValue?`: ${h(t.currentValue.length>15?t.currentValue.substring(0,15)+'...':t.currentValue)}`:''}</span>\n                        <span class="acu-validation-error-msg">${h(t.errorMessage.length>25?t.errorMessage.substring(0,25)+'...':t.errorMessage)}</span>\n                        <div class="acu-change-actions">\n                            <button class="acu-change-action-btn acu-action-reject" title="回滚"><i class="fa-solid fa-rotate-left"></i></button>\n                            <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                        </div>\n                    </div>`}),r+='</div></div>'}r+='</div>'}else if(0===o.length)r+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                当前数据与快照一致，无变更\n            </div>';else{const t={};o.forEach(n=>{const e=n.tableName;t[e]||(t[e]=[]),t[e].push(n)}),r+='<div class="acu-changes-list">';const n=fe.get('acu_changes_collapsed_groups',[]);for(const e in t){const a=t[e],o=n.includes(e);r+=`<div class="acu-changes-group ${o?'collapsed':''}">\n                    <div class="acu-changes-group-header" data-table="${h(e)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${o?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${ue(e)}"></i> ${h(e)}\n                        <span class="acu-changes-count">${a.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${o?'display:none;':''}">`,a.forEach(t=>{if('row_added'===t.type)r+=`<div class="acu-change-item acu-change-added"\n                            data-change-type="row_added"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}">\n                            <span class="acu-change-badge acu-badge-added">新</span>\n                            <span class="acu-change-title">${h(t.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="拒绝"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`;else if('row_deleted'===t.type)r+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="row_deleted"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}">\n                            <span class="acu-change-badge acu-badge-deleted">删</span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">${h(t.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受删除"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="恢复此行"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`;else if('cell_modified'===t.type){const n=t.oldValue.length>15?t.oldValue.substring(0,15)+'...':t.oldValue,e=t.newValue.length>15?t.newValue.substring(0,15)+'...':t.newValue;let a;a=t.tableName&&t.tableName.includes('选项')?`${h(t.tableName)}.${h(t.header)}`:`${h(t.rowTitle)}.${h(t.header)}`,r+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="cell_modified"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}"\n                            data-col-index="${t.colIndex}"\n  data-old-value="${x(t.oldValue)}">\n                            <span class="acu-change-badge acu-badge-modified">更</span>\n                            <span class="acu-change-field">${a}</span>\n                            <span class="acu-change-diff">\n                                <span class="acu-diff-old">${h(n||'(空)')}</span>\n                                <span class="acu-diff-arrow">→</span>\n                                <span class="acu-diff-new">${h(e||'(空)')}</span>\n                            </span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="拒绝"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else if('row_modified'===t.type){const n=t.changedFields.length,e=t.changedFields.slice(0,2).map(t=>t.header).join('、'),a=n>2?` 等${n}项`:'';r+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="row_modified"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}">\n                            <span class="acu-change-badge acu-badge-modified">更</span>\n                            <span class="acu-change-title">${h(t.rowTitle)}</span>\n                            <span class="acu-change-field-count">${h(e)}${a}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="拒绝"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else'table_deleted'===t.type&&(r+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="table_deleted"\n                            data-table-key="${t.tableKey}">\n                            <span class="acu-change-badge acu-badge-deleted">删</span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">整表已删除</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="恢复整表"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`)}),r+='</div></div>'}r+='</div>'}return r+='</div>',r},yo=()=>{const{$}=le();$('.acu-changes-content').closest('.acu-data-display').find('.acu-close-btn').off('click').on('click',function(){fe.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')});$('.acu-validation-error-item .acu-action-reject').off('click').on('click',async function(t){t.stopPropagation();const n=$(this).closest('.acu-validation-error-item'),e=n.data('table'),a=parseInt(n.data('row'),10),o=n.data('column'),i=ke();if(i)try{const t=Yn||pa();for(const n in t)if(t[n]?.name===e&&i[n]){const e=(t[n].content?.[0]||[]).indexOf(o);if(e>=0&&i[n].content?.[a+1]){const o=i[n].content[a+1][e];return t[n].content[a+1][e]=o,await xa(t,!1,!1),void mo()}break}window.toastr&&window.toastr.warning('无法找到对应的快照数据')}catch(t){console.error('[DICE]ACU 恢复快照值失败:',t),window.toastr&&window.toastr.error('恢复失败')}else window.toastr&&window.toastr.warning('无快照数据可恢复')}),$('.acu-validation-error-item .acu-action-edit').off('click').on('click',function(t){t.stopPropagation();const n=$(this).closest('.acu-validation-error-item'),e=n.data('rule-data');if(e)try{const t='string'==typeof e?JSON.parse(e):e,a={ruleId:t.ruleId,ruleType:t.ruleType,rule:t.rule,tableName:n.data('table')||t.tableName||'',rowIndex:parseInt(n.data('row'),10)||t.rowIndex||0,columnName:n.data('column')||t.columnName||'',currentValue:t.currentValue||'',rowTitle:t.rowTitle||'',ruleName:t.ruleName||t.rule?.name||'',errorMessage:t.errorMessage||t.rule?.errorMessage||''};Aa(a)}catch(t){console.error('[DICE]ACU 解析规则数据失败:',t),window.toastr&&window.toastr.error('解析规则数据失败')}else window.toastr&&window.toastr.warning('无法获取规则信息')});let t=null;$('.acu-validation-error-item').off('click touchstart touchend touchmove').on('touchstart',function(n){const e=n.originalEvent.touches[0];t={x:e.clientX,y:e.clientY}}).on('touchmove',function(n){if(!t)return;const e=n.originalEvent.touches[0],a=Math.abs(e.clientX-t.x),o=Math.abs(e.clientY-t.y);(a>10||o>10)&&(t=null)}).on('touchend',function(n){if(!t)return;if(t=null,$(n.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if(fe.get(ut,!1))return;const e=$(this).data('table'),a=$(this).data('row');fe.set('acu_changes_panel_active',!1),me(e),mo(),setTimeout(()=>{const t=$(`.acu-data-card[data-row-index="${a}"]`);t.length&&(t[0].scrollIntoView({behavior:'smooth',block:'center'}),t.addClass('acu-highlight-flash'),setTimeout(()=>t.removeClass('acu-highlight-flash'),2e3))},300)}).on('click',function(t){if($(t.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if('ontouchstart'in window)return;if(fe.get(ut,!1))return;const n=$(this).data('table'),e=$(this).data('row');fe.set('acu_changes_panel_active',!1),me(n),mo(),setTimeout(()=>{const t=$(`.acu-data-card[data-row-index="${e}"]`);t.length&&(t[0].scrollIntoView({behavior:'smooth',block:'center'}),t.addClass('acu-highlight-flash'),setTimeout(()=>t.removeClass('acu-highlight-flash'),2e3))},300)}),$('.acu-changes-group-header').off('click').on('click',function(t){if($(t.target).closest('.acu-change-item').length)return;const n=$(this).data('table'),e=$(this).closest('.acu-changes-group'),a=e.find('.acu-changes-group-body'),o=$(this).find('.acu-collapse-icon'),i=$(this).hasClass('acu-validation-group-header')?'acu_validation_collapsed_groups':'acu_changes_collapsed_groups';let r=fe.get(i,[]);e.hasClass('collapsed')?(e.removeClass('collapsed'),a.slideDown(200),o.removeClass('fa-chevron-right').addClass('fa-chevron-down'),r=r.filter(t=>t!==n)):(e.addClass('collapsed'),a.slideUp(200),o.removeClass('fa-chevron-down').addClass('fa-chevron-right'),r.includes(n)||r.push(n)),fe.set(i,r)}),$('.acu-change-item .acu-action-accept').off('click').on('click',async function(t){t.stopPropagation();const n=$(this).closest('.acu-change-item'),e=n.data('change-type'),a=n.data('table-key'),o=n.data('row-index'),i=n.data('col-index'),r=ke(),c=Yn||pa();r&&c&&('cell_modified'===e?r[a]?.content?.[o+1]&&c[a]?.content?.[o+1]&&(r[a].content[o+1][i]=c[a].content[o+1][i]):'row_modified'===e?r[a]?.content&&c[a]?.content?.[o+1]&&(r[a].content[o+1]=[...c[a].content[o+1]]):'row_added'===e?c[a]?.content?.[o+1]&&(r[a]?r[a].content[o+1]=[...c[a].content[o+1]]:r[a]=JSON.parse(JSON.stringify(c[a]))):'row_deleted'===e?r[a]?.content?.[o+1]&&r[a].content.splice(o+1,1):'table_deleted'===e&&delete r[a],_e(r),n.fadeOut(200,function(){$(this).remove(),$o()}))}),$('.acu-change-item .acu-action-reject').off('click').on('click',async function(t){t.stopPropagation();const n=$(this).closest('.acu-change-item'),e=n.data('change-type'),a=n.data('table-key'),o=n.data('row-index'),i=n.data('col-index'),r=w(n.data('old-value')||''),c=ke();let s=Yn||pa();c&&s&&('cell_modified'===e?s[a]?.content?.[o+1]&&(s[a].content[o+1][i]=r):'row_modified'===e?c[a]?.content?.[o+1]&&s[a]?.content&&(s[a].content[o+1]=[...c[a].content[o+1]]):'row_added'===e&&s[a]?.content?.[o+1]&&s[a].content.splice(o+1,1),await $a(s,[a]),n.fadeOut(200,function(){$(this).remove(),$o()}))}),$('.acu-action-restore').off('click').on('click',async function(t){t.stopPropagation();const n=$(this).closest('.acu-change-item'),e=n.data('change-type'),a=n.data('table-key'),o=n.data('row-index'),i=ke();let r=Yn||pa();if(i&&r){if('row_deleted'===e){if(i[a]?.content?.[o+1]){const t=[...i[a].content[o+1]];r[a]||(r[a]=JSON.parse(JSON.stringify(i[a])),r[a].content=[i[a].content[0]]),r[a].content.splice(o+1,0,t)}}else'table_deleted'===e&&i[a]&&(r[a]=JSON.parse(JSON.stringify(i[a])));await $a(r,[a]),n.fadeOut(200,function(){$(this).remove(),$o()})}}),$('.acu-change-item:not(.acu-validation-error-item) .acu-action-edit').off('click').on('click',function(t){t.stopPropagation();const n=$(this).closest('.acu-change-item'),e=n.data('table-key'),a=n.data('row-index'),o=n.data('change-type');if(!e||void 0===a)return;const i=Yn||pa();if(!i||!i[e])return;const r=i[e],c=r.content?r.content[0]:[],s=r.content?r.content[a+1]:null;if(s)if('row_modified'===o)Eo(s,c,r.name||'编辑',a,e);else if('cell_modified'===o){const t=n.data('col-index'),o=c[t]||`列${t}`,i=s[t]||'';Co(i,o,r.name,a,t,e)}else _o(s,c,r.name||'编辑',a,e);else window.toastr&&window.toastr.warning('该行可能已被删除')}),$('.acu-batch-accept').off('click').on('click',async function(){const t=Yn||pa();t&&(_e(JSON.parse(JSON.stringify(t))),Ln=new Set,$o())}),$('.acu-batch-reject').off('click').on('click',async function(){const t=ke();if(!t)return void(window.toastr&&window.toastr.warning('无快照数据'));const n=JSON.parse(JSON.stringify(t));Yn=n,await xa(n,!1,!1)}),$('.acu-simple-mode-toggle').off('click').on('click',function(){const t=!fe.get(ut,!1);fe.set(ut,t);const n=Yn||pa();$('#acu-data-area').html(wo(n)),yo(),ko(n)}),$('.acu-changes-content').closest('.acu-data-display').find('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const n=this;n.setPointerCapture(t.pointerId),$(n).addClass('active');const e=$('#acu-data-area'),a=e.height(),o=t.clientY,i=$(n).data('table');n.onpointermove=function(t){const n=t.clientY-o;let i=a-n;i<O&&(i=O),i>V&&(i=V),e.css('height',i+'px')},n.onpointerup=function(t){$(n).removeClass('active'),n.releasePointerCapture(t.pointerId),n.onpointermove=null,n.onpointerup=null;const a=e.height(),o=Ce();o[i]=a,Ee(o)}}).off('dblclick').on('dblclick',function(t){t.preventDefault(),t.stopPropagation();const n=$(this).data('table');$('#acu-data-area').css('height','');const e=Ce();delete e[n],Ee(e)});const n=$('.acu-changes-content.acu-changes-horizontal');n.length&&(n[0].addEventListener('touchstart',function(t){this._touchStartX=t.touches[0].clientX,this._touchStartY=t.touches[0].clientY,this._scrollDirection=null},{passive:!0}),n[0].addEventListener('touchmove',function(t){if(!this._touchStartX)return;const n=Math.abs(t.touches[0].clientX-this._touchStartX),e=Math.abs(t.touches[0].clientY-this._touchStartY);!this._scrollDirection&&(n>5||e>5)&&(this._scrollDirection=n>e?'horizontal':'vertical'),'horizontal'===this._scrollDirection&&n>10&&t.stopPropagation()},{passive:!1}),n[0].addEventListener('touchend',function(){this._touchStartX=null,this._touchStartY=null,this._scrollDirection=null},{passive:!0}))},$o=()=>{const{$}=le(),t=Yn||pa();Ln=la(t);const n=$('#acu-data-area');n.length&&fe.get('acu_changes_panel_active',!1)&&(n.html(wo(t)),yo(),ko(t))},ko=t=>{const{$}=le(),n=ke();let e=0;if(n&&t){for(const a in t){if(!a.startsWith('sheet_'))continue;const o=t[a],i=n[a];if(!o?.content)continue;const r=o.content.slice(1),c=i?.content?.slice(1)||[],s=new Map;c.forEach((t,n)=>{const e=String(t[1]??'').trim();s.has(e)||s.set(e,[]),s.get(e).push({index:n,row:t})}),r.forEach((t,n)=>{const a=String(t[1]??'').trim();let o;if(a&&s.has(a)){const t=s.get(a);if(t.length>0){const n=t.shift();o=n.row}}else a||(o=c[n]);if(o){let n=!1;t.forEach((t,e)=>{0!==e&&String(t??'')!==String(o[e]??'')&&(n=!0)}),n&&e++}else e++});const l=new Map,d=new Map;r.forEach(t=>{const n=String(t[1]??'').trim();n&&l.set(n,(l.get(n)||0)+1)}),c.forEach(t=>{const n=String(t[1]??'').trim();n&&d.set(n,(d.get(n)||0)+1)}),d.forEach((t,n)=>{const a=l.get(n)||0;t>a&&(e+=t-a)});const u=c.filter(t=>!String(t[1]??'').trim()).length,p=r.filter(t=>!String(t[1]??'').trim()).length;u>p&&(e+=u-p)}for(const a in n)a.startsWith('sheet_')&&!t[a]&&e++}const a=t?Ct.getErrorCount(t):0,o=fe.get(ut,!1),i=o?a:e,r=o&&a>0,c=$('#acu-btn-changes'),s=c.find('span');s.html(i>0?`审核(${i})`:'审核'),r?(c.find('.acu-nav-warning-icon').length||s.append(' <i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>'),c.addClass('has-validation-errors')):(c.find('.acu-nav-warning-icon').remove(),c.removeClass('has-validation-errors'))},_o=(t,n,e,a,o)=>{const{$}=le(),i=ca(),r=t.map((t,e)=>{if(0===e)return'';const a=n[e]||`列 ${e}`,o=t||'';return`\n                <div class="acu-card-edit-field">\n                    <label class="acu-card-edit-label">${h(a)}</label>\n                    <textarea class="acu-card-edit-input acu-card-edit-textarea" data-col="${e}" spellcheck="false" rows="1">${h(o)}</textarea>\n                </div>`}).join(''),c=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${i.theme}">\n                    <div class="acu-edit-title">编辑变更 (#${a+1} - ${h(e)})</div>\n                    <div class="acu-settings-content acu-settings-content-scroll">\n                        ${r}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-change-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-change-save"><i class="fa-solid fa-check"></i> 保存并确认</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(c);const s=t=>{t.style.height='auto';const n=t.scrollHeight+2;t.style.height=Math.min(n,500)+'px',t.style.overflowY=n>500?'auto':'hidden'};requestAnimationFrame(()=>{c.find('textarea').each(function(){s(this)})}),c.find('textarea').on('input',function(){s(this)}),c.find('textarea').on('input',function(){s(this)});const l=()=>{Rn=!1,c.remove()};c.find('#dlg-change-cancel').click(l),y(c,'acu-edit-overlay',l),c.find('#dlg-change-save').click(async()=>{let t=Yn||pa();if(t&&t[o]){const n=t[o]?.content?.[a+1];if(!n)return void l();let e=!1;if(c.find('textarea').each(function(){const t=parseInt($(this).data('col')),a=$(this).val();String(n[t])!==String(a)&&(e=!0,n[t]=a)}),e){try{await $a(t,[o])}catch(t){console.error('[DICE]ACU 保存失败:',t);let n=t.message||'保存出错，请检查数据格式和大小';const e=String(t);return(e.includes('Settings could not be saved')||e.includes('server connection')||e.includes('data loss'))&&(n='保存失败：服务器连接问题或数据过大，请检查网络连接或减少数据量'),void(window.toastr?window.toastr.error(n,'保存失败',{timeOut:7e3}):alert(`保存失败: ${n}`))}const e=ke();e&&e[o]&&e[o].content&&(e[o].content[a+1]=[...n],_e(e)),Ln=la(t);$('#acu-data-area').html(wo(t)),yo()}}l()})},Co=(t,n,e,a,o,i)=>{const{$}=le(),r=ca(),c=ke(),s=c?.[i]?.content?.[a+1]?.[o]??'',l=''!==s&&String(s)!==String(t),d=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${r.theme}" style="max-width:450px;">\n                    <div class="acu-edit-title">编辑: ${h(e)} - ${h(n)}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${l?`\n                        <div class="acu-diff-section acu-diff-old-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-clock-rotate-left"></i> 原始值（快照）\n                            </div>\n                            <div class="acu-diff-readonly">${h(s)}</div>\n                        </div>\n                        <div class="acu-diff-arrow-down">\n                            <i class="fa-solid fa-arrow-down"></i>\n                        </div>\n                        `:''}\n                        <div class="acu-diff-section acu-diff-new-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-pen"></i> ${l?'当前值（可编辑）':'内容'}\n                            </div>\n                            <textarea class="acu-change-single-input acu-edit-textarea" spellcheck="false"\n                                style="width:100%;min-height:60px;max-height:300px;padding:12px;resize:none;">${h(t)}</textarea>\n                        </div>\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-single-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        ${l?'<button class="acu-dialog-btn acu-btn-revert" id="dlg-single-revert"><i class="fa-solid fa-rotate-left"></i> 恢复原值</button>':''}\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-single-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(d);const u=d.find('.acu-change-single-input'),p=()=>{u[0].style.height='auto';const t=Math.max(60,Math.min(u[0].scrollHeight+2,300));u[0].style.height=t+'px'};setTimeout(p,0),u.on('input',p),u.focus();const f=()=>d.remove();d.find('#dlg-single-cancel').click(f),y(d,'acu-edit-overlay',f),d.find('#dlg-single-revert').click(function(){u.val(s).trigger('input')}),d.find('#dlg-single-save').click(async()=>{const t=u.val();let n=Yn||pa();if(n&&n[i]&&n[i].content){const e=n[i].content[a+1];if(e&&String(e[o])!==String(t)){e[o]=t,await $a(n,[i]);const r=ke();r&&r[i]&&r[i].content&&r[i].content[a+1]&&(r[i].content[a+1][o]=t,_e(r)),Ln=la(n),$o()}}f()})},Eo=(t,n,e,a,o)=>{const{$}=le(),i=ca(),r=ke(),c=r?.[o]?.content?.[a+1]||[];let s='';for(let e=1;e<n.length;e++){const a=n[e]||`列 ${e}`,o=c[e]??'',i=t[e]??'',r=String(o)!==String(i);s+=`\n                <div class="acu-row-edit-field ${r?'acu-field-changed':''}">\n                    <div class="acu-row-edit-label">${h(a)} ${r?'<span class="acu-changed-badge">已改</span>':''}</div>\n                    ${r?`<div class="acu-row-edit-old">${h(o)||'<span class="acu-empty-val">(空)</span>'}</div>`:''}\n                    <textarea class="acu-row-edit-input acu-edit-textarea" data-col="${e}" spellcheck="false" rows="1">${h(i)}</textarea>\n                </div>\n            `}const l=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${i.theme}" style="max-width:550px;">\n                    <div class="acu-edit-title">整体编辑: ${h(e)} - ${h(t[1]||'行 '+(a+1))}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px; max-height:60vh;">\n                        ${s}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-row-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn" id="dlg-row-revert"><i class="fa-solid fa-rotate-left"></i> 全部恢复</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-row-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(l);const d=t=>{t.style.height='auto',t.style.height=Math.min(t.scrollHeight+2,200)+'px'};l.find('textarea').each(function(){d(this)}),l.find('textarea').on('input',function(){d(this)});const u=()=>l.remove();l.find('#dlg-row-cancel').click(u),y(l,'acu-edit-overlay',u),l.find('#dlg-row-revert').click(function(){l.find('textarea').each(function(){const t=parseInt($(this).data('col'));$(this).val(c[t]??'').trigger('input')})}),l.find('#dlg-row-save').click(async()=>{let t=Yn||pa();if(!t?.[o]?.content?.[a+1])return void u();const n=t[o].content[a+1];let e=!1;if(l.find('textarea').each(function(){const t=parseInt($(this).data('col')),a=$(this).val();String(n[t])!==String(a)&&(e=!0,n[t]=a)}),e){await $a(t,[o]);const e=ke();e?.[o]?.content&&(e[o].content[a+1]=[...n],_e(e)),Ln=la(t),$o()}u()})},Ao=t=>{console.info('[DICE]开始抓取仪表盘数据...'),Bt.rebuild(t);const n=ca(),e=yn.findTable(t,'global'),a=yn.findTable(t,'player'),o=yn.findTable(t,'location'),i=yn.findTable(t,'npc'),r=yn.findTable(t,'quest'),c=yn.findTable(t,'bag'),s=yn.findTable(t,'equip');let l={name:'主角',status:'正常',position:'',attrs:'',money:'0'};const d=yn.parseRows(a,'player');if(d.length>0){const t=d[0];if(l.name=t.name||'主角',l.status=t.status||'正常',l.position=t.position||'',l.money=t.money||'',l.resources='',a?.data?.headers&&a?.data?.rows?.[0]){const t=a.data.headers,n=a.data.rows[0];let e='';t.forEach((t,a)=>{if(t&&t.includes('属性')){const t=n[a];t&&(e+=(e?'; ':'')+t)}}),l.attrs=e,t.forEach((t,e)=>{if(t&&(t.includes('资源')||t.includes('金钱'))){const t=n[e];t&&(l.resources=t)}})}}const u=a?.data?.rows||[],p=a?.data?.headers||[];let f='',g='';if(e?.data?.rows?.length>0){const t=e.data.headers||[],n=e.data.rows[0],a=yn.findColumnIndex(t,'detailLocation',e.config);a>=0&&n[a]&&(f=n[a]);const o=yn.findColumnIndex(t,'currentLocation',e.config);g=o>=0&&n[o]?n[o]:n[2]||''}let m=f||g||(l.position.includes('-')?l.position.split('-')[0].trim():l.position);const b=i?.name||'重要人物表',v=i?.key||'',x=yn.parseRows(i,'npc');let w=[],y=[];x.forEach(t=>{const n=String(t.inScene||'').toLowerCase(),e={name:t.name||'未知',status:t.status||'',position:t.position||'',index:t._rowIndex};'true'===n||'在场'===n?w.push(e):y.push(e)});let k=[...w,...y];const C=r?.name||'备忘事项',E=yn.parseRows(r,'quest'),A=t=>{const n=String(t||'').toLowerCase();return n.includes('进行中')||n.includes('进行')?0:1},S=t=>{const n=String(t||'').toLowerCase();return n.includes('主线')?0:n.includes('支线')?1:n.includes('日常')?2:3},I=t=>{const n=String(t||'').toLowerCase();return n.includes('紧急')?0:n.includes('重要')?1:n.includes('普通')?2:3},D=t=>{const n=String(t||'').match(/(\d+)\s*%/);return n?parseInt(n[1],10):0};let M=E.map(t=>({name:t.name||'任务',type:t.type||'',status:t.status||'',priority:t.priority||'',progress:t.progress||'',_rowIndex:t._rowIndex})).sort((t,n)=>{const e=A(t.status),a=e-A(n.status);if(0!==a)return a;if(1===e)return(n._rowIndex??0)-(t._rowIndex??0);const o=S(t.type)-S(n.type);if(0!==o)return o;const i=I(t.priority)-I(n.priority);return 0!==i?i:D(t.progress)-D(n.progress)});const T=c?.name||'背包物品表',N=yn.parseRows(c,'bag');let F=N.map(t=>({name:t.name||'未知物品',count:t.count||'1',type:t.type||''}));const P=s?.name||'装备表',j=yn.parseRows(s,'equip');let R=yn.applyFilter(j,'equipped','equip').map(t=>({name:t.name||'未知装备',type:t.type||'',part:t.part||''}));const B=o?.name||'世界地图点',O=o?.key||'',V=yn.parseRows(o,'location');let L=`\n        <div class="acu-panel-header">\n            <div class="acu-panel-title">\n                <div class="acu-title-main"><i class="fa-solid fa-chart-line"></i> <span class="acu-title-text">仪表盘</span></div>\n                <div class="acu-title-sub">综合状态总览</div>\n            </div>\n            <div class="acu-header-actions">\n                <div class="acu-height-control">\n                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="仪表盘" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                </div>\n                <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n            </div>\n        </div>\n        <div class="acu-panel-content acu-dashboard-content">\n            <div class="acu-dash-body ${'horizontal'===n.layout?'acu-dash-horizontal':''}">\n            \x3c!-- 左列：主角状态 + 基础属性 + 特有属性 --\x3e\n                <div class="acu-dash-player">\n                    <h3 class="acu-dash-clickable acu-dash-preview-trigger"\n                        data-table-key="${a?.key||''}"\n                        data-row-index="0"\n                        data-preview-type="player"\n                        style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-user-circle"></i> ${h(Tt(jt(l.name)))}</span>\n                        <span style="font-size:11px;font-weight:normal;color:var(--acu-text-main);background:var(--acu-badge-bg);padding:2px 8px;border-radius:10px;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${h(l.status)}">${h(l.status.length>6?l.status.substring(0,6)+'..':l.status)}</span>\n                    </h3>\n                    ${(()=>{const t=l.resources||l.money||'',n=In(t);let e=[],o=[];if(u.length>0&&p.length>0){const t=u[0];p.forEach((n,a)=>{if(n&&n.includes('基础属性')){In(t[a]||'').forEach(t=>{e.some(n=>n.name===t.name)||e.push(t)})}else if(n&&n.includes('特有属性')){In(t[a]||'').forEach(t=>{o.some(n=>n.name===t.name)||o.push(t)})}})}let i='';n.length>0&&(i+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:44px;overflow-y:auto;margin-bottom:4px;padding-bottom:4px;border-bottom:1px dashed var(--acu-border);">\n                                ${n.map(t=>`\n                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;">\n                                        <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${h(t.name)}">${h(t.name.substring(0,3))}</span>\n                                        <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                            <span style="color:var(--acu-accent);font-size:11px;font-weight:bold;">${t.value}</span>\n                                            <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${t.value}" data-name="${h(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="以${t.name}(${t.value})进行检定"></i>\n                                        </div>\n                                    </div>\n                                `).join('')}\n                            </div>`),i+=`<h4 class="acu-dash-clickable acu-dash-preview-trigger"\n                          data-table-key="${a?.key||''}"\n                          data-row-index="0"\n                          data-preview-type="player"\n                          style="font-size:12px;color:var(--acu-accent);margin:4px 0 2px 0;display:flex;align-items:center;gap:4px;cursor:pointer;"><i class="fa-solid fa-chart-bar" style="font-size:10px;"></i> 属性 (${e.length+o.length})</h4>`;const r=[...e,...o];return r.length>0?i+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px 4px;max-height:104px;overflow-y:auto;overflow-x:hidden;padding-bottom:2px;">\n                                ${r.map(t=>`\n                                    <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;border-bottom:1px dashed var(--acu-border);min-width:0;">\n                                        <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${h(t.name)}">${h(t.name.substring(0,2))}</span>\n                                        <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                            <span style="color:var(--acu-text-main);font-size:11px;font-weight:bold;">${t.value}</span>\n                                            <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${t.value}" data-name="${h(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="以${t.name}(${t.value})进行检定"></i>\n                                        </div>\n                                    </div>\n                                `).join('')}\n                            </div>`:i+='<div class="acu-empty-hint">暂无属性</div>',i})()}\n                </div>\n\n                \x3c!-- 中列：地点 + NPC --\x3e\n                <div class="acu-dash-locations">\n                    <h3 class="acu-dash-table-link" data-table="${h(B)}" style="display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-map"></i> 地点 (${V.length})</span>\n                        <i class="fa-solid fa-map acu-dash-map-btn" title="地图可视化" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                    </h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;align-content:start;max-height:110px;overflow-y:auto;overflow-x:hidden;margin-bottom:10px;">\n                    ${V.length>0?V.map((t,n)=>{const e=t.name||'未知',a=m&&(e.includes(m)||m.includes(e)),o=Vt(e,null);let i='';return i=o?o.startsWith('fa:')?`<i class="fa-solid fa-${o.slice(3)}" style="font-size:10px;opacity:0.7;"></i>`:o.startsWith('ti:')?`<i class="ti ti-${o.slice(3)}" style="font-size:10px;opacity:0.7;"></i>`:`<span style="font-size:10px;">${o}</span>`:a?'<i class="fa-solid fa-location-dot"></i>':'<i class="fa-solid fa-map-pin" style="font-size:9px;opacity:0.4;"></i>',`<div class="acu-location-item acu-dash-clickable acu-dash-preview-trigger ${a?'acu-current-location':''}"\n                            data-table-key="${h(O)}"\n                            data-row-index="${t._rowIndex}"\n                            data-preview-type="location">\n                            <span style="display:flex;align-items:center;gap:4px;">\n                                ${i}\n                                <span title="${h(e)}">${h(e)}</span>\n                            </span>\n                            ${a?'<i class="fa-solid fa-street-view" style="flex-shrink:0;" title="您在这里"></i>':`<i class="fa-solid fa-walking acu-dash-goto-btn" data-location="${h(e)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;flex-shrink:0;" title="前往${e}"></i>`}\n                        </div>`}).join(''):'<div class="acu-empty-hint">暂无地点数据</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${h(b)}" style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-users"></i> 角色 (${k.length})</span>\n                        <span style="display:flex;gap:8px;">\n                            <i class="fa-solid fa-project-diagram acu-dash-relation-graph-btn" title="人物关系图" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                            <i class="fa-solid fa-user-circle acu-dash-avatar-manager-btn" title="头像管理" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                        </span>\n                    </h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;align-content:start;max-height:150px;overflow-y:auto;overflow-x:hidden;">\n                    ${k.length>0?k.map((t,n)=>{const e=w.some(n=>n.name===t.name),a=n===k.length-1,o=Ft.get(t.name),i=Ft.getOffsetX(t.name),r=Ft.getOffsetY(t.name),c=Ft.getScale(t.name),s=o?`background-image:url('${o}');background-size:${c}%;background-position:${i}% ${r}%;`:'',l=e?'':'filter:grayscale(80%) brightness(0.7);opacity:0.5;';return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${h(v)}"\n                            data-row-index="${t.index}"\n                            data-preview-type="npc"\n                            style="padding:6px 4px;${a?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <span class="acu-task-name" style="font-size:12px;display:flex;align-items:center;gap:6px;">\n                                    <span class="acu-dash-npc-avatar" style="width:22px;height:22px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:var(--acu-btn-bg);border:1.5px solid ${e?'var(--acu-accent)':'var(--acu-border)'};${s}${l}" title="${e?'在场':'不在场'}">\n                                        ${o?'':`<span style="font-size:10px;font-weight:bold;color:var(--acu-text-sub);${l}">${h(jt(t.name).charAt(0))}</span>`}\n                                    </span>\n                                    <span title="${h(jt(t.name))}" style="${e?'':'opacity:0.6;'}">${h((()=>{const n=jt(t.name);return n.length>4?n.substring(0,4)+'..':n})())}</span>\n                                </span>\n                                <div style="display:flex;align-items:center;">\n                                    <i class="fa-solid fa-people-arrows acu-dash-contest-btn" data-npc="${h(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:8px;" title="与${jt(t.name)}进行对抗检定"></i>\n                                </div>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">暂无重要人物</div>'}\n                    </div>\n                </div>\n\n                \x3c!-- 右列：背包 + 技能 + 任务 --\x3e\n                <div class="acu-dash-intel">\n                    <h3 class="acu-dash-table-link" data-table="${h(T)}"><i class="fa-solid fa-bag-shopping"></i> 物品 (${N.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:90px;overflow-y:auto;margin-bottom:10px;">\n                    ${F.length>0?F.map((t,n)=>{const e=n===F.length-1,a=Vt(t.name,null);let o='';return o=a?a.startsWith('fa:')?`<i class="fa-solid fa-${a.slice(3)}" style="font-size:10px;opacity:0.7;"></i>`:a.startsWith('ti:')?`<i class="ti ti-${a.slice(3)}" style="font-size:10px;opacity:0.7;"></i>`:`<span style="font-size:10px;">${a}</span>`:'<i class="fa-solid fa-cube" style="font-size:9px;opacity:0.4;"></i>',`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${c?.key||''}"\n                            data-row-index="${n}"\n                            data-preview-type="bag"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:5px 4px;font-size:11px;cursor:pointer;${e?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <span style="color:var(--acu-text-main);flex:1;white-space:nowrap;display:flex;align-items:center;gap:4px;" title="${h(t.name)}">\n                                ${o}\n                                ${h(t.name.length>4?t.name.substring(0,4)+'..':t.name)}\n                            </span>\n                            <div style="display:flex;align-items:center;gap:6px;">\n                                <i class="fa-solid fa-hand-pointer acu-dash-use-item-btn" data-item="${h(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:8px;" title="使用${t.name}"></i>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">暂无物品</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${h(P)}" style="margin-top:10px;"><i class="fa-solid fa-shield-halved"></i> 装备 (${R.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px;max-height:80px;overflow-y:auto;margin-bottom:10px;">\n                    ${R.length>0?R.map((t,n)=>{const e=n===R.length-1,a=Vt(t.name,null);let o='';return o=a?a.startsWith('fa:')?`<i class="fa-solid fa-${a.slice(3)}" style="font-size:10px;opacity:0.7;"></i>`:a.startsWith('ti:')?`<i class="ti ti-${a.slice(3)}" style="font-size:10px;opacity:0.7;"></i>`:`<span style="font-size:10px;">${a}</span>`:'<i class="fa-solid fa-shirt" style="font-size:9px;opacity:0.4;"></i>',`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${s?.key||''}"\n                            data-row-index="${j.findIndex(n=>n.name===t.name)}"\n                            data-preview-type="equipment"\n                            style="display:flex;align-items:center;gap:4px;padding:4px;font-size:11px;cursor:pointer;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;${e?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            ${o}\n                            <span style="color:var(--acu-text-main);overflow:hidden;text-overflow:ellipsis;" title="${h(t.name)}">${h(t.name)}</span>\n                        </div>`}).join(''):'<div class="acu-empty-hint">暂无装备</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${h(C)}" style="margin-top:10px;"><i class="fa-solid fa-clipboard-list"></i> 任务 (${M.length})</h3>\n                    <div style="max-height:50px;overflow-y:auto;">\n                    ${M.length>0?M.map((t,n)=>{const e=String(t.type||'').includes('主线');let a=null;const o=String(t.progress||'').match(/(\d+)\s*%/);o&&(a=Math.min(100,Math.max(0,parseInt(o[1],10))));const i=null!==a?`<div style="width:40px;height:4px;background:var(--acu-border);border-radius:2px;overflow:hidden;"><div style="width:${a}%;height:100%;background:var(--acu-accent);"></div></div>`:'';return`<div class="acu-task-item acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${r?.key||''}"\n                            data-row-index="${void 0!==t._rowIndex?t._rowIndex:E.findIndex(n=>n.name===t.name)}"\n                            data-preview-type="quest"\n                            style="padding:4px 8px;margin-bottom:3px;cursor:pointer;">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <div class="acu-task-name" style="font-size:11px;${e?'font-weight:600;':''}">${h(t.name)}</div>\n                                ${i}\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">暂无任务</div>'}\n                    </div>\n                </div>\n            </div>\n    `;const U=[e?'全局数据':null,a?'主角信息':null,o?'地点':null,i?'NPC':null,r?'任务':null,c?'背包':null,s?'装备':null].filter(Boolean);return console.info(`[DICE]仪表盘数据抓取完成，共${U.length}个模块: ${U.join(', ')}`),L},So=async()=>{const t=await It.getAll(),n=await It.getAllTags(),e={},a=[];for(const n of t)if(n.tags&&n.tags.length>0)for(const t of n.tags)e[t]||(e[t]=[]),e[t].push(n);else a.push(n);const o=t=>{const n=t.header.map((n,e)=>{const a=n.replace(/[\(（\[【][^)）\]】]*[\)）\]】]/g,'').trim();return`\n        <div class="acu-card-row">\n          <div class="acu-card-label">${h(a)}</div>\n          <div class="acu-card-value">${h(String(t.rowData[e]||''))}</div>\n        </div>\n      `}).join(''),e=t.tags.map(t=>`<span class="acu-fav-tag">${h(t)}</span>`).join(''),a=t.sourceInfo?h(t.sourceInfo.tableName):'';return`\n        <div class="acu-data-card acu-fav-card" data-id="${h(t.id)}">\n          <div class="acu-card-header">\n            <span class="acu-editable-title">${h(String(t.rowData[0]||'未命名'))}</span>\n          </div>\n          <div class="acu-card-body view-list">${n}</div>\n          <div class="acu-fav-card-tags">\n            ${a?`<span class="acu-fav-card-source">${a}</span>`:''}\n            ${e}\n          </div>\n        </div>\n      `},i=ca();let r='';for(const t of Object.keys(e).sort())r+=`\n        <div class="acu-fav-group">\n          <div class="acu-fav-group-title"><i class="fa-solid fa-tag"></i> ${h(t)}</div>\n          <div class="acu-card-grid">${e[t].map(o).join('')}</div>\n        </div>\n      `;return a.length>0&&(r+=`\n        <div class="acu-fav-group">\n          <div class="acu-fav-group-title"><i class="fa-solid fa-inbox"></i> 未分类</div>\n          <div class="acu-card-grid">${a.map(o).join('')}</div>\n        </div>\n      `),0===t.length&&(r+='\n        <div class="acu-fav-empty">\n          <i class="fa-solid fa-star"></i>\n          <p>暂无收藏</p>\n          <p>右键点击表格行 → 选择"收藏此行"</p>\n        </div>\n      '),`\n      <div class="acu-fav-wrapper acu-theme-${i.theme}" style="--acu-card-width:${i.cardWidth}px; --acu-font-size:${i.fontSize}px;">\n      <div class="acu-panel-header">\n        <div class="acu-panel-title">\n          <div class="acu-title-main"><i class="fa-solid fa-star"></i> <span class="acu-title-text">收藏夹</span></div>\n          <div class="acu-title-sub">(共${t.length}项)</div>\n        </div>\n        <div class="acu-header-actions">\n          <button class="acu-view-btn" id="acu-fav-import" title="导入"><i class="fa-solid fa-file-import"></i></button>\n          <button class="acu-view-btn" id="acu-fav-export" title="导出"><i class="fa-solid fa-file-export"></i></button>\n          <div class="acu-search-wrapper"><i class="fa-solid fa-search acu-search-icon"></i><input type="text" class="acu-search-input" id="acu-fav-search" placeholder="搜索..." /></div>\n          <div class="acu-height-control"><i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="收藏夹"></i></div>\n          <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n        </div>\n      </div>\n      <div class="acu-fav-panel-content">\n        <div class="acu-fav-tag-filter-collapsible collapsed">\n          <div class="acu-fav-tag-filter-header">\n            <span>标签过滤</span>\n            <i class="fa-solid fa-chevron-down acu-fav-tag-toggle-icon"></i>\n          </div>\n          <div class="acu-fav-tag-filter-body">\n            ${a.length>0?'<button class="acu-fav-tag-btn active" data-tag="__untagged__">未分类</button>':''}\n            ${n.map(t=>`<button class="acu-fav-tag-btn active" data-tag="${h(t)}">${h(t)}</button>`).join('')}\n          </div>\n        </div>\n        ${r}\n      </div>\n      </div>\n    `},Io=t=>{const{$}=le(),n=Yn||pa()||{};t.off('.favEvents'),function(){const n=t[0];if(!n)return;if(n._favSwipeFixApplied)return;n._favSwipeFixApplied=!0;let e=0,a=0,o=!1;const i=t=>{1===t.touches.length&&(e=t.touches[0].clientX,a=t.touches[0].clientY,o=!1)},r=t=>{if(1!==t.touches.length)return;const n=t.touches[0],i=Math.abs(n.clientX-e),r=Math.abs(n.clientY-a);(r<5?i>5&&i>2*r:i>1.5*r&&i>10)&&(o=!0,t.stopImmediatePropagation(),t.stopPropagation())},c=t=>{o&&(t.stopImmediatePropagation(),t.stopPropagation(),o=!1),e=0,a=0};n.addEventListener('touchstart',i,!0),n.addEventListener('touchmove',r,!0),n.addEventListener('touchend',c,!0),$(window).on('pagehide.favSwipeFix',()=>{n.removeEventListener('touchstart',i,!0),n.removeEventListener('touchmove',r,!0),n.removeEventListener('touchend',c,!0)})}(),t.on('click.favEvents','.acu-close-btn',function(n){n.stopPropagation(),fe.set('acu_favorites_panel_active',!1),t.html(''),$('#acu-btn-favorites').removeClass('active')}),t.on('pointerdown.favEvents','.acu-height-drag-handle',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const n=this;n.setPointerCapture(t.pointerId),$(n).addClass('active');const e=$('#acu-data-area'),a=e.height()||400,o=t.clientY,i=$(n).data('table');n.onpointermove=function(t){const n=t.clientY-o;let i=a-n;i<O&&(i=O),i>V&&(i=V),e.css('height',i+'px')},n.onpointerup=function(t){if($(n).removeClass('active'),n.releasePointerCapture(t.pointerId),n.onpointermove=null,n.onpointerup=null,i){const t=Ce();t[i]=parseInt(e.css('height')),Ee(t),e.addClass('acu-manual-mode')}}}),t.on('dblclick.favEvents','.acu-height-drag-handle',function(t){t.preventDefault(),t.stopPropagation();const n=$(this).data('table');if(n){const t=Ce();delete t[n],Ee(t),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),t.on('click.favEvents','.acu-fav-tag-filter-header',function(){$(this).closest('.acu-fav-tag-filter-collapsible').toggleClass('collapsed')}),t.on('click.favEvents','.acu-fav-tag-btn',function(){const n=$(this),e=n.data('tag'),a=n.hasClass('active');n.toggleClass('active'),'__untagged__'===e?t.find('.acu-fav-group').each(function(){$(this).find('.acu-fav-group-title').text().includes('未分类')&&$(this).toggle(!a)}):t.find('.acu-fav-group').each(function(){const t=$(this).find('.acu-fav-group-title').text();t.includes(e)&&!t.includes('未分类')&&$(this).toggle(!a)})}),t.find('#acu-fav-search').on('input.favEvents',_.debounce(function(){const n=$(this).val().toLowerCase().trim();t.find('.acu-fav-card').each(function(){const t=$(this).text().toLowerCase();$(this).toggle(t.includes(n))})},300));const e=(e,a)=>{$('.acu-cell-menu, .acu-menu-backdrop').remove();const o=$('<div class="acu-menu-backdrop"></div>');$('body').append(o);const i=ca(),r=$(`\n        <div class="acu-cell-menu acu-theme-${i.theme}" data-fav-id="${h(a)}">\n          <div class="acu-cell-menu-item" data-action="edit"><i class="fa-solid fa-pen"></i> 编辑</div>\n          <div class="acu-cell-menu-item" data-action="copy"><i class="fa-solid fa-copy"></i> 复制</div>\n          <div class="acu-cell-menu-item" data-action="send"><i class="fa-solid fa-paper-plane"></i> 发送到表格</div>\n          <div class="acu-cell-menu-item" data-action="delete"><i class="fa-solid fa-trash"></i> 删除</div>\n          <div class="acu-cell-menu-item" data-action="close"><i class="fa-solid fa-times"></i> 关闭菜单</div>\n        </div>\n      `);$('body').append(r);const c=$(window).width()||800,s=$(window).height()||600,l=r.outerWidth()||150,d=r.outerHeight()||150;let u=e.clientX||c/2,p=e.clientY||s/2;u+l>c&&(u=c-l-10),p+d>s&&(p=s-d-10),r.css({left:u,top:p}),o.on('click',()=>{$('.acu-cell-menu, .acu-menu-backdrop').remove()}),r.on('click','.acu-cell-menu-item',async function(){const e=$(this).data('action'),a=r.data('fav-id');if($('.acu-cell-menu, .acu-menu-backdrop').remove(),'close'===e)return;const o=await It.getById(a);if(o)if('edit'===e)lo(o,async n=>{await It.updateFavorite(a,n),t.html(await So()),Io(t)});else if('copy'===e){await It.duplicateFavorite(a)&&(t.html(await So()),Io(t))}else if('send'===e){const e=It.findCompatibleTables(o,n);if(0===e.length)return void toastr.warning('当前聊天没有兼容的表格');uo(o,e,n,async()=>{t.html(await So()),Io(t)})}else'delete'===e&&(await It.deleteFavorite(a),t.html(await So()),Io(t))})};t.on('click.favEvents','.acu-fav-card',function(t){t.stopPropagation();const n=$(this).data('id'),a=$('.acu-cell-menu');a.length&&a.data('fav-id')===n?$('.acu-cell-menu, .acu-menu-backdrop').remove():e(t,n)}),t.on('click.favEvents','#acu-fav-import',async function(){const n=document.createElement('input');n.type='file',n.accept='.json',n.onchange=async n=>{const e=n.target.files?.[0];if(e){const n=await e.text(),a=await It.importFavorites(n);a&&(a.added>0||a.updated>0)?(window.toastr&&window.toastr.success(`导入成功: 新增${a.added}条, 更新${a.updated}条`),t.html(await So()),Io(t)):window.toastr&&window.toastr.warning('导入失败或无有效数据')}},n.click()}),t.on('click.favEvents','#acu-fav-export',async function(){const t=await It.exportFavorites(),n=new Blob([t],{type:'application/json'}),e=URL.createObjectURL(n),a=document.createElement('a');a.href=e,a.download=`favorites_${(new Date).toISOString().slice(0,10)}.json`,a.click(),URL.revokeObjectURL(e),window.toastr&&window.toastr.success('导出成功')}),console.log('[DICE] bindFavoritesEvents initialized')},Do=(t,n)=>{if(!t||!t.rows.length)return`\n            <div class="acu-panel-header"><div class="acu-panel-title"><i class="fa-solid ${ue(n)}"></i> ${n}</div><button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button></div>\n            <div class="acu-panel-content"><div style="text-align:center;color:var(--acu-text-sub);padding:20px;">暂无数据</div></div>`;const e=ca(),a=(t.headers||[]).slice(1),o=s(),i=o?l(n):null,c=o&&i?o.getTableLockState(i):null,u='grid'===((Ae()||{})[n]||'list');let p=1;if(1===t.headers.length)p=0;else if(n.includes('总结')||n.includes('大纲')){const n=t.headers.findIndex(t=>t&&(t.includes('索引')||t.includes('编号')||t.includes('代码')));n>0&&(p=n)}let f=t.rows.map((e,a)=>{const o=r(n,e,t.headers);return{data:e,originalIndex:a,rowKey:o,isBookmarked:o&&b.isBookmarked(n,o)}});const g=(Gn[n]||'').toLowerCase().trim(),m=(t=>Ie().includes(t))(n);g?(f=f.filter(t=>t.data.some(t=>String(t).toLowerCase().includes(g))),f.sort((t,n)=>{if(t.isBookmarked&&!n.isBookmarked)return-1;if(!t.isBookmarked&&n.isBookmarked)return 1;const e=String(t.data[p]||'').toLowerCase(),a=String(n.data[p]||'').toLowerCase(),o=e.includes(g),i=a.includes(g);return e===g&&a!==g?-1:e!==g&&a===g?1:o&&!i?-1:!o&&i?1:t.originalIndex-n.originalIndex})):f.sort((t,n)=>t.isBookmarked&&!n.isBookmarked?-1:!t.isBookmarked&&n.isBookmarked?1:m?n.originalIndex-t.originalIndex:t.originalIndex-n.originalIndex);const v=e.itemsPerPage||50,w=f.length,y=Math.ceil(w/v)||1;let k=Kn[n]||1;k>y&&(k=y),k<1&&(k=1),Kn[n]=k;const C=(k-1)*v,E=C+v,A=f.slice(C,E),S=(t=>!!t&&['总结','大纲','日志','记录','历史'].some(n=>t.includes(n)))(n),I=S?`\n            <button class="acu-view-btn acu-reverse-btn" data-table="${h(n)}" title="${m?'当前：倒序（新→旧），点击切换为正序':'当前：正序（旧→新），点击切换为倒序'}">\n                <i class="fa-solid ${m?'fa-sort-amount-up':'fa-sort-amount-down'}"></i>\n            </button>\n        `:'';let D=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n    <div class="acu-title-main"><i class="fa-solid ${ue(n)}"></i> <span class="acu-title-text">${h(n)}</span></div>\n    <div class="acu-title-sub">(${C+1}-${Math.min(E,w)} / 共${w}项)${m?' <span style="color:var(--acu-accent);">↓倒序</span>':''}</div>\n</div>\n                <div class="acu-header-actions">\n                    ${n.includes('人物')?`<button class="acu-view-btn" id="acu-btn-relation-graph" data-table="${h(n)}" title="查看人物关系图"><i class="fa-solid fa-project-diagram"></i></button>`:''}\n                    ${n.includes('地图')?'<button class="acu-view-btn acu-table-map-btn" title="地图可视化"><i class="fa-solid fa-map"></i></button>':''}\n                    ${I}\n                    <button class="acu-view-btn" id="acu-btn-switch-style" data-table="${h(n)}" title="🔄 点击切换视图模式 (当前: ${u?'双列网格':'单列列表'})">\n                        <i class="fa-solid ${u?'fa-th-large':'fa-list'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${h(n)}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                    </div>\n\n                    <div class="acu-search-wrapper"><i class="fa-solid fa-search acu-search-icon"></i><input type="text" class="acu-search-input" placeholder="搜索全部..." value="${(Gn[n]||'').replace(/"/g,'&quot;')}" /></div>\n                    <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>\n            <div class="acu-panel-content"><div class="acu-card-grid">`;if(D+=A.map(o=>{const s=o.originalIndex,l=o.data,f=l[p]||'未命名',g=Rt(n)?jt(String(f)):String(f),m=1===p,v=`${t.key}-${s}-${p}`,w=window.acuModifiedSet&&window.acuModifiedSet.has(v),y=Ln.has(`${n}-row-${s}`);let k='';e.highlightNew&&(w?k='acu-highlight-manual':y&&(k='acu-highlight-diff'));const C=r(n,l,t.headers),E=i&&C?d(i,n,C):null,A=!(!c||null===E)&&c.rows.includes(E),S=!(!c||null===E)&&c.cells.includes(`${E}:${p-1}`),I=l.map((_,t)=>t).filter(t=>t>0&&t!==p),D=I.length%2==1,M=l.map((o,i)=>{if(i<=0||i===p)return'';if((a[i-1]||'').includes('交互'))return'';const r=i===I[I.length-1]&&D,l=a[i-1]||'属性'+i,d=!(!c||null===E)&&c.cells.includes(`${E}:${i-1}`),u=A||d,f=l.replace(/[\(（\[【][^)）\]】]*[\)）\]】]/g,'').trim(),g=t=>String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),m=String(o).trim(),b=Tt(m),v=['-','--','—','null','none','无','空','n/a','undefined','/','nil'];if(v.includes(b.toLowerCase()))return'';let w='',y=!1;const k=/[;；]/,C=t=>{if(!t)return!1;return String(t).toLowerCase().includes('身份')},S=C(l)?[]:In(b);if(C(l)){const t=pe(b),n=''===g(b)&&'0'!==String(o)?'&nbsp;':g(b);w=t?'<span class="acu-badge '+t+'">'+n+'</span>':n}else if(Mn(b,f)){const t=Dn(b).filter(t=>!t.relation||!v.includes(t.relation.toLowerCase()));if(t.length>1){y=!0;let n='';for(let e=0;e<t.length;e++){const a=t[e];n+='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;'+(e<t.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'')+'">',n+='<span style="color:var(--acu-text-sub);font-size:0.95em;" data-locked="'+u+'">'+g(a.name)+'</span>',a.relation&&(n+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+g(a.relation)+'</span>'),n+='</div>'}w='<div class="acu-relation-container">'+n+'</div>'}else if(1===t.length){y=!0;const n=t[0];w='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">',w+='<span style="color:var(--acu-text-sub);font-size:0.95em;" data-locked="'+u+'">'+g(n.name)+'</span>',n.relation&&(w+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+g(n.relation)+'</span>'),w+='</div>'}}else if(S.length>1){y=!0;let t='';for(let n=0;n<S.length;n++){const e=S[n],a=!ht.isBlacklisted(e.name);t+='<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;">',t+='<span style="color:var(--acu-text-sub);font-size:0.9em;white-space:nowrap;" data-locked="'+u+'" title="'+g(e.name)+'">'+g(e.name.length>3?e.name.substring(0,5):e.name)+'</span>',t+='<div style="display:flex;align-items:center;gap:4px;">',t+='<span style="color:var(--acu-text-main);font-weight:bold;font-size:0.95em;">'+e.value+'</span>',a&&(t+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+g(e.name)+'" data-attr-value="'+e.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:10px;" title="检定"></i>'),t+='</div></div>'}w='<div class="acu-multi-attr-container">'+t+'</div>'}else if(1===S.length){y=!0;const t=S[0],n=!ht.isBlacklisted(t.name);w='<div style="display:flex;justify-content:space-between;align-items:center;">',w+='<span style="color:var(--acu-text-sub);font-size:0.95em;" data-locked="'+u+'">'+g(t.name)+'</span>',w+='<div style="display:flex;align-items:center;gap:6px;">',w+='<span style="color:var(--acu-text-main);font-weight:bold;">'+t.value+'</span>',n&&(w+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+g(t.name)+'" data-attr-value="'+t.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>'),w+='</div></div>'}else if(b.length>0&&k.test(b)&&!b.includes('http')){const t=['-','--','—','null','none','无','空','n/a','undefined','/','nil'],n=b.split(k).map(t=>t.trim()).filter(n=>n&&!t.includes(n.toLowerCase()));if(n.length>1&&n.every(t=>t.length<=6)){w='<div class="acu-tag-container">'+n.map(t=>'<span class="acu-badge '+(pe(t)||'acu-badge-neutral')+'">'+g(t)+'</span>').join('')+'</div>'}else w=n.length>0?g(n.join('; ')):''}else if(!An(b)||b.includes(':')||b.includes('：')){const t=pe(b),n=''===g(b)&&'0'!==String(o)?'&nbsp;':g(b);w=t?'<span class="acu-badge '+t+'">'+n+'</span>':n}else{const t=Sn(b),n=!ht.isBlacklisted(f);w='<div style="display:flex;justify-content:space-between;align-items:center;">',w+='<span>'+g(b)+'</span>',n&&(w+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+g(f)+'" data-attr-value="'+t+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>'),w+='</div>'}const M=Ln.has(n+'-'+s+'-'+i),T=t.key+'-'+s+'-'+i,N=window.acuModifiedSet&&window.acuModifiedSet.has(T);let F='';e.highlightNew&&(N?F='acu-highlight-manual':M&&(F='acu-highlight-diff'));return'<div class="'+('acu-card-row acu-cell'+(r?' acu-grid-span-full':'')+(y?' acu-hide-label':''))+'" data-key="'+h(t.key)+'" data-tname="'+h(n)+'" data-row="'+s+'" data-col="'+i+'" data-val="'+x(o??'')+'"><div class="acu-card-label"><span data-locked="'+u+'">'+f+'</span></div><div class="acu-card-value '+F+'">'+w+'</div></div>'}).join(''),T=En(n,t.headers,l);let N='';if(T.length>0){l[p];N=`<div class="acu-card-actions">${T.map((t,n)=>`<button class="acu-action-item ${'check'===t.type?'check-type':''}" data-action-idx="${n}" data-row="${s}"><i class="fa-solid ${t.icon||'fa-play'}"></i> ${h(t.label)}</button>`).join('')}</div>`}const F=A||S,P=r(n,l,t.headers),j=P&&b.isBookmarked(n,P),R=P?`<i class="${j?'fa-solid':'fa-regular'} fa-bookmark acu-bookmark-icon ${j?'bookmarked':''}" data-table="${h(n)}" data-row-key="${h(P)}" title="${j?'取消书签':'添加书签'}"></i>`:'';return`<div class="acu-data-card"><div class="acu-card-header"><span class="acu-card-index">${m?'#'+(s+1):''}</span><span class="acu-cell acu-editable-title ${k}" data-key="${h(t.key)}" data-tname="${h(n)}" data-row="${s}" data-col="${p}" data-val="${x(f??'')}" data-locked="${F}" title="点击编辑标题">${h(g)}</span>${R}</div><div class="acu-card-body ${u?'view-grid':'view-list'}">${M}</div>${N}</div>`}).join(''),D+='</div></div>',y>1){D+=`<div class="acu-panel-footer"><button class="acu-page-btn ${1===k?'disabled':''}" data-page="${k-1}" ${1===k?'disabled':''}><i class="fa-solid fa-chevron-left"></i></button>`;const t=[];if(y<=7)for(let n=1;n<=y;n++)t.push(n);else k<=4?t.push(1,2,3,4,5,'...',y):k>=y-3?t.push(1,'...',y-4,y-3,y-2,y-1,y):t.push(1,'...',k-1,k,k+1,'...',y);t.forEach(t=>{D+='...'===t?'<span class="acu-page-info">...</span>':`<button class="acu-page-btn ${t===k?'active':''}" data-page="${t}">${t}</button>`}),D+=`<button class="acu-page-btn ${k===y?'disabled':''}" data-page="${k+1}" ${k===y?'disabled':''}><i class="fa-solid fa-chevron-right"></i></button></div>`}return D},Mo=()=>{const{$}=le(),t=ge(),n=$('.acu-panel-content');if(t&&n.length){const e={};n.find('.acu-data-card, .acu-card-body, .acu-edit-textarea').each(function(){if(this.scrollTop>0){const t=$(this).closest('.acu-data-card').find('.acu-editable-title').data('row'),n=$(this).hasClass('acu-edit-textarea');if(void 0!==t){e[n?`edit-${t}`:t]=this.scrollTop}}}),ne[t]={left:n.scrollLeft(),top:n.scrollTop(),inner:e,timestamp:Date.now()}}},zo=()=>{const{$}=le();Mo(),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active'),me(null)},To=t=>{const{$}=le(),n=$('#acu-data-area');n.hasClass('visible')?t(n):(t(n),n.addClass('visible'))},No=t=>{const{$}=le(),n=$('.acu-wrapper');n.on('click','.acu-dash-relation-graph-btn',function(t){t.stopPropagation();const n=_a(Yn||pa()),e=yn.findTable(n,'npc');e&&e.data?Qe(e.data):window.toastr&&window.toastr.warning('未找到人物数据')}),n.on('click','.acu-dash-map-btn',function(t){t.stopPropagation(),Ze()}),n.on('click','.acu-dash-avatar-manager-btn',function(t){t.stopPropagation();try{let t;try{const n=Yn||pa();t=_a(n)}catch(t){throw console.error('获取表格数据失败:',t),new Error('无法读取表格数据')}if(!t||0===t.length)return void(window.toastr&&window.toastr.warning('仪表盘数据为空，请先添加表格数据'));const n=yn.findTable(t,'npc'),e=yn.findTable(t,'player'),a=[];if(e?.data?.rows?.[0]){const t=e.data.rows[0][1];t&&'string'==typeof t&&t.trim()&&a.push({name:t.trim(),isPlayer:!0})}if(n?.data?.rows&&Array.isArray(n.data.rows)&&n.data.rows.forEach((t,n)=>{if(Array.isArray(t)&&t[1]){const e=t[1];'string'==typeof e&&e.trim()&&a.push({name:e.trim(),isPlayer:!1,rowIndex:n})}}),0===a.length)return void(window.toastr&&window.toastr.warning('未找到角色数据，请先在仪表盘中添加主角或NPC'));try{na(a,()=>mo())}catch(t){throw console.error('showAvatarManager 执行失败:',t),new Error('头像管理器初始化失败')}}catch(t){console.error('头像管理按钮错误:',t);const n=t instanceof Error?t.message:'未知错误';window.toastr&&window.toastr.error(`打开头像管理失败: ${n}`)}}),n.off('click.acu_dash_table_link').on('click.acu_dash_table_link','.acu-dash-table-link',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('table');n&&(fe.set(F,!1),fe.set('acu_changes_panel_active',!1),$('.acu-nav-btn').removeClass('active'),$(`.acu-nav-btn[data-table="${n}"]`).addClass('active'),me(n),setTimeout(()=>mo(),0))}),$('.acu-panel-content').off('touchstart.acu_swipe touchmove.acu_swipe').on('touchstart.acu_swipe',function(t){this._touchStartX=t.originalEvent.touches[0].clientX,this._touchStartY=t.originalEvent.touches[0].clientY}).on('touchmove.acu_swipe',function(t){if(!this._touchStartX)return;const n=Math.abs(t.originalEvent.touches[0].clientX-this._touchStartX);n>Math.abs(t.originalEvent.touches[0].clientY-this._touchStartY)&&n>10&&t.stopPropagation()}),$('body').off('click.acu_nav_toggle').on('click.acu_nav_toggle','.acu-nav-toggle-btn',function(t){if(t.stopPropagation(),t.preventDefault(),jn)return;const n=we();ye(!n),mo()}),$('body').off('click.acu_opt_toggle').on('click.acu_opt_toggle','.acu-opt-header[data-action="toggle-options"]',function(t){t.stopPropagation(),t.preventDefault();const n=$e();var e;e=!n,fe.set(N,e),mo()});const e=$('.acu-panel-content');if(e.length){let t=null;e.off('scroll.acu_save').on('scroll.acu_save',function(){const n=$(this);t&&clearTimeout(t),t=setTimeout(()=>{const t=ge();t&&(ne[t]||(ne[t]={top:0,left:0,inner:{}}),ne[t].top=n.scrollTop(),ne[t].left=n.scrollLeft())},200)})}$('body').off('click.acu_delegate').on('click.acu_delegate','.acu-wrapper',function(t){if(jn)return;const n=$(t.target);if(n.closest('#acu-btn-settings').length)return t.stopPropagation(),t.preventDefault(),void po();const e=n.closest('.acu-nav-btn');if(e.length){if('acu-btn-dashboard'===e.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const n=fe.get(F,!1),a=$('#acu-data-area').hasClass('visible');return n&&a?(fe.set(F,!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(fe.set(F,!0),me(null),$('.acu-nav-btn').removeClass('active'),e.addClass('active'),To(t=>{const n=Yn||pa(),e=_a(n||{});t.html(Ao(e)),No(e)})),!1}if('acu-btn-changes'===e.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const n=fe.get('acu_changes_panel_active',!1),a=$('#acu-data-area').hasClass('visible');return n&&a?(fe.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(be(),fe.set('acu_changes_panel_active',!0),me(null),$('.acu-nav-btn').removeClass('active'),e.addClass('active'),To(t=>{const n=Yn||pa();t.html(wo(n)),yo()})),!1}if('acu-btn-favorites'===e.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const n=fe.get('acu_favorites_panel_active',!1),a=$('#acu-data-area').hasClass('visible');return n&&a?(fe.set('acu_favorites_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(be(),fe.set('acu_favorites_panel_active',!0),$('.acu-nav-btn').removeClass('active'),e.addClass('active'),To(async t=>{t.html(await So()),Io(t)})),!1}if('acu-btn-mvu'===e.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const n=ge()===Lt.MODULE_ID,a=$('#acu-data-area').hasClass('visible');return n&&a?(me(null),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(be(),me(Lt.MODULE_ID),$('.acu-nav-btn').removeClass('active'),e.addClass('active'),To(t=>{try{const n=Lt.renderPanel(),e=Ce()[Lt.MODULE_ID];e?t.css('height',e+'px').addClass('acu-manual-mode'):t.css('height','').removeClass('acu-manual-mode'),t.html('<div class="acu-mvu-panel">'+n+'</div>'),Lt.bindEvents(t)}catch(t){console.error('[MVU] Error rendering panel:',t)}Lt.getDataWithRetry(5,800).then(n=>{n&&he()&&(t.html('<div class="acu-mvu-panel">'+Lt.renderPanel()+'</div>'),Lt.bindEvents(t))}).catch(n=>{console.error('[DICE]MvuModule Error getting data:',n),he()&&(t.html('<div class="acu-mvu-panel">'+Lt.renderPanel()+'</div>'),Lt.bindEvents(t))})})),!1}t.stopPropagation();const n=e.data('table'),a=ge();return a===n&&$('#acu-data-area').hasClass('visible')?void zo():(be(),$('.acu-nav-btn').removeClass('active'),e.addClass('active'),$('.acu-panel-content').length&&a&&Mo(),me(n),void setTimeout(()=>mo(),0))}const a=n.closest('.acu-cell');if(a.length)return t.stopPropagation(),void Fo(t,a[0]);const o=n.closest('.acu-page-btn');if(o.length){if(t.stopPropagation(),o.hasClass('disabled')||o.hasClass('active'))return;const n=parseInt(o.data('page')),e=ge();return void(e&&(Kn[e]=n,mo(),requestAnimationFrame(()=>{$('.acu-panel-content').scrollTop(0)})))}}),$('#acu-btn-expand').off('click').on('click',t=>{t.stopPropagation(),jn||(ye(!1),mo())}),$('#acu-btn-collapse').off('click').on('click',t=>{t.stopPropagation(),jn||(ye(!0),mo())}),$('#acu-btn-open-visualizer').off('click').on('click',t=>{if(t.stopPropagation(),jn)return;const n=window.parent||window;n.AutoCardUpdaterAPI&&'function'==typeof n.AutoCardUpdaterAPI.openVisualizer?n.AutoCardUpdaterAPI.openVisualizer():'function'==typeof n.openNewVisualizer_ACU?n.openNewVisualizer_ACU():window.toastr&&window.toastr.warning('可视化编辑器接口不可用，请确保神-数据库脚本已加载')}),$('#acu-btn-force-update').off('click').on('click',async t=>{if(t.stopPropagation(),jn)return;const n=le().getDB();if(n&&'function'==typeof n.manualUpdate)try{await n.manualUpdate()}catch(t){console.error('[DICE]ACU 手动更新失败:',t);const n=t.message||'更新过程中出现错误';window.toastr?window.toastr.error(`更新失败: ${n}`,'错误',{timeOut:5e3}):alert(`更新失败: ${n}`)}else window.toastr&&window.toastr.warning('⚠ 后端脚本未提供 manualUpdate 接口，请确保同时也更新了最新的后端脚本','',{timeOut:5e3})}),$('body').off('click.acu_settings').on('click.acu_settings','#acu-btn-settings',function(t){t.stopPropagation(),t.preventDefault(),jn||po()}),$('#acu-btn-dice-nav').off('click').on('click',t=>{t.stopPropagation(),jn||We({targetValue:null,targetName:''})}),$('#acu-btn-open-editor').off('click').on('click',t=>{if(t.stopPropagation(),jn)return;const n=le().getDB();n&&'function'==typeof n.openSettings?n.openSettings():window.toastr&&window.toastr.warning('后端脚本(神·数据库)未就绪或版本过低')}),$('#acu-btn-refill').off('click').on('click',async t=>{if(t.stopPropagation(),jn)return;const n=le().getDB();if(n&&'function'==typeof n.manualUpdate)try{console.log('[DICE]ACU 手动填表触发'),await n.manualUpdate()}catch(t){console.error('[DICE]ACU 手动填表失败:',t);const n=t.message||'填表过程中出现错误';window.toastr?window.toastr.error(`填表失败: ${n}`,'错误',{timeOut:5e3}):alert(`填表失败: ${n}`)}else console.warn('[DICE]ACU manualUpdate API 不可用'),window.toastr&&window.toastr.warning('后端脚本未提供 manualUpdate 接口','',{timeOut:3e3})}),$('#acu-btn-save-global').off('click').on('click',async function(t){if(t.stopPropagation(),jn)return;let n=null;if(n=Wn&&Yn?Yn:pa(),n){await xa(n,!0,!0),$('.acu-highlight-manual').removeClass('acu-highlight-manual'),window.acuModifiedSet&&window.acuModifiedSet.clear(),Wn=!1;const t=$(this);t.find('i').removeClass('acu-icon-breathe fa-spinner fa-spin').addClass('fa-save'),t.attr('title','保存所有修改').css('color',''),t.prop('disabled',!1)}else window.toastr&&window.toastr.error('无法获取有效数据，保存失败')});const a=$('.acu-search-input');if(a.length){let t,n=!1;a.off('compositionstart compositionend input').on('compositionstart',()=>{n=!0}).on('compositionend',function(){n=!1;const t=$(this).val(),e=ge();e&&(Gn[e]=t,Kn[e]=1,mo(),setTimeout(()=>{$('.acu-search-input').focus()},0))}).on('input',function(){if(n)return;const e=$(this).val(),a=this.selectionStart,o=this.selectionEnd;clearTimeout(t),t=setTimeout(()=>{const t=ge();if(t){Gn[t]=e,Kn[t]=1;const n=document.activeElement&&document.activeElement.classList.contains('acu-search-input');if(mo(),n){const t=$('.acu-search-input');if(t.focus(),t.length&&t[0].setSelectionRange)try{t[0].setSelectionRange(a,o)}catch(t){}}}},300)})}$('#acu-btn-relation-graph').off('click').on('click',function(t){t.preventDefault(),t.stopPropagation();const n=$(this).data('table'),e=Yn||pa();if(e)for(const t in e){const a=e[t];if(a?.name===n){const n={headers:a.content?.[0]||[],rows:a.content?.slice(1)||[],key:t};return void Qe(n)}}window.toastr&&window.toastr.warning('无法获取表格数据')}),$('.acu-table-map-btn').off('click').on('click',function(t){t.preventDefault(),t.stopPropagation(),Ze()}),$('#acu-btn-switch-style').off('click').on('click',function(t){t.preventDefault(),t.stopPropagation();const n=$(this).data('table'),e=Ae(),a=e[n]||'list';var o;e[n]='grid'===a?'list':'grid',o=e,fe.set(j,o),mo()}),$('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const n=this;n.setPointerCapture(t.pointerId),$(n).addClass('active');const e=$('#acu-data-area'),a=e.height(),o=t.clientY,i=$(n).data('table');n.onpointermove=function(t){const n=t.clientY-o;let i=a-n;i<O&&(i=O),i>V&&(i=V),e.css('height',i+'px')},n.onpointerup=function(t){if($(n).removeClass('active'),n.releasePointerCapture(t.pointerId),n.onpointermove=null,n.onpointerup=null,i){const t=Ce();t[i]=parseInt(e.css('height')),Ee(t),e.addClass('acu-manual-mode')}}}),$('.acu-height-drag-handle').off('dblclick').on('dblclick',function(t){t.preventDefault(),t.stopPropagation();const n=$(this).data('table');if(n){const t=Ce();delete t[n],Ee(t),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),n.on('click','.acu-reverse-btn',function(t){t.stopPropagation();const n=$(this).data('table');n&&(De(n),mo())}),$('.acu-panel-header').off('dblclick.acu').on('dblclick.acu',function(t){if($(t.target).closest('.acu-search-input, .acu-close-btn, .acu-view-btn').length)return;t.preventDefault(),t.stopPropagation();const n=ge();if(n){const t=Ce();delete t[n],Ee(t),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),n.find('.acu-close-btn').off('click').on('click',function(t){t.stopPropagation();const n=$('.acu-search-input');if(n.length&&n.val())return void n.val('').trigger('input').focus();if(fe.get(F,!1))return fe.set(F,!1),me(null),void mo();if(ge()===Lt.MODULE_ID)return me(null),void mo();zo()}),$('body').off('click.acu_bookmark').on('click.acu_bookmark','.acu-bookmark-icon',function(t){t.stopPropagation(),t.preventDefault();const n=$(this),e=n.data('table'),a=n.data('row-key');e&&a&&(b.toggleBookmark(e,a),'function'==typeof mo&&mo())}),$('body').off('click.acu_action').on('click.acu_action','.acu-action-item',function(t){t.stopPropagation(),t.preventDefault();const n=$(this),e=parseInt(n.data('row'),10),a=parseInt(n.data('action-idx'),10),o=n.closest('.acu-data-card').find('.acu-editable-title'),i=o.data('key'),r=o.data('tname')||'',c=Yn||pa();if(!c||!c[i])return;const s=c[i].content[0]||[],l=c[i].content[e+1]||[],d=En(r,s,l)[a];if(d&&'skill_check'===d.type){const t=l[1]||'技能';let n=null;const e=s.findIndex(t=>t&&t.includes('属性值')),a=s.findIndex(t=>t&&(t.includes('熟练')||t.includes('等级')));if(e>0&&l[e]){const t=Sn(l[e]);t>0&&(n=t)}if(null===n&&a>0&&l[a]){const t=Sn(l[a]);t>0&&(n=t)}const o=zn(d.template,l,s);return C(o,'action'),void(null!==n&&n>0?We({attrValue:n,targetValue:null,targetName:t,initiatorName:'<user>'}):$('#send_textarea').focus())}if(d&&d.template){const t=Yn||pa();if(t&&t[i]){const n=t[i].content[0]||[],a=t[i].content[e+1]||[],o=a[1]||'对方';if('交谈'===d.label){ca();$('.acu-msg-overlay').remove();const t=$(`\n                        <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:31200;display:flex;justify-content:center;align-items:center;">\n                            <div style="background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                                <div style="font-size:14px;font-weight:bold;color:var(--acu-accent);margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                                    <i class="fa-solid fa-comment"></i> 发送消息给 ${h(o)}\n                                </div>\n                                <input type="text" id="acu-msg-input" placeholder="输入消息内容..." style="width:100%;padding:10px 12px;background:var(--acu-input-bg) !important;border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main) !important;font-size:14px;box-sizing:border-box;" autofocus>\n                                <div style="display:flex;gap:8px;margin-top:12px;">\n                                    <button id="acu-msg-cancel" style="flex:1;padding:8px;background:var(--acu-input-bg);border:1px solid var(--acu-text-sub);border-radius:6px;color:var(--acu-text-main);cursor:pointer;">取消</button>\n                                    <button id="acu-msg-send" style="flex:1;padding:8px;background:var(--acu-btn-active-bg);border:none;border-radius:6px;color:var(--acu-btn-active-text);cursor:pointer;font-weight:bold;">发送</button>\n                                </div>\n                            </div>\n                        </div>\n                    `);$('body').append(t);const n=t[0];n.style.setProperty('position','fixed','important'),n.style.setProperty('top','0','important'),n.style.setProperty('left','0','important'),n.style.setProperty('right','0','important'),n.style.setProperty('bottom','0','important'),n.style.setProperty('width','100vw','important'),n.style.setProperty('height','100vh','important'),n.style.setProperty('display','flex','important'),n.style.setProperty('justify-content','center','important'),n.style.setProperty('align-items','center','important'),n.style.setProperty('z-index','31100','important'),setTimeout(()=>t.find('#acu-msg-input').focus(),50);const e=()=>{const n=t.find('#acu-msg-input').val().trim();if(n){C(`<user>对${o}说："${n}"`,'action'),$('#send_textarea').focus()}t.remove()};return t.find('#acu-msg-send').click(e),t.find('#acu-msg-input').on('keydown',function(t){'Enter'===t.key&&(t.preventDefault(),e())}),t.find('#acu-msg-cancel').click(()=>t.remove()),void y(t,'acu-msg-overlay',()=>t.remove())}const r=zn(d.template,a,n);C(r,'action'),$('#send_textarea').focus()}}}),$('body').off('click.acu_global_dice').on('click.acu_global_dice','#acu-btn-dice',function(t){t.stopPropagation(),We({targetValue:50,targetName:'自定义检定',diceType:'1d100'})}),$('body').off('click.acu_location_toggle').on('click.acu_location_toggle','.acu-location-header',function(t){t.stopPropagation();$(this).closest('.acu-location-group').toggleClass('expanded')}),$('body').off('click.acu_dash_jump').on('click.acu_dash_jump','.acu-dash-jump-link, .acu-dash-loc-item',function(t){t.stopPropagation();const n=$(this).data('table'),e=$(this).data('search')||'';n&&(fe.set(F,!1),me(n),e&&(Gn[n]=e,Kn[n]=1),mo(),e&&setTimeout(()=>{const t=$('.acu-search-input');t.length&&t.focus()},100))}),$('body').off('click.acu_inline_dice').on('click.acu_inline_dice','.acu-inline-dice-btn',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).attr('data-attr-name')||'属性',e=parseInt($(this).attr('data-attr-value'),10)||50,a=$(this).closest('.acu-data-card'),o=a.find('.acu-editable-title').text().trim(),i=(a.find('.acu-editable-title').data('tname')||'').includes('主角');We({attrValue:e,targetValue:null,targetName:n,initiatorName:i?'<user>':o})}),$('body').off('click.acu_dash_dice').on('click.acu_dash_dice','.acu-dash-dice-btn',function(t){t.stopPropagation(),t.preventDefault();const n=parseInt($(this).data('target'),10)||50,e=$(this).data('name')||'属性',a=$(this).data('npc')||'';if(a){const t=Fe('<user>',e)||50;He({initiatorName:'<user>',initiatorValue:t,opponentName:a,opponentValue:n})}else We({attrValue:n,targetValue:null,targetName:e,initiatorName:'<user>'})}),$('body').off('click.acu_dash_goto').on('click.acu_dash_goto','.acu-dash-goto-btn',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('location')||'未知地点';C(`<user>前往${n}。`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_item').on('click.acu_dash_use_item','.acu-dash-use-item-btn',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('item')||'物品';C(`<user>使用${n}。`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_skill').on('click.acu_dash_use_skill','.acu-dash-use-skill-btn',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('skill')||'技能',e=Yn||pa();let a=null;if(e)for(const t in e){const o=e[t];if(o&&o.name&&o.content&&(o.name.includes('技能')||o.name.includes('能力'))){const t=o.content[0]||[],e=t.findIndex(t=>t&&(t.includes('名称')||t.includes('技能名')))||1,i=t.findIndex(t=>t&&t.includes('属性值')),r=t.findIndex(t=>t&&(t.includes('熟练')||t.includes('等级')));for(let t=1;t<o.content.length;t++){const c=o.content[t];if(c&&c[-1===e?1:e]===n){if(i>0&&c[i]){const t=Sn(c[i]);if(t>0){a=t;break}}if(r>0&&c[r]){const t=Sn(c[r]);if(t>0){a=t;break}}break}}if(null!==a)break}}C(`<user>使用${n}。`,'action'),null!==a&&a>0?We({attrValue:a,targetValue:null,targetName:n,initiatorName:'<user>'}):$('#send_textarea').focus()}),$('body').off('click.acu_dash_track_task').on('click.acu_dash_track_task','.acu-dash-track-task-btn',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('task')||'任务';C(`<user>将${n}设为当前追踪目标。`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_msg').on('click.acu_dash_msg','.acu-dash-msg-btn',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('npc')||'对方';ca();$('.acu-msg-overlay').remove();const e=$(`\n            <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:31200;display:flex;justify-content:center;align-items:center;">\n                <div class="acu-msg-dialog" style="background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                    <div style="font-size:14px;font-weight:bold;color:var(--acu-accent);margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                        <i class="fa-solid fa-comment"></i> 发送消息给 ${h(n)}\n                    </div>\n                    <input type="text" id="acu-msg-input" placeholder="输入消息内容..." style="width:100%;padding:10px 12px;background:var(--acu-input-bg) !important;border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main) !important;font-size:14px;box-sizing:border-box;" autofocus>\n                    <div style="display:flex;gap:8px;margin-top:12px;">\n                        <button id="acu-msg-cancel" style="flex:1;padding:8px;background:var(--acu-input-bg);border:1px solid var(--acu-text-sub);border-radius:6px;color:var(--acu-text-main);cursor:pointer;">取消</button>\n                        <button id="acu-msg-send" style="flex:1;padding:8px;background:var(--acu-btn-active-bg);border:none;border-radius:6px;color:var(--acu-btn-active-text);cursor:pointer;font-weight:bold;">发送</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(e);const a=e[0];a.style.setProperty('position','fixed','important'),a.style.setProperty('top','0','important'),a.style.setProperty('left','0','important'),a.style.setProperty('right','0','important'),a.style.setProperty('bottom','0','important'),a.style.setProperty('width','100vw','important'),a.style.setProperty('height','100vh','important'),a.style.setProperty('display','flex','important'),a.style.setProperty('justify-content','center','important'),a.style.setProperty('align-items','center','important'),a.style.setProperty('z-index','31100','important'),setTimeout(()=>e.find('#acu-msg-input').focus(),50);const o=()=>{const t=e.find('#acu-msg-input').val().trim();if(t){C(`<user>对${n}说："${t}"`,'action'),$('#send_textarea').focus()}e.remove()};e.find('#acu-msg-send').click(o),e.find('#acu-msg-input').on('keydown',function(t){'Enter'===t.key&&(t.preventDefault(),o())}),e.find('#acu-msg-cancel').click(()=>e.remove()),y(e,'acu-msg-overlay',()=>e.remove())}),$('body').off('click.acu_dash_contest').on('click.acu_dash_contest','.acu-dash-contest-btn',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('npc')||'',e=Yn||pa();var a=50,o=50;if(e)for(var i in e){var r=e[i];if(r&&r.name&&r.content){if('主角信息'===r.name&&r.content[1])for(var c=(r.content[1][7]||'').split(/[,，;；\s]+/),s=0;s<c.length;s++){var l=c[s].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\s：]\s*(\d+)/);if(l){a=parseInt(l[2],10);break}}if('重要人物表'===r.name&&n)for(var d=1;d<r.content.length;d++){var u=r.content[d];if(u&&u[1]===n){for(var p=(u[9]||'').split(/[,，;；\s]+/),f=0;f<p.length;f++){var g=p[f].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\s：]\s*(\d+)/);if(g){o=parseInt(g[2],10);break}}break}}}}He({initiatorName:'<user>',initiatorValue:a,opponentName:n,opponentValue:o,diceType:'1d100'})}),$('body').off('click.acu_preview_cell_menu').on('click.acu_preview_cell_menu','.acu-preview-overlay .acu-cell',function(t){if(console.log('[DICE] preview cell click triggered',this,$(this).data()),$(t.target).closest('.acu-preview-close').length)return;const n=$(this),e=$('.acu-cell-menu');if(e.length){if(e.data('cell-id')===`${n.data('key')}-${n.data('row')}-${n.data('col')}`)return void $('.acu-cell-menu, .acu-menu-backdrop').remove()}t.stopPropagation(),t.preventDefault(),Fo(t,this);const a=`${n.data('key')}-${n.data('row')}-${n.data('col')}`;$('.acu-cell-menu').data('cell-id',a)}),$('body').off('click.acu_dash_preview').on('click.acu_dash_preview','.acu-dash-preview-trigger',function(t){t.stopPropagation();const n=$(this).data('table-key'),e=parseInt($(this).data('row-index'),10);if(!n||isNaN(e))return;const a=Yn||pa();if(!a||!a[n])return;const o=a[n],i=o.name||'详情',c=o.content[0]||[],u=o.content[e+1];if(!u)return;const p=ca(),f=u[1]||'未命名',g=Rt(i)?jt(String(f)):String(f),m=e,b=s(),v=b?l(i):null,w=b&&v?b.getTableLockState(v):null,k=r(i,u,c),C=v&&k?d(v,i,k):null,E=!(!w||null===C)&&(w.rows?.includes(C)??!1),A=E||!(!w||null===C)&&(w.cells?.includes(`${C}:0`)??!1);let S='';u.forEach((t,e)=>{if(e<=0||1===e)return;if((c[e]||'').includes('交互'))return;const a=(c[e]||'属性'+e).replace(/[\(（\[【][^)）\]】]*[\)）\]】]/g,'').trim(),o=String(t||'').trim();if(!o)return;const r=!(!w||null===C)&&(w.cells?.includes(`${C}:${e-1}`)??!1),s=E||r;let l='',d=!1;const u=In(o);if(Mn(o,a)){const t=Dn(o);if(t.length>1){d=!0;let n='';t.forEach((e,a)=>{const o=a<t.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';n+=`<div style="display:flex;justify-content:flex-start;align-items:center;gap:8px;padding:3px 0;${o}">\n                              <span style="color:var(--acu-text-sub);font-size:0.95em;" data-locked="${s}">${h(e.name)}</span>\n                              ${e.relation?`<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${h(e.relation)}</span>`:''}\n                          </div>`}),l=`<div class="acu-relation-container">${n}</div>`}else if(1===t.length&&t[0].relation){d=!0;const n=t[0];l=`<div style="display:flex;justify-content:flex-start;align-items:center;gap:8px;">\n                          <span style="color:var(--acu-text-sub);" data-locked="${s}">${h(n.name)}</span>\n                          <span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${h(n.relation)}</span>\n                      </div>`}}else if(u.length>1){d=!0;let t='';u.forEach((n,e)=>{const a=!ht.isBlacklisted(n.name),o=e<u.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';t+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;${o}">\n                          <span style="color:var(--acu-text-sub);font-size:0.95em;" data-locked="${s}">${h(n.name)}</span>\n                          <div style="display:flex;align-items:center;gap:6px;">\n                              <span style="color:var(--acu-text-main);font-weight:bold;">${n.value}</span>\n                              ${a?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${h(n.name)}" data-attr-value="${n.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>`:''}\n                          </div></div>`}),l=`<div class="acu-multi-attr-container">${t}</div>`}else if(1===u.length){d=!0;const t=u[0],n=!ht.isBlacklisted(t.name);l=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                      <span style="color:var(--acu-text-sub);font-size:0.95em;" data-locked="${s}">${h(t.name)}</span>\n                      <div style="display:flex;align-items:center;gap:6px;">\n                          <span style="color:var(--acu-text-main);font-weight:bold;">${t.value}</span>\n                          ${n?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${h(t.name)}" data-attr-value="${t.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>`:''}\n                      </div></div>`}else if(!An(o)||o.includes(':')||o.includes('：')){const t=pe(o);l=t?`<span class="acu-badge ${t}">${h(o)}</span>`:h(o)}else{const t=Sn(o),n=!ht.isBlacklisted(a);l=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                      <span>${h(o)}</span>\n                      ${n?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${h(a)}" data-attr-value="${t}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;margin-left:6px;" title="检定"></i>`:''}\n                  </div>`}S+=`<div class="${'acu-card-row acu-cell'+(d?' acu-hide-label':'')}" data-key="${h(n)}" data-tname="${h(i)}" data-row="${m}" data-col="${e}" data-val="${x(t??'')}">\n                <div class="acu-card-label"><span data-locked="${s}">${h(a)}</span></div>\n                <div class="acu-card-value">${l}</div>\n            </div>`});const I=En(i,c,u);let D='';if(I.length>0){D=`<div class="acu-card-actions">${I.map((t,n)=>`<button class="acu-action-item ${'check'===t.type?'check-type':''}" data-action-idx="${n}" data-row="${m}"><i class="fa-solid ${t.icon||'fa-play'}"></i> ${h(t.label)}</button>`).join('')}</div>`}const M=`\n            <div class="acu-preview-overlay acu-theme-${p.theme}" style="--acu-card-width:${p.cardWidth}px;--acu-font-size:${p.fontSize}px;">\n                <div class="acu-data-card" style="width:90vw;max-width:420px;max-height:85vh;overflow-y:auto;">\n                    <div class="acu-card-header">\n                        <span class="acu-card-index">#${m+1}</span>\n                    <span class="acu-cell acu-editable-title" data-key="${h(n)}" data-tname="${h(i)}" data-row="${m}" data-col="1" data-val="${x(f)}" data-locked="${A}">${h(g)}</span>\n                        <button class="acu-preview-close" style="margin-left:auto;background:none;border:none;color:var(--acu-text-sub);cursor:pointer;font-size:16px;padding:4px;"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-card-body view-list">${S}</div>\n                    ${D}\n                </div>\n            </div>\n        `;$('.acu-preview-overlay').remove(),$('body').append(M);const T=$('.acu-preview-overlay')[0];T&&(T.style.setProperty('position','fixed','important'),T.style.setProperty('top','0','important'),T.style.setProperty('left','0','important'),T.style.setProperty('right','0','important'),T.style.setProperty('bottom','0','important'),T.style.setProperty('width','100vw','important'),T.style.setProperty('height','100vh','important'),T.style.setProperty('display','flex','important'),T.style.setProperty('justify-content','center','important'),T.style.setProperty('align-items','center','important'));const N=$('.acu-preview-overlay');y(N,'acu-preview-overlay',()=>N.remove()),N.on('click',function(t){$(t.target).closest('.acu-preview-close').length&&$(this).remove()})}),function(){const t=$(document);let n=0,e=0;t.on('touchstart.acuSwipeFix','#acu-data-area',function(t){1===t.originalEvent.touches.length&&(n=t.originalEvent.touches[0].clientX,e=t.originalEvent.touches[0].clientY)}),t.on('touchmove.acuSwipeFix','#acu-data-area',function(t){if(1!==t.originalEvent.touches.length)return;const a=t.originalEvent.touches[0],o=Math.abs(a.clientX-n);o>1.5*Math.abs(a.clientY-e)&&o>10&&(t.stopPropagation(),console.log('[DICE]ACU 阻止水平滑动冒泡，防止 ST swipe'))})}()};const Fo=(t,n)=>{const{$}=le();$('.acu-cell-menu, .acu-menu-backdrop').remove();const e=$('<div class="acu-menu-backdrop"></div>');$('body').append(e);const a=$(n),o=parseInt(a.data('row'),10),i=parseInt(a.data('col'),10);if(isNaN(o)||isNaN(i))return console.warn('[DICE]ACU 无效的行/列索引'),void e.remove();const c=a.data('key'),u=a.data('tname')||a.closest('.acu-data-card').find('.acu-editable-title').text(),p=w(a.data('val')),f=ca(),g=a.closest('.acu-data-card'),m=`${c}-${o}-${i}`;window.acuModifiedSet||(window.acuModifiedSet=new Set);const b=window.acuModifiedSet.has(m),v=Yn?.[c]?.content?.[0]||[],y=r(u,Yn?.[c]?.content?.[o+1]||[],v),k=v[i]||'';let C=!1,E=!1,A=-1,S='';const I=s();if(I&&y)if(S=l(u),S)if(A=d(S,u,y),null!==A&&-1!==A){const t=I.getTableLockState(S);if(t){E=t.rows?.includes(A)??!1;const n=`${A}:${i-1}`;C=t.cells?.includes(n)??!1}}else console.warn('[DICE] 找不到表格的 rowIndex'),C=!1,E=!1;else console.warn('[DICE] 找不到表格的 sheetKey'),C=!1,E=!1;else I||console.warn('[DICE] 神-数据库 API 不可用'),C=!1,E=!1;let D='';y&&(D='<div style="border-top:1px dashed var(--acu-border); margin:4px 0;"></div>',D+=C?'<div class="acu-cell-menu-item" id="act-unlock-field"><i class="fa-solid fa-unlock"></i> 解锁此单元格</div>':'<div class="acu-cell-menu-item" id="act-lock-field"><i class="fa-solid fa-lock"></i> 锁定此单元格</div>',D+=E?'<div class="acu-cell-menu-item" id="act-unlock-row"><i class="fa-solid fa-unlock"></i> 解锁整行</div>':'<div class="acu-cell-menu-item" id="act-lock-row"><i class="fa-solid fa-lock"></i> 锁定整行</div>');const M=$(`\n            <div class="acu-cell-menu acu-theme-${f.theme}">\n                <div class="acu-cell-menu-item" id="act-edit"><i class="fa-solid fa-pen"></i> 编辑内容</div>\n                <div class="acu-cell-menu-item" id="act-edit-card"><i class="fa-solid fa-edit"></i> 整体编辑</div>\n                <div class="acu-cell-menu-item" id="act-insert"><i class="fa-solid fa-plus"></i> 在下方插入新行</div>\n                <div class="acu-cell-menu-item" id="act-copy"><i class="fa-solid fa-copy"></i> 复制内容</div>\n                <div class="acu-cell-menu-item" id="act-favorite"><i class="fa-solid fa-star"></i> 收藏此行</div>\n                ${D}\n                ${b?'<div class="acu-cell-menu-item" id="act-undo"><i class="fa-solid fa-undo"></i> 撤销本次修改</div>':''}\n                <div class="acu-cell-menu-item" id="act-delete"><i class="fa-solid fa-trash"></i> 删除整行</div>\n                <div class="acu-cell-menu-item" id="act-close"><i class="fa-solid fa-times"></i> 关闭菜单</div>\n            </div>\n        `);$('body').append(M);const T=$(window).width(),N=$(window).height(),F=M.outerWidth()||150,P=M.outerHeight()||150;let j=t.clientX,R=t.clientY;!j&&t.originalEvent&&t.originalEvent.touches&&t.originalEvent.touches.length?(j=t.originalEvent.touches[0].clientX,R=t.originalEvent.touches[0].clientY):!j&&t.changedTouches&&t.changedTouches.length&&(j=t.changedTouches[0].clientX,R=t.changedTouches[0].clientY),void 0===j&&(j=T/2),void 0===R&&(R=N/2);let B=j+5,O=R+5;B+F>T&&(B=j-F-5),O+P>N&&(O=R-P-5),B<5&&(B=5),O<5&&(O=5),M.css({top:O+'px',left:B+'px'});const V=()=>{M.remove(),e.remove()};e.on('click',V),M.find('#act-close').click(V);const L=i-1;M.find('#act-lock-field').click(t=>{t.stopPropagation(),y&&k&&(I&&S&&null!==A&&-1!==A&&L>=0?(I.lockTableCell(S,A,L,!0),a.is('[data-locked]')&&a.attr('data-locked','true'),a.find('[data-locked]').attr('data-locked','true')):console.warn('[DICE] 神-数据库API不可用或索引转换失败，无法锁定单元格')),V()}),M.find('#act-unlock-field').click(t=>{t.stopPropagation(),y&&k&&(I&&S&&null!==A&&-1!==A&&L>=0?(I.lockTableCell(S,A,L,!1),a.is('[data-locked]')&&a.attr('data-locked','false'),a.find('[data-locked]').attr('data-locked','false')):console.warn('[DICE] 神-数据库API不可用或索引转换失败，无法解锁单元格')),V()}),M.find('#act-lock-row').click(t=>{t.stopPropagation(),y&&(I&&S&&null!==A&&-1!==A?(I.lockTableRow(S,A,!0),g.find('[data-locked]').attr('data-locked','true')):console.warn('[DICE] 神-数据库API不可用或索引转换失败，无法锁定整行')),V()}),M.find('#act-unlock-row').click(t=>{if(t.stopPropagation(),y)if(I&&S&&null!==A&&-1!==A){const t=I.getTableLockState(S);if(t&&t.cells){const n=`${A}:`;t.cells.forEach(t=>{if(t.startsWith(n)){const n=parseInt(t.split(':')[1],10);isNaN(n)||I.lockTableCell(S,A,n,!1)}})}I.lockTableRow(S,A,!1),g.find('[data-locked]').attr('data-locked','false')}else console.warn('[DICE] 神-数据库API不可用或索引转换失败，无法解锁整行');V()}),M.find('#act-copy').click(async t=>{if(t.stopPropagation(),window.TavernHelper&&window.TavernHelper.triggerSlash)try{const t=p.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\{/g,'\\{').replace(/\}/g,'\\}');return await window.TavernHelper.triggerSlash(`/clipboard-set "${t}"`),void V()}catch(t){console.warn('[DICE]ACU 酒馆接口复制失败，尝试浏览器原生方法',t)}const n=t=>{try{const n=document.createElement('textarea');n.value=t,n.style.position='fixed',n.style.left='-9999px',n.style.top='0',n.setAttribute('readonly',''),document.body.appendChild(n),n.select(),n.setSelectionRange(0,99999);const e=document.execCommand('copy');if(document.body.removeChild(n),!e)throw new Error('execCommand failed')}catch(n){console.error('[DICE]ACU 复制失败:',n),prompt('复制失败，请长按下方文本手动复制:',t)}};var e;e=p,navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{}).catch(()=>{n(e)}):n(e),V()}),M.find('#act-favorite').click(async()=>{try{const t=Yn?.[c];if(!t||!t.content)return toastr.error('无法获取表格数据'),void V();const n=(t.content[0]||[]).slice(1).map(t=>String(t||'')),e=(t.content[o+1]||[]).slice(1);if(0===n.length||0===e.length)return toastr.error('行数据为空'),void V();const a=prompt('请输入标签（多个标签用逗号分隔，留空则无标签）：',''),i=a?a.split(',').map(t=>t.trim()).filter(t=>t.length>0):[];await It.addFavorite(c,u,n,e,i)?toastr.success('收藏成功'):toastr.error('收藏失败')}catch(t){console.error('[DICE]收藏失败:',t),toastr.error('收藏失败: '+(t instanceof Error?t.message:String(t)))}V()}),M.find('#act-undo').click(()=>{const t=ke();let e=null;if(t&&t[c]?.content[o+1]&&(e=t[c].content[o+1][i]),null!==e){Yn||(Yn=pa()),Yn&&Yn[c]?.content[o+1]&&(Yn[c].content[o+1][i]=e);const t=$(n);t.attr('data-val',x(e)),t.data('val',x(e));let a=t;t.find('.acu-card-value').length>0?a=t.find('.acu-card-value'):t.hasClass('acu-grid-item')?a=t.find('.acu-grid-value'):t.hasClass('acu-full-item')&&(a=t.find('.acu-full-value'));const r=pe(e);r&&!t.hasClass('acu-editable-title')?a.html(`<span class="acu-badge ${r}">${e}</span>`):a.text(e),a.removeClass('acu-highlight-manual acu-highlight-diff'),t.hasClass('acu-editable-title')&&t.removeClass('acu-highlight-manual acu-highlight-diff'),window.acuModifiedSet.delete(m),0===window.acuModifiedSet.size&&(Wn=!1,de())}else window.toastr&&window.toastr.warning('无法找到原始数据，撤销失败');V()}),M.find('#act-delete').click(async()=>{const t=$('.acu-panel-content'),e=t.length?t.scrollTop():0,a=t.length?t.scrollLeft():0;V();const i=$('.acu-map-overlay'),r=i.length>0;$('.acu-preview-overlay').remove(),r&&(i.find(`.acu-map-element-chip[data-table-key="${c}"][data-row-index="${o}"]`).remove(),i.find(`.acu-map-thumbnail[data-table-key="${c}"][data-row-index="${o}"]`).remove());const s=$(n).closest('.acu-data-card');if(s.length&&!r&&(s.css('transition','all 0.2s ease').css('opacity','0').css('transform','scale(0.9)'),setTimeout(()=>s.slideUp(200,()=>s.remove()),200)),Yn||(Yn=pa()||ke()),Yn&&Yn[c]?.content){Yn[c].content.splice(o+1,1);try{if(await $a(Yn,[c]),Ln=la(Yn),mo(),r){const t=i.data('refreshMapData');'function'==typeof t&&await t()}setTimeout(()=>{const t=$('.acu-panel-content');t.length&&(e>0||a>0)&&(t.scrollTop(e),t.scrollLeft(a))},60)}catch(t){console.error('[DICE]ACU 删除保存失败:',t),toastr.error('删除保存失败: '+(t instanceof Error?t.message:String(t))),mo(),setTimeout(()=>{const t=$('.acu-panel-content');t.length&&(e>0||a>0)&&(t.scrollTop(e),t.scrollLeft(a))},60)}}}),M.find('#act-insert').click(async()=>{if(V(),Yn||(Yn=pa()),Yn||(Yn=ke()),Yn&&Yn[c]?.content){const t=Yn[c],n=t.content[0]?t.content[0].length:2,e=new Array(n).fill('');n>0&&(e[0]=String(t.content.length)),t.content.splice(o+2,0,e),await xa(Yn,!1,!0),mo(),setTimeout(()=>{const t=$('.acu-panel-content');t.length&&t[0].scrollHeight>t.height()&&t.scrollTop(t.scrollTop()+10)},100)}}),M.find('#act-edit-card').click(()=>{V();const t=Yn||pa();if(t&&t[c]){const n=t[c].content[0],e=t[c].content[o+1];e&&ia(e,n,u,o,c)}}),M.find('#act-edit').click(()=>{V(),Po(p,async t=>{if(Yn||(Yn=pa()||ke()),!Yn||!Yn[c]?.content[o+1])return void alert('数据结构异常，无法写入缓存，请刷新页面');Yn[c].content[o+1][i]=t;const e=$(n);e.attr('data-val',x(t)).data('val',x(t));let a=e;e.find('.acu-card-value').length?a=e.find('.acu-card-value'):e.hasClass('acu-grid-item')?a=e.find('.acu-grid-value'):e.hasClass('acu-editable-title')&&(a=e);const r=pe(t);r&&!e.hasClass('acu-editable-title')?a.html(`<span class="acu-badge ${r}">${h(t)}</span>`):a.text(t),a.removeClass('acu-highlight-manual acu-highlight-diff'),e.hasClass('acu-editable-title')&&e.removeClass('acu-highlight-manual acu-highlight-diff');try{const t=Yn[c].content[o+1];await ka(c,o,[...t])}catch(t){console.error('[DICE]ACU 单元格保存失败:',t),toastr.error('保存失败: '+(t instanceof Error?t.message:String(t)))}})})},Po=(t,n)=>{const{$}=le(),e=ca(),a=$(`\n            <div class="acu-edit-overlay">\n                \x3c!-- 2. [修改] 在这里加上 acu-theme-${e.theme} --\x3e\n                <div class="acu-edit-dialog acu-theme-${e.theme}">\n                    <div class="acu-edit-title">编辑单元格内容</div>\n                    <textarea class="acu-edit-textarea" spellcheck="false">${h(t)}</textarea>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(a);a.find('textarea').on('input',function(){var t;(t=this).style.height='auto',t.style.height=t.scrollHeight+2+'px'}),a.find('#dlg-cancel').click(()=>a.remove()),y(a,'acu-edit-overlay',()=>a.remove()),a.find('#dlg-save').click(()=>{n(a.find('textarea').val()),a.remove()})},jo=()=>{const{$}=le();if(!$)return;$('.dice-conflict-dialog-overlay').remove();$('body').append('\n      <div class="dice-conflict-dialog-overlay" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0, 0, 0, 0.75);\n        backdrop-filter: blur(4px);\n        z-index: 31200;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 20px;\n        box-sizing: border-box;\n      ">\n        <div class="dice-conflict-dialog" style="\n          background: #fff;\n          border-radius: 16px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n          max-width: 500px;\n          width: 100%;\n          padding: 30px;\n          box-sizing: border-box;\n          animation: diceDialogPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n        ">\n          <div style="\n            text-align: center;\n            margin-bottom: 20px;\n          ">\n            <div style="\n              font-size: 48px;\n              color: #e74c3c;\n              margin-bottom: 15px;\n            ">⚠️</div>\n            <h2 style="\n              font-size: 24px;\n              font-weight: bold;\n              color: #333;\n              margin: 0 0 10px 0;\n            ">脚本冲突检测</h2>\n            <p style="\n              font-size: 16px;\n              color: #666;\n              line-height: 1.6;\n              margin: 0;\n            ">检测到"可视化表格"脚本正在运行</p>\n          </div>\n          <div style="\n            background: #fff3cd;\n            border: 1px solid #ffc107;\n            border-radius: 8px;\n            padding: 15px;\n            margin-bottom: 20px;\n          ">\n            <p style="\n              font-size: 14px;\n              color: #856404;\n              line-height: 1.6;\n              margin: 0;\n            ">\n              <strong>提示：</strong>骰子系统与可视化表格脚本功能冲突，不能同时启用。<br>\n              请在酒馆助手的脚本管理中，<strong>关闭其中一个脚本后刷新酒馆页面</strong>。\n            </p>\n          </div>\n          <div style="\n            display: flex;\n            gap: 10px;\n            justify-content: center;\n            flex-wrap: wrap;\n          ">\n            <button id="dice-conflict-close" style="\n              background: #6c757d;\n              color: #fff;\n              border: none;\n              border-radius: 8px;\n              padding: 12px 24px;\n              font-size: 16px;\n              font-weight: bold;\n              cursor: pointer;\n              transition: all 0.2s;\n              min-width: 120px;\n            ">我知道了</button>\n          </div>\n        </div>\n      </div>\n      <style>\n        @keyframes diceDialogPop {\n          from {\n            opacity: 0;\n            transform: translateY(20px) scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n          }\n        }\n        .dice-conflict-dialog button:hover {\n          transform: translateY(-2px);\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        }\n        .dice-conflict-dialog button:active {\n          transform: translateY(0);\n        }\n        @media (max-width: 768px) {\n          .dice-conflict-dialog {\n            padding: 20px !important;\n            margin: 10px !important;\n            max-width: calc(100% - 20px) !important;\n          }\n          .dice-conflict-dialog h2 {\n            font-size: 20px !important;\n          }\n          .dice-conflict-dialog p {\n            font-size: 14px !important;\n          }\n        }\n      </style>\n    '),$('#dice-conflict-close').on('click',function(){$('.dice-conflict-dialog-overlay').fadeOut(200,function(){$(this).remove()})});const t=$('.dice-conflict-dialog-overlay');y(t,'dice-conflict-dialog-overlay',()=>{t.fadeOut(200,function(){$(this).remove()})}),window.toastr&&window.toastr.error('脚本冲突：骰子系统与可视化表格不能同时启用','冲突检测',{timeOut:0,extendedTimeOut:0,closeButton:!0,preventDuplicates:!0})},Ro=()=>{if(Nn)return;(()=>{const t=[];for(let n=0;n<localStorage.length;n++){const e=localStorage.key(n);e&&e.startsWith('acu_locked_fields_v2_')&&t.push(e)}t.forEach(t=>localStorage.removeItem(t)),t.length>0&&console.info(`[DICE] 已清理 ${t.length} 个旧锁定数据键`)})(),console.log('[DICE]开始初始化骰子系统...');try{at.restore(),console.info('[DICE]ConsoleCaptureManager 状态已恢复')}catch(t){console.error('[DICE]恢复 ConsoleCaptureManager 状态失败:',t)}try{ot.checkAndRestore(),console.info('[DICE]错误状态检查完成')}catch(t){console.error('[DICE]初始化时检查错误状态失败:',t)}if((()=>{const{$}=le();if(!$)return!1;const t=$('.acu-wrapper');if(t.length>0){const n=t.find('.acu-nav-container').length>0,e=t.find('.acu-data-display').length>0;if(t.attr('id'),t.attr('class'),n&&e&&!(t.find('[id*="dice"], [class*="dice"]').length>0))return!0}try{const t=document.querySelectorAll('script');for(const n of t){const t=n.textContent||n.innerHTML||'';if(t.includes('acu_visualizer_ui_v20_pagination')&&t.includes('acu_ui_config_v18'))return!0}}catch(t){}try{const t=localStorage.getItem('acu_ui_config_v18'),n=localStorage.getItem('acu_ui_config_v19');if(t&&!n&&!($('[id*="dice"], [class*="dice"]').length>0))return!0}catch(t){}return!1})())return jo(),void console.error('[DICE]骰子系统 检测到可视化表格脚本冲突，已阻止初始化');console.info('[DICE]注入 MVU 样式和自定义样式...'),Lt.injectStyles(),Un&&(Un.disconnect(),Un=null,console.info('[DICE]清理旧的 MutationObserver')),ua();const t=ca(),n=re.find(n=>n.id===t.fontFamily)?.val||re[0].val;if(i(t.theme,n),c(!0===t.muteDatabaseToasts),window.SillyTavern&&window.SillyTavern.eventSource){console.info('[DICE]注册 SillyTavern 事件监听器...');const t=window.SillyTavern.eventTypes,n=window.SillyTavern.eventSource,e=[t.CHAT_CHANGED,t.MESSAGE_SWIPED,t.MESSAGE_DELETED,t.MESSAGE_UPDATED];qn||(qn=()=>{jn?console.info('[DICE]正在编辑顺序，跳过界面渲染'):(console.info('[DICE]消息更新事件触发，延迟渲染界面'),setTimeout(mo,500))}),window._acuBoundChatChangeHandler||(window._acuBoundChatChangeHandler=()=>{console.info('[DICE]聊天切换事件触发，清理缓存并重新渲染'),Yn=null,Kn={},Gn={},ne={},Wn=!1,Ln.clear(),window.acuModifiedSet&&window.acuModifiedSet.clear();try{'function'==typeof Lt?.clearCache&&Lt.clearCache()}catch(t){console.warn('[DICE]清除变量面板缓存失败:',t)}setTimeout(mo,500)});const a=window._acuBoundChatChangeHandler;e.forEach(e=>{e&&(n.removeListener(e,qn),n.removeListener(e,a),e===t.CHAT_CHANGED?n.on(e,a):n.on(e,qn))}),console.info(`[DICE]已注册 ${e.length} 个事件监听器`)}else console.warn('[DICE]SillyTavern 事件源不可用，跳过事件监听器注册');const e=()=>{const t=le().getDB();if(t?.exportTableAsJson){Nn=!0,console.log('[DICE]骰子系统初始化成功'),console.info('[DICE]数据库 API 已就绪');const n=$('#chat');if(n.length&&!Un){console.info('[DICE]启动聊天区域 MutationObserver');let t=!1;Un=new MutationObserver(()=>{t||(t=!0,requestAnimationFrame(()=>{if('embedded'===ca().positionMode)return void(t=!1);const e=n.children().last()[0],a=$('.acu-wrapper')[0];a&&e&&e!==a&&($(e).hasClass('mes')||$(e).hasClass('message-body'))&&n.append(a);const o=qt();if(o&&o.hideDiceResultInChat){const t=n.children().last();(t.hasClass('mes')||t.hasClass('message-body'))&&t.addClass('acu-dice-result-revealing'),requestAnimationFrame(()=>{Wt(),requestAnimationFrame(()=>{t.removeClass('acu-dice-result-revealing').addClass('acu-dice-result-revealed'),setTimeout(()=>{t.removeClass('acu-dice-result-revealed')},200)})})}t=!1}))}),Un.observe(n[0],{childList:!0})}else n.length||console.warn('[DICE]聊天区域 (#chat) 未找到，跳过 MutationObserver 设置');console.info('[DICE]执行首次界面渲染...'),mo(),setTimeout(()=>{Wt()},500),t.registerTableUpdateCallback?(t.registerTableUpdateCallback(ee.handleUpdate),console.info('[DICE]已注册表格更新回调'),t.registerTableFillStartCallback&&(t.registerTableFillStartCallback(()=>{const n=t.exportTableAsJson();n&&_e(n)}),console.info('[DICE]已注册表格填充开始回调'))):console.warn('[DICE]数据库 API 不支持回调注册')}else Nn||(window._acuInitRetries=(window._acuInitRetries||0)+1,window._acuInitRetries<60?(window._acuInitRetries%10==0&&console.info(`[DICE]等待数据库 API 就绪... (${window._acuInitRetries}/60)`),setTimeout(e,1e3)):console.error('[DICE]未检测到数据库后端 API，停止轮询。请确保已安装神·数据库脚本。'))};e();setTimeout(()=>{const{$}=le(),t=()=>{Qn=!1,$('.acu-option-panel, .acu-embedded-options-container').fadeOut(200,function(){$(this).remove()})},n=new Map;let e=0;const a=t=>{const n='string'==typeof t?Number(t):t;return Number.isFinite(n)?n:null},o=t=>{if(!t)return!1;return/<meta:检定结果>[\s\S]*?<\/meta:检定结果>/g.test(t)},i=(t,n)=>{if(!t||!n)return'';const e=/(<本轮用户输入>)([\s\S]*?)(<\/本轮用户输入>)/,a=t.match(e);if(!a)return'';const o=a[2];if(o.includes(n))return'';const i=o.startsWith('\n')?'\n':'',r=o.endsWith('\n')?'\n':'',c=o.trim(),s=c?`${c} ${n}`:n;return(t.includes(n)?t.replace(n,'').trim():t).replace(e,`${a[1]}${i}${s}${r}${a[3]}`)},r=(t,n,a)=>{if(a)return;const r=n&&'object'==typeof n?n:{},c='string'==typeof r.quiet_prompt?r.quiet_prompt:'',s=!0===r.automatic_trigger;if(!0===r._acu_crazy_applied||s)return;if('quiet'===t||c.trim().length>0)return;const l=Date.now();if(l-e<300)return;const d='string'==typeof r.prompt?r.prompt:'';if(!d||!d.trim())return;if(o(d))return;if(!sn())return;const u=pn();if(!u)return;let p='';if(d.includes('<本轮用户输入>')){const t=i(d,u);p=t&&t!==d?t:`${d.trim()} ${u}`.trim()}else p=`${d.trim()} ${u}`.trim();r.prompt=p,r._acu_crazy_applied=!0,e=l},c=()=>{const t=Date.now();if(t-e<300)return;const{$}=le(),n=$('#send_textarea'),a=(n.val()||'').toString().trim();if(!a)return;if(o(a))return;if(!sn())return;const i=pn();if(!i)return;C(i,'dice');const r=(n.val()||'').toString();if(r){const t=n[0];t.value=r,t.dispatchEvent(new Event('input',{bubbles:!0})),t.dispatchEvent(new Event('change',{bubbles:!0}))}e=t},s=t=>{const e=a(t);if(null===e)return;if(!sn())return;const o=pn();o&&(n.set(e,{result:o,createdAt:Date.now()}),l(e))},l=async t=>{const e=a(t);if(null===e)return;const r=n.get(e);if(!r)return;if(Date.now()-r.createdAt>12e3)return void n.delete(e);n.delete(e);let c='';try{await enqueueMessageMutation(e,async()=>{const t=p?.chat||window.parent?.SillyTavern?.chat,n=t&&'number'==typeof e?t[e]:null,a=getChatMessages(e)[0];if(!(a&&'user'===a.role||n&&n.is_user))return;const s=String(n?.mes??a?.message??'');if(o(s))return;const l=a?.extra&&'object'==typeof a.extra?a.extra:{};if(!0!==l.acuCrazyModeApplied){if(s.includes('<本轮用户输入>')){const t=i(s,r.result);c=t&&t!==s?t:`${s} ${r.result}`.trim()}else c=s?`${s} ${r.result}`:r.result;n&&n.is_user&&(n.mes=c),await setChatMessages([{message_id:e,message:c,extra:{...l,acuCrazyModeApplied:!0}}],{refresh:'affected'})}})}catch(t){console.warn('[DICE]疯狂模式: 附加骰子结果失败',t)}const{$}=le(),s=$('#send_textarea');if(s.length&&c){(s.val()||'').toString()===c&&s.val('').trigger('input').trigger('change')}},d=()=>{A();const t=document.getElementById('send_but');if(t){const n=()=>{c(),E()};t.addEventListener('click',n,!0),t.addEventListener('pointerup',n,!0),t.addEventListener('touchend',n,!0)}$(document).off('click.acu_restore_dice','#send_but').on('click.acu_restore_dice','#send_but',function(t){c(),E()});const n=document.getElementById('send_textarea');n&&(n.addEventListener('keydown',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),E())},!0),n.addEventListener('keyup',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),E())},!0)),$('#send_textarea').off('keydown.acu_restore_dice').on('keydown.acu_restore_dice',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),E())}).off('keyup.acu_restore_dice').on('keyup.acu_restore_dice',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),E())});new MutationObserver(()=>{const t=$('#send_textarea');t.length&&!t[0]._acuValueIntercepted&&A()}).observe(document.body,{childList:!0,subtree:!0})},u=()=>{const t=window;t.__acuCrazyGenerateHookInstalled||t.TavernHelper&&'function'==typeof t.TavernHelper.generate&&(t.__acuCrazyGenerateOriginal=t.TavernHelper.generate,t.TavernHelper.generate=async function(...n){const a=n.length>0&&n[0]&&'object'==typeof n[0]?n[0]:null;if(a){const t='string'==typeof a.quiet_prompt?a.quiet_prompt:'',n=!0===a.automatic_trigger;if(!(!0===a._acu_crazy_applied)&&!n&&0===t.trim().length){let t='';const n=a.injects;if(Array.isArray(n)&&n.length>0){const e=n[0];if(e&&'object'==typeof e){const n=e.content;'string'==typeof n&&(t=n)}}if(t||'string'!=typeof a.prompt||(t=a.prompt),t||'string'!=typeof a.user_input||(t=a.user_input),t&&!o(t)&&sn()){const o=pn();if(o){const i=`${t.trim()} ${o}`.trim();if(Array.isArray(n)&&n.length>0){const t=n[0];t&&'object'==typeof t&&(t.content=i)}else'string'==typeof a.prompt?a.prompt=i:a.user_input=i;a._acu_crazy_applied=!0,e=Date.now(),console.info('[DICE]疯狂模式: 已注入到生成请求')}}}}return t.__acuCrazyGenerateOriginal.apply(this,n)},t.__acuCrazyGenerateHookInstalled=!0)},p=window.SillyTavern||window.parent?.SillyTavern,f=p?.eventTypes?.MESSAGE_SENT||(window.tavern_events?window.tavern_events.MESSAGE_SENT:'message_sent');if(p?.eventSource){p.eventSource.on(f,t),p.eventSource.on(f,async t=>{s(t),await processPendingEffectRuns(t);const n=qt();n&&n.hideDiceResultInChat&&setTimeout(()=>{Wt()},300)});const n=p?.eventTypes?.GENERATION_AFTER_COMMANDS||(window.tavern_events?window.tavern_events.GENERATION_AFTER_COMMANDS:'GENERATION_AFTER_COMMANDS');return n&&p.eventSource.on(n,(t,n,e)=>{r(t,n,e)}),u(),void d()}if('function'==typeof window.eventOn){window.eventOn(f,t),window.eventOn(f,async t=>{s(t),await processPendingEffectRuns(t);const n=qt();n&&n.hideDiceResultInChat&&setTimeout(()=>{Wt()},300)});const n=window.tavern_events?window.tavern_events.GENERATION_AFTER_COMMANDS:'GENERATION_AFTER_COMMANDS';return window.eventOn(n,(t,n,e)=>{r(t,n,e)}),u(),void d()}},2e3),setTimeout(()=>{A()},500);const a=window.eventOn||window.parent?.eventOn;'function'==typeof a?a('era:writeDone',t=>{'object'==typeof Lt&&'function'==typeof Lt.clearCache&&Lt.clearCache();'era'===Lt.detectMode()&&ge()===Lt.MODULE_ID&&(console.log('[DICE]ERA变量已更新，自动刷新面板'),mo())}):console.warn('[DICE]无法监听 ERA 事件，eventOn 不可用'),$(window).off('beforeunload.acu pagehide.acu').on('beforeunload.acu pagehide.acu',()=>{try{abortAllPendingRequests();const t=window.__acuEffectRunCleanerTimer;'number'==typeof t&&(window.clearInterval(t),delete window.__acuEffectRunCleanerTimer),localStorage.setItem(te,JSON.stringify(ne)),Un&&(Un.disconnect(),Un=null)}catch(t){console.warn('[DICE]页面卸载清理出错:',t)}})};window.testPairedTableFix=function(){const t='AM',n='编码索引',e={name:'总结表',content:[['编码索引','时间跨度','纪要'],['AM0001','时间1','纪要1'],['AM0002','时间2','纪要2'],[null,'时间3-错误行','纪要3-错误行'],['AM0030','时间4','纪要4'],[null,'时间5-错误行','纪要5-错误行']]},a={name:'总体大纲',content:[['编码索引','时间跨度','大纲'],[null,'时间A-错误行','大纲A-错误行'],['AM0002','时间B','大纲B'],['AM0030','时间C','大纲C'],['AM0040','时间D','大纲D'],['AM0050','时间E','大纲E']]},o=Sa(e,n,t),i=Sa(a,n,t),r=Da(e,0,a,0,n,Ia(o.allCodes,i.allCodes,t,1),t),c=n=>n.content.slice(1).map(t=>t[0]).filter(n=>n&&String(n).match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\d+$`))),s=c(e),l=c(a),d=e.content.slice(1).filter(n=>!n[0]||!String(n[0]).match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\d+$`))),u=a.content.slice(1).filter(n=>!n[0]||!String(n[0]).match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\d+$`))),p=(t,n,e)=>{const a=t.map(t=>{if(!t)return null;const e=t.match(new RegExp(`^${n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));return e?parseInt(e[1],10):null}).filter(t=>null!==t);for(let t=0;t<a.length;t++)if(a[t]!==e+t)return!1;return!0},f=p(s,t,1),g=p(l,t,1),m=new Set(s),b=new Set(l),h=m.size===b.size&&[...m].every(t=>b.has(t)),v=d.some(t=>t[1]&&t[1].includes('错误行')),x=u.some(t=>t[1]&&t[1].includes('错误行'));return{table1Sheet:e,table2Sheet:a,result:r,codes1:s,codes2:l,emptyRows1:d,emptyRows2:u,isValid1:f,isValid2:g,setsEqual:h,emptyRowsPreserved1:v,emptyRowsPreserved2:x,isValid:f&&g&&h&&v&&x}},window.diagnoseDiceVariables=async function(){return void 0!==Lt&&'function'==typeof Lt.diagnoseVariableFramework?await Lt.diagnoseVariableFramework():(console.error('[DICE]MvuModule 未初始化或诊断工具不可用'),null)};const{$}=le();$?$(document).ready(Ro):window.addEventListener('load',Ro)}();
//# sourceMappingURL=stable.js.map