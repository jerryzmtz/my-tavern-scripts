const t=[[/èéº¦é¢|æ‹‰é¢/,'ğŸœ'],[/RiNG|LiveHouse/,'ğŸ¸'],[/é»„ç“œ/,'ğŸ¥’'],[/èŠ’æœ/,'ğŸ¥­'],[/å‰§æœ¬/,'ğŸ“œ'],[/å‰ä»–/,'ğŸ¸'],[/ç•ªèŒ„/,'ğŸ…'],[/æ²™æ‹‰/,'ğŸ¥—'],[/å¥¶èŒ¶/,'ğŸ§‹'],[/é’¢ç´/,'ğŸ¹'],[/æ©˜å­/,'ğŸŠ'],[/éŸ³ç®±/,'ğŸ”Š'],[/å”±ç‰‡/,'ğŸ’¿'],[/çœ¼é•œ/,'ğŸ‘“'],[/é•¿è¢/,'ğŸ§¥'],[/è–¯æ¡/,'ğŸŸ'],[/é“…ç¬”/,'âœï¸'],[/ç§å­/,'ğŸŒ±'],[/å†°æ·‡æ·‹/,'ğŸ¦'],[/è‰è“/,'ğŸ“'],[/å¸ƒä¸/,'ğŸ®'],[/æ’ç”»|ç»˜æœ¬/,'ğŸ¨'],[/Tæ¤/,'ğŸ‘•'],[/å½•éŸ³/,'ğŸ™ï¸'],[/é£é“ƒ/,'ğŸ'],[/æ‰¶æ¢¯/,'ğŸ›—'],[/é•¿æ¤…|é•¿å‡³|å…¬å›­æ¤…/,'ğŸª‘'],[/èŠ±å›|èŠ±åœƒ/,'ğŸŒ·'],[/ä¹¦æ¶|ä¹¦æŸœ/,'ğŸ“š'],[/é›•åƒ|çŸ³åƒ/,'ğŸ—¿'],[/è¢«è¤¥/,'ğŸ›Œ'],[/æš–ç‚‰/,'ğŸ§±'],[/æœ¨å±‹/,'ğŸ›–'],[/å·¥åŠ/,'ğŸ› ï¸'],[/å­˜æ¡£ç‚¹|è®°å½•ç‚¹/,'ğŸ’¾'],[/ä¼ é€é—¨|ä¼ é€é˜µ/,'ğŸŒ€'],[/é™·é˜±|åœ°é›·|å°–åˆº/,'ğŸª¤'],[/å¼€å…³|æ‹‰æ†|æŒ‰é’®/,'ğŸ•¹ï¸'],[/ç¯ç«|è¥ç«|ç«æŠŠ/,'ğŸ”¥'],[/è·¯ç‰Œ|å‘Šç¤º/,'ğŸª§'],[/ç¥­å›/,'ğŸ•¯ï¸'],[/æœºåœº|åœæœºåª/,'âœˆï¸'],[/è½¦ç«™|ç«™|åœ°é“|ç«è½¦ç«™/,'ğŸš‰'],[/åœè½¦åœº|è½¦åº“/,'ğŸ…¿ï¸'],[/è·¯|å…¬è·¯|é«˜é€Ÿ/,'ğŸ›£ï¸'],[/æ ¡è½¦|å·´å£«|å…¬äº¤/,'ğŸšŒ'],[/å¨æˆ¿/,'ğŸ³'],[/æµ´å®¤/,'ğŸ›'],[/å•æ‰€|æ´—æ‰‹é—´|å«ç”Ÿé—´/,'ğŸš½'],[/é˜³å°|å¤©å°|éœ²å°/,'ğŸ”­'],[/åœ°ä¸‹å®¤|åœ°çª–/,'ğŸªœ'],[/ä¹¦æˆ¿/,'ğŸ“–'],[/å®¢å…|èµ·å±…å®¤/,'ğŸ›‹ï¸'],[/é—ºæˆ¿/,'ğŸ€'],[/ä¼šè®®å®¤/,'ğŸ‘¥'],[/ç´å®¤/,'ğŸ¹'],[/åå°/,'ğŸ­'],[/ä¸‹æ°´é“|æ’æ°´ç®¡/,'ğŸ€'],[/æ‘„å½±æ£š|ç‰‡åœº|å½±æ£š/,'ğŸ¬'],[/æ­¦å™¨åº—|é“åŒ é“º/,'âš”ï¸'],[/é˜²å…·åº—/,'ğŸ›¡ï¸'],[/é“å…·åº—|æ‚è´§é“º/,'ğŸ’'],[/æ¸©æ³‰|æ¾¡å ‚/,'â™¨ï¸'],[/èµŒåœº|å¨±ä¹åŸ|æ‰­è›‹æœº/,'ğŸ°'],[/å®éªŒå®¤|ç ”ç©¶æ‰€/,'ğŸ§ª'],[/å·¥å‚|å‘ç”µå‚/,'ğŸ­'],[/è­¦å¯Ÿå±€|æ´¾å‡ºæ‰€|ç›‘ç‹±/,'ğŸš“'],[/èŒå‘˜å®¤|æ•™å¸ˆå®¤|æ•™åŠ¡å¤„/,'ğŸ—„ï¸'],[/ç©ºé—´ç«™|å®‡å®™é£èˆ¹/,'ğŸš€'],[/é›ªå±±|å†°åŸ|å†»åœŸ/,'â„ï¸'],[/ç«å±±|ç†”å²©/,'ğŸŒ‹'],[/æ²™æ¼ |è’æ¼ /,'ğŸŒµ'],[/æµ·æ²Ÿ/,'ğŸŒŠ'],[/çŠç‘š/,'ğŸª¸'],[/æ²¼æ³½|æ³¥æ½­/,'ğŸŠ'],[/ç‹åº§|å¤§æ®¿/,'ğŸ‘‘'],[/é©¿ç«™|é©¿é¦†/,'ğŸ'],[/å¿è¡™|åºœè¡™/,'âš–ï¸'],[/å¤§å†…/,'ğŸ¯'],[/å¢“åœ°|åŸåœº|ä¹±è‘¬å²—/,'ğŸª¦'],[/åœ°ç‰¢|åœ°ä¸‹åŸ/,'ğŸ•¸ï¸'],[/ç«æŠ€åœº|å†³æ–—åœº/,'âš”ï¸'],[/ä»™å±±|çµå±±/,'â›°ï¸'],[/çµè„‰|é¾™è„‰/,'ğŸ‰'],[/ä¸¹è¯|ä»™ä¸¹/,'ğŸ’Š'],[/æ³•å®|ä»™å™¨/,'âš—ï¸'],[/é˜µæ³•|æ³•é˜µ/,'ğŸ”¯'],[/æ´åºœ|ä»™åºœ/,'ğŸ”ï¸'],[/æ¸¡åŠ«|å¤©åŠ«/,'âš¡'],[/æ±Ÿæ¹–|æ­¦æ—/,'ğŸ—¡ï¸'],[/å‰‘å†¢|å…µå™¨è°±/,'âš”ï¸'],[/é­”æ³•é˜µ|å¬å”¤é˜µ/,'ğŸ”®'],[/ç‚¼é‡‘æœ¯|ç‚¼é‡‘/,'âš—ï¸'],[/é­”æ–|æ³•æ–/,'ğŸª„'],[/é­”æ³•ä¹¦|å’’è¯­ä¹¦/,'ğŸ“–'],[/è§¦æ‰‹|è§¦é¡»/,'ğŸ™'],[/ç¦ä¹¦|ç§˜å…¸/,'ğŸ“•'],[/é‚ªæ•™|æ•™å›¢/,'ğŸ•¯ï¸'],[/å¤ç¥|æ—§ç¥|å¤–ç¥/,'ğŸ‘ï¸'],[/ä¹‰ä½“/,'ğŸ¦¾'],[/å…¨æ¯/,'ğŸ“½ï¸'],[/æ•°æ®ä¸­å¿ƒ|æœºæˆ¿/,'ğŸ–¥ï¸'],[/èŠ¯ç‰‡|æ™¶ç‰‡/,'ğŸ’¾'],[/SCP|æ”¶å®¹|å•å…ƒ/,'ğŸ›¡ï¸'],[/é£è‰‡/,'ğŸˆ'],[/é½¿è½®/,'âš™ï¸'],[/è’¸æ±½æœº|é”…ç‚‰/,'âš—ï¸'],[/é’Ÿæ¥¼/,'ğŸ•°ï¸'],[/åºŸåœŸ/,'ğŸœï¸'],[/è¾å°„/,'â˜¢ï¸'],[/é¿éš¾æ‰€/,'ğŸšï¸'],[/æ‹¾è’/,'â™»ï¸'],[/å˜å¼‚|å˜ç§/,'ğŸ§Ÿ'],[/æ˜Ÿèˆ°|æˆ˜èˆ°/,'ğŸš€'],[/å¤ªç©ºæ¸¯/,'ğŸ›°ï¸'],[/è™«æ´|è·ƒè¿/,'ğŸŒ€'],[/å¤–æ˜Ÿäºº/,'ğŸ‘½'],[/é•œåƒä¸–ç•Œ/,'ğŸª'],[/é˜´é˜³ç•Œ|å½¼å²¸/,'âš–ï¸'],[/é»„æ³‰|å†¥ç•Œ/,'ğŸ’€'],[/æ‹›é­‚|é™çµ/,'ğŸ•¯ï¸'],[/è‹”åŸ|å†»åŸ/,'ğŸ§Š'],[/é›¨æ—|çƒ­å¸¦/,'ğŸŒ´'],[/ç«¹æ—/,'ğŸ‹'],[/ç¨€æ ‘è‰åŸ/,'ğŸ¦'],[/è†æ£˜/,'ğŸŒµ'],[/èŠ±æµ·/,'ğŸŒ¸'],[/æµ®ç©ºå²›|å¤©ç©ºå²›/,'â˜ï¸'],[/åœ°å¿ƒ|åœ°æ ¸/,'ğŸ”¥'],[/èŒç±»|è˜‘è‡æ—/,'ğŸ„'],[/æš´é£é›ª/,'â„ï¸'],[/æ²™å°˜æš´/,'ğŸŒªï¸'],[/é¾™å·é£/,'ğŸŒªï¸'],[/æµæ˜Ÿé›¨/,'â˜„ï¸'],[/æ—¥é£Ÿ|æœˆé£Ÿ/,'ğŸŒ‘'],[/é…¸é›¨|æ¯’é›¨/,'â˜”'],[/æå…‰|æ˜Ÿç©º/,'ğŸŒŒ'],[/é”»é€ å°|ç†”ç‚‰/,'ğŸ”¨'],[/é™„é­”å°/,'âœ¨'],[/å·¥ä½œå°/,'ğŸªš'],[/ç‚¼è¯å°/,'âš—ï¸'],[/é…¿é€ å°/,'ğŸº'],[/çººç»‡æœº/,'ğŸ§µ'],[/é©¬å©|å…½æ /,'ğŸ´'],[/ç«å…ƒç´ |çƒˆç„°/,'ğŸ”¥'],[/æ°´å…ƒç´ |å¯’å†°/,'ğŸ’§'],[/é£å…ƒç´ |ç–¾é£/,'ğŸ’¨'],[/åœŸå…ƒç´ /,'ğŸª¨'],[/é›·å…ƒç´ /,'âš¡'],[/å…‰å…ƒç´ |åœ£å…‰/,'âœ¨'],[/æš—å…ƒç´ |æš—å½±/,'ğŸŒ‘'],[/æ—¶ç©º/,'â°'],[/æ¨±èŠ±/,'ğŸŒ¸'],[/æ«æ ‘|çº¢æ«/,'ğŸ'],[/è·èŠ±|è²èŠ±/,'ğŸª·'],[/ç«ç‘°/,'ğŸŒ¹'],[/å‘æ—¥è‘µ/,'ğŸŒ»'],[/è´è¶/,'ğŸ¦‹'],[/èœœèœ‚/,'ğŸ'],[/è™è /,'ğŸ¦‡'],[/ä¹Œé¸¦|æ¸¡é¸¦/,'ğŸ¦â€â¬›'],[/å‡¤å‡°|ç«é¸Ÿ/,'ğŸ”¥'],[/ç™½é¸½/,'ğŸ•Šï¸'],[/çŒ«/,'ğŸ±'],[/å…”å­/,'ğŸ°'],[/BOSS|é¦–é¢†|é­”ç‹/,'ğŸ²'],[/äº¡çµ|ä¸§å°¸|åƒµå°¸|éª·é«…/,'ğŸ’€'],[/é‡å…½/,'ğŸº'],[/å²è±å§†|è½¯æ³¥/,'ğŸ’§'],[/æ¶é­”/,'ğŸ‘¹'],[/æœºå™¨äºº|æœºç”²/,'ğŸ¤–'],[/é‡‘å¸|é’±è¢‹/,'ğŸ’°'],[/å®çŸ³|é’»çŸ³/,'ğŸ’'],[/æ°´æ™¶/,'ğŸ’'],[/è¯æ°´|è¯å‰‚/,'ğŸ§ª'],[/é’¥åŒ™|é—¨å¡/,'ğŸ”‘'],[/åœ°å›¾/,'ğŸ—ºï¸'],[/å®ç®±/,'ğŸ'],[/è¡€è¿¹|è¡€æ³Š/,'ğŸ©¸'],[/è„šå°/,'ğŸ‘£'],[/å°¸ä½“|æ®‹éª¸/,'â˜ ï¸'],[/è¿·é›¾/,'ğŸŒ«ï¸'],[/ç‡ƒçƒ§|ç€ç«/,'ğŸ”¥'],[/å†°å†»|ç»“å†°/,'ğŸ§Š'],[/ä¸­æ¯’/,'ğŸ¤¢'],[/æµè¡€|å‡ºè¡€/,'ğŸ©¸'],[/çœ©æ™•|æ˜è¿·/,'ğŸ’«'],[/æ²‰é»˜/,'ğŸ¤'],[/è™šå¼±|è¡°å¼±/,'ğŸ˜µâ€ğŸ’«'],[/ç‹‚æš´|ç‹‚æ€’/,'ğŸ˜¡'],[/éšèº«|æ½œè¡Œ/,'ğŸ‘»'],[/æ¸©é¦¨|æ¸©æš–/,'ğŸ¤—'],[/ææ€–|æƒŠæ‚š/,'ğŸ˜±'],[/æµªæ¼«|ç”œèœœ/,'ğŸ’•'],[/ç´§å¼ |å‹è¿«/,'ğŸ˜°'],[/å¹³å’Œ|å®é™/,'ğŸ˜Œ'],[/æ¿€çƒˆ|çƒ­è¡€/,'ğŸ’ª'],[/æ‚²ä¼¤|å“€æ„/,'ğŸ˜¢'],[/æ¬¢ä¹|å–œåº†/,'ğŸ‰'],[/å­¤ç‹¬|å¯‚å¯¥/,'ğŸ¥€'],[/ç¥åƒ/,'ğŸ’¾'],[/æ¥¼æ¢¯|æ¢¯å­/,'ğŸªœ'],[/æ¤…å­|æ²™å‘/,'ğŸª‘'],[/åºŠ|é“º/,'ğŸ›ï¸'],[/æ¡Œå­|å°å­/,'ğŸªµ'],[/æ˜¾ç¤ºå™¨|æ˜¾ç¤ºå±|ç”µè„‘|æœåŠ¡å™¨|ç»ˆç«¯|é¢æ¿|æ•°æ®/,'ğŸ–¥ï¸'],[/æ‘„åƒ/,'ğŸ“¹'],[/ä¿¡å·/,'ğŸ“¡'],[/çª—æˆ·|çª—/,'ğŸªŸ'],[/ç”µæ¢¯/,'ğŸ›—'],[/æœºå…³|è£…ç½®/,'âš™ï¸'],[/é”|å°å°/,'ğŸ”’'],[/é—¨|å¤§é—¨|å…¥å£|å‡ºå£/,'ğŸšª'],[/è¡—é“|è¡—è§’|é©¬è·¯/,'ğŸš¶'],[/æ¡¥|æ¡¥æ¢/,'ğŸŒ‰'],[/å¹¿åœº/,'â›²'],[/è¾¹å¢ƒ/,'ğŸš©'],[/èµ°å»Š|è¿‡é“|ç„å…³|é€šé“/,'ğŸ‘£'],[/å®¿èˆ|å¯å®¤/,'ğŸ¢'],[/æˆ¿é—´|å§å®¤/,'ğŸ›Œ'],[/åº­é™¢|é™¢å­/,'ğŸŒ¿'],[/é—¨å»Š/,'ğŸšª'],[/å•†ä¸šè¡—/,'ğŸ›ï¸'],[/å•†åŸ|è´­ç‰©ä¸­å¿ƒ/,'ğŸ¬'],[/æ—…é¦†|å®¢æ ˆ|é…’åº—/,'ğŸ¨'],[/ä¾¿åˆ©åº—|è¶…å¸‚|å•†åº—/,'ğŸª'],[/é¤å…|é¥­åº—|é£Ÿå ‚/,'ğŸ½ï¸'],[/å’–å•¡|èŒ¶å®¤/,'â˜•'],[/é…’å§|å¤œåº—/,'ğŸ·'],[/æ¼”å”±ä¼š|æ¼”å‡º/,'ğŸ¸'],[/ä»“åº“|å‚¨è—/,'ğŸ“¦'],[/åŒ»é™¢|è¯Šæ‰€/,'ğŸ¥'],[/é“¶è¡Œ|é‡‘åº“/,'ğŸ¦'],[/åŠå…¬|å†™å­—æ¥¼|å…¬å¸/,'ğŸ’¼'],[/æµ·æ»©|æµ·è¾¹|æµ·å²¸/,'ğŸ–ï¸'],[/æµ·æ´‹|æ·±æµ·/,'ğŸŒŠ'],[/ç€‘å¸ƒ|æ²³æµ|æºªæµ/,'ğŸ’§'],[/æ´ç©´|å±±æ´/,'ğŸ•³ï¸'],[/æ£®æ—|æ ‘æ—|ä¸›æ—/,'ğŸŒ²'],[/è‰åŸ|å¹³åŸ|è‰åœ°/,'ğŸŒ¾'],[/å±±è„‰|æ‚¬å´–|å±±é¡¶/,'â›°ï¸'],[/å…¬å›­|èŠ±å›­/,'ğŸŒ³'],[/ç‹å®«|çš‡å®«/,'ğŸ‘‘'],[/å®«æ®¿/,'ğŸ›ï¸'],[/åŸå ¡|è¦å¡/,'ğŸ°'],[/æ•™å ‚|ä¿®é“é™¢/,'â›ª'],[/ç¥ç¤¾|ç¥æ®¿|å¯ºåº™|åœ£æ®¿/,'â›©ï¸'],[/é—è¿¹|åºŸå¢Ÿ/,'ğŸ›ï¸'],[/è¿·å®«/,'ğŸ•¸ï¸'],[/å¡”|é«˜å¡”|ç¯å¡”/,'ğŸ—¼'],[/å…¬ä¼š/,'ğŸ›¡ï¸'],[/é­”æ³•|æ³•å¸ˆ/,'ğŸ§™â€â™‚ï¸'],[/æ•™å­¦æ¥¼|æ•™å®¤/,'ğŸ«'],[/å›¾ä¹¦é¦†/,'ğŸ“š'],[/æœåŠ¡å°|æ¥å¾…å°/,'ğŸ›ï¸'],[/ä½“è‚²é¦†|æ“åœº|è®­ç»ƒåœº/,'ğŸŸï¸'],[/åšç‰©é¦†|å±•è§ˆ|ç¤¼å ‚/,'ğŸ›ï¸'],[/å­¦é™¢|å­¦æ ¡|å­¦å›­|å°å­¦/,'ğŸ«'],[/å•†äºº|åº—ä¸»/,'ğŸ’°'],[/å®ˆå«|å£«å…µ|éª‘å£«/,'ğŸ›¡ï¸'],[/é¾™å¥—|è·¯äºº|æ‘æ°‘/,'ğŸ‘¥'],[/ç²®ä»“|ç²®é£Ÿ|è°·ç‰©/,'ğŸŒ¾'],[/æ­¦å™¨|å‰‘|åˆ€|æª/,'âš”ï¸'],[/é˜²å…·|ç›¾|ç›”ç”²/,'ğŸ‘•'],[/é£Ÿç‰©|æ–™ç†/,'ğŸ–'],[/ä¹¦ä¿¡|çº¸æ¡|ç¬”è®°|çº¸/,'ğŸ“„'],[/é“/,'â›“ï¸'],[/è›‹ç³•|ç”œç‚¹|ç‚¹å¿ƒ|æœå­/,'ğŸ°'],[/é…’/,'ğŸ·'],[/é±¼/,'ğŸŸ'],[/é¥¼/,'ğŸ«“'],[/é¢åŒ…/,'ğŸ'],[/èŒ¶/,'ğŸµ'],[/ç…§ç‰‡/,'ğŸ“·'],[/ç©å¶|æ¯›ç»’|ç©å…·/,'ğŸ§¸'],[/æ‰‹æœº/,'ğŸ“±'],[/åŒ…è£…/,'ğŸ'],[/æ‰‹å†Œ|æŒ‡å—/,'ğŸ“’'],[/ä»»åŠ¡/,'ğŸ“‹'],[/ç¾Šçš®/,'ğŸ“œ'],[/è¡Œæ|ç®±åŒ…/,'ğŸ§³'],[/ç‰©å“|é“å…·/,'ğŸ’'],[/å…‰|å…‰æº|ç¯/,'ğŸ’¡'],[/ç—•è¿¹|è¸ªè¿¹/,'ğŸ‘£'],[/çƒŸé›¾|æ¯’æ°”/,'ğŸŒ«ï¸'],[/æŠ¤ç›¾|åŠ›åœº/,'ğŸ›¡ï¸'],[/åŠ é€Ÿ/,'ğŸ’¨'],[/å†ç”Ÿ|æ¢å¤/,'ğŸ’š'],[/å¼‚ç•Œ|è™šç©º|ä¼ é€/,'ğŸŒ€'],[/ç¥ç§˜|è¯¡å¼‚/,'ğŸŒ€'],[/åŸå¸‚|åŸé•‡|æ‘åº„|ç¤¾åŒº/,'ğŸ˜ï¸'],[/å…¬å¯“|ä½æ‰€|å®¶|ä½å®…|åˆ«å¢…|åˆå®¿/,'ğŸ '],[/é˜æ¥¼|é¡¶å±‚/,'ğŸ '],[/å¿ƒç†|è„‘/,'ğŸ§ '],[/ç”Ÿç‰©|åŸºå› /,'ğŸ§¬'],[/æ£€æµ‹|è°ƒæŸ¥/,'ğŸ”'],[/èˆè¹ˆ/,'ğŸ’ƒ'],[/ç¯å¢ƒ|çŸ³å¤´|å²©çŸ³|æœ¨|é‡‘å±|éšœç¢/,'ğŸª¨']],e=t,a=t,n={retro:{bgNav:'#e6e2d3',bgPanel:'#e6e2d3',border:'#dcd0c0',textMain:'#5e4b35',textSub:'#999',btnBg:'#dcd0c0',btnHover:'#cbbba8',btnActiveBg:'#8d7b6f',btnActiveText:'#fdfaf5',accent:'#7a695f',inputBg:'#f5f2eb'},dark:{bgNav:'#2b2b2b',bgPanel:'#252525',border:'#444',textMain:'#eee',textSub:'#aaa',btnBg:'#3a3a3a',btnHover:'#4a4a4a',btnActiveBg:'#6a5acd',btnActiveText:'#fff',accent:'#9b8cd9',inputBg:'#3a3a3a'},modern:{bgNav:'#ffffff',bgPanel:'#f8f9fa',border:'#e0e0e0',textMain:'#333',textSub:'#666',btnBg:'#f1f3f5',btnHover:'#e9ecef',btnActiveBg:'#007bff',btnActiveText:'#fff',accent:'#007bff',inputBg:'#f1f3f5'},forest:{bgNav:'#e8f5e9',bgPanel:'#e8f5e9',border:'#c8e6c9',textMain:'#2e7d32',textSub:'#81c784',btnBg:'#c8e6c9',btnHover:'#a5d6a7',btnActiveBg:'#43a047',btnActiveText:'#fff',accent:'#4caf50',inputBg:'#c8e6c9'},ocean:{bgNav:'#e3f2fd',bgPanel:'#e3f2fd',border:'#90caf9',textMain:'#1565c0',textSub:'#64b5f6',btnBg:'#bbdefb',btnHover:'#90caf9',btnActiveBg:'#1976d2',btnActiveText:'#fff',accent:'#2196f3',inputBg:'#bbdefb'},cyber:{bgNav:'#000000',bgPanel:'#0a0a0a',border:'#333',textMain:'#00ffcc',textSub:'#ff00ff',btnBg:'#111',btnHover:'#222',btnActiveBg:'#ff00ff',btnActiveText:'#000',accent:'#00ffcc',inputBg:'#111'},nightowl:{bgNav:'#0a2133',bgPanel:'#011627',border:'#132e45',textMain:'#e0e6f2',textSub:'#a6b8cc',btnBg:'#1f3a52',btnHover:'#2a4a68',btnActiveBg:'#7fdbca',btnActiveText:'#011627',accent:'#7fdbca',inputBg:'#1f3a52'},sakura:{bgNav:'#F9F0EF',bgPanel:'#F9F0EF',border:'#EBDCD9',textMain:'#6B5552',textSub:'#C08D8D',btnBg:'#EBDCD9',btnHover:'#D8C7C4',btnActiveBg:'#C08D8D',btnActiveText:'#F9F0EF',accent:'#C08D8D',inputBg:'#EBDCD9'},minepink:{bgNav:'#1a1a1a',bgPanel:'#1a1a1a',border:'#333333',textMain:'#ffb3d9',textSub:'#ff80c1',btnBg:'#2a2a2a',btnHover:'#3a3a3a',btnActiveBg:'#ff80c1',btnActiveText:'#1a1a1a',accent:'#ff80c1',inputBg:'#2a2a2a'},purple:{bgNav:'#f3e5f5',bgPanel:'#f3e5f5',border:'#ce93d8',textMain:'#6a1b9a',textSub:'#9c27b0',btnBg:'#e1bee7',btnHover:'#ce93d8',btnActiveBg:'#9c27b0',btnActiveText:'#fff',accent:'#9c27b0',inputBg:'#e1bee7'},wechat:{bgNav:'#F7F7F7',bgPanel:'#F7F7F7',border:'#E5E5E5',textMain:'#333333',textSub:'#666666',btnBg:'#E5E5E5',btnHover:'#D5D5D5',btnActiveBg:'#09B83E',btnActiveText:'#FFFFFF',accent:'#09B83E',inputBg:'#E5E5E5'},educational:{bgNav:'#000000',bgPanel:'#000000',border:'#1B1B1B',textMain:'#FFFFFF',textSub:'#CCCCCC',btnBg:'#1B1B1B',btnHover:'#2B2B2B',btnActiveBg:'#FF9900',btnActiveText:'#000000',accent:'#FF9900',inputBg:'#1B1B1B'},vaporwave:{bgNav:'#191970',bgPanel:'#191970',border:'rgba(0,255,255,0.3)',textMain:'#00FFFF',textSub:'#FF00FF',btnBg:'rgba(25,25,112,0.8)',btnHover:'rgba(0,255,255,0.2)',btnActiveBg:'#FF00FF',btnActiveText:'#191970',accent:'#00FFFF',inputBg:'rgba(25,25,112,0.6)'},classicpackaging:{bgNav:'#000000',bgPanel:'#000000',border:'#FFFF00',textMain:'#FFFF00',textSub:'#CCCC00',btnBg:'#FF0000',btnHover:'#CC0000',btnActiveBg:'#0000FF',btnActiveText:'#FFFF00',accent:'#FF0000',inputBg:'#1a1a1a'},galgame:{bgNav:'#FFF0F5',bgPanel:'#FFF0F5',border:'#F0D4E4',textMain:'#6B4A5A',textSub:'#B08A9A',btnBg:'#FFE4E9',btnHover:'#FFD4E4',btnActiveBg:'#E8B4D9',btnActiveText:'#6B4A5A',accent:'#E8B4D9',inputBg:'#FFF8FA'},terminal:{bgNav:'#0c0c0c',bgPanel:'#0c0c0c',border:'#00ff00',textMain:'#00ff00',textSub:'#00cc00',btnBg:'#1a1a1a',btnHover:'#2a2a2a',btnActiveBg:'#00ff00',btnActiveText:'#0c0c0c',accent:'#00ff00',inputBg:'#0c0c0c'},dreamcore:{bgNav:'#F4F1EA',bgPanel:'#F4F1EA',border:'#D6D2C4',textMain:'#5C5869',textSub:'#9490A0',btnBg:'#E6E1D5',btnHover:'#DBD8CC',btnActiveBg:'#8A9AC6',btnActiveText:'#FFFFFF',accent:'#8A9AC6',inputBg:'#FFFFFF'},aurora:{bgNav:'linear-gradient(135deg,#0f172a,#1e293b)',bgPanel:'linear-gradient(180deg,#0f172a 0%,#334155 100%)',border:'#38bdf8',textMain:'#e2e8f0',textSub:'#94a3b8',btnBg:'linear-gradient(135deg,#162a3d,#25224d)',btnHover:'linear-gradient(135deg,#1e3a5f,#312e81)',btnActiveBg:'linear-gradient(135deg,#38bdf8,#a855f7)',btnActiveText:'#fff',accent:'#38bdf8',inputBg:'#0f172a'},chouten:{bgNav:'linear-gradient(135deg,rgba(26,10,46,0.95) 0%,rgba(45,27,78,0.95) 50%,rgba(26,10,46,0.95) 100%)',bgPanel:'rgba(26,10,46,0.95)',border:'#FF7EB6',textMain:'#FFFFFF',textSub:'#D0BFFF',btnBg:'rgba(255,255,255,0.1)',btnHover:'rgba(255,107,157,0.3)',btnActiveBg:'linear-gradient(90deg,#FF6B9D,#B388FF)',btnActiveText:'#FFFFFF',accent:'#7FFFD4',inputBg:'rgba(0,0,0,0.3)'}};function o(t,e){try{const a=t=>{try{return t?.jQuery}catch{return null}},o=[a(window),a(window.parent),a(window.top)].filter((t,e,a)=>!!t&&a.indexOf(t)===e);if(!o.length)return;const i=n[t]||n.aurora,r=new Set(['cyber','terminal','aurora','chouten','classicpackaging']).has(t),c=r?'invert(1) brightness(1.05)':'none',s=r?'0.85':'0.55',l=r?'dark':'light',u=`\n      <style id="dice-db-theme-sync">\n        ${e?`\n        /* å­—ä½“åŒæ­¥ï¼šè¦†ç›–æ•°æ®åº“æ–‡æœ¬å­—ä½“ï¼ˆé¿å…å½±å“å›¾æ ‡å­—ä½“ / pseudo-element å›¾æ ‡ï¼‰ */\n        html body .auto-card-updater-popup,\n        html body #shujuku_v104-main-window,\n        html body [id^="shujuku"][id$="-main-window"],\n        html body #shujuku_v104-popup.auto-card-updater-popup,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup {\n          --acu-font-family: ${e};\n          font-family: var(--acu-font-family) !important;\n        }\n\n        html body .auto-card-updater-popup :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body #shujuku_v104-main-window :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body [id^="shujuku"][id$="-main-window"] :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body #shujuku_v104-popup.auto-card-updater-popup :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em),\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup :is(div, p, span, label, a, button:not(.acu-window-btn), input, select, textarea, th, td, li, ul, ol, h1, h2, h3, h4, h5, h6, small, strong, em) {\n          font-family: var(--acu-font-family) !important;\n        }\n      `:''}\n        html body .auto-card-updater-popup {\n          --acu-bg-0: ${i.bgPanel} !important;\n          --acu-bg-1: ${i.bgNav} !important;\n          --acu-bg-2: ${i.btnBg} !important;\n          --acu-border: ${i.border} !important;\n          --acu-border-2: ${i.border} !important;\n          --acu-text-1: ${i.textMain} !important;\n          --acu-text-2: ${i.textSub} !important;\n          --acu-text-3: ${i.textSub} !important;\n          --acu-accent: ${i.accent} !important;\n          --acu-accent-glow: ${i.accent}1a !important;\n        }\n        html body .auto-card-updater-popup button,\n        html body .auto-card-updater-popup .button {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n        html body .auto-card-updater-popup button:hover,\n        html body .auto-card-updater-popup .button:hover {\n          background: ${i.btnHover} !important;\n        }\n        html body .auto-card-updater-popup button.primary,\n        html body .auto-card-updater-popup .button.primary {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .button-group.acu-data-mgmt-buttons button,\n        html body #shujuku_v104-popup.auto-card-updater-popup .button-group.acu-data-mgmt-buttons .button,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .button-group.acu-data-mgmt-buttons button,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .button-group.acu-data-mgmt-buttons .button {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .button-group.acu-data-mgmt-buttons button:hover,\n        html body #shujuku_v104-popup.auto-card-updater-popup .button-group.acu-data-mgmt-buttons .button:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .button-group.acu-data-mgmt-buttons button:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .button-group.acu-data-mgmt-buttons .button:hover {\n          background: ${i.btnHover} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup code,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup code {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-left: 2px solid ${i.accent} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup table thead th,\n        html body #shujuku_v104-popup.auto-card-updater-popup table th,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table thead th,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table th {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border-color: ${i.border} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-window-header,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-window-header,\n        html body #shujuku_v104-main-window .acu-window-header,\n        html body [id^="shujuku"][id$="-main-window"] .acu-window-header {\n          background: ${i.bgNav} !important;\n          border-bottom: 1px solid ${i.border} !important;\n          color: ${i.textMain} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-window-title,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-window-title,\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-window-title span,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-window-title span,\n        html body #shujuku_v104-main-window .acu-window-title,\n        html body [id^="shujuku"][id$="-main-window"] .acu-window-title,\n        html body #shujuku_v104-main-window .acu-window-title span,\n        html body [id^="shujuku"][id$="-main-window"] .acu-window-title span {\n          color: ${i.textMain} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-window-title i,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-window-title i,\n        html body #shujuku_v104-main-window .acu-window-title i,\n        html body [id^="shujuku"][id$="-main-window"] .acu-window-title i {\n          color: ${i.accent} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-window-btn,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-window-btn,\n        html body #shujuku_v104-main-window .acu-window-btn,\n        html body [id^="shujuku"][id$="-main-window"] .acu-window-btn {\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-window-btn:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-window-btn:hover,\n        html body #shujuku_v104-main-window .acu-window-btn:hover,\n        html body [id^="shujuku"][id$="-main-window"] .acu-window-btn:hover {\n          background: ${i.btnHover} !important;\n          color: ${i.textMain} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-window-btn.close:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-window-btn.close:hover,\n        html body #shujuku_v104-main-window .acu-window-btn.close:hover,\n        html body [id^="shujuku"][id$="-main-window"] .acu-window-btn.close:hover {\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-stepper,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-stepper {\n          background-color: ${i.inputBg} !important;\n          border-color: ${i.border} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-stepper-btn,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-stepper-btn {\n          background-color: ${i.btnBg} !important;\n          color: ${i.textSub} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-stepper-btn:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-stepper-btn:hover {\n          background-color: ${i.btnHover} !important;\n          color: ${i.accent} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-stepper-btn:active,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-stepper-btn:active {\n          background-color: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-stepper-value,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-stepper-value {\n          background-color: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border-left: 1px solid ${i.border} !important;\n          border-right: 1px solid ${i.border} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup input[type="number"],\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="number"] {\n          color-scheme: ${l} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup input[type="number"]::-webkit-inner-spin-button,\n        html body #shujuku_v104-popup.auto-card-updater-popup input[type="number"]::-webkit-outer-spin-button,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="number"]::-webkit-inner-spin-button,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="number"]::-webkit-outer-spin-button {\n          filter: ${c} !important;\n          opacity: ${s} !important;\n        }\n        html body .auto-card-updater-popup input,\n        html body .auto-card-updater-popup select,\n        html body .auto-card-updater-popup textarea,\n        html body #shujuku_v104-popup input,\n        html body #shujuku_v104-popup select,\n        html body #shujuku_v104-popup textarea,\n        html body div[id^="shujuku"][id$="-popup"] input,\n        html body div[id^="shujuku"][id$="-popup"] select,\n        html body div[id^="shujuku"][id$="-popup"] textarea {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          background-image: none !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-color: ${i.border} !important;\n          box-shadow: none !important;\n          text-shadow: none !important;\n        }\n\n        /* ä¿®å¤ placeholder é¢œè‰² */\n        html body .auto-card-updater-popup input::placeholder,\n        html body .auto-card-updater-popup textarea::placeholder,\n        [id^="shujuku"][id$="-popup"] input::placeholder,\n        [id^="shujuku"][id$="-popup"] textarea::placeholder {\n          color: ${i.textSub} !important;\n          opacity: 0.7;\n        }\n\n        /* ========== Checkbox å¼ºåŒ–è¦†ç›– ========== */\n        /* Checkbox Container (Group) */\n        html body #shujuku_v104-popup.auto-card-updater-popup .checkbox-group,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .checkbox-group {\n          background-color: transparent !important; /* é¿å…å®¹å™¨äº§ç”Ÿä¸å¿…è¦çš„èƒŒæ™¯ */\n          color: ${i.textMain} !important;\n        }\n        \n        /* Checkbox Label */\n        html body #shujuku_v104-popup.auto-card-updater-popup .checkbox-group label,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .checkbox-group label {\n          color: ${i.textMain} !important;\n        }\n\n        /* Checkbox Input Element (ç»Ÿä¸€è‡ªç»˜ï¼Œå‹åˆ¶é…’é¦†ä¸»é¢˜/è„šæœ¬è‡ªç»˜) */\n        html body #shujuku_v104-popup.auto-card-updater-popup input[type="checkbox"],\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="checkbox"],\n        html body #shujuku_v104-popup.auto-card-updater-popup .checkbox-group input[type="checkbox"],\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .checkbox-group input[type="checkbox"] {\n          -webkit-appearance: none !important;\n          appearance: none !important;\n          width: 16px !important;\n          height: 16px !important;\n          min-width: 16px !important;\n          min-height: 16px !important;\n          border-radius: 4px !important;\n          border: 1px solid ${i.border} !important;\n          background-color: ${i.inputBg} !important;\n          background-image: none !important;\n          background-repeat: no-repeat !important;\n          background-position: center !important;\n          background-size: 12px 10px !important;\n          box-shadow: none !important;\n          padding: 0 !important;\n          margin: 2px 8px 2px 0 !important;\n          cursor: pointer !important;\n          vertical-align: middle !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup input[type="checkbox"]::before,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="checkbox"]::before,\n        html body #shujuku_v104-popup.auto-card-updater-popup input[type="checkbox"]::after,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="checkbox"]::after {\n          content: none !important;\n          display: none !important;\n        }\n\n        /* Checked State */\n        html body #shujuku_v104-popup.auto-card-updater-popup input[type="checkbox"]:checked,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="checkbox"]:checked {\n          background-color: ${i.accent} !important;\n          border-color: ${i.accent} !important;\n          background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 10'%3E%3Cpath fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' d='M1 5l3 3 7-7'/%3E%3C/svg%3E") !important;\n        }\n        html body .auto-card-updater-popup th,\n        html body .auto-card-updater-popup thead th {\n          color: ${i.textMain} !important;\n          background-color: ${i.btnActiveBg} !important;\n        }\n        /* ========== Status & Messages Display çŠ¶æ€ä¸æ¶ˆæ¯æ˜¾ç¤º (è‡ªç»˜å¼ºåŒ–) ========== */\n        html body .auto-card-updater-popup span[id$="-status-display"],\n        html body .auto-card-updater-popup span[id$="-messages-display"],\n        html body .auto-card-updater-popup p.notes,\n        html body div[id$="-popup"] span[id$="-status-display"],\n        html body div[id$="-popup"] span[id$="-messages-display"],\n        html body div[id$="-popup"] p.notes,\n        html body span[id$="-card-update-status-display"],\n        html body span[id$="-total-messages-display"],\n        html body [id$="-status-message"] {\n          display: block !important;\n          background-color: var(--acu-bg-2) !important;\n          color: var(--acu-text-1) !important;\n          border: 1px solid var(--acu-border) !important;\n          border-radius: 6px !important;\n          padding: 8px 12px !important;\n          margin: 8px 0 !important;\n          font-size: 13px !important;\n          line-height: 1.4 !important;\n          box-shadow: inset 0 0 10px rgba(0,0,0,0.05) !important;\n          word-break: break-all !important;\n        }\n        html body .auto-card-updater-popup span[id$="-status-display"] b,\n        html body div[id$="-popup"] span[id$="-status-display"] b,\n        html body span[id$="-card-update-status-display"] b {\n          color: var(--acu-accent) !important;\n          font-weight: bold !important;\n        }\n        html body .auto-card-updater-popup span[id$="-status-display"] *:not(b):not([style*="color"]),\n        html body div[id$="-popup"] span[id$="-status-display"] *:not(b):not([style*="color"]),\n        html body span[id$="-card-update-status-display"] *:not(b):not([style*="color"]) {\n          color: inherit !important;\n        }\n        html body .auto-card-updater-popup table tbody tr,\n        html body .auto-card-updater-popup table tbody tr:nth-child(odd),\n        html body .auto-card-updater-popup table tbody tr:nth-child(even) {\n          background-color: ${i.bgPanel} !important;\n        }\n        html body .auto-card-updater-popup table tbody tr:hover {\n          background-color: ${i.btnHover} !important;\n        }\n        html body .auto-card-updater-popup table tbody td {\n          color: ${i.textMain} !important;\n        }\n\n        /* ========== Table Layout & Column Alignment è¡¨æ ¼å¸ƒå±€ä¸åˆ—å¯¹é½ ========== */\n        html body .auto-card-updater-popup table,\n        html body #shujuku_v104-popup.auto-card-updater-popup table,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table {\n          table-layout: fixed !important;\n          width: 100% !important;\n          border-collapse: collapse !important;\n          max-width: 100% !important;\n          overflow: hidden !important;\n          /* ä¿®å¤å³ä¾§ç©ºç™½ï¼šç¡®ä¿è¡¨æ ¼å¡«æ»¡å®¹å™¨ */\n          box-sizing: border-box !important;\n        }\n\n        html body .auto-card-updater-popup table thead,\n        html body .auto-card-updater-popup table tbody,\n        html body .auto-card-updater-popup table tr,\n        html body #shujuku_v104-popup.auto-card-updater-popup table thead,\n        html body #shujuku_v104-popup.auto-card-updater-popup table tbody,\n        html body #shujuku_v104-popup.auto-card-updater-popup table tr,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table thead,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table tbody,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table tr {\n          width: 100% !important;\n          box-sizing: border-box !important;\n        }\n\n        html body .auto-card-updater-popup table th,\n        html body .auto-card-updater-popup table td,\n        html body #shujuku_v104-popup.auto-card-updater-popup table th,\n        html body #shujuku_v104-popup.auto-card-updater-popup table td,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table th,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table td {\n          text-align: left !important;\n          padding: 5px 8px !important;\n          border: 1px solid ${i.border} !important;\n          overflow: hidden !important;\n          text-overflow: ellipsis !important;\n          white-space: nowrap !important;\n          box-sizing: border-box !important;\n        }\n\n        /* ç¬¬ä¸€åˆ—ï¼ˆåç§°åˆ—ï¼‰å·¦å¯¹é½ï¼Œè‡ªé€‚åº”å®½åº¦ */\n        html body .auto-card-updater-popup table th:first-child,\n        html body .auto-card-updater-popup table td:first-child,\n        html body #shujuku_v104-popup.auto-card-updater-popup table th:first-child,\n        html body #shujuku_v104-popup.auto-card-updater-popup table td:first-child,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table th:first-child,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table td:first-child {\n          text-align: left !important;\n          width: 25% !important;\n        }\n\n        /* ä¸­é—´åˆ—å±…ä¸­å¯¹é½ï¼Œå‡åˆ†å‰©ä½™å®½åº¦ */\n        html body .auto-card-updater-popup table th:not(:first-child):not(:last-child),\n        html body .auto-card-updater-popup table td:not(:first-child):not(:last-child),\n        html body #shujuku_v104-popup.auto-card-updater-popup table th:not(:first-child):not(:last-child),\n        html body #shujuku_v104-popup.auto-card-updater-popup table td:not(:first-child):not(:last-child),\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table th:not(:first-child):not(:last-child),\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table td:not(:first-child):not(:last-child) {\n          text-align: center !important;\n          width: calc((100% - 25%) / 4) !important;\n        }\n\n        /* æœ€åä¸€åˆ—ï¼ˆæ“ä½œåˆ—ï¼‰å±…ä¸­ */\n        html body .auto-card-updater-popup table th:last-child,\n        html body .auto-card-updater-popup table td:last-child,\n        html body #shujuku_v104-popup.auto-card-updater-popup table th:last-child,\n        html body #shujuku_v104-popup.auto-card-updater-popup table td:last-child,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table th:last-child,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table td:last-child {\n          text-align: center !important;\n          width: 25% !important;\n        }\n\n        /* ========== Mobile Responsive ç§»åŠ¨ç«¯é€‚é… ========== */\n        @media (max-width: 768px) {\n          html body .auto-card-updater-popup table,\n          html body #shujuku_v104-popup.auto-card-updater-popup table,\n          html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table {\n            font-size: 0.8em !important;\n          }\n\n          html body .auto-card-updater-popup table th,\n          html body .auto-card-updater-popup table td,\n          html body #shujuku_v104-popup.auto-card-updater-popup table th,\n          html body #shujuku_v104-popup.auto-card-updater-popup table td,\n          html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table th,\n          html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup table td {\n            padding: 4px 6px !important;\n          }\n        }\n\n        /* ========== Radio group å•é€‰æŒ‰é’®ç»„ ========== */\n        #shujuku_v104-popup.auto-card-updater-popup .qrf_radio_group,\n        [id^="shujuku"][id$="-popup"].auto-card-updater-popup .qrf_radio_group {\n          background-color: ${i.btnBg} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 6px;\n          padding: 8px 12px !important;\n        }\n        #shujuku_v104-popup.auto-card-updater-popup .qrf_radio_group label,\n        #shujuku_v104-popup.auto-card-updater-popup .qrf_radio_group span,\n        [id^="shujuku"][id$="-popup"].auto-card-updater-popup .qrf_radio_group label,\n        [id^="shujuku"][id$="-popup"].auto-card-updater-popup .qrf_radio_group span {\n          color: ${i.textMain} !important;\n        }\n        #shujuku_v104-popup.auto-card-updater-popup input[type="radio"],\n        [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="radio"] {\n          -webkit-appearance: none !important;\n          appearance: none !important;\n          width: 16px !important;\n          height: 16px !important;\n          min-width: 16px !important;\n          min-height: 16px !important;\n          border-radius: 50% !important;\n          border: 1px solid ${i.border} !important;\n          background-color: ${i.inputBg} !important;\n          box-shadow: none !important;\n          position: relative !important;\n          cursor: pointer !important;\n          vertical-align: middle !important;\n        }\n        #shujuku_v104-popup.auto-card-updater-popup input[type="radio"]:checked,\n        [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="radio"]:checked {\n          border-color: ${i.accent} !important;\n        }\n        #shujuku_v104-popup.auto-card-updater-popup input[type="radio"]:checked::after,\n        [id^="shujuku"][id$="-popup"].auto-card-updater-popup input[type="radio"]:checked::after {\n          content: '' !important;\n          position: absolute !important;\n          width: 8px !important;\n          height: 8px !important;\n          border-radius: 50% !important;\n          background: ${i.accent} !important;\n          top: 50% !important;\n          left: 50% !important;\n          transform: translate(-50%, -50%) !important;\n        }\n\n        /* ========== Worldbook entry list ä¸–ç•Œä¹¦æ¡ç›®åˆ—è¡¨ ========== */\n        #shujuku_v104-popup .qrf_worldbook_entry_list,\n        #shujuku_v104-popup [class*="worldbook-entry-list"],\n        [id^="shujuku"][id$="-popup"] .qrf_worldbook_entry_list,\n        [id^="shujuku"][id$="-popup"] [class*="worldbook-entry-list"] {\n          background-color: ${i.btnBg} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n          border-radius: 6px;\n        }\n        #shujuku_v104-popup .qrf_worldbook_entry_list label,\n        #shujuku_v104-popup .qrf_worldbook_entry_list span,\n        #shujuku_v104-popup .qrf_worldbook_entry_list div,\n        [id^="shujuku"][id$="-popup"] .qrf_worldbook_entry_list label,\n        [id^="shujuku"][id$="-popup"] .qrf_worldbook_entry_list span,\n        [id^="shujuku"][id$="-popup"] .qrf_worldbook_entry_list div {\n          color: ${i.textMain} !important;\n        }\n\n        /* ========== Plot prompt segment textarea ========== */\n        #shujuku_v104-popup textarea.plot-prompt-segment-content,\n        #shujuku_v104-popup .plot-prompt-segment-content,\n        [id^="shujuku"][id$="-popup"] textarea.plot-prompt-segment-content,\n        [id^="shujuku"][id$="-popup"] .plot-prompt-segment-content {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n\n        /* ========== Plot prompt segment container ========== */\n        #shujuku_v104-popup .plot-prompt-segment,\n        [id^="shujuku"][id$="-popup"] .plot-prompt-segment {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n\n        /* Toggle switch å†…éƒ¨ checkbox ç»´æŒéšè—è¾“å…¥ï¼Œé¿å…è¢«ä¸Šé¢è§„åˆ™æ¥ç®¡ */\n        html body #shujuku_v104-popup.auto-card-updater-popup .toggle-switch input[type="checkbox"],\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .toggle-switch input[type="checkbox"] {\n          -webkit-appearance: auto !important;\n          appearance: auto !important;\n          background: transparent !important;\n          border: 0 !important;\n          box-shadow: none !important;\n          width: 0 !important;\n          height: 0 !important;\n          min-width: 0 !important;\n          min-height: 0 !important;\n          opacity: 0 !important;\n          margin: 0 !important;\n        }\n\n        /* çŠ¶æ€æ–‡æœ¬é«˜äº®ï¼ˆæ›¿æ¢å†…è” lightgreenï¼‰ */\n        html body #shujuku_v104-popup.auto-card-updater-popup span[style*="lightgreen"],\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup span[style*="lightgreen"] {\n          color: ${i.accent} !important;\n        }\n\n        /* Toggle switch è½¨é“ä¸æ»‘å—ï¼ˆä¿®å¤æµ…è‰²ä¸»é¢˜å¯è§æ€§ï¼‰ */\n        html body #shujuku_v104-popup.auto-card-updater-popup .toggle-switch .slider,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .toggle-switch .slider {\n          background-color: ${i.inputBg} !important;\n          background: ${i.inputBg} !important;\n          border: 1px solid ${i.border} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .toggle-switch .slider:before,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .toggle-switch .slider:before {\n          background-color: ${i.btnActiveText} !important;\n          border: 1px solid ${i.border} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .toggle-switch input:checked + .slider,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .toggle-switch input:checked + .slider {\n          background-color: ${i.btnActiveBg} !important;\n          background: ${i.btnActiveBg} !important;\n          border-color: ${i.btnActiveBg} !important;\n        }\n        html body #shujuku_v104-popup.auto-card-updater-popup .toggle-switch input:checked + .slider:before,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .toggle-switch input:checked + .slider:before {\n          background-color: ${i.btnActiveText} !important;\n          border-color: ${i.btnActiveText} !important;\n        }\n\n        /* ========== Prompt Segment Toolbar (ä¿®å¤æµ…è‰²/ç»ç’ƒä¸»é¢˜å¯¹æ¯”åº¦) ========== */\n        /* Container */\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment {\n          background-color: ${i.bgPanel} !important;\n          border: 1px solid ${i.border} !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* Toolbar Container */\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment-toolbar,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment-toolbar {\n          background-color: transparent !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* Controls: Role Select, Main Slot Select, Delete Button */\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-role,\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-main-slot,\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-delete-btn,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-role,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-main-slot,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-delete-btn {\n          background-color: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n          border: 1px solid ${i.border} !important;\n        }\n\n        /* Hover states */\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-role:hover,\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-main-slot:hover,\n        html body #shujuku_v104-popup.auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-delete-btn:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-role:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-main-slot:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .prompt-segment-toolbar .prompt-segment-delete-btn:hover {\n          background-color: ${i.btnHover} !important;\n        }\n\n        /* ========== Tabs Navigation æ ‡ç­¾é¡µå¯¼èˆª ========== */\n        /* Container */\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-tabs-nav,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-tabs-nav,\n        html body #shujuku_v104-main-window .acu-tabs-nav,\n        html body [id^="shujuku"][id$="-main-window"] .acu-tabs-nav {\n          background-color: ${i.bgPanel} !important;\n          background: ${i.bgPanel} !important;\n          color: ${i.textMain} !important;\n          border-bottom: 1px solid ${i.border} !important;\n        }\n\n        /* Section Title */\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-nav-section-title,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-nav-section-title,\n        html body #shujuku_v104-main-window .acu-nav-section-title,\n        html body [id^="shujuku"][id$="-main-window"] .acu-nav-section-title {\n          color: ${i.textSub} !important;\n          font-size: 11px !important;\n          text-transform: uppercase !important;\n          letter-spacing: 0.5px !important;\n          font-weight: 600 !important;\n        }\n\n        /* Tab Button (default state) */\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-tab-button,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-tab-button,\n        html body #shujuku_v104-main-window .acu-tab-button,\n        html body [id^="shujuku"][id$="-main-window"] .acu-tab-button {\n          background-color: transparent !important;\n          background: transparent !important;\n          color: ${i.textSub} !important;\n          border: 1px solid transparent !important;\n          border-radius: 6px !important;\n          transition: all 0.2s ease !important;\n        }\n\n        /* Tab Button (hover) */\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-tab-button:hover,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-tab-button:hover,\n        html body #shujuku_v104-main-window .acu-tab-button:hover,\n        html body [id^="shujuku"][id$="-main-window"] .acu-tab-button:hover {\n          background-color: ${i.btnBg} !important;\n          background: ${i.btnBg} !important;\n          color: ${i.textMain} !important;\n        }\n\n        /* Tab Button (active state) */\n        html body #shujuku_v104-popup.auto-card-updater-popup .acu-tab-button.active,\n        html body [id^="shujuku"][id$="-popup"].auto-card-updater-popup .acu-tab-button.active,\n        html body #shujuku_v104-main-window .acu-tab-button.active,\n        html body [id^="shujuku"][id$="-main-window"] .acu-tab-button.active {\n          background-color: ${i.btnActiveBg} !important;\n          background: ${i.btnActiveBg} !important;\n          color: ${i.btnActiveText} !important;\n          border-color: ${i.btnActiveBg} !important;\n        }\n      </style>\n    `;for(const $ of o)$('#dice-db-theme-sync').remove(),$('head').append(u)}catch(t){}}!function(){const t='acu_visualizer_ui_v19_6_ai_overlay',n={STORAGE_KEY_PREFIX:'acu_locked_fields_v2_',MAX_CONTEXTS:20,PRIMARY_KEYS:{å…¨å±€æ•°æ®è¡¨:null,ä¸–ç•Œåœ°å›¾ç‚¹:'è¯¦ç»†åœ°ç‚¹',åœ°å›¾å…ƒç´ è¡¨:'å…ƒç´ åç§°',ä¸»è§’ä¿¡æ¯:'å§“å',é‡è¦äººç‰©è¡¨:'å§“å',æŠ€èƒ½è¡¨:'æŠ€èƒ½åç§°',ç‰©å“è¡¨:'ç‰©å“åç§°',è£…å¤‡è¡¨:'è£…å¤‡åç§°',ä»»åŠ¡è¡¨:'åç§°',æ€»ç»“è¡¨:'ç¼–ç ç´¢å¼•',æ€»ä½“å¤§çº²:'ç¼–ç ç´¢å¼•',é‡è¦æƒ…æŠ¥:'æƒ…æŠ¥åç§°',åŠ¿åŠ›:'åç§°'},_cache:null,_currentContextId:null,_getStorageKey(t){return this.STORAGE_KEY_PREFIX+(t||he())},_cleanupOldContexts(){try{const t=this.STORAGE_KEY_PREFIX,e=[];for(let a=0;a<localStorage.length;a++){const n=localStorage.key(a);n&&n.startsWith(t)&&e.push(n)}if(e.length<=this.MAX_CONTEXTS)return;const a=e.map(t=>{try{const e=JSON.parse(localStorage.getItem(t));return{key:t,time:e?._lastAccess||0}}catch{return{key:t,time:0}}});a.sort((t,e)=>e.time-t.time);const n=a.slice(this.MAX_CONTEXTS);n.forEach(t=>{localStorage.removeItem(t.key)}),n.length>0&&console.log(`[DICE]LockManager æ¸…ç†äº† ${n.length} ä¸ªè¿‡æœŸçš„é”å®šæ•°æ®`)}catch(t){console.warn('[DICE]LockManager æ¸…ç†å¤±è´¥',t)}},_load(){const t=he();if(this._currentContextId!==t&&(this._cache=null,this._currentContextId=t),!this._cache)try{const t=localStorage.getItem(this._getStorageKey());this._cache=t?JSON.parse(t):{},delete this._cache._lastAccess}catch(t){this._cache={}}return this._cache},_save(){try{const t={...this._cache,_lastAccess:Date.now()};localStorage.setItem(this._getStorageKey(),JSON.stringify(t)),this._cleanupOldContexts()}catch(t){console.warn('[DICE]LockManager ä¿å­˜å¤±è´¥',t)}},getRowKey(t,e,a){const n=this.PRIMARY_KEYS[t];if(null===n)return'_row_0';let o=1;if(n){const t=a.indexOf(n);-1!==t&&(o=t)}return e[o]?`${n||a[o]}=${e[o]}`:null},lockField(t,e,a,n){const o=this._load();o[t]||(o[t]={}),o[t][e]||(o[t][e]={_fullRow:!1,_fields:{},_snapshot:null}),o[t][e]._fields[a]=n,this._save()},lockRow(t,e,a,n){const o=this._load();o[t]||(o[t]={});const i={};n.forEach((t,e)=>{t&&null!=a[e]&&''!==a[e]&&(i[t]=a[e])}),o[t][e]={_fullRow:!0,_fields:{},_snapshot:i},this._save()},unlockField(t,e,a){const n=this._load(),o=n[t]?.[e];o&&(o._fullRow&&o._snapshot?(delete o._snapshot[a],0===Object.keys(o._snapshot).length&&(delete n[t][e],0===Object.keys(n[t]).length&&delete n[t])):(delete o._fields[a],0===Object.keys(o._fields).length&&(delete n[t][e],0===Object.keys(n[t]).length&&delete n[t])),this._save())},unlockRow(t,e){const a=this._load();a[t]&&(delete a[t][e],0===Object.keys(a[t]).length&&delete a[t],this._save())},isFieldLocked(t,e,a){const n=this._load()[t]?.[e];return!!n&&(n._fullRow?n._snapshot?.hasOwnProperty(a):n._fields?.hasOwnProperty(a))},isRowLocked(t,e){return!0===this._load()[t]?.[e]?._fullRow},applyLocks(t,e){const a=this._load()[t];if(!a||!e||e.length<2)return{modified:!1,restored:[]};const n=e[0],o=[];let i=!1;const r={};for(let a=1;a<e.length;a++){const o=this.getRowKey(t,e[a],n);o&&(r[o]=a)}for(const[t,c]of Object.entries(a)){const a=r[t];if(void 0===a){const a=this._rebuildRow(n,c);a&&(e.push(a),o.push(t),i=!0);continue}const s=e[a],l=c._fullRow?c._snapshot:c._fields;if(l)for(const[t,e]of Object.entries(l)){const a=n.indexOf(t);-1!==a&&s[a]!==e&&(s[a]=e,i=!0)}}return{modified:i,restored:o}},_rebuildRow(t,e){const a=e._fullRow?e._snapshot:e._fields;if(!a||0===Object.keys(a).length)return null;const n=new Array(t.length).fill(null);for(const[e,o]of Object.entries(a)){const a=t.indexOf(e);-1!==a&&(n[a]=o)}return n},hasAnyLock(t,e){const a=this._load()[t]?.[e];return!!a&&(!!a._fullRow||Object.keys(a._fields||{}).length>0)},getLockedFields(t,e){const a=this._load()[t]?.[e];return a?a._fullRow?Object.keys(a._snapshot||{}):Object.keys(a._fields||{}):[]},clearCurrentContext(){localStorage.removeItem(this._getStorageKey()),this._cache=null}},i={STORAGE_KEY_PREFIX:'acu_bookmarks_v1_',MAX_CONTEXTS:20,_cache:null,_currentContextId:null,_getStorageKey(t){return this.STORAGE_KEY_PREFIX+(t||he())},_cleanupOldContexts(){try{const t=this.STORAGE_KEY_PREFIX,e=[];for(let a=0;a<localStorage.length;a++){const n=localStorage.key(a);n&&n.startsWith(t)&&e.push(n)}if(e.length<=this.MAX_CONTEXTS)return;const a=e.map(t=>{try{const e=JSON.parse(localStorage.getItem(t));return{key:t,time:e?._lastAccess||0}}catch{return{key:t,time:0}}});a.sort((t,e)=>e.time-t.time);const n=a.slice(this.MAX_CONTEXTS);n.forEach(t=>{localStorage.removeItem(t.key)}),n.length>0&&console.log(`[DICE]BookmarkManager æ¸…ç†äº† ${n.length} ä¸ªè¿‡æœŸçš„bookmarkæ•°æ®ï¼ˆå½“å‰ä¿ç•™ ${this.MAX_CONTEXTS} ä¸ªèŠå¤©çš„æ•°æ®ï¼Œæ¸…ç†å‰å…±æœ‰ ${e.length} ä¸ªï¼‰`)}catch(t){console.warn('[DICE]BookmarkManager æ¸…ç†å¤±è´¥',t)}},_load(){const t=he();if(this._currentContextId!==t&&(this._cache=null,this._currentContextId=t),!this._cache)try{const t=localStorage.getItem(this._getStorageKey());this._cache=t?JSON.parse(t):{},delete this._cache._lastAccess}catch(t){this._cache={}}return this._cache},_save(){try{const t={...this._cache,_lastAccess:Date.now()};localStorage.setItem(this._getStorageKey(),JSON.stringify(t)),this._cleanupOldContexts()}catch(t){console.warn('[DICE]BookmarkManager ä¿å­˜å¤±è´¥',t)}},isBookmarked(t,e){const a=this._load();return!(!a[t]||!a[t][e])},toggleBookmark(t,e){const a=this._load();a[t]||(a[t]={}),a[t][e]?(delete a[t][e],0===Object.keys(a[t]).length&&delete a[t]):a[t][e]=!0,this._save()},getBookmarks(t){const e=this._load();return e[t]?Object.keys(e[t]):[]},clearCurrentContext(){localStorage.removeItem(this._getStorageKey()),this._cache=null}},r=t=>String(t??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),c=(t,e,a)=>{if('ontouchstart'in window||navigator.maxTouchPoints>0)t.on('click',function(t){$(t.target).hasClass(e)&&a()});else{let n=!1;t.on('mousedown',function(t){n=$(t.target).hasClass(e)}),t.on('mouseup',function(t){n&&$(t.target).hasClass(e)&&a(),n=!1})}},s=t=>{const{$}=$e();$('.acu-import-confirm-overlay').remove();const e=ma(),a=((t,e)=>{if(!e.includes(t))return t;let a=2,n=`${t} (${a})`;for(;e.includes(n);)a++,n=`${t} (${a})`;return n})(t.presetName,t.existingNames),n=$(`\n      <div class="acu-import-confirm-overlay acu-theme-${e.theme}">\n        <div class="acu-import-confirm-dialog">\n          <div class="acu-import-confirm-header">\n            <i class="fa-solid fa-file-import"></i> å¯¼å…¥${t.presetType}é¢„è®¾\n          </div>\n          <div class="acu-import-confirm-body">\n            <div class="acu-import-warning-container">\n              <i class="fa-solid fa-exclamation-triangle acu-import-warning-icon"></i>\n              <div class="acu-import-warning-title">å‘ç°åŒåé¢„è®¾</div>\n              <div class="acu-import-warning-message">é¢„è®¾ã€Œ${r(t.presetName)}ã€å·²å­˜åœ¨ï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š</div>\n            </div>\n            <div class="acu-import-conflict-options">\n              <label class="acu-import-radio">\n                <input type="radio" name="preset-conflict-mode" value="overwrite" checked />\n                <span>è¦†ç›–ç°æœ‰é¢„è®¾</span>\n              </label>\n              <label class="acu-import-radio">\n                <input type="radio" name="preset-conflict-mode" value="rename" />\n                <span>æ–°å»ºå‰¯æœ¬ï¼ˆå‘½åä¸ºã€Œ${r(a)}ã€ï¼‰</span>\n              </label>\n            </div>\n          </div>\n          <div class="acu-import-confirm-footer">\n            <button class="acu-import-cancel-btn">å–æ¶ˆ</button>\n            <button class="acu-import-confirm-btn">ç¡®è®¤å¯¼å…¥</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(n);n[0].style.cssText='\n      position: fixed !important;\n      top: 0 !important;\n      left: 0 !important;\n      right: 0 !important;\n      bottom: 0 !important;\n      width: 100vw !important;\n      height: 100vh !important;\n      background: rgba(0,0,0,0.6) !important;\n      z-index: 31300 !important;\n      display: flex;\n      justify-content: center !important;\n      align-items: center !important;\n      padding: 16px;\n      box-sizing: border-box !important;\n    ';const o=()=>n.remove();n.find('.acu-import-cancel-btn').click(()=>{o(),t.onCancel()}),c(n,'acu-import-confirm-overlay',()=>{o(),t.onCancel()}),n.find('.acu-import-confirm-btn').click(function(){const e=n.find('input[name="preset-conflict-mode"]:checked').val();o(),'overwrite'===e?t.onOverwrite():t.onRename(a)})},l=(t,e)=>{const{$}=$e(),a=$('#send_textarea');if(!a.length)return;const n=(a.val()||'').trim(),o=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g,i=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g,r=/<user>(?:(?!<user>).)*?[ã€‚ï¼ï¼Ÿ]/g,c=/\[æŠ•éª°ç»“æœå·²éšè—\]/g,s=xt();let l=t,u=!1;if('dice'===e&&s.hideDiceResultFromUser&&(l='[æŠ•éª°ç»“æœå·²éšè—]',u=!0),!n){if(a.val(l).trigger('input').trigger('change'),'dice'===e){a.data('acu-original-dice-text',t);const e=a[0];e._acuOriginalDiceText=t,e._acuHasDiceData=!0}return}let d=n,p='',g='',f='';if(c.test(d)){const t=a.data('acu-original-dice-text')||'';t?(d=d.replace(c,t),g=t,f=t):d=d.replace(c,'').trim()}const b=d.match(i);b&&b.length>0&&(g=b[b.length-1],f=g,d=d.replace(i,'\0').trim(),console.log('[DICE]ACU SmartInsert Found and extracted contest roll:',g));const m=d.match(o);m&&m.length>0&&(g=m[m.length-1],f=g,d=d.replace(o,'\0').trim(),console.log('[DICE]ACU SmartInsert Found and extracted normal roll:',g));const v=d.match(r);v&&v.length>0&&(p=v[v.length-1],d=d.replace(r,'').trim(),console.log('[DICE]ACU SmartInsert Found and extracted action:',p));let h=d.replace(/[\u0000\u0001]/g,' ').replace(/\s+/g,' ').trim();if('dice'===e){g=l,f=t,a.data('acu-original-dice-text',t);const e=a[0];e._acuOriginalDiceText=t,e._acuHasDiceData=!0}else'action'===e&&(p=t);const x=[];h&&x.push(h),p&&x.push(p),g&&x.push(g);const y=x.join(' ');a.val(y).trigger('input').trigger('change')},u=()=>{const{$}=$e(),t=xt();if(void 0!==t.hideDiceResultFromUser&&t.hideDiceResultFromUser)return;const e=$('#send_textarea');if(!e.length)return;const a=e.val()||'',n=e.data('acu-original-dice-text');if(a.includes('[æŠ•éª°ç»“æœå·²éšè—]')&&n){const t=a.replace(/\[æŠ•éª°ç»“æœå·²éšè—\]/g,n);e.val(t),e.removeData('acu-original-dice-text');const o=e[0];o._acuOriginalDiceText=null,o._acuHasDiceData=!1}},d=()=>{const{$}=$e(),t=$('#send_textarea');if(!t.length)return;const e=t[0];if(!e||e._acuValueIntercepted)return;e._acuValueIntercepted=!0;const a=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,'value'),n=e.value;Object.defineProperty(e,'value',{get:function(){let t;if(t=a&&a.get?a.get.call(this):this._value||n||'',!this._acuHasDiceData)return t;const e=this._acuOriginalDiceText;return t&&'string'==typeof t&&t.includes('[æŠ•éª°ç»“æœå·²éšè—]')&&e?t.replace(/\[æŠ•éª°ç»“æœå·²éšè—\]/g,e):t},set:function(t){a&&a.set?a.set.call(this,t):this._value=t},configurable:!0})},p='acu_table_order',g='acu_active_tab',f='acu_ui_config_v19',b='acu_data_snapshot_v19',m='acu_ui_collapsed_state',v='acu_options_collapsed',h='acu_dashboard_active',x='acu_table_heights_v19',y='acu_table_styles_v19',w='acu_hidden_tables_v19',k='acu_reverse_tables_v1',C=200,E=1200,A='acu_dice_config_v1',D='acu_attribute_presets_v1',I='acu_active_attr_preset_v1',F='acu_action_presets_v1',S='acu_active_action_preset_v1',M='acu_dice_crazy_mode',j={enabled:!1,crazyLevel:50,playerWeight:80,inSceneNpcWeight:15,offSceneNpcWeight:5},T='1.4.0',P=(t,e)=>{const a=t=>'number'==typeof t?`${t}.0.0`:'string'!=typeof t?'0.0.0':t,n=a(t),o=a(e),i=n.split('.').map(Number),r=o.split('.').map(Number);for(let t=0;t<Math.max(i.length,r.length);t++){const e=i[t]||0,a=r[t]||0;if(e<a)return-1;if(e>a)return 1}return 0},N='acu_avatar_map_v1',R='acu_map_focus_v1',O={logs:[],maxLogs:1e3,filters:{log:!0,info:!0,warn:!0,error:!0},originalMethods:{},isIntercepted:!1,enabled:!1,restore(){'true'===localStorage.getItem('acu_console_capture_enabled')&&this.enable()},enable(){this.enabled||(this.enabled=!0,localStorage.setItem('acu_console_capture_enabled','true'),this.intercept())},disable(){if(!this.enabled)return;this.enabled=!1,localStorage.setItem('acu_console_capture_enabled','false'),localStorage.removeItem('acu_script_error_detected');const t=document.getElementById('acu-emergency-debug-btn');t&&(t.style.display='none')},intercept(){this.isIntercepted||(this.isIntercepted=!0,['log','info','warn','error'].forEach(t=>{this.originalMethods[t]=console[t];const e=this;console[t]=function(...a){e.originalMethods[t].apply(console,a),e.enabled&&e.capture(t,a)}}))},capture(t,e){if(this.enabled)try{const a=new Date,n=a.toLocaleTimeString('zh-CN',{hour12:!1}),o=e.map(t=>{if('object'==typeof t)try{return JSON.stringify(t,null,2)}catch{return String(t)}return String(t)}).join(' ');let i=null;'error'===t&&e[0]instanceof Error&&(i=e[0].stack||null);const r={id:Date.now()+Math.random(),timestamp:a,timeStr:n,type:t,content:o,stack:i,rawArgs:e};this.logs.push(r),this.logs.length>this.maxLogs&&this.logs.shift()}catch(t){}},clear(){this.logs=[]},getFilteredLogs(){return this.logs.filter(t=>this.filters[t.type])},setFilters(t){this.filters={...this.filters,...t}}},B={errorCount:0,errorThreshold:3,lastErrorTime:0,errorWindow:5e3,fatalErrorDetected:!1,isFatalError(t,e,a,n,o){const i=[/jquery/i,/lodash/i,/vue/i,/react/i,/pixi/i,/gsap/i,/toastr/i,/node_modules/i],r=o||t?.stack||'',c=e||'';for(const t of i)if(t.test(r)||t.test(c))return!1;const s=[/acu_visualizer/i,/éª°å­ç³»ç»Ÿ/i,/LockManager/i,/Store/i,/ConsoleCaptureManager/i,/renderInterface/i,/init\s*\(/i];let l=!1;for(const t of s)if(t.test(r)||t.test(c)){l=!0;break}return l},handleError(t,e,a,n,o){try{if(!this.isFatalError(t,e,a,n,o))return;const i=Date.now();i-this.lastErrorTime>this.errorWindow&&(this.errorCount=0),this.errorCount++,this.lastErrorTime=i,this.errorCount>=this.errorThreshold&&!this.fatalErrorDetected&&(this.fatalErrorDetected=!0,this.triggerFatalError())}catch(t){console.error('[DICE]ErrorHandler å¤„ç†é”™è¯¯æ—¶å¤±è´¥:',t)}},triggerFatalError(){try{O.enabled||O.enable(),localStorage.setItem('acu_script_error_detected','true'),this.showEmergencyButton()}catch(t){console.error('[DICE]ErrorHandler è§¦å‘è‡´å‘½é”™è¯¯å¤„ç†æ—¶å¤±è´¥:',t)}},showEmergencyButton(){try{let t=document.getElementById('acu-emergency-debug-btn');if(t)return void(t.style.display='block');t=document.createElement('button'),t.id='acu-emergency-debug-btn',t.innerHTML='<i class="fa-solid fa-bug"></i> è°ƒè¯•',t.style.cssText='\n          position: fixed;\n          bottom: 20px;\n          right: 20px;\n          z-index: 99999;\n          padding: 10px 16px;\n          background: #e74c3c;\n          color: #fff;\n          border: none;\n          border-radius: 6px;\n          font-size: 14px;\n          font-weight: bold;\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);\n          display: flex;\n          align-items: center;\n          gap: 6px;\n          transition: all 0.2s;\n        ',t.onmouseenter=function(){this.style.background='#c0392b',this.style.transform='scale(1.05)'},t.onmouseleave=function(){this.style.background='#e74c3c',this.style.transform='scale(1)'},t.onclick=function(){try{'function'==typeof window.showDebugConsoleModal?window.showDebugConsoleModal():alert('è„šæœ¬å‡ºç°é”™è¯¯ï¼Œè¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰æŸ¥çœ‹æ§åˆ¶å°')}catch(t){console.error('[DICE]ç´§æ€¥å…¥å£æŒ‰é’®ç‚¹å‡»å¤±è´¥:',t),alert('è„šæœ¬å‡ºç°é”™è¯¯ï¼Œè¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰æŸ¥çœ‹æ§åˆ¶å°')}},document.body.appendChild(t)}catch(t){console.error('[DICE]æ˜¾ç¤ºç´§æ€¥å…¥å£æŒ‰é’®å¤±è´¥:',t)}},checkAndRestore(){try{'true'===localStorage.getItem('acu_script_error_detected')&&(O.enabled||O.enable(),this.showEmergencyButton())}catch(t){console.error('[DICE]ErrorHandler æ£€æŸ¥é”™è¯¯çŠ¶æ€å¤±è´¥:',t)}}};window.onerror=function(t,e,a,n,o){return B.handleError(o||t,e,a,n,o?.stack),!1},window.addEventListener('unhandledrejection',function(t){B.handleError(t.reason,null,null,null,t.reason?.stack)});const L='acu_regex_rules_v1',U='acu_regex_presets_v1',V='acu_regex_active_preset_v1',q='acu_regex_enabled_v1';const Y='acu_validation_enabled_v1',J='acu_validation_mode',W={tableReadonly:{name:'è¡¨çº§åªè¯»',scope:'table',icon:'fa-lock',desc:'ç¦æ­¢ä¿®æ”¹æ•´ä¸ªè¡¨'},rowLimit:{name:'è¡Œæ•°é™åˆ¶',scope:'table',icon:'fa-arrows-up-down',desc:'é™åˆ¶è¡¨çš„è¡Œæ•°èŒƒå›´'},sequence:{name:'åºåˆ—é€’å¢',scope:'table',icon:'fa-sort-numeric-up',desc:'æ£€æŸ¥å­—æ®µå€¼æ˜¯å¦ä¸¥æ ¼é€’å¢'},required:{name:'å¿…å¡«',scope:'field',icon:'fa-asterisk',desc:'å­—æ®µä¸èƒ½ä¸ºç©º'},format:{name:'æ ¼å¼éªŒè¯',scope:'field',icon:'fa-font',desc:'æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…'},enum:{name:'æšä¸¾éªŒè¯',scope:'field',icon:'fa-list',desc:'å€¼å¿…é¡»åœ¨åˆ—è¡¨ä¸­'},numeric:{name:'æ•°å€¼èŒƒå›´',scope:'field',icon:'fa-hashtag',desc:'æ•°å€¼å¿…é¡»åœ¨èŒƒå›´å†…'},relation:{name:'å…³è”éªŒè¯',scope:'field',icon:'fa-link',desc:'å¼•ç”¨å…¶ä»–è¡¨çš„å€¼'},keyValue:{name:'é”®å€¼å¯¹éªŒè¯',scope:'field',icon:'fa-key',desc:'éªŒè¯é”®å€¼å¯¹æ ¼å¼å’Œæ•°å€¼èŒƒå›´'}},X=[{id:'summary_code_sequence',name:'æ€»ç»“è¡¨ç¼–ç é€’å¢',description:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ç»“è¡¨',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œå‘ç°è·³å·æˆ–é‡å¤'},{id:'outline_code_sequence',name:'æ€»ä½“å¤§çº²ç¼–ç é€’å¢',description:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ä½“å¤§çº²',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œå‘ç°è·³å·æˆ–é‡å¤'},{id:'summary_code_required',name:'æ€»ç»“è¡¨ç¼–ç ç´¢å¼•å¿…å¡«',description:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ç»“è¡¨',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'required',config:{},errorMessage:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º'},{id:'outline_code_required',name:'æ€»ä½“å¤§çº²ç¼–ç ç´¢å¼•å¿…å¡«',description:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ä½“å¤§çº²',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'required',config:{},errorMessage:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º'},{id:'quest_status_enum',name:'ä»»åŠ¡è¡¨çŠ¶æ€',description:'ä»»åŠ¡çŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'çŠ¶æ€',ruleType:'enum',config:{values:['è¿›è¡Œä¸­','å·²å®Œæˆ','å·²å¤±è´¥','å·²æ”¾å¼ƒ']},errorMessage:'çŠ¶æ€å¿…é¡»ä¸ºï¼šè¿›è¡Œä¸­ã€å·²å®Œæˆã€å·²å¤±è´¥ã€å·²æ”¾å¼ƒ'},{id:'quest_type_enum',name:'ä»»åŠ¡è¡¨ç±»å‹',description:'ä»»åŠ¡ç±»å‹å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'ç±»å‹',ruleType:'enum',config:{values:['ä¸»çº¿','æ”¯çº¿','æ—¥å¸¸']},errorMessage:'ç±»å‹å¿…é¡»ä¸ºï¼šä¸»çº¿ã€æ”¯çº¿ã€æ—¥å¸¸'},{id:'quest_priority_enum',name:'ä»»åŠ¡è¡¨ä¼˜å…ˆçº§',description:'ä»»åŠ¡ä¼˜å…ˆçº§å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'ä¼˜å…ˆçº§',ruleType:'enum',config:{values:['ç´§æ€¥','é‡è¦','æ™®é€š']},errorMessage:'ä¼˜å…ˆçº§å¿…é¡»ä¸ºï¼šç´§æ€¥ã€é‡è¦ã€æ™®é€š'},{id:'equip_status_enum',name:'è£…å¤‡è¡¨çŠ¶æ€',description:'è£…å¤‡çŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'è£…å¤‡è¡¨',targetColumn:'çŠ¶æ€',ruleType:'enum',config:{values:['å·²è£…å¤‡','é—²ç½®']},errorMessage:'çŠ¶æ€å¿…é¡»ä¸ºï¼šå·²è£…å¤‡ã€é—²ç½®'},{id:'equip_quality_enum',name:'è£…å¤‡è¡¨å“è´¨',description:'è£…å¤‡å“è´¨å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'è£…å¤‡è¡¨',targetColumn:'å“è´¨',ruleType:'enum',config:{values:['æ™®é€š','ä¼˜ç§€','ç¨€æœ‰','å²è¯—','ä¼ è¯´','ç¥è¯']},errorMessage:'å“è´¨å¿…é¡»ä¸ºï¼šæ™®é€šã€ä¼˜ç§€ã€ç¨€æœ‰ã€å²è¯—ã€ä¼ è¯´ã€ç¥è¯'},{id:'item_quality_enum',name:'ç‰©å“è¡¨å“è´¨',description:'ç‰©å“å“è´¨å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ç‰©å“è¡¨',targetColumn:'å“è´¨',ruleType:'enum',config:{values:['æ™®é€š','ä¼˜ç§€','ç¨€æœ‰','å²è¯—','ä¼ è¯´','ç¥è¯']},errorMessage:'å“è´¨å¿…é¡»ä¸ºï¼šæ™®é€šã€ä¼˜ç§€ã€ç¨€æœ‰ã€å²è¯—ã€ä¼ è¯´ã€ç¥è¯'},{id:'skill_type_enum',name:'æŠ€èƒ½è¡¨ç±»å‹',description:'æŠ€èƒ½ç±»å‹å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'æŠ€èƒ½è¡¨',targetColumn:'ç±»å‹',ruleType:'enum',config:{values:['ä¸»åŠ¨','è¢«åŠ¨','ç‰¹è´¨']},errorMessage:'ç±»å‹å¿…é¡»ä¸ºï¼šä¸»åŠ¨ã€è¢«åŠ¨ã€ç‰¹è´¨'},{id:'skill_quality_enum',name:'æŠ€èƒ½è¡¨å“è´¨',description:'æŠ€èƒ½å“è´¨å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'æŠ€èƒ½è¡¨',targetColumn:'å“è´¨',ruleType:'enum',config:{values:['æ™®é€š','ä¼˜ç§€','ç¨€æœ‰','å²è¯—','ä¼ è¯´','ç¥è¯']},errorMessage:'å“è´¨å¿…é¡»ä¸ºï¼šæ™®é€šã€ä¼˜ç§€ã€ç¨€æœ‰ã€å²è¯—ã€ä¼ è¯´ã€ç¥è¯'},{id:'skill_proficiency_range',name:'æŠ€èƒ½ç†Ÿç»ƒåº¦èŒƒå›´',description:'æŠ€èƒ½ç†Ÿç»ƒåº¦å¿…é¡»åœ¨ 0-100 ä¹‹é—´',enabled:!0,builtin:!0,intercept:!1,targetTable:'æŠ€èƒ½è¡¨',targetColumn:'ç†Ÿç»ƒåº¦',ruleType:'numeric',config:{min:0,max:100},errorMessage:'ç†Ÿç»ƒåº¦å¿…é¡»åœ¨ 0-100 ä¹‹é—´'},{id:'npc_presence_enum',name:'é‡è¦äººç‰©åœ¨åœºçŠ¶æ€',description:'åœ¨åœºçŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'åœ¨åœºçŠ¶æ€',ruleType:'enum',config:{values:['åœ¨åœº','ç¦»åœº']},errorMessage:'åœ¨åœºçŠ¶æ€å¿…é¡»ä¸ºï¼šåœ¨åœºã€ç¦»åœº'},{id:'map_explore_enum',name:'åœ°å›¾ç‚¹æ¢ç´¢çŠ¶æ€',description:'æ¢ç´¢çŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸–ç•Œåœ°å›¾ç‚¹',targetColumn:'æ¢ç´¢çŠ¶æ€',ruleType:'enum',config:{values:['æœªæ¢ç´¢','éƒ¨åˆ†æ¢ç´¢','å·²æ¢ç´¢']},errorMessage:'æ¢ç´¢çŠ¶æ€å¿…é¡»ä¸ºï¼šæœªæ¢ç´¢ã€éƒ¨åˆ†æ¢ç´¢ã€å·²æ¢ç´¢'},{id:'map_importance_enum',name:'åœ°å›¾ç‚¹é‡è¦åº¦',description:'é‡è¦åº¦å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸–ç•Œåœ°å›¾ç‚¹',targetColumn:'é‡è¦åº¦',ruleType:'enum',config:{values:['æ ¸å¿ƒ','é‡è¦','æ™®é€š']},errorMessage:'é‡è¦åº¦å¿…é¡»ä¸ºï¼šæ ¸å¿ƒã€é‡è¦ã€æ™®é€š'},{id:'intel_importance_enum',name:'æƒ…æŠ¥é‡è¦åº¦',description:'é‡è¦åº¦å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦æƒ…æŠ¥',targetColumn:'é‡è¦åº¦',ruleType:'enum',config:{values:['æ ¸å¿ƒ','é‡è¦','æ™®é€š']},errorMessage:'é‡è¦åº¦å¿…é¡»ä¸ºï¼šæ ¸å¿ƒã€é‡è¦ã€æ™®é€š'},{id:'player_location_relation',name:'ä¸»è§’åœ°ç‚¹å…³è”',description:'ä¸»è§’æ‰€åœ¨åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨',enabled:!1,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'æ‰€åœ¨åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'æ‰€åœ¨åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'npc_location_relation',name:'NPCåœ°ç‚¹å…³è”',description:'NPCæ‰€åœ¨åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨',enabled:!1,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'æ‰€åœ¨åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'æ‰€åœ¨åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'element_location_relation',name:'å…ƒç´ åœ°ç‚¹å…³è”',description:'å…ƒç´ æ‰€åœ¨åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨çš„è¯¦ç»†åœ°ç‚¹',enabled:!1,builtin:!0,intercept:!1,targetTable:'åœ°å›¾å…ƒç´ è¡¨',targetColumn:'æ‰€åœ¨åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'æ‰€åœ¨åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'global_detail_location_relation',name:'å…¨å±€è¯¦ç»†åœ°ç‚¹å…³è”',description:'å½“å‰è¯¦ç»†åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨',enabled:!0,builtin:!0,intercept:!1,targetTable:'å…¨å±€æ•°æ®è¡¨',targetColumn:'å½“å‰è¯¦ç»†åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'å½“å‰è¯¦ç»†åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'player_base_attributes_keyvalue',name:'ä¸»è§’åŸºæœ¬å±æ€§',description:'åŸºæœ¬å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'åŸºç¡€å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'åŸºç¡€å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'player_special_attributes_keyvalue',name:'ä¸»è§’ç‰¹æœ‰å±æ€§',description:'ç‰¹æœ‰å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'ç‰¹æœ‰å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'ç‰¹æœ‰å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'player_relationships_keyvalue',name:'ä¸»è§’äººé™…å…³ç³»',description:'äººé™…å…³ç³»å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'äººé™…å…³ç³»',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'äººé™…å…³ç³»æ ¼å¼å¿…é¡»ä¸º"è§’è‰²å:å…³ç³»è¯;è§’è‰²å:å…³ç³»è¯"'},{id:'npc_base_attributes_keyvalue',name:'NPCåŸºæœ¬å±æ€§',description:'åŸºæœ¬å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'åŸºç¡€å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'åŸºç¡€å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'npc_special_attributes_keyvalue',name:'NPCç‰¹æœ‰å±æ€§',description:'ç‰¹æœ‰å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'ç‰¹æœ‰å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'ç‰¹æœ‰å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'npc_relationships_keyvalue',name:'NPCäººé™…å…³ç³»',description:'äººé™…å…³ç³»å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'äººé™…å…³ç³»',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'äººé™…å…³ç³»æ ¼å¼å¿…é¡»ä¸º"è§’è‰²å:å…³ç³»è¯;è§’è‰²å:å…³ç³»è¯"'},{id:'quest_progress_format',name:'ä»»åŠ¡è¿›åº¦æ ¼å¼',description:'è¿›åº¦å¿…é¡»ä¸ºæ•°å­—+%æ ¼å¼ï¼Œå¦‚50%',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'è¿›åº¦',ruleType:'format',config:{pattern:'^\\d+%$'},errorMessage:'è¿›åº¦å¿…é¡»ä¸ºæ•°å­—+%æ ¼å¼ï¼ˆå¦‚50%ã€100%ï¼‰'}],H='acu_filter_blacklist_v1',K='acu_filter_blacklist_version',G=['æ—¶é—´','åœ°ç‚¹','å¤‡å¿˜','æ€»ç»“','æ—¥æœŸ','é€‰é¡¹','ä»»åŠ¡','çºªè¦','æœè£…','å¤–è²Œ','å¤´åƒ','å¤–è²Œ','è¿›åº¦','ç¼–ç ','ä¸Šé™','ç»éªŒå€¼','æ¶ˆè€—','æ•°é‡','ç­‰çº§','ä½ç½®','ID','ç¼–å·','ä¸‰å›´','measurements','ages','å¹´é¾„','order','å·ç ','time','cost'],Q={getBlacklist(){const t=Ae.get(H,null),e=Ae.get(K,null);if(!t||!Array.isArray(t))return Ae.set(H,[...G]),Ae.set(K,T),[...G];if(!e||P(e,T)<0){console.log(`[DICE]BlacklistManager æ£€æµ‹åˆ°é»‘åå•ç‰ˆæœ¬è¾ƒæ—§ (${e||'æ— ç‰ˆæœ¬'})ï¼Œè‡ªåŠ¨åˆå¹¶æ–°ç‰ˆæœ¬`);new Set(t);const a=new Set(G),n=[...G];return t.forEach(t=>{a.has(t)||n.push(t)}),Ae.set(H,n),Ae.set(K,T),n}return t},setBlacklist:t=>Array.isArray(t)?(Ae.set(H,t),Ae.set(K,T),!0):(console.warn('[DICE]BlacklistManager è®¾ç½®å¤±è´¥ï¼šå¿…é¡»æ˜¯æ•°ç»„'),!1),resetToDefault:()=>(Ae.set(H,[...G]),Ae.set(K,T),!0),isBlacklisted(t){if(!t||'string'!=typeof t)return!1;const e=this.getBlacklist();if(0===e.length)return!1;const a=t.split(/>| > /).map(t=>t.trim()).filter(t=>t),n=a.length>0?a[a.length-1]:t;return e.some(t=>n.includes(t))}},Z='acu_validation_presets_v1',tt='acu_active_preset_id',et={_cache:null,getAllPresets(){const t=Ae.get(Z,null);if(!t)return this._initDefaultPreset(),this._cache;let e=!1;return t.forEach(t=>{if(!t.version||this._compareVersion(t.version,T)<0){console.log(`[DICE]PresetManager æ£€æµ‹åˆ°é¢„è®¾ "${t.name}" ç‰ˆæœ¬è¾ƒæ—§ (${t.version||'æ— ç‰ˆæœ¬'})ï¼Œè‡ªåŠ¨åˆå¹¶æ–°ç‰ˆæœ¬`);const a=t.rules.filter(t=>!t.builtin),n=new Set(X.map(t=>t.id||t.targetTable+'_'+t.ruleType)),o=[...X.map(t=>({...t,builtin:!0}))];a.forEach(t=>{const e=t.id||t.targetTable+'_'+t.ruleType;n.has(e)||o.push({...t,builtin:!1})}),t.rules=o,t.version=T,e=!0}}),e&&(this._save(t),at.clearCache(),this._cache=null),!e&&this._cache?this._cache:(this._cache=t,t)},getActivePreset(){const t=this.getAllPresets(),e=Ae.get(tt,'default');return t.find(t=>t.id===e)||t[0]},setActivePreset(t){return!!this.getAllPresets().find(e=>e.id===t)&&(Ae.set(tt,t),at.clearCache(),console.log('[DICE]PresetManager åˆ‡æ¢é¢„è®¾:',t),!0)},createPreset(t){const e=this.getAllPresets(),a={id:'preset_'+Date.now(),name:t||'æ–°é¢„è®¾',builtin:!1,rules:[],version:T,createdAt:(new Date).toISOString()};return e.push(a),this._save(e),a},duplicatePreset(t){const e=this.getAllPresets().find(e=>e.id===t);if(!e)return null;const a=this.getAllPresets(),n={id:'preset_'+Date.now(),name:e.name+' (å‰¯æœ¬)',builtin:!1,rules:JSON.parse(JSON.stringify(e.rules)),version:e.version||T,createdAt:(new Date).toISOString()};return a.push(n),this._save(a),console.log('[DICE]PresetManager å¤åˆ¶é¢„è®¾:',e.name,'->',n.name),n},deletePreset(t){const e=this.getAllPresets(),a=e.find(e=>e.id===t);if(!a||'default'===a.id)return!1;const n=e.filter(e=>e.id!==t);return this._save(n),Ae.get(tt)===t&&(Ae.set(tt,'default'),at.clearCache()),console.log('[DICE]PresetManager åˆ é™¤é¢„è®¾:',t),!0},updatePresetRules(t,e){const a=this.getAllPresets(),n=a.find(e=>e.id===t);return!!n&&(n.rules=e,this._save(a),at.clearCache(),!0)},exportPreset(t){const e=this.getAllPresets().find(e=>e.id===t);if(!e)return null;return JSON.stringify({format:'acu_preset_v1',version:T,preset:{name:e.name,rules:e.rules}},null,2)},_compareVersion:(t,e)=>P(t,e),mergePresetWithDefaults(t){const e=this.getAllPresets(),a=e.find(e=>e.id===t);if(!a)return!1;const n=a.rules.filter(t=>!t.builtin),o=new Set(X.map(t=>t.id||t.targetTable+'_'+t.ruleType)),i=new Map;X.forEach(t=>{const e=t.id||t.targetTable+'_'+t.ruleType;i.set(e,t)});const r=[],c=new Set;return X.forEach(t=>{const e=t.id||t.targetTable+'_'+t.ruleType,n=a.rules.find(t=>(t.id||t.targetTable+'_'+t.ruleType)===e&&t.builtin);if(n){JSON.stringify(n)!==JSON.stringify(t)?r.push({...n,builtin:!0}):r.push({...t,builtin:!0})}else r.push({...t,builtin:!0});c.add(e)}),n.forEach(t=>{const e=t.id||t.targetTable+'_'+t.ruleType;o.has(e)||r.push({...t,builtin:!1})}),a.rules=r,a.version=T,this._save(e),at.clearCache(),console.log('[DICE]PresetManager åˆå¹¶é¢„è®¾:',a.name),!0},importPreset(t,e=!1){try{const a=JSON.parse(t);if('acu_preset_v1'!==a.format||!a.preset)return null;const n=a.version||'0.0.0',o=this._compareVersion(n,T)<0,i=this.getAllPresets(),r={id:'imported_'+Date.now(),name:a.preset.name||'å¯¼å…¥çš„é¢„è®¾',builtin:!1,rules:a.preset.rules||[],version:n,createdAt:(new Date).toISOString()};return o&&e?(i.push(r),this._save(i),this.mergePresetWithDefaults(r.id),console.log('[DICE]PresetManager å¯¼å…¥å¹¶åˆå¹¶é¢„è®¾:',r.name)):(i.push(r),this._save(i),console.log('[DICE]PresetManager å¯¼å…¥é¢„è®¾:',r.name),o&&console.warn('[DICE]PresetManager é¢„è®¾ç‰ˆæœ¬è¾ƒæ—§ï¼Œå»ºè®®ä½¿ç”¨ mergePresetWithDefaults æ–¹æ³•åˆå¹¶æ–°ç‰ˆæœ¬çš„é»˜è®¤å€¼')),{preset:r,needsMerge:o&&!e}}catch(t){return console.error('[DICE]PresetManager å¯¼å…¥å¤±è´¥:',t),null}},_getBuiltinRulesVersion(){try{const t=JSON.stringify(X);let e=0;for(let a=0;a<t.length;a++){e=(e<<5)-e+t.charCodeAt(a),e&=e}return e.toString(36)}catch(t){return console.error('[DICE]PresetManager è®¡ç®—ç‰ˆæœ¬å¤±è´¥:',t),'0'}},_initDefaultPreset(){const t=this._getBuiltinRulesVersion(),e=Ae.get(Z,null);if(e&&Array.isArray(e)){const a=e.find(t=>'default'===t.id);if(a&&a._builtinVersion!==t){console.log('[DICE]PresetManager æ£€æµ‹åˆ°å†…ç½®è§„åˆ™æ›´æ–°ï¼Œè‡ªåŠ¨æ›´æ–°é»˜è®¤é¢„è®¾');const n=a.rules.filter(t=>!t.builtin);return a.rules=[...X.map(t=>({...t})),...n],a._builtinVersion=t,this._cache=e,this._save(e),void Ae.set(tt,'default')}}const a={id:'default',name:'é»˜è®¤é¢„è®¾',builtin:!0,rules:X.map(t=>({...t})),version:T,_builtinVersion:t,createdAt:(new Date).toISOString()},n=Ae.get('acu_validation_rules_v1',[]);n.length>0&&(a.rules.push(...n.map(t=>({...t,builtin:!1}))),console.log('[DICE]PresetManager è¿ç§»æ—§è§„åˆ™:',n.length,'æ¡')),this._cache=[a],this._save(this._cache),Ae.set(tt,'default')},resetDefaultPreset(){const t=this.getAllPresets(),e=t.find(t=>'default'===t.id);if(e){const a=e.rules.filter(t=>!t.builtin);return e.rules=[...X.map(t=>({...t})),...a],e._builtinVersion=this._getBuiltinRulesVersion(),this._save(t),at.clearCache(),!0}return!1},_save(t){Ae.set(Z,t),this._cache=t},clearCache(){this._cache=null}},at={_cache:null,_enabledCache:null,getAllRules(){if(this._cache)return this._cache;const t=et.getActivePreset(),e=this.getEnabledStates(),a=(t?.rules||[]).map(t=>({...t,enabled:void 0!==e[t.id]?e[t.id]:t.enabled}));return this._cache=a,a},getEnabledStates(){return this._enabledCache||(this._enabledCache=Ae.get(Y,{})),this._enabledCache},toggleRuleEnabled(t,e){const a=this.getEnabledStates();a[t]=e,Ae.set(Y,a),this._enabledCache=a,this._cache=null},toggleRuleIntercept(t,e){const a=et.getActivePreset();if(!a)return!1;const n=a.rules.find(e=>e.id===t);return!!n&&(n.intercept=e,et.updatePresetRules(a.id,a.rules),!0)},getEnabledRules(){return this.getAllRules().filter(t=>t.enabled)},addCustomRule(t){if(!t.id||!t.name||!t.targetTable)return console.error('[DICE]ValidationRuleManager è§„åˆ™ç¼ºå°‘å¿…è¦å­—æ®µ'),!1;const e=et.getActivePreset();if(!e)return!1;if(e.rules.some(e=>e.id===t.id))return console.error('[DICE]ValidationRuleManager è§„åˆ™ ID å·²å­˜åœ¨:',t.id),!1;const a={...t,builtin:!1,enabled:!0};return e.rules.push(a),et.updatePresetRules(e.id,e.rules),console.log('[DICE]ValidationRuleManager æ·»åŠ è§„åˆ™:',a.name),!0},removeCustomRule(t){const e=et.getActivePreset();if(!e)return!1;const a=e.rules.findIndex(e=>e.id===t);if(-1===a)return!1;e.rules.splice(a,1),et.updatePresetRules(e.id,e.rules);const n=this.getEnabledStates();return delete n[t],Ae.set(Y,n),this._enabledCache=n,console.log('[DICE]ValidationRuleManager åˆ é™¤è§„åˆ™:',t),!0},updateCustomRule(t,e){const a=et.getActivePreset();if(!a)return!1;const n=a.rules.findIndex(e=>e.id===t);return-1!==n&&(a.rules[n]={...a.rules[n],...e,id:t},et.updatePresetRules(a.id,a.rules),!0)},getRule(t){return this.getAllRules().find(e=>e.id===t)},clearCache(){this._cache=null,this._enabledCache=null},getRulesByTable(t){return this.getEnabledRules().filter(e=>e.targetTable===t)}},nt={_cache:null,_enabledCache:null,_generateId:()=>`regex_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,getAllRules(){if(this._cache)return this._cache;const t=Ae.get(L,[]),e=this.getEnabledStates(),a=t.map(t=>({...t,enabled:void 0!==e[t.id]?e[t.id]:t.enabled}));return this._cache=a,a},getEnabledStates(){return this._enabledCache||(this._enabledCache=Ae.get(q,{})),this._enabledCache},_saveEnabledStates(t){Ae.set(q,t),this._enabledCache=t},getEnabledRules(){return this.getAllRules().filter(t=>!1!==t.enabled)},getApplicableRules(t,e){return this.getEnabledRules().filter(a=>{switch(a.scope.type){case'global':return!0;case'table':return a.scope.tableNames&&a.scope.tableNames.includes(t);case'column':return a.scope.tableNames&&a.scope.tableNames.includes(t)&&a.scope.columnNames&&a.scope.columnNames.includes(e);default:return!1}}).sort((t,e)=>e.priority-t.priority)},toggleRuleEnabled(t,e){const a=this.getEnabledStates();a[t]=e,this._saveEnabledStates(a),this.clearCache()},addCustomRule(t){const e=Ae.get(L,[]);if(!t.name||!t.pattern||!t.scope)return console.error('[DICE]RegexTransformationManager: è§„åˆ™ç¼ºå°‘å¿…å¡«å­—æ®µ'),!1;const a={id:this._generateId(),name:t.name,description:t.description,operation:t.operation||'replace',pattern:t.pattern,flags:t.flags||{},replacement:t.replacement,scope:t.scope,enabled:void 0===t.enabled||t.enabled,priority:t.priority||50,executeMode:t.executeMode||'auto',testCases:t.testCases||[],security:t.security||{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4},createdAt:Date.now(),updatedAt:Date.now()};return e.push(a),Ae.set(L,e),this.clearCache(),this._syncRulesToActivePreset(),a},_syncRulesToActivePreset(){const t=ot.getActivePreset();if(t){const e=Ae.get(L,[]);ot.updatePresetRules(t.id,e)}},removeRule(t){const e=Ae.get(L,[]),a=e.findIndex(e=>e.id===t);return-1!==a&&(e.splice(a,1),Ae.set(L,e),this.clearCache(),this._syncRulesToActivePreset(),!0)},updateRule(t,e){const a=Ae.get(L,[]),n=a.findIndex(e=>e.id===t);return-1!==n&&(a[n]={...a[n],...e,id:t,updatedAt:Date.now()},Ae.set(L,a),this.clearCache(),this._syncRulesToActivePreset(),!0)},getRule(t){return this.getAllRules().find(e=>e.id===t)},clearCache(){this._cache=null,this._enabledCache=null}},ot={_cache:null,getAllPresets(){if(this._cache)return this._cache;const t=Ae.get(U,[]);if(0===t.length){const e={id:'regex_default',name:'é»˜è®¤é¢„è®¾',description:'ç³»ç»Ÿé»˜è®¤çš„æ­£åˆ™è½¬æ¢è§„åˆ™é¢„è®¾',version:'1.0.0',rules:[],createdAt:Date.now(),updatedAt:Date.now()};t.push(e),Ae.set(U,t)}return this._cache=t,t},getActivePreset(){const t=Ae.get(V,'regex_default'),e=this.getAllPresets();return e.find(e=>e.id===t)||e[0]},setActivePreset(t){return this.getAllPresets().find(e=>e.id===t)?(Ae.set(V,t),nt.clearCache(),!0):(console.error('[DICE]RegexPresetManager: é¢„è®¾ä¸å­˜åœ¨',t),!1)},createPreset(t,e){const a=this.getAllPresets();if(a.some(e=>e.name===t))return console.error('[DICE]RegexPresetManager: é¢„è®¾åç§°å·²å­˜åœ¨',t),!1;const n=e?a.find(t=>t.id===e):this.getActivePreset(),o={id:`regex_preset_${Date.now()}`,name:t,description:n?.description,version:'1.0.0',rules:n?JSON.parse(JSON.stringify(n.rules)):[],createdAt:Date.now(),updatedAt:Date.now()};return a.push(o),this._save(a),o},updatePresetRules(t,e){const a=this.getAllPresets(),n=a.findIndex(e=>e.id===t);return-1!==n&&(a[n].rules=JSON.parse(JSON.stringify(e)),a[n].updatedAt=Date.now(),this._save(a),t===Ae.get(V)&&nt.clearCache(),!0)},deletePreset(t){const e=this.getAllPresets();if(e.length<=1)return console.error('[DICE]RegexPresetManager: ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªé¢„è®¾'),!1;const a=e.findIndex(e=>e.id===t);return-1!==a&&(e.splice(a,1),this._save(e),t===Ae.get(V)&&this.setActivePreset(e[0].id),!0)},exportPreset(t){const e=this.getAllPresets().find(e=>e.id===t);if(!e)return null;const a=this.getActivePreset(),n=a&&a.id===t?Ae.get(L,[]):e.rules,o={...e,rules:n};return JSON.stringify(o,null,2)},importPreset(t){try{const e=JSON.parse(t);if(!e.name||!Array.isArray(e.rules))return console.error('[DICE]RegexPresetManager: é¢„è®¾æ ¼å¼æ— æ•ˆ'),!1;const a=this.getAllPresets(),n={id:`regex_preset_${Date.now()}`,name:e.name,description:e.description,version:e.version||'1.0.0',rules:e.rules.map(t=>({...t,id:nt._generateId()})),createdAt:Date.now(),updatedAt:Date.now()};return a.push(n),this._save(a),n}catch(t){return console.error('[DICE]RegexPresetManager: å¯¼å…¥é¢„è®¾å¤±è´¥',t),!1}},_save(t){Ae.set(U,t),this._cache=t},clearCache(){this._cache=null}},it={_regexCache:new Map,_buildFlags(t){const e=[];return t.caseInsensitive&&e.push('i'),t.global&&e.push('g'),t.multiline&&e.push('m'),t.unicode&&e.push('u'),t.sticky&&e.push('y'),e.join('')},_getRegex(t,e){const a=t.includes('(?<')||t.includes('(?<='),n=t.includes('(?=')||t.includes('(?!');(a||n)&&!e.unicode&&(e={...e,unicode:!0});const o=this._buildFlags(e),i=`${t}/${o}`;if(this._regexCache.has(i)){const t=this._regexCache.get(i);return t.lastIndex=0,t}try{const e=new RegExp(t,o);return this._regexCache.set(i,e),e}catch(e){return console.error('[DICE]RegexTransformationEngine: æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯',t,e),null}},_scoreRegexComplexity(t){let e=0;/(\*|\+|\{)\1{2,}/.test(t)&&(e+=50),/(\.\*|\.\+)[^\[]*\1/.test(t)&&(e+=30);const a=(t.match(/\(/g)||[]).length;return e+=Math.min(5*a,20),e},_getTimeoutForRule(t){const e=this._scoreRegexComplexity(t.pattern),a=t.security?.maxMatchTime||100;return Math.max(a-2*e,50)},_safeReplace(t,e,a){const n=t,o=e.security?.maxInputLength||1e4;if(t.length>o)return{success:!1,oldValue:n,newValue:n,matched:!1,error:`è¾“å…¥é•¿åº¦è¶…è¿‡é™åˆ¶(${o})`};try{const o=this._getTimeoutForRule(e),i=Date.now();let r;switch(e.operation){case'replace':r=t.replace(a,e.replacement||'');break;case'delete':r=t.replace(a,'');break;case'validate':a.test(t);r=t;break;default:r=t}const c=Date.now()-i;if(c>o)return console.warn('[DICE]RegexTransformationEngine: æ­£åˆ™åŒ¹é…è¶…æ—¶',e.pattern,c),{success:!1,oldValue:n,newValue:n,matched:!1,error:`åŒ¹é…è¶…æ—¶(${c}ms > ${o}ms)`};return{success:!0,oldValue:n,newValue:r,matched:n!==r||a.test(n)}}catch(t){return console.error('[DICE]RegexTransformationEngine: æ­£åˆ™æ›¿æ¢é”™è¯¯',e.pattern,t),{success:!1,oldValue:n,newValue:n,matched:!1,error:String(t)}}},applyToValue(t,e){if(null==t)return{success:!0,oldValue:'',newValue:'',matched:!1};const a=String(t);let n=e.pattern,o=e.flags||{};const i=this._extractFlags(n);i.patternWithoutFlags!==n&&(n=i.patternWithoutFlags,o={...o,...i.flags}),void 0===o.global&&(o.global=!0);const r=this._getRegex(n,o);return r?this._safeReplace(a,e,r):{success:!1,oldValue:a,newValue:a,matched:!1,error:'æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼'}},_extractFlags(t){const e={global:!1,caseInsensitive:!1,multiline:!1,unicode:!1,sticky:!1},a=t.match(/^\/(.+)\/([gimuy]*)$/);if(a){const[,t,n]=a;return n.includes('g')&&(e.global=!0),n.includes('i')&&(e.caseInsensitive=!0),n.includes('m')&&(e.multiline=!0),n.includes('u')&&(e.unicode=!0),n.includes('y')&&(e.sticky=!0),{flags:e,patternWithoutFlags:t}}return{flags:e,patternWithoutFlags:t}},applyToTable(t,e){let a=0;const n=[];try{let o=!1,i=new Map;if('name'in t&&'headers'in t&&'rows'in t){o=!0;const e=t;i.set(e.name,{sheet:e,sheetKey:e.name,name:e.name,headers:e.headers,contentRowIndex:-1})}else{const e=t;Object.keys(e).forEach(t=>{if(!t.startsWith('sheet_'))return;const a=e[t];if(!a||!a.content||!Array.isArray(a.content)||a.content.length<1)return void console.warn(`[DICE]applyToTable: è·³è¿‡æ— æ•ˆè¡¨æ ¼ ${t}`);const n=a.name||t;i.set(n,{sheet:a,sheetKey:t,name:n,headers:a.content[0]||[],contentRowIndex:0})})}if(0===i.size)return console.warn('[DICE]applyToTable: æ²¡æœ‰æœ‰æ•ˆçš„è¡¨æ ¼æ•°æ®'),{totalApplied:0,errors:['æ²¡æœ‰æœ‰æ•ˆçš„è¡¨æ ¼æ•°æ®']};for(const[t,r]of i.entries()){const{sheet:i,headers:c,contentRowIndex:s}=r;for(const r of e){if(!r.enabled)continue;const e=r.scope;if('global'===e.type||e.tableNames?.includes(t))try{if(o){const o=i.rows;for(let i=0;i<o.length;i++){const s=o[i];for(let o=0;o<s.length;o++){const i=c[o];if('column'===e.type&&!e.columnNames?.includes(i))continue;const l=this.applyToValue(s[o],r);l.success?l.matched&&(s[o]=l.newValue,a++):n.push(`${r.name} [${t}]: ${l.error}`)}}}else{const o=i.content;for(let i=1;i<o.length;i++){const s=o[i];if(Array.isArray(s))for(let o=0;o<s.length;o++){const l=c[o];if('column'===e.type&&!e.columnNames?.includes(l))continue;const u=s[o],d=this.applyToValue(u,r);d.success?d.matched&&(s[o]=d.newValue,a++,console.debug(`[DICE]æ­£åˆ™è½¬æ¢: ${t}[${i}].${l}`,`"${d.oldValue}" -> "${d.newValue}"`)):n.push(`${r.name} [${t}]: ${d.error}`)}}}}catch(e){const a=e instanceof Error?e.message:String(e);console.error(`[DICE]applyToTable: å¤„ç†è¡¨æ ¼ ${t} æ—¶å‡ºé”™:`,e),n.push(`${r.name} [${t}]: å¤„ç†è¡¨æ ¼æ—¶å‡ºé”™ - ${a}`)}}}a>0&&console.info(`[DICE]applyToTable: æˆåŠŸåº”ç”¨ ${a} å¤„è½¬æ¢`),n.length>0&&console.warn(`[DICE]applyToTable: é‡åˆ° ${n.length} ä¸ªé”™è¯¯`)}catch(t){const e=t instanceof Error?t.message:String(t);console.error('[DICE]applyToTable: æ‰§è¡Œå¤±è´¥:',t),n.push(`æ‰§è¡Œå¤±è´¥: ${e}`)}return{totalApplied:a,errors:n}},applyToCell(t,e,a,n){const o=nt.getApplicableRules(e,a);if(0===o.length)return{success:!0,oldValue:t||'',newValue:t||'',matched:!1};let i=o;if(n&&(i=o.filter(t=>t.executeMode===n||'auto'===t.executeMode)),0===i.length)return{success:!0,oldValue:t||'',newValue:t||'',matched:!1};let r=t||'',c=!1;for(const t of i){const e=this.applyToValue(r,t);if(!e.success)return e;e.matched&&(c=!0),r=e.newValue}return{success:!0,oldValue:t||'',newValue:r,matched:c}},applyToRow(t,e,a,n){return t.map((t,o)=>{const i=e[o];return this.applyToCell(t,a,i,n).newValue})},previewBatchTransform(t,e){const a=t.name,n=nt.getApplicableRules(a,null).filter(t=>'global'===t.scope.type||t.scope.tableNames?.includes(a)),o=[];for(const e of n){const n=[];let i=0;for(let o=0;o<t.rows.length;o++){const r=t.rows[o];for(let c=0;c<r.length;c++){const s=t.headers[c],l=r[c];if('column'===e.scope.type){if(!e.scope.columnNames?.includes(s)||!e.scope.tableNames?.includes(a))continue}else if('table'===e.scope.type&&!e.scope.tableNames?.includes(a))continue;const u=this.applyToValue(l,e);u.matched&&u.oldValue!==u.newValue&&(n.push({tableName:a,rowIndex:o,columnIndex:c,columnName:s,oldValue:u.oldValue,newValue:u.newValue}),i++)}}i>0&&o.push({rule:e,affectedCells:n,totalAffected:i})}return o},clearRegexCache(){this._regexCache.clear()}},rt={validateFormat(t,e){if(null==t||''===t)return!0;try{return new RegExp(e).test(String(t))}catch(t){return console.error('[DICE]ValidationEngine æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯:',e,t),!0}},validateEnum:(t,e)=>null==t||''===t||(!Array.isArray(e)||0===e.length||e.includes(String(t))),validateNumeric(t,e,a){if(null==t||''===t)return!0;const n=String(t);let o;if(n.endsWith('%'))o=parseFloat(n);else if(n.includes('/')){const t=n.split('/');o=parseFloat(t[0])}else if(n.includes(':')){const t=n.split(':');o=parseFloat(t[t.length-1])}else o=parseFloat(n);return!isNaN(o)&&(!(null!=e&&o<e)&&!(null!=a&&o>a))},validateRelation(t,e,a,n){if(null==t||''===t)return!0;if(!e||!a||!n)return!0;let o=null;for(const t in e)if(e[t]?.name===a){o=e[t];break}if(!o||!o.content||o.content.length<2)return!0;const i=o.content[0],r=String(t),c=Array.isArray(n)?n:[n];for(const t of c){const e=i.indexOf(t);if(-1!==e)for(let t=1;t<o.content.length;t++)if(String(o.content[t][e]||'')===r)return!0}return 0===c.length},validateRequired:t=>null!=t&&''!==String(t).trim(),validateKeyValue(t,e){if(null==t||''===t)return!0;const a=e?.valueType||'text',n=e?.valueMin,o=e?.valueMax;let i=String(t);i=i.replace(/ï¼š/g,':').replace(/ï¼›/g,';').replace(/ï¼Œ/g,';'),i=i.replace(/\s+/g,'');const r=i.split(';').filter(t=>t.trim());if(0===r.length)return!1;for(const t of r){const e=t.indexOf(':');if(-1===e||0===e||e===t.length-1)return!1;const i=t.substring(0,e),r=t.substring(e+1);if(!i||!r)return!1;if('numeric'===a){if(!/^-?\d+(\.\d+)?$/.test(r.trim()))return!1;const t=parseFloat(r);if(isNaN(t))return!1;if(null!=n&&t<n)return!1;if(null!=o&&t>o)return!1}}return!0},validateTableReadonly:(t,e)=>!t||!e||JSON.stringify(t)===JSON.stringify(e),validateRowLimit:(t,e,a)=>!(null!=e&&t<e)&&!(null!=a&&t>a),validateSequence(t,e,a){if(!t||!t.content||t.content.length<2)return!0;if(!e||!a)return!0;const n=t.content[0]||[],o=t.content.slice(1)||[],i=n.indexOf(e);if(i<0)return!0;const r=a.prefix||'',c=void 0!==a.startFrom?a.startFrom:1,s=[],l=[];for(let t=0;t<o.length;t++){const e=o[t]?.[i];if(l.push({rowIndex:t,rawValue:e,type:typeof e}),null==e||''===e)continue;const a=String(e).trim();if(a)if(r){const e=r.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),n=new RegExp(`^${e}(\\d+)$`),o=a.match(n);if(o){const e=parseInt(o[1],10);isNaN(e)||s.push({rowIndex:t,value:a,num:e})}}else{const e=parseInt(a,10);isNaN(e)||s.push({rowIndex:t,value:a,num:e})}}if(0===s.length)return!0;s.sort((t,e)=>t.rowIndex-e.rowIndex);if(new Set(s.map(t=>t.num)).size!==s.length)return!1;for(let t=0;t<s.length;t++){const e=c+t;if(s[t].num!==e)return!1}return!0},checkTableRules(t,e,a){const n=[];if(!t||!e||!a)return n;for(const o of a){if(!o.enabled||!o.intercept)continue;const a=W[o.ruleType];if(!a)continue;let i=null,r=null;for(const e in t)if(t[e]?.name===o.targetTable){i=t[e];break}for(const t in e)if(e[t]?.name===o.targetTable){r=e[t];break}if(r)if('table'===a.scope)if('tableReadonly'===o.ruleType)this.validateTableReadonly(i?.content,r?.content)||n.push({rule:o,tableName:o.targetTable,message:o.errorMessage||`è¡¨ "${o.targetTable}" ä¸ºåªè¯»ï¼Œä¸å…è®¸ä¿®æ”¹`});else if('rowLimit'===o.ruleType){const t=(r.content?.length||1)-1;this.validateRowLimit(t,o.config?.min,o.config?.max)||n.push({rule:o,tableName:o.targetTable,message:o.errorMessage||`è¡¨ "${o.targetTable}" è¡Œæ•° ${t} è¶…å‡ºé™åˆ¶ (${o.config?.min||0}-${o.config?.max||'âˆ'})`})}else'sequence'===o.ruleType&&o.targetColumn&&(this.validateSequence(r,o.targetColumn,o.config||{})||n.push({rule:o,tableName:o.targetTable,message:o.errorMessage||`å­—æ®µ "${o.targetColumn}" çš„ç¼–ç ç´¢å¼•å¿…é¡»ä»${o.config?.prefix||''}${String(o.config?.startFrom||1).padStart(4,'0')}å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤`}));else if('field'===a.scope&&o.targetColumn){const t=(r.content?.[0]||[]).indexOf(o.targetColumn);if(-1===t)continue;for(let a=1;a<(r.content?.length||0);a++){const i=r.content[a],c=i?.[t];if(!this.validateValue(c,o,e)){n.push({rule:o,tableName:o.targetTable,rowIndex:a,columnName:o.targetColumn,currentValue:String(c??''),message:o.errorMessage||`å­—æ®µ "${o.targetColumn}" éªŒè¯å¤±è´¥`});break}}}}return n},validateValue(t,e,a){switch(e.ruleType){case'format':return this.validateFormat(t,e.config?.pattern);case'enum':return this.validateEnum(t,e.config?.values);case'numeric':return this.validateNumeric(t,e.config?.min,e.config?.max);case'relation':return this.validateRelation(t,a,e.config?.refTable,e.config?.refColumn);case'required':return this.validateRequired(t);case'keyValue':return this.validateKeyValue(t,e.config);default:return!0}},validateRow(t,e,a,n,o,i){const r=[],c=t[1]||t[0]||`è¡Œ ${n+1}`;for(const s of o){if(s.targetTable!==a)continue;if(!s.enabled)continue;const o=e.indexOf(s.targetColumn);if(-1===o)continue;const l=t[o];this.validateValue(l,s,i)||r.push({ruleId:s.id,ruleName:s.name,ruleType:s.ruleType,rule:s,tableName:a,rowIndex:n,columnName:s.targetColumn,currentValue:String(l??''),rowTitle:c,errorMessage:s.errorMessage,severity:'error'})}return r},validateAllData(t){if(!t)return[];const e=at.getEnabledRules();if(0===e.length)return[];const a=[];for(const n in t){if(!n.startsWith('sheet_'))continue;const o=t[n];if(!o?.name||!o?.content||o.content.length<2)continue;const i=o.name,r=o.content[0],c=e.filter(t=>t.targetTable===i);if(0===c.length)continue;for(const t of c){const e=W[t.ruleType];if('table'===e?.scope)if('rowLimit'===t.ruleType){const e=o.content.length-1;this.validateRowLimit(e,t.config?.min,t.config?.max)||a.push({ruleId:t.id,ruleName:t.name,ruleType:t.ruleType,rule:t,tableName:i,rowIndex:-1,columnName:'',currentValue:`${e} è¡Œ`,errorMessage:t.errorMessage||`è¡Œæ•° ${e} è¶…å‡ºé™åˆ¶ (${t.config?.min||0}-${t.config?.max||'âˆ'})`,severity:'warning'})}else if('sequence'===t.ruleType&&t.targetColumn){if(!this.validateSequence(o,t.targetColumn,t.config||{})){const e={ruleId:t.id,ruleName:t.name,ruleType:t.ruleType,rule:t,tableName:i,rowIndex:-1,columnName:t.targetColumn,currentValue:'',errorMessage:t.errorMessage||`å­—æ®µ "${t.targetColumn}" çš„ç¼–ç ç´¢å¼•å¿…é¡»ä»${t.config?.prefix||''}${String(t.config?.startFrom||1).padStart(4,'0')}å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤`,severity:'error'};a.push(e)}}}const s=c.filter(t=>'table'!==W[t.ruleType]?.scope);for(let e=1;e<o.content.length;e++){const n=o.content[e],c=this.validateRow(n,r,i,e-1,s,t);a.push(...c)}}return a},validateTable(t,e){if(!t)return[];const a=at.getRulesByTable(e);if(0===a.length)return[];let n=null;for(const a in t)if(t[a]?.name===e){n=t[a];break}if(!n||!n.content||n.content.length<2)return[];const o=n.content[0],i=[];for(let r=1;r<n.content.length;r++){const c=n.content[r],s=this.validateRow(c,o,e,r-1,a,t);i.push(...s)}return i},groupErrorsByTable(t){const e={};for(const a of t)e[a.tableName]||(e[a.tableName]=[]),e[a.tableName].push(a);return e},getErrorCount(t){return this.validateAllData(t).length}},ct={DB_NAME:'acu_local_avatars',STORE_NAME:'avatars',DB_VERSION:1,_db:null,_urlCache:new Map,async init(){return this._db?this._db:new Promise((t,e)=>{const a=indexedDB.open(this.DB_NAME,this.DB_VERSION);a.onerror=()=>{console.error('[DICE]LocalAvatarDB æ‰“å¼€æ•°æ®åº“å¤±è´¥:',a.error),e(a.error)},a.onsuccess=()=>{this._db=a.result,t(this._db)},a.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.STORE_NAME)||e.createObjectStore(this.STORE_NAME,{keyPath:'name'})}})},async save(t,e){if(!t||!e)return!1;try{const a=await this.init();return new Promise((n,o)=>{const i=a.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME);this._urlCache.has(t)&&(URL.revokeObjectURL(this._urlCache.get(t)),this._urlCache.delete(t));const r={name:t,blob:e,size:e.size,type:e.type,updatedAt:Date.now()},c=i.put(r);c.onsuccess=()=>n(!0),c.onerror=()=>{console.error('[DICE]LocalAvatarDB ä¿å­˜å¤±è´¥:',c.error),o(c.error)}})}catch(t){return console.error('[DICE]LocalAvatarDB save error:',t),!1}},async get(t){if(!t)return null;if(this._urlCache.has(t))return this._urlCache.get(t);try{const e=await this.init();return new Promise(a=>{const n=e.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).get(t);n.onsuccess=()=>{const e=n.result;if(e&&e.blob){const n=URL.createObjectURL(e.blob);this._urlCache.set(t,n),a(n)}else a(null)},n.onerror=()=>a(null)})}catch(t){return console.error('[DICE]LocalAvatarDB get error:',t),null}},async has(t){if(!t)return!1;try{const e=await this.init();return new Promise(a=>{const n=e.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getKey(t);n.onsuccess=()=>a(void 0!==n.result),n.onerror=()=>a(!1)})}catch(t){return!1}},async delete(t){if(!t)return!1;try{this._urlCache.has(t)&&(URL.revokeObjectURL(this._urlCache.get(t)),this._urlCache.delete(t));const e=await this.init();return new Promise(a=>{const n=e.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).delete(t);n.onsuccess=()=>a(!0),n.onerror=()=>a(!1)})}catch(t){return console.error('[DICE]LocalAvatarDB delete error:',t),!1}},async getAllNames(){try{const t=await this.init();return new Promise(e=>{const a=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAllKeys();a.onsuccess=()=>e(a.result||[]),a.onerror=()=>e([])})}catch(t){return[]}},async getStats(){try{const t=await this.init();return new Promise(e=>{const a=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAll();a.onsuccess=()=>{const t=a.result||[],n=t.reduce((t,e)=>t+(e.size||0),0);e({count:t.length,totalSize:n,totalSizeMB:(n/1024/1024).toFixed(2)})},a.onerror=()=>e({count:0,totalSize:0,totalSizeMB:'0'})})}catch(t){return{count:0,totalSize:0,totalSizeMB:'0'}}},async clearAll(){try{this._urlCache.forEach(t=>URL.revokeObjectURL(t)),this._urlCache.clear();const t=await this.init();return new Promise(e=>{const a=t.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).clear();a.onsuccess=()=>e(!0),a.onerror=()=>e(!1)})}catch(t){return console.error('[DICE]LocalAvatarDB clearAll error:',t),!1}}},st={DB_NAME:'acu_favorites',STORE_NAME:'items',DB_VERSION:1,_db:null,async init(){return this._db?this._db:new Promise((t,e)=>{const a=indexedDB.open(this.DB_NAME,this.DB_VERSION);a.onerror=()=>{console.error('[DICE]FavoritesDB æ‰“å¼€æ•°æ®åº“å¤±è´¥:',a.error),e(a.error)},a.onsuccess=()=>{this._db=a.result,t(this._db)},a.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains(this.STORE_NAME)||e.createObjectStore(this.STORE_NAME,{keyPath:'id'})}})},async add(t){if(!t||!t.id)return!1;try{const e=await this.init();return new Promise((a,n)=>{const o=e.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).add(t);o.onsuccess=()=>a(!0),o.onerror=()=>{console.error('[DICE]FavoritesDB add å¤±è´¥:',o.error),n(o.error)}})}catch(t){return console.error('[DICE]FavoritesDB add error:',t),!1}},async get(t){if(!t)return null;try{const e=await this.init();return new Promise(a=>{const n=e.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).get(t);n.onsuccess=()=>{a(n.result||null)},n.onerror=()=>a(null)})}catch(t){return console.error('[DICE]FavoritesDB get error:',t),null}},async update(t,e){if(!t)return!1;try{const a=await this.get(t);if(!a)return!1;const n={...a,...e,id:a.id,updatedAt:Date.now()},o=await this.init();return new Promise((t,e)=>{const a=o.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).put(n);a.onsuccess=()=>t(!0),a.onerror=()=>{console.error('[DICE]FavoritesDB update å¤±è´¥:',a.error),e(a.error)}})}catch(t){return console.error('[DICE]FavoritesDB update error:',t),!1}},async delete(t){if(!t)return!1;try{const e=await this.init();return new Promise(a=>{const n=e.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).delete(t);n.onsuccess=()=>a(!0),n.onerror=()=>a(!1)})}catch(t){return console.error('[DICE]FavoritesDB delete error:',t),!1}},async getAll(){try{const t=await this.init();return new Promise(e=>{const a=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAll();a.onsuccess=()=>e(a.result||[]),a.onerror=()=>e([])})}catch(t){return console.error('[DICE]FavoritesDB getAll error:',t),[]}},async getAllTags(){try{const t=await this.getAll(),e=new Set;for(const a of t)if(a.tags&&Array.isArray(a.tags))for(const t of a.tags)t&&e.add(t);return Array.from(e).sort()}catch(t){return console.error('[DICE]FavoritesDB getAllTags error:',t),[]}},async getByTag(t){if(!t)return[];try{return(await this.getAll()).filter(e=>e.tags&&e.tags.includes(t))}catch(t){return console.error('[DICE]FavoritesDB getByTag error:',t),[]}},async clear(){try{const t=await this.init();return new Promise(e=>{const a=t.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).clear();a.onsuccess=()=>e(!0),a.onerror=()=>e(!1)})}catch(t){return console.error('[DICE]FavoritesDB clear error:',t),!1}},async count(){try{const t=await this.init();return new Promise(e=>{const a=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).count();a.onsuccess=()=>e(a.result||0),a.onerror=()=>e(0)})}catch(t){return console.error('[DICE]FavoritesDB count error:',t),0}}},lt={async addFavorite(t,e,a,n,o=[]){try{const i=SillyTavern.getCurrentChatId()||'',r={id:crypto.randomUUID(),header:a,rowData:n,tags:o,createdAt:Date.now(),updatedAt:Date.now(),sourceInfo:{tableUid:t,tableName:e,chatId:i}};return await st.add(r)?(console.log('[DICE]FavoritesManager æ·»åŠ æ”¶è—:',r.id),r):null}catch(t){return console.error('[DICE]FavoritesManager addFavorite error:',t),null}},async updateFavorite(t,e){try{const a=await st.update(t,e);return a&&console.log('[DICE]FavoritesManager æ›´æ–°æ”¶è—:',t),a}catch(t){return console.error('[DICE]FavoritesManager updateFavorite error:',t),!1}},async duplicateFavorite(t){try{const e=await st.get(t);if(!e)return null;const a={...e,id:crypto.randomUUID(),createdAt:Date.now(),updatedAt:Date.now()};return await st.add(a)?(console.log('[DICE]FavoritesManager å¤åˆ¶æ”¶è—:',t,'->',a.id),a):null}catch(t){return console.error('[DICE]FavoritesManager duplicateFavorite error:',t),null}},async deleteFavorite(t){try{const e=await st.delete(t);return e&&console.log('[DICE]FavoritesManager åˆ é™¤æ”¶è—:',t),e}catch(t){return console.error('[DICE]FavoritesManager deleteFavorite error:',t),!1}},async addTag(t,e){try{const a=await st.get(t);return!!a&&(!!a.tags.includes(e)||(a.tags.push(e),await st.update(t,{tags:a.tags})))}catch(t){return console.error('[DICE]FavoritesManager addTag error:',t),!1}},async removeTag(t,e){try{const a=await st.get(t);if(!a)return!1;const n=a.tags.indexOf(e);return!(n>-1)||(a.tags.splice(n,1),await st.update(t,{tags:a.tags}))}catch(t){return console.error('[DICE]FavoritesManager removeTag error:',t),!1}},getAllTags:async()=>await st.getAllTags(),getAll:async()=>await st.getAll(),getByTag:async t=>await st.getByTag(t),getById:async t=>await st.get(t),findCompatibleTables(t,e){const a=[];for(const n in e){const o=e[n];if(!o||!o.content||!o.content[0])continue;const i=o.content[0].slice(1).map(t=>String(t||'')),r=t.header.length===i.length&&t.header.every((t,e)=>t===i[e]),c=t.header.filter(t=>i.includes(t)),s=t.header.filter(t=>!i.includes(t)),l=t.header.length>0?c.length/t.header.length:0;r?a.push({tableUid:n,tableName:o.name||n,mode:'strict',matchedCols:c,unmatchedCols:s,matchRatio:1}):l>0&&a.push({tableUid:n,tableName:o.name||n,mode:'loose',matchedCols:c,unmatchedCols:s,matchRatio:l})}return a.sort((t,e)=>'strict'===t.mode&&'strict'!==e.mode?-1:'strict'!==t.mode&&'strict'===e.mode?1:e.matchRatio-t.matchRatio)},mapRowToTable(t,e){const a=[null];for(const n of e){const e=t.header.indexOf(n);a.push(e>=0?t.rowData[e]:'')}return a},async exportFavorites(){try{const t=await st.getAll(),e={version:1,exportedAt:Date.now(),items:t};return JSON.stringify(e,null,2)}catch(t){return console.error('[DICE]FavoritesManager exportFavorites error:',t),''}},async importFavorites(t){try{const e=JSON.parse(t);if(!e||!e.items||!Array.isArray(e.items))return console.error('[DICE]FavoritesManager å¯¼å…¥æ ¼å¼æ— æ•ˆ'),null;let a=0,n=0;for(const t of e.items){if(!t.id||!t.header||!t.rowData)continue;if(await st.get(t.id))await st.update(t.id,{header:t.header,rowData:t.rowData,tags:t.tags||[],updatedAt:Date.now(),sourceInfo:t.sourceInfo}),n++;else{const e={id:t.id,header:t.header,rowData:t.rowData,tags:t.tags||[],createdAt:t.createdAt||Date.now(),updatedAt:Date.now(),sourceInfo:t.sourceInfo};await st.add(e),a++}}return console.log('[DICE]FavoritesManager å¯¼å…¥å®Œæˆ:',a,'æ–°å¢,',n,'æ›´æ–°'),{added:a,updated:n}}catch(t){return console.error('[DICE]FavoritesManager importFavorites error:',t),null}}},ut=()=>{const t=ie||('function'==typeof wa?wa():null);if(t)for(const e in t){const a=t[e];if(a?.name?.includes('ä¸»è§’')&&a.content?.[1]?.[1])return a.content[1][1]}return null},dt=()=>{try{const t=window.parent||window;if(t.SillyTavern?.getContext){const e=t.SillyTavern.getContext();if(e?.name1)return e.name1}if('undefined'!=typeof name1&&name1)return name1;if(t.name1)return t.name1;const $=t.jQuery||window.jQuery;if($){const t=$('#user_avatar_block .avatar-name, #persona_name_input').first();if(t.length){const e=t.val?.()||t.text?.();if(e&&e.trim())return e.trim()}}}catch(t){console.warn('[DICE]ACU getPersonaName error:',t)}return null},pt=()=>dt()||ut()||'ä¸»è§’',gt=t=>{if(!t||'string'!=typeof t)return t;const e=pt();let a=t.replace(/<user>/gi,e);return a=a.replace(/\{\{user\}\}/gi,e),a},ft={_cache:null,load(){if(!this._cache){const t=Ae.get(N,{});this._cache={};for(const e in t)'string'==typeof t[e]?this._cache[e]={url:t[e],offsetX:50,offsetY:50,scale:150,aliases:[]}:this._cache[e]={url:t[e].url||'',offsetX:t[e].offsetX??50,offsetY:t[e].offsetY??50,scale:t[e].scale??150,aliases:t[e].aliases||[]}}return this._cache},save(){Ae.set(N,this._cache||{}),this._cache=null},get(t){const e=this.load()[t];if(e&&e.url)return e.url;for(const e in this._cache)if(this._cache[e].aliases&&this._cache[e].aliases.includes(t)&&this._cache[e].url)return this._cache[e].url;return null},async getAsync(t){if(!t)return null;const e=ut(),a='<user>'===t||'ä¸»è§’'===t||e&&t===e,n=await ct.get(t);if(n)return n;if(a&&'<user>'!==t){const t=await ct.get('<user>');if(t)return t}const o=this.getPrimaryName(t);if(o!==t){const t=await ct.get(o);if(t)return t}return this.get(t)},async hasLocalAvatar(t){if(!t)return!1;if(await ct.has(t))return!0;const e=this.getPrimaryName(t);return e!==t&&await ct.has(e)},saveLocalAvatar:async(t,e)=>await ct.save(t,e),deleteLocalAvatar:async t=>await ct.delete(t),getOffsetX(t){const e=this._resolveByAlias(t);return e?e.offsetX??50:50},getOffsetY(t){const e=this._resolveByAlias(t);return e?e.offsetY??50:50},getScale(t){const e=this._resolveByAlias(t);return e?e.scale??150:150},_resolveByAlias(t){const e=this.load()[t];if(e)return e;for(const e in this._cache)if(this._cache[e].aliases&&this._cache[e].aliases.includes(t))return this._cache[e];return null},getPrimaryName(t){if(this.load()[t])return t;for(const e in this._cache)if(this._cache[e].aliases&&this._cache[e].aliases.includes(t))return e;return t},set(t,e,a=50,n=50,o=150,i=[]){this.load()[t]={url:e,offsetX:a,offsetY:n,scale:o,aliases:i},this.save()},setPosition(t,e,a){const n=this.load()[t];n&&(n.offsetX=e,n.offsetY=a,this.save())},setScale(t,e){const a=this.load()[t];a&&(a.scale=e,this.save())},setAliases(t,e){const a=this.load()[t];a&&(a.aliases=e,this.save())},remove(t){delete this.load()[t],this.save()},getAll(){return this.load()},exportData(){return{version:1,exportTime:(new Date).toISOString(),avatars:this.load()}},importData(t,e=!0){if(!t||!t.avatars)throw new Error('æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼');const a=this.load(),n={added:0,updated:0,skipped:0};for(const o in t.avatars){const i=t.avatars[o];i.url&&(a[o]?e?(a[o]={url:i.url,offsetX:i.offsetX??50,offsetY:i.offsetY??50,scale:i.scale??150,aliases:i.aliases||[]},n.updated++):n.skipped++:(a[o]={url:i.url,offsetX:i.offsetX??50,offsetY:i.offsetY??50,scale:i.scale??150,aliases:i.aliases||[]},n.added++))}return this.save(),n},analyzeImport(t){if(!t||!t.avatars)return{valid:!1,error:'æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼'};const e=this.load(),a={valid:!0,total:0,newItems:[],conflicts:[]};for(const n in t.avatars)t.avatars[n].url&&(a.total++,e[n]?a.conflicts.push(n):a.newItems.push(n));return a}},bt=t=>{if(!t)return[];const a=[];for(const[n,o]of e)n.test(t)&&a.push(o);return a},mt=(t,e)=>{if(!t&&!e)return null;for(const[e,n]of a)if(t&&e.test(t))return n;for(const[t,n]of a)if(e&&t.test(e))return n;return null},vt=function(){const t='__mvu__';let e=null;function a(){if(e&&e._source)return e._source;const t=window.eventEmit||window.parent?.eventEmit,a=window.eventOn||window.parent?.eventOn;return'function'==typeof t&&'function'==typeof a?(console.log('[DICE]MvuModule æ™ºèƒ½æ£€æµ‹åˆ° ERA æ¡†æ¶'),'era'):void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData?(console.log('[DICE]MvuModule æ™ºèƒ½æ£€æµ‹åˆ° MVU æ¡†æ¶'),'mvu'):(console.log('[DICE]MvuModule æœªæ£€æµ‹åˆ°æ¡†æ¶ï¼Œé»˜è®¤ä½¿ç”¨ MVU æ¨¡å¼'),'mvu')}async function n(){return new Promise(t=>{const a=setTimeout(()=>{console.warn('[DICE]MvuModule ERAæŸ¥è¯¢è¶…æ—¶'),t(null)},5e3),n=window.eventEmit||window.parent?.eventEmit,o=window.eventOn||window.parent?.eventOn,i=window.eventOff||window.parent?.eventOff,r=n=>{if(clearTimeout(a),'function'==typeof i)try{i('era:queryResult',r)}catch(t){console.warn('[DICE]MvuModule ç§»é™¤äº‹ä»¶ç›‘å¬å¤±è´¥:',t)}if(console.log('[DICE]MvuModule æ”¶åˆ°ERAæŸ¥è¯¢ç»“æœ:',JSON.stringify(n,null,2)),console.log('[DICE]MvuModule detail.result:',JSON.stringify(n.result,null,2)),n.result&&n.result.error)return console.error('[DICE]MvuModule ERAæŸ¥è¯¢å¤±è´¥:',n.result.error),void t(null);const o=n.result?.statWithoutMeta||null;console.log('[DICE]MvuModule æå–çš„ stat_data:',JSON.stringify(o,null,2));const c={stat_data:o,delta_data:{},schema:null,_source:'era'};e=c,t(c)};try{if(console.log('[DICE]MvuModule å¼€å§‹è·å–ERAæ•°æ®...'),console.log('[DICE]MvuModule ERA API æ£€æŸ¥:',{eventEmit:'function'==typeof n,eventOn:'function'==typeof o,eventOff:'function'==typeof i}),'function'!=typeof o)return console.error('[DICE]MvuModule eventOn ä¸å¯ç”¨'),clearTimeout(a),void t(null);if('function'!=typeof n)return console.error('[DICE]MvuModule eventEmit ä¸å¯ç”¨'),clearTimeout(a),void t(null);o('era:queryResult',r),n('era:getCurrentVars')}catch(e){clearTimeout(a),console.error('[DICE]MvuModule ERA APIè°ƒç”¨å¤±è´¥:',e),t(null)}})}function o(t){return String(t??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}function i(){if('era'===a()){const t=window.eventEmit||window.parent?.eventEmit,e=window.eventOn||window.parent?.eventOn;return'function'==typeof t&&'function'==typeof e}return void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData}function r(){if(console.warn('[DICE]è­¦å‘Š: getData() æ˜¯åŒæ­¥å‡½æ•°ï¼Œå¯èƒ½æ— æ³•æ­£ç¡®è·å– MVU æ•°æ®ã€‚å»ºè®®ä½¿ç”¨ getDataWithRetry()'),e)return e;try{if(void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData){const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(t&&t.stat_data){const a={stat_data:t.stat_data||null,display_data:t.display_data||{},delta_data:t.delta_data||{},schema:t.schema||null,_source:'mvu'};return e=a,a}}}catch(t){console.warn('[DICE]åŒæ­¥è·å– MVU æ•°æ®å¤±è´¥:',t)}return null}async function s(t=3,a=500){try{if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)try{await Promise.race([waitGlobalInitialized('Mvu'),new Promise((_,t)=>setTimeout(()=>t(new Error('ç­‰å¾… MVU åˆå§‹åŒ–è¶…æ—¶')),3e3))])}catch(t){console.warn('[DICE]ç­‰å¾… MVU åˆå§‹åŒ–å¤±è´¥ï¼Œå°è¯•ç›´æ¥è·å–:',t.message)}for(let n=1;n<=t;n++){try{if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)throw new Error('MVU API ä¸å¯ç”¨');const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(t&&t.stat_data){const a={stat_data:t.stat_data||null,display_data:t.display_data||{},delta_data:t.delta_data||{},schema:t.schema||null,_source:'mvu'};return e=a,console.log('[DICE]MVU æ•°æ®è·å–æˆåŠŸ'),a}}catch(e){console.warn(`[DICE]MVU æ•°æ®è·å–å¤±è´¥ (å°è¯• ${n}/${t}):`,e)}n<t&&await new Promise(t=>setTimeout(t,a))}return null}catch(t){return console.error('[DICE]MVU åˆå§‹åŒ–å¤±è´¥:',t),null}}function l(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]&&('number'==typeof t[0]||'string'==typeof t[0]||'boolean'==typeof t[0])}function u(t){return!!Array.isArray(t)&&t.every(t=>'string'==typeof t||'number'==typeof t||'boolean'==typeof t||null===t)}function d(t){return Array.isArray(t)?l(t)?0:t.length:t&&'object'==typeof t?Object.keys(t).filter(t=>!t.startsWith('$')).length:0}function p(t,e=!1){if(null==t)return'';if(e||Array.isArray(t))return l(t)?String(t[0]):u(t)?t.map(t=>String(t??'')).join(', '):String(t);const a=String(t).trim();if(/^-?\d+(\.\d+)?%?$/.test(a))return a;const n=a.match(/^(-?\d+(?:\.\d+)?%?)(,\s*\[[^\]]+\])?\s+/);if(n)return n[2]?n[1]+n[2].trim():n[1];const o=a.match(/^(-?\d+(?:\.\d+)?%?\/-?\d+(?:\.\d+)?%?),/);if(o)return o[1];const i=a.match(/^(-?\d+(?:\.\d+)?%?),/);if(i)return i[1];const r=a.match(/^(-?\d+(?:\.\d+)?%?)\s+[^\d]/);return r?r[1]:a}function g(t){if(!t)return 0;const e=String(t).trim().match(/^(-?\d+(?:\.\d+)?)/);if(e){const t=parseFloat(e[1]);return isNaN(t)?0:t}return 0}function f(t,e,a,n){const i=function(t,e){if(!e||!t)return'';const a=t.split('.');let n=e;for(const t of a){if(null==n)return'';n=n[t]}if(!n)return'';if('string'==typeof n&&n.includes('->')){const t=n.match(/^(-?[\d.]+)->(-?[\d.]+)/);if(t){const e=parseFloat(t[1]),a=parseFloat(t[2]);if(!isNaN(e)&&!isNaN(a))return a>e?'â†‘':a<e?'â†“':''}return'â€¢'}return''}(a,n),r=i?'mvu-changed':'';let c,s='mvu-value';l(e)?c=String(e[0]):u(e)?(c=e.map(t=>String(t??'')).join(', '),s+=' mvu-array-value'):c=p(e??'',!1);let d='';try{if('function'==typeof qt&&qt(c)){const e=g(c);if(e>0){let n=t;if(t.includes('.')){const e=t.split('.');n=e[e.length-1]}if(a&&a.includes('.')){const e=a.split('.'),o=e[e.length-1];o&&!/^\d+$/.test(o)&&o!==t&&(n=o)}d=`<i class="fa-solid fa-dice-d20 mvu-dice-icon acu-mvu-dice-icon" data-path="${o(a)}" data-attr-name="${o(n)}" data-attr-value="${e}" title="å¿«æ·æŠ•éª°"></i>`}}}catch(t){console.warn('[DICE]MvuModule renderRow: åˆ¤æ–­æ•°å­—æ—¶å‡ºé”™',t)}return`\n                <div class="mvu-row ${r}">\n                    <div class="mvu-key">${o(t)}</div>\n                    <div class="mvu-value-wrap">\n                        <span class="${s}" data-path="${o(a)}">${o(c)}</span>\n                        ${d}\n                        ${i?`<span class="mvu-change-indicator">${i}</span>`:''}\n                    </div>\n                </div>\n            `}function b(t,e,a,n,i,r,c){const s=d(e),p=r?'':'collapsed';let g='',m=!1,v=0,h=0;if(!Array.isArray(e)||l(e)||u(e)){if(e&&'object'==typeof e&&!l(e)){const t=Object.entries(e).filter(([t])=>!t.startsWith('$'));for(const[e,o]of t){const t=a?`${a}.${e}`:e;!o||'object'!=typeof o||l(o)||u(o)?(h++,g+=f(e,o,t,n)):(m=!0,v++,g+=b(e,o,t,n,i+1,!1,c))}}}else e.forEach((t,e)=>{const o=`${a}[${e}]`;!t||'object'!=typeof t||l(t)||u(t)?(h++,g+=f(`[${e}]`,t,o,n)):(m=!0,v++,g+=b(`[${e}]`,t,o,n,i+1,!1,c))});const x=Array.isArray(e)?`[${s}]`:`(${s})`,y=c&&m?'mvu-card-body horizontal-nested':'mvu-card-body';let w=!1;if(c&&m&&0===i)if(!Array.isArray(e)||l(e)||u(e)){if(e&&'object'==typeof e&&!l(e)){const t=Object.entries(e).filter(([t])=>!t.startsWith('$'));for(const[e,a]of t)if(a&&'object'==typeof a&&!l(a)&&!u(a)){d(a)>=2&&(w=!0)}}}else e.forEach(t=>{if(t&&'object'==typeof t&&!l(t)&&!u(t)){d(t)>=2&&(w=!0)}});return`\n                <div class="mvu-card${c&&m&&(0===i&&(v>=2&&h<=1||w)||i>0&&0===h&&v>=2)?' has-nested-cards':''} ${p}" data-path="${o(a)}" data-depth="${i}">\n                    <div class="mvu-card-header">\n                        <div class="mvu-card-title">\n                            <span>${o(t)}</span>\n                            <span class="mvu-card-count">${x}</span>\n                        </div>\n                        <span class="mvu-card-toggle">â–¼</span>\n                    </div>\n                    <div class="${y}">\n                        ${g}\n                    </div>\n                </div>\n            `}return{MODULE_ID:t,isAvailable:i,getData:r,getDataWithRetry:async function(t=3,a=500){try{const o=await async function(){const t=window.eventEmit||window.parent?.eventEmit,e=window.eventOn||window.parent?.eventOn;if('function'==typeof t&&'function'==typeof e)try{const t=await Promise.race([n(),new Promise((_,t)=>setTimeout(()=>t(new Error('ERA timeout')),2e3))]);if(t&&t.stat_data)return console.log('[DICE]æ£€æµ‹åˆ° ERA æ¡†æ¶ä¸”æ•°æ®å¯ç”¨'),{mode:'era',data:t}}catch(t){console.warn('[DICE]ERA æ¡†æ¶å­˜åœ¨ä½†æ•°æ®ä¸å¯ç”¨:',t.message)}try{if(await waitGlobalInitialized('Mvu'),void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData){const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(t&&t.stat_data)return console.log('[DICE]æ£€æµ‹åˆ° MVU æ¡†æ¶ä¸”æ•°æ®å¯ç”¨'),{mode:'mvu',data:{stat_data:t.stat_data||null,display_data:t.display_data||{},delta_data:t.delta_data||{},schema:t.schema||null,_source:'mvu'}}}}catch(t){console.warn('[DICE]MVU æ¡†æ¶æ£€æµ‹å¤±è´¥:',t)}return console.warn('[DICE]æœªæ£€æµ‹åˆ°å¯ç”¨çš„å˜é‡æ¡†æ¶ï¼Œé»˜è®¤ä½¿ç”¨ MVU æ¨¡å¼'),{mode:'mvu',data:null}}();if(o.data)return e=o.data,o.data;if('era'===o.mode){for(let o=1;o<=t;o++){try{const t=await n();if(t&&t.stat_data)return e=t,t}catch(e){console.warn(`[DICE]ERA æ•°æ®è·å–å¤±è´¥ (å°è¯• ${o}/${t}):`,e)}o<t&&await new Promise(t=>setTimeout(t,a))}return console.warn('[DICE]ERA æ•°æ®è·å–å¤±è´¥ï¼Œå°è¯•é™çº§åˆ° MVU'),await s(t,a)}return await s(t,a)}catch(t){return console.error('[DICE]æ•°æ®è·å–å¤±è´¥:',t),null}},diagnoseVariableFramework:async function(){const t={timestamp:(new Date).toISOString(),era:{available:!1,eventEmit:'function'==typeof(window.eventEmit||window.parent?.eventEmit),eventOn:'function'==typeof(window.eventOn||window.parent?.eventOn),dataAvailable:!1,error:null},mvu:{available:!1,apiExists:void 0!==window.Mvu,getDataExists:'function'==typeof window.Mvu?.getMvuData,dataAvailable:!1,error:null},cache:{hasCache:!!e,cacheKeys:e?Object.keys(e):[]},recommendation:''};if(t.era.eventEmit&&t.era.eventOn)try{const e=await Promise.race([n(),new Promise((_,t)=>setTimeout(()=>t(new Error('Timeout')),2e3))]);t.era.available=!0,t.era.dataAvailable=!(!e||!e.stat_data)}catch(e){t.era.error=e.message}if(t.mvu.apiExists&&t.mvu.getDataExists)try{await Promise.race([waitGlobalInitialized('Mvu'),new Promise((_,t)=>setTimeout(()=>t(new Error('ç­‰å¾…è¶…æ—¶')),2e3))]);const e=window.Mvu.getMvuData({type:'message',message_id:'latest'});t.mvu.available=!0,t.mvu.dataAvailable=!(!e||!e.stat_data)}catch(e){t.mvu.error=e.message}return t.era.dataAvailable?t.recommendation='ERA æ¡†æ¶å¯ç”¨ä¸”æ•°æ®æ­£å¸¸':t.mvu.dataAvailable?t.recommendation='MVU æ¡†æ¶å¯ç”¨ä¸”æ•°æ®æ­£å¸¸':t.era.available||t.mvu.available?t.recommendation='æ¡†æ¶å·²å®‰è£…ä½†æ•°æ®ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è§’è‰²å¡æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–å˜é‡':t.recommendation='æœªæ£€æµ‹åˆ°ä»»ä½•å˜é‡æ¡†æ¶ï¼Œè¯·ç¡®è®¤å·²å®‰è£… MVU æˆ– ERA æ’ä»¶',t},injectStyles:function(){const t=window.parent?.document||document;if(t.getElementById('mvu-module-styles'))return;const e=t.createElement('style');e.id='mvu-module-styles',e.textContent='\n            /* MVU é¢æ¿å®¹å™¨ */\n            .acu-mvu-panel {\n                height: 100%;\n                display: flex;\n                flex-direction: column;\n                min-height: 300px; /* ç¡®ä¿é¢æ¿æœ‰è¶³å¤Ÿçš„æœ€å°é«˜åº¦ï¼Œé¿å…æ˜¾ç¤ºä¸ºç™½æ¡ */\n                overflow: hidden; /* ä¸åœ¨è¿™é‡Œæ»šåŠ¨ï¼Œè®©çˆ¶å®¹å™¨å¤„ç† */\n            }\n            .acu-mvu-panel .acu-panel-header {\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                padding: 10px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                flex-shrink: 0;\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title i {\n                color: var(--acu-accent);\n            }\n            .acu-mvu-panel .acu-header-actions {\n                display: flex;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn {\n                background: transparent;\n                border: none;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                padding: 4px;\n                font-size: 14px;\n                border-radius: 4px;\n                transition: all 0.2s;\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn:hover {\n                background: transparent;\n                color: var(--acu-accent);\n            }\n            .acu-mvu-panel .mvu-header-btn.active {\n                background: transparent;\n                color: var(--acu-accent);\n                font-weight: bold;\n            }\n            /* [æ–°å¢] æ•°å€¼æ¨¡å¼æ ·å¼ */\n            .mvu-numeric-mode {\n                padding: 0;\n            }\n            .mvu-numeric-level-controls {\n                position: sticky;\n                top: 0;\n                z-index: 10;\n            }\n            /* [æ–°å¢] å¯æŠ˜å å±‚çº§æ§åˆ¶æ ·å¼ */\n            .mvu-level-controls-collapsible {\n                margin-bottom: 8px;\n            }\n            .mvu-level-controls-header {\n                transition: background 0.2s;\n            }\n            .mvu-level-controls-header:hover {\n                background: var(--acu-table-hover) !important;\n            }\n            .mvu-level-controls-body {\n                overflow-y: auto;\n                overflow-x: hidden;\n                transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, border-bottom 0.3s ease-out;\n                max-height: 300px; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œè¶…å‡ºæ—¶å¯æ»šåŠ¨ */\n                scrollbar-width: thin;\n            }\n            /* ç§»åŠ¨ç«¯ä½¿ç”¨æ›´å°çš„æœ€å¤§é«˜åº¦ */\n            @media (max-width: 768px) {\n                .mvu-level-controls-body {\n                    max-height: 200px;\n                }\n            }\n            .mvu-level-controls-body::-webkit-scrollbar {\n                width: 6px;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-track {\n                background: transparent;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-thumb {\n                background: var(--acu-border);\n                border-radius: 3px;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-thumb:hover {\n                background: var(--acu-text-sub);\n            }\n            .mvu-level-controls-collapsible.collapsed .mvu-level-controls-body {\n                max-height: 0 !important;\n                padding-top: 0 !important;\n                padding-bottom: 0 !important;\n                border-bottom: none !important;\n                margin: 0 !important;\n            }\n            .mvu-level-controls-toggle-icon {\n                transition: transform 0.3s ease-out;\n            }\n            .mvu-level-controls-collapsible.collapsed .mvu-level-controls-toggle-icon {\n                transform: rotate(-90deg);\n            }\n            .mvu-numeric-items {\n                max-height: calc(100vh - 200px);\n                overflow-y: auto;\n            }\n            .mvu-numeric-item {\n                transition: background 0.2s;\n            }\n            .mvu-numeric-item:hover {\n                background: var(--acu-table-hover) !important;\n            }\n            .mvu-dice-icon {\n                transition: opacity 0.2s, transform 0.2s;\n            }\n            .mvu-dice-icon:hover {\n                opacity: 1 !important;\n                transform: scale(1.1);\n            }\n            .mvu-level-toggle:hover {\n                opacity: 1 !important;\n            }\n            .mvu-level-toggle[data-visible="true"]:hover {\n                background: var(--acu-accent) !important;\n                color: var(--acu-btn-active-text) !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .mvu-level-toggle[data-visible="false"]:hover,\n            .mvu-level-toggle[data-visible=""]:hover {\n                background: var(--acu-table-hover) !important;\n                color: var(--acu-text-sub) !important;\n                border-color: var(--acu-border) !important;\n            }\n\n            /* MVU å†…å®¹åŒº - å§‹ç»ˆä½¿ç”¨ç«–å‘æ»šåŠ¨æ¨¡å¼ */\n            .mvu-content {\n                display: flex;\n                flex-direction: column;\n                overflow-x: hidden;\n                overflow-y: auto; /* ç›´æ¥åœ¨å†…å®¹åŒºå¯ç”¨æ»šåŠ¨ */\n                flex: 1 1 auto;\n                min-height: 0; /* å…³é”®ï¼šå…è®¸ flex å­é¡¹ç¼©å°ä»¥å¯ç”¨æ»šåŠ¨ */\n                max-height: 100%; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºçˆ¶å®¹å™¨ */\n                padding: 12px;\n                scrollbar-width: thin;\n            }\n            .mvu-content::-webkit-scrollbar {\n                display: none;\n            }\n            .mvu-content .mvu-card {\n                flex: 0 0 auto; /* ä¸æ‹‰ä¼¸ï¼Œä¿æŒè‡ªç„¶é«˜åº¦ */\n                min-width: 100%;\n                max-width: 100%;\n                width: 100%;\n            }\n            /* MVUé¢æ¿å§‹ç»ˆæ”¯æŒæ»šåŠ¨ */\n            .acu-mvu-panel {\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                flex: 1 1 0; /* å…³é”®ï¼šä½¿ç”¨ flex-basis: 0 è®©å®¹å™¨å¯ä»¥æ­£ç¡®è®¡ç®—æ»šåŠ¨ */\n                min-height: 300px; /* ç¡®ä¿é¢æ¿æœ‰è¶³å¤Ÿçš„æœ€å°é«˜åº¦ï¼Œé¿å…æ˜¾ç¤ºä¸ºç™½æ¡ */\n            }\n\n            /* MVU å¡ç‰‡ */\n            .mvu-card {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 10px;\n                overflow: hidden;\n            }\n            .mvu-card:last-child {\n                margin-bottom: 0;\n            }\n            .mvu-card-header {\n                background: var(--acu-table-head);\n                padding: 8px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.2s;\n            }\n            .mvu-card-header:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-card-title {\n                font-weight: 600;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .mvu-card-count {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: normal;\n            }\n            .mvu-card-toggle {\n                color: var(--acu-text-sub);\n                font-size: 10px;\n                transition: transform 0.2s;\n            }\n            .mvu-card.collapsed .mvu-card-toggle {\n                transform: rotate(-90deg);\n            }\n            .mvu-card-body {\n                padding: 8px 12px;\n                display: block;\n                overflow: hidden; /* ä¸º slideUp/slideDown åŠ¨ç”»æä¾›æ”¯æŒ */\n            }\n            .mvu-card.collapsed .mvu-card-body {\n                display: none;\n            }\n\n            /* åµŒå¥—å¡ç‰‡ */\n            .mvu-card .mvu-card {\n                background: var(--acu-table-head);\n                margin: 6px 0;\n            }\n            .mvu-card .mvu-card .mvu-card-header {\n                background: rgba(128,128,128,0.1);\n                padding: 6px 10px;\n            }\n            .mvu-card .mvu-card .mvu-card-body {\n                padding: 6px 10px;\n            }\n\n            /* åµŒå¥—å¡ç‰‡æ¨ªå‘å¸ƒå±€ - åªå¯¹åµŒå¥—å¡ç‰‡ç”Ÿæ•ˆï¼Œé”®å€¼å¯¹ä¿æŒæ­£å¸¸å—çº§æ˜¾ç¤º */\n            .mvu-card-body.horizontal-nested {\n                display: flex;\n                flex-direction: row;\n                flex-wrap: nowrap;\n                gap: 12px;\n                overflow-x: auto;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: touch;\n                padding-bottom: 8px;\n                align-items: flex-start;\n            }\n            /* å¦‚æœçˆ¶å¡ç‰‡æœ‰ has-nested-cards ç±»ï¼Œä½¿ç”¨ wrap å¸ƒå±€ï¼Œè®©é”®å€¼å¯¹å’ŒåµŒå¥—å¡ç‰‡å¯ä»¥æ¢è¡Œ */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested {\n                flex-wrap: wrap;\n            }\n            /* é”®å€¼å¯¹è¡Œä¿æŒæ­£å¸¸å—çº§æ˜¾ç¤ºï¼Œå æ»¡ä¸€è¡Œ */\n            .mvu-card-body.horizontal-nested > .mvu-row {\n                display: flex;\n                flex: 0 0 100%;\n                width: 100%;\n                max-width: 100%; /* ç¡®ä¿ä¸è¶…è¿‡å®¹å™¨å®½åº¦ */\n                box-sizing: border-box;\n            }\n            /* å¦‚æœçˆ¶å¡ç‰‡æœ‰ has-nested-cards ç±»ï¼Œé”®å€¼å¯¹åº”è¯¥æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ï¼Œä½†ä»ç„¶å æ»¡ä¸€è¡Œ */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                flex: 0 0 auto; /* æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */\n                min-width: 100%; /* ç¡®ä¿å æ»¡ä¸€è¡Œ */\n                width: auto; /* æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */\n                max-width: 450px; /* é™åˆ¶é”®å€¼å¯¹çš„æœ€å¤§å®½åº¦ï¼Œé¿å…å ç”¨è¿‡å¤šæ¨ªå‘ç©ºé—´ */\n                box-sizing: border-box;\n            }\n            @media (min-width: 769px) {\n                .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                    max-width: 550px; /* å¤§å±å¹•ä¸‹ä¹Ÿé™åˆ¶é”®å€¼å¯¹çš„æœ€å¤§å®½åº¦ */\n                }\n            }\n            /* åªæœ‰åµŒå¥—å¡ç‰‡æ‰æ¨ªå‘æ’åˆ— - æ™ºèƒ½å®½åº¦ */\n            .mvu-card-body.horizontal-nested > .mvu-card {\n                flex: 0 0 auto; /* æ ¹æ®å†…å®¹è‡ªåŠ¨è°ƒæ•´å®½åº¦ */\n                min-width: 200px;\n                max-width: 350px;\n                width: auto;\n            }\n            /* å¦‚æœåµŒå¥—å¡ç‰‡å†…éƒ¨ä¹Ÿæœ‰æ¨ªå‘æ’åˆ—çš„å­å¡ç‰‡ï¼Œç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå…è®¸æ ¹æ®å†…å®¹è‡ªé€‚åº” */\n            .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                min-width: 400px; /* ä¸ºåŒ…å«åµŒå¥—å¡ç‰‡çš„åµŒå¥—å¡ç‰‡è®¾ç½®æ›´å¤§çš„æœ€å°å®½åº¦ */\n                max-width: none; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå…è®¸æ ¹æ®å†…å®¹è‡ªé€‚åº” */\n            }\n            @media (min-width: 769px) {\n                .mvu-card-body.horizontal-nested > .mvu-card {\n                    min-width: 240px;\n                    max-width: 400px;\n                }\n                .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                    min-width: 500px; /* ä¸ºåŒ…å«åµŒå¥—å¡ç‰‡çš„åµŒå¥—å¡ç‰‡è®¾ç½®æ›´å¤§çš„æœ€å°å®½åº¦ */\n                    max-width: none; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå…è®¸æ ¹æ®å†…å®¹è‡ªé€‚åº” */\n                }\n            }\n\n            /* é”®å€¼å¯¹è¡Œ */\n            .mvu-row {\n                display: flex;\n                align-items: flex-start;\n                padding: 5px 0;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .mvu-row:last-child {\n                border-bottom: none;\n            }\n            .mvu-key {\n                color: var(--acu-text-sub);\n                min-width: 80px;\n                max-width: 120px;\n                flex-shrink: 0;\n                font-size: 12px;\n                padding-right: 8px;\n                word-break: break-all;\n            }\n            .mvu-value-wrap {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                min-width: 0;\n            }\n            .mvu-value {\n                color: var(--acu-text-main);\n                font-size: var(--acu-font-size, 13px);\n                cursor: pointer;\n                padding: 1px 6px;\n                border-radius: 4px;\n                transition: background 0.2s;\n                word-break: break-word;\n                flex: 0 1 auto;\n            }\n            .mvu-value:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-value.mvu-array-value {\n                font-size: calc(var(--acu-font-size, 13px) * 0.92);\n                color: var(--acu-text-sub);\n            }\n            .mvu-change-indicator {\n                color: var(--acu-success-text);\n                font-weight: bold;\n                font-size: 12px;\n                flex-shrink: 0;\n            }\n            .mvu-row.mvu-changed {\n                background: var(--acu-success-bg);\n                margin: 0 -12px;\n                padding: 5px 12px;\n                border-radius: 4px;\n            }\n            .mvu-card .mvu-card .mvu-row.mvu-changed {\n                margin: 0 -10px;\n                padding: 5px 10px;\n            }\n\n            /* ç©ºçŠ¶æ€ */\n            .mvu-empty {\n                text-align: center;\n                padding: 40px 20px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 100%;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n            }\n            .mvu-empty i {\n                font-size: 32px;\n                margin-bottom: 12px;\n                display: block;\n                opacity: 0.5;\n            }\n            .mvu-empty p {\n                margin: 0 0 6px 0;\n            }\n            .mvu-empty .mvu-empty-hint {\n                font-size: 12px;\n                opacity: 0.7;\n            }\n\n            /* ç¼–è¾‘å¼¹çª— */\n            .mvu-edit-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0,0,0,0.6);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 99999;\n                animation: mvuFadeIn 0.15s ease-out;\n            }\n            .mvu-edit-dialog {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                padding: 16px;\n                width: 90%;\n                max-width: 400px;\n                animation: mvuSlideIn 0.2s ease-out;\n            }\n            .mvu-edit-title {\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 12px;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .mvu-edit-path {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                padding: 6px 10px;\n                border-radius: 4px;\n                margin-bottom: 12px;\n                word-break: break-all;\n                font-family: monospace;\n            }\n            .mvu-edit-textarea {\n                width: 100%;\n                min-height: 80px;\n                padding: 10px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-input-bg, var(--acu-bg-panel));\n                color: var(--acu-text-main);\n                font-size: 13px;\n                resize: vertical;\n                box-sizing: border-box;\n            }\n            .mvu-edit-textarea:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .mvu-edit-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-top: 8px;\n                opacity: 0.7;\n            }\n            .mvu-edit-btns {\n                display: flex;\n                justify-content: flex-end;\n                gap: 8px;\n                margin-top: 16px;\n            }\n            .mvu-edit-btn {\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 13px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                transition: all 0.2s;\n            }\n            .mvu-edit-btn.mvu-btn-cancel {\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-sub);\n            }\n            .mvu-edit-btn.mvu-btn-cancel:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-edit-btn.mvu-btn-save {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .mvu-edit-btn.mvu-btn-save:hover {\n                opacity: 0.9;\n            }\n\n            @keyframes mvuFadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n            @keyframes mvuSlideIn {\n                from { transform: translateY(-20px); opacity: 0; }\n                to { transform: translateY(0); opacity: 1; }\n            }\n\n            /* å¯¼èˆªæŒ‰é’® */\n            .acu-nav-btn.acu-mvu-btn.active {\n                background: var(--acu-btn-active-bg);\n                color: var(--acu-btn-active-text);\n            }\n        ',t.head.appendChild(e)},renderNavButton:function(e){return`<button class="acu-nav-btn acu-mvu-btn $${e?'active':''}" id="acu-btn-mvu" data-table="$${t}" style="order:-1;">\n                    <i class="fa-solid fa-code-branch"></i><span>å˜é‡</span>\n                </button>`},renderPanel:function(){const t=r(),e='era'===a();let n=!1;try{n='true'===localStorage.getItem('acu_mvu_numeric_mode')}catch(t){console.warn('[DICE]MvuModule è¯»å–æ•°å€¼æ¨¡å¼çŠ¶æ€å¤±è´¥',t)}const i='vertical-layout',c=e?'ERA å˜é‡':'MVU å˜é‡';if(!t)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span></div>\n                                <div class="acu-title-sub">(0é¡¹)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${vt.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="å…³é—­">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${i}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-exclamation-circle"></i>\n                                <p>æ— æ³•è·å– ${e?'ERA':'MVU'} æ•°æ®</p>\n                                <p class="mvu-empty-hint">è¯·ç¡®ä¿è§’è‰²å¡å·²é…ç½® ${e?'ERA æ¡†æ¶':'MVU æ¡†æ¶'}ï¼Œæˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®è‡ªåŠ¨é‡è¯•è·å–å˜é‡</p>\n                            </div>\n                        </div>\n                    `;if(!t.stat_data||'object'==typeof t.stat_data&&0===Object.keys(t.stat_data).length)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span></div>\n                                <div class="acu-title-sub">(0é¡¹)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${vt.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="å…³é—­">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${i}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-inbox"></i>\n                                <p>å½“å‰æ²¡æœ‰å˜é‡æ•°æ®</p>\n                                <p class="mvu-empty-hint">å˜é‡æ•°æ®å°†åœ¨ AI å›å¤åè‡ªåŠ¨åˆå§‹åŒ–ï¼Œæˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®è‡ªåŠ¨é‡è¯•è·å–å˜é‡</p>\n                            </div>\n                        </div>\n                    `;if(n){const e=function(t){if(!t||!t.stat_data)return'<div class="mvu-empty"><i class="fa-solid fa-inbox"></i><p>å½“å‰æ²¡æœ‰å˜é‡æ•°æ®</p></div>';let e={};try{const t=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');t&&(e=JSON.parse(t))}catch(t){console.warn('[DICE]MvuModule è¯»å–å±‚çº§æ˜¾ç¤ºåå¥½å¤±è´¥',t)}const a=[];function n(t,e,o){if(t&&'object'==typeof t)if(Array.isArray(t))l(t)||u(t)?t.forEach((t,n)=>{const i=e?`${e}[${n}]`:`[${n}]`,r=String(t??'').trim();if('function'==typeof qt&&qt(r)){const t=g(p(r,!1));t>0&&a.push({path:i,key:`[${n}]`,value:r,numericValue:t,levelNames:[...o]})}}):t.forEach((t,a)=>{n(t,e?`${e}[${a}]`:`[${a}]`,[...o,`[${a}]`])});else{const i=Object.entries(t).filter(([t])=>!t.startsWith('$'));for(const[t,r]of i){const i=e?`${e}.${t}`:t,c=[...o,t];if(!r||'object'!=typeof r||l(r)||u(r)){const e=String(r??'').trim();if('function'==typeof qt&&qt(e)){const n=g(p(e,!1));n>0&&a.push({path:i,key:t,value:e,numericValue:n,levelNames:c})}}else n(r,i,c)}}}const i=Object.keys(t.stat_data).filter(t=>!t.startsWith('$'));for(const e of i)n(t.stat_data[e],e,[e]);const r=a.filter(t=>{let e=t.key;const a=t.levelNames.filter(t=>t&&!t.startsWith('['));if(a.length>0)e=a[a.length-1];else if(t.path&&t.path.includes('.')){const a=t.path.split('.');e=a[a.length-1]}return!Q.isBlacklisted(e)});if(0===r.length)return'<div class="mvu-empty"><i class="fa-solid fa-filter"></i><p>å½“å‰æ²¡æœ‰æ•°å€¼é¡¹</p></div>';const c=new Set;r.forEach(t=>{(t.levelNames.length>1?t.levelNames.slice(0,-1):[]).forEach(t=>{t&&!t.startsWith('[')&&c.add(t)})});const s=Array.from(c).sort();let d='';if(s.length>0){let t='';s.forEach(a=>{const n=!1!==e[a];t+=`<button class="mvu-level-toggle acu-mvu-level-toggle ${n?'active':''}" data-level="${o(a)}" data-visible="${n}" title="${n?'éšè—':'æ˜¾ç¤º'}å±‚çº§: ${o(a)}"><span>${o(a)}</span></button>`}),d=`\n          <div class="mvu-level-controls-collapsible collapsed">\n            <div class="mvu-level-controls-header acu-mvu-header">\n              <span class="acu-mvu-header-text">æ˜¾ç¤ºå±‚çº§</span>\n              <i class="fa-solid fa-chevron-down mvu-level-controls-toggle-icon acu-mvu-toggle-icon"></i>\n            </div>\n            <div class="mvu-level-controls-body acu-mvu-body">\n              ${t}\n            </div>\n          </div>\n        `}let f='';return r.forEach(t=>{const e=t.levelNames.filter(t=>!t.startsWith('[')),a=t.levelNames.filter(t=>{if(t.startsWith('['))return!1;try{const e=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');if(e)return!1!==JSON.parse(e)[t]}catch(t){}return!0}),n=a.length>1?a.slice(0,-1):[],i=e.length>1?e.slice(0,-1):[],r=i.every(t=>{try{const e=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');if(e)return!1!==JSON.parse(e)[t]}catch(t){}return!0}),c=n.length>0?n.join(' > '):'';let s=t.key;if(t.path&&t.path.includes('.')){const e=t.path.split('.');s=e[e.length-1]}const l=`<i class="fa-solid fa-dice-d20 mvu-dice-icon acu-mvu-dice-icon" data-path="${o(t.path)}" data-attr-name="${o(s)}" data-attr-value="${t.numericValue}" title="å¿«æ·æŠ•éª°"></i>`;let u=p(t.value,!1);u=u.replace(/,\s*\[[^\]]+\]/g,'');const d=r?'':'display:none;',g=JSON.stringify(i);f+=`\n          <div class="mvu-numeric-item acu-mvu-item" data-levels='${o(g)}' style="${d}">\n            <div class="acu-mvu-item-content">\n              <div class="mvu-path-display acu-mvu-path">${o(c)}</div>\n              <div class="acu-mvu-item-row">\n                <span class="acu-mvu-attr-name">${o(s)}</span>\n                <span class="mvu-value acu-mvu-val" data-path="${o(t.path)}" title="ç‚¹å‡»ç¼–è¾‘">${o(u)}</span>\n                ${l}\n              </div>\n            </div>\n          </div>\n        `}),d+'<div class="mvu-numeric-items acu-mvu-list">'+f+'</div>'}(t);return`\n                    <div class="acu-panel-header">\n                        <div class="acu-panel-title">\n                            <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span> <span style="font-size:calc(var(--acu-font-size,13px) * 0.85);color:var(--acu-text-sub);margin-left:6px;">(æ•°å€¼æ¨¡å¼)</span></div>\n                            <div class="acu-title-sub">(æ•°å€¼è¿‡æ»¤)</div>\n                        </div>\n                        <div class="acu-header-actions">\n                            <div class="acu-height-control">\n                                <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${vt.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                            </div>\n                            <button class="mvu-header-btn mvu-btn-numeric-mode active" title="åˆ‡æ¢åˆ°æ™®é€šæ¨¡å¼">\n                                <i class="fa-solid fa-list"></i>\n                            </button>\n                            <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                            <button class="acu-close-btn" title="å…³é—­">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="mvu-content ${i} mvu-numeric-mode">\n                        ${e}\n                    </div>\n                `}const s=Object.keys(t.stat_data).filter(t=>!t.startsWith('$'));let m='';for(const e of s){const a=t.stat_data[e];d(a);!a||'object'!=typeof a||l(a)||u(a)?m+=`\n                            <div class="mvu-card" data-path="${o(e)}" data-depth="0">\n                                <div class="mvu-card-body">\n                                    ${f(e,a,e,t.delta_data)}\n                                </div>\n                            </div>\n                        `:m+=b(e,a,e,t.delta_data,0,!0,!1)}return`\n                    <div class="acu-panel-header">\n                        <div class="acu-panel-title">\n                            <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span></div>\n                            <div class="acu-title-sub">(${s.length}é¡¹)</div>\n                        </div>\n                        <div class="acu-header-actions">\n                            <div class="acu-height-control">\n                                <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${vt.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                            </div>\n                            <button class="mvu-header-btn mvu-btn-numeric-mode" title="åˆ‡æ¢åˆ°æ•°å€¼æ¨¡å¼ï¼ˆä»…æ˜¾ç¤ºæ•°å€¼é¡¹ï¼‰">\n                                <i class="fa-solid fa-filter"></i>\n                            </button>\n                            <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                            <button class="acu-close-btn" title="å…³é—­">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="mvu-content ${i}">\n                        ${m}\n                    </div>\n                `},bindEvents:function(t){const $=window.parent?.jQuery||window.jQuery;if(!$||!t||!t.length)return void console.warn('[DICE]MvuModule bindEvents: jQuery or container not available');const e=$('#acu-data-area');e.length?(e.off('.mvu'),e.on('click.mvu','.mvu-card-header',function(t){t.stopPropagation();const e=$(this).closest('.mvu-card'),a=e.find('> .mvu-card-body').first();a.is(':animated')||a.hasClass('animating')||(e.hasClass('collapsed')?(a.hide(),e.removeClass('collapsed'),a.addClass('animating').slideDown(180,function(){$(this).removeClass('animating')})):a.addClass('animating').slideUp(180,function(){e.addClass('collapsed'),$(this).removeClass('animating')}))}),e.on('click.mvu','.mvu-btn-refresh',function(t){t.stopPropagation(),vt.refresh(e)}),e.on('click.mvu','.mvu-btn-numeric-mode',function(t){t.stopPropagation();try{const t=!$(this).hasClass('active');if(localStorage.setItem('acu_mvu_numeric_mode',String(t)),'function'==typeof Ie){const t=De();Ie(t)}'function'==typeof nn&&nn()}catch(t){console.warn('[DICE]MvuModule åˆ‡æ¢æ•°å€¼æ¨¡å¼å¤±è´¥',t),window.toastr&&window.toastr.error('åˆ‡æ¢æ¨¡å¼å¤±è´¥')}}),e.on('click.mvu','.mvu-level-controls-header',function(t){t.stopPropagation();$(this).closest('.mvu-level-controls-collapsible').toggleClass('collapsed')}),e.on('click.mvu','.mvu-level-toggle',function(t){t.stopPropagation();const e=$(this),a=e.data('level'),n=!('true'===e.data('visible')||!0===e.data('visible'));try{const t=localStorage.getItem('acu_mvu_numeric_mode_visible_levels'),o=t?JSON.parse(t):{};o[a]=n,localStorage.setItem('acu_mvu_numeric_mode_visible_levels',JSON.stringify(o)),e.data('visible',n),n?(e.css({background:'var(--acu-accent)',color:'var(--acu-btn-active-text)',borderColor:'var(--acu-accent)',opacity:'1'}),e.attr('title',`éšè—å±‚çº§: ${a}`)):(e.css({background:'transparent',color:'var(--acu-text-sub)',borderColor:'var(--acu-border)',opacity:'0.5'}),e.attr('title',`æ˜¾ç¤ºå±‚çº§: ${a}`)),$('.mvu-numeric-item').each(function(){const t=$(this);try{const e=JSON.parse(t.attr('data-levels')||'[]');if(e.includes(a)){const a=e.filter(t=>{const e=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');return!1!==(e?JSON.parse(e):{})[t]}),n=a,o=n.length>0?n.join(' > '):'';t.find('.mvu-path-display').text(o)}}catch(t){console.warn('[DICE]MvuModule æ›´æ–°è·¯å¾„æ˜¾ç¤ºå¤±è´¥',t)}})}catch(t){console.warn('[DICE]MvuModule æ›´æ–°å±‚çº§æ˜¾ç¤ºåå¥½å¤±è´¥',t)}}),e.on('click.mvu','.mvu-value',function(t){t.stopPropagation();const e=$(this),a=e.data('path');if(!a)return void console.warn('[DICE]MvuModule No path on value element');const n=e.text().replace(/\s*\$\s*$/,'').trim();vt.showEditDialog(a,n,async function(t){if(null!==t&&t!==n){const n=await vt.setValue(a,t),toastr=window.parent?.toastr||window.toastr;n?(e.text(t),e.css('background','var(--acu-success-bg)'),setTimeout(()=>e.css('background',''),1500)):toastr&&toastr.error('ä¿å­˜å¤±è´¥')}})}),e.on('click.mvu','.mvu-dice-icon',function(t){t.stopPropagation(),t.preventDefault();const e=$(this),a=e.data('path'),n=e.data('attr-name')||'å±æ€§',o=parseInt(e.data('attr-value'),10)||50;if(!a)return void console.warn('[DICE]MvuModule éª°å­å›¾æ ‡ç¼ºå°‘è·¯å¾„ä¿¡æ¯');if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)return console.warn('[DICE]MvuModule MVU æ¡†æ¶æœªåŠ è½½ï¼Œé™çº§ä¸ºæ™®é€šæŠ•éª°'),void('function'==typeof oa&&oa({attrValue:o,targetValue:null,targetName:n,initiatorName:'<user>',fromMvu:!1}));let i=null;try{i=function(t){try{if(!t||'string'!=typeof t)return{initiator:null,attrName:null,candidates:[]};const e=t.split('.').filter(t=>t&&t.trim());if(0===e.length)return{initiator:null,attrName:null,candidates:[]};const a=['è§’è‰²åˆ—è¡¨','ç³»ç»Ÿ','åˆ—è¡¨','è¡¨','æ•°æ®','ä¿¡æ¯','å˜é‡','å±æ€§','çŠ¶æ€','stat_data','delta_data'],n=e.filter(t=>!a.includes(t));let o=null;n.length>=2?o=n[n.length-2]:1===n.length&&(o=n[0]);let i=null;return n.length>0?i=n[n.length-1]:e.length>0&&(i=e[e.length-1]),{initiator:o||null,attrName:i||null,candidates:n.length>0?n:e.slice(-1)}}catch(t){return console.warn('[DICE]parseMvuPathForDice è§£æè·¯å¾„æ—¶å‡ºé”™',t),{initiator:null,attrName:null,candidates:[]}}}(a)}catch(t){console.warn('[DICE]MvuModule è§£æè·¯å¾„æ—¶å‡ºé”™',t)}'function'==typeof oa&&oa({attrValue:o,targetValue:null,targetName:n,initiatorName:i?.initiator||'<user>',fromMvu:!0,mvuPath:a,mvuParsedInfo:i})}),function(){const t=window.parent?.document||document,e=$(t);e.off('touchstart.mvuSwipeFix touchmove.mvuSwipeFix touchend.mvuSwipeFix','#acu-data-area');let a=0,n=0,o=!1;e.on('touchstart.mvuSwipeFix','#acu-data-area',function(t){$(t.target).closest('.acu-mvu-panel').length>0&&1===t.originalEvent.touches.length&&(a=t.originalEvent.touches[0].clientX,n=t.originalEvent.touches[0].clientY,o=!1)}),e.on('touchmove.mvuSwipeFix','#acu-data-area',function(t){if(!($(t.target).closest('.acu-mvu-panel').length>0))return;if(1!==t.originalEvent.touches.length)return;const e=t.originalEvent.touches[0],i=Math.abs(e.clientX-a),r=Math.abs(e.clientY-n);(r<5?i>5&&i>2*r:i>1.5*r&&i>10)&&(o=!0,t.stopImmediatePropagation(),t.stopPropagation())}),e.on('touchend.mvuSwipeFix','#acu-data-area',function(t){if(!($(t.target).closest('.acu-mvu-panel').length>0))return o=!1,a=0,void(n=0);o&&(t.stopImmediatePropagation(),t.stopPropagation(),o=!1),a=0,n=0});t.addEventListener('touchstart',function(t){$(t.target).closest('.acu-mvu-panel').length>0&&t.touches&&1===t.touches.length&&(a=t.touches[0].clientX,n=t.touches[0].clientY)},!0),t.addEventListener('touchmove',function(t){if($(t.target).closest('.acu-mvu-panel').length>0&&t.touches&&1===t.touches.length&&a&&n){const e=t.touches[0],o=Math.abs(e.clientX-a),i=Math.abs(e.clientY-n);(i<5?o>5&&o>2*i:o>1.5*i&&o>10)&&(t.stopImmediatePropagation(),t.stopPropagation(),t.preventDefault())}},!0),t.addEventListener('touchend',function(t){$(t.target).closest('.acu-mvu-panel').length>0&&o&&(t.stopImmediatePropagation(),t.stopPropagation(),t.preventDefault())},!0)}(),e.on('click.mvu','.acu-close-btn',function(t){t.stopPropagation();const a=e.find('.acu-search-input');a.length&&a.val()?a.val('').trigger('input').focus():('function'==typeof Ie&&Ie(null),'function'==typeof nn&&nn())}),e.on('pointerdown.mvu','.acu-height-drag-handle',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const a=this;a.setPointerCapture(t.pointerId),$(a).addClass('active');const n=e.height(),o=t.clientY,i=$(a).data('table'),r=void 0!==window.MIN_PANEL_HEIGHT?window.MIN_PANEL_HEIGHT:200,c=void 0!==window.MAX_PANEL_HEIGHT?window.MAX_PANEL_HEIGHT:800;a.onpointermove=function(t){const a=t.clientY-o;let i=n-a;i<r&&(i=r),i>c&&(i=c),e.css('height',i+'px')},a.onpointerup=function(t){if($(a).removeClass('active'),a.releasePointerCapture(t.pointerId),a.onpointermove=null,a.onpointerup=null,i&&'function'==typeof Oe&&'function'==typeof Be){const t=Oe();t[i]=parseInt(e.css('height')),Be(t),e.addClass('acu-manual-mode')}}}),e.on('dblclick.mvu','.acu-height-drag-handle',function(t){t.preventDefault(),t.stopPropagation();const a=$(this).data('table');if(a&&'function'==typeof Oe&&'function'==typeof Be){const t=Oe();delete t[a],Be(t),e.css('height','').removeClass('acu-manual-mode')}}),e.on('dblclick.mvu','.acu-panel-header',function(t){if($(t.target).closest('.acu-search-input, .acu-close-btn, .mvu-header-btn').length)return;t.preventDefault(),t.stopPropagation();const a=vt.MODULE_ID;if(a&&'function'==typeof Oe&&'function'==typeof Be){const t=Oe();delete t[a],Be(t),e.css('height','').removeClass('acu-manual-mode')}})):console.warn('[DICE]MvuModule bindEvents: #acu-data-area not found')},showEditDialog:function(t,e,a){const $=window.parent?.jQuery||window.jQuery,n=window.parent?.document||document;if(!$)return;$(n).find('.mvu-edit-overlay').remove();const i=`\n                    <div class="mvu-edit-overlay acu-edit-overlay acu-theme-${('function'==typeof ma?ma().theme:null)||'retro'}">\n                        <div class="mvu-edit-dialog acu-edit-dialog">\n                            <div class="acu-edit-title">\n                                <i class="fa-solid fa-edit acu-edit-icon-muted"></i>\n                                <span>ç¼–è¾‘å˜é‡</span>\n                            </div>\n                            <div class="mvu-edit-path">${o(t)}</div>\n                            <textarea class="mvu-edit-textarea acu-edit-textarea">${o(e)}</textarea>\n                            <div class="mvu-edit-hint">Ctrl+Enter ä¿å­˜ | Esc å–æ¶ˆ</div>\n                            <div class="acu-dialog-btns">\n                                <button class="acu-dialog-btn mvu-btn-cancel">\n                                    <i class="fa-solid fa-times"></i> å–æ¶ˆ\n                                </button>\n                                <button class="acu-dialog-btn acu-btn-confirm mvu-btn-save">\n                                    <i class="fa-solid fa-check"></i> ä¿å­˜\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                `;$(n.body).append(i);const r=$(n).find('.mvu-edit-overlay'),s=r.find('.mvu-edit-textarea');setTimeout(()=>s.focus().select(),50),r.on('click','.mvu-btn-cancel',function(t){t.preventDefault(),t.stopPropagation(),r.remove(),a(null)}),r.on('click','.mvu-btn-save',function(t){t.preventDefault(),t.stopPropagation();const e=s.val();r.remove(),a(e)}),c(r,'mvu-edit-overlay',()=>{r.remove(),a(null)}),s.on('keydown',function(t){if('Escape'===t.key)t.preventDefault(),r.remove(),a(null);else if('Enter'===t.key&&t.ctrlKey){t.preventDefault();const e=s.val();r.remove(),a(e)}})},setValue:async function(t,e){if(!i())return!1;const n=a();try{let a=e;if('true'===e?a=!0:'false'===e?a=!1:isNaN(Number(e))||''===String(e).trim()||(a=Number(e)),'era'===n)return await async function(t,e){return new Promise(a=>{const n=setTimeout(()=>{console.warn('[DICE]MvuModule ERAå†™å…¥è¶…æ—¶'),a(!1)},5e3),o=window.eventEmit||window.parent?.eventEmit,i=window.eventOn||window.parent?.eventOn,r=window.eventOff||window.parent?.eventOff,c=t=>{clearTimeout(n),'function'==typeof r&&r('era:writeDone',c),console.log('[DICE]MvuModule ERAå†™å…¥æˆåŠŸ'),a(!0)};try{if(console.log('[DICE]MvuModule å¼€å§‹è®¾ç½®ERAå˜é‡:',t,e),'function'!=typeof i)return console.error('[DICE]MvuModule eventOn ä¸å¯ç”¨'),clearTimeout(n),void a(!1);if('function'!=typeof o)return console.error('[DICE]MvuModule eventEmit ä¸å¯ç”¨'),clearTimeout(n),void a(!1);i('era:writeDone',c),o('era:updateByPath',{path:t,value:e})}catch(t){clearTimeout(n),console.error('[DICE]MvuModule ERA APIè°ƒç”¨å¤±è´¥:',t),a(!1)}})}(t,a);{const e=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(!e)return console.error('[DICE]MvuModule æ— æ³•è·å– MVU æ•°æ®'),!1;const n=await window.Mvu.setMvuVariable(e,t,a,{reason:'æ‰‹åŠ¨ç¼–è¾‘',is_recursive:!1});return n?await window.Mvu.replaceMvuData(e,{type:'message',message_id:'latest'}):console.warn('[DICE]MvuModule setMvuVariable è¿”å› false'),n}}catch(t){return console.error('[DICE]MvuModule setValue error:',t),!1}},isModuleTab:function(e){return e===t},clearCache:function(){e=null,console.log('[DICE]MvuModule å·²æ¸…é™¤ ERA ç¼“å­˜')},detectMode:function(){return a()},refresh:function(t){if(this.clearCache(),!t||!t.length){const e=$('#acu-data-area');if(!e.length)return;t=e}const e=t.find('.mvu-btn-refresh');e.length&&e.find('i').addClass('fa-spin'),this.getDataWithRetry(10,1e3).then(a=>{if(e.length&&e.find('i').removeClass('fa-spin'),!Se())return;t.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(t);const toastr=window.parent?.toastr||window.toastr,n=this.getData();toastr&&!n&&toastr.warning('æ— æ³•è·å–å˜é‡æ•°æ®ï¼Œè¯·ç¨åé‡è¯•æˆ–ç¡®ä¿è§’è‰²å¡å·²é…ç½® MVU æ¡†æ¶')}).catch(a=>{if(console.error('[DICE]MvuModule Error refreshing data:',a),e.length&&e.find('i').removeClass('fa-spin'),!Se())return;t.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(t);const toastr=window.parent?.toastr||window.toastr,n=this.getData();toastr&&!n&&toastr.error('è·å–å˜é‡æ•°æ®æ—¶å‡ºé”™')})}}}(),ht={critSuccessMax:5,hardSuccessDiv:5,difficultSuccessDiv:2,critFailMin:96,ruleType:'high_good',lastDiceType:'1d100',dndCritSuccess:20,dndCritFail:1,contestTieRule:'initiator_lose',hideDiceResultFromUser:!1,hideDiceResultInChat:!1},xt=()=>Ae.get(A,ht),yt=t=>{const e=xt(),a={...e,...t};Ae.set(A,a);const n=Object.keys(t).filter(t=>e[t]!==a[t]);n.length>0&&console.info(`[DICE]æŠ•éª°é…ç½®å·²æ›´æ–°: ${n.join(', ')}`)},wt=()=>{try{const t=xt(),e=void 0!==t.hideDiceResultFromUser&&t.hideDiceResultFromUser,a=void 0!==t.hideDiceResultInChat&&t.hideDiceResultInChat;try{const t=$('#send_textarea');if(t.length){let a=t.val()||'',n=a;if(e){const t=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g,e=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g;t.test(n)&&(n=n.replace(t,'[æŠ•éª°ç»“æœå·²éšè—]')),e.test(n)&&(n=n.replace(e,'[æŠ•éª°ç»“æœå·²éšè—]'))}else{const e=t.data('acu-original-dice-text');e&&a.includes('[æŠ•éª°ç»“æœå·²éšè—]')&&(n=a.replace(/\[æŠ•éª°ç»“æœå·²éšè—\]/g,e),t.removeData('acu-original-dice-text'))}n!==a&&t.val(n).trigger('input').trigger('change')}}catch(t){console.warn('[DICE]ACU å¤„ç†è¾“å…¥æ æŠ•éª°ç»“æœå¤±è´¥:',t)}let n;try{n=getLastMessageId()}catch(t){return}if(n<0)return;try{const t=getChatMessages(`0-${n}`,{role:'user'});if(!t||0===t.length)return;if(a){let e=0;t.forEach(t=>{try{const a=retrieveDisplayedMessage(t.message_id);if(!a||!a.length)return;let n=a.find('.mes_text');n&&n.length||(n=a.find('.message-text, .text, [class*="text"], [class*="message"]').first(),n&&n.length||(n=a));const o=n.text();if(o.includes('[æŠ•éª°ç»“æœå·²éšè—]'))return;const i=t.message||'';if(!i)return;let r=i;const c=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g;c.test(r)&&(r=r.replace(c,'[æŠ•éª°ç»“æœå·²éšè—]'));const s=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g;if(s.test(r)&&(r=r.replace(s,'[æŠ•éª°ç»“æœå·²éšè—]')),r!==i&&r!==o){const t=n.html();let a=t;const o=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g;o.test(t)&&(a=a.replace(o,'[æŠ•éª°ç»“æœå·²éšè—]'));const i=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g;i.test(t)&&(a=a.replace(i,'[æŠ•éª°ç»“æœå·²éšè—]')),a!==t&&(n.html(a),e++)}}catch(e){console.warn(`[DICE]ACU éšè—ç¬¬ ${t.message_id} æ¥¼æŠ•éª°ç»“æœå¤±è´¥:`,e)}}),e>0&&console.info(`[DICE]å·²éšè— ${e} æ¡æ¶ˆæ¯çš„æŠ•éª°ç»“æœ`)}else{let e=0;t.forEach(t=>{try{const a=retrieveDisplayedMessage(t.message_id);if(!a||!a.length)return;const n=a.find('.mes_text');if(!n||!n.length)return;if(n.text().includes('[æŠ•éª°ç»“æœå·²éšè—]')){const a=t.message||'';a&&(n.text(a),e++)}}catch(t){}}),e>0&&console.info(`[DICE]å·²æ¢å¤ ${e} æ¡æ¶ˆæ¯çš„æŠ•éª°ç»“æœ`)}}catch(t){a&&console.warn('[DICE]ACU å¤„ç†èŠå¤©è®°å½•æŠ•éª°ç»“æœå¤±è´¥:',t)}}catch(t){const e=xt();e&&(e.hideDiceResultFromUser||e.hideDiceResultInChat)&&console.warn('[DICE]ACU éšè—æŠ•éª°ç»“æœå¤±è´¥:',t)}},kt=[{format:'acu_attr_preset_v1',version:T,id:'coc7',name:'ç®€åŒ–COCè§„åˆ™',builtin:!0,description:'åŸºäºå…‹è‹é²çš„å‘¼å”¤ç¬¬7ç‰ˆè§„åˆ™çš„å±æ€§é¢„è®¾ã€‚åŒ…å«8æ¡åŸºæœ¬å±æ€§å’Œ16æ¡ç‰¹æ®Šå±æ€§ã€‚',baseAttributes:[{name:'åŠ›é‡',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'ä½“è´¨',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'æ•æ·',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'å¤–è²Œ',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'æ„å¿—',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'å¹¸è¿',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'æ™ºåŠ›',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'},{name:'æ•™è‚²',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'}],specialAttributes:[{name:'ä¾¦æŸ¥',formula:'10+5d20',range:[15,95]},{name:'è†å¬',formula:'10+5d20',range:[15,95]},{name:'å¿ƒç†å­¦',formula:'10+5d20',range:[15,95]},{name:'è¯´æœ',formula:'5+4d20',range:[9,85]},{name:'è¯æœ¯',formula:'5+4d20',range:[9,85]},{name:'æ½œè¡Œ',formula:'5+4d20',range:[9,85]},{name:'æ ¼æ–—',formula:'5+4d20',range:[9,85]},{name:'å°„å‡»',formula:'5+4d20',range:[9,85]},{name:'é­…æƒ‘',formula:'5+3d20',range:[8,65]},{name:'æå“',formula:'5+3d20',range:[8,65]},{name:'å›¾ä¹¦é¦†ä½¿ç”¨',formula:'5+3d20',range:[8,65]},{name:'æ€¥æ•‘',formula:'5+3d20',range:[8,65]},{name:'ç¥ç§˜å­¦',formula:'1+2d20',range:[3,41]},{name:'é—ªé¿',formula:'æ•æ·/2',range:[1,99]},{name:'SANå€¼',formula:'æ„å¿—',range:[1,99]},{name:'å…‹è‹é²ç¥è¯',formula:'1d5',range:[1,5]}]},{format:'acu_attr_preset_v1',version:T,id:'dnd5e',name:'ç®€åŒ–DNDè§„åˆ™',builtin:!0,description:'åŸºäºé¾™ä¸åœ°ä¸‹åŸç¬¬5ç‰ˆè§„åˆ™çš„å±æ€§é¢„è®¾ã€‚åŒ…å«6æ¡åŸºæœ¬å±æ€§å’Œ8æ¡ç‰¹æ®Šå±æ€§ã€‚',baseAttributes:[{name:'åŠ›é‡',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'æ•æ·',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'ä½“è´¨',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'æ™ºåŠ›',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'æ„ŸçŸ¥',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'é­…åŠ›',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'}],specialAttributes:[{name:'å¯Ÿè§‰',formula:'8+2d6',range:[10,20]},{name:'éšåŒ¿',formula:'8+2d6',range:[10,20]},{name:'è¿åŠ¨',formula:'5+2d6',range:[7,17]},{name:'å·§æ‰‹',formula:'5+2d6',range:[7,17]},{name:'æ´æ‚‰',formula:'5+2d6',range:[7,17]},{name:'æ¸¸è¯´',formula:'5+2d6',range:[7,17]},{name:'å¥¥ç§˜',formula:'2+2d6',range:[4,14]},{name:'æ¬ºç’',formula:'2+2d6',range:[4,14]}]}],$t=(()=>{let t=null;return{getAllPresets(){const e=Ae.get(D,[]);let a=!1;return e.forEach(t=>{const e=t.version||'0.0.0';P(e,T)<0&&(console.log(`[DICE]AttributePresetManager æ£€æµ‹åˆ°é¢„è®¾ "${t.name}" ç‰ˆæœ¬è¾ƒæ—§ (${e})ï¼Œè‡ªåŠ¨æ›´æ–°åˆ° ${T}`),t.version=T,a=!0)}),a&&(Ae.set(D,e),t=null),!a&&t||(t=[...kt,...e]),t},getActivePreset(){const t=Ae.get(I,null);return t&&this.getAllPresets().find(e=>e.id===t)||null},setActivePreset(e){try{const a=''===e||void 0===e?null:e;return Ae.set(I,a),t=null,console.log('[DICE]AttributePresetManager åˆ‡æ¢é¢„è®¾:',a),!0}catch(t){return console.error('[DICE]AttributePresetManager è®¾ç½®é¢„è®¾å¤±è´¥:',t),!1}},createPreset(e){const a=Ae.get(D,[]),n={...e,id:e.id||'custom_'+Date.now(),builtin:!1,version:e.version||T,createdAt:(new Date).toISOString()};return a.push(n),Ae.set(D,a),t=null,console.log('[DICE]AttributePresetManager åˆ›å»ºé¢„è®¾:',n.name),n},updatePreset(e,a){const n=Ae.get(D,[]),o=n.findIndex(t=>t.id===e);return!(o<0)&&(n[o]={...n[o],...a},Ae.set(D,n),t=null,console.log('[DICE]AttributePresetManager æ›´æ–°é¢„è®¾:',e),!0)},deletePreset(e){const a=Ae.get(D,[]),n=a.filter(t=>t.id!==e);return n.length!==a.length&&(Ae.set(D,n),t=null,Ae.get(I)===e&&Ae.set(I,null),console.log('[DICE]AttributePresetManager åˆ é™¤é¢„è®¾:',e),!0)},exportPreset(t){const e=this.getAllPresets().find(e=>e.id===t);if(!e)return null;const a={format:'acu_attr_preset_v1',version:T,...e};return delete a.builtin,JSON.stringify(a,null,2)},importPreset(t,e=!1){try{const a=JSON.parse(t);if('acu_attr_preset_v1'!==a.format)throw new Error('ä¸æ”¯æŒçš„é¢„è®¾æ ¼å¼');if(!a.name||!a.baseAttributes||!Array.isArray(a.baseAttributes))throw new Error('é¢„è®¾æ•°æ®ä¸å®Œæ•´');const n=a.version||'0.0.0',o=P(n,T)<0,i={...a,id:'imported_'+Date.now(),builtin:!1,version:e&&o?T:n,createdAt:(new Date).toISOString()},r=this.createPreset(i);return r&&o&&!e&&console.warn(`[DICE]AttributePresetManager å¯¼å…¥çš„é¢„è®¾ "${r.name}" ç‰ˆæœ¬è¾ƒæ—§ (${n})ï¼Œå»ºè®®æ›´æ–°åˆ° ${T}`),r}catch(t){return console.error('[DICE]AttributePresetManager å¯¼å…¥å¤±è´¥:',t),null}},clearCache(){t=null}}})(),_t=[{format:'acu_action_preset_v1',version:T,id:'__builtin_default__',name:'é»˜è®¤äº¤äº’è§„åˆ™',builtin:!0,description:'åŸºäºè¡¨æ ¼ç±»å‹çš„é»˜è®¤äº¤äº’é€‰é¡¹ï¼ŒåŒ…å«åœ°ç‚¹ã€äººç‰©ã€ç‰©å“ã€è£…å¤‡ã€æŠ€èƒ½ã€ä»»åŠ¡ã€åŠ¿åŠ›ç­‰å¸¸ç”¨è§„åˆ™',rules:[{table_keywords:['åœ°ç‚¹','åœ°å›¾','Location','Map','ä¸–ç•Œ','åœºæ‰€'],actions:[{label:'å‰å¾€',template:'<user>å‰å¾€{Name}ã€‚'},{label:'æ¢ç´¢',template:'<user>æ¢ç´¢{Name}ã€‚'},{label:'åœç•™',template:'<user>åœ¨{Name}åœç•™ã€‚'}]},{table_keywords:['äººç‰©','NPC','é‡è¦äººç‰©','è§’è‰²','å¥³ä¸»'],actions:[{label:'äº¤è°ˆ',template:'<user>ä¸{Name}äº¤è°ˆã€‚'},{label:'è§‚å¯Ÿ',template:'<user>è§‚å¯Ÿ{Name}ã€‚'},{label:'æˆ˜æ–—',template:'<user>ä¸{Name}æˆ˜æ–—ã€‚'}]},{table_keywords:['ç‰©å“','èƒŒåŒ…','é“å…·'],actions:[{label:'ä½¿ç”¨',template:'<user>ä½¿ç”¨äº†{Name}ã€‚'},{label:'æŸ¥çœ‹',template:'<user>æŸ¥çœ‹äº†{Name}ã€‚'},{label:'ä¸¢å¼ƒ',template:'<user>ä¸¢å¼ƒäº†{Name}ã€‚'}]},{table_keywords:['è£…å¤‡','æ­¦å™¨','é˜²å…·'],actions:[{label:'è£…å¤‡',template:'<user>è£…å¤‡äº†{Name}ã€‚'},{label:'å¸ä¸‹',template:'<user>å¸ä¸‹äº†{Name}ã€‚'},{label:'å–å‡º',template:'<user>å–å‡ºäº†{Name}ã€‚'}]},{table_keywords:['æŠ€èƒ½','èƒ½åŠ›'],actions:[{label:'ä½¿ç”¨',template:'<user>ä½¿ç”¨{Name}ã€‚'},{label:'ç»ƒä¹ ',template:'<user>ç»ƒä¹ {Name}ã€‚'}]},{table_keywords:['å¤‡å¿˜','ä»»åŠ¡','äº‹é¡¹'],actions:[{label:'è¿½è¸ª',template:'<user>å°†{Name}è®¾ä¸ºå½“å‰è¿½è¸ªç›®æ ‡ã€‚'},{label:'æ•´ç†',template:'<user>æ•´ç†å…³äº{Name}çš„ä¿¡æ¯ã€‚'},{label:'æ”¾å¼ƒ',template:'<user>æ”¾å¼ƒäº†{Name}ã€‚'}]},{table_keywords:['åŠ¿åŠ›','ç»„ç»‡','é˜µè¥'],actions:[{label:'æ‰“æ¢',template:'<user>æ‰“æ¢{Name}çš„æƒ…æŠ¥ã€‚'},{label:'åŠ å…¥',template:'<user>ç”³è¯·åŠ å…¥{Name}ã€‚'},{label:'åˆä½œ',template:'<user>å‘{Name}è¯·æ±‚åˆä½œã€‚'}]}]}],Ct=(()=>{let t=null;return{getAllPresets(){if(t)return t;const e=Ae.get(F,[]);return t=[..._t,...e],t},getPresetById(t){return this.getAllPresets().find(e=>e.id===t)||null},getActivePresetId(){const t=Ae.get(S,'__builtin_default__');return null===t?'__builtin_default__':t},getActivePreset(){const t=this.getActivePresetId();return t&&'__none__'!==t?this.getPresetById(t):null},setActivePresetId(e){try{const a=''===e||null==e?'__none__':e;return Ae.set(S,a),t=null,console.log('[DICE]ActionPresetManager åˆ‡æ¢é¢„è®¾:',a),!0}catch(t){return console.error('[DICE]ActionPresetManager è®¾ç½®é¢„è®¾å¤±è´¥:',t),!1}},createPreset(e){const a=Ae.get(F,[]),n={format:'acu_action_preset_v1',version:T,...e,id:e.id||'custom_'+Date.now(),builtin:!1,createdAt:(new Date).toISOString()};return a.push(n),Ae.set(F,a),t=null,console.log('[DICE]ActionPresetManager åˆ›å»ºé¢„è®¾:',n.name),n},updatePreset(e,a){const n=Ae.get(F,[]),o=n.findIndex(t=>t.id===e);return!(o<0)&&(n[o]={...n[o],...a,version:T},Ae.set(F,n),t=null,console.log('[DICE]ActionPresetManager æ›´æ–°é¢„è®¾:',e),!0)},deletePreset(e){const a=Ae.get(F,[]),n=a.filter(t=>t.id!==e);return n.length!==a.length&&(Ae.set(F,n),t=null,Ae.get(S)===e&&Ae.set(S,null),console.log('[DICE]ActionPresetManager åˆ é™¤é¢„è®¾:',e),!0)},exportPreset(t){const e=this.getPresetById(t);if(!e)return null;const a={format:'acu_action_preset_v1',version:T,...e};return delete a.builtin,delete a.createdAt,JSON.stringify(a,null,2)},importPreset(t){try{const e=JSON.parse(t);if('acu_action_preset_v1'!==e.format)throw new Error('ä¸æ”¯æŒçš„é¢„è®¾æ ¼å¼ï¼Œéœ€è¦ acu_action_preset_v1');if(!e.name||!e.rules||!Array.isArray(e.rules))throw new Error('é¢„è®¾æ•°æ®ä¸å®Œæ•´ï¼Œéœ€è¦ name å’Œ rules å­—æ®µ');const a={...e,id:'imported_'+Date.now(),builtin:!1,version:T,createdAt:(new Date).toISOString()};return this.createPreset(a)}catch(t){return console.error('[DICE]ActionPresetManager å¯¼å…¥å¤±è´¥:',t),null}},clearCache(){t=null}}})(),Et=()=>{const t=Ae.get(M,null);return t?{...j,...t}:{...j}},At=t=>{Ae.set(M,t)},Dt=()=>{const t=Et();if(!t.enabled)return!1;return 100*Math.random()<t.crazyLevel},It=()=>{const t=Et(),e=ie||wa();if(!e)return null;const a=Ca(e||{}),n=Rt.findTable(a,'player'),o=Rt.findTable(a,'npc'),i=[];if(n?.data?.rows?.length>0){const e=pt()||'ä¸»è§’',a=ta('<user>');i.push({name:e,attrs:a,isPlayer:!0,inScene:!0,weight:t.playerWeight})}if(o){Rt.parseRows(o,'npc').forEach(e=>{if(!e.name)return;const a=String(e.inScene||'').toLowerCase(),n='true'===a||'åœ¨åœº'===a,o=ta(e.name);i.push({name:e.name,attrs:o,isPlayer:!1,inScene:n,weight:n?t.inSceneNpcWeight:t.offSceneNpcWeight})})}return 0===i.length?null:(t=>{if(!t||0===t.length)return null;const e=t.reduce((t,e)=>t+(e.weight||1),0);let a=Math.random()*e;for(const e of t)if(a-=e.weight||1,a<=0)return e;return t[t.length-1]})(i)},Ft=t=>{if(!t)return{name:'å¹¸è¿',value:50};if(t.attrs&&t.attrs.length>0){const e=t.attrs[Math.floor(Math.random()*t.attrs.length)];return{name:e.name,value:e.value}}const e=$t.getActivePreset();if(e){const t=[...e.baseAttributes||[],...e.specialAttributes||[]];if(t.length>0){const e=t[Math.floor(Math.random()*t.length)],a=e.range||[0,100],n=Math.floor((a[0]+a[1])/2);return{name:e.name,value:n}}}const a=He();if(a&&a.length>0){return{name:a[Math.floor(Math.random()*a.length)],value:50}}return{name:'å¹¸è¿',value:50}},St=()=>Math.floor(100*Math.random())+1,Mt=(t,e)=>t<=5?'å¤§æˆåŠŸ':t>=96?'å¤§å¤±è´¥':t<=e?'æˆåŠŸ':'å¤±è´¥',zt=()=>{if('normal'===(t=>{if(t<50)return'normal';const e=t<=75?.3:.5;return Math.random()<e?'contest':'normal'})(Et().crazyLevel)){const t=It();if(!t)return null;const e=Ft(t),a=St(),n=Mt(a,e.value);return`ï¼ˆå…ƒå™äº‹ï¼š${t.name}å‘èµ·äº†ã€${e.name}ã€‘æ£€å®šï¼Œæ·å‡º${a}ï¼Œç›®æ ‡${e.value}ï¼Œã€${n}ã€‘ï¼‰`}{const t=It();if(!t)return null;let e=null;for(let a=0;a<5;a++){const a=It();if(a&&a.name!==t.name){e=a;break}}if(!e){const e=Ft(t),a=St(),n=Mt(a,e.value);return`ï¼ˆå…ƒå™äº‹ï¼š${t.name}å‘èµ·äº†ã€${e.name}ã€‘æ£€å®šï¼Œæ·å‡º${a}ï¼Œç›®æ ‡${e.value}ï¼Œã€${n}ã€‘ï¼‰`}const a=Ft(t),n=Ft(e),o=St(),i=St(),r=Mt(o,a.value),c=Mt(i,n.value),s=a.value-o,l=n.value-i;let u;return u=s>l?`${t.name}èƒœå‡º`:l>s?`${e.name}èƒœå‡º`:'å¹³å±€',`ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€${t.name} ${a.name} vs ${e.name} ${n.name}ã€‘çš„å¯¹æŠ—æ£€å®šã€‚${t.name} ${a.name} (ç›®æ ‡${a.value}) æ·å‡º ${o}ï¼Œåˆ¤å®šä¸ºã€${r}ã€‘ï¼›${e.name} ${n.name} (ç›®æ ‡${n.value}) æ·å‡º ${i}ï¼Œåˆ¤å®šä¸ºã€${c}ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€${u}ã€‘ï¼‰`}},jt=t=>{const e=t.match(/^(\d+)d(\d+)(kh\d+|kl\d+|dh\d+|dl\d+)?$/i);if(!e)return NaN;const[,a,n,o]=e,i=parseInt(a,10),r=parseInt(n,10);let c=Array.from({length:i},()=>(t=>Math.floor(Math.random()*t)+1)(r));if(o){const t=o.toLowerCase(),e=parseInt(t.slice(2),10);c.sort((t,e)=>e-t),t.startsWith('kh')?c=c.slice(0,e):t.startsWith('kl')?c=c.slice(-e):t.startsWith('dh')?c=c.slice(e):t.startsWith('dl')&&(c=c.slice(0,-e))}return c.reduce((t,e)=>t+e,0)},Tt=(t,e={})=>{if(!t)return 0;let a=String(t).trim();const n=Object.keys(e).sort((t,e)=>e.length-t.length);for(const t of n){const n=e[t];'number'!=typeof n||isNaN(n)||(a=a.split(t).join(`(${n})`))}if(a=a.replace(/\d+d\d+(kh\d+|kl\d+|dh\d+|dl\d+)?/gi,t=>{const e=jt(t);return isNaN(e)?'0':String(e)}),!/^[\d\s+\-*/().]+$/.test(a))return console.warn('[DICE]evaluateFormula å…¬å¼åŒ…å«éæ³•å­—ç¬¦:',t,'â†’',a),0;try{const t=new Function(`return (${a})`)();return Math.round(t)}catch(e){return console.error('[DICE]evaluateFormula å…¬å¼è®¡ç®—å¤±è´¥:',t,'â†’',a,e),0}},Pt=(t,e,a)=>{let n=Tt(t,a);return e&&Array.isArray(e)&&2===e.length&&(n=Math.max(e[0],Math.min(e[1],n))),n},Nt={global:{tableKeywords:['å…¨å±€æ•°æ®è¡¨','å…¨å±€æ•°æ®','å…¨å±€'],columns:{detailLocation:{keywords:['å½“å‰è¯¦ç»†åœ°ç‚¹','è¯¦ç»†åœ°ç‚¹','å…·ä½“ä½ç½®','å½“å‰ä½ç½®'],fallbackIndex:null},currentLocation:{keywords:['å½“å‰æ¬¡è¦åœ°åŒº','å½“å‰æ‰€åœ¨åœ°ç‚¹','å½“å‰åœ°ç‚¹','æ‰€åœ¨åœ°ç‚¹'],fallbackIndex:2}}},player:{tableKeywords:['ä¸»è§’ä¿¡æ¯','ä¸»è§’','ç©å®¶','è§’è‰²ä¿¡æ¯','player','ç”¨æˆ·','user','<user>'],columns:{name:{keywords:['å§“å','åç§°','äººç‰©åç§°','name'],fallbackIndex:1},status:{keywords:['çŠ¶æ€å…³é”®è¯','çŠ¶æ€å…³é”®å­—','çŠ¶æ€æ ‡ç­¾','çŠ¶æ€'],fallbackIndex:null},position:{keywords:['å…·ä½“ä½ç½®','ä½ç½®','æ‰€åœ¨åœ°'],fallbackIndex:null},attrs:{keywords:['åŸºç¡€å±æ€§','å±æ€§'],fallbackIndex:null,isMultiple:!0},money:{keywords:['é‡‘é’±','èµ„é‡‘','é‡‘å¸','è´§å¸','ä½™é¢','çµçŸ³','ç§¯åˆ†','ä»£å¸','ä¿¡ç”¨ç‚¹'],fallbackIndex:null},resources:{keywords:['èµ„æºæ•°æ®','èµ„æº','resources'],fallbackIndex:null}}},location:{tableKeywords:['ä¸–ç•Œåœ°å›¾ç‚¹','åœ°å›¾ç‚¹','åœ°å›¾','åœ°ç‚¹','åœ°ç‚¹è¡¨','åœ°å›¾è¡¨','åœºæ™¯','åŒºåŸŸ','ç§˜å¢ƒ','å‰¯æœ¬','æ´åºœ','ç©ºé—´','ä½é¢','ç•ŒåŸŸ'],columns:{name:{keywords:['è¯¦ç»†åœ°ç‚¹','å…·ä½“ä½ç½®','å½“å‰åœ°ç‚¹','æ¬¡è¦åœ°åŒº','ä¸»è¦åœ°åŒº','åœ°åŒº','åœ°ç‚¹å','åç§°'],fallbackIndex:1},description:{keywords:['ç¯å¢ƒæè¿°','æè¿°','è¯´æ˜','ä»‹ç»','æ°›å›´æè¿°'],fallbackIndex:null}}},npc:{tableKeywords:['é‡è¦äººç‰©è¡¨','é‡è¦äººç‰©','NPC','äººç‰©è¡¨','äººç‰©','è§’è‰²è¡¨','è§’è‰²','character','å¼Ÿå­','æˆå‘˜','é˜Ÿå‹','ä¼™ä¼´','å® ç‰©','çµå® '],columns:{name:{keywords:['å§“å','åç§°'],fallbackIndex:1},status:{keywords:['è‡ªèº«çŠ¶æ€','çŠ¶æ€'],fallbackIndex:null},position:{keywords:['å…·ä½“ä½ç½®','ä½ç½®','æ‰€åœ¨åœ°ç‚¹','æ‰€åœ¨'],fallbackIndex:null},inScene:{keywords:['åœ¨åœºçŠ¶æ€','åœ¨åœº','æ˜¯å¦ç¦»åœº','ç¦»åœº'],fallbackIndex:null}}},quest:{tableKeywords:['ä»»åŠ¡è¡¨','å¤‡å¿˜äº‹é¡¹','ä»»åŠ¡','äº‹é¡¹','ç›®æ ‡','å¾…åŠ','ä¸»çº¿','æ”¯çº¿','å§”æ‰˜','æ‚¬èµ'],columns:{name:{keywords:['äº‹é¡¹åç§°','ä»»åŠ¡å','åç§°'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»','äº‹é¡¹ç±»å‹'],fallbackIndex:2},progress:{keywords:['è¿›åº¦','å®Œæˆåº¦','è¿›åº¦/ç»“æœ'],fallbackIndex:5},status:{keywords:['çŠ¶æ€'],fallbackIndex:6}},filters:{active:{column:'status',includes:['æ´»è·ƒ','è¿›è¡Œä¸­','è¿›è¡Œ'],excludeColumn:'type',excludes:['è§„åˆ™']}}},bag:{tableKeywords:['èƒŒåŒ…ç‰©å“','èƒŒåŒ…','ç‰©å“','é“å…·','åº“å­˜','å‚¨ç‰©è¢‹','ç©ºé—´æˆ’æŒ‡','æŒæœ‰ç‰©å“è¡¨'],columns:{name:{keywords:['ç‰©å“åç§°','åç§°','ç‰©å“å'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»','ç‰©å“ç±»å‹'],fallbackIndex:2},count:{keywords:['æ•°é‡','ä¸ªæ•°','æŒæœ‰æ•°'],fallbackIndex:3}}},skill:{tableKeywords:['ä¸»è§’æŠ€èƒ½','æŠ€èƒ½è¡¨','æŠ€èƒ½','èƒ½åŠ›','é­”æ³•','è¶…èƒ½åŠ›','å¼‚èƒ½','ç¥é€š','é“æ³•','åŠŸæ³•','è¡€è„‰','å¤©èµ‹','ä¹‰ä½“æ”¹é€ ','è¶…å‡¡èƒ½åŠ›','è¯æ¡'],columns:{name:{keywords:['æŠ€èƒ½åç§°','åç§°','æŠ€èƒ½å'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»'],fallbackIndex:2},level:{keywords:['ç­‰çº§','çº§åˆ«','ç†Ÿç»ƒåº¦','lv'],fallbackIndex:3}}},equip:{tableKeywords:['è£…å¤‡è¡¨','è£…å¤‡','æ­¦å™¨','é˜²å…·','æ³•å®','çµå™¨','ä»™å™¨','ç¥å™¨','ä¹‰ä½“','ç¥è£…'],columns:{name:{keywords:['è£…å¤‡åç§°','åç§°','è£…å¤‡å'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»'],fallbackIndex:2},part:{keywords:['éƒ¨ä½','è£…å¤‡éƒ¨ä½','ä½ç½®'],fallbackIndex:3},isEquipped:{keywords:['çŠ¶æ€','æ˜¯å¦è£…å¤‡','è£…å¤‡çŠ¶æ€','è£…å¤‡ä¸­'],fallbackIndex:4}},filters:{equipped:{column:'isEquipped',includes:['å·²è£…å¤‡','è£…å¤‡ä¸­','true','æ˜¯','yes','equipped']}}}},Rt={findTable(t,e){const a=Nt[e];if(!a)return console.info(`[DICE]ä»ªè¡¨ç›˜æŸ¥æ‰¾è¡¨æ ¼: æ¨¡å—"${e}"é…ç½®ä¸å­˜åœ¨`),null;for(const n of a.tableKeywords)for(const o in t)if(o.includes(n))return console.info(`[DICE]ä»ªè¡¨ç›˜æŸ¥æ‰¾è¡¨æ ¼: æ¨¡å—"${e}"æ‰¾åˆ°è¡¨æ ¼"${o}" (å…³é”®è¯: "${n}")`),{data:t[o],name:o,key:t[o].key,config:a};return console.info(`[DICE]ä»ªè¡¨ç›˜æŸ¥æ‰¾è¡¨æ ¼: æ¨¡å—"${e}"æœªæ‰¾åˆ°åŒ¹é…è¡¨æ ¼ (å…³é”®è¯: ${a.tableKeywords.join(', ')})`),null},findColumnIndex(t,e,a){const n=a.columns[e];if(!n)return-1;for(let e=0;e<t.length;e++){const a=String(t[e]||'').toLowerCase();if(n.keywords.some(t=>a.includes(t.toLowerCase())))return e}return n.fallbackIndex??-1},getValue(t,e,a,n){const o=this.findColumnIndex(e,a,n);return o<0||o>=t.length?null:t[o]},getColumnMap(t,e){const a=Nt[e];if(!a)return{};const n={};for(const e in a.columns)n[e]=this.findColumnIndex(t,e,a);return n},parseRows(t,e){if(!t||!t.data)return console.info(`[DICE]ä»ªè¡¨ç›˜è§£ææ•°æ®: æ¨¡å—"${e}"æ— æ•°æ®ï¼Œè·³è¿‡è§£æ`),[];const{data:a,config:n}=t,o=a.headers||[],i=a.rows||[],r=this.getColumnMap(o,e),c=i.map((t,e)=>{const a={_rowIndex:e,_raw:t};for(const e in r){const n=r[e];a[e]=n>=0&&n<t.length?t[n]:null}return a});return console.info(`[DICE]ä»ªè¡¨ç›˜è§£ææ•°æ®: æ¨¡å—"${e}"è§£æå®Œæˆï¼Œå…±${c.length}è¡Œ`),c},applyFilter(t,e,a){const n=Nt[a];if(!n||!n.filters||!n.filters[e])return t;const o=n.filters[e];return t.some(t=>null!==t[o.column]&&void 0!==t[o.column])?t.filter(t=>{const e=String(t[o.column]||'').toLowerCase(),a=o.includes.some(t=>e.includes(t.toLowerCase()));if(o.excludeColumn&&o.excludes){const e=String(t[o.excludeColumn]||'').toLowerCase(),n=o.excludes.some(t=>e.includes(t.toLowerCase()));return a&&!n}return a}):t}},Ot={enabled:!0,diceSystem:'1d100',showDiceIcon:!0,autoSendPrompt:!0,action_groups:[{table_keywords:['åœ°ç‚¹','åœ°å›¾','Location','Map','ä¸–ç•Œ','åœºæ‰€'],actions:[{label:'å‰å¾€',icon:'fa-walking',type:'prompt',template:'<user>å‰å¾€{Name}ã€‚',auto_send:!0},{label:'æ¢ç´¢',icon:'fa-search',type:'prompt',template:'<user>æ¢ç´¢{Name}ã€‚',auto_send:!0},{label:'åœç•™',icon:'fa-clock',type:'prompt',template:'<user>åœ¨{Name}åœç•™ã€‚',auto_send:!0}]},{table_keywords:['äººç‰©','NPC','é‡è¦äººç‰©','è§’è‰²','å¥³ä¸»'],actions:[{label:'äº¤è°ˆ',icon:'fa-comments',type:'prompt',template:'<user>ä¸{Name}äº¤è°ˆã€‚',auto_send:!0},{label:'è§‚å¯Ÿ',icon:'fa-eye',type:'prompt',template:'<user>è§‚å¯Ÿ{Name}ã€‚',auto_send:!0},{label:'æˆ˜æ–—',icon:'fa-hand-fist',type:'prompt',template:'<user>ä¸{Name}æˆ˜æ–—ã€‚',auto_send:!0}]},{table_keywords:['ç‰©å“','èƒŒåŒ…','é“å…·'],actions:[{label:'ä½¿ç”¨',icon:'fa-hand-pointer',type:'prompt',template:'<user>ä½¿ç”¨äº†{Name}ã€‚',auto_send:!0},{label:'æŸ¥çœ‹',icon:'fa-eye',type:'prompt',template:'<user>æŸ¥çœ‹äº†{Name}ã€‚',auto_send:!0},{label:'ä¸¢å¼ƒ',icon:'fa-trash',type:'prompt',template:'<user>ä¸¢å¼ƒäº†{Name}ã€‚',auto_send:!0}]},{table_keywords:['è£…å¤‡','æ­¦å™¨','é˜²å…·'],actions:[{label:'è£…å¤‡',icon:'fa-shield-halved',type:'prompt',template:'<user>è£…å¤‡äº†{Name}ã€‚',auto_send:!0},{label:'å¸ä¸‹',icon:'fa-circle-xmark',type:'prompt',template:'<user>å¸ä¸‹äº†{Name}ã€‚',auto_send:!0},{label:'å–å‡º',icon:'fa-coins',type:'prompt',template:'<user>å–å‡ºäº†{Name}ã€‚',auto_send:!0}]},{table_keywords:['æŠ€èƒ½','èƒ½åŠ›'],actions:[{label:'ä½¿ç”¨',icon:'fa-wand-magic-sparkles',type:'skill_check',template:'<user>ä½¿ç”¨{Name}ã€‚',auto_send:!0},{label:'ç»ƒä¹ ',icon:'fa-dumbbell',type:'prompt',template:'<user>ç»ƒä¹ {Name}ã€‚',auto_send:!0}]},{table_keywords:['å¤‡å¿˜','ä»»åŠ¡','äº‹é¡¹'],actions:[{label:'è¿½è¸ª',icon:'fa-crosshairs',type:'prompt',template:'<user>å°†{Name}è®¾ä¸ºå½“å‰è¿½è¸ªç›®æ ‡ã€‚',auto_send:!0},{label:'æ•´ç†',icon:'fa-list-check',type:'prompt',template:'<user>æ•´ç†å…³äº{Name}çš„ä¿¡æ¯ã€‚',auto_send:!0},{label:'æ”¾å¼ƒ',icon:'fa-circle-xmark',type:'prompt',template:'<user>æ”¾å¼ƒäº†{Name}ã€‚',auto_send:!0}]},{table_keywords:['åŠ¿åŠ›','ç»„ç»‡','é˜µè¥'],actions:[{label:'æ‰“æ¢',icon:'fa-ear-listen',type:'prompt',template:'<user>æ‰“æ¢{Name}çš„æƒ…æŠ¥ã€‚',auto_send:!0},{label:'åŠ å…¥',icon:'fa-user-plus',type:'prompt',template:'<user>ç”³è¯·åŠ å…¥{Name}ã€‚',auto_send:!0},{label:'åˆä½œ',icon:'fa-handshake',type:'prompt',template:'<user>å‘{Name}è¯·æ±‚åˆä½œã€‚',auto_send:!0}]}]},Bt=t=>{const e={critSuccess:'acu-result-badge acu-result-badge-crit-success',extremeSuccess:'acu-result-badge acu-result-badge-extreme-success',success:'acu-result-badge acu-result-badge-success',warning:'acu-result-badge acu-result-badge-warning',failure:'acu-result-badge acu-result-badge-failure',critFailure:'acu-result-badge acu-result-badge-crit-failure'};return e[t]||e.failure},Lt={æˆ˜æ–—:'fa-hand-fist',æ”»å‡»:'fa-hand-fist',é˜²å¾¡:'fa-shield',é€ƒè·‘:'fa-person-running',äº¤è°ˆ:'fa-comments',å¯¹è¯:'fa-comments',å‘Šåˆ«:'fa-hand',æ±‚çˆ±:'fa-heart',é‚€çº¦:'fa-calendar-check',èµ é€:'fa-gift',é€ç¤¼:'fa-gift',è§‚å¯Ÿ:'fa-eye',æŸ¥çœ‹:'fa-eye',æ£€æŸ¥:'fa-magnifying-glass',ä½¿ç”¨:'fa-hand-pointer',ä¸¢å¼ƒ:'fa-trash',è£…å¤‡:'fa-shield-halved',å¸ä¸‹:'fa-circle-xmark',å–å‡º:'fa-coins',è´­ä¹°:'fa-shopping-cart',å‰å¾€:'fa-walking',æ¢ç´¢:'fa-search',åœç•™:'fa-clock',ç¦»å¼€:'fa-door-open',ç»ƒä¹ :'fa-dumbbell',æ–½å±•:'fa-wand-magic-sparkles',å‡ç»ƒ:'fa-fire',è¿½è¸ª:'fa-crosshairs',æ•´ç†:'fa-list-check',æ”¾å¼ƒ:'fa-circle-xmark',å®Œæˆ:'fa-check',æ‰“æ¢:'fa-ear-listen',åŠ å…¥:'fa-user-plus',åˆä½œ:'fa-handshake',è¡¨æ¼”:'fa-music',æ¼”å¥:'fa-guitar',å”±æ­Œ:'fa-microphone'},Ut=t=>{const e=(()=>{const t=Ae.get('acu_gm_engine_config_v1',Ot);if('__none__'===Ct.getActivePresetId())return{...t,action_rules_disabled:!0};const e=Ct.getActivePreset();if(e&&e.rules&&e.rules.length>0){const a=e.rules.map(t=>({table_keywords:t.table_keywords||[],actions:(t.actions||[]).map(t=>({label:t.label,icon:t.icon||Lt[t.label]||'fa-circle',type:'prompt',template:t.template||`<user>å¯¹{Name}æ‰§è¡Œäº’åŠ¨:${t.label}ã€‚`,auto_send:!1}))}));return{...t,custom_action_groups:a}}return t})();if(!e.enabled)return[];if(e.action_rules_disabled)return[];const a=t.toLowerCase(),n=e.custom_action_groups||[];for(const t of n){if(t.table_keywords.some(t=>a.includes(t.toLowerCase())))return[...t.actions||[]]}const o=e.action_groups||[];for(const t of o){if(t.table_keywords.some(t=>a.includes(t.toLowerCase())))return[...t.actions||[]]}return[]},Vt=(t,e,a)=>{const n=[...Ut(t)],o=e.findIndex(t=>t&&String(t).includes('äº¤äº’'));if(o<0||!a[o])return n;const i=['-','null','none','æ— ','ç©º','n/a','undefined','/'],r=String(a[o]).trim();if(!r||i.includes(r.toLowerCase()))return n;const c=r.split(/[,ï¼Œã€;ï¼›]/).map(t=>t.trim()).filter(t=>t&&!i.includes(t.toLowerCase()));if(0===c.length)return n;const s=n.map(t=>t.label.toLowerCase()),l=c.filter(t=>!s.includes(t.toLowerCase())).map(t=>({label:t,icon:Lt[t]||'fa-hand-pointer',type:'prompt',template:`<user>å¯¹{Name}æ‰§è¡Œäº’åŠ¨:${t}ã€‚`,auto_send:!0}));return[...n,...l]},qt=t=>{if(null==t||''===t)return!1;const e=String(t).trim();return/^-?\d+(\.\d+)?%?$/.test(e)||/^\d+\/\d+$/.test(e)||/^[\u4e00-\u9fa5a-zA-Z]+[:\sï¼š]\s*\d+/i.test(e)||/\d+/.test(e)},Yt=t=>{if(!t)return 0;const e=String(t).trim();if(/^\d+\/\d+$/.test(e))return parseInt(e.split('/')[0],10);if(e.endsWith('%'))return parseInt(e.replace('%',''),10);const a=e.match(/\d+/g);return a&&a.length>0?parseInt(a[a.length-1],10):0},Jt=t=>{if(!t)return[];const e=[],a=String(t).trim();if(a.startsWith('{')&&a.endsWith('}'))try{const t=JSON.parse(a);for(const a in t){const n=t[a];'number'==typeof n?e.push({name:a,value:n}):'string'==typeof n&&/^\d+$/.test(n)&&e.push({name:a,value:parseInt(n,10)})}if(e.length>0)return e}catch(t){}const n=a.split(/[,;ï¼Œï¼›\s]+/);for(const t of n){const a=t.match(/^"?([\u4e00-\u9fa5a-zA-Z_]+)"?[:\sï¼š]\s*"?(-?\d+)"?/);a&&e.push({name:a[1],value:parseInt(a[2],10)})}return e},Wt=t=>{if(!t)return[];const e=[],a=String(t).trim().split(/[;ï¼›]/);for(const t of a){const a=t.trim();if(!a)continue;const n=a.match(/^ä¸?(.+?)[:ï¼š](.+)$/);if(n){const t=n[1].trim(),a=n[2].trim();if(t&&a){e.push({name:t,relation:a});continue}}const o=a.match(/^([^(ï¼ˆ]+)[(ï¼ˆ]([^)ï¼‰]+)[)ï¼‰]$/);o?e.push({name:o[1].trim(),relation:o[2].trim()}):a.length>0&&e.push({name:a,relation:''})}return e},Xt=(t,e)=>{if(!t)return!1;const a=String(t).trim(),n=(e||'').toLowerCase();return!(!n.includes('å…³ç³»')&&!n.includes('äººé™…'))||/^[^(ï¼ˆ;ï¼›]+[(ï¼ˆ][^)ï¼‰]+[)ï¼‰]([;ï¼›][^(ï¼ˆ;ï¼›]+[(ï¼ˆ][^)ï¼‰]+[)ï¼‰])*$/.test(a)},Ht=(t,e,a)=>{if(!t||!e)return t;let n=t;const o=e[1]||'æœªçŸ¥';return n=n.replace(/\{Name\}/gi,o),n=n.replace(/\{RowIndex\}/gi,e[0]||'0'),a&&a.length>0&&a.forEach((t,a)=>{if(t&&a<e.length){const o=e[a]||'æœªçŸ¥',i=new RegExp(`\\{${t}\\}`,'gi');n=n.replace(i,o)}}),n=n.replace(/\{[^}]+\}/g,'æœªçŸ¥'),n},Kt=[{id:'acu-btn-refresh',icon:'fa-sync-alt',title:'é‡æ–°åŠ è½½'},{id:'acu-btn-open-editor',icon:'fa-database',title:'æ‰“å¼€ç¥-æ•°æ®åº“'},{id:'acu-btn-collapse',icon:'fa-chevron-down',title:'æ”¶èµ·é¢æ¿'},{id:'acu-btn-refill',icon:'fa-bolt',title:'é‡æ–°å¡«è¡¨'},{id:'acu-btn-settings',icon:'fa-cog',title:'å…¨èƒ½è®¾ç½®'}];let Gt=!1,Qt=!1,Zt=Promise.resolve(),te=!1,ee=!1,ae=new Set,ne=null,oe=null,ie=null,re=!1,ce={};const se=()=>ce;let le=!1,ue={},de={},pe=null,ge=!1;const fe='acu_scroll_v19_fixed';let be={};try{const t=localStorage.getItem(fe);t&&(be=JSON.parse(t))}catch(t){console.warn('[DICE]ACU Error:',t)}const me={_lastValidationCount:0,_isRollingBack:!1,handleUpdate:()=>{if(!me._isRollingBack){try{const t=Ne(),e=wa();if(t&&e){const a=at.getEnabledRules(),n=rt.checkTableRules(t,e,a);if(n.length>0){console.warn('[DICE]ACU è§„åˆ™æ‹¦æˆªè§¦å‘ï¼Œæ‰§è¡Œå›æ»š:',n),me._isRollingBack=!0;const e=$e().getDB();if(e?.fillTable)try{e.fillTable(t),window.toastr&&window.toastr.error(n[0].message,'å·²å›æ»š',{timeOut:5e3,positionClass:'toast-bottom-right'})}catch(t){console.error('[DICE]ACU fillTable å›æ»šå¤±è´¥:',t),window.toastr&&window.toastr.error(`è§„åˆ™æ‹¦æˆª: ${n[0].message}ï¼ˆå›æ»šæ“ä½œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°ï¼‰`,'é”™è¯¯',{timeOut:7e3,positionClass:'toast-bottom-right'})}return void setTimeout(()=>{me._isRollingBack=!1},500)}}}catch(t){console.error('[DICE]ACU æ‹¦æˆªæ£€æŸ¥å¤±è´¥:',t)}nn(),setTimeout(()=>{try{const t=ie||wa();if(t){const e=rt.validateAllData(t).length;me._lastValidationCount,me._lastValidationCount=e,ve(e)}}catch(t){console.error('[DICE]ACU éªŒè¯æ‰§è¡Œå¤±è´¥:',t)}},100)}}},ve=t=>{const{$}=$e(),e=$('.acu-validation-indicator');t>0?e.length&&(e.find('.acu-validation-count').text(t),e.show()):e.hide()},he=()=>{try{if('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId)return SillyTavern.getCurrentChatId();if('undefined'!=typeof SillyTavern&&SillyTavern.chatId)return SillyTavern.chatId;if(window.parent?.SillyTavern?.getCurrentChatId)return window.parent.SillyTavern.getCurrentChatId()}catch(t){console.warn('[DICE]ACU getCurrentContextFingerprint error:',t)}return'unknown_context'},xe={layout:'horizontal',collapseStyle:'bar',collapseAlign:'right',fontFamily:'default',theme:'retro',cardWidth:260,fontSize:13,highlightNew:!0,itemsPerPage:50,actionsPosition:'bottom',gridColumns:'auto',positionMode:'fixed',showOptionPanel:!0,clickOptionToAutoSend:!0,optionFontSize:12},ye=[{id:'default',name:'ç³»ç»Ÿé»˜è®¤ (Modern)',val:'\'Segoe UI\', \'Microsoft YaHei\', sans-serif'},{id:'hanchan',name:'å¯’è‰å…¨åœ†ä½“',val:'"å¯’è‰å…¨åœ†ä½“", sans-serif'},{id:'maple',name:'Maple Mono (ä»£ç é£)',val:'"Maple Mono NF CN", monospace'},{id:'huiwen',name:'æ±‡æ–‡æ˜æœä½“ (Huiwen)',val:'"Huiwen-mincho", serif'},{id:'cooper',name:'Cooperæ­£æ¥·',val:'"CooperZhengKai", serif'},{id:'yffyt',name:'YFFYT (è‰ºæœ¯ä½“)',val:'"YFFYT", sans-serif'},{id:'fusion',name:'Fusion Pixel (åƒç´ é£)',val:'"Fusion Pixel 12px M latin", monospace'},{id:'wenkai',name:'éœé¹œæ–‡æ¥· (WenKai)',val:'"LXGW WenKai", serif'},{id:'notosans',name:'æ€æºé»‘ä½“ (Noto Sans)',val:'"Noto Sans CJK", sans-serif'},{id:'zhuque',name:'æœ±é›€ä»¿å®‹ (Zhuque)',val:'"Zhuque Fangsong (technical preview)", serif'}],we=[{id:'retro',name:'å¤å¤ç¾Šçš® (Retro)',icon:'fa-scroll'},{id:'dark',name:'æå¤œæ·±ç©º (Dark)',icon:'fa-moon'},{id:'modern',name:'ç°ä»£æ¸…çˆ½ (Modern)',icon:'fa-sun'},{id:'forest',name:'æ£®ä¹‹ç‰©è¯­ (Forest)',icon:'fa-tree'},{id:'ocean',name:'æ·±æµ·å¹½è“ (Ocean)',icon:'fa-water'},{id:'cyber',name:'èµ›åšéœ“è™¹ (Cyber)',icon:'fa-bolt'},{id:'nightowl',name:'æ·±è“ç£¨ç ‚ (Night Owl)',icon:'fa-feather'},{id:'sakura',name:'æš–ç²‰æ‰‹è´¦ (Warm Pink)',icon:'fa-heart'},{id:'minepink',name:'é‡äº§åœ°é›· (Mine Pink)',icon:'fa-skull'},{id:'galgame',name:'ç²‰æ¢¦ç‰©è¯­ (Galgame Pink)',icon:'fa-heart'},{id:'purple',name:'ç´«ç½—å…°æ¢¦ (Purple)',icon:'fa-gem'},{id:'wechat',name:'ç»¿è‰²æ³¡æ³¡ (Green Bubble)',icon:'fa-weixin'},{id:'educational',name:'å­¦ä¹ èµ„æ–™ (Educational)',icon:'fa-book'},{id:'vaporwave',name:'éœ“è™¹æ€€æ—§ (Vaporwave)',icon:'fa-palette'},{id:'classicpackaging',name:'ç»å…¸åŒ…è£… (Classic Packaging)',icon:'fa-box'},{id:'terminal',name:'ç»ˆç«¯ç»¿å± (Terminal)',icon:'fa-terminal'},{id:'dreamcore',name:'æ¢¦æ ¸è¿·ç¦» (Dreamcore)',icon:'fa-cloud-moon'},{id:'aurora',name:'æå…‰å¹»å¢ƒ (Aurora)',icon:'fa-snowflake'},{id:'chouten',name:'å¹»å¤œéœ“è™¹ (Cyber Kawaii)',icon:'fa-star'}];let ke=null;const $e=()=>{const t=window.parent||window,$=window.jQuery||t.jQuery;if(ke&&ke.$)return ke;const e={$,getDB:()=>t.AutoCardUpdaterAPI||window.AutoCardUpdaterAPI,clipboard:t.navigator.clipboard,ST:window.SillyTavern||t.SillyTavern||(()=>{try{return window.top?window.top.SillyTavern:null}catch(t){return null}})()};return $&&(ke=e),e},_e=()=>{const{$}=$e(),t=$('#acu-btn-save-global'),e=t.find('i'),a=se();let n=!1;if(a)for(const t in a)if(a[t]&&a[t].length>0){n=!0;break}re||n?(e.addClass('acu-icon-breathe'),t.attr('title','ä½ æœ‰æœªä¿å­˜çš„æ‰‹åŠ¨ä¿®æ”¹æˆ–åˆ é™¤æ“ä½œ')):(e.removeClass('acu-icon-breathe'),t.attr('title','ä¿å­˜'),t.css('color',''))},Ce=t=>{if(!t)return'fa-table';const e=t.toLowerCase();return e.includes('ä¸»è§’')||e.includes('è§’è‰²')?'fa-user-circle':e.includes('é€šç”¨')||e.includes('å…¨å±€')?'fa-globe-asia':e.includes('è£…å¤‡')||e.includes('èƒŒåŒ…')?'fa-briefcase':e.includes('æŠ€èƒ½')||e.includes('æ­¦é­‚')?'fa-dragon':e.includes('å…³ç³»')||e.includes('å‘¨è¾¹')?'fa-user-friends':e.includes('ä»»åŠ¡')||e.includes('æ—¥å¿—')?'fa-scroll':e.includes('äººç‰©')||e.includes('å…³é”®äººç‰©')?'fa-address-book':e.includes('æ€»ç»“')||e.includes('å¤§çº²')?'fa-book-reader':e.includes('åœ°å›¾ç‚¹')||e.includes('ä¸–ç•Œåœ°å›¾')?'fa-map-location-dot':e.includes('åœ°å›¾å…ƒç´ ')||e.includes('æœºå…³')||e.includes('çº¿ç´¢')?'fa-bullseye':e.includes('åŠ¿åŠ›')||e.includes('é˜µè¥')?'fa-shield-halved':e.includes('ç‰©å“')?'fa-gem':e.includes('æƒ…æŠ¥')||e.includes('ä¿¡æ¯')?'fa-file-lines':e.includes('é€‰é¡¹')?'fa-list-check':'fa-table'},Ee=t=>{if(!t)return'';const e=String(t).trim();return/^[0-9]+%?$/.test(e)||/^Lv\.\d+$/.test(e)?'acu-badge-green':e.length<=6&&!e.includes('http')||['æ˜¯','å¦','æœ‰','æ— ','æ­»äº¡','å­˜æ´»'].includes(e)?'acu-badge-neutral':''},Ae={get:(t,e=null)=>{try{return JSON.parse(localStorage.getItem(t))??e}catch{return e}},set:(t,e)=>{try{localStorage.setItem(t,JSON.stringify(e))}catch(a){if('QuotaExceededError'===a.name||a.message.includes('quota')){console.warn('[DICE]ACU å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè§¦å‘é™é»˜æ¸…ç†ç­–ç•¥...');try{localStorage.removeItem(b),localStorage.setItem(t,JSON.stringify(e))}catch(t){console.error('[DICE]ACU Store æ¸…ç†åä¾ç„¶å¤±è´¥',t),window.toastr&&!window._acuQuotaAlerted&&(window.toastr.warning('âš ï¸ æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼Œé…ç½®ä¿å­˜å¤±è´¥'),window._acuQuotaAlerted=!0,setTimeout(()=>window._acuQuotaAlerted=!1,1e4))}}else console.error('[DICE]ACU Store',a)}}},De=()=>Ae.get(g),Ie=t=>Ae.set(g,t),Fe=()=>{Ae.set(h,!1),Ae.set('acu_changes_panel_active',!1),Ae.set('acu_favorites_panel_active',!1),Ie(null)};function Se(){return De()===vt.MODULE_ID&&(!Ae.get('acu_changes_panel_active',!1)&&(!Ae.get('acu_favorites_panel_active',!1)&&!Ae.get(h,!1)))}const Me=()=>Ae.get(p),ze=t=>Ae.set(p,t),je=()=>Ae.get(m,!1),Te=t=>Ae.set(m,t),Pe=()=>Ae.get(v,!1),Ne=()=>{const t=Ae.get(b);if(!t)return null;const e=he();return t._contextId&&t._contextId!==e?null:t},Re=t=>{t&&('object'==typeof t&&(t._contextId=he()),Ae.set(b,t))},Oe=()=>Ae.get(x,{}),Be=t=>Ae.set(x,t),Le=()=>Ae.get(y,{}),Ue=()=>Ae.get(w,[]),Ve=()=>Ae.get(k,[]),qe=t=>{const e=Ve(),a=e.indexOf(t);var n;a>=0?e.splice(a,1):e.push(t),n=e,Ae.set(k,n),console.log('[DICE]ACU toggleTableReverse:',t,'reversed:',a<0)},Ye=t=>{const e=ie||wa();if(!e)return[];const a=!t||'<user>'===t||''===t.trim();for(const n in e){const o=e[n];if(!o||!o.name||!o.content)continue;const i=o.name;if(a&&(i.includes('ä¸»è§’')||i.includes('ç©å®¶')||i.toLowerCase().includes('player'))&&o.content[1]){const t=o.content[0]||[],e=o.content[1];let a=[];if(t.forEach((t,n)=>{if(t&&t.includes('å±æ€§')){Jt(e[n]||'').forEach(t=>{a.includes(t.name)||a.push(t.name)})}}),a.length>0)return a}if(!a&&(i.includes('äººç‰©')||i.includes('NPC')||i.includes('è§’è‰²')||i.toLowerCase().includes('character'))){const e=o.content[0]||[];let a=1;for(let t=0;t<e.length;t++)if(e[t]&&(e[t].includes('å§“å')||e[t].includes('åç§°')||e[t].toLowerCase().includes('name'))){a=t;break}for(let n=1;n<o.content.length;n++){const i=o.content[n];if(i&&i[a]===t){let t=[];return e.forEach((e,a)=>{if(e&&e.includes('å±æ€§')){Jt(i[a]||'').forEach(e=>{t.includes(e.name)||t.push(e.name)})}}),t}}}}return[]},Je=(t,e)=>{const a=ie||wa();if(!a||!e)return null;const n=!t||'<user>'===t||''===t.trim();for(const o in a){const i=a[o];if(!i||!i.name||!i.content)continue;const r=i.name;if(n&&(r.includes('ä¸»è§’')||r.includes('ç©å®¶')||r.toLowerCase().includes('player'))&&i.content[1]){const t=i.content[0]||[],a=i.content[1];for(let n=0;n<t.length;n++){const o=t[n];if(o&&o.includes('å±æ€§')){const t=Jt(a[n]||'').find(t=>t.name===e);if(t)return t.value}}}if(!n&&(r.includes('äººç‰©')||r.includes('NPC')||r.includes('è§’è‰²')||r.toLowerCase().includes('character'))){const a=i.content[0]||[];let n=1;for(let t=0;t<a.length;t++)if(a[t]&&(a[t].includes('å§“å')||a[t].includes('åç§°')||a[t].toLowerCase().includes('name'))){n=t;break}for(let o=1;o<i.content.length;o++){const r=i.content[o];if(r&&r[n]===t)for(let t=0;t<a.length;t++){const n=a[t];if(n&&n.includes('å±æ€§')){const a=Jt(r[t]||'').find(t=>t.name===e);if(a)return a.value}}}}}return null},We=['åŠ›é‡','æ•æ·','ä½“è´¨','æ™ºåŠ›','æ„ŸçŸ¥','é­…åŠ›'],Xe=()=>{const t=$t.getActivePreset();return t&&t.baseAttributes?t.baseAttributes.map(t=>t.name):We},He=()=>{try{const t=$t.getActivePreset();if(t){const e=new Set;return t.baseAttributes&&Array.isArray(t.baseAttributes)&&t.baseAttributes.forEach(t=>{const a='string'==typeof t?t:t&&t.name;a&&e.add(a)}),t.specialAttributes&&Array.isArray(t.specialAttributes)&&t.specialAttributes.forEach(t=>{const a='string'==typeof t?t:t&&t.name;a&&e.add(a)}),Array.from(e)}const e=$t.getAllPresets()||[],a=new Set(Ke||[]);return Array.isArray(e)&&e.forEach(t=>{t&&(t.baseAttributes&&Array.isArray(t.baseAttributes)&&t.baseAttributes.forEach(t=>{const e='string'==typeof t?t:t&&t.name;e&&a.add(e)}),t.specialAttributes&&Array.isArray(t.specialAttributes)&&t.specialAttributes.forEach(t=>{const e='string'==typeof t?t:t&&t.name;e&&a.add(e)}))}),Array.from(a)}catch(t){return console.error('[DICE]ACU getRandomSkillPool é”™è¯¯:',t),Ke||[]}},Ke=['æ‚æŠ€','ç‰¹æŠ€','è¿åŠ¨','æ ¼æ–—','æ–—æ®´','æ”€çˆ¬','å¥åº·','é—ªé¿','èº«æ³•','é©¾é©¶','è€åŠ›','çµå·§','å·§æ‰‹','æˆæ³•','è·‘é…·','é£è¡Œ','æ½œè¡Œ','æ¸—é€','éª‘æœ¯','æ¸¸æ³³','æŠ•æ·','è·³è·ƒ','ä½“æ“','åŠŸå¤«','æ­¦æœ¯','è¡Œæ”¿','å®˜åƒš','æƒå¨','å‘½ä»¤','äº¤æ˜“','æ®å®¢','æ¬ºè¯ˆ','è¯±éª—','è°è¨€ä¾¦æµ‹','ç‹‚æ¬¢','äº¤é™…','æ‘†å¸ƒ','é•‡å®š','é»‘è¯','è¡Œè¯','ç¤¼èŠ‚','ç¤¼ä»ª','ä¿¡èª‰','è´¢åŠ›','æˆå‰§','è¡¨æ¼”','å…±æƒ…','æ´å¯Ÿ','æƒ…æ„Ÿ','å›¢é˜Ÿç²¾ç¥','è¯æœ¯','åšå¼ˆ','èµŒåš','é˜…äºº','å°é€æ˜','å®¡è®¯','æå“','æŒ‘è¡…','é¢†å¯¼','è°ˆåˆ¤','æ¼”è¯´','ç²¾ç¥åˆ†æ','è¡—å¤´æ™ºæ…§','è¾¹ç¼˜çŸ¥è¯†','æ®‹é…·çœŸç›¸','æ„å¿—','å†³å¿ƒ','è¯´æœ','é­…æƒ‘','å¨å“','æ¸¸è¯´','äº¤æ¶‰','å¯Ÿè¨€è§‚è‰²','æ¬ºéª—','æ´æ‚‰','æ¬ºç’','æ ‡æ–°ç«‹å¼‚','è„‘å†…å‰§åœº','ç¥æ¸¸å¤ªè™š','è¸©åœ°é›·','é¡¾å·¦å³è€Œè¨€ä»–','ä¸»è§’å…‰ç¯','åšé¢œæ— è€»','ç”©é”…','é€ å‡','åºŸè¯æ–‡å­¦','ä¸Šå¤´','ç ´é˜²','ç§è‰','ç¤¾æ­»','ç‚¹å­','æƒŠä¸–æ™ºæ…§','å¥¶é¾™ä¹‹åŠ›','ç‹—å±è¿','å¤©æ„','æ¡ƒèŠ±è¿','å»ºç­‘å­¦','å†›æ¢°','æªæ¢°åˆ¶é€ ','å·¥åŒ ','æŠ€è‰º','ç”Ÿç‰©ç§‘æŠ€','éœ²è¥','åŒ–å­¦','è¯ç†','åˆ›ä½œ','ç”µè„‘','é»‘å®¢','èµ›åšæŠ€æœ¯','çˆ†ç ´','ç”µå­å­¦','å·¥ç¨‹å­¦','æ€¥æ•‘','ä¼ªé€ ','ä¿¡æ¯å®‰å…¨','ä¿®è¡¥','æ£é¼“','å¼€é”','æœºæ¢°','ä¿®ç†','åŒ»å­¦','æ‘„å½±','ç¼–ç¨‹','é”»é€ ','ç¼–è¯‘','ç§‘æŠ€ä½¿ç”¨','æœºæ¢°ç»´ä¿®','ç”µæ°”ç»´ä¿®','é”åŒ ','æ“ä½œé‡å‹æœºæ¢°','è¯å­¦','è‰ºæœ¯','ä¼šè®¡','äººç±»å­¦','æ™ºæ…§ç”Ÿç‰©å­¦','è€ƒå¤å­¦','çµè§†','å¯¼èˆª','æ–¹å‘','å¤©æ–‡å­¦','ç”Ÿç‰©å­¦','çŠ¯ç½ªå­¦','ç¥è¯','ç¦å¿ŒçŸ¥è¯†','æ–‡åŒ–','ä¹ ä¿—','æ³•åŒ»','æœè¯','å†å²','äººåŠ›æƒ…æŠ¥','è°ƒæŸ¥','æœç´¢','è¯­è¨€','è¯­è¨€å­¦','æ³•å¾‹','å›¾ä¹¦é¦†ä½¿ç”¨','ç ”ç©¶','å­¦è¯†','ä¾¦å¯Ÿ','ç¥ç§˜å­¦','ç‰©ç†','æœ‰å¤‡æ— æ‚£','ä¿¡å·æƒ…æŠ¥','ç”Ÿå­˜','æˆ˜æœ¯','ç¥å­¦','é€šè¯†','ä¾¦æŸ¥','è†å¬','å¿ƒç†å­¦','è¿½è¸ª','åšç‰©å­¦','å…‹è‹é²ç¥è¯','åœ°è´¨å­¦','æ°”è±¡å­¦','å¥¥ç§˜','è‡ªç„¶','å®—æ•™','å¯Ÿè§‰','æ±‚ç”Ÿ','æƒ…æŠ¥æ”¶é›†','ä¼°ä»·','å¯†è¯­','è¯»å”‡','æ‰‹è¯­','å¼“æœ¯','ç‚®æœ¯','å¼•å¯¼','å¬å”¤','ä¿¡ä»°','å¥‡è¿¹','å‡»å‰‘','æªæ¢°','å°„å‡»','é‡æ­¦å™¨','å…ˆæ”»','ç¥å°„','ç‹™å‡»','æ­¦è‰º','è¿‘æˆ˜','å…µå™¨','é¢„å…†','è¿æ°”','æ ¼æŒ¡','çµèƒ½','å·«æœ¯','æ–½æ³•','èŒ¶é“','ç ´å','å‰‘æœ¯','æ–§æœ¯','é­æœ¯','èº²è—','ä¹”è£…','éšåŒ¿','é©¯å…½','åŒ»ç–—','å‚¬çœ ','ä¼ªè£…','æ—¶é«¦å€¼'],Ge=(t=void 0)=>{if('boolean'==typeof t){const e=t,a=t=>Math.floor(Math.random()*t)+1,n=()=>a(6)+a(6)+a(6),o=()=>{if(e){const t=n(),e=a(4)-2;return Math.max(3,Math.min(18,t+e))}{const t=5*n(),e=a(10)-5;return Math.max(5,Math.min(95,t+e))}},i={};return We.forEach(t=>{i[t]=o()}),i}const e=t||$t.getActivePreset();if(!e){const t=t=>Math.floor(Math.random()*t)+1,e=()=>t(6)+t(6)+t(6),a={};return We.forEach(n=>{const o=5*e(),i=t(10)-5;a[n]=Math.max(5,Math.min(95,o+i))}),{base:a,special:{}}}const a={};e.baseAttributes.forEach(t=>{const e=t.modifier?`${t.formula}+${t.modifier}`:t.formula;a[t.name]=Pt(e,t.range,{})});const n={};return e.specialAttributes&&Array.isArray(e.specialAttributes)&&e.specialAttributes.forEach(t=>{n[t.name]=Pt(t.formula,t.range,a)}),{base:a,special:n}},Qe=async t=>{const e=ie||wa();if(!e)return console.error('[DICE]ACU clearPresetAttributesForCharacter: æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),window.toastr&&window.toastr.error('æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),{success:!1};const a=!t||'<user>'===t||''===t.trim();let n=null,o=-1,i=-1,r=null;for(const c in e){const s=e[c];if(!s||!s.name||!s.content)continue;const l=s.name,u=s.content[0]||[];if(a&&(l.includes('ä¸»è§’')||l.includes('ç©å®¶')||l.toLowerCase().includes('player'))&&s.content[1]){n=s,o=1,r=c;for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('åŸºç¡€å±æ€§')){i=t;break}if(i<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('å±æ€§')){i=t;break}break}if(!a&&(l.includes('äººç‰©')||l.includes('NPC')||l.includes('è§’è‰²')||l.toLowerCase().includes('character'))){let e=1;for(let t=0;t<u.length;t++)if(u[t]&&(u[t].includes('å§“å')||u[t].includes('åç§°')||u[t].toLowerCase().includes('name'))){e=t;break}for(let a=1;a<s.content.length;a++){const l=s.content[a];if(l&&l[e]===t){n=s,o=a,r=c;for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('åŸºç¡€å±æ€§')){i=t;break}if(i<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('å±æ€§')){i=t;break}break}}if(o>0)break}}if(!n||o<0)return console.error('[DICE]ACU clearPresetAttributesForCharacter: æ‰¾ä¸åˆ°è§’è‰²',t),window.toastr&&window.toastr.error(`æ‰¾ä¸åˆ°è§’è‰²ã€Œ${t||'<user>'}ã€`),{success:!1};if(i<0)return console.error('[DICE]ACU clearPresetAttributesForCharacter: æ‰¾ä¸åˆ°å±æ€§åˆ—'),window.toastr&&window.toastr.error('æ‰¾ä¸åˆ°å±æ€§åˆ—'),{success:!1};const c=n.content[o][i]||'',s=Jt(c),l=Xe(),u=$t.getActivePreset(),d=new Set(l);u&&u.specialAttributes&&u.specialAttributes.forEach(t=>d.add(t.name));const p=s.filter(t=>!d.has(t.name)).map(t=>`${t.name}:${t.value}`).join(';');return n.content[o][i]=p,ie=e,await $a(e),{success:!0,attrString:p}},Ze=async(t,e,a=!1)=>{const n=ie||wa();if(!n)return console.error('[DICE]ACU writeAttributesToCharacter: æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),window.toastr&&window.toastr.error('æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),{success:!1};const o=!t||'<user>'===t||''===t.trim();let i=null,r=-1,c=-1,s=null;for(const e in n){const a=n[e];if(!a||!a.name||!a.content)continue;const l=a.name,u=a.content[0]||[];if(o&&(l.includes('ä¸»è§’')||l.includes('ç©å®¶')||l.toLowerCase().includes('player'))&&a.content[1]){i=a,r=1,s=e;for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('åŸºç¡€å±æ€§')){c=t;break}if(c<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('å±æ€§')){c=t;break}break}if(!o&&(l.includes('äººç‰©')||l.includes('NPC')||l.includes('è§’è‰²')||l.toLowerCase().includes('character'))){let n=1;for(let t=0;t<u.length;t++)if(u[t]&&(u[t].includes('å§“å')||u[t].includes('åç§°')||u[t].toLowerCase().includes('name'))){n=t;break}for(let o=1;o<a.content.length;o++){const l=a.content[o];if(l&&l[n]===t){i=a,r=o,s=e;for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('åŸºç¡€å±æ€§')){c=t;break}if(c<0)for(let t=0;t<u.length;t++)if(u[t]&&u[t].includes('å±æ€§')){c=t;break}break}}if(r>0)break}}if(!i||r<0)return console.error('[DICE]ACU writeAttributesToCharacter: æ‰¾ä¸åˆ°è§’è‰²',t),window.toastr&&window.toastr.error(`æ‰¾ä¸åˆ°è§’è‰²ã€Œ${t||'<user>'}ã€`),{success:!1};if(c<0)return console.error('[DICE]ACU writeAttributesToCharacter: æ‰¾ä¸åˆ°å±æ€§åˆ—'),window.toastr&&window.toastr.error('æ‰¾ä¸åˆ°å±æ€§åˆ—ï¼ˆéœ€è¦åŒ…å«"å±æ€§"å…³é”®è¯çš„åˆ—ï¼‰'),{success:!1};const l=i.content[r][c]||'',u=Jt(l),d={};u.forEach(t=>{d[t.name]=t.value});const p=Xe(),g=$t.getActivePreset(),f=new Set(p);g&&g.specialAttributes&&g.specialAttributes.forEach(t=>f.add(t.name));let b=0;p.forEach(t=>{void 0!==d[t]&&b++});const m=b===p.length,v=[];u.forEach(t=>{f.has(t.name)||v.push({name:t.name,value:t.value})});const h=[];p.forEach(t=>{if(m){const a=void 0!==e[t]?e[t]:d[t];void 0!==a&&h.push(`${t}:${a}`)}else void 0!==d[t]?h.push(`${t}:${d[t]}`):void 0!==e[t]&&h.push(`${t}:${e[t]}`)}),Object.keys(e).forEach(t=>{p.includes(t)||(m||!d[t]?h.push(`${t}:${e[t]}`):h.push(`${t}:${d[t]}`))}),v.forEach(t=>{h.push(`${t.name}:${t.value}`)});const x=h.join(';');i.content[r][c]=x,ie=n,await $a(n);const y=[];return p.forEach(t=>{y.push({name:t,value:e[t]})}),{success:!0,attrs:y,attrString:x,wasComplete:m}},ta=t=>{const e=ie||wa();if(!e)return[];const a=!t||'<user>'===t||''===t.trim();let n=[];for(const o in e){const i=e[o];if(!i||!i.name||!i.content)continue;const r=i.name;if(a&&(r.includes('ä¸»è§’')||r.includes('ç©å®¶')||r.toLowerCase().includes('player'))&&i.content[1]){const t=i.content[0]||[],e=i.content[1];if(t.forEach((t,a)=>{if(t&&t.includes('å±æ€§')){Jt(e[a]||'').forEach(t=>{n.some(e=>e.name===t.name)||n.push(t)})}}),n.length>0)break}if(!a&&(r.includes('äººç‰©')||r.includes('NPC')||r.includes('è§’è‰²')||r.toLowerCase().includes('character'))){const e=i.content[0]||[];let a=1;for(let t=0;t<e.length;t++)if(e[t]&&(e[t].includes('å§“å')||e[t].includes('åç§°')||e[t].toLowerCase().includes('name'))){a=t;break}for(let o=1;o<i.content.length;o++){const r=i.content[o];if(r&&r[a]===t){e.forEach((t,e)=>{if(t&&t.includes('å±æ€§')){Jt(r[e]||'').forEach(t=>{n.some(e=>e.name===t.name)||n.push(t)})}});break}}if(n.length>0)break}}return n},ea=(t,e)=>{const{$}=$e(),a=t.attr('id')||'dd_'+Math.random().toString(36).substr(2,9);t.attr('id',a),t.parent().find('.acu-dropdown-list').remove(),t.parent().hasClass('acu-dropdown-wrapper')||t.wrap('<div class="acu-dropdown-wrapper"></div>');const n=$(`<div class="acu-dropdown-list" data-for="${a}"></div>`);t.after(n);const o=(t='')=>{const a=t.toLowerCase(),o=e.filter(t=>t.toLowerCase().includes(a));0===o.length?n.html('<div class="acu-dropdown-empty">æ— åŒ¹é…é¡¹</div>'):n.html(o.map(t=>`<div class="acu-dropdown-item" data-value="${r(t)}">${r(t)}</div>`).join(''))},i=()=>{n.removeClass('visible')};t.off('.acudd').on('focus.acudd click.acudd',function(e){e.stopPropagation(),$('.acu-dropdown-list').removeClass('visible'),o(t.val()),n.addClass('visible')}),t.on('input.acudd',function(){o($(this).val())}),n.on('click','.acu-dropdown-item',function(e){e.stopPropagation(),e.preventDefault();const a=$(this).data('value');t.val(a).trigger('change'),i()}),n.on('click',function(t){t.stopPropagation()}),t.closest('.acu-dice-panel, .acu-contest-panel').off('click.acudd_'+a).on('click.acudd_'+a,function(t){$(t.target).closest('.acu-dropdown-wrapper').length||i()})},aa=(t,e)=>{const{$}=$e();t.find(e).each(function(){const t=$(this);if(t.parent().hasClass('acu-input-wrapper'))return;t.wrap('<div class="acu-input-wrapper"></div>');const e=$('<button type="button" class="acu-clear-btn" title="æ¸…é™¤"><i class="fa-solid fa-times"></i></button>');t.after(e),e.on('click',function(e){e.preventDefault(),e.stopPropagation(),t.val('').trigger('input').trigger('change').focus()})})},na=(t=!1)=>{const{$}=$e();$('.acu-dice-config-overlay').remove();const e=ma(),a=xt(),n=t?'DND è§„åˆ™è®¾ç½®':'COC è§„åˆ™è®¾ç½®',o=t?'æ¢å¤ DND é»˜è®¤':'æ¢å¤ COC é»˜è®¤',i=t?{critSuccess:20,critFail:1}:{critSuccess:5,critFail:96,hardDiv:2,extremeDiv:5},r=t?void 0!==a.dndCritSuccess&&a.dndCritSuccess!==i.critSuccess?a.dndCritSuccess:'':void 0!==a.critSuccessMax&&a.critSuccessMax!==i.critSuccess?a.critSuccessMax:'',s=t?void 0!==a.dndCritFail&&a.dndCritFail!==i.critFail?a.dndCritFail:'':void 0!==a.critFailMin&&a.critFailMin!==i.critFail?a.critFailMin:'',l=t||void 0===a.difficultSuccessDiv||a.difficultSuccessDiv===i.hardDiv?'':a.difficultSuccessDiv,u=t||void 0===a.hardSuccessDiv||a.hardSuccessDiv===i.extremeDiv?'':a.hardSuccessDiv,d=a.contestTieRule||'initiator_lose',p=void 0!==a.hideDiceResultFromUser&&a.hideDiceResultFromUser,g=void 0!==a.hideDiceResultInChat&&a.hideDiceResultInChat,f=t?'':`\n            <div class="acu-dice-cfg-row">\n                <div class="acu-dice-cfg-item">\n                    <label>å›°éš¾ (Ã·)</label>\n                    <div class="acu-stepper" data-id="cfg-hard-div" data-min="2" data-max="5" data-step="1">\n                        <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                        <span class="acu-stepper-value">${l||i.hardDiv}</span>\n                        <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                    </div>\n                </div>\n                <div class="acu-dice-cfg-item">\n                    <label>æéš¾ (Ã·)</label>\n                    <div class="acu-stepper" data-id="cfg-extreme-div" data-min="3" data-max="10" data-step="1">\n                        <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                        <span class="acu-stepper-value">${u||i.extremeDiv}</span>\n                        <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                    </div>\n                </div>\n            </div>\n        `,b=`\n            <div class="acu-dice-config-overlay">\n                <div class="acu-dice-config-dialog acu-theme-${e.theme}">\n                    <div class="acu-dice-cfg-header">\n                        <span><i class="fa-solid fa-cog"></i> ${n}</span>\n                        <button class="acu-config-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-dice-cfg-body">\n                        <div class="acu-dice-cfg-row">\n                            <div class="acu-dice-cfg-item">\n                                <label>å¤§æˆåŠŸé˜ˆå€¼</label>\n                                <div class="acu-stepper" data-id="cfg-crit-success" data-min="1" data-max="100" data-step="1">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${r||i.critSuccess}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                            <div class="acu-dice-cfg-item">\n                                <label>å¤§å¤±è´¥é˜ˆå€¼</label>\n                                <div class="acu-stepper" data-id="cfg-crit-fail" data-min="1" data-max="100" data-step="1">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${s||i.critFail}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                        </div>\n                        ${f}\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item">\n                                <label>å¯¹æŠ—å¹³æ‰‹è§„åˆ™</label>\n                                <select id="cfg-tie-rule">\n                                    <option value="initiator_lose" ${'initiator_lose'===d?'selected':''}>ç”²æ–¹åˆ¤è´Ÿ (é»˜è®¤)</option>\n                                    <option value="tie" ${'tie'===d?'selected':''}>åŒæ–¹å¹³æ‰‹</option>\n                                    <option value="initiator_win" ${'initiator_win'===d?'selected':''}>ç”²æ–¹åˆ¤èƒœ</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item acu-cfg-toggle-item">\n                                <label>éšè—è¾“å…¥æ ä¸­çš„æ£€å®šç»“æœ</label>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-hide-dice-result" ${p?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item acu-cfg-toggle-item">\n                                <label>éšè—èŠå¤©è®°å½•ä¸­çš„æ£€å®šç»“æœ</label>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-hide-dice-result-chat" ${g?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-actions">\n                            <button id="cfg-reset-dice">${o}</button>\n                            <button id="cfg-save-dice">ä¿å­˜</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,m=$(b);$('body').append(m),m.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',background:'rgba(0,0,0,0.6)','z-index':'31300',display:'flex','align-items':'center','justify-content':'center',padding:'20px','box-sizing':'border-box'});const v=()=>m.remove();m.find('.acu-config-close').click(v),c(m,'acu-dice-config-overlay',v),m.find('.acu-stepper').each(function(){const t=$(this),e=(t.data('id'),parseInt(t.data('min'))),a=parseInt(t.data('max')),n=parseInt(t.data('step')),o=t.find('.acu-stepper-value'),i=t=>{t=Math.max(e,Math.min(a,t)),o.text(t)},r=()=>{const t=o.text().replace(/[^\d]/g,'');return parseInt(t)||e};t.find('.acu-stepper-dec').on('click',function(){i(r()-n)}),t.find('.acu-stepper-inc').on('click',function(){i(r()+n)})}),m.find('#cfg-save-dice').click(function(){const e={contestTieRule:$('#cfg-tie-rule').val()},a=t=>{const e=m.find(`.acu-stepper[data-id="${t}"]`);if(e.length){const t=e.find('.acu-stepper-value').text().replace(/[^\d]/g,'');return''!==t?parseInt(t,10):null}return null},n=a('cfg-crit-success'),o=a('cfg-crit-fail');if(t)e.dndCritSuccess=null!==n?n:i.critSuccess,e.dndCritFail=null!==o?o:i.critFail;else{e.critSuccessMax=null!==n?n:i.critSuccess,e.critFailMin=null!==o?o:i.critFail;const t=a('cfg-hard-div'),r=a('cfg-extreme-div');e.difficultSuccessDiv=null!==t?t:i.hardDiv,e.hardSuccessDiv=null!==r?r:i.extremeDiv}e.hideDiceResultFromUser=$('#cfg-hide-dice-result').is(':checked'),e.hideDiceResultInChat=$('#cfg-hide-dice-result-chat').is(':checked'),yt(e),console.info('[DICE]åº”ç”¨æŠ•éª°ç»“æœéšè—/æ˜¾ç¤ºè®¾ç½®...'),wt(),v()}),m.find('#cfg-reset-dice').click(function(){const e=(t,e)=>{const a=m.find(`.acu-stepper[data-id="${t}"]`);a.length&&a.find('.acu-stepper-value').text(e)};e('cfg-crit-success',i.critSuccess),e('cfg-crit-fail',i.critFail),t||(e('cfg-hard-div',i.hardDiv),e('cfg-extreme-div',i.extremeDiv))})},oa=(t={})=>{const{$}=$e();$('.acu-dice-panel, .acu-dice-overlay').remove();const e=ma();let a=xt().lastDiceType||'1d100';/^\d+d\d+$/i.test(a)||(a='1d100');const n=ie||wa();let o=['<user>'],i=[];if(n)for(const t in n){const e=n[t];if(e&&e.name&&e.content){if('é‡è¦äººç‰©è¡¨'===e.name)for(let t=1;t<e.content.length;t++){const a=e.content[t];a&&a[1]&&o.push(a[1])}if('ä¸»è§’ä¿¡æ¯'===e.name&&e.content[1]){const t=e.content[1];(e.content[0]||[]).forEach((e,a)=>{if(e&&e.includes('å±æ€§')){Jt(t[a]||'').forEach(t=>{i.includes(t.name)||i.push(t.name)})}})}}}const{targetValue:c=null,targetName:s='ç›®æ ‡',attrValue:u=null,diceType:d=a,successCriteria:p='lte',onResult:g=null,initiatorName:f='',fromMvu:b=!1,mvuPath:m=null,mvuParsedInfo:v=null}=t;let h=u,x=c;null!==u&&null===c&&(x='1d20'===d||'gte'===p?Math.max(0,20-u):u);const y=$('<div class="acu-dice-overlay"></div>');let w=p;'1d100'===d?w='lte':'1d20'===d&&(w='gte');const k=$(`\n            <div class="acu-dice-panel acu-theme-${e.theme}">\n                <div class="acu-dice-panel-header">\n                    <div class="acu-dice-panel-title">\n                        <i class="fa-solid fa-dice-d20"></i> æ™®é€šæ£€å®š\n                    </div>\n                    <div class="acu-dice-panel-actions">\n                        <button id="dice-switch-contest-top" title="åˆ‡æ¢åˆ°å¯¹æŠ—æ£€å®š"><i class="fa-solid fa-people-arrows"></i></button>\n                        <button class="acu-dice-config-btn" title="æ·éª°è§„åˆ™è®¾ç½®">\n                            <i class="fa-solid fa-cog"></i>\n                        </button>\n                        <button class="acu-dice-close">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    </div>\n                </div>\n                <div class="acu-dice-panel-body">\n                    <div class="acu-dice-presets">\n                        <button class="acu-dice-preset ${'1d20'===d?'active':''}" data-dice="1d20" data-criteria="gte">1d20</button>\n                        <button class="acu-dice-preset ${'1d100'===d?'active':''}" data-dice="1d100" data-criteria="lte">1d100</button>\n                        <button class="acu-dice-preset acu-dice-custom-btn ${['1d20','1d100'].includes(d)?'':'active'}" data-dice="custom">è‡ªå®šä¹‰</button>\n                        <input type="text" id="dice-custom-input" class="acu-dice-input" placeholder="å¦‚2d6" value="${['1d20','1d100'].includes(d)?'':d}">\n                    </div>\n\n                    \x3c!-- å¿«æ·é€‰æ‹©è§’è‰² --\x3e\n                    <div class="acu-dice-quick-section">\n                        <div class="acu-dice-section-title"><span><i class="fa-solid fa-user"></i> å¿«æ·é€‰æ‹©</span><div id="dice-char-buttons" class="acu-dice-quick-inline"></div></div>\n                    </div>\n\n                    \x3c!-- ç¬¬1è¡Œï¼šåå­— + å±æ€§å --\x3e\n                    <div class="acu-dice-form-row cols-2">\n                        <div>\n                            <div class="acu-dice-form-label">åå­—</div>\n                            <input type="text" id="dice-initiator-name" class="acu-dice-input" value="${r(f)}" placeholder="<user>">\n                        </div>\n                        <div>\n                            <div class="acu-dice-form-label">\n                                å±æ€§å\n                                <button type="button" class="acu-random-skill-btn" id="dice-random-skill" title="éšæœºæŠ€èƒ½">\n                                    <i class="fa-solid fa-dice"></i>\n                                </button>\n                            </div>\n                            <input type="text" id="dice-attr-name" class="acu-dice-input" value="${r(s||'')}" placeholder="è‡ªç”±æ£€å®š">\n                        </div>\n                    </div>\n\n                    \x3c!-- ç¬¬2è¡Œï¼šå±æ€§å€¼ + ç›®æ ‡å€¼ --\x3e\n                    <div class="acu-dice-form-row cols-2">\n                        <div>\n                            <div class="acu-dice-form-label">å±æ€§å€¼</div>\n                            <input type="text" id="dice-attr-value" class="acu-dice-input" value="${null!==h?h:''}" placeholder="ç•™ç©º=50%æœ€å¤§å€¼">\n                        </div>\n                        <div>\n                            <div class="acu-dice-form-label" id="dice-target-label">ç›®æ ‡å€¼</div>\n                            <input type="text" id="dice-target" class="acu-dice-input" value="${null!==x?x:''}" placeholder="ç•™ç©º=å±æ€§å€¼">\n                        </div>\n                    </div>\n\n                    \x3c!-- å¿«æ·é€‰æ‹©å±æ€§ï¼ˆç´§å‡‘å‹ï¼‰ --\x3e\n                    <div id="dice-attr-buttons" class="acu-dice-quick-compact"></div>\n\n                    \x3c!-- ç¬¬3è¡Œï¼šæˆåŠŸæ ‡å‡† + éš¾åº¦ç­‰çº§ + ä¿®æ­£å€¼ --\x3e\n                    <div class="acu-dice-form-row cols-3" id="dice-row-3">\n                        <div>\n                            <div class="acu-dice-form-label centered">æˆåŠŸæ ‡å‡†</div>\n                            <select id="dice-success-criteria" class="acu-dice-select">\n                                ${[{id:'lte',name:'â‰¤ (COC)'},{id:'gte',name:'â‰¥ (DND)'}].map(t=>`<option value="${t.id}" ${t.id===w?'selected':''}>${t.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div id="dice-difficulty-wrapper">\n                            <div class="acu-dice-form-label centered">éš¾åº¦ç­‰çº§</div>\n                            <select id="dice-difficulty" class="acu-dice-select">\n                                <option value="normal" selected>æ™®é€š</option>\n                                <option value="hard">å›°éš¾</option>\n                                <option value="extreme">æéš¾</option>\n                                <option value="critical">å¤§æˆåŠŸ</option>\n                            </select>\n                        </div>\n                        <div>\n                            <div class="acu-dice-form-label">ä¿®æ­£å€¼</div>\n                            <input type="text" id="dice-modifier" class="acu-dice-input" value="0">\n                        </div>\n                    </div>\n\n                    \x3c!-- éšè—çš„éª°å­å…¬å¼ --\x3e\n                    <input type="hidden" id="dice-formula" value="${d}">\n\n                    <button id="dice-roll-btn" class="acu-dice-roll-btn">\n                        <i class="fa-solid fa-dice"></i> æ·éª°ï¼\n                    </button>\n                </div>\n            </div>\n        `);y.append(k),$('body').append(y);const C=t=>{const e=k.find('#dice-attr-buttons'),a=e.parent(),n=ta(t);a.show();let o='';if(b&&v&&v.attrName){const e=v.attrName,a=Je(t,e)||c||'';o+=a?`<button class="acu-dice-attr-btn acu-dice-attr-btn-mvu" data-name="${r(e)}" data-value="${a}" title="ä»å˜é‡è·¯å¾„æå–: ${r(e)}">${r(e)}:${a}</button>`:`<button class="acu-dice-attr-btn acu-dice-attr-btn-mvu" data-name="${r(e)}" data-value="" title="ä»å˜é‡è·¯å¾„æå–: ${r(e)}">${r(e)}</button>`}n.forEach(t=>{o+=`<button class="acu-dice-attr-btn" data-name="${r(t.name)}" data-value="${t.value}">${r(t.name)}:${t.value}</button>`}),o+='<button class="acu-dice-gen-attr-btn" title="ä¸ºå½“å‰è§’è‰²ç”Ÿæˆå±æ€§"><i class="fa-solid fa-dice"></i></button>',o+='<button class="acu-dice-clear-attr-btn" title="æ¸…ç©ºå½“å‰è§„åˆ™çš„å±æ€§ï¼ˆä¿ç•™è‡ªå®šä¹‰å±æ€§ï¼‰"><i class="fa-solid fa-trash-alt"></i></button>',e.html(o),e.find('.acu-dice-attr-btn').click(function(){const t=$(this).data('name'),e=$(this).data('value');k.find('#dice-attr-name').val(t),k.find('#dice-attr-value').val(e);const a='gte'===(k.find('#dice-success-criteria').val()||'lte'),n=parseInt(e,10)||0;a?k.find('#dice-target').val(20-n):k.find('#dice-target').val(e),k.find('#dice-attr-value').trigger('change')}),e.find('.acu-dice-gen-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const e=$(this);if(e.prop('disabled'))return;e.prop('disabled',!0).css('opacity','0.5');const a=e.html();e.html('<i class="fa-solid fa-spinner fa-spin"></i>');const n=me.handleUpdate;me.handleUpdate=()=>{console.log('[DICE]ACU å±æ€§ç”Ÿæˆä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{const t=k.find('#dice-initiator-name').val().trim()||'<user>';console.log('[DICE]ACU ç”Ÿæˆå±æ€§ for:',t);const e=Ge(),a=e.base||e,n=e.special||{},o={...a,...n};(await Ze(t,o)).success&&C(t)}catch(t){console.error('[DICE]ACU ç”Ÿæˆå±æ€§å¤±è´¥:',t),window.toastr&&window.toastr.error('ç”Ÿæˆå±æ€§å¤±è´¥')}finally{me.handleUpdate=n,e.prop('disabled',!1).css('opacity','1').html(a)}}),e.find('.acu-dice-clear-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const e=$(this);if(e.prop('disabled'))return;const a=k.find('#dice-initiator-name').val().trim()||'<user>';if(!confirm(`ç¡®å®šè¦æ¸…ç©ºã€Œ${a}ã€çš„è§„åˆ™é¢„è®¾å±æ€§å—ï¼Ÿ\n\nï¼ˆç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ä¼šä¿ç•™ï¼‰`))return;e.prop('disabled',!0).css('opacity','0.5');const n=e.html();e.html('<i class="fa-solid fa-spinner fa-spin"></i>');const o=me.handleUpdate;me.handleUpdate=()=>{console.log('[DICE]ACU æ¸…ç©ºå±æ€§ä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{console.log('[DICE]ACU æ¸…ç©ºå±æ€§ for:',a);(await Qe(a)).success&&C(a)}catch(t){console.error('[DICE]ACU æ¸…ç©ºå±æ€§å¤±è´¥:',t),window.toastr&&window.toastr.error('æ¸…ç©ºå±æ€§å¤±è´¥')}finally{me.handleUpdate=o,e.prop('disabled',!1).css('opacity','1').html(n)}})};(()=>{const t=k.find('#dice-char-buttons');let e='';if(b&&v&&v.initiator){const t=v.initiator,a=t.length>4?t.substring(0,4)+'..':t;e+=`<button class="acu-dice-char-btn acu-dice-char-btn-mvu" data-char="${r(t)}" title="ä»å˜é‡è·¯å¾„æå–: ${r(t)}">${r(a)}</button>`}o.forEach(t=>{const a='<user>'===t?pt():gt(t),n=a.length>4?a.substring(0,4)+'..':a;e+=`<button class="acu-dice-char-btn" data-char="${r(t)}" title="${r(a)}">${r(n)}</button>`}),b&&v&&v.candidates&&v.candidates.length>0&&v.candidates.forEach(t=>{if(v.initiator&&t===v.initiator)return;const a=t.length>4?t.substring(0,4)+'..':t;e+=`<button class="acu-dice-char-btn acu-dice-char-btn-mvu-candidate" data-char="${r(t)}" title="ä»å˜é‡è·¯å¾„æå–: ${r(t)}">${r(a)}</button>`}),t.html(e||'<div class="acu-dice-empty-hint">æ— è§’è‰²æ•°æ®</div>'),t.find('.acu-dice-char-btn').click(function(){const t=$(this).data('char');k.find('#dice-initiator-name').val(t).trigger('change')})})(),C('<user>'),k.find('#dice-random-skill').click(function(t){t.preventDefault(),t.stopPropagation();const e=He(),a=e[Math.floor(Math.random()*e.length)];k.find('#dice-attr-name').val(a).trigger('change')}),ea(k.find('#dice-initiator-name'),o),ea(k.find('#dice-attr-name'),i),aa(k,'#dice-initiator-name, #dice-attr-name, #dice-attr-value, #dice-target'),k.find('#dice-initiator-name').on('change.acuattr input.acuattr',function(){const t=$(this).val().trim()||'<user>',e=Ye(t);ea(k.find('#dice-attr-name'),e.length>0?e:i),C(t)}),k.find('#dice-attr-name').on('change.acuval',function(){const t=k.find('#dice-initiator-name').val().trim()||'<user>',e=$(this).val().trim(),a=Je(t,e);if(null!==a){k.find('#dice-attr-value').val(a);const t='gte'===(k.find('#dice-success-criteria').val()||'lte');k.find('#dice-target').val(t?20-a:a)}});const E=(t,e,a)=>{if(!t||''===t)return'';const n=parseInt(t,10);if(isNaN(n))return t;const o=t=>{const e=t.match(/(\d+)d(\d+)/i);return e?parseInt(e[1],10)*parseInt(e[2],10):100},i=o(e),r=o(a),c=n/i,s=Math.round(c*r);return Math.max(1,Math.min(s,r))},A=()=>{const t='gte'===k.find('#dice-success-criteria').val(),e=k.find('#dice-target'),a=k.find('#dice-difficulty-wrapper'),n=k.find('#dice-row-3');t?(e.attr('placeholder','ç•™ç©º=20-å±æ€§å€¼'),k.find('#dice-target-label').text('DC'),a.hide(),n.css('grid-template-columns','1fr 1fr')):(e.attr('placeholder','ç•™ç©º=å±æ€§å€¼'),k.find('#dice-target-label').text('ç›®æ ‡å€¼'),a.show(),n.css('grid-template-columns','1fr 1fr 1fr'))};k.find('#dice-success-criteria').on('change',A),A();let D=d;k.find('.acu-dice-preset').click(function(){const t=$(this).data('dice');if('custom'===t)return;k.find('.acu-dice-preset').removeClass('active'),$(this).addClass('active'),yt({lastDiceType:t});const e=$(this).data('criteria')||'lte',a=k.find('#dice-target'),n=a.val().trim();if(''!==n){const e=E(n,D,t);a.val(e)}const o=(t=>{const e=t.match(/(\d+)d(\d+)/i);return e?parseInt(e[1],10)*parseInt(e[2],10):100})(t);k.find('#dice-target-auto').text(`(è‡ªåŠ¨: 1~${o})`),D=t,k.find('#dice-formula').val(t),k.find('#dice-success-criteria').val(e).trigger('change')}),k.find('.acu-dice-custom-btn').click(function(){k.find('.acu-dice-preset').removeClass('active'),$(this).addClass('active');const t=k.find('#dice-custom-input').val().trim();if(!t)return void k.find('#dice-custom-input').focus();if(!/^\d+d\d+$/i.test(t))return void(window.toastr&&window.toastr.warning('æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥å¦‚ 4d6'));const e=k.find('#dice-target'),a=e.val().trim();if(''!==a){const n=E(a,D,t);e.val(n)}k.find('#dice-formula').val(t),D=t,yt({lastDiceType:t}),k.find('#dice-success-criteria').val('gte').trigger('change')}),k.find('#dice-custom-input').on('keydown',function(t){'Enter'===t.key&&(t.preventDefault(),k.find('.acu-dice-custom-btn').click())});let I=0;const F=function(){const t=k.find('#dice-roll-btn'),e=Date.now();if(e-I<100)return;if(I=e,t.prop('disabled'))return;t.prop('disabled',!0).addClass('disabled'),setTimeout(()=>{t.prop('disabled',!1).removeClass('disabled')},100);const a=k.find('#dice-formula').val().trim()||'1d100',n=function(t){if(!t||''===t.trim())return 0;const e=t.trim(),a=parseFloat(e);if(!isNaN(a)&&isFinite(a)&&e.match(/^-?\d+(\.\d+)?$/))return a;let n=0,o=e;const i=/(\d+)d(\d+)(kh\d+|kl\d+|dh\d+|dl\d+)?/gi;let r;for(;null!==(r=i.exec(o));){const t=jt(r[0]);isNaN(t)||(n+=t),o=o.replace(r[0],'')}const c=/([+-]?\d+(\.\d+)?)/g;let s;for(;null!==(s=c.exec(o));){const t=parseFloat(s[0]);!isNaN(t)&&isFinite(t)&&(n+=t)}return n}(k.find('#dice-modifier').val().trim()||'0'),o=k.find('#dice-attr-name').val().trim()||'è‡ªç”±æ£€å®š',i=k.find('#dice-success-criteria').val()||'lte',r=k.find('#dice-difficulty').val()||'normal',c='gte'===i,s=xt(),u=s.difficultSuccessDiv||2,d=s.hardSuccessDiv||5,p=c?s.dndCritFail||1:s.critSuccessMax||5,f=c?s.dndCritSuccess||20:s.critFailMin||96;let b,m=k.find('#dice-target').val().trim(),v=k.find('#dice-attr-value').val().trim(),h=''!==v?parseInt(v,10):0,x=!1;const y=t=>{const e=t.match(/(\d+)d(\d+)/i);if(e){const t=parseInt(e[1],10)*parseInt(e[2],10);return Math.round(t/2)}return 50};''!==m?b=parseInt(m,10)||y(a):c?h>0?(b=20-h,x=!0):(b=10,x=!0):h>0?(b=h,x=!0):(b=y(a),x=!0);const w=(t=>{const e=t.match(/(\d+)d(\d+)([+-]\d+)?/i);if(!e)return{total:0,rolls:[],formula:t};const a=parseInt(e[1],10),n=parseInt(e[2],10),o=e[3]?parseInt(e[3],10):0,i=[];for(let t=0;t<a;t++)i.push(Math.floor(Math.random()*n)+1);return{total:i.reduce((t,e)=>t+e,0)+o,rolls:i,sides:n,count:a,modifier:o,formula:t}})(a),C=w.total+n;let E=b,A='',D=1;if(!c)switch(r){case'hard':E=Math.floor(b/u),A='å›°éš¾',D=u;break;case'extreme':E=Math.floor(b/d),A='æéš¾',D=d;break;case'critical':E=p,A='å¤§æˆåŠŸ';break;default:A=''}let S=!1,M=!1,j=!1,T='',P='';if(c?(S=C>=f,M=C<=p):(S=C<=p,M=C>=f),j=c?C>=E:C<=E,S)T='å¤§æˆåŠŸï¼',P='success',j=!0;else if(M)T='å¤§å¤±è´¥ï¼',P='failure',j=!1;else if(j){if(c)T='æˆåŠŸ';else if('hard'===r)T='å›°éš¾æˆåŠŸ';else if('extreme'===r)T='æéš¾æˆåŠŸ';else{const t=Math.floor(b/d),e=Math.floor(b/u);T=C<=t?'æéš¾æˆåŠŸ':C<=e?'å›°éš¾æˆåŠŸ':'æˆåŠŸ'}P='success'}else T='å¤±è´¥',P='failure';const N=c?'â‰¥':'â‰¤',R=void 0!==s.hideDiceResultFromUser&&s.hideDiceResultFromUser,O=R?'ï¼Ÿï¼Ÿ':C,B=R?'':T;let L;L=S?'critSuccess':M?'critFailure':j?'extreme'===r||'normal'===r&&C<=Math.floor(b/d)?'extremeSuccess':'hard'===r||'normal'===r&&C<=Math.floor(b/u)?'success':'warning':'failure';const U=Bt(L),V=k.find('#dice-roll-btn');V.html(`\n        <div class="acu-dice-result-display">\n          <span class="acu-dice-result-value">${O}</span>\n          <span class="acu-dice-result-target">${N}${E}${A?'('+A+')':''}</span>\n          ${B?`<span class="${U}">${B}</span>`:''}\n          <button class="dice-retry-btn acu-dice-retry-btn" title="é‡æ–°æŠ•éª°">\n            <i class="fa-solid fa-rotate-right"></i>\n          </button>\n        </div>\n      `),V.off('click','.dice-retry-btn').on('click','.dice-retry-btn',function(t){t.stopPropagation(),t.preventDefault(),F()});const q=k.find('#dice-initiator-name').val().trim()||'<user>';let Y='';if(S)Y=c?`${C}â‰¥${f}`:`${C}â‰¤${p}`;else if(M)Y=c?`${C}â‰¤${p}`:`${C}â‰¥${f}`;else if(c)Y=j?`éœ€${N}${E}ï¼Œ${C}â‰¥${E}`:`éœ€${N}${E}ï¼Œ${C}<${E}`;else if('critical'===r)Y=`éœ€â‰¤${p}ï¼Œ${C}>${p}`;else if('normal'!==r)Y=j?`éœ€â‰¤${b}/${D}ï¼Œ${C}â‰¤${E}`:`éœ€â‰¤${b}/${D}ï¼Œ${C}>${E}`;else if(j){const t=Math.floor(b/d),e=Math.floor(b/u);Y=C<=t?`éœ€â‰¤${b}ï¼Œ${C}â‰¤${b}/${d}`:C<=e?`éœ€â‰¤${b}ï¼Œ${C}â‰¤${b}/${u}`:`éœ€â‰¤${b}ï¼Œ${C}â‰¤${b}`}else Y=`éœ€â‰¤${b}ï¼Œ${C}>${b}`;l(`ï¼ˆå…ƒå™äº‹ï¼š${q}å‘èµ·äº†ã€${o}ã€‘æ£€å®šï¼Œæ·å‡º${C}ï¼Œ${Y}ï¼Œã€${T}ã€‘ï¼‰`,'dice');const J={success:j,total:C,target:b,outcomeText:T,attrName:o,criteria:i,isAutoTarget:x,formula:a},W={...J,timestamp:Date.now()};Wa.push(W),Wa.length>Ha&&Wa.shift(),Ka('check',W),g&&g(J)};k.find('#dice-roll-btn').click(function(){F()}),k.find('#dice-switch-contest-top').click(function(){k.find('#dice-target').val().trim();const t=k.find('#dice-attr-value').val().trim(),e=k.find('#dice-formula').val()||'1d100',a=k.find('#dice-initiator-name').val().trim();S(),ia({initiatorName:a&&'<user>'!==a?a:'',initiatorValue:''!==t?parseInt(t,10):void 0,diceType:e})});const S=()=>{y.remove(),k.remove()};k.on('click',t=>{t.stopPropagation()}),y.click(S),k.find('.acu-dice-close').click(S),k.find('.acu-dice-config-btn').click(function(t){t.stopPropagation();const e=k.find('#dice-success-criteria').val();na('gte'===e)})},ia=(t={})=>{const{$}=$e();$('.acu-dice-panel, .acu-dice-overlay, .acu-contest-panel, .acu-contest-overlay').remove();const e=ma();let a=xt().lastDiceType||'1d100';/^\d+d\d+$/i.test(a)||(a='1d100');const n=t.opponentName||'',o=t.diceType||a,i=t.initiatorName||'',c=t.initiatorValue,s=t.opponentValue,u=ie||wa();let d=[],p=[],g=['<user>'];if(u)for(const t in u){const e=u[t];if(e&&'é‡è¦äººç‰©è¡¨'===e.name&&e.content){for(let t=1;t<e.content.length;t++){const a=e.content[t];a&&a[1]&&g.push(a[1])}break}}let f=[];if(u)for(const t in u){const e=u[t];if(e&&'ä¸»è§’ä¿¡æ¯'===e.name&&e.content&&e.content[1]){const t=e.content[0]||[],a=e.content[1];t.forEach((t,e)=>{if(t&&t.includes('å±æ€§')){Jt(a[e]||'').forEach(t=>{f.includes(t.name)||f.push(t.name)})}});break}}if(u)for(const t in u){const e=u[t];if(e&&e.name&&e.content){if('ä¸»è§’ä¿¡æ¯'===e.name&&e.content[1]){const t=e.content[1][7]||'';d=Jt(t)}if('é‡è¦äººç‰©è¡¨'===e.name&&n)for(let t=1;t<e.content.length;t++){const a=e.content[t];if(a&&a[1]===n){const t=a[9]||'';p=Jt(t);break}}}}const b=(t,e)=>{let a='';for(let n=0;n<t.length;n++){const o=t[n];a+='<button class="acu-contest-attr-btn" data-val="'+o.value+'" data-aname="'+r(o.name)+'" data-type="'+e+'">'+r(o.name)+': '+o.value+'</button>'}return a+='<button class="acu-contest-gen-attr-btn" data-type="'+e+'" title="ç”Ÿæˆå±æ€§"><i class="fa-solid fa-dice"></i></button>',a+='<button class="acu-contest-clear-attr-btn" data-type="'+e+'" title="æ¸…ç©ºè§„åˆ™å±æ€§"><i class="fa-solid fa-trash-alt"></i></button>',a},m=$('<div class="acu-contest-overlay"></div>'),v='<div class="acu-contest-panel acu-theme-'+e.theme+'"><div class="acu-dice-panel-header"><div class="acu-dice-panel-title"><i class="fa-solid fa-people-arrows"></i> å¯¹æŠ—æ£€å®š</div><div class="acu-dice-panel-actions"><button id="contest-switch-normal" class="acu-dice-panel-action-btn" title="åˆ‡æ¢åˆ°æ™®é€šæ£€å®š"><i class="fa-solid fa-dice-d20"></i></button><button class="acu-contest-config-btn acu-dice-panel-action-btn" title="æ·éª°è§„åˆ™è®¾ç½®"><i class="fa-solid fa-cog"></i></button><button class="acu-contest-close acu-dice-panel-action-btn"><i class="fa-solid fa-times"></i></button></div></div><div class="acu-dice-panel-body"><div class="acu-dice-presets"><button class="acu-dice-preset'+('1d20'===o?' active':'')+'" data-dice="1d20">1d20</button><button class="acu-dice-preset'+('1d100'===o?' active':'')+'" data-dice="1d100">1d100</button><button class="acu-dice-preset acu-contest-custom-btn'+(['1d20','1d100'].includes(o)?'':' active')+'" data-dice="custom">è‡ªå®šä¹‰</button><input type="text" class="acu-dice-custom-input" id="contest-custom-dice" placeholder="å¦‚2d6" value="'+(['1d20','1d100'].includes(o)?'':o)+'" /></div><input type="hidden" id="contest-dice-type" value="'+o+'"><div class="acu-dice-section-title"><span><i class="fa-solid fa-user"></i> ç”²æ–¹</span><div id="contest-init-char-buttons" class="acu-dice-quick-inline"></div></div><div class="acu-dice-form-row cols-2"><div><div class="acu-dice-form-label">åå­—</div><input type="text" class="acu-dice-input" id="contest-init-display" value="" placeholder="<user>"></div><div><div class="acu-dice-form-label">å±æ€§å<button type="button" class="acu-random-skill-btn" id="contest-init-random-skill" title="éšæœºæŠ€èƒ½"><i class="fa-solid fa-dice"></i></button></div><input type="text" class="acu-dice-input" id="contest-init-name" value="" placeholder="è‡ªç”±æ£€å®š"></div></div><div class="acu-dice-form-row cols-2"><div><div class="acu-dice-form-label">å±æ€§å€¼</div><input type="text" class="acu-dice-input" id="contest-init-value" value="'+(void 0!==c?c:'')+'" placeholder="ç•™ç©º=50%æœ€å¤§å€¼"></div><div><div class="acu-dice-form-label">ç›®æ ‡å€¼</div><input type="text" class="acu-dice-input" id="contest-init-target" value="" placeholder="è‡ªåŠ¨"></div></div><div id="init-attr-buttons" class="acu-dice-quick-compact">'+b(d,'init')+'</div><div class="acu-dice-section-title"><span><i class="fa-solid fa-user"></i> ä¹™æ–¹</span><div id="contest-opp-char-buttons" class="acu-dice-quick-inline"></div></div><div class="acu-dice-form-row cols-2"><div><div class="acu-dice-form-label">åå­—</div><input type="text" class="acu-dice-input" id="contest-opponent-display" value="'+r(n)+'" placeholder="å¯¹æ‰‹"></div><div><div class="acu-dice-form-label">å±æ€§å<button type="button" class="acu-random-skill-btn" id="contest-opp-random-skill" title="éšæœºæŠ€èƒ½"><i class="fa-solid fa-dice"></i></button></div><input type="text" class="acu-dice-input" id="contest-opp-name" value="" placeholder="åŒç”²æ–¹"></div></div><div class="acu-dice-form-row cols-2"><div><div class="acu-dice-form-label">å±æ€§å€¼</div><input type="text" class="acu-dice-input" id="contest-opp-value" value="'+(void 0!==s?s:'')+'" placeholder="ç•™ç©º=50%æœ€å¤§å€¼"></div><div><div class="acu-dice-form-label">ç›®æ ‡å€¼</div><input type="text" class="acu-dice-input" id="contest-opp-target" value="" placeholder="è‡ªåŠ¨"></div></div><div id="opp-attr-buttons" class="acu-dice-quick-compact">'+b(p,'opp')+'</div><div id="contest-result-display" class="acu-contest-result-display"><div class="acu-contest-result-inner"><div id="contest-result-init" class="acu-contest-result-side"></div><span class="acu-contest-vs">VS</span><div id="contest-result-opp" class="acu-contest-result-side right"></div></div></div><button id="contest-roll-btn" class="acu-dice-roll-btn"><i class="fa-solid fa-dice"></i> å¼€å§‹å¯¹æŠ—ï¼</button></div></div>',h=$(v);m.append(h),$('body').append(m);const x=t=>{const e='init'===t?'#contest-init-char-buttons':'#contest-opp-char-buttons',a=h.find(e);let n='';g.forEach(e=>{const a='<user>'===e?pt():gt(e),o=a.length>4?a.substring(0,4)+'..':a;n+='<button class="acu-dice-char-btn" data-char="'+r(e)+'" data-type="'+t+'" title="'+r(a)+'">'+r(o)+'</button>'}),a.html(n),a.find('.acu-dice-char-btn').click(function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data('char');'init'===$(this).data('type')?h.find('#contest-init-display').val(e).trigger('change'):h.find('#contest-opponent-display').val(e).trigger('change')})},y=(t,e)=>{const a='init'===e?'#init-attr-buttons':'#opp-attr-buttons',n=h.find(a);n.show();let o='';t.length>0&&t.forEach(t=>{o+='<button class="acu-contest-attr-btn" data-val="'+t.value+'" data-aname="'+r(t.name)+'" data-type="'+e+'">'+r(t.name)+':'+t.value+'</button>'}),o+='<button class="acu-contest-gen-attr-btn" data-type="'+e+'" title="ç”Ÿæˆå±æ€§"><i class="fa-solid fa-dice"></i></button>',o+='<button class="acu-contest-clear-attr-btn" data-type="'+e+'" title="æ¸…ç©ºè§„åˆ™å±æ€§"><i class="fa-solid fa-trash-alt"></i></button>',n.html(o),n.find('.acu-contest-attr-btn').click(function(){const t=$(this).attr('data-val'),e=$(this).attr('data-aname');'init'===$(this).attr('data-type')?(h.find('#contest-init-value').val(t),h.find('#contest-init-name').val(e)):(h.find('#contest-opp-value').val(t),h.find('#contest-opp-name').val(e))}),n.find('.acu-contest-gen-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const e=$(this);if(e.prop('disabled'))return;const a=e.attr('data-type');e.prop('disabled',!0).css('opacity','0.5');const n=e.html();e.html('<i class="fa-solid fa-spinner fa-spin"></i>');const o=me.handleUpdate;me.handleUpdate=()=>{console.log('[DICE]ACU å¯¹æŠ—å±æ€§ç”Ÿæˆä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{let t;if(t='init'===a?h.find('#contest-init-display').val().trim()||'<user>':h.find('#contest-opponent-display').val().trim(),!t)return void(window.toastr&&window.toastr.warning('è¯·å…ˆé€‰æ‹©è§’è‰²'));console.log('[DICE]ACU å¯¹æŠ—é¢æ¿ç”Ÿæˆå±æ€§ for:',t,'type:',a);const e=Ge(),n=e.base||e,o=e.special||{},i={...n,...o};if((await Ze(t,i)).success){const e=ta(t);y(e,a)}}catch(t){console.error('[DICE]ACU å¯¹æŠ—é¢æ¿ç”Ÿæˆå±æ€§å¤±è´¥:',t),window.toastr&&window.toastr.error('ç”Ÿæˆå±æ€§å¤±è´¥')}finally{me.handleUpdate=o,e.prop('disabled',!1).css('opacity','1').html(n)}}),n.find('.acu-contest-clear-attr-btn').click(async function(t){t.preventDefault(),t.stopPropagation();const e=$(this);if(e.prop('disabled'))return;const a=e.attr('data-type');let n;if(n='init'===a?h.find('#contest-init-display').val().trim()||'<user>':h.find('#contest-opponent-display').val().trim(),!n)return void(window.toastr&&window.toastr.warning('è¯·å…ˆé€‰æ‹©è§’è‰²'));if(!confirm(`ç¡®å®šè¦æ¸…ç©ºã€Œ${n}ã€çš„è§„åˆ™é¢„è®¾å±æ€§å—ï¼Ÿ\n\nï¼ˆç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ä¼šä¿ç•™ï¼‰`))return;e.prop('disabled',!0).css('opacity','0.5');const o=e.html();e.html('<i class="fa-solid fa-spinner fa-spin"></i>');const i=me.handleUpdate;me.handleUpdate=()=>{console.log('[DICE]ACU æ¸…ç©ºå±æ€§ä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{console.log('[DICE]ACU å¯¹æŠ—é¢æ¿æ¸…ç©ºå±æ€§ for:',n,'type:',a);if((await Qe(n)).success){const t=ta(n);y(t,a)}}catch(t){console.error('[DICE]ACU å¯¹æŠ—é¢æ¿æ¸…ç©ºå±æ€§å¤±è´¥:',t),window.toastr&&window.toastr.error('æ¸…ç©ºå±æ€§å¤±è´¥')}finally{me.handleUpdate=i,e.prop('disabled',!1).css('opacity','1').html(o)}})};x('init'),x('opp'),h.find('#contest-init-random-skill').click(function(t){t.preventDefault(),t.stopPropagation();const e=He();var a=e[Math.floor(Math.random()*e.length)];h.find('#contest-init-name').val(a).trigger('change')}),h.find('#contest-opp-random-skill').click(function(t){t.preventDefault(),t.stopPropagation();const e=He();var a=e[Math.floor(Math.random()*e.length)];h.find('#contest-opp-name').val(a).trigger('change')});const w=ta(i||'<user>');y(w,'init');const k=ta(n||'');y(k,'opp'),ea(h.find('#contest-init-display'),g),ea(h.find('#contest-opponent-display'),g),ea(h.find('#contest-init-name'),f),ea(h.find('#contest-opp-name'),f),aa(h,'#contest-init-display, #contest-init-name, #contest-init-value, #contest-init-target, #contest-opponent-display, #contest-opp-name, #contest-opp-value, #contest-opp-target'),h.find('#contest-init-display').on('change.acuattr input.acuattr',function(){const t=$(this).val().trim()||'<user>',e=Ye(t);ea(h.find('#contest-init-name'),e.length>0?e:f);const a=ta(t);y(a,'init')}),h.find('#contest-opponent-display').on('change.acuattr input.acuattr',function(){const t=$(this).val().trim(),e=Ye(t);ea(h.find('#contest-opp-name'),e.length>0?e:f);const a=ta(t);y(a,'opp')}),h.find('#contest-init-name').on('change.acuval',function(){const t=h.find('#contest-init-display').val().trim()||'<user>',e=$(this).val().trim(),a=Je(t,e);null!==a&&h.find('#contest-init-value').val(a)}),h.find('#contest-opp-name').on('change.acuval',function(){const t=h.find('#contest-opponent-display').val().trim(),e=$(this).val().trim(),a=Je(t,e);null!==a&&h.find('#contest-opp-value').val(a)}),h.find('.acu-dice-preset').click(function(){const t=$(this).data('dice');'custom'!==t&&(h.find('.acu-dice-preset').removeClass('active'),$(this).addClass('active'),h.find('#contest-dice-type').val(t),yt({lastDiceType:t}))}),h.find('.acu-contest-custom-btn').click(function(){h.find('.acu-dice-preset').removeClass('active'),$(this).addClass('active');var t=h.find('#contest-custom-dice').val().trim();t?/^\d+d\d+$/i.test(t)?(h.find('#contest-dice-type').val(t),yt({lastDiceType:t})):window.toastr&&window.toastr.warning('æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥å¦‚ 4d6'):h.find('#contest-custom-dice').focus()}),h.find('#contest-custom-dice').on('keydown',function(t){'Enter'===t.key&&(t.preventDefault(),h.find('.acu-contest-custom-btn').click())});const C=function(t){const e=t.match(/(\d+)d(\d+)([+-]\d+)?/i);if(!e)return{total:0,rolls:[],sides:100};const a=parseInt(e[1],10),n=parseInt(e[2],10),o=e[3]?parseInt(e[3],10):0,i=[];for(let t=0;t<a;t++)i.push(Math.floor(Math.random()*n)+1);return{total:i.reduce(function(t,e){return t+e},0)+o,rolls:i,sides:n}},E=function(t,e,a){return 100===a?t<=5?{level:3,name:'å¤§æˆåŠŸ',color:'var(--acu-crit-success-text)'}:t>=96?{level:-1,name:'å¤§å¤±è´¥',color:'var(--acu-crit-failure-text)'}:t<=Math.floor(e/5)?{level:2,name:'æéš¾æˆåŠŸ',color:'var(--acu-extreme-success-text)'}:t<=Math.floor(e/2)?{level:1,name:'å›°éš¾æˆåŠŸ',color:'var(--acu-success-text)'}:t<=e?{level:0,name:'æ™®é€šæˆåŠŸ',color:'var(--acu-warning-text)'}:{level:-1,name:'å¤±è´¥',color:'var(--acu-failure-text)'}:20===t?{level:3,name:'å¤§æˆåŠŸ',color:'var(--acu-crit-success-text)'}:1===t?{level:-1,name:'å¤§å¤±è´¥',color:'var(--acu-crit-failure-text)'}:t>=e?{level:0,name:'æˆåŠŸ',color:'var(--acu-success-text)'}:{level:-1,name:'å¤±è´¥',color:'var(--acu-failure-text)'}};let A=0;const D=function(){const t=h.find('#contest-roll-btn'),e=h.find('.acu-contest-result-row'),a=Date.now();if(a-A<100)return;if(A=a,t.prop('disabled')||e.hasClass('disabled'))return;t.prop('disabled',!0).addClass('disabled'),e.addClass('disabled').css('pointer-events','none'),setTimeout(()=>{t.prop('disabled',!1).removeClass('disabled'),e.removeClass('disabled').css('pointer-events','')},100);var n,o=h.find('#contest-dice-type').val()||'1d100',i=h.find('#contest-init-display').val().trim()||'<user>',c=h.find('#contest-init-name').val().trim()||'è‡ªç”±æ£€å®š',s=function(t){var e=t.match(/(\d+)d(\d+)/i);return e?Math.round(parseInt(e[1],10)*parseInt(e[2],10)/2):50},u=h.find('#contest-init-value').val().trim();n=''===u?s(o):parseInt(u,10)||s(o);var d,p=h.find('#contest-init-target').val().trim();d=''!==p?parseInt(p,10):n;var g,f=h.find('#contest-opponent-display').val().trim()||'å¯¹æ‰‹',b=h.find('#contest-opp-name').val().trim()||c,m=h.find('#contest-opp-value').val().trim();g=''===m?s(o):parseInt(m,10)||s(o);var v,x=h.find('#contest-opp-target').val().trim();v=''!==x?parseInt(x,10):g;var y,w,k=C(o),I=C(o),F=E(k.total,d,k.sides),S=E(I.total,v,I.sides),M=xt(),j=M.contestTieRule||'initiator_lose',T=void 0!==M.hideDiceResultFromUser&&M.hideDiceResultFromUser,P=T?'ï¼Ÿï¼Ÿ':k.total,N=T?'ï¼Ÿï¼Ÿ':I.total,R=T?'':F.name,O=T?'':S.name;F.level>S.level?(y=i+' èƒœåˆ©',w='success',F.name,S.name):F.level<S.level?(y=f+' èƒœåˆ©',w='failure',S.name,F.name):('åŒæ–¹å‡ä¸º '+F.name,'initiator_win'===j?(y='å¹³æ‰‹ï¼Œ'+i+' åˆ¤èƒœ',w='success'):'tie'===j?(y='åŒæ–¹å¹³æ‰‹',w='warning'):(y='å¹³æ‰‹ï¼Œ'+i+' åˆ¤è´Ÿ',w='failure'));var B=T?'':y;const L=t=>3===t.level?'critSuccess':2===t.level?'extremeSuccess':1===t.level?'success':0===t.level?'warning':-1===t.level&&'å¤§å¤±è´¥'===t.name?'critFailure':'failure',U=L(F),V=L(S),q=Bt(U),Y=Bt(V),J=(Bt(w),'success'===w?'acu-contest-winner-success':'warning'===w?'acu-contest-winner-warning':'acu-contest-winner-failure'),W=h.find('#contest-result-display'),X=h.find('#contest-result-init'),H=h.find('#contest-result-opp');X.html('<span class="acu-contest-result-name">'+r(i)+'</span><span class="acu-contest-result-value">'+P+'</span>'+(R?'<span class="'+q+'">'+R+'</span>':'')),H.html((O?'<span class="'+Y+'">'+O+'</span>':'')+'<span class="acu-contest-result-value">'+N+'</span><span class="acu-contest-result-name">'+r(f)+'</span>'),W.html('<div class="acu-contest-result-container" title="ç‚¹å‡»é‡æ–°æŠ•éª°"><div class="acu-contest-result-row"><div class="acu-contest-result-inner"><div id="contest-result-init" class="acu-contest-result-side"><span class="acu-contest-result-name">'+r(i)+'</span><span class="acu-contest-result-value">'+P+'</span>'+(R?'<span class="'+q+'">'+R+'</span>':'')+'</div><span class="acu-contest-vs">VS</span><div id="contest-result-opp" class="acu-contest-result-side right">'+(O?'<span class="'+Y+'">'+O+'</span>':'')+'<span class="acu-contest-result-value">'+N+'</span><span class="acu-contest-result-name">'+r(f)+'</span></div></div></div><div class="acu-contest-result-winner-row"><span class="acu-contest-winner-text '+J+'">'+B+'</span><i class="fa-solid fa-rotate-right acu-contest-reroll-icon"></i></div></div>'),W.show(),W.off('click').on('click',function(t){t.stopPropagation(),t.preventDefault(),D()});h.find('#contest-roll-btn').hide();const K=`ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€${i} ${c} vs ${f} ${b}ã€‘çš„å¯¹æŠ—æ£€å®šã€‚${i} ${c} (ç›®æ ‡${d}) æ·å‡º ${k.total}ï¼Œåˆ¤å®šä¸ºã€${F.name}ã€‘ï¼›${f} ${b} (ç›®æ ‡${v}) æ·å‡º ${I.total}ï¼Œåˆ¤å®šä¸ºã€${S.name}ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€${y}ã€‘ï¼‰`;l(K,'dice');const G={...{left:{name:i,attribute:c,roll:k.total,target:d,successLevel:F.level},right:{name:f,attribute:b,roll:I.total,target:v,successLevel:S.level},winner:F.level>S.level?'left':F.level<S.level?'right':'tie',message:y},timestamp:Date.now()};Xa.push(G),Xa.length>Ha&&Xa.shift(),Ka('contest',G)};h.find('#contest-roll-btn').click(function(){D()}),h.find('#contest-switch-normal').click(function(){var t=h.find('#contest-init-value').val().trim(),e=h.find('#contest-init-name').val()||'',a=h.find('#contest-dice-type').val()||'1d100',n=h.find('#contest-init-display').val().trim();I(),oa({targetValue:''!==t?parseInt(t,10):null,targetName:e,diceType:a,initiatorName:n})}),h.find('.acu-contest-config-btn').click(function(t){t.stopPropagation();const e=h.find('#contest-dice-type').val()||'1d100';na('1d20'===e)});var I=function(){m.remove(),h.remove()};h.on('click',function(t){t.stopPropagation()}),m.click(I),h.find('.acu-contest-close').click(I)},ra=(t,e)=>{const a=String(t||'').trim().toLowerCase(),n=String(e||'').toLowerCase();return!!a&&(n.includes('ç¦»åœº')?'å¦'===a||'false'===a||'no'===a:a.startsWith('åœ¨åœº')||'true'===a||'æ˜¯'===a||'yes'===a)},ca=async()=>{const t=ie||wa(),e=Ca(t||{});if(!t||0===Object.keys(e).length)return null;const a=Rt.findTable(e,'global'),n=Rt.findTable(e,'location'),o=Rt.findTable(e,'npc'),i=Rt.findTable(e,'player'),r=(()=>{const t=['åœ°å›¾å…ƒç´ ','å…ƒç´ è¡¨','åœ°å›¾è¦ç´ ','æœºå…³','çº¿ç´¢'];for(const a in e)if(t.some(t=>a.includes(t)))return{data:e[a],name:a,key:e[a].key};return null})(),c=a?.data?.headers||[],s=(a?.data?.rows||[])[0]||[],l=Nt.global,u=Rt.findColumnIndex(c,'detailLocation',l),d=Rt.findColumnIndex(c,'currentLocation',l),p=u>=0?String(s[u]||'').trim():'',g=d>=0?String(s[d]||'').trim():'';if(!n?.data)return null;const f=(t,e,a=null)=>{for(let a=0;a<t.length;a++){const n=String(t[a]||'').toLowerCase();if(e.some(t=>n.includes(t.toLowerCase())))return a}return a??-1},b=new Map,m=n.data.headers||[],v=n.data.rows||[],h=f(m,['è¯¦ç»†åœ°ç‚¹','å…·ä½“ä½ç½®','åœ°ç‚¹å','åœ°ç‚¹','åç§°'],1),x=f(m,['æ¬¡è¦åœ°åŒº','æ¬¡è¦åŒºåŸŸ','åŒºåŸŸ','åœ°åŒº'],null),y=f(m,['åœ°ç‚¹ç±»å‹','åœ°ç‚¹ç±»åˆ«','ç±»å‹'],null),w=f(m,['ç¯å¢ƒæè¿°','æè¿°','è¯´æ˜','ä»‹ç»','æ°›å›´æè¿°'],null),k=f(m,['é‡è¦åº¦','é‡è¦æ€§'],null),C=f(m,['æ¢ç´¢çŠ¶æ€','æ¢ç´¢è¿›åº¦','çŠ¶æ€'],null),E=[];v.forEach(t=>{const e=String(t[h]||'').trim().replace(/[\u200B-\u200D\uFEFF]/g,'');e&&E.push(e)});const A=(t=>{const e=new Map;for(const a of t)e.set(a,bt(a));const a=[...t].sort((t,e)=>t.length!==e.length?t.length-e.length:t.localeCompare(e)),n=new Set,o=new Map;for(const t of a){const a=e.get(t)||[],i=a.find(t=>!n.has(t));i?(o.set(t,i),n.add(i)):o.set(t,a.length>0?a[0]:null)}return o})(E);v.forEach((t,e)=>{const a=String(t[h]||'').trim().replace(/[\u200B-\u200D\uFEFF]/g,'');if(!a)return;const o={name:a,region:x>=0?String(t[x]||'').trim():'',locationType:y>=0&&t[y]||'',description:w>=0&&t[w]||'',importance:k>=0&&t[k]||'',exploreStatus:C>=0&&t[C]||'',emoji:A.get(a)??null,tableKey:n.key||'',rowIndex:e};b.set(a,o)});const D=new Map;if(r?.data){const t=r.data.headers||[],e=r.data.rows||[],a=f(t,['å…ƒç´ åç§°','åç§°','å…ƒç´ å'],1),n=f(t,['å…ƒç´ ç±»å‹','ç±»å‹','å…ƒç´ åˆ†ç±»'],2),o=f(t,['æ‰€åœ¨åœ°ç‚¹','ä½ç½®','åœ°ç‚¹'],3),i=f(t,['å…ƒç´ æè¿°','æè¿°','è¯´æ˜'],null),c=f(t,['çŠ¶æ€','äº¤äº’çŠ¶æ€'],null),s=f(t,['äº¤äº’é€‰é¡¹','äº¤äº’','äº’åŠ¨','å¯äº¤äº’'],null);e.forEach((t,e)=>{const l=String(t[a]||'').trim();if(!l)return;const u=String(t[o]||'').trim();if(!u)return;if(g&&b.size>0&&!b.has(u))return;const d=s>=0?t[s]:'',p=String(d||'').split(/[,ï¼Œã€;ï¼›]/).map(t=>t.trim()).filter(Boolean),f=n>=0&&t[n]||'';((t,e)=>{D.has(t)||D.set(t,[]),D.get(t).push(e)})(u,{name:l,type:f,location:u,description:i>=0&&t[i]||'',status:c>=0&&t[c]||'',interactions:p,emoji:mt(l,f),tableKey:r.key||'',rowIndex:e})})}const I=new Map,F=async t=>{const e=await ft.getAsync(t.name),a={...t,avatarUrl:e,avatarOffsetX:ft.getOffsetX(t.name),avatarOffsetY:ft.getOffsetY(t.name),avatarScale:ft.getScale(t.name)};I.has(a.location)||I.set(a.location,[]),I.get(a.location).push(a)};let S='';if(i?.data){const t=Nt.player,e=i.data.headers||[],a=(i.data.rows||[])[0]||[],n=Rt.findColumnIndex(e,'name',t),o=Rt.findColumnIndex(e,'position',t),r=n>=0?a[n]:ut(),c=o>=0?a[o]:'',s=String(r||'').trim();S=String(c||'').trim(),!S&&p&&(S=p),s&&S&&await F({name:s,location:S,isPlayer:!0,isInScene:!0,tableKey:i.key||'',rowIndex:0})}if(o?.data){const t=Nt.npc,e=o.data.headers||[],a=o.data.rows||[],n=Rt.findColumnIndex(e,'name',t),i=Rt.findColumnIndex(e,'position',t),r=Rt.findColumnIndex(e,'inScene',t);for(let t=0;t<a.length;t++){const c=a[t],s=String(c[n]||'').trim();if(!s)continue;const l=String(c[i]||'').trim();if(!l)continue;if(g&&b.size>0&&!b.has(l))continue;const u=r>=0?c[r]:'',d=e[r]||'',p=ra(u,d);await F({name:s,location:l,isPlayer:!1,isInScene:p,tableKey:o.key||'',rowIndex:t})}}const M=b.values().next().value,j=[...new Set(Array.from(b.values()).map(t=>t.region||'å…¶ä»–'))].sort(),T=j.indexOf('å…¶ä»–');T>-1&&(j.splice(T,1),j.push('å…¶ä»–'));const P=(()=>{if(p&&b.has(p))return p;if(S&&b.has(S))return S;const t=j[0];if(t){const e=(t=>{const e=t||'å…¶ä»–';return Array.from(b.values()).filter(t=>(t.region||'å…¶ä»–')===e).sort((t,e)=>{const a=(I.get(t.name)?.length||0)+(D.get(t.name)?.length||0);return(I.get(e.name)?.length||0)+(D.get(e.name)?.length||0)-a})})(t);if(e.length>0)return e[0].name}return M?M.name:''})();return{currentRegion:g||b.get(S)?.region||'å…¶ä»–',detailLocation:p,focusLocation:P,playerLocation:S,locations:b,elements:D,characters:I,allRegions:j}};let sa=!1;const la=async()=>{const{$}=$e();if(sa)return;sa=!0,$('.acu-map-overlay').remove();let t=await ca();if(!t)return sa=!1,void(window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°åœ°å›¾æ•°æ®'));const e=ma(),a=new Map,n=t.detailLocation||'',o=t.playerLocation||'';let i='',s=t.currentRegion;if(n&&t.locations.has(n)){i=n;const e=t.locations.get(n);s=e?.region||t.currentRegion||'å…¶ä»–'}else if(o&&t.locations.has(o)){i=o;const e=t.locations.get(o);s=e?.region||t.currentRegion||'å…¶ä»–'}else if(t.focusLocation&&t.locations.has(t.focusLocation)){i=t.focusLocation;const e=t.locations.get(i);s=e?.region||t.currentRegion||'å…¶ä»–'}i&&(Ae.set(R,i),a.set(s,i));const l=$(`\n            <div class="acu-map-overlay acu-theme-${e.theme}">\n                <div class="acu-map-container">\n                    <div class="acu-panel-header">\n                        <div class="acu-map-title">\n                            <i class="fa-solid fa-map-location-dot"></i>\n                            <span class="acu-map-region-name">${r(t.currentRegion||'åœ°å›¾')}</span>\n                        </div>\n                        <div class="acu-map-region-tabs"></div>\n                        <div class="acu-map-actions">\n                            <button class="acu-map-back-btn" title="å›åˆ°å½“å‰åœ°ç‚¹"><i class="fa-solid fa-location-crosshairs"></i></button>\n                            <button class="acu-close-btn acu-map-close"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-map-body">\n                        <div class="acu-map-focus-area"></div>\n                        <div class="acu-map-thumbnails"></div>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(l);const u=l[0];u.style.setProperty('position','fixed','important'),u.style.setProperty('top','0','important'),u.style.setProperty('left','0','important'),u.style.setProperty('right','0','important'),u.style.setProperty('bottom','0','important'),u.style.setProperty('width','100vw','important'),u.style.setProperty('height','100vh','important'),u.style.setProperty('display','flex','important'),u.style.setProperty('justify-content','center','important'),u.style.setProperty('align-items','center','important'),u.style.setProperty('z-index','31100','important');const d=l.find('.acu-map-focus-area'),p=l.find('.acu-map-thumbnails'),g=t=>{const e=t.name||t.type||'å…ƒç´ ',a=t.emoji?`<span class="acu-map-chip-emoji">${t.emoji}</span>`:'';return`\n                 <div class="acu-map-element-chip acu-dash-preview-trigger" data-table-key="${r(t.tableKey||'')}" data-row-index="${t.rowIndex}">\n                     ${a}\n                     <span class="acu-map-chip-name" title="${r(e)}">${r(e)}</span>\n                 </div>\n             `},f=()=>{d.html(((t,e)=>{const a=t.locations.get(e);if(!a)return'<div class="acu-map-loading" style="grid-column: 1 / -1;"><div class="acu-map-spinner"></div></div>';const n=t.characters.get(e)||[],o=t.elements.get(e)||[],i=n.slice(0,Math.ceil(n.length/2)),c=n.slice(Math.ceil(n.length/2)),s=o.slice(0,Math.ceil(o.length/2)),l=o.slice(Math.ceil(o.length/2)),u=t=>{const e=gt(t.name),a=t.avatarUrl?`background-image:url('${t.avatarUrl}');background-size:${t.avatarScale}%;background-position:${t.avatarOffsetX}% ${t.avatarOffsetY}%;`:'';return`\n            <div class="acu-map-avatar acu-dash-preview-trigger" data-table-key="${r(t.tableKey||'')}" data-row-index="${t.rowIndex}">\n                <div class="acu-map-avatar-circle" style="${a}">\n                    ${t.avatarUrl?'':`<span>${r(e.charAt(0))}</span>`}\n                </div>\n                <div class="acu-map-avatar-name" title="${r(e)}">${r(e.length>4?e.substring(0,4)+'..':e)}</div>\n            </div>\n        `},d=i.length?i.map(u).join(''):'',p=c.length?c.map(u).join(''):'',f=s.length?s.map(t=>g(t)).join(''):'',b=l.length?l.map(t=>g(t)).join(''):'',m=a.emoji?`<div class="acu-map-location-emoji">${a.emoji}</div>`:`<div class="acu-map-location-text">${r(a.name.charAt(0)||'â–¡')}</div>`;return`\n        <div class="acu-map-wing left">\n            <div class="acu-map-avatar-group acu-group-left">${d||''}</div>\n            <div class="acu-map-element-group acu-group-left">${f||''}</div>\n        </div>\n        <div class="acu-map-stage-center acu-dash-preview-trigger" data-table-key="${r(a.tableKey)}" data-row-index="${a.rowIndex}">\n            ${m}\n            <div class="acu-map-location-name" title="${r(a.name)}">${r(a.name)}</div>\n        </div>\n        <div class="acu-map-wing right">\n            <div class="acu-map-avatar-group acu-group-right">${p||''}</div>\n            <div class="acu-map-element-group acu-group-right">${b||''}</div>\n        </div>\n        <div class="acu-map-mobile-stack">\n            <div class="acu-map-mobile-avatars">${d||''}${p||''}</div>\n            <div class="acu-map-mobile-elements">${f||''}${b||''}</div>\n        </div>\n    `})(t,i));const e=Array.from(t.locations.values()).filter(t=>(t.region||'å…¶ä»–')===s).sort((e,a)=>{const n=(t.characters.get(e.name)?.length||0)+(t.elements.get(e.name)?.length||0);return(t.characters.get(a.name)?.length||0)+(t.elements.get(a.name)?.length||0)-n}).map(e=>((t,e,a)=>{const n=(t.characters.get(e.name)||[]).length+(t.elements.get(e.name)||[]).length,o=e.emoji?`<div class="acu-map-thumbnail-emoji">${e.emoji}</div>`:`<div class="acu-map-thumbnail-placeholder">${r(e.name.charAt(0)||'â–¡')}</div>`,i=n>0?`<div class="acu-map-thumbnail-badge">${n}</div>`:'';return`\n        <div class="acu-map-thumbnail ${a?'active':''}" data-location="${r(e.name)}">\n            ${i}\n            ${o}\n            <div class="acu-map-thumbnail-name" title="${r(e.name)}">${r(e.name.length>6?e.name.substring(0,6)+'..':e.name)}</div>\n        </div>\n    `})(t,e,e.name===i)).join('');var a,n;p.html(e||'<div class="acu-map-empty">è¯¥åœ°åŒºæš‚æ— å…¶ä»–åœ°ç‚¹</div>'),l.find('.acu-map-region-name').text(s||'åœ°å›¾'),l.find('.acu-map-region-tabs').html((a=t.allRegions,n=s,a.length<=1?'':a.map(t=>`<button class="acu-map-region-tab ${t===n?'active':''}" data-region="${r(t)}">${r(t)}</button>`).join('')))};f(),l.data('refreshMapData',async()=>{const e=await ca();if(e){if(t=e,!t.locations.has(i)){const e=t.detailLocation||'',n=t.playerLocation||'';let o='',r=s;const c=Array.from(t.locations.values()).filter(t=>(t.region||'å…¶ä»–')===s);if(c.length>0)o=c[0].name;else if(e&&t.locations.has(e)){o=e;const a=t.locations.get(e);r=a?.region||r}else if(n&&t.locations.has(n)){o=n;const e=t.locations.get(n);r=e?.region||r}else if(t.focusLocation&&t.locations.has(t.focusLocation)){o=t.focusLocation;const e=t.locations.get(o);r=e?.region||r}else{const e=Array.from(t.locations.values())[0];e&&(o=e.name,r=e.region||'å…¶ä»–')}o&&(i=o,s=r,Ae.set(R,i),a.set(s,i))}f()}});l.find('.acu-map-close').on('click',t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),l.remove()}),l.on('click','.acu-map-region-tab',function(){const e=$(this).data('region');if(e===s)return;s=e;const n=Array.from(t.locations.values()).filter(t=>(t.region||'å…¶ä»–')===s);if(!n.find(t=>t.name===i)&&n.length>0){const e=a.get(s);if(e&&n.find(t=>t.name===e))i=e;else{const e=(e=>{const a=e||'å…¶ä»–';return Array.from(t.locations.values()).filter(t=>(t.region||'å…¶ä»–')===a).sort((e,a)=>{const n=(t.characters.get(e.name)?.length||0)+(t.elements.get(e.name)?.length||0);return(t.characters.get(a.name)?.length||0)+(t.elements.get(a.name)?.length||0)-n})})(s);i=e.length>0?e[0].name:n[0].name}Ae.set(R,i)}f()}),c(l,'acu-map-overlay',()=>{l.remove()}),l.on('click','.acu-map-thumbnail',function(){const t=$(this).data('location');var e;t&&((e=t)&&(i=e,Ae.set(R,i),a.set(s,i),f()))}),l.on('click','.acu-map-back-btn',()=>{const e=t.focusLocation,a=t.detailLocation||'',n=t.playerLocation||'';let o='';if(a&&t.locations.has(a)?o=a:n&&t.locations.has(n)?o=n:e&&t.locations.has(e)&&(o=e),!o)return;const r=t.locations.get(o),c=r?.region||t.currentRegion||'å…¶ä»–';c!==s&&(s=c),i=o,Ae.set(R,i),f()}),sa=!1},ua=t=>{console.info('[DICE]å¼€å§‹æŠ“å–äººç‰©å…³ç³»è¡¨æ•°æ®...');const{$}=$e();$('.acu-relation-graph-overlay').remove();const e=ma(),a=t.headers||[],n=t.rows||[],o=a.findIndex(t=>t&&(t.includes('å§“å')||t.includes('åç§°')))||1,i=a.findIndex(t=>t&&t.includes('äººé™…å…³ç³»')),s=t.key||'';if(console.info(`[DICE]äººç‰©å…³ç³»è¡¨æŸ¥æ‰¾: è¡¨æ ¼"${s||'æœªçŸ¥'}"ï¼Œå…±${n.length}è¡Œæ•°æ®`),i<0)return console.warn('[DICE]äººç‰©å…³ç³»è¡¨æŸ¥æ‰¾: æœªæ‰¾åˆ°"äººé™…å…³ç³»"åˆ—'),void(window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°"äººé™…å…³ç³»"åˆ—'));const l=new Map,u=[],d=t=>(t=>{if(!t)return t;const e=ut(),a=dt(),n=['<user>','{{user}}'].some(e=>t===e||t.toLowerCase()===e.toLowerCase()),o=a&&t===a,i=!!e&&(t===e||ft.getPrimaryName(t)===e);return n||o||i?'{{user}}':ft.getPrimaryName(t)})(t),p=ie||wa();let g='ä¸»è§’';if(p)for(const t in p){const e=p[t];if(e?.name?.includes('ä¸»è§’')&&e.content?.[1]){g=e.content[1][1]||'ä¸»è§’';break}}const f=d(g),b=(()=>{for(const t in p)if(p[t]?.name?.includes('ä¸»è§’'))return t;return''})();l.set(f,{name:f,isPlayer:!0,x:0,y:0,tableKey:b,rowIndex:0});const m=a.findIndex(t=>t&&t.includes('åœ¨åœº'));n.forEach((t,e)=>{const r=t[o];if(!r)return;const c=d(r);let p=!1;if(m>0){const e=String(t[m]||'').trim().toLowerCase();p=String(a[m]||'').toLowerCase().includes('ç¦»åœº')?'å¦'===e||'false'===e||'no'===e:e.startsWith('åœ¨åœº')||'true'===e||'æ˜¯'===e||'yes'===e}l.has(c)||l.set(c,{name:c,isPlayer:!1,x:0,y:0,tableKey:s,rowIndex:e,isInScene:p});const g=t[i]||'';Wt(g).forEach(t=>{if(!t.name)return;const e=d(t.name);if(e===c)return;if(!l.has(e)){let t=-1,i=!1;for(let r=0;r<n.length;r++)if(d(n[r][o])===e){if(t=r,m>0){const t=String(n[r][m]||'').trim().toLowerCase();i=String(a[m]||'').toLowerCase().includes('ç¦»åœº')?'å¦'===t||'false'===t||'no'===t:t.startsWith('åœ¨åœº')||'true'===t||'æ˜¯'===t||'yes'===t}break}l.set(e,{name:e,isPlayer:e===f,x:0,y:0,tableKey:t>=0?s:'',rowIndex:t>=0?t:void 0,isInScene:i})}const i=(t=>{if(!t)return[];const e=String(t).split(/[,ï¼Œã€;ï¼›\/\|]+|\s*[å’Œä¸&]\s*|\s{2,}|\n/).map(t=>t.trim()).filter(t=>t&&t.length<30),a=['æ‹äºº','æƒ…ä¾£','å¤«å¦»','ä¼´ä¾£','çˆ±äºº','ç”·å‹','å¥³å‹','å‰ç”·å‹','å‰å¥³å‹','æœ‹å‹','å¥½å‹','æŒšå‹','å¯†å‹','é—ºèœœ','æ­»å…š','çŸ¥å·±','æŸå‹','åŒå­¦','æ ¡å‹','åŒçª—','å­¦é•¿','å­¦å§','å­¦å¼Ÿ','å­¦å¦¹','å‰è¾ˆ','åè¾ˆ','åŒäº‹','ä¸Šå¸','ä¸‹å±','è€æ¿','å‘˜å·¥','æ­æ¡£','é˜Ÿå‹','æˆ˜å‹','ä¼™ä¼´','å¸ˆçˆ¶','å¸ˆå‚…','å¾’å¼Ÿ','å¼Ÿå­','è€å¸ˆ','å­¦ç”Ÿ','å¯¼å¸ˆ','é—¨ç”Ÿ','çˆ¶äº²','æ¯äº²','å„¿å­','å¥³å„¿','å…„å¼Ÿ','å§å¦¹','å“¥å“¥','å§å§','å¼Ÿå¼Ÿ','å¦¹å¦¹','çˆ·çˆ·','å¥¶å¥¶','å¤–å…¬','å¤–å©†','å”å”','é˜¿å§¨','èˆ…èˆ…','å§‘å§‘','è¡¨å“¥','è¡¨å§','è¡¨å¼Ÿ','è¡¨å¦¹','å ‚å…„','å ‚å¼Ÿ','å ‚å§','å ‚å¦¹','å®¶äºº','äº²äºº','äº²æˆš','è¡€äº²','ä¹‰çˆ¶','ä¹‰æ¯','ä¹‰å…„','ä¹‰å¦¹','æ•Œäºº','ä»‡äºº','å¯¹æ‰‹','åŠ²æ•Œ','å®¿æ•Œ','æƒ…æ•Œ','æ­»æ•Œ','å†¤å®¶','é‚»å±…','å®¤å‹','æˆ¿ä¸œ','ç§Ÿå®¢','å®¢æˆ·','å•†äºº','é›‡ä¸»','é›‡å‘˜','ä¿¡å¾’','æ•™å¾’','è¿½éšè€…','å´‡æ‹œè€…','ç²‰ä¸','é™Œç”Ÿäºº','ç†Ÿäºº','è·¯äºº','è¿‡å®¢'];return e.map(t=>{const e=(t=t.replace(/[ï¼ˆ(][^ï¼‰)]*[ï¼‰)]/g,'').trim()).match(/^(.+)çš„(ç›®æ ‡|å¯¹è±¡)$/);if((t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=(t=e?e[1]:t.replace(/^[\u4e00-\u9fa5]{2,4}çš„(?=[\u4e00-\u9fa5]{1,4}$)/,'')).replace(/^(?:å±äº|ä½œä¸º|èº«ä¸º|æ˜¯å…¶?|ä¸ºå…¶?|ä¹ƒ)/,'')).replace(/^(?:æ›¾ç»æ˜¯?|ä»¥å‰æ˜¯?|åŸæœ¬æ˜¯?|å‰)/,'å‰')).replace(/^(?:äº’ä¸º|å½¼æ­¤æ˜¯?|ç›¸äº’æ˜¯?)/,'')).replace(/å…³ç³»$/,'')).replace(/å¯¹è±¡$/,'')).replace(/ç›®æ ‡$/,'')).replace(/^å…³ç³»å¤æ‚$/,'å¤æ‚')).replace(/^å…³ç³»ä¸æ˜$/,'ä¸æ˜')).replace(/^å…³ç³»å¾®å¦™$/,'å¾®å¦™')).replace(/^å…³ç³»ç´§å¼ $/,'ç´§å¼ ')).replace(/^å…³ç³»äº²å¯†$/,'äº²å¯†')).replace(/^å…³ç³»ç–è¿œ$/,'ç–è¿œ')).replace(/^(?:ä¸è®¤è¯†|ä¸ç†Ÿæ‚‰|é™Œç”Ÿäºº?)$/,'é™Œç”Ÿ')).replace(/^(?:è®¤è¯†|ç†Ÿäºº)$/,'ç†Ÿäºº')).replace(/^(?:å¥½æœ‹å‹|æŒšå‹|å¯†å‹|è‡³äº¤)$/,'æŒšå‹')).replace(/^(?:ç”·æœ‹å‹|ç”·å‹)$/,'ç”·å‹')).replace(/^(?:å¥³æœ‹å‹|å¥³å‹)$/,'å¥³å‹')).replace(/^(?:å‰ç”·å‹|å‰ç”·æœ‹å‹)$/,'å‰ç”·å‹')).replace(/^(?:å‰å¥³å‹|å‰å¥³æœ‹å‹)$/,'å‰å¥³å‹')).replace(/^(?:æš—æ‹å¯¹è±¡|æš—æ‹)$/,'æš—æ‹')).replace(/^(?:å•ç›¸æ€|å•æ‹)$/,'å•æ‹')).replace(/^(?:é’æ¢…ç«¹é©¬|å„¿æ—¶ç©ä¼´|å‘å°)$/,'é’æ¢…ç«¹é©¬')).replace(/^(?:åŒç­åŒå­¦|åŒçº§åŒå­¦)$/,'åŒå­¦')).replace(/^(?:å·¥ä½œä¼™ä¼´|åˆä½œä¼™ä¼´|æ­æ¡£)$/,'æ­æ¡£')).trim()).length>8){for(const e of a)if(t.endsWith(e))return e;const e=t.slice(-4);for(const t of a)if(e.includes(t))return t;return t.slice(-3)}return t}).filter(t=>t&&t.length>0&&t.length<=8)})(t.relation);0===i.length&&i.push('');let r=u.find(t=>t.source===c&&t.target===e||t.source===e&&t.target===c);if(r)if(r.source===c){const t=[...r.labelsFromSource||[],...i];r.labelsFromSource=[...new Set(t)].slice(0,2)}else{const t=[...r.labelsFromTarget||[],...i];r.labelsFromTarget=[...new Set(t)].slice(0,2)}else u.push({source:c,target:e,labelsFromSource:i.slice(0,2),labelsFromTarget:[]})})});const v=Array.from(l.values());console.info(`[DICE]äººç‰©å…³ç³»è¡¨æ•°æ®æŠ“å–å®Œæˆï¼Œå…±${v.length}ä¸ªèŠ‚ç‚¹ï¼Œ${u.length}æ¡è¾¹`);const h=new Map;v.forEach(t=>h.set(t.name,0)),u.forEach(t=>{h.set(t.source,(h.get(t.source)||0)+1),h.set(t.target,(h.get(t.target)||0)+1)});const x=window.innerWidth<=768,y=x?22:28,w=x?38:50,k=x?28:35,C=x?2.5:3.5;let E=1,A=!1,D=!1;const I=(t,e)=>{const a=e?k:y,n=h.get(t)||0;return Math.min(w,a+Math.sqrt(n)*C)*E};v.forEach(t=>{t.radius=I(t.name,t.isPlayer)});const F=()=>`acu-relation-graph-layout-cache-${v.map(t=>t.name).sort().join('|')}`,S=()=>{try{const t=F(),e=localStorage.getItem(t);if(!e)return!1;const a=JSON.parse(e);let n=!0;for(const t of v)if(!a[t.name]){n=!1;break}return!!n&&(v.forEach(t=>{const e=a[t.name];e&&(t.x=e.x,t.y=e.y,t.vx=0,t.vy=0)}),!0)}catch(t){return console.warn('[DICE]å…³ç³»å›¾ åŠ è½½å¸ƒå±€ç¼“å­˜å¤±è´¥:',t),!1}},M=()=>{v.forEach(t=>{if(t.isPlayer)t.x=400,t.y=300,t.vx=0,t.vy=0;else{const e=2*Math.random()*Math.PI,a=50+100*Math.random();t.x=400+Math.cos(e)*a,t.y=300+Math.sin(e)*a,t.vx=0,t.vy=0}});const t=new Map;v.forEach(e=>t.set(e.name,e));for(let e=0;e<300;e++){for(let t=0;t<v.length;t++){const e=v[t];for(let a=t+1;a<v.length;a++){const t=v[a],n=t.x-e.x,o=t.y-e.y;let i=n*n+o*o;i<1&&(i=1);const r=Math.sqrt(i),c=2e4/i,s=n/r*c,l=o/r*c;e.isPlayer||(e.vx-=s,e.vy-=l),t.isPlayer||(t.vx+=s,t.vy+=l)}}u.forEach(e=>{const a=t.get(e.source),n=t.get(e.target);if(!a||!n)return;const o=n.x-a.x,i=n.y-a.y,r=Math.sqrt(o*o+i*i)||1,c=.02*(r-250),s=o/r*c,l=i/r*c;a.isPlayer||(a.vx+=s,a.vy+=l),n.isPlayer||(n.vx-=s,n.vy-=l)}),v.forEach(t=>{if(t.isPlayer)return;const e=400-t.x,a=300-t.y;t.vx+=.01*e,t.vy+=.01*a});const a=50*(1-e/300);v.forEach(t=>{if(t.isPlayer)return;t.vx*=.8,t.vy*=.8;const e=Math.sqrt(t.vx*t.vx+t.vy*t.vy);e>a&&(t.vx=t.vx/e*a,t.vy=t.vy/e*a),t.x+=.5*t.vx,t.y+=.5*t.vy})}(()=>{try{const t=F(),e={};v.forEach(t=>{e[t.name]={x:t.x,y:t.y}}),localStorage.setItem(t,JSON.stringify(e))}catch(t){console.warn('[DICE]å…³ç³»å›¾ ä¿å­˜å¸ƒå±€ç¼“å­˜å¤±è´¥:',t)}})()};S()||M();let j=1,T=0,P=0;const N=$(`\n            <div class="acu-relation-graph-overlay acu-theme-${e.theme}">\n                <div class="acu-relation-graph-container">\n                    <div class="acu-panel-header">\n                        <div class="acu-graph-title">\n                            <i class="fa-solid fa-project-diagram"></i>\n                            <button class="acu-graph-btn acu-filter-toggle acu-graph-filter-btn ml-8" id="filter-in-scene" title="åªæ˜¾ç¤ºä¸»è§’å’Œåœ¨åœºè§’è‰²"><i class="fa-solid fa-map-marker-alt"></i></button>\n                            <button class="acu-graph-btn acu-filter-toggle acu-graph-filter-btn" id="filter-direct-only" title="åªæ˜¾ç¤ºä¸ä¸»è§’ç›´æ¥ç›¸å…³"><i class="fa-solid fa-link"></i></button>\n                        </div>\n                        <div class="acu-graph-actions">\n                            <button class="acu-graph-btn" id="graph-relayout" title="é‡æ–°å¸ƒå±€ï¼ˆæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°è®¡ç®—èŠ‚ç‚¹ä½ç½®ï¼‰"><i class="fa-solid fa-sync"></i></button>\n                            <button class="acu-graph-btn" id="graph-manage-avatar" title="ç®¡ç†å¤´åƒ"><i class="fa-solid fa-user-circle"></i></button>\n                            <button class="acu-graph-btn acu-graph-close" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-graph-canvas-wrapper">\n                        <svg class="acu-graph-svg" viewBox="0 0 800 600">\n                            <defs>\n                                <marker id="arrowhead-end" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 6 2.5, 0 5" />\n                                </marker>\n                                <marker id="arrowhead-start" markerWidth="6" markerHeight="5" refX="1" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="6 0, 0 2.5, 6 5" />\n                                </marker>\n                                <marker id="arrowhead-end-hl" markerWidth="7" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 7 3, 0 6" />\n                                </marker>\n                                <marker id="arrowhead-start-hl" markerWidth="7" markerHeight="6" refX="1" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="7 0, 0 3, 7 6" />\n                                </marker>\n                            </defs>\n                            <g class="acu-graph-transform">\n                                <g class="acu-graph-edges"></g>\n                                <g class="acu-graph-nodes"></g>\n                            </g>\n                        </svg>\n                        <div class="acu-node-size-slider-container">\n                            <div class="acu-slider-header">\n                                <span class="acu-slider-label">èŠ‚ç‚¹å¤§å°</span>\n                                <span id="slider-size-display" class="acu-slider-value">${Math.round(100*E)}%</span>\n                            </div>\n                            <input type="range" id="node-size-slider" min="0.5" max="2.0" step="0.1" value="${E}" class="acu-range-input" />\n                        </div>\n                    </div>\n                    <div class="acu-graph-legend">\n                        <button class="acu-graph-btn acu-graph-reset-btn" id="graph-zoom-reset" title="é‡ç½®è§†å›¾å’ŒèŠ‚ç‚¹å¤§å°"><i class="fa-solid fa-compress-arrows-alt"></i><span>é‡ç½®</span></button>\n                        <div class="acu-node-size-stepper-wrapper acu-node-size-wrapper">\n                            <span style="font-size:11px;color:var(--acu-text-sub);white-space:nowrap;">èŠ‚ç‚¹:</span>\n                            <div class="acu-stepper acu-stepper-container" data-id="graph-node-size" data-min="50" data-max="200" data-step="10">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value acu-stepper-value-display" id="node-size-display">${Math.round(100*E)}%</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <span class="acu-zoom-display acu-zoom-info">\n                            <span>è§†å›¾:</span>\n                            <span>${Math.round(100*j)}%</span>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(N);const R=N.find('.acu-graph-svg'),O=N.find('.acu-graph-transform'),B=N.find('.acu-graph-edges'),L=N.find('.acu-graph-nodes'),U=N.find('.acu-zoom-display span:last-child'),V=N.find('#node-size-display'),q=N.find('.acu-graph-canvas-wrapper'),Y=()=>{O.attr('transform',`translate(${T}, ${P}) scale(${j})`),U.text(`${Math.round(100*j)}%`)},J=()=>{V.length&&V.text(`${Math.round(100*E)}%`)},W=(t,e=400,a=300)=>{const n=j;j=Math.max(.3,Math.min(4,t));const o=j/n;T=e-(e-T)*o,P=a-(a-P)*o,Y()},X=async()=>{const t=(()=>{if(!A&&!D)return v;let t=null;return D&&(t=new Set([f]),u.forEach(e=>{e.source===f&&t.add(e.target),e.target===f&&t.add(e.source)})),v.filter(e=>{const a=!A||e.isInScene||e.isPlayer,n=!D||t.has(e.name);return a&&n})})(),e=new Set(t.map(t=>t.name)),a=u.filter(t=>e.has(t.source)&&e.has(t.target));let n='';a.forEach((t,e)=>{const a=l.get(t.source),o=l.get(t.target);if(!a||!o)return;const i=o.x-a.x,c=o.y-a.y,s=Math.sqrt(i*i+c*c)||1,u=i/s,d=c/s,p=-d,g=u,f=t.labelsFromSource&&t.labelsFromSource.length>0&&t.labelsFromSource.some(t=>t),b=t.labelsFromTarget&&t.labelsFromTarget.length>0&&t.labelsFromTarget.some(t=>t),m=a.radius||28,v=o.radius||28,h=a.x+u*(m+10),x=a.y+d*(m+10),y=o.x-u*(v+10),w=o.y-d*(v+10);let k=(t.labelsFromSource||[]).filter(t=>t),C=(t.labelsFromTarget||[]).filter(t=>t);const E=new Set(k),A=new Set(C),D=[...E].filter(t=>A.has(t)),I=k.filter(t=>!D.includes(t)),F=C.filter(t=>!D.includes(t));let S='',M='';f&&(M='url(#arrowhead-end)'),b&&(S='url(#arrowhead-start)'),n+=`<line class="acu-graph-edge" x1="${h}" y1="${x}" x2="${y}" y2="${w}"\n                    ${M?`marker-end="${M}"`:''}\n                    ${S?`marker-start="${S}"`:''}\n                    data-edge-idx="${e}" />`;const j=(a.x+o.x)/2,T=(a.y+o.y)/2,P=Math.sqrt(i*i+c*c);if(f&&b&&D.length>0&&0===I.length&&0===F.length)D.slice(0,2).forEach((t,a)=>{if(!t)return;const o=0===a?1:-1,i=6+10*a;n+=`<text class="acu-graph-edge-label" x="${j+p*o*i}" y="${T+g*o*i}" data-edge-idx="${e}">${r(t)}</text>`});else{const t=Math.max(30,Math.min(.25*P,60)),a=[{emoji:'ğŸ’•',keywords:['æ‹äºº','æ‹çˆ±','çˆ±æƒ…','æ‹æƒ…','æƒ…ä¾£','ç”·å‹','å¥³å‹','æš—æ‹','å•æ‹','å¿ƒåŠ¨','å–œæ¬¢','çˆ±æ…•','å€¾å¿ƒ','é’Ÿæƒ…','æƒ…äºº','çˆ±äºº']},{emoji:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',keywords:['å®¶äºº','äº²äºº','çˆ¶æ¯','çˆ¶äº²','æ¯äº²','å…„å¼Ÿ','å§å¦¹','å…„å¦¹','å§å¼Ÿ','å„¿å­','å¥³å„¿','çˆ·çˆ·','å¥¶å¥¶','å¤–å…¬','å¤–å©†','å”å”','é˜¿å§¨','è¡¨äº²','å ‚äº²','è¡€äº²']},{emoji:'ğŸ˜Š',keywords:['æœ‹å‹','å‹äºº','å¥½å‹','å‹æƒ…','ä¼™ä¼´','æ­æ¡£','é˜Ÿå‹','æˆ˜å‹','åŒä¼´','ç›Ÿå‹','æŒšå‹','å¯†å‹','è‡³äº¤','é—ºèœœ','æ­»å…š','çŸ¥å·±','è«é€†']},{emoji:'ğŸ“',keywords:['å¸ˆçˆ¶','å¸ˆå‚…','å¾’å¼Ÿ','å¸ˆå¾’','è€å¸ˆ','å­¦ç”Ÿ','å¯¼å¸ˆ','å¼Ÿå­','é—¨ç”Ÿ','åŒå­¦','åŒçª—','åŒçº§','åŒç­','å‰è¾ˆ','åè¾ˆ','å­¦é•¿','å­¦å§','å­¦å¼Ÿ','å­¦å¦¹']},{emoji:'ğŸ’°',keywords:['äº¤æ˜“','åˆä½œ','ç”Ÿæ„','å®¢æˆ·','å•†ä¸š','åˆ©ç›Š','é›‡ä½£','å¥‘çº¦','åˆåŒ']},{emoji:'âš”ï¸',keywords:['å¯¹æ‰‹','ç«äº‰','åŠ²æ•Œ','å®¿æ•Œ','æƒ…æ•Œ','æ­»å¯¹å¤´','å†¤å®¶']},{emoji:'ğŸ’¢',keywords:['æ•Œäºº','ä»‡äºº','ä»‡æ¨','æ•Œå¯¹','ä»‡æ•Œ','æ­»æ•Œ','æ†æ¨','æ€¨æ¨','ä»‡æ€¨']},{emoji:'ğŸ™',keywords:['ä¿¡ä»°','å´‡æ‹œ','æ•¬ä»°','ä»°æ…•','è¿½éš','ä¿¡å¾’','æ•™å¾’','ç‹‚ä¿¡']},{emoji:'ğŸŒ€',keywords:['å¤æ‚','å¾®å¦™','çº è‘›','ç¾ç»Š','çº ç¼ ']}],o=t=>{if(!t)return'';for(const e of a)for(const a of e.keywords)if(t.includes(a))return t+e.emoji;return t},i=(t,e=4)=>{if(!t)return'';const a=t.length>e?t.substring(0,e)+'..':t;return o(a)};if(D.length>0&&D.slice(0,1).forEach((t,a)=>{if(!t)return;n+=`<text class="acu-graph-edge-label" x="${j+8*p}" y="${T+8*g-3}" data-edge-idx="${e}">${r(i(t,5))}</text>`}),I.length>0||f&&!b&&0===D.length){const a=I.length>0?I:k,o=j-u*t,c=T-d*t;a.slice(0,2).forEach((t,a)=>{if(!t)return;const s=10*(0===a?1:-1);n+=`<text class="acu-graph-edge-label" x="${o+p*s}" y="${c+g*s}" data-edge-idx="${e}">${r(i(t,5))}</text>`})}if(F.length>0||b&&!f&&0===D.length){const a=F.length>0?F:C,o=j+u*t,c=T+d*t;a.slice(0,2).forEach((t,a)=>{if(!t)return;const s=10*(0===a?-1:1);n+=`<text class="acu-graph-edge-label" x="${o+p*s}" y="${c+g*s}" data-edge-idx="${e}">${r(i(t,5))}</text>`})}}}),B.html(n);let o='';for(const e of t){const t=await ft.getAsync(e.name),a=(e.isPlayer,.22*e.radius),n=.62*e.radius,i=e.isInScene?`<circle class="acu-node-inscene-indicator" cx="${n}" cy="${n}" r="${a}" style="fill:var(--acu-accent);stroke:var(--acu-bg-panel);stroke-width:3;" />`:'',c=gt(e.name);o+=`\n                <g class="acu-graph-node acu-dash-preview-trigger" data-name="${r(e.name)}" data-table-key="${e.tableKey||''}" data-row-index="${void 0!==e.rowIndex?e.rowIndex:''}" transform="translate(${e.x}, ${e.y})">\n                    <circle class="acu-node-bg" r="${e.radius}" />\n                    ${t?(()=>{const a=ft.getOffsetX(e.name),n=ft.getOffsetY(e.name),o=ft.getScale(e.name),i=2*(e.radius-2),r=i+8,c=r/2;return`<foreignObject x="${-c}" y="${-c}" width="${r}" height="${r}">\n                            <div class="acu-node-avatar" xmlns="http://www.w3.org/1999/xhtml" style="\n                                width: ${i}px;\n                                height: ${i}px;\n                                margin: 4px;\n                                border-radius: 50%;\n                                background-image: url('${t}');\n                                background-size: ${o}%;\n                                background-position: ${a}% ${n}%;\n                                background-repeat: no-repeat;\n                            "></div>\n                        </foreignObject>`})():`<text class="acu-node-char" dy="0.35em">${r(c.charAt(0))}</text>`}\n                    ${i}\n                    <text class="acu-node-label" dy="${e.radius+14}">${r(c)}</text>\n                </g>\n            `}L.html(o)},H=t=>{R.addClass('highlighting'),L.find('.acu-graph-node').each(function(){$(this).data('name')===t&&$(this).addClass('highlighted')});const e=new Set([t]);u.forEach(a=>{if(a.source===t||a.target===t){const n=a.source===t?a.target:a.source;e.add(n)}}),L.find('.acu-graph-node').each(function(){e.has($(this).data('name'))&&$(this).addClass('highlighted')});const a=new Set;u.forEach((e,n)=>{e.source!==t&&e.target!==t||a.add(n)}),B.find('.acu-graph-edge').each(function(){const t=parseInt($(this).attr('data-edge-idx'),10);a.has(t)&&($(this).addClass('highlighted'),$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end-hl)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start-hl)'))}),B.find('.acu-graph-edge-label').each(function(){const t=parseInt($(this).attr('data-edge-idx'),10);a.has(t)&&$(this).addClass('highlighted')})},K=()=>{R.removeClass('highlighting'),L.find('.highlighted').removeClass('highlighted'),B.find('.highlighted').removeClass('highlighted'),B.find('.acu-graph-edge').each(function(){$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start)')})};if(!window.matchMedia('(pointer: fine)').matches){let t=null;L.on('pointerdown','.acu-graph-node',function(e){const a=$(this),n=a.data('name'),o=e.clientX,i=e.clientY,r=Date.now();let c=!1,s=!1;if(t)return K(),t=null,e.preventDefault(),void e.stopPropagation();const l=setTimeout(()=>{!c&&n&&(s=!0,t=n,H(n),navigator.vibrate&&navigator.vibrate(30))},300);$(document).on('pointermove.mobilenode',t=>{const e=Math.abs(t.clientX-o),a=Math.abs(t.clientY-i);(e>8||a>8)&&(c=!0,clearTimeout(l))}),$(document).on('pointerup.mobilenode pointercancel.mobilenode',()=>{$(document).off('pointermove.mobilenode pointerup.mobilenode pointercancel.mobilenode'),clearTimeout(l);const t=Date.now()-r;if(!s&&!c&&t<300){const t=a.data('name'),e=ft.getPrimaryName(t),n=a.data('table-key');let o=a.data('row-index');if(!n||''===o||void 0===o){const t=ie||wa();if(t)for(const a in t){const n=t[a];if(!n?.content||!n.name?.includes('NPC'))continue;const o=(n.content[0]||[]).findIndex(t=>t&&(t.includes('å§“å')||t.includes('åç§°')||t.includes('åå­—')));if(!(o<0))for(let t=1;t<n.content.length;t++){const i=String(n.content[t][o]||'').trim();if(i===e||ft.getPrimaryName(i)===e){const e=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',a).data('row-index',t-1);return $('body').append(e),e.trigger('click.acu_dash_preview'),void e.remove()}}}return void(window.toastr&&window.toastr.info(`ã€Œ${e}ã€æš‚æ— è¯¦ç»†èµ„æ–™`,'',{timeOut:2e3}))}const i=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',n).data('row-index',parseInt(o,10));$('body').append(i),i.trigger('click.acu_dash_preview'),i.remove()}})}),q.on('pointerup.mobileclear',function(e){t&&!$(e.target).closest('.acu-graph-node').length&&(K(),t=null)})}else L.on('pointerenter.pchover','.acu-graph-node',function(){const t=$(this).data('name');t&&H(t)}),L.on('pointerleave.pchover','.acu-graph-node',function(){K()}),L.on('click.pcclick','.acu-graph-node',function(t){t.stopPropagation();const e=$(this),a=e.data('name'),n=ft.getPrimaryName(a),o=e.data('table-key');let i=e.data('row-index');if(!o||''===i||void 0===i){const t=ie||wa();if(t)for(const e in t){const a=t[e];if(!a?.content||!a.name?.includes('NPC'))continue;const o=(a.content[0]||[]).findIndex(t=>t&&(t.includes('å§“å')||t.includes('åç§°')||t.includes('åå­—')));if(!(o<0))for(let t=1;t<a.content.length;t++){const i=String(a.content[t][o]||'').trim();if(i===n||ft.getPrimaryName(i)===n){const a=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',e).data('row-index',t-1);return $('body').append(a),a.trigger('click.acu_dash_preview'),void a.remove()}}}return void(window.toastr&&window.toastr.info(`ã€Œ${n}ã€æš‚æ— è¯¦ç»†èµ„æ–™`,'',{timeOut:2e3}))}const r=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',o).data('row-index',parseInt(i,10));$('body').append(r),r.trigger('click.acu_dash_preview'),r.remove()});X().then(()=>{Y()});let G=!1,Q=0,Z=0,tt=0,et=0,at=0,nt=null;const ot=q[0],it=R[0];ot.onpointerdown=function(t){0===t.button&&($(t.target).closest('.acu-graph-node').length||$(t.target).closest('.acu-node-size-slider-container').length||(t.preventDefault(),ot.setPointerCapture(t.pointerId),nt=t.pointerId,G=!0,Q=t.clientX,Z=t.clientY,tt=T,et=P,it.style.cursor='grabbing'))},ot.onpointermove=function(t){if(!G||t.pointerId!==nt)return;const e=t.clientX-Q,a=t.clientY-Z,n=it.getBoundingClientRect();T=tt+e/n.width*800,P=et+a/n.height*600,Y()},ot.onpointerup=function(t){t.pointerId===nt&&(ot.releasePointerCapture(t.pointerId),G=!1,nt=null,it.style.cursor='grab')},ot.onpointercancel=function(t){t.pointerId===nt&&(G=!1,nt=null,it.style.cursor='grab')},ot.onwheel=function(t){t.preventDefault();const e=t.deltaY>0?-.15:.15;W(j+e)},ot.addEventListener('touchstart',function(t){2===t.touches.length&&(t.preventDefault(),G=!1,at=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY))},{passive:!1}),ot.addEventListener('touchmove',function(t){if(2===t.touches.length){t.preventDefault();const e=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY);at>0&&W(j*(e/at)),at=e}},{passive:!1}),ot.addEventListener('touchend',function(t){t.touches.length<2&&(at=0)});const rt=N.find('#node-size-slider'),ct=N.find('#slider-size-display'),st=N.find('.acu-node-size-slider-container'),lt=N.find('#node-size-display-trigger');N.find('.acu-graph-legend');let pt=!1,bt=null;const mt=()=>{pt&&(bt&&(clearTimeout(bt),bt=null),pt=!1,st.hide())},vt=()=>{bt&&clearTimeout(bt),bt=setTimeout(()=>{mt()},4e3)};N.on('click','#node-size-display-trigger, #node-size-display-trigger *',function(t){t.stopPropagation(),pt?mt():(()=>{if(pt)return;bt&&(clearTimeout(bt),bt=null),pt=!0;const t=lt[0].getBoundingClientRect(),e=q[0].getBoundingClientRect(),a=e.height-60-10,n=t.left-e.left;st.css({display:'block',top:`${a}px`,left:`${n}px`}),vt()})()}),rt.on('input mousedown touchstart',function(t){t.stopPropagation(),pt&&vt()}),st.on('pointerdown mousedown touchstart',function(t){t.stopPropagation()}),$(document).on('click.slider-hide',function(t){!pt||st.is(t.target)||0!==st.has(t.target).length||lt.is(t.target)||0!==lt.has(t.target).length||mt()}),rt.on('input',function(){E=parseFloat($(this).val()),ct.text(Math.round(100*E)+'%'),J(),v.forEach(t=>{t.radius=I(t.name,t.isPlayer)}),X(),vt()});const ht=N.find('#filter-in-scene'),xt=N.find('#filter-direct-only'),yt=()=>{ht.toggleClass('active',A),xt.toggleClass('active',D)};yt(),ht.click(function(t){t.stopPropagation(),A=!A,yt(),X()}),xt.click(function(t){t.stopPropagation(),D=!D,yt(),X()}),N.find('#graph-zoom-reset').click(()=>{j=1,T=0,P=0,Y(),E=1,rt.val(1),ct.text('100%'),J();const t=N.find('.acu-stepper[data-id="graph-node-size"]');t.length&&t.find('.acu-stepper-value').text('100%'),v.forEach(t=>{t.radius=I(t.name,t.isPlayer)}),S()||M(),X()});const wt=N.find('.acu-stepper[data-id="graph-node-size"]');if(wt.length){const t=parseInt(wt.data('min')),e=parseInt(wt.data('max')),a=parseInt(wt.data('step')),n=wt.find('.acu-stepper-value'),o=a=>{a=Math.max(t,Math.min(e,a)),E=a/100,n.text(`${a}%`),J(),v.forEach(t=>{t.radius=I(t.name,t.isPlayer)}),X()},i=()=>{const t=n.text().replace(/[^\d]/g,'');return parseInt(t)||100};wt.find('.acu-stepper-dec').on('click',function(){o(i()-a)}),wt.find('.acu-stepper-inc').on('click',function(){o(i()+a)})}N.find('#graph-relayout').click(()=>{(()=>{try{const t=F();localStorage.removeItem(t)}catch(t){console.warn('[DICE]å…³ç³»å›¾ æ¸…é™¤å¸ƒå±€ç¼“å­˜å¤±è´¥:',t)}})(),v.forEach(t=>{t.radius=I(t.name,t.isPlayer)}),M(),X()}),N.find('#graph-manage-avatar').click(()=>{pa(v,()=>{v.forEach(t=>{t.radius=I(t.name,t.isPlayer)}),X()})});const kt=()=>{ot.onpointerdown=null,ot.onpointermove=null,ot.onpointerup=null,ot.onpointercancel=null,ot.onwheel=null,bt&&(clearTimeout(bt),bt=null),$(document).off('click.slider-hide'),N.remove()};N.find('.acu-graph-close').click(kt),c(N,'acu-relation-graph-overlay',kt)},da=(t,e,a)=>{const{$}=$e();$('.acu-crop-modal-overlay').remove();const n=ma();let o=150,i=50,s=50;const l=ft.getAll()[e];l&&(o=l.scale??150,i=l.offsetX??50,s=l.offsetY??50);const u=`\n            <div class="acu-crop-modal-overlay acu-theme-${n.theme}">\n                <div class="acu-crop-modal">\n                    <div class="acu-crop-header">\n                        <span><i class="fa-solid fa-crop-simple"></i> è°ƒæ•´å¤´åƒ - ${r(e)}</span>\n                        <button class="acu-crop-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-crop-body">\n                        <div class="acu-crop-container">\n                            <div class="acu-crop-image" style="\n                                background-image: url('${t}');\n                                background-size: ${o}%;\n                                background-position: ${i}% ${s}%;\n                            "></div>\n                            <div class="acu-crop-mask"></div>\n                        </div>\n                        <div class="acu-crop-hint">æ‹–æ‹½ç§»åŠ¨ Â· æ»šè½®/åŒæŒ‡ç¼©æ”¾</div>\n                    </div>\n                    <div class="acu-crop-footer">\n                        <label class="acu-crop-btn acu-crop-reupload" title="é‡æ–°ä¸Šä¼ ">\n                            <i class="fa-solid fa-camera"></i>\n                            <input type="file" accept="image/*" class="acu-crop-file-input" />\n                        </label>\n                        <button class="acu-crop-btn acu-crop-cancel">å–æ¶ˆ</button>\n                        <button class="acu-crop-btn acu-crop-confirm"><i class="fa-solid fa-check"></i> ç¡®å®š</button>\n                    </div>\n                </div>\n            </div>\n        `,d=$(u);$('body').append(d);const p=d.find('.acu-crop-image'),g=d.find('.acu-crop-container')[0],f=p[0],b=()=>{f.style.backgroundSize=`${o}%`,f.style.backgroundPosition=`${i}% ${s}%`};let m=!1,v=0,h=0,x=0,y=0,w=null;f.addEventListener('pointerdown',t=>{null===w&&(t.preventDefault(),t.stopPropagation(),m=!0,w=t.pointerId,v=t.clientX,h=t.clientY,x=i,y=s,f.setPointerCapture(t.pointerId),f.style.cursor='grabbing')}),f.addEventListener('pointermove',t=>{if(!m||t.pointerId!==w)return;t.preventDefault(),t.stopPropagation();const e=t.clientX-v,a=t.clientY-h,n=100/o;i=Math.max(0,Math.min(100,x-e*n)),s=Math.max(0,Math.min(100,y-a*n)),b()}),f.addEventListener('pointerup',t=>{t.pointerId===w&&(m=!1,w=null,f.releasePointerCapture(t.pointerId),f.style.cursor='grab')}),f.addEventListener('pointercancel',t=>{t.pointerId===w&&(m=!1,w=null,f.style.cursor='grab')}),g.addEventListener('wheel',t=>{t.preventDefault(),t.stopPropagation();const e=t.deltaY>0?-10:10;o=Math.max(100,Math.min(300,o+e)),b()},{passive:!1});let k=0,C=o;g.addEventListener('touchstart',t=>{2===t.touches.length&&(t.preventDefault(),k=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY),C=o)},{passive:!1}),g.addEventListener('touchmove',t=>{if(2===t.touches.length){t.preventDefault();const e=Math.hypot(t.touches[1].clientX-t.touches[0].clientX,t.touches[1].clientY-t.touches[0].clientY);if(k>0){const t=e/k;o=Math.max(100,Math.min(300,C*t)),b()}}},{passive:!1}),g.addEventListener('touchend',t=>{t.touches.length<2&&(k=0,C=o)}),d.find('.acu-crop-file-input').on('change',async function(a){const n=a.target.files[0];if(n)if(n.type.startsWith('image/'))if(n.size>5242880)window.toastr&&window.toastr.warning('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');else{try{if(await ft.saveLocalAvatar(e,n)){const a=await ct.get(e);t=a,o=150,i=50,s=50,p.css('background-image',`url('${a}')`),b()}}catch(t){console.error('[DICE]ACU é‡æ–°ä¸Šä¼ å¤±è´¥:',t),window.toastr&&window.toastr.error('ä¸Šä¼ å¤±è´¥')}$(this).val('')}else window.toastr&&window.toastr.warning('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶')}),d.find('.acu-crop-close, .acu-crop-cancel').on('click',()=>{d.remove()}),d.find('.acu-crop-confirm').on('click',()=>{a({scale:o,offsetX:i,offsetY:s}),d.remove()}),c(d,'acu-crop-modal-overlay',()=>{d.remove()})},pa=(t,e)=>{try{const{$}=$e();$('.acu-avatar-manager-overlay').remove();const a=ma(),n=ft.getAll(),o=t=>{if(!t)return t;const e=ut(),a=dt(),n=['<user>','{{user}}'].some(e=>t===e||t.toLowerCase()===e.toLowerCase()),o=a&&t===a,i=(()=>{if(!e)return!1;if(t===e)return!0;return ft.getPrimaryName(t)===e})();return n||o||i?'{{user}}':ft.getPrimaryName(t)},i=async()=>{let e='';const a=t.find(t=>'{{user}}'===o(t.name)),i=t.filter(t=>'{{user}}'!==o(t.name));if(a){const t={...a,name:'{{user}}'},o=n[t.name]||{};let i=o.url||'';const c=await ft.hasLocalAvatar(t.name);let s='',l='';c?(s=await ct.get(t.name),l='<span class="acu-avatar-source acu-source-local">æœ¬åœ°</span>'):i&&(s=i,l='<span class="acu-avatar-source acu-source-url">URL</span>');const u=(o.aliases||[]).join(', '),d=!!s;e+=`\n                    <div class="acu-avatar-item" data-name="${r(t.name)}" data-has-local="${c}" data-display-url="${r(s)}">\n                        <div class="acu-avatar-preview-wrap">\n                            <div class="acu-avatar-preview ${d?'has-image':''}" data-avatar-url="${r(s)}" data-avatar-x="${o.offsetX??50}" data-avatar-y="${o.offsetY??50}" data-avatar-scale="${o.scale??150}">\n                                ${d?'':`<span>${r(t.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                            </div>\n                            ${l}\n                        </div>\n                        <div class="acu-avatar-info">\n                            <div class="acu-avatar-name-row">\n                                <div class="acu-avatar-name">${r(t.name)}</div>\n                                <div class="acu-avatar-actions">\n                                    <button class="acu-avatar-save-btn" title="ä¿å­˜"><i class="fa-solid fa-check"></i></button>\n                                    <button class="acu-avatar-clear-btn" title="æ¸…é™¤"><i class="fa-solid fa-trash"></i></button>\n                                </div>\n                            </div>\n                            <input type="text" class="acu-avatar-url" placeholder="ç²˜è´´URL..." value="${r(i)}" />\n                            <input type="text" class="acu-avatar-aliases" placeholder="åˆ«åï¼ˆé€—å·åˆ†éš”ï¼‰..." value="${r(u)}" title="ä¾‹å¦‚: ç¦, ç¦å¤´" />\n                            <input type="file" accept="image/*" class="acu-avatar-file-input" />\n                        </div>\n                    </div>\n                `}for(const t of i){const a=n[t.name]||{};let o=a.url||'';const i=await ft.hasLocalAvatar(t.name);let c='',s='';i?(c=await ct.get(t.name),s='<span class="acu-avatar-source acu-source-local">æœ¬åœ°</span>'):o&&(c=o,s='<span class="acu-avatar-source acu-source-url">URL</span>');const l=(a.aliases||[]).join(', '),u=!!c;e+=`\n                    <div class="acu-avatar-item" data-name="${r(t.name)}" data-has-local="${i}" data-display-url="${r(c)}">\n                        <div class="acu-avatar-preview-wrap">\n                            <div class="acu-avatar-preview ${u?'has-image':''}" data-avatar-url="${r(c)}" data-avatar-x="${a.offsetX??50}" data-avatar-y="${a.offsetY??50}" data-avatar-scale="${a.scale??150}">\n                                ${u?'':`<span>${r(t.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                            </div>\n                            ${s}\n                        </div>\n                        <div class="acu-avatar-info">\n                            <div class="acu-avatar-name-row">\n                                <div class="acu-avatar-name">${r(t.name)}</div>\n                                <div class="acu-avatar-actions">\n                                    <button class="acu-avatar-save-btn" title="ä¿å­˜"><i class="fa-solid fa-check"></i></button>\n                                    <button class="acu-avatar-clear-btn" title="æ¸…é™¤"><i class="fa-solid fa-trash"></i></button>\n                                </div>\n                            </div>\n                            <input type="text" class="acu-avatar-url" placeholder="ç²˜è´´URL..." value="${r(o)}" />\n                            <input type="text" class="acu-avatar-aliases" placeholder="åˆ«åï¼ˆé€—å·åˆ†éš”ï¼‰..." value="${r(l)}" title="ä¾‹å¦‚: ç¦, ç¦å¤´" />\n                            <input type="file" accept="image/*" class="acu-avatar-file-input" />\n                        </div>\n                    </div>\n                `}return e},s=t=>{t.find('.acu-avatar-preview').each(function(){const t=$(this),e=t.attr('data-avatar-url');if(!e)return;const a=Number(t.attr('data-avatar-x')||50),n=Number(t.attr('data-avatar-y')||50),o=Number(t.attr('data-avatar-scale')||150);t.css({'--acu-avatar-image':`url('${e}')`,'--acu-avatar-x':`${a}%`,'--acu-avatar-y':`${n}%`,'--acu-avatar-scale':`${o}%`})})},l=`\n            <div class="acu-avatar-manager-overlay acu-theme-${a.theme}">\n                <div class="acu-avatar-manager">\n                    <div class="acu-panel-header">\n                        <div class="acu-avatar-title"><i class="fa-solid fa-user-circle"></i> å¤´åƒç®¡ç†</div>\n                        <div class="acu-avatar-header-actions">\n                            <button class="acu-avatar-import-btn" title="å¯¼å…¥"><i class="fa-solid fa-file-import"></i></button>\n                            <button class="acu-avatar-export-btn" title="å¯¼å‡º"><i class="fa-solid fa-file-export"></i></button>\n                            <button class="acu-avatar-close"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-avatar-list" id="acu-avatar-list-container">\n                        <div class="acu-import-empty">\n                            <i class="fa-solid fa-spinner fa-spin"></i> åŠ è½½ä¸­...\n                        </div>\n                    </div>\n                </div>\n                <input type="file" id="acu-avatar-file-input" accept=".json" />\n            </div>\n        `,u=$(l);$('body').append(u),i().then(t=>{u.find('#acu-avatar-list-container').html(t),s(u),p()});const d=async t=>{const e=u.find(`.acu-avatar-item[data-name="${t}"]`);if(!e.length)return;const a=ft.getAll()[t]||{},n=await ft.hasLocalAvatar(t);let o='',i='';n?(o=await ct.get(t),i='<span class="acu-avatar-source acu-source-local">æœ¬åœ°</span>'):a.url&&(o=a.url,i='<span class="acu-avatar-source acu-source-url">URL</span>');const c=e.find('.acu-avatar-preview');e.find('.acu-avatar-source').remove(),o?(c.addClass('has-image').attr('data-avatar-url',o).attr('data-avatar-x',a.offsetX??50).attr('data-avatar-y',a.offsetY??50).attr('data-avatar-scale',a.scale??150).css({'--acu-avatar-image':`url('${o}')`,'--acu-avatar-x':`${a.offsetX??50}%`,'--acu-avatar-y':`${a.offsetY??50}%`,'--acu-avatar-scale':`${a.scale??150}%`}).find('span').remove(),e.find('.acu-avatar-preview-wrap').append(i)):c.removeClass('has-image').attr('data-avatar-url','').attr('data-avatar-x',50).attr('data-avatar-y',50).attr('data-avatar-scale',150).css({'--acu-avatar-image':'','--acu-avatar-x':'','--acu-avatar-y':'','--acu-avatar-scale':''}).html(`<span>${r(t.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`),e.attr('data-has-local',n),e.attr('data-display-url',o)},p=()=>{u.on('click','.acu-avatar-preview',async function(t){t.stopPropagation();const a=$(this).closest('.acu-avatar-item'),n=a.data('name'),o=a.attr('data-display-url');o?da(o,n,async t=>{const a=ft.getAll()[n]||{};ft.set(n,a.url||'',t.offsetX,t.offsetY,t.scale,a.aliases||[]),await d(n),e&&e()}):a.find('.acu-avatar-file-input').click()}),u.on('change','.acu-avatar-file-input',async function(t){const a=t.target.files[0];if(!a)return;if(!a.type.startsWith('image/'))return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶'));if(a.size>5242880)return void(window.toastr&&window.toastr.warning('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB'));const n=$(this).closest('.acu-avatar-item').data('name');try{if(await ft.saveLocalAvatar(n,a)){const t=await ct.get(n);await d(n),da(t,n,async t=>{const a=ft.getAll()[n]||{};ft.set(n,a.url||'',t.offsetX,t.offsetY,t.scale,a.aliases||[]),await d(n),e&&e()})}}catch(t){console.error('[DICE]ACU ä¸Šä¼ å¤´åƒå¤±è´¥:',t),window.toastr&&window.toastr.error('ä¸Šä¼ å¤±è´¥')}$(this).val('')}),u.on('click','.acu-avatar-save-btn',async function(){const t=$(this).closest('.acu-avatar-item'),a=t.data('name'),n=t.find('.acu-avatar-url').val().trim(),o=t.find('.acu-avatar-aliases').val().trim(),i=o?o.split(/[,ï¼Œ]/).map(t=>t.trim()).filter(t=>t&&t!==a):[],r=ft.getAll()[a]||{};ft.set(a,n,r.offsetX??50,r.offsetY??50,r.scale??150,i);const c='true'===t.attr('data-has-local');n&&!c?(await d(a),da(n,a,async t=>{ft.set(a,n,t.offsetX,t.offsetY,t.scale,i),await d(a),e&&e()})):(await d(a),e&&e())}),u.on('click','.acu-avatar-clear-btn',async function(){const t=$(this).closest('.acu-avatar-item'),a=t.data('name');await ft.deleteLocalAvatar(a),ft.remove(a),t.find('.acu-avatar-url').val(''),t.find('.acu-avatar-aliases').val(''),await d(a),e&&e()}),u.on('click','.acu-avatar-export-btn',function(){const t=ft.exportData(),e=JSON.stringify(t,null,2),a=new Blob([e],{type:'application/json'}),n=URL.createObjectURL(a),o=document.createElement('a');o.href=n,o.download=`avatar-config-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}),u.on('click','.acu-avatar-import-btn',function(){u.find('#acu-avatar-file-input').click()}),u.on('change','#acu-avatar-file-input',function(a){const n=a.target.files[0];if(!n)return;const o=new FileReader;o.onload=function(a){try{const n=JSON.parse(a.target.result),o=ft.analyzeImport(n);if(!o.valid)return void(window.toastr&&window.toastr.error(o.error));ga(n,o,()=>{u.remove(),pa(t,e),e&&e()})}catch(t){console.error('[DICE]ACU å¯¼å…¥è§£æå¤±è´¥:',t),window.toastr&&window.toastr.error('æ–‡ä»¶è§£æå¤±è´¥')}},o.readAsText(n),$(this).val('')})},g=()=>u.remove();u.on('click','.acu-avatar-close',g),c(u,'acu-avatar-manager-overlay',g)}catch(t){if(console.error('å¤´åƒç®¡ç†å™¨é”™è¯¯:',t),window.toastr){const e=t instanceof Error?t.message:'æœªçŸ¥é”™è¯¯';window.toastr.error(`å¤´åƒç®¡ç†å™¨åŠ è½½å¤±è´¥: ${e}`)}$('.acu-avatar-manager-overlay').remove()}},ga=(t,e,a)=>{const{$}=$e();$('.acu-import-confirm-overlay').remove();const n=ma(),o=e.conflicts.length>0,i=e.conflicts.length>0?`<div style="max-height:80px;overflow-y:auto;background:rgba(0,0,0,0.1);border-radius:4px;padding:6px 8px;margin-top:6px;font-size:11px;color:var(--acu-text-sub);">${e.conflicts.map(t=>r(t)).join(', ')}</div>`:'',s=$(`\n            <div class="acu-import-confirm-overlay acu-theme-${n.theme}">\n                <div class="acu-import-confirm-dialog">\n                    <div class="acu-import-confirm-header">\n                        <i class="fa-solid fa-file-import"></i> å¯¼å…¥å¤´åƒé…ç½®\n                    </div>\n                    <div class="acu-import-confirm-body">\n                        <div class="acu-import-stats">\n                            <div class="acu-import-stat">\n                                <span class="acu-stat-num">${e.total}</span>\n                                <span class="acu-stat-label">æ€»è®¡</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-new">\n                                <span class="acu-stat-num">${e.newItems.length}</span>\n                                <span class="acu-stat-label">æ–°å¢</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-conflict">\n                                <span class="acu-stat-num">${e.conflicts.length}</span>\n                                <span class="acu-stat-label">å†²çª</span>\n                            </div>\n                        </div>\n\n                        ${o?`\n                            <div class="acu-import-conflict-section">\n                                <div class="acu-import-warning">\n                                    <i class="fa-solid fa-exclamation-triangle"></i> ä»¥ä¸‹è§’è‰²å·²å­˜åœ¨ï¼š\n                                </div>\n                                ${i}\n                                <div class="acu-import-conflict-options">\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="overwrite" checked />\n                                        <span>ç”¨å¯¼å…¥çš„è¦†ç›–æœ¬åœ°</span>\n                                    </label>\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="skip" />\n                                        <span>ä¿ç•™æœ¬åœ°çš„ä¸å˜</span>\n                                    </label>\n                                </div>\n                            </div>\n                        `:'\n                            <div class="acu-import-success">\n                                <i class="fa-solid fa-check-circle"></i> æ— å†²çªï¼Œå¯ç›´æ¥å¯¼å…¥\n                            </div>\n                        '}\n                    </div>\n                    <div class="acu-import-confirm-footer">\n                        <button class="acu-import-cancel-btn">å–æ¶ˆ</button>\n                        <button class="acu-import-confirm-btn">ç¡®è®¤å¯¼å…¥</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(s);s[0].style.cssText='\n            position: fixed !important;\n            top: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            bottom: 0 !important;\n            width: 100vw !important;\n            height: 100vh !important;\n            background: rgba(0,0,0,0.6) !important;\n            z-index: 31300 !important;\n            display: flex;\n            justify-content: center !important;\n            align-items: center !important;\n            padding: 16px;\n            box-sizing: border-box !important;\n        ';const l=()=>s.remove();s.find('.acu-import-cancel-btn').click(l),c(s,'acu-import-confirm-overlay',l),s.find('.acu-import-confirm-btn').click(function(){const e='skip'!==s.find('input[name="conflict-mode"]:checked').val();try{ft.importData(t,e);l(),a&&a()}catch(t){console.error('[DICE]ACU å¯¼å…¥å¤±è´¥:',t),window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥ï¼š'+t.message)}})},fa=(t,e,a,n,o)=>{const{$}=$e(),i=ma();let s=ie||wa()||Ne(),l=t;s&&s[o]&&s[o]?.content?.[n+1]&&(l=s[o]?.content?.[n+1]);const u=l.map((t,a)=>{if(0===a)return'';const n=e[a]||`åˆ— ${a}`,o=t||'';return`\n                <div class="acu-card-edit-field">\n                    <label class="acu-card-edit-label">${r(n)}</label>\n                    <textarea class="acu-card-edit-input acu-card-edit-textarea" data-col="${a}" spellcheck="false" rows="1">${r(o)}</textarea>\n                </div>`}).join(''),d=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${i.theme}">\n                    <div class="acu-edit-title">æ•´ä½“ç¼–è¾‘ (#${n+1} - ${r(a)})</div>\n                    <div class="acu-settings-content acu-settings-content-scroll">\n                        ${u}\n                    </div>\n                     <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-card-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-card-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(d);const p=t=>{t.style.height='auto';const e=t.scrollHeight+2;t.style.height=Math.min(e,500)+'px',t.style.overflowY=e>500?'auto':'hidden'};requestAnimationFrame(()=>{d.find('textarea').each(function(){p(this)})}),d.find('textarea').on('input',function(){p(this)});const g=()=>d.remove();d.find('#dlg-card-cancel').click(g),d.find('#dlg-card-save').click(async()=>{let t=ie||wa()||Ne();if(t&&t[o]){const e=t[o]?.content?.[n+1];if(!e)return void g();let a=!1;if(d.find('textarea').each(function(){const t=parseInt($(this).data('col')),n=$(this).val();String(e[t])!==String(n)&&(a=!0,e[t]=n)}),a)try{await _a(o,n,[...e]),nn()}catch(t){return void console.error('[DICE]ACU ä¿å­˜å¤±è´¥:',t)}}g()}),c(d,'acu-edit-overlay',g),d.on('click',function(t){$(t.target).closest('#dlg-close-x, #dlg-close, .acu-close-btn').length&&g()})};let ba=null;const ma=()=>(ba||(ba={...xe,...Ae.get(f,{})}),ba),va=t=>{ba={...ma(),...t},Ae.set(f,ba);const e=xa(ba);o(ba.theme,e)},ha=t=>{const e=Ne(),a=new Set;if(!e)return a;for(const n in t){const o=t[n],i=e[n];if(!o||!o.name)continue;const r=o.name;if(!i){o.content&&o.content.forEach((t,e)=>{e>0&&a.add(`${r}-row-${e-1}`)});continue}const c=o.content||[],s=i.content||[],l=new Map;s.forEach((t,e)=>{if(0===e)return;const a=String(t[1]??'').trim();a&&(l.has(a)||l.set(a,[]),l.get(a).push({index:e,row:t}))});const u=new Set;c.forEach((t,e)=>{if(0===e)return;const n=String(t[1]??'').trim();let o=null;if(n&&l.has(n)){const t=l.get(n);if(t.length>0){const e=t.shift();o=e.row,u.add(e.index),0===t.length&&l.delete(n)}}if(!o&&!n){const t=s[e];t&&!u.has(e)&&(o=t,u.add(e))}o?t.forEach((t,n)=>{if(0===n)return;const i=o[n];String(t??'')!==String(i??'')&&a.add(`${r}-${e-1}-${n}`)}):a.add(`${r}-row-${e-1}`)})}return a},xa=t=>{const{$}=$e(),e=$('.acu-wrapper'),a=ye.find(e=>e.id===t.fontFamily)?.val||ye[0].val,n=$('#acu-dynamic-font');if(n.data('font-id')!==t.fontFamily){n.remove();const e='\n                @import url("https://fontsapi.zeoseven.com/3/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/442/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/256/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/482/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/446/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/570/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/292/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/69/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/7/main/result.css");\n            ';$('head').append(`\n                <style id="acu-dynamic-font" data-font-id="${t.fontFamily}">\n                    ${e}\n                    .acu-wrapper, .acu-edit-dialog, .acu-cell-menu, .acu-nav-container, .acu-data-card, .acu-panel-title, .acu-settings-label, .acu-btn-block, .acu-nav-btn, .acu-edit-textarea,\n                    .acu-dice-panel, .acu-contest-panel, .acu-dice-config-dialog,\n                    .acu-relation-graph-container, .acu-avatar-manager, .acu-import-confirm-dialog,\n                    .acu-embedded-options-container, .acu-option-panel, .acu-opt-btn {\n                        font-family: ${a} !important;\n                    }\n                </style>\n            `)}const o={'--acu-card-width':`${t.cardWidth}px`,'--acu-font-size':`${t.fontSize}px`,'--acu-opt-font-size':`${t.optionFontSize||12}px`,'--acu-grid-cols':t.gridColumns};e.length&&(e.removeClass((t,e)=>(e.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),e.addClass(`acu-theme-${t.theme}`),e.css(o));const i=$('.acu-embedded-options-container');return i.length&&(i.removeClass((t,e)=>(e.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),i.addClass(`acu-theme-${t.theme}`),i.css(o)),a},ya=()=>{if(window._acuStylesInjected&&$(`#${t}-styles`).length)return;window._acuStylesInjected=!0;const{$}=$e();$('style').each(function(){this.id&&this.id.startsWith('acu_')&&this.id.endsWith('-styles')&&this.id!==`${t}-styles`&&$(this).remove()}),$(`#${t}-styles`).remove();const e=`<style id="${t}-styles">\n    /* ========== æ ¸å¿ƒéš”ç¦»å±‚ ========== */\n    .acu-wrapper,\n    .acu-wrapper *:not(i[class*="fa-"]),\n    .acu-edit-overlay,\n    .acu-edit-overlay *:not(i[class*="fa-"]),\n    .acu-cell-menu,\n    .acu-cell-menu *:not(i[class*="fa-"]),\n    .acu-dice-panel,\n    .acu-dice-panel *:not(i[class*="fa-"]),\n    .acu-contest-panel,\n    .acu-contest-panel *:not(i[class*="fa-"]),\n    .acu-relation-graph-overlay,\n    .acu-relation-graph-overlay *:not(i[class*="fa-"]),\n    .acu-avatar-manager-overlay,\n    .acu-avatar-manager-overlay *:not(i[class*="fa-"]),\n    .acu-preview-overlay,\n    .acu-preview-overlay *:not(i[class*="fa-"]),\n    .acu-import-confirm-overlay,\n    .acu-import-confirm-overlay *:not(i[class*="fa-"]),\n    .acu-embedded-options-container,\n    .acu-embedded-options-container *:not(i[class*="fa-"]) {\n        box-sizing: border-box;\n        -webkit-tap-highlight-color: transparent;\n        -webkit-font-smoothing: antialiased;\n    }\n    /* ========== åŸºç¡€æ ·å¼ ========== */\n    .acu-wrapper,\n    .acu-edit-overlay,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-embedded-options-container,\n    .acu-cell-menu {\n        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;\n        font-size: 13px;\n        line-height: 1.5;\n        color: var(--acu-text-main);\n    }\n    /* æŠ•éª°é¢æ¿ç»Ÿä¸€æ ·å¼ (éœ€è¦ !important è¦†ç›– SillyTavern å…¨å±€æ ·å¼å’Œå†…è”æ ·å¼) */\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    .acu-dice-panel input[type="text"],\n    .acu-dice-panel input[type="number"],\n    .acu-dice-panel input:not([type]),\n    .acu-dice-panel select,\n    .acu-contest-panel input[type="text"],\n    .acu-contest-panel input[type="number"],\n    .acu-contest-panel input:not([type]),\n    .acu-contest-panel select,\n    .acu-dice-config-dialog input[type="text"],\n    .acu-dice-config-dialog input[type="number"],\n    .acu-dice-config-dialog input:not([type]),\n    .acu-dice-config-dialog select {\n        width: 100%;\n        text-align: center;\n        padding: 6px;\n        background: var(--acu-input-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 4px;\n        color: var(--acu-text-main) !important;\n        font-size: 12px;\n    }\n    /* éšè—numberç±»å‹è¾“å…¥æ¡†çš„æ­¥æ•°å™¨ */\n    .acu-dice-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-outer-spin-button {\n        -webkit-appearance: none;\n        margin: 0;\n    }\n    .acu-dice-panel input[type="number"],\n    .acu-contest-panel input[type="number"],\n    .acu-dice-config-dialog input[type="number"] {\n        -moz-appearance: textfield;\n        text-align: center;\n        box-sizing: border-box;\n    }\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-dice-config-dialog input::placeholder {\n        color: var(--acu-text-sub) !important;\n        opacity: 0.7;\n        text-align: center;\n    }\n    .acu-dice-input {\n        text-align: center;\n    }\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-dice-config-dialog input:focus,\n    .acu-dice-config-dialog select:focus {\n        outline: none;\n        border-color: var(--acu-accent) !important;\n    }\n    .acu-dice-panel select option,\n    .acu-contest-panel select option,\n    .acu-dice-config-dialog select option {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    /* æŠ•éª°é¢æ¿ä¸‹æ‹‰æ¡†ç»Ÿä¸€æ ·å¼ */\n    .acu-dice-select {\n        width: 100%;\n        padding: 4px 4px;\n        background: var(--acu-input-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 4px;\n        color: var(--acu-text-main) !important;\n        font-size: 10px;\n        line-height: 1.2;\n        min-height: 24px;\n        box-sizing: border-box;\n        cursor: pointer;\n        -webkit-appearance: none;\n        text-align: center;\n        appearance: none;\n    }\n    .acu-dice-select:focus {\n        outline: none;\n        border-color: var(--acu-accent) !important;\n    }\n    .acu-dice-select option {\n        background: var(--acu-bg-panel) !important;\n        color: var(--acu-text-main) !important;\n    }\n    /* æœç´¢æ¡†æ ·å¼ */\n    .acu-wrapper .acu-search-input {\n        background-color: var(--acu-input-bg) !important;\n        color: var(--acu-text-main) !important;\n        border: 1px solid var(--acu-border);\n    }\n    .acu-wrapper .acu-search-input:focus {\n        outline: none;\n        border-color: var(--acu-accent);\n        box-shadow: none !important;\n    }\n    .acu-wrapper .acu-search-input::placeholder {\n        color: var(--acu-text-sub) !important;\n        opacity: 0.7;\n    }\n    /* ========== é€šç”¨ç»„ä»¶åŸºç±» ========== */\n    /* æŒ‰é’®åŸºç±» */\n    .acu-wrapper button,\n    .acu-edit-overlay button,\n    .acu-dice-panel button,\n    .acu-contest-panel button,\n    .acu-relation-graph-overlay button,\n    .acu-avatar-manager-overlay button,\n    .acu-preview-overlay button,\n    .acu-embedded-options-container button:not(.acu-opt-btn) {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        cursor: pointer;\n        border: 1px solid var(--acu-border);\n        border-radius: 6px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        transition: all 0.2s ease;\n        outline: none;\n    }\n    .acu-wrapper button:hover,\n    .acu-edit-overlay button:hover,\n    .acu-dice-panel button:hover,\n    .acu-contest-panel button:hover,\n    .acu-relation-graph-overlay button:hover,\n    .acu-avatar-manager-overlay button:hover,\n    .acu-preview-overlay button:hover,\n    .acu-embedded-options-container button:not(.acu-opt-btn):hover {\n        background: var(--acu-btn-hover);\n    }\n    .acu-wrapper button:focus,\n    .acu-edit-overlay button:focus,\n    .acu-dice-panel button:focus,\n    .acu-contest-panel button:focus,\n    .acu-relation-graph-overlay button:focus,\n    .acu-avatar-manager-overlay button:focus,\n    .acu-preview-overlay button:focus,\n    .acu-embedded-options-container button:not(.acu-opt-btn):focus {\n        outline: none;\n        box-shadow: none;\n    }\n\n    /* è¾“å…¥æ¡†åŸºç±» */\n    .acu-wrapper input,\n    .acu-wrapper textarea,\n    .acu-wrapper select,\n    .acu-edit-overlay input,\n    .acu-edit-overlay textarea,\n    .acu-edit-overlay select,\n    .acu-dice-panel input,\n    .acu-dice-panel select,\n    .acu-contest-panel input,\n    .acu-contest-panel select,\n    .acu-avatar-manager-overlay input {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        border: 1px solid var(--acu-border);\n        border-radius: 4px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        outline: none;\n        transition: border-color 0.2s;\n    }\n    .acu-wrapper input:focus,\n    .acu-wrapper textarea:focus,\n    .acu-wrapper select:focus,\n    .acu-edit-overlay input:focus,\n    .acu-edit-overlay textarea:focus,\n    .acu-edit-overlay select:focus,\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-avatar-manager-overlay input:focus {\n        border-color: var(--acu-accent);\n        box-shadow: none;\n        outline: none;\n    }\n    .acu-wrapper input::placeholder,\n    .acu-wrapper textarea::placeholder,\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-avatar-manager-overlay input::placeholder {\n        color: var(--acu-text-sub);\n        opacity: 0.7;\n    }\n\n    /* å¼¹çª—é®ç½©å±‚åŸºç±» */\n    .acu-edit-overlay,\n    .acu-dice-overlay,\n    .acu-contest-overlay,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-dice-config-overlay,\n    .acu-crop-modal-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0,0,0,0.6);\n        z-index: 31010;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 16px;\n        backdrop-filter: blur(2px);\n    }\n\n    /* å¼¹çª—å®¹å™¨åŸºç±» */\n    .acu-edit-dialog,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-container,\n    .acu-avatar-manager,\n    .acu-import-confirm-dialog,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        border: 1px solid var(--acu-border);\n        border-radius: 12px;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.4);\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n    }\n\n    /* ========== éª°å­é¢æ¿ä¸“ç”¨æ ·å¼ ========== */\n    .acu-dice-panel,\n    .acu-contest-panel {\n        position: relative;\n        z-index: 31011;\n        width: 340px;\n        max-width: calc(100vw - 32px);\n        max-height: calc(100vh - 32px);\n        max-height: calc(100dvh - 32px);\n    }\n    .acu-dice-panel-header {\n        padding: 12px 15px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n    }\n    .acu-dice-panel-title {\n        font-size: 15px;\n        font-weight: bold;\n        color: var(--acu-accent);\n        display: flex;\n        align-items: center;\n        gap: 8px;\n    }\n    .acu-dice-panel-actions {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n    }\n    .acu-dice-panel-actions button {\n        background: none;\n        border: none;\n        color: var(--acu-text-sub);\n        cursor: pointer;\n        font-size: 14px;\n        padding: 4px;\n        transition: all 0.2s;\n    }\n    .acu-dice-panel-actions button:hover {\n        color: var(--acu-accent);\n    }\n    .acu-dice-panel-body {\n        padding: 15px;\n        flex: 1;\n        min-height: 0;\n        overflow-y: auto;\n        overscroll-behavior: contain;\n        -webkit-overflow-scrolling: touch;\n    }\n    .acu-dice-presets {\n        display: flex;\n        gap: 6px;\n        flex-wrap: wrap;\n        margin-bottom: 12px;\n        align-items: center;\n    }\n    .acu-dice-preset {\n        padding: 4px 10px;\n        background: var(--acu-btn-bg);\n        border: 1px solid var(--acu-border);\n        border-radius: 4px;\n        color: var(--acu-text-main);\n        font-size: 11px;\n        cursor: pointer;\n        transition: all 0.2s;\n    }\n    .acu-dice-preset:hover {\n        background: var(--acu-btn-hover);\n    }\n    .acu-dice-preset.active {\n        background: var(--acu-accent);\n        color: var(--acu-button-text-on-accent, #fff);\n        border-color: var(--acu-accent);\n    }\n    .acu-dice-preset.active:hover {\n        background: var(--acu-accent);\n        color: var(--acu-button-text-on-accent, #fff);\n        filter: brightness(1.1);\n    }\n    .acu-dice-form-row {\n        display: grid;\n        gap: 6px;\n        margin-bottom: 6px;\n    }\n    .acu-dice-form-row.cols-2 { grid-template-columns: 1fr 1fr; }\n    .acu-dice-form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }\n    .acu-dice-form-label {\n        font-size: 10px;\n        color: var(--acu-text-sub);\n        margin-bottom: 2px;\n        min-height: 18px;\n        display: flex;\n        align-items: center;\n    }\n    .acu-dice-form-label.center { justify-content: center; }\n    /* Section Title (Party A/B, Quick Select) */\n    .acu-dice-section-title {\n        display: flex;\n        align-items: flex-start;\n        justify-content: space-between;\n        flex-wrap: wrap;\n        margin-bottom: 6px;\n        min-height: 24px;\n    }\n    .acu-dice-section-title > span {\n        font-size: 12px;\n        font-weight: bold;\n        color: var(--acu-accent);\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        white-space: nowrap;\n    }\n    .acu-dice-quick-section {\n        margin-bottom: 10px;\n    }\n    .acu-dice-quick-title {\n        font-size: 10px;\n        color: var(--acu-text-sub);\n        font-weight: bold;\n        margin-bottom: 4px;\n        display: flex;\n        align-items: center;\n        gap: 6px;\n    }\n    .acu-dice-quick-buttons {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 4px;\n        max-height: 60px;\n        overflow-y: auto;\n    }\n    .acu-dice-quick-inline {\n        display: flex;\n        gap: 4px;\n        margin-left: 0;\n        margin-top: 4px;\n        flex: 1 1 100%;\n        align-content: flex-start;\n        min-width: 0;\n        max-width: 100%;\n        max-height: 84px;\n        overflow-x: hidden;\n        overflow-y: auto;\n        white-space: normal;\n        align-items: flex-start;\n        flex-wrap: wrap;\n        -webkit-overflow-scrolling: touch;\n    }\n    .acu-dice-quick-inline::-webkit-scrollbar { width: 6px; }\n    .acu-dice-quick-compact {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 3px;\n        margin-bottom: 8px;\n        max-height: 84px;\n        overflow-y: auto;\n        align-content: flex-start;\n    }\n    .acu-dice-panel .acu-dice-char-btn,\n    .acu-contest-panel .acu-dice-char-btn,\n    .acu-dice-panel .acu-dice-attr-btn,\n    .acu-contest-panel .acu-dice-attr-btn,\n    .acu-dice-panel .acu-dice-gen-attr-btn,\n    .acu-dice-panel .acu-dice-clear-attr-btn,\n    .acu-contest-panel .acu-contest-attr-btn,\n    .acu-contest-panel .acu-contest-gen-attr-btn,\n    .acu-contest-panel .acu-contest-clear-attr-btn {\n        padding: 1px 5px;\n        background: var(--acu-btn-bg);\n        border: 1px solid var(--acu-border);\n        border-radius: 4px;\n        color: var(--acu-text-main);\n        font-size: 10px;\n        cursor: pointer;\n        transition: all 0.2s;\n        white-space: nowrap;\n        flex-shrink: 0;\n        line-height: 1.3;\n    }\n    .acu-dice-panel .acu-dice-char-btn:hover,\n    .acu-contest-panel .acu-dice-char-btn:hover,\n    .acu-dice-panel .acu-dice-attr-btn:hover,\n    .acu-contest-panel .acu-dice-attr-btn:hover,\n    .acu-dice-panel .acu-dice-gen-attr-btn:hover,\n    .acu-dice-panel .acu-dice-clear-attr-btn:hover,\n    .acu-contest-panel .acu-contest-attr-btn:hover,\n    .acu-contest-panel .acu-contest-gen-attr-btn:hover,\n    .acu-contest-panel .acu-contest-clear-attr-btn:hover {\n        background: var(--acu-btn-hover);\n    }\n    .acu-dice-panel .acu-dice-char-btn.active,\n    .acu-contest-panel .acu-dice-char-btn.active,\n    .acu-dice-panel .acu-dice-attr-btn.active,\n    .acu-contest-panel .acu-dice-attr-btn.active {\n        background: var(--acu-accent);\n        color: var(--acu-button-text-on-accent, #fff);\n        border-color: var(--acu-accent);\n    }\n    .acu-dice-roll-btn {\n        width: 100%;\n        padding: 12px;\n        background: var(--acu-accent);\n        border: none;\n        border-radius: 8px;\n        color: var(--acu-button-text, #fff);\n        font-size: 15px;\n        font-weight: bold;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 8px;\n        transition: all 0.2s;\n    }\n    .acu-dice-roll-btn:hover {\n        filter: brightness(1.1);\n    }\n    .acu-random-skill-btn {\n        width: 18px;\n        height: 18px;\n        padding: 0;\n        background: transparent;\n        border: 1px dashed var(--acu-accent);\n        border-radius: 4px;\n        color: var(--acu-accent);\n        font-size: 9px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        transition: all 0.2s;\n    }\n    .acu-random-skill-btn:hover {\n        background: var(--acu-accent);\n        color: var(--acu-button-text-on-accent, #fff);\n    }\n\n    /* å¼¹çª—å¤´éƒ¨åŸºç±» - ç»Ÿä¸€ä½¿ç”¨ .acu-panel-header */\n    .acu-panel-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 15px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        flex-shrink: 0;\n    }\n\n    /* å…³é—­æŒ‰é’®åŸºç±» - æ‰€æœ‰å…³é—­æŒ‰é’®ç»Ÿä¸€ä½¿ç”¨ .acu-close-btn */\n    .acu-close-btn {\n        background: none;\n        border: none;\n        color: var(--acu-text-sub);\n        cursor: pointer;\n        font-size: 16px;\n        padding: 4px;\n        border-radius: 4px;\n        transition: all 0.2s;\n    }\n    .acu-close-btn:hover {\n        background: none;\n        color: var(--acu-accent);\n    }\n\n    /* æ»šåŠ¨æ¡å…¨å±€éšè— */\n    [class^="acu-"], [class^="acu-"] * { scrollbar-width: none; -ms-overflow-style: none; }\n    [class^="acu-"] *::-webkit-scrollbar { display: none !important; }\n\n    /* ========== ä¸»é¢˜å˜é‡å®šä¹‰ ========== */\n    .acu-theme-retro { --acu-bg-nav: #e6e2d3; --acu-bg-panel: #e6e2d3; --acu-border: #dcd0c0; --acu-text-main: #5e4b35; --acu-text-sub: #999; --acu-btn-bg: #dcd0c0; --acu-btn-hover: #cbbba8; --acu-btn-active-bg: #8d7b6f; --acu-btn-active-text: #fdfaf5; --acu-accent: #7a695f; --acu-table-head: #efebe4; --acu-table-hover: #f0ebe0; --acu-opt-hover: #f7f3ed; --acu-opt-bg: #fffef9; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #fffef9; --acu-badge-bg: #efebe4; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #27ae60; --acu-success-bg: rgba(39, 174, 96, 0.15); --acu-scrollbar-track: #e6e2d3; --acu-scrollbar-thumb: #cbbba8; --acu-input-bg: #f5f2eb;--acu-hl-manual: #d35400; --acu-hl-manual-bg: rgba(211, 84, 0, 0.15); --acu-hl-diff: #2980b9; --acu-hl-diff-bg: rgba(41, 128, 185, 0.15); --acu-error-text: #e74c3c; --acu-error-bg: rgba(231, 76, 60, 0.15); --acu-error-border: rgba(231, 76, 60, 0.5); --acu-warning-icon: #e67e22; --acu-failure-text: #e74c3c; --acu-failure-bg: rgba(231, 76, 60, 0.15); --acu-warning-text: #f39c12; --acu-warning-bg: rgba(243, 156, 18, 0.15); --acu-crit-success-text: #9b59b6; --acu-crit-success-bg: rgba(155, 89, 182, 0.15); --acu-crit-failure-text: #c0392b; --acu-crit-failure-bg: rgba(192, 57, 43, 0.15); --acu-extreme-success-text: #2980b9; --acu-extreme-success-bg: rgba(41, 128, 185, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #5e4b35; --acu-gray-bg: rgba(128,128,128,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-dark { --acu-bg-nav: #2b2b2b; --acu-bg-panel: #252525; --acu-border: #444; --acu-text-main: #eee; --acu-text-sub: #aaa; --acu-btn-bg: #3a3a3a; --acu-btn-hover: #4a4a4a; --acu-btn-active-bg: #6a5acd; --acu-btn-active-text: #fff; --acu-accent: #9b8cd9; --acu-table-head: #333333; --acu-table-hover: #3a3a3a; --acu-opt-hover: rgba(255, 255, 255, 0.1); --acu-opt-bg: rgba(255, 255, 255, 0.05); --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #2d3035; --acu-badge-bg: #3a3f4b; --acu-menu-bg: #333; --acu-menu-text: #eee; --acu-success-text: #4cd964; --acu-success-bg: rgba(76, 217, 100, 0.2); --acu-scrollbar-track: #2b2b2b; --acu-scrollbar-thumb: #555; --acu-hl-manual: #ff6b81; --acu-hl-manual-bg: rgba(255, 107, 129, 0.2); --acu-hl-diff: #00d2d3; --acu-hl-diff-bg: rgba(0, 210, 211, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-failure-text: #ff6b6b; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-crit-success-text: #ba68c8; --acu-crit-success-bg: rgba(186, 104, 200, 0.2); --acu-crit-failure-text: #d32f2f; --acu-crit-failure-bg: rgba(211, 47, 47, 0.2); --acu-extreme-success-text: #42a5f5; --acu-extreme-success-bg: rgba(66, 165, 245, 0.2); --acu-overlay-bg: rgba(0,0,0,0.75); --acu-overlay-bg-light: rgba(0,0,0,0.65); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255,255,255,0.05); --acu-very-light-bg: rgba(255,255,255,0.02); --acu-button-text: #fff; --acu-gray-bg: rgba(255,255,255,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-modern { --acu-bg-nav: #ffffff; --acu-bg-panel: #f8f9fa; --acu-border: #e0e0e0; --acu-text-main: #333; --acu-text-sub: #666; --acu-btn-bg: #f1f3f5; --acu-btn-hover: #e9ecef; --acu-btn-active-bg: #007bff; --acu-btn-active-text: #fff; --acu-accent: #007bff; --acu-table-head: #f8f9fa; --acu-table-hover: #f1f3f5; --acu-opt-hover: #f1f3f5; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #f1f3f5; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #28a745; --acu-success-bg: rgba(40, 167, 69, 0.15); --acu-scrollbar-track: #fff; --acu-scrollbar-thumb: #ccc; --acu-hl-manual: #fd7e14; --acu-hl-manual-bg: rgba(253, 126, 20, 0.15); --acu-hl-diff: #0d6efd; --acu-hl-diff-bg: rgba(13, 110, 253, 0.15); --acu-error-text: #dc3545; --acu-error-bg: rgba(220, 53, 69, 0.15); --acu-error-border: rgba(220, 53, 69, 0.5); --acu-warning-icon: #fd7e14; --acu-failure-text: #dc3545; --acu-failure-bg: rgba(220, 53, 69, 0.15); --acu-warning-text: #ffc107; --acu-warning-bg: rgba(255, 193, 7, 0.15); --acu-crit-success-text: #6f42c1; --acu-crit-success-bg: rgba(111, 66, 193, 0.15); --acu-crit-failure-text: #c82333; --acu-crit-failure-bg: rgba(200, 35, 51, 0.15); --acu-extreme-success-text: #17a2b8; --acu-extreme-success-bg: rgba(23, 162, 184, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #333; --acu-gray-bg: rgba(128,128,128,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-forest { --acu-bg-nav: #e8f5e9; --acu-bg-panel: #e8f5e9; --acu-border: #c8e6c9; --acu-text-main: #2e7d32; --acu-text-sub: #81c784; --acu-btn-bg: #c8e6c9; --acu-btn-hover: #a5d6a7; --acu-btn-active-bg: #43a047; --acu-btn-active-text: #fff; --acu-accent: #4caf50; --acu-table-head: #dcedc8; --acu-table-hover: #f1f8e9; --acu-opt-hover: #f1f8e9; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #dcedc8; --acu-menu-bg: #fff; --acu-menu-text: #2e7d32; --acu-success-text: #2e7d32; --acu-success-bg: rgba(46, 125, 50, 0.2); --acu-scrollbar-track: #e8f5e9; --acu-scrollbar-thumb: #a5d6a7; --acu-hl-manual: #e67e22; --acu-hl-manual-bg: rgba(230, 126, 34, 0.15); --acu-hl-diff: #1e8449; --acu-hl-diff-bg: rgba(30, 132, 73, 0.2); --acu-button-text: #2e7d32; --acu-button-text-on-accent: #fff; }\n    .acu-theme-ocean { --acu-bg-nav: #e3f2fd; --acu-bg-panel: #e3f2fd; --acu-border: #90caf9; --acu-text-main: #1565c0; --acu-text-sub: #64b5f6; --acu-btn-bg: #bbdefb; --acu-btn-hover: #90caf9; --acu-btn-active-bg: #1976d2; --acu-btn-active-text: #fff; --acu-accent: #2196f3; --acu-table-head: #bbdefb; --acu-table-hover: #e1f5fe; --acu-opt-hover: #e1f5fe; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #e3f2fd; --acu-menu-bg: #fff; --acu-menu-text: #1565c0; --acu-success-text: #0288d1; --acu-success-bg: rgba(2, 136, 209, 0.15); --acu-scrollbar-track: #e3f2fd; --acu-scrollbar-thumb: #90caf9; --acu-hl-manual: #ff4757; --acu-hl-manual-bg: rgba(255, 71, 87, 0.15); --acu-hl-diff: #0277bd; --acu-hl-diff-bg: rgba(2, 119, 189, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-failure-text: #d32f2f; --acu-failure-bg: rgba(211, 47, 47, 0.15); --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-crit-success-text: #7b1fa2; --acu-crit-success-bg: rgba(123, 31, 162, 0.15); --acu-crit-failure-text: #b71c1c; --acu-crit-failure-bg: rgba(183, 28, 28, 0.15); --acu-extreme-success-text: #0277bd; --acu-extreme-success-bg: rgba(2, 119, 189, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #1565c0; --acu-gray-bg: rgba(128,128,128,0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-cyber { --acu-bg-nav: #000000; --acu-bg-panel: #0a0a0a; --acu-border: #333; --acu-text-main: #00ffcc; --acu-text-sub: #ff00ff; --acu-btn-bg: #111; --acu-btn-hover: #222; --acu-btn-active-bg: #ff00ff; --acu-btn-active-text: #000; --acu-accent: #00ffcc; --acu-table-head: #050505; --acu-table-hover: #111; --acu-opt-hover: rgba(0, 255, 204, 0.15); --acu-opt-bg: rgba(0, 255, 204, 0.08); --acu-shadow: 0 0 15px rgba(0,255,204,0.15); --acu-card-bg: #050505; --acu-badge-bg: #1a1a1a; --acu-menu-bg: #111; --acu-menu-text: #00ffcc; --acu-success-text: #0f0; --acu-success-bg: rgba(0, 255, 0, 0.15); --acu-scrollbar-track: #000; --acu-scrollbar-thumb: #333; --acu-hl-manual: #ff9f43; --acu-hl-manual-bg: rgba(255, 159, 67, 0.2); --acu-hl-diff: #0abde3; --acu-hl-diff-bg: rgba(10, 189, 227, 0.2); --acu-button-text-on-accent: #000; }\n    .acu-theme-cyber .acu-nav-btn { border-color: #222; }\n    .acu-theme-cyber .acu-data-card { border-color: #222; }\n    .acu-theme-cyber .acu-dice-panel input::placeholder,\n    .acu-theme-cyber .acu-contest-panel input::placeholder {\n        color: #ff00ff !important;\n        opacity: 0.7;\n    }\n    .acu-theme-cyber .acu-dice-panel input[type="text"],\n    .acu-theme-cyber .acu-dice-panel input[type="number"],\n    .acu-theme-cyber .acu-dice-panel input:not([type]),\n    .acu-theme-cyber .acu-contest-panel input[type="text"],\n    .acu-theme-cyber .acu-contest-panel input[type="number"],\n    .acu-theme-cyber .acu-contest-panel input:not([type]) {\n        color: #ff00ff !important;\n    }\n    .acu-theme-nightowl { --acu-bg-nav: #0a2133; --acu-bg-panel: #011627; --acu-border: #132e45; --acu-text-main: #e0e6f2; --acu-text-sub: #a6b8cc; --acu-btn-bg: #1f3a52; --acu-btn-hover: #2a4a68; --acu-btn-active-bg: #7fdbca; --acu-btn-active-text: #011627; --acu-accent: #7fdbca; --acu-table-head: #0a2133; --acu-table-hover: #01294a; --acu-opt-hover: rgba(127, 219, 202, 0.15); --acu-opt-bg: rgba(127, 219, 202, 0.08); --acu-shadow: rgba(0,0,0,0.5); --acu-card-bg: #0a2133; --acu-badge-bg: #1f3a52; --acu-menu-bg: #011627; --acu-menu-text: #e0e6f2; --acu-success-text: #addb67; --acu-success-bg: rgba(173, 219, 103, 0.15); --acu-scrollbar-track: #011627; --acu-scrollbar-thumb: #1f3a52; --acu-hl-manual: #ff8f66; --acu-hl-manual-bg: rgba(255, 143, 102, 0.2); --acu-hl-diff: #82aaff; --acu-hl-diff-bg: rgba(130, 170, 255, 0.2); --acu-button-text-on-accent: #011627; }\n    .acu-theme-sakura { --acu-bg-nav: #F9F0EF; --acu-bg-panel: #F9F0EF; --acu-border: #EBDCD9; --acu-text-main: #6B5552; --acu-text-sub: #C08D8D; --acu-btn-bg: #EBDCD9; --acu-btn-hover: #D8C7C4; --acu-btn-active-bg: #C08D8D; --acu-btn-active-text: #F9F0EF; --acu-accent: #C08D8D; --acu-table-head: #F9F0EF; --acu-table-hover: #F5EAE8; --acu-opt-hover: #F5EAE8; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #F9F0EF; --acu-menu-bg: #fff; --acu-menu-text: #6B5552; --acu-success-text: #6B5552; --acu-success-bg: rgba(192, 141, 141, 0.12); --acu-scrollbar-track: #F9F0EF; --acu-scrollbar-thumb: #EBDCD9; --acu-hl-manual: #A68A7A; --acu-hl-manual-bg: rgba(166, 138, 122, 0.12); --acu-hl-diff: #9B7A7A; --acu-hl-diff-bg: rgba(155, 122, 122, 0.2); --acu-error-text: #9B7A7A; --acu-error-bg: rgba(155, 122, 122, 0.12); --acu-error-border: rgba(155, 122, 122, 0.4); --acu-warning-icon: #A68A7A; --acu-failure-text: #9B7A7A; --acu-failure-bg: rgba(155, 122, 122, 0.12); --acu-warning-text: #A68A7A; --acu-warning-bg: rgba(166, 138, 122, 0.12); --acu-crit-success-text: #8B7A7A; --acu-crit-success-bg: rgba(139, 122, 122, 0.12); --acu-crit-failure-text: #8B6F6F; --acu-crit-failure-bg: rgba(139, 111, 111, 0.12); --acu-extreme-success-text: #9B8A8A; --acu-extreme-success-bg: rgba(155, 138, 138, 0.12); --acu-overlay-bg: rgba(107, 85, 82, 0.6); --acu-overlay-bg-light: rgba(107, 85, 82, 0.5); --acu-shadow-bg: rgba(107, 85, 82, 0.3); --acu-light-bg: rgba(192, 141, 141, 0.08); --acu-very-light-bg: rgba(192, 141, 141, 0.02); --acu-button-text: #6B5552; --acu-gray-bg: rgba(192, 141, 141, 0.08); --acu-button-text-on-accent: #F9F0EF; }\n    .acu-theme-minepink { --acu-bg-nav: #1a1a1a; --acu-bg-panel: #1a1a1a; --acu-border: #333333; --acu-text-main: #ffb3d9; --acu-text-sub: #ff80c1; --acu-btn-bg: #2a2a2a; --acu-btn-hover: #3a3a3a; --acu-btn-active-bg: #ff80c1; --acu-btn-active-text: #1a1a1a; --acu-accent: #ff80c1; --acu-table-head: #252525; --acu-table-hover: #2a2a2a; --acu-opt-hover: rgba(255, 128, 193, 0.15); --acu-opt-bg: rgba(255, 128, 193, 0.08); --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #222222; --acu-badge-bg: #2a2a2a; --acu-menu-bg: #1a1a1a; --acu-menu-text: #ffb3d9; --acu-success-text: #ff80c1; --acu-success-bg: rgba(255, 128, 193, 0.2); --acu-scrollbar-track: #1a1a1a; --acu-scrollbar-thumb: #333333; --acu-hl-manual: #ffa726; --acu-hl-manual-bg: rgba(255, 167, 38, 0.2); --acu-hl-diff: #ff80c1; --acu-hl-diff-bg: rgba(255, 128, 193, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-failure-text: #ff6b6b; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-crit-success-text: #ff80c1; --acu-crit-success-bg: rgba(255, 128, 193, 0.2); --acu-crit-failure-text: #ff4444; --acu-crit-failure-bg: rgba(255, 68, 68, 0.2); --acu-extreme-success-text: #ffb3d9; --acu-extreme-success-bg: rgba(255, 179, 217, 0.2); --acu-overlay-bg: rgba(0,0,0,0.8); --acu-overlay-bg-light: rgba(0,0,0,0.7); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255, 128, 193, 0.1); --acu-very-light-bg: rgba(255, 128, 193, 0.02); --acu-button-text: #1a1a1a; --acu-gray-bg: rgba(255, 128, 193, 0.1); --acu-button-text-on-accent: #1a1a1a; }\n    .acu-theme-purple { --acu-bg-nav: #f3e5f5; --acu-bg-panel: #f3e5f5; --acu-border: #ce93d8; --acu-text-main: #6a1b9a; --acu-text-sub: #9c27b0; --acu-btn-bg: #e1bee7; --acu-btn-hover: #ce93d8; --acu-btn-active-bg: #9c27b0; --acu-btn-active-text: #fff; --acu-accent: #9c27b0; --acu-table-head: #f8e1f5; --acu-table-hover: #fce4ec; --acu-opt-hover: #fce4ec; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #f8e1f5; --acu-menu-bg: #fff; --acu-menu-text: #6a1b9a; --acu-success-text: #6a1b9a; --acu-success-bg: rgba(106, 27, 154, 0.15); --acu-scrollbar-track: #f3e5f5; --acu-scrollbar-thumb: #ce93d8; --acu-hl-manual: #f57c00; --acu-hl-manual-bg: rgba(245, 124, 0, 0.15); --acu-hl-diff: #6a1b9a; --acu-hl-diff-bg: rgba(106, 27, 154, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-failure-text: #d32f2f; --acu-failure-bg: rgba(211, 47, 47, 0.15); --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-crit-success-text: #7b1fa2; --acu-crit-success-bg: rgba(123, 31, 162, 0.15); --acu-crit-failure-text: #b71c1c; --acu-crit-failure-bg: rgba(183, 28, 28, 0.15); --acu-extreme-success-text: #6a1b9a; --acu-extreme-success-bg: rgba(106, 27, 154, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(156, 39, 176, 0.1); --acu-very-light-bg: rgba(156, 39, 176, 0.02); --acu-button-text: #6a1b9a; --acu-gray-bg: rgba(156, 39, 176, 0.1); --acu-button-text-on-accent: #fff; }\n    .acu-theme-wechat { --acu-bg-nav: #F7F7F7; --acu-bg-panel: #F7F7F7; --acu-border: #E5E5E5; --acu-text-main: #333333; --acu-text-sub: #666666; --acu-btn-bg: #E5E5E5; --acu-btn-hover: #D5D5D5; --acu-btn-active-bg: #09B83E; --acu-btn-active-text: #FFFFFF; --acu-accent: #09B83E; --acu-table-head: #F0F0F0; --acu-table-hover: #EBEBEB; --acu-opt-hover: #EBEBEB; --acu-opt-bg: #ffffff; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #F0F0F0; --acu-menu-bg: #fff; --acu-menu-text: #333333; --acu-success-text: #09B83E; --acu-success-bg: rgba(9, 184, 62, 0.12); --acu-scrollbar-track: #F7F7F7; --acu-scrollbar-thumb: #E5E5E5; --acu-hl-manual: #FF9500; --acu-hl-manual-bg: rgba(255, 149, 0, 0.12); --acu-hl-diff: #09B83E; --acu-hl-diff-bg: rgba(9, 184, 62, 0.2); --acu-error-text: #E53E3E; --acu-error-bg: rgba(229, 62, 62, 0.12); --acu-error-border: rgba(229, 62, 62, 0.5); --acu-warning-icon: #FF9500; --acu-failure-text: #E53E3E; --acu-failure-bg: rgba(229, 62, 62, 0.12); --acu-warning-text: #FF9500; --acu-warning-bg: rgba(255, 149, 0, 0.12); --acu-crit-success-text: #07A832; --acu-crit-success-bg: rgba(7, 168, 50, 0.15); --acu-crit-failure-text: #C53030; --acu-crit-failure-bg: rgba(197, 48, 48, 0.15); --acu-extreme-success-text: #09B83E; --acu-extreme-success-bg: rgba(9, 184, 62, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.2); --acu-light-bg: rgba(9, 184, 62, 0.08); --acu-very-light-bg: rgba(9, 184, 62, 0.02); --acu-button-text: #333333; --acu-gray-bg: rgba(9, 184, 62, 0.08); --acu-button-text-on-accent: #fff; }\n    .acu-theme-educational { --acu-bg-nav: #000000; --acu-bg-panel: #000000; --acu-border: #1B1B1B; --acu-text-main: #FFFFFF; --acu-text-sub: #CCCCCC; --acu-btn-bg: #1B1B1B; --acu-btn-hover: #2B2B2B; --acu-btn-active-bg: #FF9900; --acu-btn-active-text: #000000; --acu-accent: #FF9900; --acu-table-head: #1B1B1B; --acu-table-hover: #2B2B2B; --acu-opt-hover: rgba(255, 153, 0, 0.18); --acu-opt-bg: rgba(255, 153, 0, 0.1); --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #1B1B1B; --acu-badge-bg: #1B1B1B; --acu-menu-bg: #000000; --acu-menu-text: #FFFFFF; --acu-success-text: #FF9900; --acu-success-bg: rgba(255, 153, 0, 0.15); --acu-scrollbar-track: #000000; --acu-scrollbar-thumb: #1B1B1B; --acu-input-bg: #1B1B1B; --acu-hl-manual: #FF9900; --acu-hl-manual-bg: rgba(255, 153, 0, 0.15); --acu-hl-diff: #FFB84D; --acu-hl-diff-bg: rgba(255, 184, 77, 0.2); --acu-error-text: #FF6B6B; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #FFAA00; --acu-failure-text: #FF6B6B; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #FFAA00; --acu-warning-bg: rgba(255, 170, 0, 0.2); --acu-crit-success-text: #FF9900; --acu-crit-success-bg: rgba(255, 153, 0, 0.2); --acu-crit-failure-text: #FF4444; --acu-crit-failure-bg: rgba(255, 68, 68, 0.2); --acu-extreme-success-text: #FFB84D; --acu-extreme-success-bg: rgba(255, 184, 77, 0.2); --acu-overlay-bg: rgba(0,0,0,0.8); --acu-overlay-bg-light: rgba(0,0,0,0.7); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255, 153, 0, 0.1); --acu-very-light-bg: rgba(255, 153, 0, 0.02); --acu-button-text: #FFFFFF; --acu-gray-bg: rgba(255, 255, 255, 0.1); --acu-button-text-on-accent: #000; }\n    .acu-theme-vaporwave { --acu-bg-nav: #191970; --acu-bg-panel: #191970; --acu-border: rgba(0, 255, 255, 0.3); --acu-text-main: #00FFFF; --acu-text-sub: #FF00FF; --acu-btn-bg: rgba(25, 25, 112, 0.8); --acu-btn-hover: rgba(0, 255, 255, 0.2); --acu-btn-active-bg: #FF00FF; --acu-btn-active-text: #191970; --acu-accent: #00FFFF; --acu-table-head: rgba(25, 25, 112, 0.9); --acu-table-hover: rgba(0, 255, 255, 0.1); --acu-opt-hover: rgba(0, 255, 255, 0.18); --acu-opt-bg: rgba(0, 255, 255, 0.1); --acu-shadow: 0 0 15px rgba(0, 255, 255, 0.3); --acu-card-bg: rgba(25, 25, 112, 0.95); --acu-badge-bg: rgba(25, 25, 112, 0.8); --acu-menu-bg: #191970; --acu-menu-text: #00FFFF; --acu-success-text: #00FFFF; --acu-success-bg: rgba(0, 255, 255, 0.15); --acu-scrollbar-track: #191970; --acu-scrollbar-thumb: rgba(0, 255, 255, 0.3); --acu-input-bg: rgba(25, 25, 112, 0.6); --acu-hl-manual: #00FFFF; --acu-hl-manual-bg: rgba(0, 255, 255, 0.2); --acu-hl-diff: #FF00FF; --acu-hl-diff-bg: rgba(255, 0, 255, 0.2); --acu-error-text: #FF00FF; --acu-error-bg: rgba(255, 0, 255, 0.2); --acu-error-border: rgba(255, 0, 255, 0.5); --acu-warning-icon: #FF00FF; --acu-failure-text: #FF00FF; --acu-failure-bg: rgba(255, 0, 255, 0.2); --acu-warning-text: #FF00FF; --acu-warning-bg: rgba(255, 0, 255, 0.15); --acu-crit-success-text: #00FFFF; --acu-crit-success-bg: rgba(0, 255, 255, 0.2); --acu-crit-failure-text: #FF00FF; --acu-crit-failure-bg: rgba(255, 0, 255, 0.25); --acu-extreme-success-text: #00FFFF; --acu-extreme-success-bg: rgba(0, 255, 255, 0.2); --acu-overlay-bg: rgba(25, 25, 112, 0.85); --acu-overlay-bg-light: rgba(25, 25, 112, 0.75); --acu-shadow-bg: rgba(0, 255, 255, 0.3); --acu-light-bg: rgba(0, 255, 255, 0.05); --acu-very-light-bg: rgba(0, 255, 255, 0.02); --acu-button-text: #F0F8FF; --acu-gray-bg: rgba(0, 255, 255, 0.1); --acu-button-text-on-accent: #191970; }\n    .acu-theme-vaporwave .acu-nav-btn { border-color: rgba(0, 255, 255, 0.3); }\n    .acu-theme-vaporwave .acu-data-card { border-color: rgba(0, 255, 255, 0.3); }\n    .acu-theme-vaporwave .acu-dice-panel input::placeholder,\n    .acu-theme-vaporwave .acu-contest-panel input::placeholder {\n        color: #FF00FF !important;\n        opacity: 0.7;\n    }\n    .acu-theme-vaporwave .acu-dice-panel input[type="text"],\n    .acu-theme-vaporwave .acu-dice-panel input[type="number"],\n    .acu-theme-vaporwave .acu-dice-panel input:not([type]),\n    .acu-theme-vaporwave .acu-contest-panel input[type="text"],\n    .acu-theme-vaporwave .acu-contest-panel input[type="number"],\n    .acu-theme-vaporwave .acu-contest-panel input:not([type]) {\n        color: #00FFFF !important;\n    }\n    .acu-theme-classicpackaging { --acu-bg-nav: #000000; --acu-bg-panel: #000000; --acu-border: #FFFF00; --acu-text-main: #FFFF00; --acu-text-sub: #CCCC00; --acu-btn-bg: #FF0000; --acu-btn-hover: #CC0000; --acu-btn-active-bg: #0000FF; --acu-btn-active-text: #FFFF00; --acu-accent: #FF0000; --acu-table-head: #1a1a1a; --acu-table-hover: #2a2a2a; --acu-opt-hover: rgba(255, 255, 0, 0.15); --acu-opt-bg: rgba(255, 255, 0, 0.08); --acu-shadow: rgba(255,255,0,0.3); --acu-card-bg: #1a1a1a; --acu-badge-bg: #FF0000; --acu-menu-bg: #000000; --acu-menu-text: #FFFF00; --acu-success-text: #0000FF; --acu-success-bg: rgba(0, 0, 255, 0.2); --acu-scrollbar-track: #000000; --acu-scrollbar-thumb: #FFFF00; --acu-input-bg: #1a1a1a; --acu-hl-manual: #FF0000; --acu-hl-manual-bg: rgba(255, 0, 0, 0.2); --acu-hl-diff: #0000FF; --acu-hl-diff-bg: rgba(0, 0, 255, 0.2); --acu-error-text: #FF0000; --acu-error-bg: rgba(255, 0, 0, 0.2); --acu-error-border: rgba(255, 0, 0, 0.8); --acu-warning-icon: #FF0000; --acu-failure-text: #FF0000; --acu-failure-bg: rgba(255, 0, 0, 0.2); --acu-warning-text: #FF0000; --acu-warning-bg: rgba(255, 0, 0, 0.15); --acu-crit-success-text: #0000FF; --acu-crit-success-bg: rgba(0, 0, 255, 0.2); --acu-crit-failure-text: #FF0000; --acu-crit-failure-bg: rgba(255, 0, 0, 0.25); --acu-extreme-success-text: #0000FF; --acu-extreme-success-bg: rgba(0, 0, 255, 0.2); --acu-overlay-bg: rgba(0,0,0,0.9); --acu-overlay-bg-light: rgba(0,0,0,0.8); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255,255,0,0.1); --acu-very-light-bg: rgba(255,255,0,0.02); --acu-button-text: #FFFF00; --acu-gray-bg: rgba(255,255,0,0.1); --acu-button-text-on-accent: #FFFF00; }\n    .acu-theme-classicpackaging .acu-nav-btn { border-color: #FFFF00; border-width: 2px; font-weight: bold; }\n    .acu-theme-classicpackaging .acu-data-card { border-color: #FFFF00; border-width: 2px; }\n    .acu-theme-classicpackaging .acu-dice-panel input::placeholder,\n    .acu-theme-classicpackaging .acu-contest-panel input::placeholder {\n        color: #666600 !important;\n        opacity: 0.7;\n    }\n    .acu-theme-classicpackaging .acu-dice-panel input[type="text"],\n    .acu-theme-classicpackaging .acu-dice-panel input[type="number"],\n    .acu-theme-classicpackaging .acu-dice-panel input:not([type]),\n    .acu-theme-classicpackaging .acu-contest-panel input[type="text"],\n    .acu-theme-classicpackaging .acu-contest-panel input[type="number"],\n    .acu-theme-classicpackaging .acu-contest-panel input:not([type]) {\n        color: #FFFF00 !important;\n        font-weight: bold;\n    }\n    .acu-theme-galgame { --acu-bg-nav: #FFF0F5; --acu-bg-panel: #FFF0F5; --acu-border: #F0D4E4; --acu-text-main: #6B4A5A; --acu-text-sub: #B08A9A; --acu-btn-bg: #FFE4E9; --acu-btn-hover: #FFD4E4; --acu-btn-active-bg: #E8B4D9; --acu-btn-active-text: #6B4A5A; --acu-accent: #E8B4D9; --acu-table-head: #FFF5F9; --acu-table-hover: #FFF0F8; --acu-opt-hover: #FFF0F8; --acu-opt-bg: #ffffff; --acu-shadow: rgba(232, 180, 217, 0.25); --acu-card-bg: #ffffff; --acu-badge-bg: #FFF5F9; --acu-menu-bg: #fff; --acu-menu-text: #6B4A5A; --acu-success-text: #D4A5C8; --acu-success-bg: rgba(212, 165, 200, 0.15); --acu-scrollbar-track: #FFF0F5; --acu-scrollbar-thumb: #F0D4E4; --acu-input-bg: #FFF8FA; --acu-hl-manual: #D4A5A5; --acu-hl-manual-bg: rgba(212, 165, 165, 0.15); --acu-hl-diff: #E8B4D9; --acu-hl-diff-bg: rgba(232, 180, 217, 0.2); --acu-error-text: #C88A9A; --acu-error-bg: rgba(200, 138, 154, 0.15); --acu-error-border: rgba(200, 138, 154, 0.4); --acu-warning-icon: #D4A5A5; --acu-failure-text: #C88A9A; --acu-failure-bg: rgba(200, 138, 154, 0.15); --acu-warning-text: #D4A5A5; --acu-warning-bg: rgba(212, 165, 165, 0.15); --acu-crit-success-text: #E8B4D9; --acu-crit-success-bg: rgba(232, 180, 217, 0.2); --acu-crit-failure-text: #C88A9A; --acu-crit-failure-bg: rgba(200, 138, 154, 0.2); --acu-extreme-success-text: #D4A5C8; --acu-extreme-success-bg: rgba(212, 165, 200, 0.2); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(232, 180, 217, 0.25); --acu-light-bg: rgba(232, 180, 217, 0.08); --acu-very-light-bg: rgba(232, 180, 217, 0.02); --acu-button-text: #6B4A5A; --acu-button-text-on-accent: #6B4A5A; --acu-gray-bg: rgba(232, 180, 217, 0.1); }\n    .acu-theme-galgame .acu-nav-btn { border-radius: 8px; transition: all 0.3s ease; }\n    .acu-theme-galgame .acu-data-card { border-radius: 12px; box-shadow: 0 4px 12px rgba(232, 180, 217, 0.15); transition: all 0.3s ease; }\n    .acu-theme-galgame .acu-data-card:hover { box-shadow: 0 6px 20px rgba(232, 180, 217, 0.25); transform: translateY(-2px); }\n    .acu-theme-galgame .acu-nav-btn:hover { box-shadow: 0 2px 8px rgba(232, 180, 217, 0.2); }\n    .acu-theme-terminal { --acu-bg-nav: #0c0c0c; --acu-bg-panel: #0c0c0c; --acu-border: #00ff00; --acu-text-main: #00ff00; --acu-text-sub: #00cc00; --acu-btn-bg: #1a1a1a; --acu-btn-hover: #2a2a2a; --acu-btn-active-bg: #00ff00; --acu-btn-active-text: #0c0c0c; --acu-accent: #00ff00; --acu-table-head: #0a0a0a; --acu-table-hover: #1a1a1a; --acu-opt-hover: rgba(0, 255, 0, 0.12); --acu-opt-bg: rgba(0, 255, 0, 0.06); --acu-shadow: rgba(0,255,0,0.2); --acu-card-bg: #0c0c0c; --acu-badge-bg: #1a1a1a; --acu-menu-bg: #0c0c0c; --acu-menu-text: #00ff00; --acu-success-text: #00ff00; --acu-success-bg: rgba(0, 255, 0, 0.15); --acu-scrollbar-track: #0c0c0c; --acu-scrollbar-thumb: #00ff00; --acu-input-bg: #0c0c0c; --acu-hl-manual: #ffff00; --acu-hl-manual-bg: rgba(255, 255, 0, 0.15); --acu-hl-diff: #00ffff; --acu-hl-diff-bg: rgba(0, 255, 255, 0.15); --acu-error-text: #ff0000; --acu-error-bg: rgba(255, 0, 0, 0.15); --acu-error-border: rgba(255, 0, 0, 0.5); --acu-warning-icon: #ffff00; --acu-failure-text: #ff0000; --acu-failure-bg: rgba(255, 0, 0, 0.15); --acu-warning-text: #ffff00; --acu-warning-bg: rgba(255, 255, 0, 0.15); --acu-crit-success-text: #00ffff; --acu-crit-success-bg: rgba(0, 255, 255, 0.15); --acu-crit-failure-text: #ff00ff; --acu-crit-failure-bg: rgba(255, 0, 255, 0.15); --acu-extreme-success-text: #00ff00; --acu-extreme-success-bg: rgba(0, 255, 0, 0.2); --acu-overlay-bg: rgba(0,0,0,0.9); --acu-overlay-bg-light: rgba(0,0,0,0.8); --acu-shadow-bg: rgba(0,0,0,0.7); --acu-light-bg: rgba(0,255,0,0.05); --acu-very-light-bg: rgba(0,255,0,0.02); --acu-button-text: #0c0c0c; --acu-gray-bg: rgba(0,255,0,0.05); --acu-button-text-on-accent: #0c0c0c; font-family: 'Courier New', 'Consolas', 'Monaco', monospace; }\n    .acu-theme-terminal .acu-nav-btn { border-color: #00ff00; text-shadow: 0 0 5px rgba(0,255,0,0.5); }\n    .acu-theme-terminal .acu-data-card { border-color: #00ff00; text-shadow: 0 0 2px rgba(0,255,0,0.3); }\n    .acu-theme-terminal .acu-dice-panel input::placeholder,\n    .acu-theme-terminal .acu-contest-panel input::placeholder {\n        color: #008800 !important;\n        opacity: 0.7;\n    }\n    .acu-theme-terminal .acu-dice-panel input[type="text"],\n    .acu-theme-terminal .acu-dice-panel input[type="number"],\n    .acu-theme-terminal .acu-dice-panel input:not([type]),\n    .acu-theme-terminal .acu-contest-panel input[type="text"],\n    .acu-theme-terminal .acu-contest-panel input[type="number"],\n    .acu-theme-terminal .acu-contest-panel input:not([type]) {\n        color: #00ff00 !important;\n    }\n    .acu-theme-dreamcore { --acu-bg-nav: #F4F1EA; --acu-bg-panel: #F4F1EA; --acu-border: #D6D2C4; --acu-text-main: #5C5869; --acu-text-sub: #9490A0; --acu-btn-bg: #E6E1D5; --acu-btn-hover: #DBD8CC; --acu-btn-active-bg: #8A9AC6; --acu-btn-active-text: #FFFFFF; --acu-accent: #8A9AC6; --acu-table-head: #EBE7DE; --acu-table-hover: #F8F6F0; --acu-opt-hover: #F8F6F0; --acu-opt-bg: #FFFFFF; --acu-shadow: rgba(92, 88, 105, 0.15); --acu-card-bg: #FFFFFF; --acu-badge-bg: #EBE7DE; --acu-menu-bg: #FCFAF5; --acu-menu-text: #5C5869; --acu-success-text: #4A7A68; --acu-success-bg: rgba(74, 122, 104, 0.18); --acu-scrollbar-track: #F4F1EA; --acu-scrollbar-thumb: #D6D2C4; --acu-input-bg: #FFFFFF; --acu-hl-manual: #8A7040; --acu-hl-manual-bg: rgba(138, 112, 64, 0.18); --acu-hl-diff: #8A9AC6; --acu-hl-diff-bg: rgba(138, 154, 198, 0.18); --acu-error-text: #B85C5C; --acu-error-bg: rgba(184, 92, 92, 0.15); --acu-error-border: rgba(184, 92, 92, 0.4); --acu-warning-icon: #E0C080; --acu-failure-text: #8F5E5E; --acu-failure-bg: rgba(143, 94, 94, 0.18); --acu-warning-text: #8A7040; --acu-warning-bg: rgba(138, 112, 64, 0.18); --acu-crit-success-text: #2D6E58; --acu-crit-success-bg: rgba(45, 110, 88, 0.25); --acu-crit-failure-text: #7A3E3E; --acu-crit-failure-bg: rgba(122, 62, 62, 0.25); --acu-extreme-success-text: #5C5228; --acu-extreme-success-bg: rgba(92, 82, 40, 0.2); --acu-overlay-bg: rgba(244, 241, 234, 0.85); --acu-overlay-bg-light: rgba(255, 255, 255, 0.4); --acu-shadow-bg: rgba(92, 88, 105, 0.15); --acu-light-bg: rgba(138, 154, 198, 0.08); --acu-very-light-bg: rgba(138, 154, 198, 0.03); --acu-button-text: #5C5869; --acu-gray-bg: rgba(92, 88, 105, 0.08); --acu-button-text-on-accent: #fff; }\n    .acu-theme-dreamcore .acu-nav-btn { border-color: #D6D2C4; }\n    /* æå…‰å¹»å¢ƒ (Aurora) ä¸»é¢˜ï¼šæ·±é‚ƒæ˜Ÿç©ºä¸æå…‰æ¸å˜ */\n    .acu-theme-aurora {\n        --acu-bg-nav: linear-gradient(135deg, #0f172a, #1e293b);\n        --acu-bg-panel: linear-gradient(180deg, #0f172a 0%, #334155 100%);\n        --acu-border: #38bdf8;\n        --acu-text-main: #e2e8f0;\n        --acu-text-sub: #94a3b8;\n        --acu-btn-bg: linear-gradient(135deg, #162a3d, #25224d);\n        --acu-btn-hover: linear-gradient(135deg, #1e3a5f, #312e81);\n        --acu-btn-active-bg: linear-gradient(135deg, #38bdf8, #a855f7);\n        --acu-btn-active-text: #fff;\n        --acu-accent: #38bdf8;\n        --acu-table-head: linear-gradient(90deg, #0f172a, #1e293b);\n        --acu-table-hover: rgba(56, 189, 248, 0.08);\n        --acu-opt-hover: rgba(56, 189, 248, 0.15);\n        --acu-opt-bg: rgba(56, 189, 248, 0.08);\n        --acu-shadow: 0 8px 32px rgba(56, 189, 248, 0.15), 0 4px 16px rgba(168, 85, 247, 0.1);\n        --acu-card-bg: linear-gradient(145deg, #1e293b, #0f172a);\n        --acu-badge-bg: rgba(56, 189, 248, 0.2);\n        --acu-menu-bg: #1e293b;\n        --acu-menu-text: #e2e8f0;\n        --acu-success-text: #4ade80;\n        --acu-success-bg: rgba(74, 222, 128, 0.15);\n        --acu-scrollbar-track: #0f172a;\n        --acu-scrollbar-thumb: #38bdf8;\n        --acu-input-bg: #0f172a;\n        --acu-hl-manual: #f97316;\n        --acu-hl-manual-bg: rgba(249, 115, 22, 0.2);\n        --acu-hl-diff: #38bdf8;\n        --acu-hl-diff-bg: rgba(56, 189, 248, 0.2);\n        --acu-error-text: #f87171;\n        --acu-error-bg: rgba(248, 113, 113, 0.2);\n        --acu-error-border: rgba(248, 113, 113, 0.5);\n        --acu-warning-icon: #fbbf24;\n        --acu-failure-text: #f87171;\n        --acu-failure-bg: rgba(248, 113, 113, 0.2);\n        --acu-warning-text: #fbbf24;\n        --acu-warning-bg: rgba(251, 191, 36, 0.2);\n        --acu-crit-success-text: #a855f7;\n        --acu-crit-success-bg: rgba(168, 85, 247, 0.2);\n        --acu-crit-failure-text: #ef4444;\n        --acu-crit-failure-bg: rgba(239, 68, 68, 0.25);\n        --acu-extreme-success-text: #22d3ee;\n        --acu-extreme-success-bg: rgba(34, 211, 238, 0.2);\n        --acu-overlay-bg: rgba(15, 23, 42, 0.98);\n        --acu-overlay-bg-light: rgba(30, 41, 59, 0.95);\n        --acu-shadow-bg: rgba(56, 189, 248, 0.2);\n        --acu-light-bg: rgba(56, 189, 248, 0.08);\n        --acu-very-light-bg: rgba(56, 189, 248, 0.03);\n        --acu-button-text: #e2e8f0;\n        --acu-gray-bg: rgba(148, 163, 184, 0.1);\n        --acu-button-text-on-accent: #fff;\n    }\n    .acu-theme-aurora .acu-nav-btn { border-color: rgba(56, 189, 248, 0.3); }\n    .acu-theme-aurora .acu-data-card { border-color: rgba(56, 189, 248, 0.3); box-shadow: 0 4px 20px rgba(56, 189, 248, 0.1), 0 2px 10px rgba(168, 85, 247, 0.08); }\n    .acu-theme-aurora .acu-dice-panel input::placeholder,\n    .acu-theme-aurora .acu-contest-panel input::placeholder {\n        color: #94a3b8 !important;\n        opacity: 0.7;\n    }\n    .acu-theme-aurora .acu-dice-panel input[type="text"],\n    .acu-theme-aurora .acu-dice-panel input[type="number"],\n    .acu-theme-aurora .acu-dice-panel input:not([type]),\n    .acu-theme-aurora .acu-contest-panel input[type="text"],\n    .acu-theme-aurora .acu-contest-panel input[type="number"],\n    .acu-theme-aurora .acu-contest-panel input:not([type]) {\n        color: #e2e8f0 !important;\n    }\n    /* æå…‰å¹»å¢ƒï¼šå¯¼èˆªæ  - æå…‰æ¸å˜å…‰æ•ˆ */\n    .acu-theme-aurora .acu-nav-container {\n        background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%) !important;\n        border: 1px solid #38bdf8 !important;\n        box-shadow: 0 0 30px rgba(56, 189, 248, 0.1), 0 0 60px rgba(168, 85, 247, 0.05), inset 0 0 20px rgba(56, 189, 248, 0.05) !important;\n        overflow: visible !important;\n    }\n    /* æå…‰é¡¶éƒ¨æ¸å˜å…‰æ¡ */\n    .acu-theme-aurora .acu-nav-container::before {\n        content: '';\n        position: absolute;\n        top: -1px; left: -1px; right: -1px; bottom: -1px;\n        background: linear-gradient(90deg, #38bdf8, #a855f7, #22d3ee, #38bdf8);\n        background-size: 300% 100%;\n        z-index: -1;\n        border-radius: 14px;\n        animation: aurora-glow 6s ease-in-out infinite;\n        opacity: 0.6;\n    }\n    @keyframes aurora-glow {\n        0% { background-position: 0% 50%; opacity: 0.4; }\n        50% { background-position: 100% 50%; opacity: 0.7; }\n        100% { background-position: 0% 50%; opacity: 0.4; }\n    }\n    /* æå…‰å¹»å¢ƒï¼šæŒ‰é’®æ ·å¼ */\n    .acu-theme-aurora .acu-nav-btn {\n        border: 1px solid rgba(56, 189, 248, 0.2) !important;\n        background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(168, 85, 247, 0.1)) !important;\n        border-radius: 8px;\n        color: #e2e8f0;\n        transition: all 0.3s ease;\n    }\n    .acu-theme-aurora .acu-nav-btn:hover {\n        background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(168, 85, 247, 0.2)) !important;\n        border-color: rgba(56, 189, 248, 0.5) !important;\n        box-shadow: 0 4px 15px rgba(56, 189, 248, 0.2);\n        transform: translateY(-2px);\n    }\n    .acu-theme-aurora .acu-nav-btn.active {\n        background: linear-gradient(135deg, #38bdf8, #a855f7) !important;\n        border-color: transparent !important;\n        color: #ffffff !important;\n        box-shadow: 0 4px 20px rgba(56, 189, 248, 0.4), 0 2px 10px rgba(168, 85, 247, 0.3);\n        font-weight: bold;\n    }\n    /* æå…‰å¹»å¢ƒï¼šæ•°æ®å¡ç‰‡ */\n    .acu-theme-aurora .acu-data-card:hover {\n        border-color: rgba(56, 189, 248, 0.5) !important;\n        box-shadow: 0 8px 30px rgba(56, 189, 248, 0.15), 0 4px 15px rgba(168, 85, 247, 0.1);\n        transform: translateY(-3px);\n    }\n    .acu-theme-dreamcore .acu-data-card { border-color: #D6D2C4; box-shadow: 0 2px 8px rgba(92, 88, 105, 0.1); }\n    .acu-theme-dreamcore .acu-dice-panel input::placeholder,\n    .acu-theme-dreamcore .acu-contest-panel input::placeholder {\n        color: #B0ACC0 !important;\n        opacity: 0.9;\n    }\n    .acu-theme-dreamcore .acu-dice-panel input[type="text"],\n    .acu-theme-dreamcore .acu-dice-panel input[type="number"],\n    .acu-theme-dreamcore .acu-dice-panel input:not([type]),\n    .acu-theme-dreamcore .acu-contest-panel input[type="text"],\n    .acu-theme-dreamcore .acu-contest-panel input[type="number"],\n    .acu-theme-dreamcore .acu-contest-panel input:not([type]) {\n        color: #4A4652 !important;\n    }\n    /* è¶…å¤©é…± (Choutenã¡ã‚ƒã‚“) ä¸»é¢˜ï¼šé›»è„³ã‚«ãƒ¯ã‚¤ã‚¤ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ‰ãƒ©ã‚¤ãƒ– */\n    .acu-theme-chouten {\n        --acu-bg-nav: linear-gradient(135deg, rgba(26, 10, 46, 0.95) 0%, rgba(45, 27, 78, 0.95) 50%, rgba(26, 10, 46, 0.95) 100%);\n        --acu-bg-panel: rgba(26, 10, 46, 0.95);\n        --acu-border: #FF7EB6;\n        --acu-text-main: #FFFFFF;\n        --acu-text-sub: #D0BFFF;\n        --acu-btn-bg: rgba(255, 255, 255, 0.1);\n        --acu-btn-hover: rgba(255, 107, 157, 0.3);\n        --acu-btn-active-bg: linear-gradient(90deg, #FF6B9D, #B388FF);\n        --acu-btn-active-text: #FFFFFF;\n        --acu-accent: #7FFFD4;\n        --acu-table-head: rgba(255, 107, 157, 0.15);\n        --acu-table-hover: linear-gradient(90deg, rgba(255, 107, 157, 0.2), rgba(127, 255, 212, 0.2));\n        --acu-opt-hover: linear-gradient(90deg, rgba(255, 107, 157, 0.15), rgba(127, 255, 212, 0.15)); --acu-opt-bg: transparent;\n        --acu-shadow: rgba(255, 107, 157, 0.5);\n        --acu-card-bg: rgba(20, 10, 35, 0.7);\n        --acu-badge-bg: rgba(127, 255, 212, 0.2);\n        --acu-menu-bg: #2D1B4E;\n        --acu-menu-text: #FFE4F0;\n        --acu-success-text: #7FFFD4;\n        --acu-success-bg: rgba(127, 255, 212, 0.15);\n        --acu-scrollbar-track: #1A0A2E;\n        --acu-scrollbar-thumb: #FF6B9D;\n        --acu-input-bg: rgba(0, 0, 0, 0.3);\n        --acu-hl-manual: #FFD93D;\n        --acu-hl-manual-bg: rgba(255, 217, 61, 0.2);\n        --acu-hl-diff: #7FFFD4;\n        --acu-hl-diff-bg: rgba(127, 255, 212, 0.2);\n        --acu-error-text: #FF6B6B;\n        --acu-error-bg: rgba(255, 107, 107, 0.2);\n        --acu-error-border: #FF6B6B;\n        --acu-warning-icon: #FFD93D;\n        --acu-failure-text: #FF6B6B;\n        --acu-failure-bg: rgba(255, 107, 107, 0.2);\n        --acu-warning-text: #FFD93D;\n        --acu-warning-bg: rgba(255, 217, 61, 0.2);\n        --acu-crit-success-text: #00FFAB;\n        --acu-crit-success-bg: rgba(0, 255, 171, 0.25);\n        --acu-crit-failure-text: #FF4757;\n        --acu-crit-failure-bg: rgba(255, 71, 87, 0.25);\n        --acu-extreme-success-text: #00D9FF;\n        --acu-extreme-success-bg: rgba(0, 217, 255, 0.2);\n        --acu-overlay-bg: rgba(26, 10, 46, 0.95);\n        --acu-overlay-bg-light: rgba(45, 27, 78, 0.85);\n        --acu-shadow-bg: rgba(255, 107, 157, 0.3);\n        --acu-light-bg: rgba(255, 107, 157, 0.1);\n        --acu-very-light-bg: rgba(179, 136, 255, 0.05);\n        --acu-button-text: #FFFFFF;\n        --acu-button-text-on-accent: #1A0A2E;\n        --acu-gray-bg: rgba(255, 255, 255, 0.05);\n    }\n\n    .acu-theme-retro { --acu-opt-bright-bg: #fffef9; }\n    .acu-theme-modern,\n    .acu-theme-forest,\n    .acu-theme-ocean,\n    .acu-theme-sakura,\n    .acu-theme-purple,\n    .acu-theme-wechat,\n    .acu-theme-galgame,\n    .acu-theme-dreamcore { --acu-opt-bright-bg: #ffffff; }\n    .acu-theme-dark { --acu-opt-bright-bg: rgba(255, 255, 255, 0.05); }\n    .acu-theme-cyber { --acu-opt-bright-bg: rgba(0, 255, 204, 0.08); }\n    .acu-theme-nightowl { --acu-opt-bright-bg: rgba(127, 219, 202, 0.08); }\n    .acu-theme-minepink { --acu-opt-bright-bg: rgba(255, 128, 193, 0.08); }\n    .acu-theme-educational { --acu-opt-bright-bg: rgba(255, 153, 0, 0.1); }\n    .acu-theme-vaporwave { --acu-opt-bright-bg: rgba(0, 255, 255, 0.1); }\n    .acu-theme-aurora { --acu-opt-bright-bg: rgba(56, 189, 248, 0.1); }\n    .acu-theme-classicpackaging { --acu-opt-bright-bg: rgba(255, 255, 0, 0.08); }\n    .acu-theme-terminal { --acu-opt-bright-bg: rgba(0, 255, 0, 0.06); }\n    .acu-theme-chouten { --acu-opt-bright-bg: transparent; }\n\n    /* è¶…å¤©é…±ï¼šå¯¼èˆªæ  - å¶åƒèˆå°å…‰æ•ˆ */\n    .acu-theme-chouten .acu-nav-container {\n        background: linear-gradient(180deg, rgba(45, 27, 78, 0.95) 0%, rgba(26, 10, 46, 0.98) 100%) !important;\n        border: 1px solid rgba(255, 107, 157, 0.5) !important;\n        box-shadow: 0 0 20px rgba(179, 136, 255, 0.2), inset 0 0 30px rgba(255, 107, 157, 0.1) !important;\n        backdrop-filter: blur(10px);\n        overflow: visible !important;\n    }\n    /* é¡¶éƒ¨å½©è™¹å…‰æ¡ */\n    .acu-theme-chouten .acu-nav-container::before {\n        content: '';\n        position: absolute;\n        top: -2px; left: -2px; right: -2px; bottom: -2px;\n        background: linear-gradient(90deg, #FF6B9D, #B388FF, #7FFFD4, #FF6B9D);\n        background-size: 300% 100%;\n        z-index: -1;\n        border-radius: 12px;\n        animation: chouten-rainbow-border 4s linear infinite;\n        opacity: 0.8;\n    }\n    @keyframes chouten-rainbow-border {\n        0% { background-position: 0% 50%; }\n        50% { background-position: 100% 50%; }\n        100% { background-position: 0% 50%; }\n    }\n\n    /* è¶…å¤©é…±ï¼šæŒ‰é’® - ç³–æœéœ“è™¹ */\n    .acu-theme-chouten .acu-nav-btn {\n        border: 1px solid rgba(255, 255, 255, 0.2) !important;\n        background: rgba(255, 255, 255, 0.05) !important;\n        border-radius: 8px;\n        color: #FFE4F0;\n        transition: all 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n        position: relative;\n        overflow: hidden;\n    }\n    .acu-theme-chouten .acu-nav-btn:hover {\n        background: rgba(255, 107, 157, 0.2) !important;\n        border-color: #FF6B9D !important;\n        text-shadow: 0 0 8px #FF6B9D;\n        transform: translateY(-2px) scale(1.02);\n        box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);\n    }\n    .acu-theme-chouten .acu-nav-btn.active {\n        background: linear-gradient(135deg, #FF6B9D 0%, #B388FF 100%) !important;\n        border-color: #FFFFFF !important;\n        color: #FFFFFF !important;\n        box-shadow: 0 0 20px rgba(255, 107, 157, 0.6), inset 0 0 10px rgba(255, 255, 255, 0.3);\n        font-weight: bold;\n        text-shadow: 0 1px 2px rgba(0,0,0,0.3);\n    }\n    /* æŒ‰é’®æ¿€æ´»æ—¶çš„é—ªçƒç²’å­æ•ˆæœ (æ¨¡æ‹Ÿ) */\n    .acu-theme-chouten .acu-nav-btn.active::after {\n        content: 'âœ¦';\n        position: absolute;\n        top: 2px;\n        right: 4px;\n        font-size: 10px;\n        color: #7FFFD4;\n        animation: chouten-sparkle 1.5s infinite;\n    }\n\n    /* è¶…å¤©é…±ï¼šæ•°æ®å¡ç‰‡ - èµ›åšå…‰æ™• */\n    .acu-theme-chouten .acu-data-card {\n        border: 1px solid rgba(179, 136, 255, 0.3) !important;\n        background: linear-gradient(160deg, rgba(30, 15, 50, 0.85) 0%, rgba(20, 8, 40, 0.9) 100%) !important;\n        backdrop-filter: blur(5px);\n        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), inset 0 0 20px rgba(179, 136, 255, 0.05);\n        position: relative;\n    }\n    .acu-theme-chouten .acu-data-card::after {\n        content: '';\n        position: absolute;\n        top: 0; left: 0; right: 0; height: 1px;\n        background: linear-gradient(90deg, transparent, #7FFFD4, transparent);\n        opacity: 0.5;\n    }\n    .acu-theme-chouten .acu-data-card:hover {\n        border-color: #7FFFD4 !important;\n        box-shadow: 0 8px 30px rgba(127, 255, 212, 0.15), 0 0 15px rgba(127, 255, 212, 0.1);\n        transform: translateY(-2px);\n    }\n\n    /* è¶…å¤©é…±ï¼šè¾“å…¥æ¡† - æµ®ç©ºå…¨æ¯ */\n    .acu-theme-chouten .acu-dice-panel input::placeholder,\n    .acu-theme-chouten .acu-contest-panel input::placeholder {\n        color: rgba(179, 136, 255, 0.6) !important;\n    }\n    .acu-theme-chouten .acu-dice-panel input,\n    .acu-theme-chouten .acu-contest-panel input {\n        background: rgba(0, 0, 0, 0.4) !important;\n        border: 1px solid rgba(255, 107, 157, 0.3) !important;\n        border-radius: 4px;\n        color: #7FFFD4 !important;\n        transition: all 0.3s ease;\n    }\n    .acu-theme-chouten .acu-dice-panel input:focus,\n    .acu-theme-chouten .acu-contest-panel input:focus {\n        border-color: #7FFFD4 !important;\n        box-shadow: 0 0 10px rgba(127, 255, 212, 0.4), inset 0 0 10px rgba(127, 255, 212, 0.1) !important;\n        background: rgba(0, 0, 0, 0.6) !important;\n    }\n\n    /* è¶…å¤©é…±ï¼šæ»šåŠ¨æ¡ */\n    .acu-theme-chouten ::-webkit-scrollbar-thumb {\n        background: linear-gradient(180deg, #FF6B9D, #B388FF) !important;\n        border: 1px solid rgba(255, 255, 255, 0.2);\n    }\n    .acu-theme-chouten ::-webkit-scrollbar-track {\n        background: rgba(0, 0, 0, 0.2) !important;\n    }\n\n    /* è¶…å¤©é…±ï¼šè¡¨æ ¼è¡Œ - æ‚¬åœé«˜äº® */\n    .acu-theme-chouten .acu-card-row {\n        border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n    }\n    .acu-theme-chouten .acu-card-row:hover {\n        background: linear-gradient(90deg, rgba(255, 107, 157, 0.2), rgba(179, 136, 255, 0.1)) !important;\n        box-shadow: inset 2px 0 0 #FF6B9D;\n    }\n\n    /* è¶…å¤©é…±ï¼šå¾½ç« é—ªçƒåŠ¨ç”» */\n    .acu-theme-chouten .acu-badge-green {\n        background: rgba(127, 255, 212, 0.15) !important;\n        color: #7FFFD4 !important;\n        border: 1px solid rgba(127, 255, 212, 0.4);\n        box-shadow: 0 0 10px rgba(127, 255, 212, 0.2);\n        animation: chouten-badge-pulse 2s infinite;\n    }\n    @keyframes chouten-badge-pulse {\n        0%, 100% { box-shadow: 0 0 5px rgba(127, 255, 212, 0.2); opacity: 0.9; }\n        50% { box-shadow: 0 0 15px rgba(127, 255, 212, 0.5); opacity: 1; }\n    }\n    @keyframes chouten-sparkle {\n        0%, 100% { opacity: 0.4; transform: scale(0.8); }\n        50% { opacity: 1; transform: scale(1.2); }\n    }\n    /* Night Owlä¸»é¢˜ï¼šæ•°æ®éªŒè¯å’Œè¡¨æ ¼ç®¡ç†æ¡†æ¡†ä½¿ç”¨æ›´æš—çš„è¾¹æ¡† */\n    .acu-theme-nightowl .acu-table-manager-item,\n    .acu-theme-nightowl .acu-validation-rule-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-table-manager-item:hover,\n    .acu-theme-nightowl .acu-validation-rule-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    /* Night Owlä¸»é¢˜ï¼šé¢„è®¾å¡ç‰‡æ¡†æ¡†ä½¿ç”¨æ›´æš—çš„è¾¹æ¡† */\n    .acu-theme-nightowl .acu-preset-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-preset-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    .acu-wrapper { position: relative; width: 100%; margin: 15px 0; z-index: 31000 !important; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column-reverse; }\n    .acu-wrapper.acu-mode-embedded { position: relative !important; width: 100% !important; margin-top: 8px !important; z-index: 31001 !important; clear: both; display: flex; flex-direction: column-reverse !important; padding: 0; }\n    .acu-wrapper.acu-mode-embedded .acu-nav-container { position: relative !important; z-index: 31002 !important; }\n    .acu-wrapper.acu-mode-embedded .acu-data-display { position: absolute !important; bottom: 100% !important; left: 0 !important; right: 0 !important; width: 100% !important; box-shadow: 0 -10px 30px rgba(0,0,0,0.25) !important; border: 1px solid var(--acu-border); margin-bottom: 5px; z-index: 31010 !important; max-height: 70vh !important; overflow-y: auto !important; }\n    .acu-nav-container { display: grid; grid-template-columns: repeat(var(--acu-grid-cols, 3), 1fr); gap: 4px; padding: 6px; background: var(--acu-bg-nav); border: 1px solid var(--acu-border); border-radius: 10px; align-items: center; box-shadow: 0 2px 6px var(--acu-shadow); position: relative; z-index: 31001 !important; }\n    .acu-nav-btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 3px; padding: 4px 2px; border: 1px solid transparent; border-radius: 6px; background: var(--acu-btn-bg); color: var(--acu-text-main); font-weight: 600; font-size: 11px; cursor: pointer; transition: all 0.2s ease; user-select: none; overflow: hidden; height: 28px; }\n    .acu-nav-btn span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-top: 1px; }\n    .acu-nav-btn:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n    .acu-nav-btn:focus, .acu-nav-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n    /* [æ–°å¢] ç§»æ¤åŠŸèƒ½æ ·å¼ */\n/* --- 1. å¤–å±‚å®¹å™¨ï¼šé˜²æ­¢è¯¯è§¦è¾¹ç¼˜ --- */\n.acu-height-control {\n    display: flex;\n    align-items: center;\n    margin-right: 8px;\n    cursor: ns-resize;\n    padding: 4px;\n    border-radius: 4px;\n    color: var(--acu-text-sub);\n    transition: all 0.2s;\n    /* å…³é”®å±æ€§ï¼šç¦æ­¢åœ¨æ­¤åŒºåŸŸè§¦å‘æµè§ˆå™¨é»˜è®¤æ‰‹åŠ¿ */\n    touch-action: none;\n}\n\n/* äº¤äº’åé¦ˆ */\n.acu-height-control:hover, .acu-height-control.active {\n    color: var(--acu-accent);\n    background: var(--acu-table-hover);\n}\n\n/* --- 2. [åŠ ä¿é™©] å†…éƒ¨å›¾æ ‡ï¼šè¿™æ˜¯äº‹ä»¶ç»‘å®šçš„ä¸»ä½“ï¼Œå¿…é¡»ç¦æ­¢è§¦æ‘¸ --- */\n.acu-height-drag-handle {\n    cursor: ns-resize;\n    /* åŒé‡ä¿é™©ï¼šç¡®ä¿ç›´æ¥æŒ‰åœ¨å›¾æ ‡ä¸Šä¹Ÿä¸ä¼šè§¦å‘æ»šåŠ¨ */\n    touch-action: none;\n}\n\n            /* è§†å›¾åˆ‡æ¢æ ·å¼ */\n            .acu-view-btn { background: transparent !important; border: none; color: var(--acu-text-main) !important; cursor: pointer; padding: 4px; margin-right: 5px; font-size: 14px; opacity: 0.7; }\n            .acu-view-btn:hover { opacity: 1; color: var(--acu-accent) !important; background: var(--acu-table-hover) !important; border-radius: 4px; }\n            .acu-view-btn.acu-reverse-btn.active, .acu-reverse-btn[data-reversed="true"] { color: var(--acu-accent) !important; opacity: 1; }\n            /* Grid è§†å›¾ (åŒåˆ—) */\n            .acu-card-body.view-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }\n            /* ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶ Grid æ¨¡å¼ä½¿ç”¨ Flex å¸ƒå±€å¹¶å…è®¸é«˜åº¦è‡ªé€‚åº” */\n.acu-card-body.view-grid .acu-card-row { display: flex; height: auto !important; min-height: fit-content; border: 1px solid var(--acu-border); border-radius: 6px; padding: 4px 6px; flex-direction: column !important; align-items: flex-start !important; background: rgba(0,0,0,0.02); box-sizing: border-box; }\n            .acu-card-body.view-grid .acu-card-row.acu-grid-span-full { grid-column: 1 / -1; }\n            .acu-card-body.view-grid .acu-card-label { width: 100% !important; font-size: 0.85em; opacity: 0.8; margin-bottom: 2px; }\n            .acu-card-body.view-grid .acu-card-value { width: 100% !important; }\n\n            /* List è§†å›¾ (å•åˆ— - åŸç‰ˆå¢å¼º) */\n            .acu-nav-btn.active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); outline: none; border-color: transparent; }\n            .acu-nav-btn.active:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); transform: none; }\n            .acu-nav-btn.active:focus, .acu-nav-btn.active:focus-visible { outline: none; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2) !important; }\n            .acu-nav-btn.has-validation-errors { border-color: rgba(231, 76, 60, 0.5); }\n            .acu-nav-btn .acu-nav-warning-icon { color: var(--acu-error-text, #e74c3c); font-size: 10px; margin-left: 2px; animation: pulse 1.5s infinite; }\n            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }\n            .acu-action-btn { flex: 1; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--acu-btn-bg); border-radius: 8px; color: var(--acu-text-sub); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; margin: 0; }\n            .acu-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }\n            .acu-action-btn:focus, .acu-action-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n            #acu-btn-save-global { color: var(--acu-btn-active-bg); } #acu-btn-save-global:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); }\n\n            .acu-data-display { position: absolute; bottom: calc(100% + 10px); left: 0; right: 0; max-height: 80vh; height: auto; background: var(--acu-bg-panel); border: 1px solid var(--acu-border); border-radius: 8px; box-shadow: 0 8px 30px var(--acu-shadow); display: flex; flex-direction: column; z-index: 31002 !important; opacity: 0; visibility: hidden; transition: opacity 0.2s ease-out, visibility 0s linear 0.2s; pointer-events: none; }\n            .acu-data-display.visible { opacity: 1; visibility: visible; transition: opacity 0.2s ease-in, visibility 0s linear 0s; pointer-events: auto; }\n            @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }\n            @keyframes highlightFlash { 0%, 100% { box-shadow: none; } 50% { box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.6); } }\n            .acu-highlight-flash { animation: highlightFlash 0.5s ease-in-out 3; }\n\n            .acu-panel-header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); border-radius: 8px 8px 0 0; }\n            /* æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ äº† flex: 1 å’Œ min-width: 0ï¼Œå¼ºåˆ¶æ ‡é¢˜åœ¨ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨å˜çŸ­æ˜¾ç¤ºçœç•¥å· */\n/* --- æ–°çš„æ ‡é¢˜å¸ƒå±€ï¼šçºµå‘æ’åˆ— --- */\n.acu-panel-title {\n    display: flex;\n    flex-direction: column; /* å‚ç›´å †å  */\n    justify-content: center;\n    align-items: flex-start;\n    flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */\n    min-width: 0; /* å…è®¸å‹ç¼© */\n    margin-right: 8px;\n    overflow: hidden;\n}\n\n/* ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ä¸»ä½“ (åŠ ç²—ï¼Œç¨å¤§) */\n.acu-title-main {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    width: 100%;\n    font-size: 13px; /* ä½ è¦æ±‚çš„ï¼šå­—ä½“å˜å°ä¸€ç‚¹ï¼Œä½†ä¿æŒåŠ ç²— */\n    font-weight: bold;\n    color: var(--acu-text-main);\n    line-height: 1.2;\n}\n\n/* æ ‡é¢˜æ–‡å­—æœ¬èº« (æº¢å‡ºçœç•¥) */\n.acu-title-text {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n/* ç¬¬äºŒè¡Œï¼šé¡µç ä¿¡æ¯ (ç°è‰²ï¼Œæ›´å°) */\n.acu-title-sub {\n    font-size: 10px;\n    color: var(--acu-text-sub);\n    font-weight: normal;\n    opacity: 0.8;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    width: 100%;\n    line-height: 1.2;\n    margin-top: 1px;\n}\n            /* å¢åŠ äº† flex-shrink: 0; é˜²æ­¢è¢«æ ‡é¢˜æŒ¤å‹ */\n/* æ ¸å¿ƒä¿®æ”¹ï¼šflex-shrink: 0 ç¡®ä¿è¿™ä¸€å—åŒºåŸŸæ°¸è¿œä¸ä¼šè¢«å‹ç¼© */\n.acu-header-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }\n            .acu-search-wrapper { position: relative; display: flex; align-items: center; }\n            .acu-wrapper input.acu-search-input { background: var(--acu-btn-bg) !important; border: 1px solid var(--acu-border) !important; color: var(--acu-text-main) !important; padding: 4px 8px 4px 24px; border-radius: 12px; font-size: 12px; width: 120px; transition: width 0.2s, border-color 0.2s; }\n            .acu-wrapper input.acu-search-input::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            .acu-wrapper input.acu-search-input:focus { width: 160px; outline: none !important; border-color: var(--acu-accent) !important; box-shadow: none !important; }\n            .acu-search-input::placeholder { color: var(--acu-text-sub) ; opacity: 0.7; }\n            .acu-search-icon { position: absolute; left: 8px; font-size: 10px; color: var(--acu-text-sub); pointer-events: none; }\n            /* å¢åŠ äº† min-width å’Œ flex-shrink: 0 */\n            .acu-panel-content { flex: 1; overflow-x: auto; overflow-y: hidden; padding: 15px; background: transparent; scrollbar-width: thin; scrollbar-color: var(--acu-scrollbar-thumb) var(--acu-scrollbar-track); overscroll-behavior-x: contain; overscroll-behavior-y: auto; touch-action: pan-x pan-y; -webkit-overflow-scrolling: touch; }\n            /* å¢åŠ äº† height: 100%; è®©ç½‘æ ¼å®¹å™¨å¡«æ»¡é¢æ¿çš„é«˜åº¦ */\n.acu-card-grid { display: flex; flex-wrap: nowrap; gap: 12px; align-items: flex-start; }\n            .acu-layout-vertical .acu-panel-content { overflow-x: hidden !important; overflow-y: auto !important; overscroll-behavior: auto; touch-action: manipulation; min-height: 0; }\n            /* ç«–å‘å¸ƒå±€æ—¶æ¢å¤ auto é«˜åº¦ */\n.acu-layout-vertical .acu-card-grid { flex-wrap: wrap !important; justify-content: center; padding-bottom: 20px; height: auto; }\n.acu-wrapper:not(.acu-layout-vertical) .acu-manual-mode .acu-card-grid { height: 100%; } .acu-manual-mode .acu-data-card { max-height: 100% !important; overscroll-behavior-y: auto; } .acu-data-card { flex: 0 0 var(--acu-card-width, 260px); width: var(--acu-card-width, 260px); background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; height: auto; max-height: 60vh; overflow-y: auto; overscroll-behavior-y: auto; touch-action: manipulation; transition: all 0.2s ease; display: flex; flex-direction: column; position: relative; }\n            .acu-data-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--acu-shadow); border-color: var(--acu-accent); }\n            .acu-data-card.pending-deletion { opacity: 0.6; border: 1px dashed var(--acu-error-text, #e74c3c); }\n            .acu-data-card.pending-deletion::after { content: "å¾…åˆ é™¤"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--acu-error-text, #e74c3c); font-size: 24px; font-weight: bold; border: 2px solid var(--acu-error-text, #e74c3c); padding: 5px 10px; border-radius: 8px; opacity: 0.8; pointer-events: none; }\n            @keyframes pulse-highlight { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }\n            .acu-highlight-manual { color: var(--acu-hl-manual) !important; background-color: var(--acu-hl-manual-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-highlight-diff { color: var(--acu-hl-diff) !important; background-color: var(--acu-hl-diff-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-editable-title.acu-highlight-manual, .acu-editable-title.acu-highlight-diff { width: auto; display: inline-block; }\n            .acu-card-header { flex: 0 0 auto; padding: 8px 10px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); font-weight: bold; color: var(--acu-text-main); font-size: 14px; display: flex; flex-direction: row !important; align-items: center !important; justify-content: flex-start !important; gap: 8px; min-height: 40px; height: auto !important; position: relative; }\n            .acu-editable-title { flex: 1; width: auto !important; cursor: pointer; border-bottom: 1px dashed transparent; transition: all 0.2s; white-space: pre-wrap !important; overflow: visible !important; word-break: break-word !important; text-align: center; line-height: 1.3; margin: 0; }\n            .acu-editable-title:hover { border-bottom-color: var(--acu-accent); color: var(--acu-accent); }\n            .acu-card-index { position: static !important; transform: none !important; margin: 0; flex-shrink: 0; font-size: 11px; color: var(--acu-text-sub); font-weight: normal; background: var(--acu-badge-bg); padding: 2px 6px; border-radius: 4px; }\n            .acu-bookmark-icon { position: absolute; top: 8px; right: 8px; color: var(--acu-accent); cursor: pointer; font-size: 16px; opacity: 0.3; transition: opacity 0.2s, color 0.2s, transform 0.2s; z-index: 10; }\n            .acu-bookmark-icon:hover { opacity: 0.6; transform: scale(1.1); }\n            .acu-bookmark-icon.bookmarked { color: var(--acu-accent); opacity: 1; }\n            .acu-card-body { padding: 6px 12px; display: flex; flex-direction: column; gap: 0; font-size: var(--acu-font-size, 13px); flex: 1; }\n            .acu-card-row { display: block; padding: 6px 0; border-bottom: 1px dashed var(--acu-border); cursor: pointer; overflow: hidden; }\n            .acu-card-row:last-child { border-bottom: none; }\n            .acu-card-actions { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 10px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); }\n            .acu-action-item { padding: 4px 10px; font-size: 11px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.15s; white-space: nowrap; }\n            .acu-action-item:hover { background: var(--acu-btn-hover); border-color: var(--acu-accent); color: var(--acu-accent); transform: translateY(-1px); }\n            .acu-action-item:active { transform: translateY(0); }\n            .acu-action-item.check-type { border-style: dashed; }\n            .acu-action-item i { font-size: 10px; opacity: 0.7; }\n            .acu-card-row:hover { background: var(--acu-table-hover); }\n            .acu-card-label { float: left !important; clear: left; width: auto !important; margin-right: 8px !important; color: var(--acu-text-sub); font-size: 0.9em; line-height: 1.5; padding-top: 0; }\n            .acu-hide-label .acu-card-label { display: none; }\n            .acu-hide-label .acu-card-value { width: 100% !important; }\n            .acu-inline-dice-btn:hover { opacity: 1 !important; transform: scale(1.2); }\n            .acu-card-value { display: block; width: auto !important; margin: 0; text-align: left !important; word-break: break-all !important; white-space: pre-wrap !important; line-height: 1.5 !important; color: var(--acu-text-main); font-size: 1em; }\n            .acu-tag-container { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; margin-top: 2px; }\n            .acu-multi-attr-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 8px; }\n            .acu-badge { display: inline-block; padding: 1px 8px; border-radius: 12px; font-size: 0.9em; font-weight: 500; line-height: 1.2; }\n            .acu-badge-green { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-neutral { background: var(--acu-badge-bg); color: var(--acu-text-main); border: 1px solid var(--acu-border); }\n            .acu-panel-footer { flex: 0 0 auto; padding: 8px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); display: flex; justify-content: center; align-items: center; gap: 5px; flex-wrap: wrap; }\n            .acu-page-btn { padding: 4px 10px; min-width: 32px; height: 28px; border-radius: 4px; border: 1px solid var(--acu-border); background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }\n            .acu-page-btn:hover:not(.disabled):not(.active) { background: var(--acu-btn-hover); transform: translateY(-1px); }\n            .acu-page-btn.active { background: var(--acu-accent); color: var(--acu-button-text-on-accent, #fff); border-color: var(--acu-accent); font-weight: bold; }\n            .acu-page-btn.disabled { opacity: 0.5; cursor: not-allowed; }\n            .acu-page-info { font-size: 12px; color: var(--acu-text-sub); margin: 0 10px; }\n            /* --- [é‡è®¾è®¡] è¡ŒåŠ¨é€‰é¡¹é¢æ¿æ ·å¼ - å™äº‹ä¹¦é¡µé£ --- */\n            .acu-option-panel {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n                padding: 4px;\n                background: var(--acu-opt-panel-bg, var(--acu-bg-nav));\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                margin-top: 0;\n                margin-bottom: 4px;\n                width: 100%;\n                box-sizing: border-box;\n                z-index: 31001;\n                animation: acuFadeIn 0.3s ease;\n                backdrop-filter: blur(5px);\n            }\n\n            .acu-embedded-options-container {\n                width: 100%;\n                max-width: 100%;\n                margin: 12px 0;\n                padding: 0;\n                clear: both;\n                box-sizing: border-box;\n                animation: acuFadeIn 0.3s ease;\n            }\n\n            .acu-opt-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                font-size: 11px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                padding: 8px 0;\n                border-bottom: 1px solid var(--acu-border);\n                margin-bottom: 8px;\n                cursor: pointer;\n                user-select: none;\n                transition: color 0.2s;\n            }\n            .acu-opt-header:hover {\n                color: var(--acu-text-main);\n            }\n\n            /* --- [é‡è®¾è®¡] å™äº‹æ¡ç›®é£æ ¼æŒ‰é’® --- */\n            .acu-opt-btn {\n                background: var(--acu-opt-bright-bg, #ffffff);\n                border: 1px solid transparent;\n                padding: 3px 6px;\n                border-radius: 4px;\n                cursor: pointer;\n                color: var(--acu-text-main);\n                font-size: var(--acu-opt-font-size, 12px) !important;\n                transition: all 0.15s;\n                font-weight: normal;\n                text-align: left;\n                white-space: pre-wrap;\n                word-break: break-word;\n                min-height: 22px;\n                line-height: 1.3;\n                display: flex;\n                align-items: center;\n                justify-content: flex-start;\n                opacity: 1;\n            }\n            .acu-opt-btn:last-child {\n                border-bottom: none;\n            }\n            .acu-opt-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n                transform: translateX(3px);\n            }\n            .acu-opt-btn:active {\n                background: var(--acu-btn-active-bg);\n                color: var(--acu-btn-active-text);\n            }\n\n            /* --- [æ–°å¢] æŠ˜å æ€æ ·å¼ --- */\n            .acu-option-panel.collapsed .acu-opt-btn {\n                display: none;\n            }\n            .acu-option-panel.collapsed .acu-opt-header {\n                border-bottom: none;\n                margin-bottom: 0;\n            }\n            @keyframes acuFadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }\n\n            /* [æ–°å¢] éª°å­ç»“æœéšè—åŠ¨ç”»ï¼šæ¶ˆé™¤é—ªçƒ */\n            .acu-dice-result-revealing {\n                opacity: 0 !important;\n                transform: translateY(3px) !important;\n                transition: opacity 0.18s ease-out, transform 0.18s ease-out !important;\n            }\n            .acu-dice-result-revealed {\n                opacity: 1 !important;\n                transform: translateY(0) !important;\n            }\n            /* ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”»æ—¶é•¿ */\n            @media (max-width: 768px) {\n                .acu-dice-result-revealing {\n                    transition: opacity 0.15s ease-out, transform 0.15s ease-out !important;\n                }\n            }\n            /* å°Šé‡ç”¨æˆ·çš„å‡å¼±åŠ¨ç”»åå¥½è®¾ç½® */\n            @media (prefers-reduced-motion: reduce) {\n                .acu-dice-result-revealing {\n                    transition: none !important;\n                    opacity: 1 !important;\n                    transform: none !important;\n                }\n            }\n\n            .acu-menu-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: transparent; z-index: 31110 !important; }\n            /* 1. èœå•å®¹å™¨ï¼šèƒŒæ™¯è‰²ã€è¾¹æ¡†ã€é˜´å½±å…¨éƒ¨è·Ÿéšä¸»é¢˜å˜é‡ */\n.acu-cell-menu {\n    position: fixed !important;\n    background: var(--acu-menu-bg) !important;\n    border: 1px solid var(--acu-border);\n    box-shadow: 0 6px 20px var(--acu-shadow) !important;\n    z-index: 31111 !important;\n    border-radius: 8px;\n    overflow: hidden;\n    min-width: 150px;\n    color: var(--acu-menu-text);\n}\n\n/* 2. èœå•é¡¹ï¼šæ–‡å­—é¢œè‰²è·Ÿéšä¸»é¢˜ */\n.acu-cell-menu-item {\n    padding: 12px 16px;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    gap: 12px;\n    align-items: center;\n    color: var(--acu-menu-text);\n    font-weight: 500;\n    background: transparent;\n    transition: background 0.2s;\n}\n\n/* 3. æ‚¬åœæ•ˆæœï¼šä½¿ç”¨ä¸»é¢˜å®šä¹‰çš„é€šç”¨æ‚¬åœè‰² */\n.acu-cell-menu-item:hover {\n    background: var(--acu-table-hover);\n}\n\n/* 4. ç‰¹æ®ŠæŒ‰é’®ä¼˜åŒ– */\n            .acu-cell-menu-item#act-delete { color: var(--acu-error-text, #e74c3c); }\n            .acu-cell-menu-item#act-delete:hover { background: var(--acu-error-bg, rgba(231, 76, 60, 0.1)); } /* çº¢è‰²åŠé€æ˜èƒŒæ™¯ï¼Œä»»ä½•ä¸»é¢˜éƒ½é€‚é… */\n            .acu-cell-menu-item#act-close { border-top: 1px dashed var(--acu-border); color: var(--acu-text-sub); }\n            .acu-edit-overlay { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.75) !important; z-index: 31200 !important; display: flex; justify-content: center !important; align-items: center !important; backdrop-filter: blur(2px); }\n            .acu-edit-dialog { background: var(--acu-bg-panel); width: 95%; max-width: 500px; max-height: 95vh; padding: 16px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 15px 50px rgba(0,0,0,0.6); color: var(--acu-text-main); border: 1px solid var(--acu-border); overflow: hidden; flex-shrink: 0; }\n            @media (min-width: 768px) { .acu-edit-dialog { max-width: 900px; width: 90%; } .acu-edit-dialog.acu-settings-dialog { max-width: 400px; width: 400px; } }\n            .acu-edit-title { margin: 0; font-size: 16px; font-weight: bold; color: var(--acu-text-main); padding-bottom: 8px; border-bottom: 1px solid var(--acu-border); }\n            .acu-edit-icon-muted { opacity: 0.7; }\n            .acu-edit-content { background: var(--acu-bg-panel); }\n            .acu-settings-content-scroll { flex: 1; overflow-y: auto; padding: 15px; }\n            .acu-card-edit-field { margin-bottom: 10px; }\n            .acu-card-edit-label { display: block; font-size: 12px; color: var(--acu-accent); font-weight: bold; margin-bottom: 4px; }\n            .acu-card-edit-input { width: 100%; padding: 10px; border: 1px solid var(--acu-border); border-radius: 6px; background: var(--acu-input-bg); color: var(--acu-text-main); box-sizing: border-box; font-size: 14px; line-height: 1.5; }\n            .acu-card-edit-input:focus { outline: none; border-color: var(--acu-accent); }\n            .acu-card-edit-textarea { min-height: 40px; max-height: 500px; resize: none; overflow-y: hidden; }\n            .acu-edit-textarea { width: 100%; height: auto; padding: 12px; border: 1px solid var(--acu-border) !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; line-height: 1.6; overflow-y: auto !important; }\n            .acu-edit-textarea:focus { outline: none; border-color: var(--acu-accent) !important; }\n            .acu-edit-textarea::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            @media (min-width: 768px) { .acu-edit-textarea { height: auto !important; font-size: 15px !important; } }\n            .acu-edit-textarea:focus { outline: 1px solid #aaa; }\n            .acu-dialog-btns { display: flex; justify-content: flex-end; gap: 20px; margin-top: 10px; }\n            .acu-dialog-btn { background: none; border: none; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 6px; color: var(--acu-text-sub); transition: color 0.2s; }\n            .acu-dialog-btn:hover { color: var(--acu-text-main); } .acu-btn-confirm { color: var(--acu-success-text); } .acu-btn-confirm:hover { opacity: 0.8; }\n            /* --- [UI Optimization] PC-First Edit Mode Styles --- */\n            .acu-order-controls { grid-column: 1 / -1; order: -2; display: none; width: 100%; text-align: left; background: var(--acu-accent); color: var(--acu-button-text-on-accent, var(--acu-text-main)); padding: 6px 12px; margin: 0 0 8px 0; border-radius: 4px; font-weight: bold; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }\n            .acu-order-controls.visible { display: flex; align-items: center; justify-content: space-between; }\n\n            .acu-nav-container.editing-order { border: 2px solid var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-nav-container.editing-order .acu-nav-btn, .acu-nav-container.editing-order .acu-action-btn { opacity: 1 !important; cursor: grab !important; border: 1px solid var(--acu-border); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }\n            .acu-nav-container.editing-order .acu-nav-btn:hover, .acu-nav-container.editing-order .acu-action-btn:hover { border-color: var(--acu-accent); transform: translateY(-1px); }\n\n            .acu-swap-selected { background-color: var(--acu-accent) !important; color: var(--acu-button-text-on-accent, var(--acu-text-main)) !important; border-color: var(--acu-accent); box-shadow: 0 0 0 2px rgba(255,255,255,0.5), 0 4px 12px rgba(0,0,0,0.2); transform: scale(1.05); z-index: 10; }\n            .acu-drag-over { border: 2px dashed var(--acu-accent); opacity: 0.5; transform: scale(0.95); background: rgba(var(--acu-accent-rgb), 0.1); }\n\n            /* --- [PC Style] Unused Pool Optimization (å·¥å…·æ¶æ ·å¼) --- */\n            .acu-unused-pool {\n                grid-column: 1 / -1;\n                display: none;\n                flex-wrap: wrap;\n                gap: 8px;\n                background: var(--acu-table-head); /* ä½¿ç”¨è¡¨å¤´èƒŒæ™¯è‰²ï¼Œæ›´èåˆ */\n                border: 1px dashed var(--acu-border); /* è™šçº¿æ¡†è¡¨ç¤ºè¿™æ˜¯ç¼–è¾‘åŒºåŸŸ */\n                padding: 10px 15px;\n                margin: 0 0 10px 0;\n                border-radius: 8px;\n                justify-content: flex-start;\n                align-items: center;\n                min-height: 50px;\n                box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);\n            }\n            .acu-unused-pool.visible { display: flex; animation: acuFadeIn 0.2s ease-out; }\n\n            /* PCç«¯æ¸…æ™°çš„æ–‡å­—å¼•å¯¼ */\n            .acu-unused-pool::before {\n                content: "å¤‡é€‰åŠŸèƒ½æ±  (æ‹–æ‹½å›¾æ ‡åˆ°ä¸‹æ–¹å¯ç”¨ â†˜)";\n                display: flex;\n                align-items: center;\n                height: 32px;\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                margin-right: 15px;\n                padding-right: 15px;\n                border-right: 1px solid var(--acu-border);\n                white-space: nowrap;\n                opacity: 0.8;\n            }\n\n            .acu-actions-group { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 4px; border-top: 1px dashed var(--acu-border); padding-top: 8px; margin-top: 4px; min-height: 36px; transition: all 0.2s; }\n\n            /* [ä¿®å¤] ç§»åŠ¨ç«¯é¡¶éƒ¨å¸ƒå±€é€‚é…ï¼šå¼ºåˆ¶æå‡é¡ºåº */\n            .acu-pos-top .acu-actions-group { order: -1; border-top: none; border-bottom: 1px dashed var(--acu-border); margin-top: 0; margin-bottom: 6px; padding-top: 0; padding-bottom: 8px; }\n\n            /* [ä¿®å¤] ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå¤‡é€‰æ± ä¹Ÿè·Ÿéšç½®é¡¶ */\n            .acu-pos-top .acu-unused-pool { order: -1; margin-bottom: 10px; border-bottom: 1px dashed var(--acu-border); }\n            .acu-actions-group.dragging-over { background: rgba(127, 127, 127, 0.05); box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }\n\n            /* ä»ªè¡¨ç›˜æ¨ªå‘æ»šåŠ¨æ¨¡å¼ */\n                .acu-dash-body.acu-dash-horizontal {\n                    display: flex;\n                    flex-wrap: nowrap;\n                    gap: 15px;\n                    overflow-x: auto;\n                    overflow-y: hidden;\n                    padding-bottom: 10px;\n                }\n                .acu-dash-body.acu-dash-horizontal > div {\n                    flex: 0 0 280px;\n                    min-width: 280px;\n                    max-height: 60vh;\n                    overflow-y: auto;\n                }\n                @media (min-width: 769px) {\n                    .acu-dash-body.acu-dash-horizontal > div {\n                        flex: 0 0 320px;\n                        min-width: 320px;\n                    }\n                }\n            /* Mobile adjustments to keep it usable there */\n            @media (max-width: 768px) {\n                .acu-unused-pool { justify-content: center; background: rgba(0,0,0,0.05); border: 1px dashed var(--acu-border); border-bottom: none; margin: 0 0 8px 0; border-radius: 6px; }\n                .acu-unused-pool::before { display: block; width: 100%; text-align: center; margin-bottom: 4px; content: "å¯é€‰åŠŸèƒ½æ±  (æ‹–æ‹½æˆ–ç‚¹å‡»)"; }\n                .acu-order-controls { flex-direction: column; gap: 6px; text-align: center; }\n            }\n            .acu-actions-group.dragging-over { background: rgba(var(--acu-accent-rgb), 0.1); border-color: var(--acu-accent); }\n            .acu-settings-item { margin-bottom: 15px; }\n            .acu-settings-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #ccc; }\n            .acu-settings-val { float: right; color: #4cd964; font-size: 12px; }\n            .acu-slider { width: 100%; height: 4px; background: #555; border-radius: 2px; outline: none; -webkit-appearance: none; }\n            .acu-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; }\n            .acu-select { width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; border-radius: 4px; outline: none; }\n            .acu-edit-overlay input[type="checkbox"].acu-checkbox { margin-right: 10px; accent-color: var(--acu-accent) !important; background: transparent !important; background-color: transparent !important; }\n            .acu-btn-block { width: 100%; padding: 10px; background: #444; color: #eee; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }\n            .acu-btn-block:hover { background: #555; color: #fff; }\n            .acu-expand-trigger { background: var(--acu-bg-nav); border: 1px solid var(--acu-border); box-shadow: 0 2px 6px var(--acu-shadow); cursor: pointer; color: var(--acu-text-main); font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 31005 !important; }\n            .acu-expand-trigger:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n            .acu-col-bar { width: 100%; justify-content: center; padding: 8px 10px; border-radius: 6px; }\n            .acu-col-pill { width: auto !important; padding: 6px 16px; border-radius: 50px; }\n            .acu-col-mini { width: 40px !important; height: 40px !important; padding: 0; justify-content: center; border-radius: 50%; }\n            .acu-col-mini span { display: none; }\n            /* [ä¼˜åŒ–] å°çœ¼ç›å›¾æ ‡æ‚¬åœæ•ˆæœ */\n            .acu-nav-toggle-btn:hover { opacity: 1 !important; transform: translateY(-50%) scale(1.2); color: var(--acu-accent); }\n            .acu-align-right { margin-left: auto; align-self: flex-end; }\n            .acu-align-center { \n                margin-left: auto !important; \n                margin-right: auto !important; \n            }\n            .acu-align-left { margin-right: auto; margin-left: 0; align-self: flex-start; }\n            .acu-nav-container.acu-left-mode .acu-actions-group { order: -1; margin-left: 0; margin-right: 10px; }\n            #acu-btn-collapse { color: var(--acu-text-sub); }\n            #acu-btn-collapse:hover { color: var(--acu-text-main); background: rgba(0,0,0,0.05); }\n            @keyframes acu-breathe { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.85); color: #ff7e67; } 100% { opacity: 1; transform: scale(1); } } .acu-icon-breathe { animation: acu-breathe 3s infinite ease-in-out !important; display: inline-block; }\n\n            @media (min-width: 768px) {\n                .acu-wrapper.acu-mode-embedded .acu-nav-container { width: fit-content !important; min-width: 300px; max-width: 100%; margin: 0 auto; border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; border: 1px solid var(--acu-border); padding: 6px 20px; background: var(--acu-bg-nav) !important; }\n                .acu-wrapper.acu-mode-embedded .acu-data-display { bottom: calc(100% + 12px) !important; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important; }\n                .acu-nav-container { display: flex; flex-wrap: wrap !important; gap: 6px !important; padding: 6px 10px; grid-template-columns: none !important; flex-direction: row !important; justify-content: flex-start !important; align-items: center !important; height: auto !important; }\n                .acu-nav-container .acu-nav-btn { width: fit-content !important; flex: 0 0 auto !important; height: 32px !important; padding: 0 12px; font-size: 13px !important; min-width: auto !important; }\n                .acu-nav-btn span { max-width: 200px; }\n                .acu-action-btn { flex: 0 0 32px !important; width: 32px !important; height: 32px !important; background: transparent !important; color: var(--acu-text-sub) !important; border-radius: 6px; border: 1px solid transparent; }\n                .acu-action-btn:hover { background: var(--acu-btn-hover) !important; color: var(--acu-text-main) !important; transform: scale(1.1); box-shadow: none; }\n                #acu-btn-save-global { color: var(--acu-accent) !important; }\n                #acu-btn-save-global:hover { background: var(--acu-accent) !important; color: var(--acu-btn-active-text) !important; }\n                .acu-order-controls { margin: 0 0 8px 0; padding: 4px; }\n                .acu-actions-group { width: auto !important; margin-left: auto !important; border-top: none !important; border-bottom: none !important; padding: 0; margin-top: 0 !important; margin-bottom: 0 !important; gap: 4px !important; background: transparent; justify-content: flex-end; order: 9999 !important; display: flex; }\n                .acu-pos-top .acu-actions-group { order: -1 !important; margin-left: 0 !important; margin-right: 10px !important; justify-content: flex-start !important; }\n            }\n            @media (max-width: 768px) {\n                .acu-panel-content { -webkit-overflow-scrolling: touch !important; overscroll-behavior-y: auto; }\n                .acu-data-card { box-shadow: none !important; border: 1px solid var(--acu-border); transform: translateZ(0); }\n                .acu-data-card:hover { transform: none !important; box-shadow: none !important; }\n                .acu-nav-btn:hover { transform: none !important; }\n            }\n            /* === ç§»åŠ¨ç«¯æŠ•éª°é¢æ¿é€‚é… === */\n            @media (max-width: 768px) {\n                .acu-dice-panel, .acu-contest-panel {\n                    position: relative !important;\n                    top: auto !important;\n                    left: auto !important;\n                    transform: none !important;\n                    width: 92vw !important;\n                    max-width: 400px !important;\n                    max-height: calc(100vh - 32px) !important;\n                    max-height: calc(100dvh - 32px) !important;\n                }\n                .acu-dice-overlay, .acu-contest-overlay {\n                    align-items: center !important;\n                    padding: 16px !important;\n                }\n            }\n                /* === ä»ªè¡¨ç›˜æ–°å¢æ ·å¼ï¼šå¯å±•å¼€åœ°ç‚¹åˆ—è¡¨ === */\n                .acu-dash-body {\n                    display: grid;\n                    grid-template-columns: 1fr 1.2fr 1fr;\n                    gap: 15px;\n                    margin: 15px 0;\n                }\n\n                .acu-dash-locations {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-locations h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-location-group {\n                    margin-bottom: 8px;\n                    border-radius: 6px;\n                    overflow: hidden;\n                    background: var(--acu-card-bg);\n                    border: 1px solid transparent;\n                    transition: all 0.2s;\n                }\n\n                .acu-location-group.expanded {\n                    border-color: var(--acu-accent);\n                }\n\n                .acu-location-header {\n                    padding: 8px 10px;\n                    cursor: pointer;\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                    background: var(--acu-table-head);\n                    transition: all 0.2s;\n                    user-select: none;\n                }\n\n                .acu-location-header:hover {\n                    background: var(--acu-table-hover);\n                }\n\n                .acu-expand-icon {\n                    font-size: 10px;\n                    transition: transform 0.2s;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-group.expanded .acu-expand-icon {\n                    transform: rotate(90deg);\n                    color: var(--acu-accent);\n                }\n\n                .acu-region-name {\n                    flex: 1;\n                    font-weight: bold;\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-location-count {\n                    font-size: 11px;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-list {\n                    max-height: 0;\n                    overflow: hidden;\n                    transition: max-height 0.3s ease;\n                }\n\n                .acu-location-group.expanded .acu-location-list {\n                    max-height: 500px;\n                }\n\n                .acu-location-item {\n                    padding: 6px 10px 6px 26px;\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                    font-size: 12px;\n                    border-bottom: 1px dashed rgba(0,0,0,0.05);\n                    transition: all 0.15s;\n                }\n\n                /* ä»ªè¡¨ç›˜åœ°ç‚¹åç§°å•è¡Œçœç•¥æ ·å¼ */\n                .acu-dash-locations .acu-location-item {\n                    padding: 4px 8px !important;\n                    min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */\n                    overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */\n                    align-items: center;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child {\n                    display: flex !important;\n                    align-items: center;\n                    gap: 6px;\n                    flex: 1;\n                    min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */\n                    overflow: hidden;\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child i {\n                    flex-shrink: 0; /* å›¾æ ‡ä¸æ”¶ç¼© */\n                    font-size: 9px;\n                    opacity: 0.4;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-dash-locations .acu-location-item > i {\n                    margin-left: auto;\n                    width: 14px;\n                    text-align: center;\n                    font-size: 10px;\n                    opacity: 0.4;\n                    color: var(--acu-text-sub);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    line-height: 1;\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child > span {\n                    white-space: nowrap;\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    flex: 1;\n                    min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */\n                }\n\n                .acu-location-item:last-child {\n                    border-bottom: none;\n                }\n\n                .acu-location-item:hover {\n                    background: var(--acu-table-hover);\n                    transform: translateX(4px);\n                }\n\n                .acu-location-item.current {\n                    background: var(--acu-hl-diff-bg);\n                }\n\n                .acu-location-item i {\n                    font-size: 10px;\n                    opacity: 0.6;\n                }\n\n                .acu-current-badge {\n                    margin-left: auto;\n                    font-size: 10px;\n                    padding: 2px 6px;\n                    background: var(--acu-btn-active-bg);\n                    color: var(--acu-btn-active-text);\n                    border-radius: 3px;\n                    font-weight: bold;\n                }\n                /* === ä»ªè¡¨ç›˜æ ¸å¿ƒæ ·å¼ï¼ˆè¡¥å……ï¼‰ === */\n                .acu-dash-context {\n                    background: linear-gradient(135deg, var(--acu-table-head), var(--acu-bg-panel));\n                    padding: 15px;\n                    border-radius: 8px;\n                    margin-bottom: 15px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-location {\n                    font-size: 18px;\n                    font-weight: bold;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                }\n\n                .acu-dash-location-desc {\n                    font-size: 13px;\n                    color: var(--acu-text-sub);\n                    margin-top: 6px;\n                    line-height: 1.5;\n                }\n\n                .acu-dash-player, .acu-dash-intel {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-player h3, .acu-dash-intel h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-player-status {\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-task-item {\n                    padding: 8px;\n                    margin-bottom: 6px;\n                    background: rgba(0,0,0,0.03);\n                    border-radius: 6px;\n                    border-left: 3px solid var(--acu-border);\n                }\n\n                .acu-task-name {\n                    font-size: 13px;\n                    font-weight: 500;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-empty-hint {\n                    font-size: 11px;\n                    color: var(--acu-text-sub);\n                    text-align: center;\n                    padding: 15px;\n                    opacity: 0.7;\n                    grid-column: 1 / -1;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                }\n                /* ä»ªè¡¨ç›˜ä¸­æœ‰å›ºå®šé«˜åº¦å®¹å™¨çš„ç©ºçŠ¶æ€å±…ä¸­ */\n                .acu-player-status .acu-empty-hint,\n                .acu-dash-locations > div .acu-empty-hint {\n                    height: 100%;\n                    min-height: inherit;\n                }\n                /* å®¡æ ¸é¢æ¿ç©ºçŠ¶æ€å±…ä¸­ */\n                .acu-changes-content .acu-empty-hint {\n                    flex: 1;\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    justify-content: center;\n                    min-height: 200px;\n                }\n\n                .acu-dashboard-content {\n                    padding: 15px;\n                    overflow-y: auto !important;\n                    overflow-x: hidden !important;\n                    -webkit-overflow-scrolling: touch !important;\n                    touch-action: pan-y !important;\n                    overscroll-behavior-y: contain;\n                    max-height: calc(80vh - 60px);\n                }\n\n                /* === ä»ªè¡¨ç›˜äº¤äº’æŒ‰é’®ä¼˜åŒ– === */\n                h3.acu-dash-table-link,\n                h4.acu-dash-table-link {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    padding: 2px 4px;\n                    margin: -2px -4px;\n                    border-radius: 4px;\n                }\n                h3.acu-dash-table-link:hover,\n                h4.acu-dash-table-link:hover {\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                }\n\n                /* ä»ªè¡¨ç›˜æ“ä½œå›¾æ ‡ - ç»Ÿä¸€æ”¾å¤§+å¢åŠ ç‚¹å‡»çƒ­åŒº */\n                .acu-dash-dice-btn,\n                .acu-dash-goto-btn,\n                .acu-dash-use-item-btn,\n                .acu-dash-use-skill-btn,\n                .acu-dash-track-task-btn,\n                .acu-dash-msg-btn,\n                .acu-dash-contest-btn,\n                .acu-dash-dice-free,\n                .acu-dash-relation-graph-btn,\n                .acu-dash-avatar-manager-btn {\n                    cursor: pointer;\n                    color: var(--acu-text-sub);\n                    opacity: 0.5;\n                    font-size: 14px !important;\n                    padding: 6px;\n                    margin: -4px;\n                    border-radius: 4px;\n                    transition: all 0.15s;\n                    display: inline-flex;\n                    align-items: center;\n                    justify-content: center;\n                    min-width: 28px;\n                    min-height: 28px;\n                }\n                .acu-dash-dice-btn:hover,\n                .acu-dash-goto-btn:hover,\n                .acu-dash-use-item-btn:hover,\n                .acu-dash-use-skill-btn:hover,\n                .acu-dash-track-task-btn:hover,\n                .acu-dash-msg-btn:hover,\n                .acu-dash-contest-btn:hover,\n                .acu-dash-dice-free:hover {\n                    opacity: 1;\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                    transform: scale(1.1);\n                }\n\n                /* ä»ªè¡¨ç›˜å¯ç‚¹å‡»é¡¹ - å¢å¼ºåé¦ˆ */\n                .acu-dash-clickable {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    border-radius: 4px;\n                }\n                .acu-dash-clickable:hover {\n                    background: var(--acu-table-hover);\n                }\n                .acu-dash-clickable:active {\n                    transform: scale(0.98);\n                }\n\n                @media (max-width: 768px) {\n                    .acu-dash-body {\n                        grid-template-columns: 1fr;\n                        max-height: none;\n                        overflow: visible;\n                    }\n\n                    .acu-dashboard-content {\n                        max-height: calc(75vh - 50px) !important;\n                        padding-bottom: 20px !important;\n                    }\n\n                    /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥æ”¾å¤§æ“ä½œæŒ‰é’® */\n                    .acu-dash-dice-btn,\n                    .acu-dash-goto-btn,\n                    .acu-dash-use-item-btn,\n                    .acu-dash-use-skill-btn,\n                    .acu-dash-track-task-btn,\n                    .acu-dash-msg-btn,\n                    .acu-dash-contest-btn,\n                    .acu-dash-dice-free {\n                        font-size: 16px !important;\n                        padding: 8px;\n                        min-width: 36px;\n                        min-height: 36px;\n                    }\n                }\n            /* === ä»ªè¡¨ç›˜é¢„è§ˆå¡ç‰‡æ ·å¼ === */\n            .acu-preview-overlay {\n                z-index: 31100;\n                backdrop-filter: blur(3px);\n                animation: acuFadeIn 0.2s ease;\n            }\n\n                .acu-preview-overlay .acu-data-card {\n                    width: 90vw;\n                    max-width: 400px;\n                    flex: none;\n                }\n                @media (min-width: 768px) {\n                    .acu-preview-overlay .acu-data-card {\n                        max-width: 550px;\n                    }\n                }\n\n            .acu-preview-close:hover {\n                background: var(--acu-error-bg, rgba(231, 76, 60, 0.1));\n                color: var(--acu-error-text, #e74c3c);\n            }\n\n            .acu-dash-clickable {\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n\n            .acu-dash-clickable:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-current-location span {\n                color: inherit;\n                font-weight: inherit;\n            }\n            .acu-current-location i {\n                color: inherit;\n            }\n            .acu-current-location > span:first-child > span {\n                font-weight: 600;\n            }\n            /* === è‡ªå®šä¹‰ä¸‹æ‹‰èœå•æ ·å¼ === */\n            .acu-dropdown-wrapper { position: relative; width: 100%; }\n            .acu-dropdown-list {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                max-height: 150px;\n                overflow-y: auto;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                z-index: 31105;\n                display: none;\n            }\n            .acu-dropdown-list.visible { display: block; }\n            .acu-dropdown-item {\n                padding: 6px 10px;\n                font-size: 12px;\n                cursor: pointer;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                background: transparent;\n                color: var(--acu-text-main);\n                transition: background 0.1s;\n            }\n            .acu-dropdown-item:hover {\n                background: var(--acu-table-head);\n            }\n            .acu-dropdown-empty {\n                padding: 8px 10px;\n                font-size: 12px;\n                text-align: center;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            /* === è¾“å…¥æ¡†æ¸…é™¤æŒ‰é’®æ ·å¼ === */\n            .acu-input-wrapper { position: relative; display: flex; align-items: center; width: 100%; }\n            .acu-input-wrapper input { padding-right: 24px !important; }\n            .acu-clear-btn { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background: transparent !important; border: none !important; font-size: 12px; cursor: pointer; padding: 4px; line-height: 1; opacity: 0.5; transition: opacity 0.2s, color 0.2s; z-index: 5; color: var(--acu-text-sub); }\n            .acu-clear-btn:hover { background: transparent !important; border: none !important; opacity: 1 !important; color: var(--acu-accent) !important; }\n\n            /* === ç»“æœå¾½ç« æ ·å¼ === */\n            .acu-result-badge {\n                padding: 3px 8px;\n                border-radius: 6px;\n                font-size: 11px;\n                font-weight: bold;\n                white-space: nowrap;\n                display: inline-flex;\n                align-items: center;\n                border: 1px solid transparent;\n            }\n            .acu-result-badge-crit-success { background-color: var(--acu-crit-success-bg); color: var(--acu-crit-success-text); border-color: var(--acu-crit-success-bg); }\n            .acu-result-badge-extreme-success { background-color: var(--acu-extreme-success-bg); color: var(--acu-extreme-success-text); border-color: var(--acu-extreme-success-bg); }\n            .acu-result-badge-success { background-color: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-bg); }\n            .acu-result-badge-warning { background-color: var(--acu-warning-bg); color: var(--acu-warning-text); border-color: var(--acu-warning-bg); }\n            .acu-result-badge-failure { background-color: var(--acu-failure-bg); color: var(--acu-failure-text); border-color: var(--acu-failure-bg); }\n            .acu-result-badge-crit-failure { background-color: var(--acu-crit-failure-bg); color: var(--acu-crit-failure-text); border-color: var(--acu-crit-failure-bg); }\n\n            /* === é¢„è®¾æŒ‰é’®æ ·å¼ === */\n            .acu-dice-preset, .acu-contest-preset {\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                border: 1px solid var(--acu-border);\n                padding: 4px 8px;\n                border-radius: 4px;\n                font-size: 11px;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-dice-preset:hover, .acu-contest-preset:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-dice-preset.active, .acu-contest-preset.active {\n                background: var(--acu-accent);\n                color: var(--acu-button-text-on-accent, #fff);\n                border-color: var(--acu-accent);\n            }\n            .acu-dice-preset.active:hover, .acu-contest-preset.active:hover {\n                background: var(--acu-accent);\n                color: var(--acu-button-text-on-accent, #fff);\n                filter: brightness(1.1);\n            }\n\n            /* === éª°å­ç»“æœæ˜¾ç¤ºåŒºåŸŸ === */\n            .acu-dice-result-display {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 100%;\n                gap: 8px;\n            }\n            .acu-dice-result-value {\n                font-size: 22px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-dice-result-target {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                opacity: 0.9;\n            }\n            .acu-dice-retry-btn {\n                background: transparent !important;\n                border: none !important;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                padding: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                opacity: 0.8;\n                transition: opacity 0.2s;\n            }\n            .acu-dice-retry-btn:hover {\n                opacity: 1;\n                color: var(--acu-accent);\n            }\n\n            /* === å¯¹æˆ˜ç»“æœæ˜¾ç¤ºåŒºåŸŸ === */\n            .acu-contest-result-display {\n                display: none;\n                margin-bottom: 10px;\n            }\n            .acu-contest-result-container {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                cursor: pointer;\n            }\n            .acu-contest-result-row {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 12px;\n                padding: 12px 16px;\n                background: var(--acu-light-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                transition: all 0.2s;\n            }\n            .acu-contest-result-row:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-accent);\n            }\n            .acu-contest-result-winner-row {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                padding: 10px 16px;\n                background: var(--acu-light-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                transition: all 0.2s;\n            }\n            .acu-contest-result-winner-row:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-accent);\n            }\n            .acu-contest-reroll-icon {\n                font-size: 14px;\n                color: var(--acu-text-sub);\n                transition: all 0.2s;\n            }\n            .acu-contest-result-winner-row:hover .acu-contest-reroll-icon {\n                color: var(--acu-accent);\n                transform: rotate(90deg);\n            }\n            .acu-contest-result-inner {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 12px;\n                flex: 1;\n            }\n            .acu-contest-result-side {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-contest-result-side.right {\n                flex-direction: row-reverse;\n            }\n            .acu-contest-vs {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                padding: 0 4px;\n            }\n            .acu-contest-result-name {\n                font-size: 10px;\n                color: var(--acu-text-main);\n                opacity: 0.9;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                max-width: 4em;\n                text-align: center;\n            }\n            .acu-contest-result-value {\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-contest-winner-text {\n                font-size: 14px;\n                font-weight: bold;\n            }\n            .acu-contest-winner-success { color: var(--acu-success-text); }\n            .acu-contest-winner-warning { color: var(--acu-warning-text); }\n            .acu-contest-winner-failure { color: var(--acu-failure-text); }\n\n            /* === å…³ç³»å›¾æ»‘å—å®¹å™¨ === */\n            .acu-node-size-slider-container {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n            }\n            .acu-node-size-slider-container .acu-slider-label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                white-space: nowrap;\n            }\n            .acu-node-size-slider-container .acu-slider-value {\n                font-size: 11px;\n                color: var(--acu-accent);\n                font-weight: bold;\n                min-width: 35px;\n                text-align: right;\n            }\n            .acu-node-size-slider-container input[type="range"] {\n                background: var(--acu-btn-bg);\n            }\n\n            /* === å…³ç³»å›¾è¿‡æ»¤æŒ‰é’® === */\n            .acu-graph-filter-btn {\n                transition: all 0.15s;\n            }\n            .acu-graph-filter-btn.active {\n                background: var(--acu-accent) !important;\n                color: var(--acu-button-text-on-accent, #fff) !important;\n                border-color: var(--acu-accent) !important;\n            }\n\n            /* === å…³ç³»å›¾ç®­å¤´æ ‡è®° - ä½¿ç”¨ CSS å˜é‡ === */\n            .acu-graph-svg #arrowhead-end polygon,\n            .acu-graph-svg #arrowhead-start polygon {\n                fill: var(--acu-text-sub);\n            }\n            .acu-graph-svg #arrowhead-end-hl polygon,\n            .acu-graph-svg #arrowhead-start-hl polygon {\n                fill: var(--acu-accent);\n            }\n\n            /* === å¯¼å…¥æç¤ºæ ·å¼ === */\n            .acu-import-empty {\n                text-align: center;\n                padding: 20px;\n                color: var(--acu-text-sub);\n            }\n            .acu-import-warning {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-import-warning i {\n                color: var(--acu-warning-icon, #f39c12);\n            }\n            .acu-import-success {\n                text-align: center;\n                padding: 10px;\n                color: var(--acu-success-text);\n            }\n\n            /* ========== äººç‰©å…³ç³»å›¾æ ·å¼ ========== */\n            .acu-relation-graph-overlay {\n                background: rgba(0,0,0,0.8);\n                z-index: 31100;\n                backdrop-filter: blur(4px);\n            }\n            .acu-relation-graph-container {\n                width: 95%;\n                max-width: 900px;\n                height: 85vh;\n                max-height: 700px;\n            }\n            .acu-graph-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-graph-actions {\n                display: flex;\n                gap: 8px;\n            }\n            .acu-graph-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-graph-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-graph-canvas-wrapper {\n                flex: 1;\n                overflow: hidden;\n                position: relative;\n                min-height: 0;\n            }\n            .acu-graph-svg {\n                width: 100%;\n                height: 100%;\n                cursor: grab;\n            }\n            .acu-graph-svg:active { cursor: grabbing; }\n            .acu-graph-edge {\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                opacity: 0.6;\n            }\n            .acu-graph-edge-label {\n                font-size: 11px;\n                fill: var(--acu-text-sub);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-graph-node { cursor: grab; }\n            .acu-graph-node:active { cursor: grabbing; }\n            .acu-node-bg {\n                fill: var(--acu-btn-bg);\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                transition: all 0.2s;\n            }\n            .acu-node-bg.player {\n                fill: var(--acu-accent);\n                stroke: var(--acu-btn-active-text);\n            }\n            .acu-graph-node:hover .acu-node-bg {\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n                filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));\n            }\n            .acu-graph-node:hover .acu-node-avatar {\n                box-shadow: 0 0 0 2px var(--acu-accent);\n            }\n            .acu-graph-svg.highlighting .acu-graph-node {\n                opacity: 0.2;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted {\n                opacity: 1;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted .acu-node-bg {\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted .acu-node-avatar {\n                box-shadow: 0 0 0 2px var(--acu-accent);\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge.highlighted {\n                opacity: 1;\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label.highlighted {\n                opacity: 1;\n                fill: var(--acu-accent);\n                font-weight: bold;\n            }\n            .acu-node-char {\n                font-size: 16px;\n                font-weight: bold;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-bg.player + text.acu-node-char,\n            .acu-node-bg.player ~ text.acu-node-char {\n                fill: var(--acu-btn-active-text);\n            }\n            .acu-node-label {\n                font-size: 12px;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-inscene-indicator {\n                fill: var(--acu-accent);\n                stroke: var(--acu-bg-panel);\n                stroke-width: 2;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));\n            }\n            .acu-graph-legend {\n                display: flex;\n                gap: 16px;\n                justify-content: center;\n                padding: 10px;\n                border-top: 1px solid var(--acu-border);\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n            }\n            .acu-graph-legend span {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-zoom-display {\n                background: var(--acu-btn-bg);\n                padding: 2px 8px;\n                border-radius: 4px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                min-width: 45px;\n                text-align: center;\n            }\n            .acu-node-size-slider-container input[type="range"] {\n                -webkit-appearance: none;\n                appearance: none;\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n                outline: none;\n                cursor: pointer;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb {\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-track {\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n            }\n            @media (max-width: 768px) {\n                .acu-relation-graph-container {\n                    width: 100%;\n                    height: 80vh;\n                    max-height: none;\n                    border-radius: 12px;\n                }\n                .acu-graph-legend {\n                    gap: 8px;\n                    flex-wrap: nowrap;\n                    padding: 8px 6px;\n                }\n            }\n\n            /* ========== åœ°å›¾å¯è§†åŒ–æ ·å¼ ========== */\n            .acu-map-overlay {\n                background: rgba(0,0,0,0.8);\n                z-index: 31100;\n                backdrop-filter: blur(4px);\n            }\n            .acu-map-container {\n                width: 95%;\n                max-width: 500px;\n                max-height: 85vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n                box-shadow: 0 10px 40px rgba(0,0,0,0.45);\n            }\n            .acu-map-title {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                white-space: nowrap;\n                flex-shrink: 0;\n            }\n            .acu-map-actions {\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-map-actions button {\n                width: 28px;\n                height: 28px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n            }\n            .acu-map-actions button:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n            .acu-map-body {\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                padding: 12px;\n                overflow: hidden;\n            }\n            /* ç„¦ç‚¹åŒºåŸŸ - 3åˆ—Gridå¸ƒå±€ */\n            .acu-map-focus-area {\n                display: grid;\n                grid-template-columns: 1fr auto 1fr;\n                gap: 12px;\n                align-items: center;\n                border: 1px dashed var(--acu-border);\n                border-radius: 12px;\n                padding: 16px;\n                background: var(--acu-btn-bg);\n            }\n\n            /* ä¾§ç¿¼ */\n            .acu-map-wing {\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                min-width: 0;\n                align-self: flex-start; /* ä¾§ç¿¼é¡¶éƒ¨å¯¹é½ */\n            }\n            .acu-map-wing.left { align-items: flex-end; text-align: right; }\n            .acu-map-wing.right { align-items: flex-start; text-align: left; }\n\n            .acu-map-mobile-stack {\n                display: none;\n            }\n\n            /* å¤´åƒç»„ */\n            .acu-map-avatar-group {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 6px;\n                align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */\n                min-height: 70px; /* ç¡®ä¿æœ‰æœ€å°é«˜åº¦ */\n            }\n            .acu-map-wing.left .acu-map-avatar-group { justify-content: flex-end; }\n            .acu-map-wing.right .acu-map-avatar-group { justify-content: flex-start; }\n\n            /* å¤´åƒæ™ºèƒ½å †å  */\n            .acu-map-wing.left .acu-map-avatar:not(:last-child) { margin-right: -12px; }\n            .acu-map-wing.right .acu-map-avatar:not(:first-child) { margin-left: -12px; }\n            .acu-map-avatar:hover { transform: scale(1.1); z-index: 10; position: relative; }\n\n            .acu-map-avatar {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 4px;\n                min-width: 56px;\n                cursor: pointer;\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            .acu-map-avatar-circle {\n                width: 46px;\n                height: 46px;\n                border-radius: 50%;\n                border: 2px solid var(--acu-accent);\n                background: var(--acu-btn-bg);\n                background-size: cover;\n                background-position: center;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--acu-text-sub);\n                font-weight: bold;\n                font-size: 16px;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n            .acu-map-avatar-name {\n                font-size: 11px;\n                color: var(--acu-text-main);\n                text-shadow: 0 1px 2px rgba(0,0,0,0.3);\n            }\n\n            /* å…ƒç´ ç»„ */\n            .acu-map-element-group {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                max-width: 140px;\n            }\n            .acu-map-element-chip {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                padding: 4px 8px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-bg-panel);\n                font-size: 11px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                transition: all 0.15s;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-map-element-chip:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n                transform: translateX(2px);\n            }\n\n            /* ä¸­å¤®èˆå° */\n            .acu-map-stage-center {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                min-width: 100px;\n                z-index: 2;\n                cursor: pointer;\n            }\n\n            /* é€æ˜èƒŒæ™¯å¤§å·Emoji */\n            .acu-map-location-emoji {\n                background: transparent;\n                border: none;\n                width: auto;\n                height: auto;\n                font-size: 4rem;\n                line-height: 1;\n                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));\n                transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            .acu-map-location-emoji:hover { transform: scale(1.1) rotate(5deg); }\n\n            /* æ— emojiæ—¶çš„æ–‡å­—å ä½ */\n            .acu-map-location-text {\n                width: 64px;\n                height: 64px;\n                border-radius: 12px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 28px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n            }\n\n            /* åœ°ç‚¹å */\n            .acu-map-location-name {\n                margin-top: 8px;\n                font-weight: 700;\n                font-size: 1.1em;\n                max-width: 140px;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                color: var(--acu-text-main);\n            }\n\n            /* ç¼©ç•¥å›¾æ ·å¼ */\n            .acu-map-thumbnails {\n                display: grid;\n                grid-template-columns: repeat(3, minmax(0, 1fr));\n                gap: 12px;\n                max-height: 50vh;\n                overflow-y: auto;\n                overflow-x: hidden;\n                padding: 12px;\n                box-sizing: border-box;\n            }\n            .acu-map-thumbnail {\n                position: relative;\n                border: 1px solid var(--acu-border);\n                border-radius: 10px;\n                padding: 8px;\n                background: var(--acu-btn-bg);\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 4px;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-map-thumbnail.active {\n                border-color: var(--acu-accent);\n                box-shadow: 0 0 0 1px var(--acu-accent);\n            }\n            .acu-map-thumbnail:hover {\n                border-color: var(--acu-accent);\n                transform: translateY(-2px);\n            }\n            .acu-map-thumbnail-emoji {\n                width: 36px;\n                height: 36px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 24px;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));\n            }\n            .acu-map-thumbnail-placeholder {\n                width: 36px;\n                height: 36px;\n                border-radius: 8px;\n                background: var(--acu-bg-panel);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                border: 1px solid var(--acu-border);\n            }\n            .acu-map-thumbnail-name { font-size: 11px; color: var(--acu-text-main); }\n\n            /* è§’æ ‡ */\n            .acu-map-thumbnail-badge {\n                position: absolute;\n                top: -8px;\n                right: -8px;\n                min-width: 22px;\n                height: 22px;\n                padding: 0 6px;\n                border-radius: 99px;\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                font-size: 0.75rem;\n                font-weight: 800;\n                font-variant-numeric: tabular-nums;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                box-shadow: 0 3px 6px rgba(0,0,0,0.25);\n                border: 3px solid var(--acu-btn-bg);\n                z-index: 10;\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n\n            .acu-map-thumbnail:hover .acu-map-thumbnail-badge {\n                transform: scale(1.1);\n            }\n\n            /* åœ°åŒºæ ‡ç­¾é¡µ */\n            .acu-map-region-tabs {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 4px;\n                margin-left: auto;\n                margin-right: 8px;\n            }\n            .acu-map-region-tab {\n                padding: 4px 10px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-map-region-tab.active,\n            .acu-map-region-tab:hover {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n            }\n\n            .acu-map-empty {\n                text-align: center;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                padding: 8px 0;\n            }\n            .acu-map-loading {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                padding: 40px;\n                width: 100%;\n            }\n            .acu-map-spinner {\n                width: 32px;\n                height: 32px;\n                border: 3px solid var(--acu-border);\n                border-top-color: var(--acu-accent);\n                border-radius: 50%;\n                animation: acu-map-spin 0.8s linear infinite;\n            }\n            @keyframes acu-map-spin { to { transform: rotate(360deg); } }\n            @media (max-width: 768px) {\n                .acu-map-container {\n                    width: 96%;\n                    max-height: 92vh;\n                }\n                .acu-map-focus-area {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 12px;\n                    padding: 16px 12px;\n                    background: var(--acu-btn-bg);\n                }\n                .acu-map-stage-center {\n                    width: 100%;\n                    margin-bottom: 4px;\n                    flex-direction: row;\n                    justify-content: center;\n                    gap: 12px;\n                }\n                .acu-map-location-emoji {\n                    font-size: 2.5rem;\n                    width: 48px;\n                    height: 48px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                }\n                .acu-map-location-text {\n                    width: 48px;\n                    height: 48px;\n                    font-size: 20px;\n                }\n                .acu-map-location-name {\n                    margin-top: 0;\n                    font-size: 1.25rem;\n                    max-width: none;\n                    text-align: left;\n                    align-self: center;\n                }\n                .acu-map-wing {\n                    display: none;\n                }\n                .acu-map-mobile-stack {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 10px;\n                    width: 100%;\n                }\n                .acu-map-mobile-avatars,\n                .acu-map-mobile-elements {\n                    display: flex;\n                    flex-wrap: wrap;\n                    justify-content: center;\n                    gap: 8px;\n                    max-height: 168px;\n                    overflow-y: auto;\n                    padding: 2px 4px;\n                }\n                .acu-map-mobile-avatars:empty,\n                .acu-map-mobile-elements:empty {\n                    display: none;\n                }\n                .acu-map-avatar {\n                    min-width: auto;\n                    width: 52px;\n                }\n                .acu-map-avatar-circle {\n                    width: 42px;\n                    height: 42px;\n                }\n                .acu-map-element-chip {\n                    font-size: 12px;\n                    padding: 6px 10px;\n                    background: var(--acu-bg-panel);\n                }\n                .acu-map-thumbnails {\n                    grid-template-columns: repeat(3, minmax(0, 1fr));\n                    gap: 10px;\n                }\n            }\n\n            /* ========== å¤´åƒç®¡ç†å¼¹çª—æ ·å¼ ========== */\n            .acu-avatar-manager-overlay {\n                background: rgba(0,0,0,0.7);\n                z-index: 31300;\n            }\n            .acu-avatar-manager {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n            }\n            .acu-avatar-title {\n                font-size: 15px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-avatar-header-actions {\n                display: flex;\n                gap: 4px;\n                align-items: center;\n            }\n            .acu-avatar-list {\n                flex: 1;\n                overflow-y: auto;\n                padding: 12px;\n                min-height: 0;\n            }\n            .acu-avatar-file-input,\n            #acu-avatar-file-input {\n                display: none;\n            }\n            .acu-avatar-item {\n                display: flex;\n                align-items: flex-start;\n                gap: 12px;\n                padding: 10px;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .acu-avatar-item:last-child { border-bottom: none; }\n            .acu-avatar-preview {\n                width: 48px;\n                height: 48px;\n                border-radius: 50%;\n                background: var(--acu-btn-bg);\n                background-size: cover;\n                background-position: center;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                border: 2px solid var(--acu-border);\n                flex-shrink: 0;\n                position: relative;\n                cursor: pointer;\n            }\n            .acu-avatar-preview.has-image {\n                background-image: var(--acu-avatar-image);\n                background-position: var(--acu-avatar-x, 50%) var(--acu-avatar-y, 50%);\n                background-size: var(--acu-avatar-scale, 150%);\n                background-repeat: no-repeat;\n            }\n            .acu-avatar-preview span {\n                font-size: 18px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-camera-hint {\n                position: absolute;\n                bottom: 2px;\n                right: 2px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                opacity: 0.5;\n                pointer-events: none;\n            }\n            .acu-avatar-preview:hover .acu-avatar-camera-hint {\n                opacity: 0.8;\n                color: var(--acu-accent);\n            }\n            .acu-avatar-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-avatar-name {\n                font-size: 13px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-avatar-name-row {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-url,\n            .acu-avatar-manager-overlay input.acu-avatar-aliases {\n                width: 100%;\n                padding: 6px 8px;\n                font-size: 12px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-main) !important;\n                box-sizing: border-box;\n                -webkit-appearance: none;\n                appearance: none;\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-url:focus,\n            .acu-avatar-manager-overlay input.acu-avatar-aliases:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n                box-shadow: none !important;\n            }\n            /* å¤´åƒè¾“å…¥è¡Œï¼ˆURL + ä¸Šä¼ æŒ‰é’®ï¼‰ */\n            .acu-avatar-input-row {\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-avatar-input-row .acu-avatar-url {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-avatar-upload-btn {\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                flex-shrink: 0;\n                transition: all 0.15s;\n            }\n            .acu-avatar-upload-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n            .acu-avatar-upload-btn:active {\n                transform: scale(0.95);\n            }\n            /* å¤´åƒæ¥æºæ ‡ç­¾ */\n            .acu-avatar-source {\n                position: absolute;\n                bottom: -10px;\n                left: 50%;\n                transform: translateX(-50%);\n                font-size: 9px;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-weight: bold;\n                white-space: nowrap;\n            }\n            .acu-avatar-preview-wrap {\n                position: relative;\n                flex-shrink: 0;\n            }\n            .acu-source-local,\n            .acu-source-url,\n            .acu-source-auto {\n                background: var(--acu-badge-bg);\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-aliases {\n                padding: 4px 8px;\n                font-size: 11px;\n                margin-top: 4px;\n            }\n            .acu-avatar-manager-overlay input::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7;\n            }\n            .acu-avatar-actions {\n                display: flex;\n                flex-direction: row;\n                gap: 4px;\n                flex-shrink: 0;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-actions button {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-sub) !important;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-actions button:hover {\n                background: var(--acu-btn-hover) !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-avatar-save-btn:hover { color: var(--acu-success-text, #27ae60) !important; }\n            .acu-avatar-clear-btn:hover { color: var(--acu-error-text, #e74c3c) !important; }\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 12px;\n                transition: all 0.2s;\n            }\n            .acu-avatar-import-btn:hover,\n            .acu-avatar-export-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-avatar-crop-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-top: 6px;\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-crop-row.hidden { display: none; }\n            .acu-avatar-manager-overlay .acu-avatar-scale {\n                flex: 1;\n                height: 6px !important;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n                margin: 0 8px;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-runnable-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer !important;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;\n                margin-top: -5px !important;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-thumb {\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                border: 2px solid var(--acu-bg-panel);\n                cursor: pointer !important;\n            }\n            @media (max-width: 768px) {\n                .acu-avatar-manager {\n                    width: 95%;\n                    max-height: 85vh;\n                }\n            }\n\n            /* ========== å¯¼å…¥ç¡®è®¤å¼¹çª—æ ·å¼ ========== */\n            .acu-import-confirm-overlay {\n                z-index: 31400;\n            }\n            .acu-import-confirm-dialog {\n                width: 90%;\n                max-width: 360px;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n                overflow: hidden;\n            }\n            .acu-import-confirm-header {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-import-confirm-header i {\n                font-size: 16px;\n            }\n            .acu-import-confirm-body {\n                padding: 20px;\n            }\n            .acu-import-stats {\n                display: flex;\n                justify-content: space-around;\n                margin-bottom: 16px;\n            }\n            .acu-import-stat {\n                text-align: center;\n            }\n            .acu-stat-num {\n                display: block;\n                font-size: 24px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-stat-label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-stat-new .acu-stat-num { color: var(--acu-success-text); }\n            .acu-stat-conflict .acu-stat-num { color: #e67e22; }\n            .acu-import-conflict-section {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-import-cancel-btn,\n            .acu-import-confirm-btn {\n                flex: 1;\n                padding: 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: bold;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-import-cancel-btn {\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-import-cancel-btn:hover {\n                background: var(--acu-btn-hover) !important;\n            }\n            .acu-import-confirm-btn {\n                background: var(--acu-accent) !important;\n                border: none !important;\n                color: var(--acu-btn-active-text) !important;\n            }\n            .acu-import-confirm-btn:hover {\n                opacity: 0.85 !important;\n                background: var(--acu-accent) !important;\n            }\n            /* ========== é¢„è®¾å¯¼å…¥è­¦å‘Šæ ·å¼ ========== */\n            .acu-import-warning-container {\n                text-align: center;\n                padding: 16px 12px 20px;\n                color: var(--acu-text-main);\n            }\n            .acu-import-warning-icon {\n                display: block;\n                width: 48px;\n                height: 48px;\n                margin: 0 auto 12px;\n                line-height: 48px;\n                border-radius: 50%;\n                background: rgba(243, 156, 18, 0.15);\n                color: var(--acu-warning-icon, #f39c12);\n                font-size: 22px;\n            }\n            .acu-import-warning-title {\n                font-size: 15px;\n                font-weight: bold;\n                margin-bottom: 8px;\n                color: var(--acu-text-main);\n            }\n            .acu-import-warning-message {\n                font-size: 13px;\n                color: var(--acu-text-sub);\n                line-height: 1.5;\n            }\n            .acu-import-conflict-options {\n                margin-top: 16px;\n                padding-top: 16px;\n                border-top: 1px dashed var(--acu-border);\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n            .acu-import-radio {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 10px 12px;\n                border-radius: 8px;\n                cursor: pointer;\n                font-size: 13px;\n                color: var(--acu-text-main) !important;\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid transparent !important;\n                transition: all 0.2s ease;\n            }\n            .acu-import-radio:hover {\n                border-color: var(--acu-border) !important;\n                background: var(--acu-btn-hover) !important;\n            }\n            .acu-import-radio input {\n                accent-color: var(--acu-accent);\n                width: 16px;\n                height: 16px;\n            }\n            .acu-import-confirm-footer {\n                display: flex;\n                gap: 12px;\n                padding: 16px 20px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            /* ========== å¤´åƒå¯¼å…¥/å¯¼å‡ºç›¸å…³æ ·å¼ ========== */\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n            }\n\n            /* ========== ç»Ÿä¸€éª°å­è®¾ç½®é¢æ¿æ ·å¼ ========== */\n            .acu-dice-config-dialog {\n                width: 320px;\n                max-width: 92vw;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 15px 40px rgba(0,0,0,0.4);\n                overflow: hidden;\n            }\n            .acu-dice-cfg-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 14px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-dice-cfg-header .acu-config-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                font-size: 14px;\n                padding: 4px;\n            }\n            .acu-dice-cfg-header .acu-config-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-body {\n                padding: 12px;\n            }\n            .acu-dice-cfg-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n            .acu-dice-cfg-row.acu-cfg-full-row {\n                grid-template-columns: 1fr;\n            }\n            .acu-dice-cfg-item {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n            .acu-dice-cfg-item label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: 500;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item {\n                flex-direction: row;\n                align-items: center;\n                justify-content: space-between;\n                padding: 8px 0;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item > label {\n                margin: 0;\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input,\n            .acu-dice-cfg-item select {\n                width: 100%;\n                padding: 7px 8px;\n                background: var(--acu-input-bg) !important;\n                border: 1px solid var(--acu-border);\n                border-radius: 5px;\n                color: var(--acu-text-main) !important;\n                font-size: 13px;\n                text-align: center;\n                box-sizing: border-box;\n            }\n            .acu-dice-cfg-item input::placeholder {\n                color: var(--acu-text-sub);\n                opacity: 0.6;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item select {\n                text-align: left;\n                cursor: pointer;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input:focus,\n            .acu-dice-cfg-item select:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .acu-cfg-hint {\n                font-size: 9px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n                text-align: center;\n            }\n            .acu-dice-cfg-actions {\n                display: flex;\n                gap: 8px;\n                margin-top: 12px;\n                padding: 10px 12px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-dice-cfg-actions button {\n                flex: 1;\n                padding: 9px 12px;\n                border-radius: 6px;\n                font-size: 12px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-actions button:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-dice-cfg-actions button.primary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-btn-bg);\n                color: var(--acu-button-text);\n            }\n            .acu-dice-cfg-actions button.primary:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-btn-hover);\n            }\n            /* ========== æ–°ç‰ˆè®¾ç½®é¢æ¿æ ·å¼ ========== */\n            .acu-settings-dialog {\n                width: 380px;\n                max-width: 380px;\n                max-height: 85vh;\n                padding: 0;\n                gap: 0;\n            }\n            @media (max-width: 768px) {\n                .acu-settings-dialog {\n                    width: 92vw;\n                    max-width: 92vw;\n                    max-height: 85vh;\n                }\n                .acu-settings-body {\n                    max-height: calc(85vh - 110px);\n                    -webkit-overflow-scrolling: touch;\n                }\n                .acu-table-manager-list {\n                    max-height: 40vh;\n                    -webkit-overflow-scrolling: touch;\n                }\n            }\n            .acu-settings-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 14px 16px;\n                border-bottom: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-settings-title-group {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n            }\n            .acu-settings-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-header-actions {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-version-badge {\n                display: inline-flex;\n                align-items: center;\n                line-height: 1.2;\n                white-space: nowrap;\n                letter-spacing: 0.5px;\n                background: var(--acu-badge-bg, rgba(0, 0, 0, 0.05));\n                color: var(--acu-text-sub);\n                border-radius: 4px;\n                padding: 2px 6px;\n                font-size: 10px;\n                font-weight: normal;\n                margin-left: 6px;\n                opacity: 0.8;\n            }\n            .acu-help-btn {\n                background: none !important;\n                border: none !important;\n                box-shadow: none !important;\n                outline: none !important;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                font-size: 16px;\n                padding: 6px;\n                margin: 0;\n                border-radius: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-help-btn:hover {\n                color: var(--acu-text-main);\n                background: var(--acu-table-hover) !important;\n            }\n            /* æ‰‹åŠ¨æ›´æ–°æŒ‰é’® - çº¯å›¾æ ‡ï¼Œé€æ˜èƒŒæ™¯ï¼Œä¸ç‰ˆæœ¬å·å¤§å°ä¸€è‡´ */\n            .acu-manual-update-btn {\n                display: inline-flex;\n                align-items: center;\n                justify-content: center;\n                background: transparent;\n                color: var(--acu-text-sub);\n                border: none;\n                padding: 0;\n                margin-left: 6px;\n                font-size: 11px;\n                opacity: 0.6;\n                cursor: pointer;\n                transition: all 0.2s;\n                vertical-align: middle;\n                line-height: 1;\n            }\n            .acu-manual-update-btn:hover {\n                opacity: 1;\n                color: var(--acu-accent, #3b82f6);\n                background: transparent;\n            }\n            /* æ‰‹åŠ¨æ›´æ–°ç¡®è®¤å¼¹çª—æ ·å¼ */\n            .acu-manual-update-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0, 0, 0, 0.6);\n                z-index: 31400;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                padding: 16px;\n                box-sizing: border-box;\n            }\n            .acu-manual-update-dialog {\n                background: var(--acu-panel-bg, #ffffff);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 100%;\n                max-width: 360px;\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);\n                overflow: hidden;\n                position: relative;\n                z-index: 1;\n            }\n            .acu-manual-update-header {\n                padding: 14px 16px;\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-manual-update-body {\n                padding: 16px;\n                color: var(--acu-text-main) !important;\n                font-size: 13px;\n                line-height: 1.6;\n            }\n            .acu-manual-update-body p {\n                margin: 0 0 12px 0;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-manual-update-safe-box {\n                background: var(--acu-card-bg, rgba(34, 197, 94, 0.1));\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                padding: 10px 12px;\n                display: flex;\n                align-items: flex-start;\n                gap: 8px;\n            }\n            .acu-manual-update-safe-box i {\n                color: var(--acu-accent, #22c55e);\n                margin-top: 2px;\n            }\n            .acu-manual-update-safe-box .safe-text {\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                line-height: 1.5;\n            }\n            .acu-manual-update-safe-box .safe-text strong {\n                color: var(--acu-text-main);\n                display: block;\n                margin-bottom: 2px;\n            }\n            .acu-manual-update-footer {\n                padding: 12px 16px;\n                display: flex;\n                justify-content: flex-end;\n                gap: 8px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-manual-update-cancel-btn,\n            .acu-manual-update-confirm-btn {\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s;\n                border: none;\n            }\n            .acu-manual-update-cancel-btn {\n                background: var(--acu-card-bg);\n                color: var(--acu-text-sub);\n                border: 1px solid var(--acu-border);\n            }\n            .acu-manual-update-cancel-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-text-main);\n            }\n            .acu-manual-update-confirm-btn {\n                background: var(--acu-accent, #3b82f6);\n                color: #fff;\n            }\n            .acu-manual-update-confirm-btn:hover {\n                filter: brightness(1.1);\n            }\n            .acu-manual-update-confirm-btn:disabled {\n                opacity: 0.7;\n                cursor: not-allowed;\n            }\n            .acu-settings-body {\n                flex: 1;\n                min-height: 0;\n                overflow-y: auto;\n                overflow-x: hidden;\n                padding: 8px;\n                -webkit-overflow-scrolling: touch;\n            }\n            .acu-settings-group {\n                background: var(--acu-card-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 8px;\n                overflow: hidden;\n            }\n            .acu-settings-group-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 12px 14px;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: var(--acu-table-head);\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.15s;\n            }\n            .acu-settings-group-title:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-group-chevron {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                width: 12px;\n                transition: transform 0.2s;\n            }\n            .acu-settings-group-body {\n                padding: 4px 12px 8px;\n            }\n            .acu-settings-group.collapsed .acu-settings-group-body {\n                display: none;\n            }\n            .acu-settings-group-body.acu-animating {\n                display: block !important;\n                overflow: hidden;\n            }\n            .acu-settings-group:last-child {\n                margin-bottom: 0;\n            }\n            .acu-setting-row {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 0;\n                border-bottom: 1px dashed var(--acu-border);\n                gap: 12px;\n                min-height: 44px;\n            }\n            .acu-setting-row:last-child {\n                border-bottom: none;\n            }\n            .acu-setting-row-slider {\n                flex-direction: column;\n                align-items: stretch;\n            }\n            .acu-setting-info {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-setting-label {\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-setting-hint {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-setting-value {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                margin-left: auto;\n            }\n            .acu-setting-select {\n                padding: 6px 10px;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px;\n                min-width: 120px;\n                cursor: pointer;\n                -webkit-appearance: none;\n                appearance: none;\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L2 4h8z'/%3E%3C/svg%3E");\n                background-repeat: no-repeat;\n                background-position: right 8px center;\n                padding-right: 28px;\n            }\n            .acu-setting-select:focus {\n                outline: none;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-setting-select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-select-short {\n                min-width: 80px;\n            }\n            .acu-setting-slider {\n                width: 100%;\n                height: 6px;\n                margin-top: 8px;\n                -webkit-appearance: none;\n                appearance: none;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n            }\n            .acu-setting-slider::-webkit-slider-runnable-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n            }\n            .acu-setting-slider::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n                margin-top: -6px;\n            }\n            .acu-setting-slider::-moz-range-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-setting-slider::-moz-range-thumb {\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n            }\n            .acu-setting-slider:focus {\n                outline: none;\n            }\n            .acu-setting-mini-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 11px;\n                flex-shrink: 0;\n                transition: all 0.15s;\n            }\n            .acu-setting-mini-btn:hover, .acu-setting-mini-btn.active {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n            }\n\n            /* ========== å±æ€§é¢„è®¾ç®¡ç†é¢æ¿æ ·å¼ ========== */\n            .acu-preset-item {\n                padding: 12px;\n                background: var(--acu-card-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 10px;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                gap: 12px;\n                transition: all 0.2s;\n            }\n            .acu-preset-item:hover {\n                background: var(--acu-table-hover);\n                border-color: var(--acu-accent);\n            }\n            .acu-preset-info {\n                flex: 1;\n            }\n            .acu-preset-name {\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-preset-desc {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-bottom: 4px;\n            }\n            .acu-preset-stats {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n            }\n            .acu-preset-actions {\n                display: flex;\n                gap: 8px;\n                flex-shrink: 0;\n                align-items: center;\n            }\n            .acu-preset-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 13px;\n                transition: all 0.15s;\n            }\n            .acu-preset-btn:hover {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n            }\n            .acu-preset-btn.acu-preset-delete:hover {\n                background: rgba(231, 76, 60, 0.2);\n                color: #e74c3c;\n                border-color: #e74c3c;\n            }\n            /* é¢„è®¾ç¼–è¾‘å™¨è¾“å…¥æ¡†æ ·å¼ï¼ˆé˜²æ­¢è¢«ä¸»é¢˜è¦†ç›–ï¼‰ */\n            .acu-preset-editor-input,\n            .acu-preset-editor-textarea {\n                background: var(--acu-input-bg) !important;\n                color: var(--acu-text-main) !important;\n                border: 1px solid var(--acu-border) !important;\n            }\n            .acu-preset-editor-input:focus,\n            .acu-preset-editor-textarea:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n                box-shadow: 0 0 0 2px rgba(var(--acu-accent-rgb, 100, 150, 200), 0.2) !important;\n            }\n            .acu-preset-editor-textarea {\n                font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;\n            }\n            /* Toggle å¼€å…³ */\n            .acu-toggle {\n                position: relative;\n                width: 44px;\n                height: 24px;\n                flex-shrink: 0;\n            }\n            .acu-toggle input {\n                opacity: 0;\n                width: 0;\n                height: 0;\n            }\n            .acu-toggle-slider {\n                position: absolute;\n                cursor: pointer;\n                top: 0; left: 0; right: 0; bottom: 0;\n                background: rgba(120, 120, 128, 0.16);\n                border: none;\n                border-radius: 24px;\n                transition: all 0.3s ease;\n            }\n            .acu-toggle-slider:before {\n                position: absolute;\n                content: "";\n                height: 20px;\n                width: 20px;\n                left: 2px;\n                top: 2px;\n                background: #fff;\n                border-radius: 50%;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.15);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider {\n                background: var(--acu-accent);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider:before {\n                transform: translateX(20px);\n                box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n            }\n            /* Range Slider æ»‘æ¡æ ·å¼ */\n            .acu-range-slider {\n                -webkit-appearance: none;\n                appearance: none;\n                flex: 1;\n                height: 6px;\n                border-radius: 3px;\n                background: rgba(120, 120, 128, 0.3);\n                outline: none;\n                cursor: pointer;\n                transition: background 0.2s ease;\n            }\n            .acu-range-slider::-webkit-slider-runnable-track {\n                height: 6px;\n                border-radius: 3px;\n                background: transparent;\n            }\n            .acu-range-slider::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                width: 18px !important;\n                height: 18px !important;\n                border-radius: 50% !important;\n                background: #fff !important;\n                border: 1px solid rgba(0,0,0,0.1) !important;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.25) !important;\n                cursor: pointer !important;\n                margin-top: -6px !important;\n                transition: all 0.2s ease;\n            }\n            .acu-range-slider:hover::-webkit-slider-thumb {\n                transform: scale(1.05) !important;\n                background: #e8e8e8 !important;\n                box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;\n            }\n            .acu-range-slider:active::-webkit-slider-thumb {\n                transform: scale(0.95) !important;\n                background: #d0d0d0 !important;\n                box-shadow: 0 1px 4px rgba(0,0,0,0.15) !important;\n            }\n            .acu-range-slider::-moz-range-track {\n                height: 6px;\n                border-radius: 3px;\n                background: rgba(120, 120, 128, 0.16);\n            }\n            .acu-range-slider::-moz-range-thumb {\n                width: 18px !important;\n                height: 18px !important;\n                border-radius: 50% !important;\n                background: #fff !important;\n                border: 1px solid rgba(0,0,0,0.1) !important;\n                box-shadow: 0 2px 8px rgba(0,0,0,0.25) !important;\n                cursor: pointer !important;\n                transition: all 0.2s ease;\n            }\n            .acu-range-slider:hover::-moz-range-thumb {\n                transform: scale(1.05) !important;\n                background: #e8e8e8 !important;\n                box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;\n            }\n            .acu-range-slider:active::-moz-range-thumb {\n                transform: scale(0.95) !important;\n                background: #d0d0d0 !important;\n                box-shadow: 0 1px 4px rgba(0,0,0,0.15) !important;\n            }\n            .acu-range-value {\n                min-width: 45px;\n                text-align: right;\n                font-weight: 600;\n                font-size: 13px;\n                color: var(--acu-accent, var(--SmartThemeBodyColor, #d4a574));\n            }\n            /* ç–¯ç‹‚ç¨‹åº¦æŒ‰é’®ç»„æ ·å¼ */\n            .acu-crazy-btn {\n                padding: 4px 12px;\n                font-size: 12px;\n                border: 1px solid var(--acu-border, rgba(0,0,0,0.1));\n                border-radius: 4px;\n                background: var(--acu-btn-bg, rgba(0,0,0,0.05));\n                color: var(--acu-text, inherit);\n                cursor: pointer;\n                transition: all 0.2s ease;\n                font-weight: 500;\n            }\n            .acu-crazy-btn:hover {\n                background: var(--acu-btn-hover, rgba(0,0,0,0.1));\n            }\n            .acu-crazy-btn.active {\n                background: var(--acu-accent, #d4a574);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent, #d4a574);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.15);\n            }\n            /* Debugæ§åˆ¶å°è¿‡æ»¤æ ·å¼ - å¢åŠ ä¼˜å…ˆçº§é˜²æ­¢è¢«é…’é¦†æ ·å¼è¦†ç›– */\n            .acu-debug-console-dialog .acu-debug-filter,\n            .acu-debug-console-dialog label input.acu-debug-filter {\n                cursor: pointer !important;\n                width: auto !important;\n                height: auto !important;\n                margin: 0 !important;\n                padding: 0 !important;\n                appearance: checkbox !important;\n                -webkit-appearance: checkbox !important;\n                -moz-appearance: checkbox !important;\n            }\n            .acu-debug-console-dialog label {\n                display: flex !important;\n                align-items: center !important;\n                gap: 4px !important;\n                cursor: pointer !important;\n                font-size: 12px !important;\n            }\n            .acu-setting-action-btn {\n                width: 100%;\n                padding: 10px 14px;\n                margin-bottom: 6px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: all 0.15s;\n            }\n            /* Stepper æ­¥è¿›å™¨ */\n            .acu-stepper {\n                display: flex;\n                align-items: center;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                overflow: hidden;\n                background: transparent !important;\n                flex-shrink: 0;\n            }\n            .acu-stepper-btn {\n                width: 36px;\n                height: 34px;\n                border: none !important;\n                background: transparent !important;\n                background-color: transparent !important;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n            }\n            .acu-stepper-btn:hover {\n                background: var(--acu-table-hover) !important;\n                color: var(--acu-accent);\n            }\n            .acu-stepper-btn:active {\n                transform: scale(0.95);\n                background: var(--acu-accent) !important;\n                color: var(--acu-button-text);\n            }\n            .acu-stepper-value {\n                min-width: 60px;\n                height: 34px;\n                line-height: 34px;\n                text-align: center;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: transparent !important;\n                border-left: 1px solid var(--acu-border);\n                border-right: 1px solid var(--acu-border);\n            }\n            /* ========== å˜æ›´å®¡æ ¸é¢æ¿æ ·å¼ ========== */\n            .acu-changes-content {\n                padding: 10px;\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                -webkit-overflow-scrolling: touch !important;\n                touch-action: pan-y !important;\n                overscroll-behavior-y: contain;\n            }\n            /* ========== éªŒè¯é”™è¯¯æ¶ˆæ¯æ ·å¼ ========== */\n            .acu-validation-error-msg {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 0;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n            /* æ•°æ®éªŒè¯æ¨¡å¼æç¤º - å›ºå®šåœ¨é¢æ¿é¡¶éƒ¨ï¼Œä¸å‚ä¸æ¨ªå‘æ»šåŠ¨ */\n            .acu-validation-mode-hint {\n                padding: 8px 12px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                border-radius: 6px;\n                margin: 0 0 10px 0;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            /* å®¡æ ¸é¢æ¿æ¨ªå‘æ»šåŠ¨æ¨¡å¼ */\n            .acu-changes-content.acu-changes-horizontal {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                align-items: flex-start !important;\n                gap: 12px;\n                overflow-x: auto !important;\n                overflow-y: visible !important;\n                touch-action: pan-x pan-y !important;\n                padding-bottom: 5px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-x: contain;\n                overscroll-behavior-y: auto;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-list {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                gap: 12px;\n                align-items: flex-start;\n                min-width: max-content;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                flex: 0 0 280px;\n                min-width: 280px;\n                max-width: 280px;\n                max-height: none;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: auto;\n                overscroll-behavior-y: auto;\n            }\n            @media (min-width: 769px) {\n                .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                    flex: 0 0 320px;\n                    min-width: 320px;\n                    max-width: 320px;\n                }\n            }\n            .acu-changes-list { display: flex; flex-direction: column; gap: 10px; }\n            .acu-changes-group { background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; overflow: hidden; }\n            .acu-changes-group-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--acu-table-head); font-weight: bold; font-size: 13px; color: var(--acu-text-main); }\n            .acu-changes-count { margin-left: auto; background: var(--acu-accent); color: var(--acu-btn-active-text); font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: normal; }\n            .acu-changes-group-body { padding: 6px; display: flex; flex-direction: column; gap: 4px; }\n            .acu-change-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 6px; font-size: 12px; background: rgba(0,0,0,0.02); flex-wrap: wrap; transition: all 0.15s; }\n            .acu-change-item:hover { background: var(--acu-table-hover); }\n            .acu-change-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }\n            .acu-badge-added { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-deleted { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); }\n            .acu-badge-modified { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); }\n            .acu-change-title { color: var(--acu-text-main); font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-field { color: var(--acu-text-sub); font-size: 11px; flex-shrink: 0; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-diff { display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0; overflow: hidden; }\n            .acu-diff-old { color: var(--acu-hl-manual); text-decoration: line-through; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            .acu-diff-arrow { color: var(--acu-text-sub); flex-shrink: 0; }\n            .acu-diff-new { color: var(--acu-success-text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            /* å˜æ›´æ“ä½œæŒ‰é’® */\n            .acu-change-actions { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }\n            .acu-change-action-btn { width: 24px; height: 24px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; transition: all 0.15s; padding: 0; }\n            .acu-change-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: scale(1.1); }\n            .acu-action-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-action-reject:hover, .acu-action-restore:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-action-edit:hover { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); border-color: var(--acu-hl-diff); }\n            /* æ‰¹é‡æ“ä½œæŒ‰é’® - å¢å¼ºæ·±è‰²ä¸»é¢˜ä¸‹çš„å¯¹æ¯”åº¦ */\n            .acu-changes-batch-btn { width: 32px; height: 32px; border: 1.5px solid rgba(255,255,255,0.4); border-radius: 6px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.85); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: all 0.15s; }\n            .acu-changes-batch-btn:hover { background: rgba(255,255,255,0.2); color: #fff; border-color: rgba(255,255,255,0.6); }\n            .acu-batch-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-batch-reject:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-simple-mode-toggle.active { background: var(--acu-accent); color: var(--acu-btn-active-text); border-color: var(--acu-accent); }\n            .acu-simple-mode-toggle:hover { background: var(--acu-accent); color: var(--acu-btn-active-text); border-color: var(--acu-accent); }\n            .acu-changes-group.collapsed .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group:not(.collapsed) .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group-header:hover { background: var(--acu-table-hover); }\n            /* å˜æ›´å¯¹æ¯”ç¼–è¾‘å¼¹çª—æ ·å¼ */\n            .acu-diff-section { margin-bottom: 12px; }\n            .acu-diff-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }\n            .acu-diff-readonly { padding: 10px 12px; background: var(--acu-table-head); border: 1px dashed var(--acu-border); border-radius: 6px; color: var(--acu-text-main); font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; max-height: 150px; overflow-y: auto; opacity: 0.8; }\n            .acu-diff-arrow-down { text-align: center; color: var(--acu-text-sub); font-size: 14px; margin: 8px 0; opacity: 0.5; }\n            /* å¯ç¼–è¾‘åŒºåŸŸé«˜äº®æ ·å¼ */\n            .acu-diff-new-section { padding: 12px; background: var(--acu-input-bg); border: 2px solid var(--acu-accent); border-radius: 6px; box-shadow: 0 0 0 3px rgba(127, 127, 255, 0.1); }\n            .acu-diff-new-section .acu-diff-label { color: var(--acu-accent); font-weight: 600; }\n            .acu-diff-new-section textarea,\n            .acu-diff-new-section input { background: var(--acu-input-bg) !important; border-color: var(--acu-border) !important; }\n            .acu-diff-new-section textarea:focus,\n            .acu-diff-new-section input:focus { border-color: var(--acu-accent) !important; box-shadow: 0 0 0 2px rgba(127, 127, 255, 0.15); }\n            /* å•å­—æ®µç¼–è¾‘å¼¹çª—æŒ‰é’®ä¼˜åŒ– */\n            .acu-edit-dialog .acu-dialog-btns {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n                margin: 0 -16px -16px -16px;\n                border-radius: 0 0 12px 12px;\n            }\n            .acu-edit-dialog .acu-dialog-btn {\n                flex: 1;\n                padding: 10px 12px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                white-space: nowrap;\n                transition: all 0.15s;\n            }\n            .acu-edit-dialog .acu-dialog-btn:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-edit-dialog .acu-btn-confirm {\n                background: var(--acu-accent);\n                border-color: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .acu-edit-dialog .acu-btn-confirm:hover {\n                background: var(--acu-accent);\n                opacity: 0.9;\n            }\n            @media (max-width: 768px) {\n                .acu-edit-dialog .acu-dialog-btns {\n                    flex-wrap: nowrap;\n                }\n                .acu-edit-dialog .acu-dialog-btn {\n                    padding: 10px 8px;\n                    font-size: 12px;\n                    min-width: 0;\n                }\n                .acu-edit-dialog .acu-dialog-btn i {\n                    font-size: 11px;\n                }\n            }\n            @media (max-width: 768px) {\n                .acu-change-item { padding: 8px 6px; }\n                .acu-change-diff { flex-basis: 100%; margin-top: 4px; order: 10; }\n                .acu-change-actions { order: 5; }\n                .acu-diff-old, .acu-diff-new { max-width: 100px; }\n                .acu-change-action-btn { width: 28px; height: 28px; }\n            }\n            .acu-change-field-count { font-size: 11px; color: var(--acu-text-sub); margin-left: 4px; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            /* å¤šå­—æ®µæ•´ä½“ç¼–è¾‘å¼¹çª—æ ·å¼ */\n            .acu-row-edit-field { margin-bottom: 12px; padding: 10px; background: var(--acu-table-head); border-radius: 6px; border: 1px solid transparent; }\n            .acu-row-edit-field.acu-field-changed { border-color: var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-row-edit-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }\n            .acu-changed-badge { font-size: 10px; padding: 1px 6px; background: var(--acu-accent); color: var(--acu-btn-active-text); border-radius: 3px; font-weight: normal; }\n            .acu-row-edit-old { font-size: 12px; color: var(--acu-text-sub); padding: 6px 8px; background: var(--acu-table-head); border-radius: 4px; margin-bottom: 6px; text-decoration: line-through; opacity: 0.7; white-space: pre-wrap; word-break: break-word; }\n            .acu-row-edit-input { width: 100%; min-height: 36px; max-height: 200px; padding: 8px; resize: none; }\n            .acu-empty-val { opacity: 0.5; font-style: italic; }\n            /* ========== è¡¨æ ¼ç®¡ç†åˆ—è¡¨æ ·å¼ ========== */\n            .acu-table-manager-list {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                max-height: 300px;\n                overflow-y: auto;\n                padding: 4px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-y: contain;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                cursor: default;\n                transition: all 0.15s;\n                user-select: none;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-table-manager-item.hidden-table {\n                opacity: 0.5;\n                border-color: var(--acu-border);\n                border-style: dashed;\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-name {\n                text-decoration: line-through;\n            }\n            .acu-table-item-check {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                color: var(--acu-accent);\n                border-radius: 4px;\n                transition: all 0.15s;\n            }\n            .acu-table-item-check:hover {\n                background: var(--acu-table-hover);\n                transform: scale(1.1);\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-check {\n                color: var(--acu-text-sub);\n            }\n            .acu-table-item-icon {\n                width: 20px;\n                text-align: center;\n                color: var(--acu-accent);\n                font-size: 12px;\n            }\n            .acu-table-item-name {\n                flex: 1;\n                font-size: 13px;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-table-item-handle {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--acu-text-sub);\n                cursor: grab;\n                opacity: 0.4;\n                transition: all 0.15s;\n                border-radius: 4px;\n            }\n            .acu-table-item-handle:hover {\n                opacity: 1;\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n            }\n            .acu-table-manager-item.acu-dragging {\n                opacity: 0.9;\n                background: var(--acu-accent);\n                border-color: var(--acu-accent);\n                box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n                z-index: 100;\n            }\n            .acu-table-manager-item.acu-dragging .acu-table-item-name,\n            .acu-table-manager-item.acu-dragging .acu-table-item-check,\n            .acu-table-manager-item.acu-dragging .acu-table-item-icon,\n            .acu-table-manager-item.acu-dragging .acu-table-item-handle {\n                color: var(--acu-btn-active-text);\n            }\n            .acu-table-manager-item.acu-drag-above {\n                border-top: 2px solid var(--acu-accent);\n                margin-top: -1px;\n            }\n            .acu-table-manager-item.acu-drag-below {\n                border-bottom: 2px solid var(--acu-accent);\n                margin-bottom: -1px;\n            }\n            @media (max-width: 768px) {\n                .acu-table-item-handle {\n                    opacity: 0.6;\n                }\n            }\n            /* ç‰¹æ®ŠæŒ‰é’®æ ·å¼ï¼ˆæŠ•éª°/å®¡æ ¸/å˜é‡ï¼‰ */\n            .acu-table-manager-item.acu-special-item {\n                background: linear-gradient(135deg, rgba(var(--acu-accent-rgb, 128, 128, 128), 0.08), transparent);\n                border-style: dashed;\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-icon {\n                color: var(--acu-accent);\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-name {\n                font-weight: 500;\n            }\n            /* ========== æ•°æ®éªŒè¯è§„åˆ™æ ·å¼ ========== */\n            .acu-validation-rules-list {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                max-height: 280px;\n                overflow-y: auto;\n                padding: 2px;\n            }\n            .acu-validation-rule-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                transition: all 0.2s ease;\n            }\n            .acu-validation-rule-item.disabled {\n                opacity: 0.5;\n            }\n            .acu-validation-rule-item:hover {\n                border-color: var(--acu-accent);\n            }\n            .acu-rule-toggle {\n                cursor: pointer;\n                font-size: 18px;\n                color: var(--text-sub);\n                transition: all 0.2s;\n                flex-shrink: 0;\n                background: none;\n                border: none;\n                border-radius: 4px;\n                padding: 4px 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-rule-toggle:hover {\n                opacity: 0.8;\n            }\n            .acu-rule-toggle.active {\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-rule-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-rule-name {\n                font-size: 12px;\n                font-weight: 500;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-rule-target {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                margin-top: 2px;\n            }\n            .acu-rule-type-icon {\n                width: 20px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n                text-align: center;\n                background: none !important;\n            }\n            .acu-rule-delete {\n                background: none;\n                border: none;\n                color: var(--text-sub);\n                cursor: pointer;\n                padding: 4px;\n                opacity: 0.6;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-delete:hover {\n                color: #e74c3c;\n                opacity: 1;\n            }\n            .acu-rule-edit {\n                background: none;\n                border: none;\n                color: var(--text-sub);\n                cursor: pointer;\n                padding: 4px;\n                opacity: 0.6;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-edit:hover {\n                color: var(--accent-color);\n                opacity: 1;\n            }\n            .acu-rule-delete:hover {\n                color: #e74c3c;\n                opacity: 1;\n            }\n            .acu-rule-intercept {\n                cursor: pointer;\n                font-size: 14px;\n                color: var(--acu-text-sub);\n                padding: 4px 6px;\n                border-radius: 4px;\n                opacity: 0.5;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-intercept:hover {\n                opacity: 0.8;\n                background: var(--acu-hover-bg);\n            }\n            .acu-rule-intercept.active {\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-add-rule-btn {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                width: 100%;\n                padding: 10px;\n                margin-top: 8px;\n                background: var(--acu-btn-bg);\n                border: 1px dashed var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-add-rule-btn:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n                background: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.1);\n            }\n            /* éªŒè¯è§„åˆ™å¼¹çª— */\n            .acu-validation-modal-overlay {\n                z-index: 31320;\n            }\n            .acu-validation-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 420px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-validation-modal-body {\n                padding: 16px;\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                max-height: 60vh;\n                overflow-y: auto;\n            }\n            .acu-validation-modal-body .acu-setting-row {\n                flex-wrap: wrap;\n            }\n            .acu-validation-modal-body .acu-panel-input,\n            .acu-validation-modal input[type="text"],\n            .acu-validation-modal input[type="number"],\n            .acu-validation-modal select {\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                padding: 8px 10px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n            }\n            .acu-validation-modal-body .acu-panel-input:focus,\n            .acu-validation-modal input[type="text"]:focus,\n            .acu-validation-modal input[type="number"]:focus,\n            .acu-validation-modal select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-validation-modal-body .acu-panel-input::placeholder,\n            .acu-validation-modal input[type="text"]::placeholder,\n            .acu-validation-modal input[type="number"]::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-validation-modal select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-validation-modal select option[value=""] {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-rule-config-section {\n                padding: 8px 0;\n            }\n            .acu-validation-modal-footer {\n                display: flex;\n                justify-content: center;\n                gap: 12px;\n                padding: 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-validation-modal-footer .acu-btn {\n                flex: 1;\n                padding: 10px 12px !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n            }\n            /* æ™ºèƒ½ä¿®æ”¹å¼¹çª—æ ·å¼ */\n            .acu-smart-fix-meta {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 0 !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-separator {\n                color: var(--acu-border) !important;\n                opacity: 0.5 !important;\n            }\n            .acu-smart-fix-diff {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                padding: 6px 0 !important;\n                margin: 4px 0 !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-diff-old-text {\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n                font-size: 13px !important;\n                white-space: nowrap !important;\n                overflow: hidden !important;\n                text-overflow: ellipsis !important;\n                max-width: 150px !important;\n            }\n            .acu-smart-fix-diff-arrow {\n                color: var(--acu-text-sub) !important;\n                flex-shrink: 0 !important;\n            }\n            .acu-smart-fix-empty {\n                opacity: 0.5 !important;\n                font-style: italic !important;\n            }\n            .acu-smart-fix-diff-input-wrapper {\n                flex: 1 !important;\n                min-width: 120px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input,\n            .acu-smart-fix-diff-input-wrapper select {\n                width: 100% !important;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                padding: 4px 8px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n                -moz-appearance: none !important;\n                appearance: none !important;\n                min-height: 26px !important;\n                line-height: 1.3 !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input:focus,\n            .acu-smart-fix-diff-input-wrapper select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select {\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23666' d='M5 7L1 3h8z'/%3E%3C/svg%3E") !important;\n                background-repeat: no-repeat !important;\n                background-position: right 6px center !important;\n                padding-right: 24px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select option {\n                background: var(--acu-card-bg) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-suggest {\n                padding: 10px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-suggest-label {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                margin-bottom: 6px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 4px !important;\n            }\n            .acu-smart-fix-suggest-label i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-suggest-value {\n                font-size: 13px !important;\n                color: var(--acu-success-text) !important;\n                font-weight: 500 !important;\n                padding: 6px 8px !important;\n                background: var(--acu-success-bg) !important;\n                border-radius: 4px !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-suggest-value:hover {\n                background: var(--acu-success-text) !important;\n                color: white !important;\n            }\n            .acu-smart-fix-suggest-options {\n                display: flex !important;\n                flex-wrap: wrap !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-suggest-options-scroll {\n                max-height: 120px !important;\n                overflow-y: auto !important;\n                padding-right: 4px !important;\n            }\n            .acu-smart-fix-option {\n                display: inline-block !important;\n                font-size: 12px !important;\n                padding: 4px 10px !important;\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                color: var(--acu-text-main) !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-option:hover {\n                background: var(--acu-btn-hover) !important;\n                border-color: var(--acu-accent) !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-option-current {\n                background: var(--acu-hl-manual-bg) !important;\n                border-color: var(--acu-hl-manual) !important;\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n            }\n            .acu-smart-fix-error-hint {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-card-bg) !important;\n                border-radius: 4px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-error-hint i {\n                color: var(--acu-accent) !important;\n                flex-shrink: 0 !important;\n            }\n            @media (max-width: 600px) {\n                .acu-smart-fix-diff {\n                    flex-direction: column !important;\n                    align-items: stretch !important;\n                }\n                .acu-smart-fix-diff-arrow {\n                    transform: rotate(90deg) !important;\n                }\n            }\n            .acu-btn {\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid transparent;\n            }\n            .acu-btn-secondary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-btn-secondary:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-btn-primary {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .acu-btn-primary:hover {\n                opacity: 0.9;\n            }\n            /* æ™ºèƒ½ä¿®æ”¹å¼¹çª—æ–°å¢æ ·å¼ */\n            .acu-smart-fix-rule-info {\n                padding: 10px 12px !important;\n                background: var(--acu-table-head) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-left: 3px solid var(--acu-accent) !important;\n                border-radius: 4px !important;\n                margin-bottom: 12px !important;\n            }\n            .acu-smart-fix-rule-header {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                font-size: 13px !important;\n                font-weight: 600 !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-rule-header i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-rule-desc {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                line-height: 1.4 !important;\n            }\n            .acu-smart-fix-suggest-section {\n                margin-top: 12px !important;\n            }\n            .acu-smart-fix-suggest code {\n                background: var(--acu-table-head) !important;\n                padding: 2px 6px !important;\n                border-radius: 3px !important;\n                font-size: 11px !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-quick-btn {\n                display: inline-flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                padding: 6px 12px !important;\n                background: var(--acu-accent) !important;\n                color: var(--acu-btn-active-text) !important;\n                border: 1px solid var(--acu-accent) !important;\n                border-radius: 4px !important;\n                font-size: 12px !important;\n                font-weight: 500 !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-quick-btn:hover {\n                background: var(--acu-btn-active-bg) !important;\n                color: var(--acu-btn-active-text) !important;\n                border-color: var(--acu-btn-active-bg) !important;\n            }\n            .acu-smart-fix-table-summary {\n                padding: 12px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n            }\n            .acu-smart-fix-stat {\n                font-size: 13px !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 8px !important;\n            }\n            .acu-smart-fix-stat strong {\n                color: var(--acu-hl-manual) !important;\n            }\n            .acu-smart-fix-change-list {\n                max-height: 150px !important;\n                overflow-y: auto !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-change-item {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 3px !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-hint {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 4px !important;\n                margin-top: 8px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-hint i {\n                color: var(--acu-accent) !important;\n            }\n            /* ========== å¤´åƒè£å‰ªå¼¹çª—æ ·å¼ ========== */\n            .acu-crop-modal-overlay {\n                z-index: 31330;\n            }\n            .acu-crop-file-input {\n                display: none;\n            }\n            .acu-crop-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 360px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-crop-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-crop-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                font-size: 16px;\n                cursor: pointer;\n                padding: 4px;\n            }\n            .acu-crop-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-crop-body {\n                padding: 20px;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 12px;\n            }\n            .acu-crop-container {\n                position: relative;\n                width: 200px;\n                height: 200px;\n                border-radius: 50%;\n                overflow: hidden;\n                touch-action: none;\n                user-select: none;\n            }\n            .acu-crop-image {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-repeat: no-repeat;\n                cursor: grab;\n            }\n            .acu-crop-mask {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                border: 3px solid var(--acu-accent);\n                border-radius: 50%;\n                pointer-events: none;\n                box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);\n            }\n            .acu-crop-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-crop-footer {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-top: 1px solid var(--acu-border);\n            }\n            .acu-crop-btn {\n                flex: 1;\n                padding: 10px 16px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-crop-cancel {\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-crop-cancel:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-crop-confirm {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: var(--acu-btn-active-text);\n            }\n            .acu-crop-confirm:hover {\n                opacity: 0.9;\n            }\n            .acu-crop-reupload {\n                flex: 0 0 auto;\n                padding: 10px 14px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-crop-reupload:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n\n            /* ========== æ”¶è—å¤¹é¢æ¿æ ·å¼ ========== */\n            .acu-favorites-overlay,\n            .acu-fav-edit-overlay,\n            .acu-fav-new-overlay,\n            .acu-fav-send-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.6);\n                z-index: 31300;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                backdrop-filter: blur(2px);\n            }\n            .acu-favorites-panel {\n                width: 90%;\n                max-width: 800px;\n                max-height: 85vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n            .acu-favorites-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n            }\n            .acu-favorites-header h3 {\n                margin: 0;\n                font-size: 16px;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-favorites-header-actions {\n                display: flex;\n                gap: 8px;\n            }\n            .acu-fav-header-btn {\n                padding: 6px 12px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                font-size: 12px;\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-header-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-header-btn.acu-fav-close {\n                background: transparent;\n                border: none;\n                font-size: 16px;\n            }\n            .acu-favorites-filter {\n                display: flex;\n                gap: 10px;\n                padding: 12px 18px;\n                border-bottom: 1px solid var(--acu-border);\n                background: var(--acu-bg-main);\n            }\n            .acu-favorites-filter select,\n            .acu-favorites-filter input {\n                flex: 1;\n                padding: 8px 12px;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 13px;\n            }\n            .acu-favorites-filter select {\n                max-width: 200px;\n            }\n            .acu-favorites-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 16px;\n            }\n            .acu-favorites-empty {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n                padding: 60px 20px;\n                color: var(--acu-text-muted);\n                text-align: center;\n            }\n            .acu-favorites-group {\n                margin-bottom: 20px;\n            }\n            .acu-favorites-group-title {\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 10px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-favorites-group-cards {\n                display: grid;\n                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));\n                gap: 12px;\n            }\n            .acu-favorites-card {\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                padding: 12px;\n                transition: all 0.2s ease;\n            }\n            .acu-favorites-card:hover {\n                border-color: var(--acu-accent);\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n            }\n            .acu-favorites-card-header {\n                margin-bottom: 8px;\n            }\n            .acu-favorites-card-preview {\n                font-size: 12px;\n                color: var(--acu-text-main);\n                line-height: 1.5;\n            }\n            .acu-fav-preview-item {\n                display: block;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n            .acu-fav-preview-item b {\n                color: var(--acu-accent);\n            }\n            .acu-favorites-card-source {\n                font-size: 11px;\n                color: var(--acu-text-muted);\n                margin-top: 4px;\n            }\n            .acu-favorites-card-tags {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 4px;\n                margin-bottom: 8px;\n            }\n            .acu-favorites-tag {\n                padding: 2px 8px;\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-radius: 10px;\n                font-size: 10px;\n                font-weight: 500;\n            }\n            .acu-favorites-card-actions {\n                display: flex;\n                gap: 6px;\n                justify-content: flex-end;\n            }\n            .acu-fav-btn {\n                width: 28px;\n                height: 28px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 12px;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-delete:hover {\n                color: #e74c3c;\n            }\n            .acu-fav-send:hover {\n                color: #27ae60;\n            }\n\n            /* ========== æ”¶è—å¤¹æ ‡ç­¾è¿‡æ»¤å¯æŠ˜å åŒºåŸŸ ========== */\n            .acu-fav-tag-filter-collapsible {\n                border-bottom: 1px solid var(--acu-border);\n            }\n            .acu-fav-tag-filter-header {\n                position: sticky;\n                top: 0;\n                z-index: 1;\n                padding: 6px 12px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                user-select: none;\n            }\n            .acu-fav-tag-filter-header span {\n                font-size: calc(var(--acu-font-size, 13px) * 0.85);\n                color: var(--acu-text-sub);\n                font-weight: 500;\n            }\n            .acu-fav-tag-toggle-icon {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                transition: transform 0.2s;\n            }\n            .acu-fav-tag-filter-body {\n                padding: 8px 12px;\n                background: var(--acu-table-head);\n                display: flex;\n                flex-wrap: wrap;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-fav-tag-filter-body.horizontal {\n                display: grid;\n                grid-auto-flow: column;\n                grid-template-rows: repeat(auto-fill, minmax(28px, 1fr));\n                gap: 6px;\n                overflow-x: auto;\n            }\n            .acu-fav-tag-filter-collapsible.collapsed .acu-fav-tag-filter-body {\n                display: none;\n            }\n            .acu-fav-tag-filter-collapsible.collapsed .acu-fav-tag-toggle-icon {\n                transform: rotate(-90deg);\n            }\n            .acu-fav-tag-btn {\n                padding: 0 10px;\n                height: 28px;\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: calc(var(--acu-font-size, 13px) * 0.85);\n                transition: all 0.2s ease;\n                opacity: 0.5;\n                white-space: nowrap;\n            }\n            .acu-fav-tag-btn:hover {\n                opacity: 0.8;\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n            }\n            .acu-fav-tag-btn.active {\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-color: var(--acu-accent);\n                opacity: 1;\n            }\n\n            /* ç¼–è¾‘å¼¹çª— */\n            .acu-fav-edit-modal,\n            .acu-fav-new-modal,\n            .acu-fav-send-modal {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n            .acu-fav-edit-modal-header,\n            .acu-fav-new-modal-header,\n            .acu-fav-send-modal-header {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                padding: 14px 18px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n            }\n            .acu-fav-edit-modal-header h4,\n            .acu-fav-new-modal-header h4,\n            .acu-fav-send-modal-header h4 {\n                margin: 0;\n                font-size: 15px;\n                color: var(--acu-accent);\n            }\n            .acu-fav-edit-close,\n            .acu-fav-new-close,\n            .acu-fav-send-close {\n                background: transparent;\n                border: none;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                font-size: 16px;\n            }\n            .acu-fav-edit-modal-body,\n            .acu-fav-new-modal-body,\n            .acu-fav-send-modal-body {\n                flex: 1;\n                overflow-y: auto;\n                padding: 16px;\n            }\n            .acu-fav-edit-tags-section {\n                margin-bottom: 16px;\n            }\n            .acu-fav-edit-tags-section label {\n                display: block;\n                font-size: 12px;\n                color: var(--acu-text-muted);\n                margin-bottom: 6px;\n            }\n            .acu-fav-edit-tags-section input {\n                width: 100%;\n                padding: 8px 12px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 13px;\n            }\n            .acu-fav-edit-rows {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 12px;\n            }\n            .acu-fav-edit-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n            .acu-fav-edit-header {\n                flex: 0 0 120px;\n                padding: 8px 10px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-accent);\n                font-size: 12px;\n                font-weight: 600;\n            }\n            .acu-fav-edit-value {\n                flex: 1;\n                padding: 8px 10px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 12px;\n            }\n            .acu-fav-edit-remove {\n                width: 28px;\n                height: 28px;\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-muted);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-fav-edit-remove:hover {\n                color: #e74c3c;\n                border-color: #e74c3c;\n            }\n            .acu-fav-edit-add-col {\n                padding: 8px 12px;\n                background: var(--acu-btn-bg);\n                border: 1px dashed var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                font-size: 12px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-edit-add-col:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n            }\n            .acu-fav-edit-modal-footer,\n            .acu-fav-new-modal-footer,\n            .acu-fav-send-modal-footer {\n                display: flex;\n                justify-content: flex-end;\n                gap: 10px;\n                padding: 14px 18px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-bg-main);\n            }\n            .acu-fav-edit-cancel,\n            .acu-fav-new-cancel,\n            .acu-fav-send-cancel {\n                padding: 8px 16px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n            }\n            .acu-fav-edit-save,\n            .acu-fav-new-create {\n                padding: 8px 16px;\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                border-radius: 6px;\n                color: var(--acu-btn-active-text);\n                cursor: pointer;\n            }\n            .acu-fav-edit-save:hover,\n            .acu-fav-new-create:hover {\n                opacity: 0.9;\n            }\n\n            /* å‘é€é€‰æ‹©å¼¹çª— */\n            .acu-fav-send-option {\n                padding: 12px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 8px;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n            .acu-fav-send-option:hover {\n                border-color: var(--acu-accent);\n                background: var(--acu-btn-hover);\n            }\n            .acu-fav-send-option-name {\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-fav-send-option-mode {\n                font-size: 12px;\n            }\n            .acu-fav-send-unmatched {\n                font-size: 11px;\n                color: var(--acu-text-muted);\n                margin-top: 4px;\n            }\n\n            /* æ–°å»ºæ¨¡æ¿é€‰æ‹© */\n            .acu-fav-new-modal-body label {\n                display: block;\n                font-size: 13px;\n                color: var(--acu-text-main);\n                margin-bottom: 10px;\n            }\n            .acu-fav-new-modal-body select {\n                width: 100%;\n                padding: 10px 12px;\n                background: var(--acu-bg-main);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                font-size: 14px;\n            }\n\n            @media (max-width: 768px) {\n                .acu-favorites-panel {\n                    width: 95%;\n                    max-height: 90vh;\n                }\n                .acu-favorites-group-cards {\n                    grid-template-columns: 1fr;\n                }\n                .acu-favorites-header-actions {\n                    flex-wrap: wrap;\n                }\n                .acu-fav-header-btn span {\n                    display: none;\n                }\n            }\n\n            /* ========== æ”¶è—å¤¹é¢æ¿æ ·å¼ (æ–°å¢) ========== */\n            /* [ä¿®å¤] æ”¶è—å¤¹å¤–å±‚å®¹å™¨å¿…é¡»é™åˆ¶é«˜åº¦å’Œæº¢å‡ºï¼Œé˜²æ­¢å¡ç‰‡è¶…å‡ºé¢æ¿èŒƒå›´ */\n            .acu-fav-wrapper {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n                max-height: 100%;\n                overflow: hidden;\n            }\n            .acu-fav-panel-content {\n                padding: 12px;\n                overflow-y: auto;\n                overflow-x: hidden;\n                flex: 1;\n                min-height: 0; /* å…³é”®ï¼šå…è®¸ flex å­å…ƒç´ æ”¶ç¼© */\n            }\n            /* [å·²åºŸå¼ƒ] å·¥å…·æ å·²ç§»è‡³Headerï¼Œä¿ç•™æ ·å¼ä»¥é˜²å›é€€ */\n            /*\n            .acu-fav-toolbar {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 12px;\n                flex-wrap: wrap;\n            }\n            */\n            .acu-fav-select,\n            .acu-fav-input {\n                padding: 6px 10px !important;\n                background: var(--acu-bg-panel) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                height: auto !important;\n                box-shadow: none !important;\n            }\n            .acu-fav-select {\n                min-width: 120px;\n            }\n            .acu-fav-input {\n                flex: 1;\n                min-width: 150px;\n            }\n            .acu-fav-toolbar-btn {\n                padding: 6px 10px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                font-size: 12px;\n            }\n            .acu-fav-toolbar-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-grid {\n                display: flex;\n                flex-direction: column;\n                gap: 16px;\n            }\n            .acu-fav-group-title {\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-accent);\n                margin-bottom: 8px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-fav-group-cards {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 10px;\n            }\n            /* æ”¶è—å¤¹å¡ç‰‡ - å¤ç”¨ acu-data-card å®½åº¦ï¼Œä¿æŒä¸æ™®é€šè¡¨æ ¼ä¸€è‡´ */\n            .acu-fav-card {\n                flex: 0 0 var(--acu-card-width, 260px);\n                width: var(--acu-card-width, 260px);\n                cursor: pointer;\n            }\n            .acu-fav-card-tags {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 4px;\n                padding: 6px 12px 8px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-fav-tag {\n                padding: 2px 6px;\n                background: var(--acu-accent);\n                color: var(--acu-btn-active-text);\n                border-radius: 8px;\n                font-size: 10px;\n            }\n            /* [å·²åºŸå¼ƒ] æ“ä½œæŒ‰é’®å·²æ”¹ä¸ºå•å‡»èœå•ï¼Œä¿ç•™æ ·å¼ä»¥é˜²å›é€€ */\n            /*\n            .acu-fav-card-actions {\n                display: flex;\n                justify-content: flex-end;\n                gap: 4px;\n                padding: 8px 12px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-bg-main);\n            }\n            .acu-fav-action-btn {\n                width: 28px;\n                height: 28px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 11px;\n            }\n            .acu-fav-action-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-fav-delete:hover {\n                color: #e74c3c;\n            }\n            */\n            .acu-fav-empty {\n                text-align: center;\n                padding: 40px 20px;\n                color: var(--acu-text-muted);\n            }\n            .acu-fav-empty i {\n                font-size: 36px;\n                opacity: 0.3;\n                margin-bottom: 12px;\n            }\n            .acu-fav-empty p {\n                margin: 4px 0;\n            }\n\n            /* ç¼–è¾‘å¼¹çª— - ä¿ç•™å¼¹çª—å½¢å¼ï¼Œæ·»åŠ ç§»åŠ¨ç«¯é€‚é… */\n            .acu-fav-edit-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0,0,0,0.6);\n                z-index: 31300;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-fav-edit-modal {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n            }\n            @media (max-width: 768px) {\n                .acu-fav-edit-modal {\n                    position: fixed !important;\n                    top: 5% !important;\n                    left: 50% !important;\n                    transform: translateX(-50%) !important;\n                    width: 92vw !important;\n                    max-height: 88vh !important;\n                }\n                .acu-fav-edit-overlay {\n                    align-items: flex-start !important;\n                    padding-top: 5vh !important;\n                }\n                .acu-fav-group-cards {\n                    grid-template-columns: 1fr !important;\n                }\n            }\n            /* ç¼–è¾‘å¼¹çª—è¾“å…¥æ¡†æ ·å¼è¦†ç›– */\n            .acu-fav-edit-modal input {\n                padding: 8px 10px !important;\n                background: var(--acu-bg-panel) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                height: auto !important;\n                box-shadow: none !important;\n            }\n\n    /* Cleaned up Inline Styles */\n    #dice-custom-input { width: 60px; }\n    #contest-custom-dice {\n        width: 60px;\n        flex: 0 0 auto;\n    }\n    \n    .acu-mvu-dice-icon {\n        cursor: pointer;\n        color: var(--acu-accent);\n        opacity: 0.6;\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        flex-shrink: 0;\n    }\n    \n    .acu-mvu-level-toggle {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        cursor: pointer;\n        padding: 2px 6px;\n        border-radius: 4px;\n        border: 1px solid var(--acu-border);\n        transition: all 0.2s;\n        background: transparent;\n        color: var(--acu-text-sub);\n        opacity: 0.5;\n    }\n    .acu-mvu-level-toggle.active {\n        background: var(--acu-accent);\n        color: var(--acu-btn-active-text);\n        border-color: var(--acu-accent);\n        opacity: 1;\n    }\n    \n    .acu-mvu-header {\n        padding: 6px 8px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        justify-content: space-between;\n        user-select: none;\n    }\n    \n    .acu-mvu-body {\n        padding: 8px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        display: flex;\n        flex-wrap: wrap;\n        gap: 6px;\n        align-items: center;\n    }\n    \n    .acu-mvu-item {\n        display: flex;\n        align-items: center;\n        padding: 6px 8px;\n        margin-bottom: 4px;\n        background: var(--acu-table-hover);\n        border-radius: 4px;\n        border-left: 3px solid var(--acu-accent);\n    }\n    \n    .acu-mvu-path {\n        font-size: calc(var(--acu-font-size, 13px) * 0.77);\n        color: var(--acu-text-sub);\n        margin-bottom: 2px;\n    }\n    \n    .acu-mvu-val {\n        font-size: var(--acu-font-size, 13px);\n        color: var(--acu-accent);\n        font-weight: bold;\n        cursor: pointer;\n    }\n    \n    .acu-mvu-list {\n        padding: 0 8px;\n    }\n\n    .acu-mvu-toggle-icon {\n        font-size: 10px;\n        color: var(--acu-text-sub);\n        transition: transform 0.2s;\n    }\n    .acu-mvu-header-text {\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        color: var(--acu-text-sub);\n    }\n    .acu-mvu-item-content {\n        flex: 1;\n        min-width: 0;\n    }\n    .acu-mvu-item-row {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n    }\n    .acu-mvu-attr-name {\n        font-size: calc(var(--acu-font-size, 13px) * 0.92);\n        color: var(--acu-text-main);\n        font-weight: bold;\n    }\n    .acu-order-first {\n        order: -1;\n    }\n    .acu-text-sub-small {\n        font-size: calc(var(--acu-font-size, 13px) * 0.85);\n        color: var(--acu-text-sub);\n    }\n    .acu-ml-6 {\n        margin-left: 6px;\n    }\n\n    /* Graph & Node Size Controls */\n    .acu-graph-filter-btn {\n        padding: 4px 6px;\n        font-size: 12px;\n    }\n    .acu-graph-filter-btn.ml-8 {\n        margin-left: 8px;\n    }\n    .acu-node-size-slider-container {\n        position: absolute;\n        display: none;\n        width: 200px;\n        padding: 10px;\n        border-radius: 8px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        z-index: 10;\n        background: var(--acu-bg-panel);\n        border: 1px solid var(--acu-border);\n    }\n    .acu-slider-header {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        margin-bottom: 6px;\n    }\n    .acu-range-input {\n        width: 100%;\n        height: 8px;\n        border-radius: 4px;\n        outline: none;\n        cursor: pointer;\n        -webkit-appearance: none;\n        background: var(--acu-input-bg);\n        margin: 0;\n    }\n    .acu-range-input::-webkit-slider-thumb {\n        -webkit-appearance: none;\n        width: 16px;\n        height: 16px;\n        border-radius: 50%;\n        background: var(--acu-accent);\n        cursor: pointer;\n        margin-top: -4px; /* Adjust for track height if needed, usually 0 or negative for center */\n    }\n    .acu-range-input::-webkit-slider-runnable-track {\n        width: 100%;\n        height: 8px;\n        cursor: pointer;\n        background: var(--acu-input-bg);\n        border-radius: 4px;\n    }\n    .acu-graph-reset-btn {\n        width: auto;\n        height: auto;\n        padding: 4px 10px;\n        font-size: 11px;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n    }\n    .acu-node-size-wrapper {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 6px;\n    }\n    .acu-stepper-container {\n        display: flex;\n        align-items: center;\n    }\n    .acu-stepper-value-display {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n    }\n    .acu-zoom-info {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        color: var(--acu-text-sub);\n        font-size: 11px;\n    }\n</style>`;$('head').append(e)},wa=()=>{const t=$e().getDB();if(!t||!t.exportTableAsJson)return console.warn('[DICE]æ•°æ®åº“ API ä¸å¯ç”¨ï¼Œæ— æ³•è·å–è¡¨æ ¼æ•°æ®'),null;try{const e=t.exportTableAsJson();if(e){const t=Object.keys(e).filter(t=>t.startsWith('sheet_')).length;console.info(`[DICE]å·²åŠ è½½è¡¨æ ¼æ•°æ®ï¼ŒåŒ…å« ${t} ä¸ªå·¥ä½œè¡¨`)}return e}catch(t){return console.error('[DICE]è·å–è¡¨æ ¼æ•°æ®å¤±è´¥:',t),null}},ka=async(t,e=!1,a=!1)=>{if(Qt)return void console.warn('[DICE]ä¿å­˜æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');console.info('[DICE]å¼€å§‹ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“...'),Qt=!0;const{$}=$e(),n=$('#acu-btn-save-global');!e&&n.length&&(n.find('i').removeClass('fa-save').addClass('fa-spinner fa-spin'),n.prop('disabled',!0));try{const n={};if(t.mate?n.mate=t.mate:n.mate={type:'chatSheets',version:1},Object.keys(t).forEach(e=>{e.startsWith('sheet_')&&(n[e]=t[e])}),a){const t=se();Object.keys(t).forEach(e=>{n[e]&&n[e].content&&t[e].sort((t,e)=>e-t).forEach(t=>{n[e].content[t+1]&&n[e].content.splice(t+1,1)})})}let o;try{o=JSON.stringify(n);const t=new Blob([o]).size/1048576;if(t>10)throw new Error(`æ•°æ®å¤ªå¤§ (${t.toFixed(2)}MB)ï¼Œè¶…è¿‡ 10MB é™åˆ¶`);console.info(`[DICE]æ•°æ®åºåˆ—åŒ–å®Œæˆï¼Œå¤§å°: ${t.toFixed(2)}MB`)}catch(t){throw console.error('[DICE]ACU JSON åºåˆ—åŒ–å¤±è´¥:',t),new Error(`æ•°æ®åºåˆ—åŒ–å¤±è´¥: ${t.message||t}`)}const i=$e().getDB();if(!i||!i.importTableAsJson)throw new Error('æ•°æ®åº“ API ä¸å¯ç”¨');try{if(!1===await i.importTableAsJson(o))throw new Error('æ•°æ®å¯¼å…¥å¤±è´¥ï¼ˆè¿”å› falseï¼‰');console.info('[DICE]æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“')}catch(t){console.error('[DICE]ACU API ä¿å­˜å¤±è´¥:',t);const e=t.message||String(t);if(e.includes('Settings could not be saved')||e.includes('server connection')||e.includes('data loss'))throw new Error('ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨è¿æ¥é—®é¢˜æˆ–æ•°æ®è¿‡å¤§ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å‡å°‘æ•°æ®é‡');throw new Error(`ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥: ${e}`)}ie=n,Re(n),re=!1,ae=new Set,window.acuModifiedSet&&window.acuModifiedSet.clear(),console.info('[DICE]æœ¬åœ°çŠ¶æ€å·²æ›´æ–°ï¼Œæœªä¿å­˜æ›´æ”¹å·²æ¸…é™¤'),e||nn()}catch(t){const e=t.message||'ä¿å­˜å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼å’Œå¤§å°';throw console.error('[DICE]ä¿å­˜æ•°æ®å¤±è´¥:',{error:t,message:e,stack:t.stack}),window.toastr?window.toastr.error(e,'ä¿å­˜å¤±è´¥',{timeOut:5e3}):alert(`ä¿å­˜å¤±è´¥: ${e}`),t}finally{Qt=!1,console.info('[DICE]ä¿å­˜æ“ä½œå®Œæˆ'),!e&&n.length&&(n.find('i').removeClass('fa-spinner fa-spin').addClass('fa-save'),n.prop('disabled',!1))}},$a=async t=>{const e=Zt.then(async()=>{try{const e={};let a;t.mate?e.mate=t.mate:e.mate={type:'chatSheets',version:1},Object.keys(t).forEach(a=>{a.startsWith('sheet_')&&(e[a]=t[a])});try{a=JSON.stringify(e);const t=new Blob([a]).size/1048576;if(t>10)throw new Error(`æ•°æ®å¤ªå¤§ (${t.toFixed(2)}MB)ï¼Œè¶…è¿‡ 10MB é™åˆ¶`)}catch(t){throw console.error('[DICE]ACU JSON åºåˆ—åŒ–å¤±è´¥:',t),new Error(`æ•°æ®åºåˆ—åŒ–å¤±è´¥: ${t.message||t}`)}const n=$e().getDB();if(!n||!n.importTableAsJson)throw new Error('æ•°æ®åº“ API ä¸å¯ç”¨');try{if(!1===await n.importTableAsJson(a))throw new Error('æ•°æ®å¯¼å…¥å¤±è´¥ï¼ˆè¿”å› falseï¼‰')}catch(t){console.error('[DICE]ACU API ä¿å­˜å¤±è´¥:',t);const e=t.message||String(t);if(e.includes('Settings could not be saved')||e.includes('server connection')||e.includes('data loss'))throw new Error('ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨è¿æ¥é—®é¢˜æˆ–æ•°æ®è¿‡å¤§ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å‡å°‘æ•°æ®é‡');throw new Error(`ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥: ${e}`)}ie=e}catch(t){throw console.error('[DICE]ACU saveDataOnly error:',t),t}}).catch(t=>{console.error('[DICE]ACU saveDataOnly queue error:',t)});return Zt=e,e},_a=async(t,e,a)=>{try{const n=ie||wa();if(!n||!n[t])throw new Error(`è¡¨æ ¼ "${t}" ä¸å­˜åœ¨`);if(!n[t].content)throw new Error(`è¡¨æ ¼ "${t}" å†…å®¹ä¸ºç©º`);n[t].content[e+1]=a,await $a(n);const o=Ne();o&&o[t]&&o[t].content&&(o[t].content[e+1]=[...a],Re(o))}catch(t){const e=t instanceof Error?t.message:String(t);throw console.error('[DICE]ACU saveRowInstantly error:',t),toastr.error(`ä¿å­˜å¤±è´¥: ${e}`),t}},Ca=t=>{const e={};if(!t||'object'!=typeof t)return e;for(const a in t)if(t[a]?.name){const n=t[a];e[n.name]={key:a,headers:n.content&&n.content[0]||[],rows:n.content?n.content.slice(1):[],rawContent:n.content||[],exportConfig:n.exportConfig||{},updateConfig:n.updateConfig||{},...n}}return e};const Ea=()=>{const{$}=$e(),t=$('.acu-settings-dialog');if(!t.length)return;const e=t.find('#regex-rules-list');if(!e.length)return;const a=nt.getAllRules().map(t=>{const e='global'===t.scope.type?'fa-globe':'table'===t.scope.type?'fa-table':'fa-columns',a='global'===t.scope.type?'å…¨å±€':'table'===t.scope.type?t.scope.tableNames?.join(','):`${t.scope.tableNames?.join(',')}.${t.scope.columnNames?.join(',')}`;return`\n          <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${r(t.id)}">\n              <div class="acu-rule-type-icon" title="ä½œç”¨åŸŸ: ${r(t.scope.type)}">\n                  <i class="fa-solid ${e}"></i>\n              </div>\n              <div class="acu-rule-info">\n                  <div class="acu-rule-name">${r(t.name)}</div>\n                  <div class="acu-rule-target" style="font-size:10px;">${r(a)} | ${r(t.operation)}</div>\n              </div>\n              <button class="acu-rule-edit" data-rule-id="${r(t.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n              <div class="acu-rule-toggle ${t.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n                  <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n              </div>\n              <button class="acu-rule-delete" data-rule-id="${r(t.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n          </div>\n      `}).join('');e.html(a)},Aa=(t,e)=>{const{$}=$e(),a=`acu-theme-${ma().theme}`,n=ie||wa(),o=Ca(n||{}),i=Object.keys(o),s=!!e,l=s?at.getRule(e):null,u=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay" ${s?'style="opacity:0;transition:opacity 0.15s ease-in;"':''}>\n        <div class="acu-edit-dialog acu-validation-modal ${a}">\n          <div class="acu-dice-cfg-header">\n            <span><i class="fa-solid ${s?'fa-pen':'fa-plus'}"></i> ${s?'ç¼–è¾‘éªŒè¯è§„åˆ™':'æ·»åŠ è‡ªå®šä¹‰éªŒè¯è§„åˆ™'}</span>\n            <button class="acu-config-close" id="dlg-rule-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-validation-modal-body">\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™åç§°</span></div>\n              <input type="text" id="rule-name" class="acu-panel-input" placeholder="å¦‚ï¼šç‰©å“æ•°é‡é™åˆ¶" style="flex:1;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">ç›®æ ‡è¡¨æ ¼</span></div>\n              <select id="rule-table" class="acu-setting-select">\n                <option value="">è¯·é€‰æ‹©...</option>\n                ${i.map(t=>`<option value="${r(t)}">${r(t)}</option>`).join('')}\n              </select>\n            </div>\n            <div class="acu-setting-row" id="row-column">\n              <div class="acu-setting-info"><span class="acu-setting-label">ç›®æ ‡åˆ—</span></div>\n              <select id="rule-column" class="acu-setting-select" disabled>\n                <option value="">è¯·å…ˆé€‰æ‹©è¡¨æ ¼...</option>\n              </select>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™ç±»å‹</span></div>\n              <select id="rule-type" class="acu-setting-select">\n                <optgroup label="â”€â”€ è¡¨çº§è§„åˆ™ â”€â”€">\n                  <option value="tableReadonly">è¡¨çº§åªè¯»ï¼ˆç¦æ­¢ä¿®æ”¹ï¼‰</option>\n                  <option value="rowLimit">è¡Œæ•°é™åˆ¶</option>\n                  <option value="sequence">åºåˆ—é€’å¢</option>\n                </optgroup>\n                <optgroup label="â”€â”€ å­—æ®µçº§è§„åˆ™ â”€â”€">\n                  <option value="required">å¿…å¡«</option>\n                  <option value="format">æ ¼å¼éªŒè¯ï¼ˆæ­£åˆ™ï¼‰</option>\n                  <option value="enum">æšä¸¾éªŒè¯ï¼ˆå¯é€‰å€¼ï¼‰</option>\n                  <option value="numeric">æ•°å€¼èŒƒå›´</option>\n                  <option value="relation">å…³è”éªŒè¯ï¼ˆå¼•ç”¨å…¶ä»–è¡¨ï¼‰</option>\n                  <option value="keyValue">é”®å€¼å¯¹éªŒè¯</option>\n                </optgroup>\n              </select>\n            </div>\n            \x3c!-- è¡¨çº§åªè¯»æ— éœ€é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-tableReadonly">\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> å¯ç”¨å,è¯¥è¡¨å°†ä¸å…è®¸ä»»ä½•ä¿®æ”¹\n              </div>\n            </div>\n            \x3c!-- è¡Œæ•°é™åˆ¶é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-rowLimit" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">æœ€å°‘è¡Œæ•°</span></div>\n                <input type="number" id="cfg-row-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">æœ€å¤šè¡Œæ•°</span></div>\n                <input type="number" id="cfg-row-max" class="acu-panel-input" placeholder="ä¸é™" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- åºåˆ—é€’å¢é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-sequence" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">ç¼–ç å‰ç¼€</span></div>\n                <input type="text" id="cfg-sequence-prefix" class="acu-panel-input" placeholder="å¦‚ï¼šAM" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">èµ·å§‹æ•°å­—</span></div>\n                <input type="number" id="cfg-sequence-start" class="acu-panel-input" placeholder="1" value="1" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">é…å¯¹è¡¨ï¼ˆå¯é€‰ï¼‰</span></div>\n                <select id="cfg-sequence-paired-table" class="acu-setting-select" style="flex:1;">\n                  <option value="">æ— ï¼ˆå•è¡¨ä¿®å¤ï¼‰</option>\n                  ${i.map(t=>`<option value="${r(t)}">${r(t)}</option>`).join('')}\n                </select>\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> æ£€æŸ¥æŒ‡å®šåˆ—çš„å€¼æ˜¯å¦ä»"å‰ç¼€+èµ·å§‹æ•°å­—"å¼€å§‹ä¸¥æ ¼é€’å¢(å¦‚AM0001, AM0002, AM0003...),ä¸å¯è·³å·æˆ–é‡å¤ã€‚éœ€è¦æŒ‡å®šç›®æ ‡åˆ—ã€‚<br>\n                <i class="fa-solid fa-link" style="margin-top:4px;display:block;color:var(--acu-warning-icon);margin-right:6px;"></i> å¦‚æœè®¾ç½®äº†é…å¯¹è¡¨,ä¿®å¤æ—¶ä¼šåŒæ—¶ä¿®å¤ä¸¤ä¸ªè¡¨çš„ç¼–ç ,ç¡®ä¿ç›¸åŒç¼–ç å€¼ä¿®å¤åä»ç„¶ç›¸åŒã€‚\n              </div>\n            </div>\n            \x3c!-- å¿…å¡«æ— éœ€é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-required" style="display:none;">\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> è¯¥å­—æ®µä¸èƒ½ä¸ºç©º\n              </div>\n            </div>\n            \x3c!-- æ ¼å¼éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-format" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">æ­£åˆ™è¡¨è¾¾å¼</span></div>\n                <input type="text" id="cfg-pattern" class="acu-panel-input" placeholder="å¦‚ï¼š^AM\\d{3}$" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- æšä¸¾éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-enum" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å…è®¸çš„å€¼</span></div>\n                <input type="text" id="cfg-values" class="acu-panel-input" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šè¿›è¡Œä¸­,å·²å®Œæˆ,å·²å¤±è´¥" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- æ•°å€¼èŒƒå›´é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-numeric" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">æœ€å°å€¼</span></div>\n                <input type="number" id="cfg-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">æœ€å¤§å€¼</span></div>\n                <input type="number" id="cfg-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- å…³è”éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-relation" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å…³è”è¡¨æ ¼</span></div>\n                <select id="cfg-ref-table" class="acu-setting-select">\n                  <option value="">è¯·é€‰æ‹©...</option>\n                  ${i.map(t=>`<option value="${r(t)}">${r(t)}</option>`).join('')}\n                </select>\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å…³è”åˆ—</span></div>\n                <select id="cfg-ref-column" class="acu-setting-select" multiple style="flex:1;min-height:80px;">\n                  <option value="">è¯·å…ˆé€‰æ‹©å…³è”è¡¨æ ¼...</option>\n                </select>\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> å¯é€‰æ‹©å¤šåˆ—,ä»»ä¸€åˆ—åŒ¹é…å³é€šè¿‡éªŒè¯(OR é€»è¾‘)ã€‚ä½¿ç”¨ Ctrl/Cmd é”®å¯é€‰æ‹©å¤šä¸ªåˆ—ã€‚\n              </div>\n            </div>\n            \x3c!-- é”®å€¼å¯¹éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-keyValue" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å€¼ç±»å‹</span></div>\n                <select id="cfg-keyvalue-type" class="acu-setting-select">\n                  <option value="text">æ–‡æœ¬å‹ï¼ˆåªéªŒè¯æ ¼å¼ï¼‰</option>\n                  <option value="numeric">æ•°å€¼å‹ï¼ˆéªŒè¯æ ¼å¼å’Œæ•°å€¼èŒƒå›´ï¼‰</option>\n                </select>\n              </div>\n              <div class="acu-setting-row" id="row-keyvalue-range" style="display:none;">\n                <div class="acu-setting-info"><span class="acu-setting-label">æœ€å°å€¼</span></div>\n                <input type="number" id="cfg-keyvalue-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">æœ€å¤§å€¼</span></div>\n                <input type="number" id="cfg-keyvalue-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> æ ¼å¼:é”®:å€¼;é”®:å€¼(ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹,è‡ªåŠ¨å»é™¤ç©ºæ ¼)ã€‚æ•°å€¼å‹ä¼šéªŒè¯æ¯ä¸ªå€¼çš„èŒƒå›´ã€‚\n              </div>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">é”™è¯¯æç¤º</span></div>\n              <input type="text" id="rule-error-msg" class="acu-panel-input" placeholder="éªŒè¯å¤±è´¥æ—¶æ˜¾ç¤ºçš„æç¤ºä¿¡æ¯" style="flex:1;">\n            </div>\n          </div>\n          <div class="acu-dice-cfg-actions">\n            <button id="dlg-rule-cancel">å–æ¶ˆ</button>\n            <button id="dlg-rule-save">${s?'ä¿å­˜':'æ·»åŠ '}</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(u);const d=t=>{const e=t.val();e&&''!==e?(t.css('color','var(--acu-text-main)'),t.css('opacity','1')):(t.css('color','var(--acu-text-sub)'),t.css('opacity','0.7'))};u.find('select').each(function(){d($(this)),$(this).on('change',function(){d($(this))})}),u.find('#rule-table').on('change',function(){const t=$(this).val(),e=u.find('#rule-column'),a=u.find('#cfg-sequence-paired-table');if(d($(this)),a.length>0){const e=a.val();a.empty(),a.append('<option value="">æ— ï¼ˆå•è¡¨ä¿®å¤ï¼‰</option>'),i.filter(e=>e!==t).forEach(t=>{a.append(`<option value="${r(t)}">${r(t)}</option>`)}),e&&e!==t&&a.val(e),d(a)}if(!t||!o[t])return e.html('<option value="">è¯·å…ˆé€‰æ‹©è¡¨æ ¼...</option>').prop('disabled',!0),void d(e);const n=(o[t].headers||[]).filter((t,e)=>e>0&&t).map(t=>`<option value="${r(t)}">${r(t)}</option>`).join('');e.html('<option value="">è¯·é€‰æ‹©...</option>'+n).prop('disabled',!1),d(e)}),u.find('#cfg-ref-table').on('change',function(){const t=$(this).val(),e=u.find('#cfg-ref-column');if(d($(this)),!t||!o[t])return e.html('<option value="">è¯·å…ˆé€‰æ‹©å…³è”è¡¨æ ¼...</option>').prop('disabled',!0),void d(e);const a=(o[t].headers||[]).filter((t,e)=>e>0&&t).map(t=>`<option value="${r(t)}">${r(t)}</option>`).join('');e.html(a).prop('disabled',!1),d(e)}),u.find('#rule-type').on('change',function(){const t=$(this).val(),e=W[t],a='table'===e?.scope;d($(this)),u.find('.acu-rule-config-section').hide(),u.find('#config-'+t).show(),a&&'sequence'!==t?(u.find('#row-column').hide(),u.find('#rule-column').val('').prop('disabled',!0)):(u.find('#row-column').show(),u.find('#rule-table').val()&&u.find('#rule-column').prop('disabled',!1))}),u.find('#cfg-keyvalue-type').on('change',function(){'numeric'===$(this).val()?u.find('#row-keyvalue-range').show():u.find('#row-keyvalue-range').hide()});const p=()=>u.remove();u.on('click','#dlg-rule-close, #dlg-rule-cancel',function(t){t.stopPropagation(),p()}),c(u,'acu-validation-modal-overlay',()=>{p()}),u.find('#dlg-rule-save').on('click',function(){const a=u.find('#rule-name').val()?.trim(),n=u.find('#rule-table').val(),o=u.find('#rule-column').val(),i=u.find('#rule-type').val(),c=u.find('#rule-error-msg').val()?.trim(),d=W[i],g='table'===d?.scope;if(!a)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥è§„åˆ™åç§°'));if(!n)return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©ç›®æ ‡è¡¨æ ¼'));if(!(g&&'sequence'!==i||o))return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©ç›®æ ‡åˆ—'));const f={};if('tableReadonly'===i);else if('rowLimit'===i){const t=u.find('#cfg-row-min').val(),e=u.find('#cfg-row-max').val();''!==t&&(f.min=parseInt(t,10)),''!==e&&(f.max=parseInt(e,10))}else if('required'===i);else if('format'===i){const t=u.find('#cfg-pattern').val()?.trim();if(!t)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼'));try{new RegExp(t)}catch(t){return void(window.toastr&&window.toastr.error('æ­£åˆ™è¡¨è¾¾å¼æ— æ•ˆ'))}f.pattern=t}else if('enum'===i){const t=u.find('#cfg-values').val()?.trim();if(!t)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥å…è®¸çš„å€¼'));f.values=t.split(',').map(t=>t.trim()).filter(t=>t)}else if('numeric'===i){const t=u.find('#cfg-min').val(),e=u.find('#cfg-max').val();''!==t&&(f.min=parseFloat(t)),''!==e&&(f.max=parseFloat(e))}else if('relation'===i){const t=u.find('#cfg-ref-table').val(),e=u.find('#cfg-ref-column').val();if(!t)return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©å…³è”è¡¨æ ¼'));const a=Array.isArray(e)?e:e?[e]:[];if(0===a.length||1===a.length&&!a[0])return void(window.toastr&&window.toastr.warning('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—ä½œä¸ºå…³è”åˆ—'));f.refTable=t,f.refColumn=1===a.length?a[0]:a}else if('keyValue'===i){const t=u.find('#cfg-keyvalue-type').val();if(f.valueType=t||'text','numeric'===t){const t=u.find('#cfg-keyvalue-min').val(),e=u.find('#cfg-keyvalue-max').val();''!==t&&(f.valueMin=parseFloat(t)),''!==e&&(f.valueMax=parseFloat(e))}}else if('sequence'===i){const t=u.find('#cfg-sequence-prefix').val()?.trim()||'',e=u.find('#cfg-sequence-start').val(),a=u.find('#cfg-sequence-paired-table').val()?.trim()||null;if(f.prefix=t,f.startFrom=''!==e?parseInt(e,10):1,isNaN(f.startFrom))return void(window.toastr&&window.toastr.warning('èµ·å§‹æ•°å­—å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—'));a&&(f.pairedTable=a)}const b=s?e:'custom_'+Date.now()+'_'+Math.random().toString(36).substr(2,6),m={id:b,name:a,description:l?.description||'',targetTable:n,targetColumn:g&&'sequence'!==i?'':o,ruleType:i,config:f,errorMessage:c||d?.desc||'æ•°æ®éªŒè¯å¤±è´¥',intercept:l?.intercept??!1,enabled:l?.enabled??!0};let v=!1;if(v=s?at.updateCustomRule(e,m):at.addCustomRule(m),v){p(),at.clearCache();const c=t.find('#validation-rules-list');if(s){const t=c.find(`.acu-validation-rule-item[data-rule-id="${r(e)}"]`);if(t.length){const e=m.enabled;t.find('.acu-rule-name').text(a),t.find('.acu-rule-target').text(`${n}${g&&'sequence'!==i?' (æ•´è¡¨)':'.'+o}`),t.find('.acu-rule-type-icon').attr('title',`${d?.name||i}${g?' (è¡¨çº§)':''}`).find('i').attr('class',`fa-solid ${d?.icon||'fa-question'}`),t.toggleClass('disabled',!e)}}else{const t=`\n          <div class="acu-validation-rule-item" data-rule-id="${r(b)}">\n            <div class="acu-rule-type-icon" title="${r(d?.name||i)}${g?' (è¡¨çº§)':''}">\n              <i class="fa-solid ${d?.icon||'fa-question'}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${r(a)}</div>\n              <div class="acu-rule-target">${r(n)}${g&&'sequence'!==i?' (æ•´è¡¨)':'.'+r(o)}</div>\n            </div>\n            <div class="acu-rule-intercept" data-rule-id="${r(b)}" title="ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰"><i class="fa-solid fa-shield-halved"></i></div>\n            <button class="acu-rule-edit" data-rule-id="${r(b)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n            <div class="acu-rule-toggle active" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n              <i class="fa-solid fa-toggle-on"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${r(b)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n          </div>\n        `;c.append(t)}}else window.toastr&&window.toastr.error(s?'è§„åˆ™æ›´æ–°å¤±è´¥':'è§„åˆ™æ·»åŠ å¤±è´¥')}),s&&l&&(u.find('#rule-name').val(l.name||''),u.find('#rule-error-msg').val(l.errorMessage||''),u.find('#rule-table').val(l.targetTable||'').trigger('change'),u.find('#rule-type').val(l.ruleType||'required').trigger('change'),setTimeout(()=>{l.targetColumn&&(u.find('#rule-column').val(l.targetColumn),d(u.find('#rule-column')));const t=l.config||{},e=l.ruleType;if('rowLimit'===e)void 0!==t.min&&u.find('#cfg-row-min').val(t.min),void 0!==t.max&&u.find('#cfg-row-max').val(t.max);else if('sequence'===e)u.find('#cfg-sequence-prefix').val(t.prefix||''),u.find('#cfg-sequence-start').val(t.startFrom??1),t.pairedTable&&(u.find('#cfg-sequence-paired-table').val(t.pairedTable),d(u.find('#cfg-sequence-paired-table')));else if('format'===e)u.find('#cfg-pattern').val(t.pattern||'');else if('enum'===e)u.find('#cfg-values').val((t.values||[]).join(','));else if('numeric'===e)void 0!==t.min&&u.find('#cfg-min').val(t.min),void 0!==t.max&&u.find('#cfg-max').val(t.max);else if('relation'===e){if(t.refTable)return u.find('#cfg-ref-table').val(t.refTable).trigger('change'),void setTimeout(()=>{const e=Array.isArray(t.refColumn)?t.refColumn:t.refColumn?[t.refColumn]:[];u.find('#cfg-ref-column').val(e),d(u.find('#cfg-ref-column')),u.css('opacity','1')},100)}else'keyValue'===e&&(u.find('#cfg-keyvalue-type').val(t.valueType||'text').trigger('change'),void 0!==t.valueMin&&u.find('#cfg-keyvalue-min').val(t.valueMin),void 0!==t.valueMax&&u.find('#cfg-keyvalue-max').val(t.valueMax));u.css('opacity','1')},100))},Da=t=>{if(!t||!t.rule)return void(window.toastr&&window.toastr.warning('æ— æ³•è·å–è§„åˆ™ä¿¡æ¯'));const{$}=$e(),e=`acu-theme-${ma().theme}`,a=t.rule,n=t.ruleType||a.ruleType,o=W[n]||{name:n,icon:'fa-question'},i='table'===o?.scope,s=ie||wa(),l=Ne();if(!t.rowTitle&&t.rowIndex>=0&&s&&t.tableName)for(const e in s)if(s[e]?.name===t.tableName){const a=s[e].content?.[t.rowIndex+1];a&&(t.rowTitle=a[1]||a[0]||`è¡Œ ${t.rowIndex+1}`);break}let u='';if(!i&&l&&t.tableName&&void 0!==t.columnName)for(const e in l)if(l[e]?.name===t.tableName){const a=(l[e].content?.[0]||[]).indexOf(t.columnName),n=t.rowIndex+1;a>=0&&l[e].content?.[n]&&(u=l[e].content[n][a]??'');break}const d=''!==u&&String(u)!==String(t.currentValue||'');if(i)return void Ma(t,a,n,s,l,e);let p='';p=('enum'===n&&a.config?.values||'relation'===n&&a.config?.refTable&&a.config?.refColumn||'numeric'===n||'format'===n&&a.config,`<textarea id="smart-fix-value" class="acu-edit-textarea" spellcheck="false"\n        style="width:100%;min-height:60px;max-height:200px;resize:none;">${r(t.currentValue||'')}</textarea>`);let g='';if('required'===n){const e=function(t,e,a,n,o=5){const i=new Set;if(!t||!e||!n)return[];for(const o in n)if(n[o]?.name===t){const t=n[o].content?.[0]||[],r=n[o].content?.slice(1)||[],c=t.indexOf(e);c>=0&&r.forEach((t,e)=>{if(e!==a){const e=t?.[c];null!=e&&''!==String(e).trim()&&i.add(String(e).trim())}});break}return Array.from(i).slice(0,o)}(t.tableName,t.columnName,t.rowIndex,s,5);e.length>0&&(g=`\n          <div class="acu-smart-fix-suggest">\n            <div class="acu-smart-fix-suggest-label">\n              <i class="fa-solid fa-lightbulb"></i> åŒåˆ—ç¤ºä¾‹å€¼:\n            </div>\n            <div class="acu-smart-fix-suggest-options">\n              ${e.map(t=>`\n                <span class="acu-smart-fix-option" data-value="${r(t)}" title="ç‚¹å‡»å¡«å……">\n                  ${r(t.length>20?t.substring(0,20)+'...':t)}\n                </span>\n              `).join('')}\n            </div>\n          </div>\n        `)}else if('enum'===n&&a.config?.values){g=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-list"></i> å…è®¸çš„å€¼ (ç‚¹å‡»é€‰æ‹©):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll">\n            ${a.config.values.map(e=>`\n              <span class="acu-smart-fix-option ${t.currentValue===e?'acu-smart-fix-option-current':''}"\n                    data-value="${r(e)}" title="${t.currentValue===e?'å½“å‰å€¼ï¼ˆæ— æ•ˆï¼‰':'ç‚¹å‡»é€‰æ‹©'}">\n                ${r(e)}\n              </span>\n            `).join('')}\n          </div>\n        </div>\n      `}else if('format'===n&&a.config?.pattern){let e=null;if(s&&t.tableName)for(const a in s)if(s[a]?.name===t.tableName){e=s[a];break}const n=function(t,e,a=[],n=null){if(!t||void 0===e||e<0)return null;try{const a=t.match(/^\^?([A-Za-z]+)\\d\{(\d+)\}\$?$/);if(a){const t=a[1],o=parseInt(a[2],10);if(n&&('æ€»ç»“è¡¨'===n.name||'æ€»ä½“å¤§çº²'===n.name)){const e=n.content?.[0]||[],a=n.content?.slice(1)||[],i=e.indexOf('ç¼–ç ç´¢å¼•');if(i>=0){const e=[];a.forEach(a=>{const n=a?.[i];if(n&&'string'==typeof n){const a=n.match(new RegExp(`^${t}(\\d+)$`));if(a){const t=parseInt(a[1],10);isNaN(t)||e.push(t)}}});const n=e.length>0?Math.max(...e):0,r=String(n+1).padStart(o,'0');return t+r}}const i=String(e+1).padStart(o,'0');return t+i}const o=t.match(/^\^?\\d\{(\d+)\}\$?$/);if(o){const t=parseInt(o[1],10);return String(e+1).padStart(t,'0')}}catch(t){console.error('[DICE]ACU æ ¼å¼æ¨ç®—å¤±è´¥:',t)}return null}(a.config.pattern,t.rowIndex,[],e);g=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-font"></i> æ ¼å¼è¦æ±‚: <code>${r(a.config.pattern)}</code>\n          </div>\n          ${n?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-suggest-label" style="margin-bottom:4px;display:block;">\n                <i class="fa-solid fa-lightbulb"></i> æ¨èå€¼:\n              </span>\n              <span class="acu-smart-fix-quick-btn" data-value="${r(n)}">\n                <i class="fa-solid fa-magic"></i> ${r(n)}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('numeric'===n){const e=a.config?.min,n=a.config?.max,o=parseFloat(t.currentValue),i=!isNaN(o)&&(void 0!==e&&o<e||void 0!==n&&o>n),r=i?function(t,e,a){const n=parseFloat(t);return isNaN(n)?void 0!==e?e:0:void 0!==e&&n<e?e:void 0!==a&&n>a?a:n}(t.currentValue,e,n):null;g=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-hashtag"></i> å…è®¸èŒƒå›´: ${void 0!==e?e:'-âˆ'} ~ ${void 0!==n?n:'+âˆ'}\n          </div>\n          ${i&&null!==r?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${r}">\n                <i class="fa-solid fa-arrow-right"></i> ä¿®æ­£ä¸º ${r}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('relation'===n&&a.config?.refTable&&a.config?.refColumn){const e=function(t,e,a){const n=new Set;if(!t||!e||!a)return Array.from(n);const o=Array.isArray(e)?e:[e];for(const e in a)if(a[e]?.name===t){const t=a[e].content?.[0]||[],i=a[e].content?.slice(1)||[];o.forEach(e=>{const a=t.indexOf(e);a>=0&&i.forEach(t=>{const e=t?.[a];null!=e&&''!==String(e).trim()&&n.add(String(e).trim())})});break}return Array.from(n).sort()}(a.config.refTable,a.config.refColumn,s),n=Array.isArray(a.config.refColumn)?a.config.refColumn:[a.config.refColumn],o=n.length>1,i=String(t.currentValue||'').trim(),c=function(t,e,a,n){if(!(t&&e&&a&&n))return!1;if(''===String(t).trim())return!1;const o=Array.isArray(a)?a:[a],i=String(t).trim();for(const t in n)if(n[t]?.name===e){const e=n[t].content?.[0]||[],a=n[t].content?.slice(1)||[];for(const t of o){const n=e.indexOf(t);if(-1!==n)for(let t=0;t<a.length;t++){const e=a[t]?.[n];if(null!=e&&String(e).trim()===i)return!0}}break}return!1}(i,a.config.refTable,a.config.refColumn,s);let l='';e.length>0&&(l=`\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-link"></i> å…³è”è¡¨ "${r(a.config.refTable)}" å¯ç”¨å€¼ (${e.length}é¡¹):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll" id="smart-fix-options-container">\n            ${e.map(e=>`\n              <span class="acu-smart-fix-option ${t.currentValue===e?'acu-smart-fix-option-current':''}"\n                    data-value="${r(e)}" title="${t.currentValue===e?'å½“å‰å€¼ï¼ˆæ— æ•ˆï¼‰':'ç‚¹å‡»é€‰æ‹©'}">\n                ${r(e)}\n              </span>\n            `).join('')}\n          </div>\n        `);let u='';i&&!c&&(u=o?`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--acu-border);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> åå‘å†™å…¥åˆ°å…³è”è¡¨:\n              </div>\n              <div style="margin-top:8px;">\n                <select id="smart-fix-reverse-column" class="acu-edit-select" style="width:100%;margin-bottom:8px;">\n                  ${n.map(t=>`<option value="${r(t)}">${r(t)}</option>`).join('')}\n                </select>\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> å°† "${r(i.length>30?i.substring(0,30)+'...':i)}" å†™å…¥åˆ° "${r(a.config.refTable)}"\n                </button>\n              </div>\n            </div>\n          `:`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--acu-border);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> åå‘å†™å…¥åˆ°å…³è”è¡¨:\n              </div>\n              <div style="margin-top:8px;">\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" data-column="${r(n[0])}" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> å°† "${r(i.length>30?i.substring(0,30)+'...':i)}" å†™å…¥åˆ° "${r(a.config.refTable)}.${r(n[0])}"\n                </button>\n              </div>\n            </div>\n          `),(l||u)&&(g=`\n          <div class="acu-smart-fix-suggest">\n            ${l}\n            ${u}\n          </div>\n        `)}else if('keyValue'===n){const e=a.config?.valueType||'text',n=a.config?.valueMin,o=a.config?.valueMax;let i=String(t.currentValue||'');i=i.replace(/ï¼š/g,':').replace(/ï¼›/g,';').replace(/ï¼Œ/g,';').replace(/\s+/g,'');const c=i.split(';').filter(t=>t.trim()),s=[],l=[];for(const t of c){const a=t.indexOf(':');if(-1===a||0===a||a===t.length-1){s.push({pair:t,error:'æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘å†’å·æˆ–é”®/å€¼ä¸ºç©º'});continue}const i=t.substring(0,a),r=t.substring(a+1);if(!i||!r){s.push({pair:t,error:'é”®æˆ–å€¼ä¸èƒ½ä¸ºç©º'});continue}let c=r,u=!1;if('numeric'===e){const e=parseFloat(r);isNaN(e)?(s.push({pair:t,error:`"${r}" ä¸æ˜¯æœ‰æ•ˆæ•°å­—`}),u=!0):null!=n&&e<n?(c=String(n),s.push({pair:t,error:`æ•°å€¼ ${e} å°äºæœ€å°å€¼ ${n}`}),u=!0):null!=o&&e>o&&(c=String(o),s.push({pair:t,error:`æ•°å€¼ ${e} å¤§äºæœ€å¤§å€¼ ${o}`}),u=!0)}l.push({key:i,val:c,originalVal:r,hasIssue:u})}const u=l.map(t=>`${t.key}:${t.val}`).join(';'),d=s.length>0||l.some(t=>t.hasIssue);let p='';d&&(p=`\n          <div class="acu-smart-fix-suggest-label" style="margin-bottom:8px;">\n            <i class="fa-solid fa-exclamation-triangle"></i> é—®é¢˜åˆ—è¡¨:\n          </div>\n          <div style="margin-bottom:8px;">\n            ${s.map(t=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">âŒ</span> ${r(t.pair)} - ${r(t.error)}\n              </div>\n            `).join('')}\n            ${l.filter(t=>t.hasIssue).map(t=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">âš ï¸</span> ${r(t.key)}:${r(t.originalVal)} â†’ ${r(t.val)}\n              </div>\n            `).join('')}\n          </div>\n        `),g=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-key"></i> æ ¼å¼è¦æ±‚: é”®:å€¼;é”®:å€¼ï¼ˆä½¿ç”¨è‹±æ–‡æ ‡ç‚¹ï¼Œè‡ªåŠ¨å»é™¤ç©ºæ ¼ï¼‰\n          </div>\n          ${'numeric'===e?`\n            <div class="acu-smart-fix-suggest-label" style="margin-top:8px;">\n              <i class="fa-solid fa-hashtag"></i> æ•°å€¼èŒƒå›´: ${void 0!==n?n:'-âˆ'} ~ ${void 0!==o?o:'+âˆ'}\n            </div>\n          `:''}\n          ${p}\n          ${d?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${r(u)}">\n                <i class="fa-solid fa-magic"></i> ä¸€é”®ä¿®æ­£æ‰€æœ‰é—®é¢˜\n              </span>\n            </div>\n            <div style="margin-top:8px;padding:8px;background:var(--acu-card-bg);border-radius:4px;font-size:11px;color:var(--acu-text-sub);">\n              <div style="margin-bottom:4px;"><strong>ä¿®æ­£åé¢„è§ˆ:</strong></div>\n              <code style="color:var(--acu-success-text);">${r(u)}</code>\n            </div>\n          `:'\n            <div style="margin-top:8px;padding:8px;background:var(--acu-success-bg);border-radius:4px;font-size:11px;color:var(--acu-success-text);">\n              <i class="fa-solid fa-check-circle"></i> æ ¼å¼æ­£ç¡®\n            </div>\n          '}\n        </div>\n      `}const f=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${e}" style="max-width:450px;">\n          <div class="acu-edit-title">æ™ºèƒ½ä¿®æ”¹: ${r(t.tableName||'')} - ${r(t.columnName||'')}</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            \x3c!-- è§„åˆ™è¯´æ˜ --\x3e\n            <div class="acu-smart-fix-rule-info">\n              <div class="acu-smart-fix-rule-header">\n                <i class="fa-solid ${o.icon}"></i>\n                <span>${r(t.ruleName||a.name||'')}</span>\n              </div>\n              <div class="acu-smart-fix-rule-desc">${r(t.errorMessage||a.errorMessage||o.desc||'')}</div>\n            </div>\n\n            \x3c!-- å¿«ç…§å€¼ï¼ˆåªè¯»ï¼‰ --\x3e\n            ${d?`\n              <div class="acu-diff-section acu-diff-old-section">\n                <div class="acu-diff-label">\n                  <i class="fa-solid fa-clock-rotate-left"></i> å¿«ç…§å€¼ï¼ˆåŸå§‹ï¼‰\n                </div>\n                <div class="acu-diff-readonly">${r(u)}</div>\n              </div>\n              <div class="acu-diff-arrow-down"><i class="fa-solid fa-arrow-down"></i></div>\n            `:''}\n\n            \x3c!-- å½“å‰å€¼ï¼ˆå¯ç¼–è¾‘ï¼‰ --\x3e\n            <div class="acu-diff-section acu-diff-new-section">\n              ${t.rowTitle&&t.rowIndex>=0?`<div style="font-size:12px;color:var(--acu-text-sub);margin-bottom:8px;padding:4px 8px;background:var(--acu-bg-sub);border-radius:4px;">\n                <i class="fa-solid fa-tag" style="margin-right:4px;"></i>${r(t.rowTitle)}\n              </div>`:''}\n              <div class="acu-diff-label">\n                <i class="fa-solid fa-pen"></i> å½“å‰å€¼ï¼ˆå¯ç¼–è¾‘ï¼‰\n              </div>\n              ${p}\n            </div>\n\n            \x3c!-- æ™ºèƒ½å»ºè®® --\x3e\n            ${g?`\n              <div class="acu-smart-fix-suggest-section">\n                ${g}\n              </div>\n            `:''}\n          </div>\n          <div class="acu-dialog-btns">\n            <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n            ${d?'<button class="acu-dialog-btn acu-btn-revert" id="smart-fix-revert"><i class="fa-solid fa-rotate-left"></i> æ¢å¤å¿«ç…§å€¼</button>':''}\n            <button class="acu-dialog-btn acu-btn-clear" id="smart-fix-clear"><i class="fa-solid fa-eraser"></i> æ¸…ç©ºå½“å‰å€¼</button>\n            <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-confirm"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(f),f.on('click','.acu-smart-fix-option, .acu-smart-fix-quick-btn',function(){if('smart-fix-reverse-write-btn'===$(this).attr('id'))return;if($(this).hasClass('acu-smart-fix-option-current'))return;const t=$(this).data('value')||$(this).text().trim();f.find('#smart-fix-value').val(t).trigger('input')}),f.on('click','#smart-fix-reverse-write-btn',async function(){const e=String(t.currentValue||'').trim();if(!e)return void(window.toastr&&window.toastr.warning('æ— æ³•å†™å…¥ç©ºå€¼'));let o;if('relation'===n&&a.config?.refColumn){{const t=Array.isArray(a.config.refColumn)?a.config.refColumn:[a.config.refColumn];o=t.length>1?f.find('#smart-fix-reverse-column').val():$(this).data('column')||t[0]}if(o&&a.config?.refTable)try{const t=ie||wa();let n=null,i=null;for(const e in t)if(t[e]?.name===a.config.refTable){n=t[e],i=e;break}if(!n||!n.content)return void(window.toastr&&window.toastr.error(`æ‰¾ä¸åˆ°å…³è”è¡¨ "${a.config.refTable}"`));const r=n.content[0]||[],c=r.indexOf(o);if(-1===c)return void(window.toastr&&window.toastr.error(`å…³è”è¡¨ä¸­ä¸å­˜åœ¨åˆ— "${o}"`));const s=new Array(r.length).fill('');s[c]=e,n.content.push(s),await ka(t,!1,!1),b(),nn()}catch(t){console.error('[DICE]ACU åå‘å†™å…¥å¤±è´¥:',t),window.toastr&&window.toastr.error('åå‘å†™å…¥å¤±è´¥: '+(t.message||'æœªçŸ¥é”™è¯¯'))}else window.toastr&&window.toastr.error('æ— æ³•ç¡®å®šç›®æ ‡è¡¨æˆ–åˆ—')}else window.toastr&&window.toastr.error('æ— æ³•ç¡®å®šç›®æ ‡åˆ—')}),f.on('click','#smart-fix-revert',function(){f.find('#smart-fix-value').val(u)}),f.on('click','#smart-fix-clear',function(){f.find('#smart-fix-value').val('').trigger('input')});const b=()=>f.remove();f.on('click','#smart-fix-close, #smart-fix-cancel',b),c(f,'acu-validation-modal-overlay',b),f.find('#smart-fix-confirm').on('click',async function(){const e=f.find('#smart-fix-value').val()?.trim()||'';if(''!==e||'required'!==n)try{const a=ie||wa();let n=!1;for(const o in a)if(a[o]?.name===t.tableName){const i=a[o],r=i.content?.[0]||[];if(t.rowIndex>=0&&t.columnName){const a=r.indexOf(t.columnName),o=t.rowIndex+1;if(a>=0&&i.content&&i.content[o]){i.content[o][a]=e,n=!0;break}}}n?(await ka(a,!1,!1),b(),nn()):window.toastr&&window.toastr.error('æ— æ³•æ‰¾åˆ°ç›®æ ‡å•å…ƒæ ¼')}catch(t){console.error('[DICE]ACU æ›´æ–°å•å…ƒæ ¼å¤±è´¥:',t),window.toastr&&window.toastr.error('æ›´æ–°å¤±è´¥: '+(t.message||'æœªçŸ¥é”™è¯¯'))}else window.toastr&&window.toastr.warning('å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º')})};function Ia(t,e,a){if(!t||!t.content||t.content.length<2)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const n=t.content[0]||[],o=t.content.slice(1)||[],i=n.indexOf(e);if(i<0)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const r=new Map,c=new Set,s=new Map;for(let t=0;t<o.length;t++){const e=o[t]?.[i];if(null==e||''===e)continue;const n=String(e).trim();if(!n)continue;let r=!1;if(a){n.match(new RegExp(`^${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(r=!0)}else{const t=parseInt(n,10);isNaN(t)||(r=!0)}r&&(c.add(n),s.has(n)||s.set(n,[]),s.get(n).push(t))}return{codes:r,allCodes:c,codeToRows:s}}function Fa(t,e,a,n){const o=new Set([...t,...e]),i=[];for(const t of o){let e=null;if(a){const n=t.match(new RegExp(`^${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));n&&(e=parseInt(n[1],10))}else e=parseInt(t,10);isNaN(e)||i.push({code:t,num:e})}i.sort((t,e)=>t.num-e.num);const r=new Map;for(let t=0;t<i.length;t++){const e=i[t].code,o=a+String(n+t).padStart(4,'0');r.set(e,o)}return r}function Sa(t,e,a,n,o,i,r,c,s){if(!t||!a)return{fixedCount1:0,fixedCount2:0};const l=t.content[0]||[],u=t.content.slice(1)||[],d=l.indexOf(o),p=a.content[0]||[],g=a.content.slice(1)||[],f=p.indexOf(o);if(d<0||f<0)return{fixedCount1:0,fixedCount2:0};let b=0,m=0;const v=new Map;for(const[t,e]of i.entries())v.set(e,t);const h=Array.from(i.values()).sort((t,e)=>parseInt(t.replace(r,''),10)-parseInt(e.replace(r,''),10)),x=(t,e)=>{const a=[],n=[];for(let o=0;o<t.length;o++){const i=t[o]?.[e],c=null==i?'':String(i).trim();let s=!1;if(c&&r){c.match(new RegExp(`^${r.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(s=!0)}else if(c){const t=parseInt(c,10);isNaN(t)||(s=!0)}s?a.push({rowIndex:o,oldCode:c,row:t[o]}):n.push({rowIndex:o,row:t[o],prevOldCode:null,nextOldCode:null})}for(const t of n){let e=null,n=null;for(const o of a)if(o.rowIndex<t.rowIndex&&(e=o.oldCode),o.rowIndex>t.rowIndex&&null===n){n=o.oldCode;break}t.prevOldCode=e,t.nextOldCode=n}return{codeRows:a,emptyRows:n}},y=x(u,d),w=x(g,f),k=(t,e,a,n)=>{const o=[],r=new Map;for(const e of t.codeRows)r.set(e.oldCode,e.row);for(const t of h){const n=v.get(t);if(r.has(n)){const e=r.get(n).map(t=>t);e[a]=t,o.push({newCode:t,row:e,isCodeRow:!0})}else{const n=new Array(e.length).fill(null);n[a]=t,o.push({newCode:t,row:n,isCodeRow:!0,isInserted:!0})}}const c=[];let s=0;for(const e of t.emptyRows)if(null===e.prevOldCode&&null!==e.nextOldCode){const t=i.get(e.nextOldCode);for(;s<o.length&&o[s].newCode!==t;)c.push(o[s].row),s++;c.push(e.row)}else null===e.prevOldCode&&null===e.nextOldCode&&c.push(e.row);for(;s<o.length;s++){c.push(o[s].row);const e=o[s].newCode,a=v.get(e);for(const e of t.emptyRows)e.prevOldCode===a&&c.push(e.row)}for(const e of t.emptyRows)null!==e.prevOldCode&&e.nextOldCode;return c},C=k(y,l,d,new Set(y.codeRows.map(t=>t.oldCode))),E=k(w,p,f,new Set(w.codeRows.map(t=>t.oldCode))),A=(t,e,a)=>{let n=0;const o=new Set(t.codeRows.map(t=>t.oldCode)),r=new Set;for(const t of e){const e=t[a];e&&r.add(e)}for(const[t,e]of i.entries())o.has(t)&&t!==e&&n++;for(const t of h){const e=v.get(t);o.has(e)||n++}return n};return b=A(y,C,d),m=A(w,E,f),t.content=[l,...C],a.content=[p,...E],{fixedCount1:b,fixedCount2:m}}const Ma=(t,e,a,n,o,i)=>{const{$}=$e();let s='',l='';if('tableReadonly'===a){let e=0,a=[];if(o&&n)for(const i in n)if(n[i]?.name===t.tableName&&o[i]){const t=n[i].content?.slice(1)||[],r=o[i].content?.slice(1)||[];if(t.forEach((t,n)=>{const o=r[n];if(o){for(let i=0;i<t.length;i++)if(String(t[i]||'')!==String(o[i]||'')){a.push(`ç¬¬${n+1}è¡Œ: æœ‰ä¿®æ”¹`),e++;break}}else a.push(`ç¬¬${n+1}è¡Œ: æ–°å¢`),e++}),r.length>t.length)for(let n=t.length;n<r.length;n++)a.push(`ç¬¬${n+1}è¡Œ: å·²åˆ é™¤`),e++;break}s=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-lock"></i>\n            <span>è¡¨åªè¯»ä¿æŠ¤</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">æ­¤è¡¨è¢«è®¾ç½®ä¸ºåªè¯»ï¼Œä½†æ£€æµ‹åˆ°æœ‰ä¿®æ”¹ã€‚</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            æ£€æµ‹åˆ° <strong>${e}</strong> å¤„ä¿®æ”¹\n          </div>\n          ${a.length>0?`\n            <div class="acu-smart-fix-change-list">\n              ${a.slice(0,10).map(t=>`<div class="acu-smart-fix-change-item">${r(t)}</div>`).join('')}\n              ${a.length>10?`<div class="acu-smart-fix-change-item">... è¿˜æœ‰ ${a.length-10} å¤„</div>`:''}\n            </div>\n          `:''}\n        </div>\n      `,l='\n        <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n        <button class="acu-dialog-btn acu-btn-revert" id="smart-fix-restore-table"><i class="fa-solid fa-rotate-left"></i> æ¢å¤æ•´è¡¨</button>\n      '}else if('rowLimit'===a){const a=e.config?.min,o=e.config?.max;let i=0,c=[];for(const e in n)if(n[e]?.name===t.tableName){i=(n[e].content?.length||1)-1;break}const u=void 0!==o&&i>o,d=void 0!==a&&i<a;if(u)for(let t=o+1;t<=i;t++)c.push(t);s=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-arrows-up-down"></i>\n            <span>è¡Œæ•°é™åˆ¶</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${r(t.errorMessage||e.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            å½“å‰è¡Œæ•°: <strong>${i}</strong> è¡Œ\n            ${void 0!==a||void 0!==o?` | é™åˆ¶: ${void 0!==a?a:0} ~ ${void 0!==o?o:'âˆ'} è¡Œ`:''}\n          </div>\n          ${u&&c.length>0?`\n            <div class="acu-smart-fix-excess-rows">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-trash"></i> éœ€åˆ é™¤çš„è¡Œ (ç¬¬ ${c[0]} è¡ŒåŠä¹‹å):\n              </div>\n              <div class="acu-smart-fix-change-list">\n                ${c.slice(0,10).map(t=>`<div class="acu-smart-fix-change-item">ç¬¬ ${t} è¡Œ</div>`).join('')}\n                ${c.length>10?`<div class="acu-smart-fix-change-item">... å…± ${c.length} è¡Œ</div>`:''}\n              </div>\n            </div>\n          `:''}\n          ${d?`\n            <div class="acu-smart-fix-hint">\n              <i class="fa-solid fa-info-circle"></i> éœ€è¦æ·»åŠ  ${a-i} è¡Œæ‰èƒ½æ»¡è¶³æœ€å°è¡Œæ•°è¦æ±‚\n            </div>\n          `:''}\n        </div>\n      `,l=u&&c.length>0?`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-delete-rows" data-start="${o}" data-table="${r(t.tableName)}">\n            <i class="fa-solid fa-trash"></i> åˆ é™¤å¤šä½™çš„ ${c.length} è¡Œ\n          </button>\n        `:'<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å…³é—­</button>'}else if('sequence'===a&&e.targetColumn){const a=e.config?.prefix||'',o=void 0!==e.config?.startFrom?e.config?.startFrom:1;let i=null,c=[],u=[];for(const e in n)if(n[e]?.name===t.tableName){i=n[e];break}if(i&&i.content&&i.content.length>1){const t=i.content[0]||[],n=i.content.slice(1)||[],r=t.indexOf(e.targetColumn);if(r>=0){const t=[];for(let e=0;e<n.length;e++){const o=n[e]?.[r];if(null==o||''===o)continue;const i=String(o).trim();if(!i)continue;let c=null;if(a){const t=i.match(new RegExp(`^${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));t&&(c=parseInt(t[1],10))}else c=parseInt(i,10);isNaN(c)||t.push({rowIndex:e,value:i,num:c,originalRowIndex:e+2})}t.sort((t,e)=>t.rowIndex-e.rowIndex);const e=new Map,i=[],s=[],l=[];for(let a=0;a<t.length;a++){const n=t[a].num;e.has(n)||e.set(n,[]),e.get(n).push(a)}for(let a=0;a<t.length;a++){const n=o+a,r=t[a].num,c=t[a].originalRowIndex,u=e.get(r)||[];u.length>1&&u[0]===a&&i.push({rowNum:c,value:t[a].value,num:r,expectedNum:n,count:u.length}),r!==n&&(r<n?l.push({rowNum:c,value:t[a].value,num:r,expectedNum:n}):s.push({rowNum:c,value:t[a].value,num:r,expectedNum:n}))}for(let e=0;e<t.length;e++){const n=o+e,r=t[e].num,c=t[e].originalRowIndex,s=t[e].value,l=a+String(n).padStart(4,'0');(r!==n||i.some(t=>t.num===r&&t.rowNum===c))&&u.push({rowNum:c,currentValue:s,fixedValue:l,reason:r<n?'é‡å¤æˆ–é¡ºåºé”™è¯¯':r>n?'è·³å·':'é‡å¤'})}const d=new Set;i.forEach(t=>{d.add(`ç¬¬${t.rowNum}è¡Œ: "${t.value}" é‡å¤ (å‡ºç°${t.count}æ¬¡)`)}),s.forEach(t=>{d.add(`ç¬¬${t.rowNum}è¡Œ: "${t.value}" åº”ä¸º "${a}${String(t.expectedNum).padStart(4,'0')}" (è·³å·)`)}),l.forEach(t=>{d.add(`ç¬¬${t.rowNum}è¡Œ: "${t.value}" åº”ä¸º "${a}${String(t.expectedNum).padStart(4,'0')}" (é¡ºåºé”™è¯¯)`)}),c=Array.from(d)}}if(s=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-sort-numeric-up"></i>\n            <span>åºåˆ—é€’å¢éªŒè¯</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${r(t.errorMessage||e.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            æ£€æµ‹åˆ° <strong>${c.length}</strong> ä¸ªé—®é¢˜\n          </div>\n          ${c.length>0?`\n            <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n              ${c.slice(0,20).map(t=>`<div class="acu-smart-fix-change-item">${r(t)}</div>`).join('')}\n              ${c.length>20?`<div class="acu-smart-fix-change-item">... è¿˜æœ‰ ${c.length-20} ä¸ªé—®é¢˜</div>`:''}\n            </div>\n          `:''}\n          ${u.length>0?`\n            <div class="acu-smart-fix-suggest" style="margin-top:12px;">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-lightbulb"></i> ä¿®å¤å»ºè®®:\n              </div>\n              <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n                ${u.slice(0,20).map(t=>`\n                  <div class="acu-smart-fix-change-item">\n                    <span style="color:var(--acu-text-sub);">ç¬¬${t.rowNum}è¡Œ:</span>\n                    <span style="color:var(--acu-hl-manual);">${r(t.currentValue)}</span>\n                    <span style="color:var(--acu-text-sub);"> â†’ </span>\n                    <span style="color:var(--acu-hl-auto);">${r(t.fixedValue)}</span>\n                    <span style="color:var(--acu-text-sub);font-size:11px;"> (${r(t.reason)})</span>\n                  </div>\n                `).join('')}\n                ${u.length>20?`<div class="acu-smart-fix-change-item">... è¿˜æœ‰ ${u.length-20} å¤„éœ€è¦ä¿®å¤</div>`:''}\n              </div>\n            </div>\n          `:''}\n        </div>\n      `,u.length>0){const n=e.config?.pairedTable||('æ€»ç»“è¡¨'===t.tableName?'æ€»ä½“å¤§çº²':'æ€»ä½“å¤§çº²'===t.tableName?'æ€»ç»“è¡¨':null),i=n?`data-paired-table="${r(n)}"`:'';l=`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-fix-sequence" data-table="${r(t.tableName)}" data-column="${r(e.targetColumn)}" data-prefix="${r(a)}" data-start="${o}" ${i}>\n            <i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤ ${u.length} å¤„\n          </button>\n        `}else l='<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å…³é—­</button>'}const u=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${i}" style="max-width:450px;">\n          <div class="acu-edit-title">æ™ºèƒ½ä¿®æ”¹: ${r(t.tableName||'')} (è¡¨çº§è§„åˆ™)</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            ${s}\n          </div>\n          <div class="acu-dialog-btns">\n            ${l}\n          </div>\n        </div>\n      </div>\n    `);$('body').append(u);const d=()=>u.remove();u.on('click','#smart-fix-cancel',d),c(u,'acu-validation-modal-overlay',d),u.on('click','#smart-fix-restore-table',async function(){if(o)try{for(const e in n)if(n[e]?.name===t.tableName&&o[e]){n[e]=JSON.parse(JSON.stringify(o[e]));break}await ka(n,!1,!1),d(),nn()}catch(t){console.error('[DICE]ACU æ¢å¤è¡¨å¤±è´¥:',t),window.toastr&&window.toastr.error('æ¢å¤å¤±è´¥: '+(t.message||'æœªçŸ¥é”™è¯¯'))}else window.toastr&&window.toastr.warning('æ— å¿«ç…§æ•°æ®')}),u.on('click','#smart-fix-fix-sequence',async function(){const t=$(this),e=t.data('table'),a=t.data('column'),o=t.data('prefix')||'',i=parseInt(t.data('start')||'1',10),r=t.data('paired-table')||null;try{t.prop('disabled',!0).html('<i class="fa-solid fa-spinner fa-spin"></i> ä¿®å¤ä¸­...');let c=null,s=null;for(const t in n)if(n[t]?.name===e){c=n[t],s=t;break}if(!c||!c.content||c.content.length<2)return window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°ç›®æ ‡è¡¨'),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');const l=c.content[0]||[],u=c.content.slice(1)||[],p=l.indexOf(a);if(p<0)return window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°ç›®æ ‡åˆ—'),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');if(r){let e=null,s=null;for(const t in n)if(n[t]?.name===r){e=n[t],s=t;break}if(!e||!e.content||e.content.length<1)return window.toastr&&window.toastr.warning(`æœªæ‰¾åˆ°é…å¯¹è¡¨: ${r}`),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');const l=e.content[0]||[];if(l.indexOf(a)<0)return window.toastr&&window.toastr.warning(`é…å¯¹è¡¨ä¸­æœªæ‰¾åˆ°ç›®æ ‡åˆ—: ${a}`),void t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');const u=Ia(c,a,o),p=Ia(e,a,o),g=Fa(u.allCodes,p.allCodes,o,i),{fixedCount1:f,fixedCount2:b}=Sa(c,0,e,0,a,g,o);await ka(n,!1,!1),d(),nn()}else{const t=[];for(let e=0;e<u.length;e++){const a=u[e]?.[p];if(null==a||''===a)continue;const n=String(a).trim();if(!n)continue;let i=null;if(o){const t=n.match(new RegExp(`^${o.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));t&&(i=parseInt(t[1],10))}else i=parseInt(n,10);isNaN(i)||t.push({rowIndex:e,value:n,num:i})}t.sort((t,e)=>t.rowIndex-e.rowIndex);let e=0;for(let a=0;a<t.length;a++){const n=i+a,r=t[a].num,c=t[a].rowIndex;if(r!==n){const t=o+String(n).padStart(4,'0');u[c][p]=t,e++}}await ka(n,!1,!1),d(),nn()}}catch(e){console.error('[DICE]ACU ä¿®å¤åºåˆ—é€’å¢å¤±è´¥:',e),window.toastr&&window.toastr.error('ä¿®å¤å¤±è´¥: '+(e.message||'æœªçŸ¥é”™è¯¯')),t.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤')}}),u.on('click','#smart-fix-delete-rows',async function(){const t=parseInt($(this).data('start'),10),e=$(this).data('table');try{for(const a in n)if(n[a]?.name===e){n[a].content=n[a].content.slice(0,t+1);break}await ka(n,!1,!1),d(),nn()}catch(t){console.error('[DICE]ACU åˆ é™¤è¡Œå¤±è´¥:',t),window.toastr&&window.toastr.error('åˆ é™¤å¤±è´¥: '+(t.message||'æœªçŸ¥é”™è¯¯'))}})},za=()=>{const{$}=$e(),t=ma();$('.acu-blacklist-manager-overlay').remove();Q.getBlacklist();const e=$(`\n      <div class="acu-blacklist-manager-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="max-width: 600px; width: 90%;">\n          <div class="acu-edit-title" style="position: relative;">\n            <i class="fa-solid fa-filter"></i> å˜é‡è¿‡æ»¤é»‘åå•ç®¡ç†\n            <button class="acu-close-btn" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--acu-text-main); cursor: pointer; font-size: 18px; z-index: 10;">\n              <i class="fa-solid fa-times"></i>\n            </button>\n          </div>\n          <div class="acu-settings-content" style="flex: 1; overflow-y: auto; padding: 20px;">\n            <div style="margin-bottom: 15px;">\n              <div style="margin-bottom: 8px; font-size: 12px; color: var(--acu-text-sub);">\n                é»‘åå•ä¸­çš„å…³é”®è¯å¯¹åº”çš„æœ€ä¸‹å±‚å˜é‡åæˆ–åˆ—åå°†ä¸ä¼šæ˜¾ç¤ºå¿«æ·éª°å­å›¾æ ‡\n              </div>\n              <textarea id="blacklist-textarea" style="width: 100%; min-height: 120px; max-height: 300px; padding: 10px !important; border: 1px solid var(--acu-border) !important; border-radius: 4px !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-size: 13px !important; box-sizing: border-box !important; resize: vertical; font-family: monospace; line-height: 1.5;" placeholder="è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆæ”¯æŒä¸­è‹±æ–‡é€—å·ï¼‰"></textarea>\n              <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: nowrap;">\n                <input type="text" id="blacklist-input" placeholder="è¾“å…¥å…³é”®è¯..." style="flex: 1; min-width: 0; padding: 8px !important; border: 1px solid var(--acu-border) !important; border-radius: 4px !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-size: 13px !important; box-sizing: border-box !important;">\n                <button id="blacklist-add-btn" style="padding: 8px 16px; background: var(--acu-accent); color: var(--acu-btn-active-text); border: none; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap; flex-shrink: 0;">\n                  <i class="fa-solid fa-plus"></i> æ·»åŠ \n                </button>\n              </div>\n            </div>\n            <div style="display: flex; gap: 8px; margin-top: 15px;">\n              <button id="blacklist-reset-btn" style="flex: 1; padding: 10px; background: var(--acu-btn-bg); color: var(--acu-text-main); border: 1px solid var(--acu-border); border-radius: 4px; cursor: pointer; font-size: 13px;">\n                <i class="fa-solid fa-undo"></i> é‡ç½®ä¸ºé»˜è®¤\n              </button>\n              <button id="blacklist-close-btn" style="flex: 1; padding: 10px; background: var(--acu-accent); color: var(--acu-btn-active-text); border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">\n                <i class="fa-solid fa-check"></i> å®Œæˆ\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(e),e.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',background:'rgba(0,0,0,0.6)','z-index':'31300',display:'flex','align-items':'center','justify-content':'center',padding:'20px','box-sizing':'border-box'});const a=()=>{const t=Q.getBlacklist();e.find('#blacklist-textarea').val(t.join('ï¼Œ'))};a(),e.find('#blacklist-textarea').on('input',function(){(()=>{const t=e.find('#blacklist-textarea').val().trim();if(!t)return void Q.setBlacklist([]);const n=t.split(/[ï¼Œ,]/).map(t=>t.trim()).filter(t=>t.length>0),o=[...new Set(n)];Q.setBlacklist(o),o.length!==n.length&&a()})()}),e.find('#blacklist-add-btn').click(function(){const t=e.find('#blacklist-input'),n=t.val().trim();if(!n)return;const o=n.split(/[ï¼Œ,]/).map(t=>t.trim()).filter(t=>t.length>0);if(0===o.length)return;const i=Q.getBlacklist(),r=new Set(i),c=[];o.forEach(t=>{r.has(t)||(i.push(t),r.add(t),c.push(t))}),0!==c.length?(Q.setBlacklist(i),t.val(''),a()):window.toastr&&window.toastr.warning('æ‰€æœ‰é¡¹å·²å­˜åœ¨')}),e.find('#blacklist-input').on('keypress',function(t){13===t.which&&e.find('#blacklist-add-btn').click()}),e.find('#blacklist-reset-btn').click(function(){confirm('ç¡®å®šè¦é‡ç½®é»‘åå•ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')&&(Q.resetToDefault(),a())});const n=()=>{e.remove(),nn()};e.find('#blacklist-close-btn, .acu-close-btn').click(n),c(e,'acu-blacklist-manager-overlay',n)},ja=()=>{const{$}=$e();$('.acu-edit-overlay').remove();const t=ma(),e=$t.getAllPresets(),a=Ae.get(I,null),n=`\n      <div class="acu-preset-item" data-id="__default__">\n        <div class="acu-preset-info">\n          <div class="acu-preset-name">\n            å…­ç»´å±æ€§ç™¾åˆ†åˆ¶\n            <span style="font-size: 10px; color: var(--acu-text-sub); margin-left: 6px;">(é»˜è®¤)</span>\n          </div>\n          <div class="acu-preset-desc">ä½¿ç”¨ç™¾åˆ†åˆ¶ç”Ÿæˆå…­ç»´åŸºç¡€å±æ€§ï¼ˆåŠ›é‡ã€æ•æ·ã€ä½“è´¨ã€æ™ºåŠ›ã€æ„ŸçŸ¥ã€é­…åŠ›ï¼‰ï¼ŒèŒƒå›´5-95</div>\n          <div class="acu-preset-stats">\n            åŸºç¡€å±æ€§: 6 | ç‰¹åˆ«å±æ€§: 0\n          </div>\n        </div>\n<div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n            <label class="acu-toggle" style="margin: 0;">\n              <input type="checkbox" class="acu-preset-toggle" data-id="__default__" ${null===a?'checked':''}>\n              <span class="acu-toggle-slider"></span>\n            </label>\n            <button class="acu-preset-btn acu-preset-copy" data-id="__default__" title="å¤åˆ¶ä¸ºè‡ªå®šä¹‰é¢„è®¾"><i class="fa-solid fa-copy"></i></button>\n            <button class="acu-preset-btn acu-preset-export" data-id="__default__" title="å¯¼å‡º"><i class="fa-solid fa-download"></i></button>\n          </div>\n        </div>\n    `+e.map(t=>{const e=t.id===a,n=t.builtin;return`\n        <div class="acu-preset-item" data-id="${t.id}">\n          <div class="acu-preset-info">\n            <div class="acu-preset-name">\n              ${r(t.name)}\n              ${n?'<span style="font-size: 10px; color: var(--acu-text-sub); margin-left: 6px;">(å†…ç½®)</span>':''}\n            </div>\n            ${t.description?`<div class="acu-preset-desc">${r(t.description)}</div>`:''}\n            <div class="acu-preset-stats">\n              åŸºç¡€å±æ€§: ${t.baseAttributes.length} | ç‰¹åˆ«å±æ€§: ${t.specialAttributes?.length||0}\n            </div>\n          </div>\n          <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n            <label class="acu-toggle" style="margin: 0;">\n              <input type="checkbox" class="acu-preset-toggle" data-id="${t.id}" ${e?'checked':''}>\n              <span class="acu-toggle-slider"></span>\n            </label>\n            ${n?`<button class="acu-preset-btn acu-preset-copy" data-id="${t.id}" title="å¤åˆ¶ä¸ºè‡ªå®šä¹‰é¢„è®¾"><i class="fa-solid fa-copy"></i></button>`:`<button class="acu-preset-btn acu-preset-edit" data-id="${t.id}" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>`}\n            <button class="acu-preset-btn acu-preset-export" data-id="${t.id}" title="å¯¼å‡º"><i class="fa-solid fa-download"></i></button>\n            ${n?'':`<button class="acu-preset-btn acu-preset-delete" data-id="${t.id}" title="åˆ é™¤" style="color: var(--acu-error-text);"><i class="fa-solid fa-trash"></i></button>`}\n          </div>\n        </div>\n      `}).join(''),o=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="width: 600px; max-width: 92vw; max-height: 80vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-dice-d20"></i> è‡ªå®šä¹‰å±æ€§è§„åˆ™ç®¡ç†\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div id="acu-presets-list">\n              ${n||'<div style="text-align: center; padding: 40px; color: var(--acu-text-sub);">æš‚æ— é¢„è®¾</div>'}\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="acu-preset-new" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-plus"></i> æ–°å»ºé¢„è®¾\n            </button>\n            <button id="acu-preset-import" style="flex: 1; padding: 10px; background: var(--acu-btn-bg); border: 1px solid var(--acu-border); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-file-import"></i> å¯¼å…¥\n            </button>\n            <button id="acu-preset-back" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-border); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-arrow-left"></i> è¿”å›\n            </button>\n          </div>\n\n          <input type="file" id="acu-preset-file-input" accept=".json" style="display: none;" />\n        </div>\n      </div>\n    `);$('body').append(o),o.find('.acu-close-btn, #acu-preset-back').on('click',()=>{o.remove(),tn()}),o.on('change','.acu-preset-toggle',function(){const t=$(this),e=t.data('id');if(t.is(':checked')){const t='__default__'===e?null:e;$t.setActivePreset(t),o.find('.acu-preset-toggle').each(function(){const t=$(this);t.data('id')!==e&&t.prop('checked',!1)})}else $t.setActivePreset(null)}),o.on('click','.acu-preset-edit',function(){const t=$(this).data('id');o.remove(),Ta(t)}),o.on('click','.acu-preset-export',function(){const t=$(this).data('id');let a,n;if('__default__'===t){const t={format:'acu_attr_preset_v1',version:T,id:'default_percentile',name:'å…­ç»´å±æ€§ç™¾åˆ†åˆ¶',description:'ä½¿ç”¨ç™¾åˆ†åˆ¶ç”Ÿæˆå…­ç»´åŸºç¡€å±æ€§ï¼ˆåŠ›é‡ã€æ•æ·ã€ä½“è´¨ã€æ™ºåŠ›ã€æ„ŸçŸ¥ã€é­…åŠ›ï¼‰ï¼ŒèŒƒå›´5-95',baseAttributes:['åŠ›é‡','æ•æ·','ä½“è´¨','æ™ºåŠ›','æ„ŸçŸ¥','é­…åŠ›'].map(t=>({name:t,formula:'3d6*5',range:[15,90],modifier:'1d10-5'})),specialAttributes:[]};a=JSON.stringify(t,null,2),n=`acu_preset_å…­ç»´å±æ€§ç™¾åˆ†åˆ¶_${Date.now()}.json`}else{if(a=$t.exportPreset(t),!a)return void(window.toastr&&window.toastr.error('å¯¼å‡ºå¤±è´¥'));const o=e.find(e=>e.id===t);n=`acu_preset_${o?.name||t}_${Date.now()}.json`}const o=new Blob([a],{type:'application/json'}),i=URL.createObjectURL(o),r=document.createElement('a');r.href=i,r.download=n,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}),o.on('click','.acu-preset-delete',function(){const t=$(this).data('id'),a=e.find(e=>e.id===t);if(confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ã€Œ${a?.name}ã€å—ï¼Ÿ`)){$t.deletePreset(t)?(o.remove(),ja()):window.toastr&&window.toastr.error('åˆ é™¤å¤±è´¥')}}),o.on('click','.acu-preset-copy',function(){const t=$(this).data('id');let a;if('__default__'===t){a={name:'å…­ç»´å±æ€§ç™¾åˆ†åˆ¶ (å‰¯æœ¬)',description:'ä½¿ç”¨ç™¾åˆ†åˆ¶ç”Ÿæˆå…­ç»´åŸºç¡€å±æ€§ï¼ˆåŠ›é‡ã€æ•æ·ã€ä½“è´¨ã€æ™ºåŠ›ã€æ„ŸçŸ¥ã€é­…åŠ›ï¼‰ï¼ŒèŒƒå›´5-95',baseAttributes:['åŠ›é‡','æ•æ·','ä½“è´¨','æ™ºåŠ›','æ„ŸçŸ¥','é­…åŠ›'].map(t=>({name:t,formula:'3d6*5',range:[15,90],modifier:'1d10-5'})),specialAttributes:[]}}else{const n=e.find(e=>e.id===t);if(!n)return;a={name:n.name+' (å‰¯æœ¬)',description:n.description||'',baseAttributes:JSON.parse(JSON.stringify(n.baseAttributes)),specialAttributes:JSON.parse(JSON.stringify(n.specialAttributes||[]))}}const n=$t.createPreset(a);n&&(window.toastr&&window.toastr.success(`å·²åˆ›å»ºå‰¯æœ¬ï¼š${n.name}`),o.remove(),ja())}),o.find('#acu-preset-new').on('click',()=>{o.remove(),Ta()}),o.find('#acu-preset-import').on('click',()=>{o.find('#acu-preset-file-input').click()}),o.find('#acu-preset-file-input').on('change',function(t){const e=t.target.files[0];if(!e)return;const a=new FileReader;a.onload=t=>{try{const e=t.target.result;if(!e?.trim())return;let a;try{a=JSON.parse(e.trim())}catch{return void(window.toastr&&window.toastr.error('JSONæ ¼å¼æ— æ•ˆ'))}const n=a?.name||'å¯¼å…¥çš„é¢„è®¾',i=$t.getAllPresets(),r=i.map(t=>t.name),c=r.includes(n),l=(t,r)=>{let s=e.trim();if(r&&(a.name=r,a.id=`attr_preset_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=JSON.stringify(a)),t&&c){const t=i.find(t=>t.name===n);t&&!t.builtin&&$t.deletePreset(t.id)}$t.importPreset(s)?(o.remove(),ja()):window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥ï¼šæ ¼å¼ä¸æ­£ç¡®')};c?s({presetName:n,presetType:'å±æ€§è§„åˆ™',existingNames:r,onOverwrite:()=>l(!0),onRename:t=>l(!1,t),onCancel:()=>{}}):l(!1)}catch(t){console.error('[DICE]ACU å¯¼å…¥é¢„è®¾å¤±è´¥:',t),window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥')}},a.readAsText(e),$(this).val('')}),c(o,'acu-edit-overlay',()=>{o.remove(),tn()})},Ta=(t=null)=>{const{$}=$e();$('.acu-edit-overlay').remove();const e=ma(),a=!!t,n=a?$t.getAllPresets().find(e=>e.id===t):null,o={name:n?.name||'æ–°è§„åˆ™é¢„è®¾',description:n?.description||'',baseAttributes:n?.baseAttributes||[{name:'åŠ›é‡',formula:'3d6',range:[3,18]},{name:'æ•æ·',formula:'3d6',range:[3,18]},{name:'ä½“è´¨',formula:'3d6',range:[3,18]},{name:'æ™ºåŠ›',formula:'3d6',range:[3,18]},{name:'æ„ŸçŸ¥',formula:'3d6',range:[3,18]},{name:'é­…åŠ›',formula:'3d6',range:[3,18]}],specialAttributes:n?.specialAttributes||[]},i=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${e.theme}" style="width: 650px; max-width: 95vw; max-height: 85vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-pen"></i> ${a?'ç¼–è¾‘':'æ–°å»º'}è§„åˆ™é¢„è®¾\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">é¢„è®¾åç§°</label>\n              <input id="preset-name" type="text" value="${r(o.name)}" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">æè¿°</label>\n              <input id="preset-desc" type="text" value="${r(o.description)}" placeholder="å¯é€‰" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 8px;">\n                JSONé…ç½® <span style="font-size: 10px; color: var(--acu-text-sub);">(æ”¯æŒç›´æ¥ç¼–è¾‘æˆ–å¯¼å…¥)</span>\n              </label>\n              <textarea id="preset-json" class="acu-preset-editor-textarea" style="width: 100%; height: 320px; padding: 10px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-family: 'Consolas', 'Monaco', monospace !important; font-size: 12px; resize: vertical; box-sizing: border-box;"></textarea>\n            </div>\n\n            <div style="font-size: 11px; color: var(--acu-text-sub); padding: 8px; background: var(--acu-table-head); border-radius: 6px; line-height: 1.6;">\n              <strong>é…ç½®æ ¼å¼è¯´æ˜ï¼š</strong><br/>\n              â€¢ baseAttributes: åŸºæœ¬å±æ€§æ•°ç»„ï¼Œæ¯é¡¹åŒ…å« nameã€formulaã€rangeã€modifier(å¯é€‰)<br/>\n              â€¢ specialAttributes: ç‰¹åˆ«å±æ€§æ•°ç»„ï¼Œæ¯é¡¹åŒ…å« nameã€formulaã€range(å¯é€‰)<br/>\n              â€¢ å…¬å¼æ”¯æŒ: 3d6, 4d6kh3, å˜é‡å¼•ç”¨(åŠ›é‡/2), æ•°å­¦è¿ç®—(+ã€-ã€*ã€/)\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="preset-save" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px; font-weight: bold;">\n              <i class="fa-solid fa-check"></i> ä¿å­˜\n            </button>\n            <button id="preset-cancel" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-border); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-times"></i> å–æ¶ˆ\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(i);const s=i.find('#preset-json');(()=>{const t={baseAttributes:o.baseAttributes,specialAttributes:o.specialAttributes};s.val(JSON.stringify(t,null,2))})(),i.find('.acu-close-btn, #preset-cancel').on('click',()=>{i.remove(),ja()}),i.find('#preset-save').on('click',()=>{try{const e=i.find('#preset-name').val().trim(),n=i.find('#preset-desc').val().trim(),o=s.val().trim();if(!e)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥é¢„è®¾åç§°'));const r=JSON.parse(o);if(!r.baseAttributes||!Array.isArray(r.baseAttributes)||0===r.baseAttributes.length)return void(window.toastr&&window.toastr.error('åŸºæœ¬å±æ€§ä¸èƒ½ä¸ºç©º'));const c={format:'acu_attr_preset_v1',version:1,id:t||`custom_${Date.now()}`,name:e,description:n,baseAttributes:r.baseAttributes,specialAttributes:r.specialAttributes||[]};a?$t.updatePreset(t,c):$t.createPreset(c),i.remove(),ja()}catch(t){console.error('[DICE]ACU ä¿å­˜é¢„è®¾å¤±è´¥:',t),window.toastr&&window.toastr.error('ä¿å­˜å¤±è´¥ï¼š'+(t.message||'JSONæ ¼å¼é”™è¯¯'))}}),c(i,'acu-edit-overlay',()=>{i.remove(),tn()})},Pa=()=>{const{$}=$e();$('.acu-edit-overlay').remove();const t=ma(),e=Ct.getAllPresets(),a=Ct.getActivePresetId(),n=0===e.length?'<div style="text-align: center; padding: 40px; color: var(--acu-text-sub);">æš‚æ— è‡ªå®šä¹‰è§„åˆ™ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»º</div>':e.map(t=>{const e=t.id===a,n=!0===t.builtin,o=(t.rules||[]).flatMap(t=>t.table_keywords||[]).slice(0,3).join('ã€')||'æ— ',i=(t.rules||[]).flatMap(t=>(t.actions||[]).map(t=>t.label)).slice(0,4).join('ã€')||'æ— ';return`\n          <div class="acu-preset-item" data-id="${t.id}">\n            <div class="acu-preset-info">\n              <div class="acu-preset-name">${r(t.name)}${n?'<span style="font-size: 10px; color: var(--acu-text-sub); margin-left: 6px;">(å†…ç½®)</span>':''}</div>\n              ${t.description?`<div class="acu-preset-desc">${r(t.description)}</div>`:''}\n              <div class="acu-preset-stats" style="font-size: 11px; color: var(--acu-text-sub);">\n                å…³é”®è¯: ${r(o)} | åŠ¨ä½œ: ${r(i)}\n              </div>\n            </div>\n            <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n              <label class="acu-toggle" style="margin: 0;">\n                <input type="checkbox" class="acu-action-preset-toggle" data-id="${t.id}" ${e?'checked':''}>\n                <span class="acu-toggle-slider"></span>\n              </label>\n              ${n?`<button class="acu-preset-btn acu-action-preset-copy" data-id="${t.id}" title="å¤åˆ¶ä¸ºè‡ªå®šä¹‰è§„åˆ™"><i class="fa-solid fa-copy"></i></button>`:`<button class="acu-preset-btn acu-action-preset-edit" data-id="${t.id}" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>`}\n              <button class="acu-preset-btn acu-action-preset-export" data-id="${t.id}" title="å¯¼å‡º"><i class="fa-solid fa-download"></i></button>\n              ${n?'':`<button class="acu-preset-btn acu-action-preset-delete" data-id="${t.id}" title="åˆ é™¤" style="color: var(--acu-error-text);"><i class="fa-solid fa-trash"></i></button>`}\n            </div>\n          </div>\n        `}).join(''),o=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="width: 600px; max-width: 92vw; max-height: 80vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-wand-magic-sparkles"></i> è‡ªå®šä¹‰äº¤äº’è§„åˆ™ç®¡ç†\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div id="acu-action-presets-list">\n              ${n}\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="acu-action-preset-new" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-plus"></i> æ–°å»ºè§„åˆ™\n            </button>\n            <button id="acu-action-preset-import" style="flex: 1; padding: 10px; background: var(--acu-btn-bg); border: 1px solid var(--acu-border); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-file-import"></i> å¯¼å…¥\n            </button>\n            <button id="acu-action-preset-back" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-border); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-arrow-left"></i> è¿”å›\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(o),o.find('.acu-close-btn, #acu-action-preset-back').on('click',()=>{o.remove(),tn()}),o.on('change','.acu-action-preset-toggle',function(){const t=$(this),e=t.data('id');t.is(':checked')?(Ct.setActivePresetId(e),o.find('.acu-action-preset-toggle').each(function(){$(this).data('id')!==e&&$(this).prop('checked',!1)})):Ct.getActivePresetId()===e&&(Ct.setActivePresetId(null),window.toastr&&window.toastr.info('æ‰€æœ‰äº¤äº’è§„åˆ™å·²ç¦ç”¨'))}),o.on('click','.acu-action-preset-edit',function(){const t=$(this).data('id');o.remove(),Na(t)}),o.on('click','.acu-action-preset-export',function(){const t=$(this).data('id'),a=e.find(e=>e.id===t),n=Ct.exportPreset(t);if(!n)return void(window.toastr&&window.toastr.error('å¯¼å‡ºå¤±è´¥'));const o=new Blob([n],{type:'application/json'}),i=URL.createObjectURL(o),r=document.createElement('a');r.href=i,r.download=`${a?.name||'äº¤äº’è§„åˆ™'}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),window.toastr&&window.toastr.success('å·²å¯¼å‡ºæ–‡ä»¶')}),o.on('click','.acu-action-preset-copy',function(){const t=$(this).data('id'),a=e.find(e=>e.id===t);if(!a)return;const n={name:a.name+' (å‰¯æœ¬)',description:a.description||'',rules:JSON.parse(JSON.stringify(a.rules))},i=Ct.createPreset(n);i&&(window.toastr&&window.toastr.success(`å·²åˆ›å»ºå‰¯æœ¬ï¼š${i.name}ï¼ŒåŒ…å« ${i.rules.length} ä¸ªè§„åˆ™ç»„`),o.remove(),Pa())}),o.on('click','.acu-action-preset-delete',function(){const t=$(this).data('id'),a=e.find(e=>e.id===t);if(confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™ã€Œ${a?.name}ã€å—ï¼Ÿ`)){Ct.deletePreset(t)?(o.remove(),Pa()):window.toastr&&window.toastr.error('åˆ é™¤å¤±è´¥')}}),o.find('#acu-action-preset-new').on('click',()=>{o.remove(),Na()}),o.find('#acu-action-preset-import').on('click',()=>{const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=()=>{const e=t.files?.[0];if(!e)return;const a=new FileReader;a.onload=t=>{const e=t.target?.result;if(!e?.trim())return void(window.toastr&&window.toastr.error('æ–‡ä»¶å†…å®¹ä¸ºç©º'));const a=Ct.importPreset(e.trim());a?(window.toastr&&window.toastr.success(`å¯¼å…¥æˆåŠŸï¼š${a.name}`),o.remove(),Pa()):window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥JSONæ ¼å¼')},a.onerror=()=>{window.toastr&&window.toastr.error('æ–‡ä»¶è¯»å–å¤±è´¥')},a.readAsText(e)},t.click()}),c(o,'acu-edit-overlay',()=>{o.remove(),tn()})},Na=t=>{const{$}=$e();$('.acu-edit-overlay').remove();const e=ma(),a=!!t,n=a?Ct.getPresetById(t):null,o={name:n?.name||'æ–°äº¤äº’è§„åˆ™',description:n?.description||'',rules:n?.rules||[{table_keywords:['åœ°ç‚¹ï¼ˆè¾“å…¥è¡¨æ ¼åå…³é”®è¯ï¼Œè¡¨åä¸­åŒ…å«å…³é”®è¯çš„è¡¨æ ¼å°†åº”ç”¨æ­¤è§„åˆ™ï¼‰','åœºæ‰€'],actions:[{label:'å‰å¾€ï¼ˆæŒ‰é’®æ˜¾ç¤ºçš„æ–‡å­—ï¼‰',template:'<user>å¯¹{Name}æ‰§è¡Œäº’åŠ¨:å‰å¾€ã€‚ï¼ˆç‚¹å‡»æŒ‰é’®åå‘é€çš„å†…å®¹ï¼Œ{Name}ä¼šæ›¿æ¢ä¸ºè¡¨æ ¼ç¬¬ä¸€åˆ—çš„åˆ—åï¼Œä¸€èˆ¬ä¸ºåç§°ï¼‰'},{label:'è°ƒæŸ¥',template:'<user>ä»”ç»†è°ƒæŸ¥äº†{Name}çš„æƒ…å†µã€‚'}]},{table_keywords:['é­”æ³•','å¥¥æœ¯'],actions:[{label:'å­¦ä¹ ',template:'<user>å°è¯•å­¦ä¹ {Name}ã€‚'},{label:'é‡Šæ”¾',template:'<user>é‡Šæ”¾äº†{Name}ï¼'}]}]},i=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${e.theme}" style="width: 700px; max-width: 95vw; max-height: 85vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid var(--acu-border);">\n            <div style="font-size: 16px; font-weight: bold; color: var(--acu-text-main);">\n              <i class="fa-solid fa-wand-magic-sparkles"></i> ${a?'ç¼–è¾‘':'æ–°å»º'}äº¤äº’è§„åˆ™\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">é¢„è®¾åç§°</label>\n              <input id="action-preset-name" type="text" value="${r(o.name)}" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 4px;">æè¿°</label>\n              <input id="action-preset-desc" type="text" value="${r(o.description)}" placeholder="å¯é€‰" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: var(--acu-text-sub); margin-bottom: 8px;">\n                è§„åˆ™é…ç½® <span style="font-size: 10px; color: var(--acu-text-sub);">(JSONæ ¼å¼ï¼Œæ”¯æŒç›´æ¥ç¼–è¾‘)</span>\n              </label>\n              <textarea id="action-preset-json" class="acu-preset-editor-textarea" style="width: 100%; height: 300px; padding: 10px; border: 1px solid var(--acu-border) !important; border-radius: 6px; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; resize: vertical; box-sizing: border-box;"></textarea>\n            </div>\n\n            <div style="font-size: 11px; color: var(--acu-text-sub); padding: 8px; background: var(--acu-table-head); border-radius: 6px; line-height: 1.6;">\n              <strong>é…ç½®æ ¼å¼è¯´æ˜ï¼š</strong><br/>\n              â€¢ æ¯ä¸ªè§„åˆ™åŒ…å« table_keywordsï¼ˆè¡¨åå…³é”®è¯æ•°ç»„ï¼‰å’Œ actionsï¼ˆåŠ¨ä½œæ•°ç»„ï¼‰<br/>\n              â€¢ åŠ¨ä½œåŒ…å« labelï¼ˆæŒ‰é’®æ–‡å­—ï¼‰å’Œ templateï¼ˆå‘é€æ¨¡æ¿ï¼Œ{Name}ä¸ºè¡Œåç§°ï¼‰<br/>\n              â€¢ ç¤ºä¾‹: { "table_keywords": ["äººç‰©"], "actions": [{ "label": "äº¤è°ˆ", "template": "<user>ä¸{Name}äº¤è°ˆã€‚" }] }\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid var(--acu-border);">\n            <button id="action-preset-save" style="flex: 1; padding: 10px; background: var(--acu-accent); border: none; border-radius: 6px; color: var(--acu-btn-active-text); cursor: pointer; font-size: 13px; font-weight: bold;">\n              <i class="fa-solid fa-check"></i> ä¿å­˜\n            </button>\n            <button id="action-preset-cancel" style="padding: 10px 16px; background: var(--acu-btn-bg); border: 1px solid var(--acu-border); border-radius: 6px; color: var(--acu-text-main); cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-times"></i> å–æ¶ˆ\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(i);const s=i.find('#action-preset-json');s.val(JSON.stringify(o.rules,null,2)),i.find('.acu-close-btn, #action-preset-cancel').on('click',()=>{i.remove(),Pa()}),i.find('#action-preset-save').on('click',()=>{try{const e=i.find('#action-preset-name').val().trim(),n=i.find('#action-preset-desc').val().trim(),o=s.val().trim();if(!e)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥é¢„è®¾åç§°'));const r=JSON.parse(o);if(!Array.isArray(r)||0===r.length)return void(window.toastr&&window.toastr.error('è§„åˆ™ä¸èƒ½ä¸ºç©ºï¼Œéœ€è¦è‡³å°‘ä¸€ä¸ªè§„åˆ™'));for(let t=0;t<r.length;t++){const e=r[t];if(!e.table_keywords||!Array.isArray(e.table_keywords)||0===e.table_keywords.length)return void(window.toastr&&window.toastr.error(`è§„åˆ™ ${t+1} ç¼ºå°‘ table_keywords`));if(!e.actions||!Array.isArray(e.actions)||0===e.actions.length)return void(window.toastr&&window.toastr.error(`è§„åˆ™ ${t+1} ç¼ºå°‘ actions`))}a&&t?(Ct.updatePreset(t,{name:e,description:n,rules:r}),window.toastr&&window.toastr.success('è§„åˆ™å·²æ›´æ–°')):(Ct.createPreset({name:e,description:n,rules:r}),window.toastr&&window.toastr.success('è§„åˆ™å·²åˆ›å»º')),i.remove(),Pa()}catch(t){window.toastr&&window.toastr.error('JSON æ ¼å¼é”™è¯¯: '+t.message)}}),c(i,'acu-edit-overlay',()=>{i.remove(),Pa()})},Ra=()=>{const{$}=$e();$('.acu-edit-overlay').not(':has(.acu-debug-console-dialog)').remove();const t=`acu-theme-${ma().theme}`,e=Ae.get('acu_debug_filters',{log:!0,info:!0,warn:!0,error:!0});O.setFilters(e);const a=()=>{const t=O.getFilteredLogs(),e=n.find('.acu-debug-log-container');e.empty(),0!==t.length?t.forEach(t=>{const a={error:'var(--acu-error-text)',warn:'var(--acu-warning-text)',info:'var(--acu-hl-diff)',log:'var(--acu-text-sub)'},n={error:'fa-exclamation-circle',warn:'fa-exclamation-triangle',info:'fa-info-circle',log:'fa-circle'},o=a[t.type]||a.log,i=n[t.type]||n.log,c=$(`\n          <div class="acu-debug-log-item" data-type="${t.type}" style="padding:8px 12px;border-bottom:1px solid var(--acu-border);font-family:monospace;font-size:12px;line-height:1.5;">\n            <div style="display:flex;align-items:flex-start;gap:8px;">\n              <span style="color:${o};min-width:60px;font-size:11px;">\n                <i class="fa-solid ${i}"></i> [${t.timeStr}]\n              </span>\n              <span style="color:${o};min-width:50px;font-size:11px;text-transform:uppercase;">[${t.type}]</span>\n              <span style="flex:1;color:var(--acu-text-main);word-break:break-word;white-space:pre-wrap;">${r(t.content)}</span>\n            </div>\n            ${t.stack?`<div style="margin-top:4px;margin-left:128px;color:var(--acu-text-sub);font-size:11px;white-space:pre-wrap;font-family:monospace;">${r(t.stack)}</div>`:''}\n          </div>\n        `);e.append(c)}):e.html('<div style="text-align:center;padding:40px;color:var(--acu-text-sub);"><i class="fa-solid fa-inbox"></i><br/>æš‚æ— æ—¥å¿—</div>')},n=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-debug-console-dialog ${t}" style="max-width:90vw;max-height:90vh;width:800px;height:600px;display:flex;flex-direction:column;">\n          <div class="acu-settings-header" style="flex-shrink:0;">\n            <div class="acu-settings-title"><i class="fa-solid fa-bug"></i> Debugæ§åˆ¶å°</div>\n            <button class="acu-close-btn" id="debug-console-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">\n            \x3c!-- å·¥å…·æ  --\x3e\n            <div style="padding:12px;border-bottom:1px solid var(--acu-border);flex-shrink:0;display:flex;flex-direction:column;gap:8px;">\n              \x3c!-- ConsoleæŠ“å–å¼€å…³ --\x3e\n              <div style="display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid var(--acu-border);">\n                <span style="font-size:12px;color:var(--acu-text-sub);flex:1;">ConsoleæŠ“å–:</span>\n                <label class="acu-toggle">\n                  <input type="checkbox" id="debug-console-capture-toggle" ${O.enabled?'checked':''}>\n                  <span class="acu-toggle-slider"></span>\n                </label>\n                <span id="debug-console-capture-status" style="font-size:11px;color:var(--acu-text-sub);">${O.enabled?'å·²å¯ç”¨':'å·²å…³é—­'}</span>\n              </div>\n              \x3c!-- è¿‡æ»¤å’Œæ“ä½œæŒ‰é’® --\x3e\n              <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">\n                <div style="display:flex;gap:8px;align-items:center;flex:1;">\n                  <span style="font-size:12px;color:var(--acu-text-sub);">è¿‡æ»¤:</span>\n                  <button class="acu-btn ${e.log?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="log" style="padding:4px 10px;font-size:12px;${e.log?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Log</span>\n                  </button>\n                  <button class="acu-btn ${e.info?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="info" style="padding:4px 10px;font-size:12px;${e.info?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Info</span>\n                  </button>\n                  <button class="acu-btn ${e.warn?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="warn" style="padding:4px 10px;font-size:12px;${e.warn?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Warn</span>\n                  </button>\n                  <button class="acu-btn ${e.error?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="error" style="padding:4px 10px;font-size:12px;${e.error?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Error</span>\n                  </button>\n                </div>\n                <div style="display:flex;gap:6px;">\n                  <button class="acu-btn acu-btn-secondary" id="debug-console-clear" style="padding:6px 12px;font-size:12px;">\n                    <i class="fa-solid fa-trash"></i> æ¸…ç©º\n                  </button>\n                  <button class="acu-btn acu-btn-secondary" id="debug-console-copy" style="padding:6px 12px;font-size:12px;">\n                    <i class="fa-solid fa-copy"></i> å¤åˆ¶\n                  </button>\n                  <button class="acu-btn acu-btn-primary" id="debug-console-export" style="padding:6px 12px;font-size:12px;">\n                    <i class="fa-solid fa-download"></i> å¯¼å‡º\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ --\x3e\n            <div class="acu-debug-log-scroll" style="flex:1;overflow-y:auto;overflow-x:hidden;background:var(--acu-card-bg);">\n              <div class="acu-debug-log-container"></div>\n            </div>\n\n            \x3c!-- åº•éƒ¨çŠ¶æ€æ  --\x3e\n            <div style="padding:8px 12px;border-top:1px solid var(--acu-border);flex-shrink:0;font-size:11px;color:var(--acu-text-sub);display:flex;justify-content:space-between;">\n              <span>æ€»è®¡: <span id="debug-total-count">0</span> | æ˜¾ç¤º: <span id="debug-filtered-count">0</span></span>\n            </div>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(n);const o=()=>{const t=O.logs.length,e=O.getFilteredLogs().length;n.find('#debug-total-count').text(t),n.find('#debug-filtered-count').text(e)};a(),o(),n.find('#debug-console-capture-toggle').on('change',function(){const t=$(this).is(':checked'),e=n.find('#debug-console-capture-status');t?(O.enable(),e.text('å·²å¯ç”¨'),console.log('[DICE]Debugæ§åˆ¶å°æŠ“å–æ¨¡å¼å·²å¼€å¯')):(O.disable(),e.text('å·²å…³é—­'))}),n.find('[data-filter-type]').on('click',function(){const t=$(this).data('filter-type'),e=!$(this).hasClass('acu-btn-primary');e?($(this).removeClass('acu-btn-secondary').addClass('acu-btn-primary'),$(this).css('opacity','1')):($(this).removeClass('acu-btn-primary').addClass('acu-btn-secondary'),$(this).css('opacity','0.5')),O.setFilters({[t]:e}),Ae.set('acu_debug_filters',O.filters),a(),o()}),n.find('#debug-console-clear').on('click',()=>{O.clear(),a(),o()}),n.find('#debug-console-copy').on('click',async()=>{const t=O.getFilteredLogs();if(0===t.length)return void(window.toastr&&window.toastr.warning('æ²¡æœ‰å¯å¤åˆ¶çš„æ—¥å¿—'));const e=t.map(t=>{let e=`[${t.timeStr}] [${t.type.toUpperCase()}] ${t.content}`;return t.stack&&(e+='\n'+t.stack),e}).join('\n');try{if(window.TavernHelper&&window.TavernHelper.triggerSlash){const t=e.replace(/\"/g,'\\"').replace(/\}/g,'\\}');return void await window.TavernHelper.triggerSlash(`/clipboard-set "${t}"`)}if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(e);else{const t=document.createElement('textarea');t.value=e,t.style.position='fixed',t.style.left='-9999px',t.style.top='0',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999);const a=document.execCommand('copy');if(document.body.removeChild(t),!a)throw new Error('execCommand failed')}}catch(t){console.error('[DICE]DebugConsole å¤åˆ¶å¤±è´¥:',t),window.toastr&&window.toastr.error('å¤åˆ¶å¤±è´¥')}}),n.find('#debug-console-export').on('click',()=>{const t=O.getFilteredLogs();if(0===t.length)return void(window.toastr&&window.toastr.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—'));const e=t.map(t=>{let e=`[${t.timeStr}] [${t.type.toUpperCase()}] ${t.content}`;return t.stack&&(e+='\n'+t.stack),e}).join('\n\n'),a=new Blob([e],{type:'text/plain;charset=utf-8'}),n=URL.createObjectURL(a),o=document.createElement('a');o.href=n,o.download=`debug-console-${(new Date).toISOString().slice(0,19).replace(/:/g,'-')}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}),n.find('#debug-console-close, .acu-edit-overlay').on('click',function(t){(t.target===this||$(t.target).closest('.acu-close-btn').length)&&n.remove()});const i=setInterval(()=>{n.length&&n.is(':visible')&&(a(),o())},500);n.on('remove',()=>{clearInterval(i)})},Oa=t=>{const{$}=$e(),e=`acu-theme-${ma().theme}`,a=t?nt.getRule(t):null,n=ie||wa(),o=(Object.keys(n||{}).filter(t=>t.startsWith('sheet_')).map(t=>n[t]?.name||t).sort(),$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${e}">\n          <div class="acu-dice-cfg-header">\n            <span><i class="fa-solid fa-magic"></i> ${a?'ç¼–è¾‘':'æ·»åŠ '}æ­£åˆ™è½¬æ¢è§„åˆ™</span>\n            <button class="acu-config-close" id="acu-close-regex-rule"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-validation-modal-body">\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™åç§° *</span></div>\n              <input type="text" id="rule-name" class="acu-panel-input" value="${a?r(a.name):''}" placeholder="ä¾‹å¦‚: æ¸…ç†å¤šä½™ç©ºæ ¼" style="flex:1;" required>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™æè¿°</span></div>\n              <textarea id="rule-description" class="acu-panel-input" placeholder="è¾“å…¥è§„åˆ™ä»‹ç»" style="flex:1; resize: none; overflow-wrap: break-word; overflow-y: hidden; min-height: 34px; height: 34px; line-height: 1.4;">${a?r(a.description||''):''}</textarea>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">åŒ¹é…æ¨¡å¼ *</span></div>\n              <input type="text" id="rule-pattern" class="acu-panel-input" value="${a?r(a.pattern):''}" placeholder="ä¾‹å¦‚: \\s+ æˆ– /test/g" style="flex:1; font-family: monospace;" required>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">æ›¿æ¢å†…å®¹</span></div>\n              <input type="text" id="rule-replacement" class="acu-panel-input" value="${a?r(a.replacement||''):''}" placeholder="ç•™ç©ºè¡¨ç¤ºåˆ é™¤,æˆ–ä½¿ç”¨ $1, $2 ç­‰æ•è·ç»„" style="flex:1; font-family: monospace;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">ä½œç”¨èŒƒå›´ *</span></div>\n              <select id="rule-scope-type" class="acu-setting-select" style="width:120px;">\n                <option value="global" ${'global'===a?.scope?.type?'selected':''}>å…¨å±€</option>\n                <option value="table" ${'table'===a?.scope?.type?'selected':''}>è¡¨çº§</option>\n                <option value="column" ${'column'===a?.scope?.type?'selected':''}>åˆ—çº§</option>\n              </select>\n            </div>\n            <div class="acu-setting-row" id="field-table-names" style="display: ${'global'===a?.scope?.type?'none':'flex'};">\n              <div class="acu-setting-info"><span class="acu-setting-label">è¡¨æ ¼å (å¤šä¸ªç”¨é€—å·åˆ†éš”)</span></div>\n              <input type="text" id="rule-table-names" class="acu-panel-input" value="${a?.scope?.tableNames?.join(',')||''}" placeholder="ä¾‹å¦‚: ç‰©å“è¡¨,è£…å¤‡è¡¨" style="flex:1;">\n            </div>\n            <div class="acu-setting-row" id="field-column-names" style="display: ${'column'===a?.scope?.type?'flex':'none'};">\n              <div class="acu-setting-info"><span class="acu-setting-label">åˆ—å (å¤šä¸ªç”¨é€—å·åˆ†éš”)</span></div>\n              <input type="text" id="rule-column-names" class="acu-panel-input" value="${a?.scope?.columnNames?.join(',')||''}" placeholder="ä¾‹å¦‚: å“è´¨,æè¿°" style="flex:1;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">ä¼˜å…ˆçº§</span></div>\n              <input type="number" id="rule-priority" class="acu-panel-input" value="${a?.priority||50}" min="1" max="100" style="width:80px;">\n            </div>\n\n          </div>\n          <div class="acu-dice-cfg-actions">\n            <button id="acu-regex-rule-cancel">å–æ¶ˆ</button>\n            <button id="acu-regex-rule-confirm">ä¿å­˜</button>\n          </div>\n        </div>\n      </div>\n    `));o.find('#rule-scope-type').on('change',()=>{const t=o.find('#rule-scope-type').val();'global'===t?o.find('#field-table-names, #field-column-names').hide():'table'===t?(o.find('#field-table-names').css('display','flex').show(),o.find('#field-column-names').hide()):'column'===t&&o.find('#field-table-names, #field-column-names').css('display','flex').show()});const i=o.find('#rule-description');i.on('input',()=>{i.css('height','34px');const t=i[0].scrollHeight;i.css('height',Math.max(34,t)+'px')}),o.find('#acu-regex-rule-confirm').on('click',async function(){const e=o.find('#rule-name').val(),a=o.find('#rule-pattern').val(),n=o.find('#rule-scope-type').val();if(!e||!a)return void toastr.error('è¯·å¡«å†™è§„åˆ™åç§°å’ŒåŒ¹é…æ¨¡å¼');const i={type:n};if('global'!==n){const t=o.find('#rule-table-names').val();t&&(i.tableNames=String(t).split(',').map(t=>t.trim()).filter(t=>t))}if('column'===n){const t=o.find('#rule-column-names').val();t&&(i.columnNames=String(t).split(',').map(t=>t.trim()).filter(t=>t))}const r=String(a),{flags:c,patternWithoutFlags:s}=it._extractFlags(r),l=o.find('#flag-global'),u=o.find('#flag-ignorecase'),d=o.find('#flag-multiline'),p={global:l.length>0&&l.is(':checked'),caseInsensitive:u.length>0&&u.is(':checked'),multiline:d.length>0&&d.is(':checked')},g=s!==r?s:r,f=s!==r?{...p,...c}:p,b={name:String(e),description:o.find('#rule-description').val(),operation:'replace',pattern:g,flags:f,replacement:o.find('#rule-replacement').val(),scope:i,enabled:!0,priority:parseInt(o.find('#rule-priority').val(),10),executeMode:'auto'};if(t)nt.updateRule(t,b);else{const e=nt.addCustomRule(b);e&&(t=e.id)}o.remove(),$(document).off('keydown.regex-rule-modal'),Ea()});const s=()=>{o.remove(),$(document).off('keydown.regex-rule-modal')};o.find('#acu-regex-rule-cancel, #acu-close-regex-rule').on('click',function(t){t.stopPropagation(),s()}),c(o,'acu-edit-overlay',s),$(document).on('keydown.regex-rule-modal',function(t){'Escape'===t.key&&o.length&&o.is(':visible')&&(t.preventDefault(),s(),$(document).off('keydown.regex-rule-modal'))}),$('body').append(o),requestAnimationFrame(()=>{const t=o.find('#rule-description');t.length&&t[0].scrollHeight>34&&t.css('height',t[0].scrollHeight+'px')})};window.showAddRegexRuleModal=Oa,window.showDebugConsoleModal=Ra;const Ba=(()=>{try{return window.top??window}catch(t){return window}})(),La=[];let Ua=!1;const Va=t=>{try{t()}catch(t){console.error('[AcuDice] onReady å›è°ƒå‡ºé”™',t)}},qa=t=>{'AcuDice'in t||Object.defineProperty(t,'AcuDice',{value:Ga,writable:!1,configurable:!1})},Ya=t=>{try{t.dispatchEvent(new CustomEvent('acudice:ready'))}catch(t){console.warn('[AcuDice] ready äº‹ä»¶è§¦å‘å¤±è´¥',t)}},Ja=new Map,Wa=[],Xa=[],Ha=100;function Ka(t,e){const a=Ja.get(t);a&&a.forEach(t=>{try{t(e)}catch(t){console.error('[AcuDice] Event handler error:',t)}})}const Ga={version:'1.0.0',roll(t){if(!t||'string'!=typeof t)throw new Error('[AcuDice] roll() éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„éª°å­è¡¨è¾¾å¼å­—ç¬¦ä¸²');const e=Tt(t,{});return{total:e,formula:t,breakdown:`${t} = ${e}`}},async check(t={}){const e=xt(),a=t.diceType||e.lastDiceType||'1d100',n='gte'===(t.successCriteria||('1d20'===a?'gte':'lte')),o=t.modifier||0;let i=t.targetValue;if(void 0===i&&(t.attribute||t.skill)){const e=t.attribute||t.skill||'',a=ie||wa();if(a)for(const t in a){const n=a[t];if('ä¸»è§’ä¿¡æ¯'===n?.name&&n.content?.[1]){const t=n.content[0]||[],a=n.content[1];for(let n=0;n<t.length;n++){const o=t[n];if(o&&(o.includes('å±æ€§')||o.includes('æŠ€èƒ½'))){const t=Jt(a[n]||'').find(t=>t.name===e);if(t){i=t.value;break}}}if(void 0!==i)break}}if(void 0===i)throw new Error(`[AcuDice] æœªæ‰¾åˆ°å±æ€§æˆ–æŠ€èƒ½: ${e}`)}if(void 0===i)throw new Error('[AcuDice] check() éœ€è¦ targetValue æˆ–æœ‰æ•ˆçš„ attribute/skill åç§°');const r=jt(a);if(isNaN(r))throw new Error(`[AcuDice] æ— æ•ˆçš„éª°å­è¡¨è¾¾å¼: ${a}`);const c=r+o,s=i;let l=!1,u=!1,d=!1,p='';if(n)l=c>=s,u=r===e.dndCritSuccess,d=r===e.dndCritFail,u?(l=!0,p=`å¤§æˆåŠŸï¼æ·å‡º ${r}${o?` + ${o}`:''} = ${c}ï¼ŒDC ${s}`):d?(l=!1,p=`å¤§å¤±è´¥ï¼æ·å‡º ${r}${o?` + ${o}`:''} = ${c}ï¼ŒDC ${s}`):p=l?`æˆåŠŸï¼æ·å‡º ${c} >= DC ${s}`:`å¤±è´¥ï¼æ·å‡º ${c} < DC ${s}`;else if(l=c<=s,u=c<=e.critSuccessMax,d=c>=e.critFailMin,u)l=!0,p=`å¤§æˆåŠŸï¼æ·å‡º ${c}ï¼Œç›®æ ‡ ${s}`;else if(d)l=!1,p=`å¤§å¤±è´¥ï¼æ·å‡º ${c}ï¼Œç›®æ ‡ ${s}`;else if(l){const t=c<=Math.floor(s/e.hardSuccessDiv);p=c<=Math.floor(s/e.difficultSuccessDiv)?`æéš¾æˆåŠŸï¼æ·å‡º ${c} <= ${Math.floor(s/e.difficultSuccessDiv)}`:t?`å›°éš¾æˆåŠŸï¼æ·å‡º ${c} <= ${Math.floor(s/e.hardSuccessDiv)}`:`æˆåŠŸï¼æ·å‡º ${c} <= ${s}`}else p=`å¤±è´¥ï¼æ·å‡º ${c} > ${s}`;return{success:l,roll:c,target:s,margin:n?c-s:s-c,criticalSuccess:u,criticalFailure:d,message:p,diceType:a,rule:n?'dnd':'coc'}},onReady(t){'function'==typeof t?Ua?Va(t):La.push(t):console.warn('[AcuDice] onReady() éœ€è¦ä¸€ä¸ªå‡½æ•°')},on(t,e){Ja.has(t)||Ja.set(t,new Set),Ja.get(t).add(e)},off(t,e){const a=Ja.get(t);a&&a.delete(e)},getLatestCheck:()=>Wa.length>0?Wa[Wa.length-1]:null,getLatestContest:()=>Xa.length>0?Xa[Xa.length-1]:null,getHistory(t){const e=t?.limit,a=t?.type;let n=[];return a&&'check'!==a||(n=n.concat(Wa.map(t=>({...t,_type:'check'})))),a&&'contest'!==a||(n=n.concat(Xa.map(t=>({...t,_type:'contest'})))),n.sort((t,e)=>e.timestamp-t.timestamp),e&&e>0&&(n=n.slice(0,e)),n},listCharacters(){const t=ie||wa();if(!t)return[];const e=Ca(t||{}),a=[],n=Rt.findTable(e,'player');n?.data?.rows?.length>0&&a.push('<user>');const o=Rt.findTable(e,'npc');if(o){Rt.parseRows(o,'npc').forEach(t=>{t.name&&'string'==typeof t.name&&a.push(t.name)})}return a},getCharacterAttributes(t){if(!t||'string'!=typeof t)throw new Error('[AcuDice] getCharacterAttributes() éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„è§’è‰²å');return ta(t)},getAttributeValue(t,e){if(!t||'string'!=typeof t)throw new Error('[AcuDice] getAttributeValue() éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„è§’è‰²å');if(!e||'string'!=typeof e)throw new Error('[AcuDice] getAttributeValue() éœ€è¦ä¸€ä¸ªæœ‰æ•ˆçš„å±æ€§å');return Je(t,e)},async checkByCharacter(t){if(!t||!t.name||!t.attribute)throw new Error('[AcuDice] checkByCharacter() éœ€è¦ name å’Œ attribute å‚æ•°');const e=Je(t.name,t.attribute);if(null===e)throw new Error(`[AcuDice] æœªæ‰¾åˆ°è§’è‰² "${t.name}" çš„å±æ€§ "${t.attribute}"`);return this.check({attribute:t.attribute,targetValue:e,modifier:t.modifier,diceType:t.diceType,successCriteria:t.successCriteria})},async contest(t){if(!t?.left?.name||!t?.left?.attribute)throw new Error('[AcuDice] contest() éœ€è¦ left.name å’Œ left.attribute å‚æ•°');if(!t?.right?.name||!t?.right?.attribute)throw new Error('[AcuDice] contest() éœ€è¦ right.name å’Œ right.attribute å‚æ•°');const e=Je(t.left.name,t.left.attribute);if(null===e)throw new Error(`[AcuDice] æœªæ‰¾åˆ°è§’è‰² "${t.left.name}" çš„å±æ€§ "${t.left.attribute}"`);const a=Je(t.right.name,t.right.attribute);if(null===a)throw new Error(`[AcuDice] æœªæ‰¾åˆ°è§’è‰² "${t.right.name}" çš„å±æ€§ "${t.right.attribute}"`);const n=xt(),o=n.lastDiceType||'1d100',i=jt(o),r=jt(o),c=o.match(/\d+d(\d+)/i),s=c?parseInt(c[1],10):100,l=getSuccessLevel(i,e,s),u=getSuccessLevel(r,a,s);let d,p;if(l.level>u.level)d='left',p=`${t.left.name} èƒœåˆ©ï¼(${l.name} èƒœè¿‡ ${u.name})`;else if(l.level<u.level)d='right',p=`${t.right.name} èƒœåˆ©ï¼(${u.name} èƒœè¿‡ ${l.name})`;else{const e=t.rule||n.contestTieRule||'initiator_lose';p=`åŒæ–¹å¹³æ‰‹ï¼(å‡ä¸º ${l.name})`,'initiator_win'===e?(d='left',p+=` - ${t.left.name} åˆ¤èƒœ`):'tie'===e?d='tie':(d='right',p+=` - ${t.left.name} åˆ¤è´Ÿ`)}const g={left:{name:t.left.name,attribute:t.left.attribute,roll:i,target:e,successLevel:l.level},right:{name:t.right.name,attribute:t.right.attribute,roll:r,target:a,successLevel:u.level},winner:d,message:p};return Ka('contest',g),Xa.push({...g,timestamp:Date.now()}),Xa.length>Ha&&Xa.shift(),g}};if(qa(window),Ba!==window)try{qa(Ba)}catch(t){console.warn('[AcuDice] æ— æ³•å†™å…¥é¡¶å±‚çª—å£ï¼Œå¯èƒ½è·¨åŸŸ',t)}(()=>{if(!Ua){Ua=!0;for(const t of La)Va(t);La.length=0}})(),Ya(window),Ba!==window&&Ya(Ba),console.info('[AcuDice] API v1.0.0 å·²åŠ è½½');const Qa=(t,e)=>{const{$}=$e();$('.acu-fav-edit-overlay').remove();const a=`\n      <div class="acu-fav-edit-overlay acu-theme-${ma().theme}">\n        <div class="acu-fav-edit-modal">\n          <div class="acu-fav-edit-modal-header">\n            <h4>ç¼–è¾‘æ”¶è—</h4>\n            <button class="acu-fav-edit-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-fav-edit-modal-body">\n            <div class="acu-fav-edit-tags-section">\n              <label>æ ‡ç­¾ (é€—å·åˆ†éš”):</label>\n              <input type="text" id="acu-fav-edit-tags" value="${r(t.tags.join(', '))}" />\n            </div>\n            <div class="acu-fav-edit-rows">\n              ${n=t.header,o=t.rowData,n.map((t,e)=>`\n        <div class="acu-fav-edit-row" data-index="${e}">\n          <input type="text" class="acu-fav-edit-header" value="${r(t)}" placeholder="åˆ—å" />\n          <input type="text" class="acu-fav-edit-value" value="${r(String(o[e]||''))}" placeholder="å€¼" />\n          <button class="acu-fav-edit-remove" title="åˆ é™¤åˆ—"><i class="fa-solid fa-minus"></i></button>\n        </div>\n      `).join('')}\n            </div>\n            <button class="acu-fav-edit-add-col"><i class="fa-solid fa-plus"></i> æ·»åŠ åˆ—</button>\n          </div>\n          <div class="acu-fav-edit-modal-footer">\n            <button class="acu-fav-edit-cancel">å–æ¶ˆ</button>\n            <button class="acu-fav-edit-save">ä¿å­˜</button>\n          </div>\n        </div>\n      </div>\n    `;var n,o;$('body').append(a);const i=$('.acu-fav-edit-overlay'),c=i.find('.acu-fav-edit-modal'),s=()=>i.remove();i.on('click',t=>{$(t.target).hasClass('acu-fav-edit-overlay')&&s()}),c.find('.acu-fav-edit-close, .acu-fav-edit-cancel').on('click',s),c.on('click','.acu-fav-edit-remove',function(){$(this).closest('.acu-fav-edit-row').remove()}),c.find('.acu-fav-edit-add-col').on('click',()=>{const t=`\n        <div class="acu-fav-edit-row" data-index="${c.find('.acu-fav-edit-row').length}">\n          <input type="text" class="acu-fav-edit-header" value="" placeholder="åˆ—å" />\n          <input type="text" class="acu-fav-edit-value" value="" placeholder="å€¼" />\n          <button class="acu-fav-edit-remove" title="åˆ é™¤åˆ—"><i class="fa-solid fa-minus"></i></button>\n        </div>\n      `;c.find('.acu-fav-edit-rows').append(t)}),c.find('.acu-fav-edit-save').on('click',()=>{const t=[],a=[];c.find('.acu-fav-edit-row').each(function(){const e=$(this).find('.acu-fav-edit-header').val(),n=$(this).find('.acu-fav-edit-value').val();e.trim()&&(t.push(e.trim()),a.push(n))});const n=(c.find('#acu-fav-edit-tags').val()||'').split(',').map(t=>t.trim()).filter(t=>t.length>0);e({header:t,rowData:a,tags:n}),s()})},Za=(t,e,a,n)=>{const{$}=$e();$('.acu-fav-send-overlay').remove();const o=ma(),i=e.map(e=>{const a='strict'===e.mode?'<span style="color:#27ae60;">âœ“ å®Œå…¨åŒ¹é…</span>':`<span style="color:#f39c12;">âš  éƒ¨åˆ†åŒ¹é… (${e.matchedCols.length}/${t.header.length}åˆ—)</span>`,n=e.unmatchedCols.length>0?`<div class="acu-fav-send-unmatched">æœªåŒ¹é…: ${e.unmatchedCols.join(', ')}</div>`:'';return`\n        <div class="acu-fav-send-option" data-uid="${r(e.tableUid)}" data-mode="${e.mode}">\n          <div class="acu-fav-send-option-name">${r(e.tableName)}</div>\n          <div class="acu-fav-send-option-mode">${a}</div>\n          ${n}\n        </div>\n      `}).join(''),c=`\n      <div class="acu-fav-send-overlay acu-theme-${o.theme}">\n        <div class="acu-fav-send-modal">\n          <div class="acu-fav-send-modal-header">\n            <h4>é€‰æ‹©ç›®æ ‡è¡¨æ ¼</h4>\n            <button class="acu-fav-send-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-fav-send-modal-body">\n            ${i}\n          </div>\n          <div class="acu-fav-send-modal-footer">\n            <button class="acu-fav-send-cancel">å–æ¶ˆ</button>\n          </div>\n        </div>\n      </div>\n    `;$('body').append(c);const s=$('.acu-fav-send-overlay'),l=s.find('.acu-fav-send-modal'),u=()=>s.remove();s.on('click',t=>{$(t.target).hasClass('acu-fav-send-overlay')&&u()}),l.find('.acu-fav-send-close, .acu-fav-send-cancel').on('click',u),l.on('click','.acu-fav-send-option',async function(){const e=$(this).data('uid'),o=$(this).data('mode'),i=a[e];if(!i||!i.content)return void toastr.error('æ— æ³•è·å–ç›®æ ‡è¡¨æ ¼');const r=i.content[0].slice(1).map(t=>String(t||'')),c=lt.mapRowToTable(t,r);i.content.push(c),ie&&ie[e]&&(ie[e].content=i.content);try{const t=$e().getDB();if(!t||!t.importTableAsJson)return void toastr.error('æ•°æ®åº“ API ä¸å¯ç”¨ï¼Œæ— æ³•å‘é€åˆ°è¡¨æ ¼');const e=JSON.stringify(ie);if(!1===await t.importTableAsJson(e))return void toastr.error('æ•°æ®å¯¼å…¥å¤±è´¥');console.log('[DICE]FavoritesManager å‘é€æˆåŠŸï¼Œå·²å†™å…¥æ•°æ®åº“')}catch(t){return console.error('[DICE]FavoritesManager å†™å…¥æ•°æ®åº“å¤±è´¥:',t),void toastr.error('å†™å…¥æ•°æ®åº“å¤±è´¥: '+(t.message||t))}if('loose'===o){const e=t.header.filter(t=>!r.includes(t)).length;e>0&&toastr.info(`${e}åˆ—æœªåŒ¹é…ï¼Œå·²å¡«å……ç©ºå€¼`)}u(),n()})},tn=()=>{const{$}=$e();$('.acu-edit-overlay').not(':has(.acu-settings-dialog)').remove(),ee=!0;const t=ma(),e=`acu-theme-${t.theme}`,a=Ae.get('acu_settings_expanded',['appearance']),n=t=>a.includes(t),o=[{key:'__dice__',name:'æŠ•éª°',icon:'fa-dice-d20'},{key:'__changes__',name:'å˜æ›´å®¡æ ¸',icon:'fa-code-compare'},{key:'__mvu__',name:'MVUå˜é‡',icon:'fa-code-branch'},{key:'__favorites__',name:'æ”¶è—å¤¹',icon:'fa-star'}],i=(()=>{const t=ie||wa(),e=Ca(t||{}),a=Me()||[],n=Ue();let i=[];if(o.forEach(t=>{i.push({key:t.key,name:t.name,icon:t.icon,isSpecial:!0})}),Object.keys(e).forEach(t=>{i.push({key:t,name:t,icon:Ce(t),isSpecial:!1})}),a.length>0){const t=new Map(a.map((t,e)=>[t,e]));i.sort((e,a)=>(t.has(e.key)?t.get(e.key):9999)-(t.has(a.key)?t.get(a.key):9999))}return i.map(t=>{const e=n.includes(t.key),a=t.isSpecial?' acu-special-item':'',o=t.name;return'<div class="acu-table-manager-item'+a+(e?' hidden-table':'')+'" data-table-name="'+r(t.key)+'" draggable="false"><div class="acu-table-item-check" title="ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º/éšè—"><i class="fa-solid '+(e?'fa-eye-slash':'fa-eye')+'"></i></div><div class="acu-table-item-icon"><i class="fa-solid '+t.icon+'"></i></div><div class="acu-table-item-name">'+r(o)+'</div><div class="acu-table-item-handle" title="æ‹–æ‹½æ’åº"><i class="fa-solid fa-grip-vertical"></i></div></div>'}).join('')})(),l=t=>n(t)?'fa-chevron-down':'fa-chevron-right',u=$(`\n        <div class="acu-edit-overlay">\n            <div class="acu-edit-dialog acu-settings-dialog ${e}">\n                <div class="acu-settings-header">\n                    <div class="acu-settings-title">\n                        <span class="acu-settings-text">\n                            <i class="fa-solid fa-cog"></i> è®¾ç½®\n                            <span class="acu-version-badge">v3.64</span><button class="acu-manual-update-btn" id="acu-manual-update-btn" title="æ¸…ç†ç¼“å­˜å¹¶åˆ·æ–°ä»¥è·å–æœ€æ–°ç‰ˆæœ¬"><i class="fa-solid fa-rotate"></i></button>\n                        </span>\n                    </div>\n                    <div class="acu-header-actions">\n                        <button class="acu-help-btn" id="acu-help-btn" title="æŸ¥çœ‹ä½¿ç”¨æ–‡æ¡£"><i class="fa-solid fa-question-circle"></i></button>\n                        <button class="acu-close-btn" id="dlg-close-x"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                </div>\n\n                <div class="acu-settings-body">\n                \x3c!-- å¤–è§‚æ ·å¼ --\x3e\n                <div class="acu-settings-group ${n('appearance')?'':'collapsed'}" data-group="appearance">                    <div class="acu-settings-group-title">\n                        <i class="fa-solid ${l('appearance')} acu-group-chevron"></i>\n                        <i class="fa-solid fa-palette"></i> å¤–è§‚æ ·å¼\n                    </div>\n                    <div class="acu-settings-group-body">\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">èƒŒæ™¯ä¸»é¢˜</span>\n                            </div>\n                            <select id="cfg-theme" class="acu-setting-select">\n                                ${we.map(e=>`<option value="${e.id}" ${e.id===t.theme?'selected':''}>${e.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">å­—ä½“é£æ ¼</span>\n                            </div>\n                            <select id="cfg-font-family" class="acu-setting-select">\n                                ${ye.map(e=>`<option value="${e.id}" ${e.id===t.fontFamily?'selected':''}>${e.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">å­—ä½“å¤§å° (ç•Œé¢)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-main" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${t.fontSize}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">å­—ä½“å¤§å° (é€‰é¡¹)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-opt" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${t.optionFontSize||12}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row acu-setting-row-toggle">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">é«˜äº®å˜åŒ–å†…å®¹</span>\n                            </div>\n                            <label class="acu-toggle">\n                                <input type="checkbox" id="cfg-new" ${t.highlightNew?'checked':''}>\n                                <span class="acu-toggle-slider"></span>\n                            </label>\n                        </div>\n                    </div>\n                </div>\n\n                    \x3c!-- å¸ƒå±€è®¾ç½® --\x3e\n                    <div class="acu-settings-group ${n('layout')?'':'collapsed'}" data-group="layout">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${l('layout')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-th-large"></i> å¸ƒå±€è®¾ç½®\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">å¡ç‰‡å®½åº¦</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-width" data-min="200" data-max="500" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${t.cardWidth}px</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">å¸ƒå±€æ¨¡å¼</span>\n                                </div>\n                                <select id="cfg-layout" class="acu-setting-select">\n                                    <option value="horizontal" ${'vertical'!==t.layout?'selected':''}>æ¨ªå‘æ»šåŠ¨</option>\n                                    <option value="vertical" ${'vertical'===t.layout?'selected':''}>ç«–å‘æ»šåŠ¨</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">åº•éƒ¨æŒ‰é’®åˆ—æ•°</span>\n                                    <span class="acu-setting-hint">ä»…ç§»åŠ¨ç«¯</span>\n                                </div>\n                                <select id="cfg-grid-cols" class="acu-setting-select acu-select-short">\n                                    <option value="2" ${2==t.gridColumns?'selected':''}>2åˆ—</option>\n                                    <option value="3" ${3==t.gridColumns?'selected':''}>3åˆ—</option>\n                                    <option value="4" ${4==t.gridColumns?'selected':''}>4åˆ—</option>\n                                    <option value="auto" ${'auto'===t.gridColumns?'selected':''}>è‡ªåŠ¨</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ¯é¡µæ˜¾ç¤ºæ¡æ•°</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-per-page" data-min="10" data-max="200" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${t.itemsPerPage}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n\n                    \x3c!-- ä½ç½®ä¸äº¤äº’ --\x3e\n                    <div class="acu-settings-group ${n('position')?'':'collapsed'}" data-group="position">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${l('position')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-arrows-alt"></i> ä½ç½®ä¸äº¤äº’\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">é¢æ¿ä½ç½®</span>\n                                </div>\n                                <select id="cfg-position" class="acu-setting-select">\n                                    <option value="fixed" ${'embedded'!==t.positionMode?'selected':''}>æ‚¬æµ®åº•éƒ¨</option>\n                                    <option value="embedded" ${'embedded'===t.positionMode?'selected':''}>è·Ÿéšæ¶ˆæ¯</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">åŠŸèƒ½æŒ‰é’®ä½ç½®</span>\n                                </div>\n                                <select id="cfg-action-pos" class="acu-setting-select acu-select-short">\n                                    <option value="bottom" ${'top'!==t.actionsPosition?'selected':''}>åº•éƒ¨</option>\n                                    <option value="top" ${'top'===t.actionsPosition?'selected':''}>é¡¶éƒ¨</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ”¶èµ·æ ·å¼</span>\n                                </div>\n                                <select id="cfg-col-style" class="acu-setting-select acu-select-short">\n                                    <option value="bar" ${'bar'===t.collapseStyle?'selected':''}>é•¿æ¡</option>\n                                    <option value="pill" ${'pill'===t.collapseStyle?'selected':''}>èƒ¶å›Š</option>\n                                    <option value="mini" ${'mini'===t.collapseStyle?'selected':''}>åœ†é’®</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row" id="cfg-col-align-row" style="${'bar'===t.collapseStyle?'display:none;':''}">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ”¶èµ·ä½ç½®</span>\n                                </div>\n                                <select id="cfg-col-align" class="acu-setting-select acu-select-short">\n                                    <option value="right" ${'right'===t.collapseAlign?'selected':''}>é å³</option>\n                                    <option value="left" ${'left'===t.collapseAlign?'selected':''}>é å·¦</option>\n                                    <option value="center" ${'center'===t.collapseAlign?'selected':''}>å±…ä¸­</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- è¡ŒåŠ¨é€‰é¡¹ --\x3e\n                    <div class="acu-settings-group ${n('options')?'':'collapsed'}" data-group="options">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${l('options')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-gamepad"></i> è¡ŒåŠ¨é€‰é¡¹\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row acu-setting-row-toggle">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ˜¾ç¤ºè¡ŒåŠ¨é€‰é¡¹é¢æ¿</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-show-opt" ${!1!==t.showOptionPanel?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                            <div class="acu-setting-row acu-setting-row-toggle" id="row-auto-send" style="${!1!==t.showOptionPanel?'':'display:none;'}">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">ç‚¹å‡»é€‰é¡¹ç›´æ¥å‘é€</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-auto-send" ${!1!==t.clickOptionToAutoSend?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                    </div>\n\n                \x3c!-- è¡¨æ ¼ç®¡ç† --\x3e\n                    <div class="acu-settings-group ${n('tables')?'':'collapsed'}" data-group="tables">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${l('tables')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-table"></i> è¡¨æ ¼ç®¡ç†\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-table-manager-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤ºï¼Œé•¿æŒ‰æ‹–æ‹½æ’åº\n                            </div>\n                            <div class="acu-table-manager-list" id="table-manager-list">\n                                ${i}\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- æ•°æ®éªŒè¯è§„åˆ™ --\x3e\n                    <div class="acu-settings-group ${n('validation')?'':'collapsed'}" data-group="validation">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${l('validation')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-clipboard-check"></i> æ•°æ®éªŒè¯è§„åˆ™\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- é¢„è®¾é€‰æ‹©å™¨ --\x3e\n                            <div class="acu-setting-row" style="margin-bottom:8px;">\n                                <span>å½“å‰é¢„è®¾</span>\n                                <select class="acu-setting-select" id="preset-select" style="flex:1;max-width:160px;">\n                                    ${et.getAllPresets().map(t=>`<option value="${r(t.id)}" ${t.id===et.getActivePreset()?.id?'selected':''}>${r(t.name)}${t.builtin?' (å†…ç½®)':''}</option>`).join('')}\n                                </select>\n                            </div>\n                            \x3c!-- é¢„è®¾æ“ä½œæŒ‰é’® --\x3e\n                            <div style="display:flex;gap:6px;margin-bottom:10px;">\n                                <button class="acu-action-btn" id="btn-preset-dup" title="å¤åˆ¶é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-copy"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-new" title="æ–°å»ºé¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-plus"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-del" title="åˆ é™¤é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-trash"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-export" title="å¯¼å‡º" style="flex:1;height:28px;"><i class="fa-solid fa-file-export"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-import" title="å¯¼å…¥" style="flex:1;height:28px;"><i class="fa-solid fa-file-import"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-reset" title="æ¢å¤é»˜è®¤é¢„è®¾è§„åˆ™" style="flex:1;height:28px;"><i class="fa-solid fa-rotate-left"></i></button>\n                            </div>\n                            <div class="acu-validation-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> éªŒè¯è§„åˆ™ç”¨äºæ£€æµ‹æ•°æ®åˆæ³•æ€§ï¼Œ<i class="fa-solid fa-shield-halved"></i> è¡¨ç¤ºå¯ç”¨æ‹¦æˆª\n                            </div>\n                            <div class="acu-validation-rules-list" id="validation-rules-list">\n                                ${at.getAllRules().map(t=>{const e=W[t.ruleType]||{name:t.ruleType,icon:'fa-question'},a='table'===e.scope,n=t.intercept;return`\n                                    <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${r(t.id)}">\n                                        <div class="acu-rule-type-icon" title="${r(e.name)}${a?' (è¡¨çº§)':''}">\n                                            <i class="fa-solid ${e.icon}"></i>\n                                        </div>\n                                        <div class="acu-rule-info">\n                                            <div class="acu-rule-name">${r(t.name)}</div>\n                                            <div class="acu-rule-target">${r(t.targetTable)}${t.targetColumn?'.'+r(t.targetColumn):a?' (æ•´è¡¨)':''}</div>\n                                        </div>\n                                        <div class="acu-rule-intercept ${n?'active':''}" data-rule-id="${r(t.id)}" title="${n?'ç‚¹å‡»å…³é—­æ‹¦æˆª':'ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰'}"><i class="fa-solid fa-shield-halved"></i></div>\n                                        <button class="acu-rule-edit" data-rule-id="${r(t.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n                                        <div class="acu-rule-toggle ${t.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n                                            <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n                                        </div>\n                                        <button class="acu-rule-delete" data-rule-id="${r(t.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n                                    </div>\n                                `}).join('')}\n                            </div>\n                            <button class="acu-add-rule-btn" id="btn-add-validation-rule">\n                                <i class="fa-solid fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰éªŒè¯è§„åˆ™\n                            </button>\n                        </div>\n                    </div>\n\n                    \x3c!-- æ­£åˆ™è½¬æ¢è§„åˆ™ - Phase 4.1 --\x3e\n                    <div class="acu-settings-group ${n('regex')?'':'collapsed'}" data-group="regex">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${l('regex')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-wand-magic-sparkles"></i> æ­£åˆ™è½¬æ¢è§„åˆ™\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- é¢„è®¾é€‰æ‹©å™¨ --\x3e\n                            <div class="acu-setting-row" style="margin-bottom:8px;">\n                                <span>å½“å‰é¢„è®¾</span>\n                                <select class="acu-setting-select" id="regex-preset-select" style="flex:1;max-width:160px;">\n                                    ${ot.getAllPresets().map(t=>`<option value="${r(t.id)}" ${t.id===ot.getActivePreset()?.id?'selected':''}>${r(t.name)}</option>`).join('')}\n                                </select>\n                            </div>\n                            \x3c!-- é¢„è®¾æ“ä½œæŒ‰é’® --\x3e\n                            <div style="display:flex;gap:6px;margin-bottom:10px;">\n                                <button class="acu-action-btn" id="btn-regex-preset-dup" title="å¤åˆ¶é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-copy"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-new" title="æ–°å»ºé¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-plus"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-del" title="åˆ é™¤é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-trash"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-export" title="å¯¼å‡º" style="flex:1;height:28px;"><i class="fa-solid fa-file-export"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-import" title="å¯¼å…¥" style="flex:1;height:28px;"><i class="fa-solid fa-file-import"></i></button>\n                            </div>\n                            <div class="acu-validation-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> æ­£åˆ™è½¬æ¢è§„åˆ™ç”¨äºè‡ªåŠ¨ä¿®æ”¹æ•°æ®åº“è¡¨æ ¼å†…å®¹\n                            </div>\n                            \x3c!-- è§„åˆ™åˆ—è¡¨ --\x3e\n                            <div class="acu-validation-rules-list" id="regex-rules-list">\n                                ${nt.getAllRules().map(t=>{const e='global'===t.scope.type?'fa-globe':'table'===t.scope.type?'fa-table':'fa-columns',a='global'===t.scope.type?'å…¨å±€':'table'===t.scope.type?t.scope.tableNames?.join(','):`${t.scope.tableNames?.join(',')}.${t.scope.columnNames?.join(',')}`;return`\n                                    <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${r(t.id)}">\n                                        <div class="acu-rule-type-icon" title="ä½œç”¨åŸŸ: ${r(t.scope.type)}">\n                                            <i class="fa-solid ${e}"></i>\n                                        </div>\n                                        <div class="acu-rule-info">\n                                            <div class="acu-rule-name">${r(t.name)}</div>\n                                            <div class="acu-rule-target" style="font-size:10px;">${r(a)} | ${r(t.operation)}</div>\n                                        </div>\n                                        <button class="acu-rule-edit" data-rule-id="${r(t.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n                                        <div class="acu-rule-toggle ${t.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n                                            <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n                                        </div>\n                                        <button class="acu-rule-delete" data-rule-id="${r(t.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n                                    </div>\n                                `}).join('')}\n                            </div>\n                            <div style="display:flex;gap:8px;margin-top:8px;">\n                                <button class="acu-add-rule-btn" id="btn-add-regex-rule" style="flex:1;">\n                                    <i class="fa-solid fa-plus"></i> æ·»åŠ è½¬æ¢è§„åˆ™\n                                </button>\n                                <button class="acu-add-rule-btn" id="btn-import-tavern-regex" style="flex:1;">\n                                    <i class="fa-solid fa-file-import"></i> å¯¼å…¥é…’é¦†æ­£åˆ™\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- é«˜çº§è®¾ç½® --\x3e\n                    <div class="acu-settings-group ${n('advanced')?'':'collapsed'}" data-group="advanced">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${l('advanced')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-sliders-h"></i> é«˜çº§è®¾ç½®\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- ç–¯ç‹‚æ¨¡å¼è®¾ç½® --\x3e\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-fire"></i> ç–¯ç‹‚æ¨¡å¼</span>\n                                </div>\n                                <select id="cfg-crazy-mode" class="acu-setting-select" style="width: 90px; min-width: 90px; text-align: center; text-align-last: center;">\n                                    <option value="0">â—‹ å…³é—­</option>\n                                    <option value="25">â—” ä½</option>\n                                    <option value="50">â—‘ ä¸­</option>\n                                    <option value="75">â—• é«˜</option>\n                                    <option value="100">â— æé™</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-dice-d20"></i> è‡ªå®šä¹‰å±æ€§è§„åˆ™</span>\n                                </div>\n                                <button id="cfg-attr-preset-manage" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> ç®¡ç†\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-wand-magic-sparkles"></i> è‡ªå®šä¹‰äº¤äº’è§„åˆ™</span>\n                                </div>\n                                <button id="cfg-action-preset-manage" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> ç®¡ç†\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-filter"></i> å˜é‡è¿‡æ»¤é»‘åå•</span>\n                                </div>\n                                <button id="cfg-blacklist-manage" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> ç®¡ç†\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-bug"></i> Debugæ§åˆ¶å°</span>\n                                </div>\n                                <button id="btn-open-debug-console" class="acu-setting-action-btn" style="width: 90px; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-terminal"></i> æ‰“å¼€\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                </div>\x3c!-- å…³é—­ .acu-settings-body --\x3e\n            </div>\n        </div>\n    `);$('body').append(u),u.find('.acu-settings-group-title').on('click',function(){const t=$(this).closest('.acu-settings-group'),e=t.find('.acu-settings-group-body');if(e.hasClass('acu-animating'))return;const a=t.data('group'),n=$(this).find('.acu-group-chevron');let o=Ae.get('acu_settings_expanded',['appearance']);if(t.hasClass('collapsed')){t.removeClass('collapsed'),n.removeClass('fa-chevron-right').addClass('fa-chevron-down'),o.includes(a)||o.push(a),e.addClass('acu-animating').show();const i=e.prop('scrollHeight');e.css('height',0).animate({height:i},180,function(){$(this).css('height','').removeClass('acu-animating')})}else{t.addClass('collapsed'),n.removeClass('fa-chevron-down').addClass('fa-chevron-right'),o=o.filter(t=>t!==a);const i=e.outerHeight();e.addClass('acu-animating').css('height',i).animate({height:0},180,function(){$(this).hide().css('height','').removeClass('acu-animating')})}Ae.set('acu_settings_expanded',o)}),u.find('#cfg-theme').on('change',function(){const t=$(this).val();va({theme:t}),u.find('.acu-edit-dialog').removeClass(we.map(t=>`acu-theme-${t.id}`).join(' ')).addClass(`acu-theme-${t}`)}),u.find('#cfg-font-family').on('change',function(){va({fontFamily:$(this).val()})}),u.find('#cfg-attr-preset-manage').on('click',function(t){t.preventDefault(),t.stopPropagation(),u.remove(),ee=!1,ja()}),u.find('#cfg-action-preset-manage').on('click',function(t){t.stopPropagation(),u.remove(),ee=!1,Pa()});(()=>{const t=Et(),e=t.enabled?t.crazyLevel:0;u.find('#cfg-crazy-mode').val(e),u.find('#cfg-crazy-mode').on('change',function(){const t=parseInt($(this).val(),10);At(0===t?{enabled:!1,crazyLevel:50}:{enabled:!0,crazyLevel:t})})})(),u.find('#cfg-blacklist-manage').on('click',function(t){t.preventDefault(),t.stopPropagation(),za()}),u.find('#cfg-layout').on('change',function(){va({layout:$(this).val()}),nn()}),u.find('#cfg-grid-cols').on('change',function(){va({gridColumns:$(this).val()})}),u.find('#cfg-position').on('change',function(){va({positionMode:$(this).val()}),nn()}),u.find('#cfg-action-pos').on('change',function(){va({actionsPosition:$(this).val()}),nn()}),u.find('#cfg-col-style').on('change',function(){const t=$(this).val();va({collapseStyle:t});const e=u.find('#cfg-col-align-row');'bar'===t?e.hide():e.show(),nn()}),u.find('#cfg-col-align').on('change',function(){va({collapseAlign:$(this).val()}),nn()}),u.find('#cfg-show-opt').on('change',function(){const t=$(this).is(':checked');va({showOptionPanel:t}),t?u.find('#row-auto-send').slideDown(200):u.find('#row-auto-send').slideUp(200),nn()}),u.find('#cfg-auto-send').on('change',function(){va({clickOptionToAutoSend:$(this).is(':checked')})}),u.find('#cfg-new').on('change',function(){va({highlightNew:$(this).is(':checked')}),nn()}),u.find('.acu-table-item-check').on('click',function(t){t.stopPropagation();const e=$(this).closest('.acu-table-manager-item'),a=e.data('table-name');let n=Ue();const o=$(this).find('i');var i;n.includes(a)?(n=n.filter(t=>t!==a),e.removeClass('hidden-table'),o.removeClass('fa-eye-slash').addClass('fa-eye')):(n.push(a),e.addClass('hidden-table'),o.removeClass('fa-eye').addClass('fa-eye-slash')),i=n,Ae.set(w,i),nn()});const d=u.find('#table-manager-list');let p={isDragging:!1,element:null,timer:null,startY:0};const g=()=>{p.timer&&(clearTimeout(p.timer),p.timer=null),p.element&&$(p.element).removeClass('acu-dragging'),d.find('.acu-drag-above, .acu-drag-below').removeClass('acu-drag-above acu-drag-below'),p.isDragging=!1,p.element=null},f=t=>{p.isDragging=!0,p.element=t[0],t.addClass('acu-dragging')};d[0].addEventListener('pointerdown',function(t){const e=t.target.closest('.acu-table-item-handle');if(!e)return;t.preventDefault();const a=$(e).closest('.acu-table-manager-item');p.startY=t.clientY,f(a),e.setPointerCapture(t.pointerId)},{passive:!1}),d[0].addEventListener('pointerdown',function(t){const e=t.target.closest('.acu-table-manager-item');if(!e)return;if(t.target.closest('.acu-table-item-check, .acu-table-item-handle'))return;p.startY=t.clientY;const a=$(e);p.timer=setTimeout(()=>{f(a)},350)}),d[0].addEventListener('pointermove',function(t){if(p.timer&&Math.abs(t.clientY-p.startY)>8&&(clearTimeout(p.timer),p.timer=null),!p.isDragging||!p.element)return;t.preventDefault();const e=d.find('.acu-table-manager-item').not('.acu-dragging');let a=null,n=!0;e.each(function(){const e=this.getBoundingClientRect(),o=e.top+e.height/2;t.clientY<o&&!a?(a=this,n=!0):t.clientY>=e.top&&t.clientY<=e.bottom&&(a=this,n=t.clientY<o)}),d.find('.acu-drag-above, .acu-drag-below').removeClass('acu-drag-above acu-drag-below'),a&&a!==p.element&&$(a).addClass(n?'acu-drag-above':'acu-drag-below')},{passive:!1}),d[0].addEventListener('pointerup',()=>{if(!p.isDragging||!p.element)return void g();const t=$(p.element),e=d.find('.acu-drag-above, .acu-drag-below').first();if(e.length&&e[0]!==p.element){e.hasClass('acu-drag-above')?t.insertBefore(e):t.insertAfter(e);const a=[];d.find('.acu-table-manager-item').each(function(){a.push($(this).data('table-name'))}),ze(a)}g()}),d[0].addEventListener('pointercancel',g),d[0].addEventListener('touchmove',function(t){p.isDragging&&t.preventDefault()},{passive:!1}),u.find('.acu-stepper').each(function(){const t=$(this),e=t.data('id'),a=parseInt(t.data('min')),n=parseInt(t.data('max')),o=parseInt(t.data('step')),i=t.find('.acu-stepper-value'),r=t=>{t=Math.max(a,Math.min(n,t));const o='cfg-per-page'===e?'':'px';i.text(t+o),'cfg-width'===e?($('.acu-wrapper').css('--acu-card-width',t+'px'),va({cardWidth:t})):'cfg-font-main'===e?($('.acu-wrapper').css('--acu-font-size',t+'px'),va({fontSize:t})):'cfg-font-opt'===e?($('.acu-wrapper, .acu-embedded-options-container').css('--acu-opt-font-size',t+'px'),va({optionFontSize:t})):'cfg-per-page'===e&&va({itemsPerPage:t})},c=()=>{const t=i.text().replace(/[^\d]/g,'');return parseInt(t)||a};t.find('.acu-stepper-dec').on('click',function(){r(c()-o)}),t.find('.acu-stepper-inc').on('click',function(){r(c()+o)})}),u.on('click','.acu-rule-toggle',function(t){t.stopPropagation();const e=$(this),a=e.closest('.acu-validation-rule-item'),n=a.data('rule-id'),o=e.find('i'),i=e.hasClass('active');at.toggleRuleEnabled(n,!i),i?(e.removeClass('active'),o.removeClass('fa-toggle-on').addClass('fa-toggle-off'),a.addClass('disabled')):(e.addClass('active'),o.removeClass('fa-toggle-off').addClass('fa-toggle-on'),a.removeClass('disabled'))}),u.on('click','#validation-rules-list .acu-rule-edit',function(t){t.stopPropagation();const e=$(this).data('rule-id');at.getRule(e)&&Aa(u,e)}),u.on('click','#validation-rules-list .acu-rule-delete',function(t){t.stopPropagation();const e=$(this).data('rule-id'),a=$(this).closest('.acu-validation-rule-item');confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è‡ªå®šä¹‰è§„åˆ™å—ï¼Ÿ')&&at.removeCustomRule(e)&&a.fadeOut(200,function(){$(this).remove()})}),u.on('click','.acu-rule-intercept',function(t){t.stopPropagation();const e=$(this),a=e.data('rule-id'),n=e.hasClass('active');at.toggleRuleIntercept(a,!n)&&(n?e.removeClass('active').attr('title','ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰'):e.addClass('active').attr('title','ç‚¹å‡»å…³é—­æ‹¦æˆª'))});const b=()=>{at.clearCache();const t=at.getAllRules();let e='';t.forEach(t=>{const a=W[t.ruleType]||{name:t.ruleType,icon:'fa-question'},n='table'===a.scope,o=t.intercept;e+=`\n          <div class="acu-validation-rule-item ${t.enabled?'':'disabled'}" data-rule-id="${r(t.id)}">\n            <div class="acu-rule-type-icon" title="${r(a.name)}${n?' (è¡¨çº§)':''}">\n              <i class="fa-solid ${a.icon}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${r(t.name)}</div>\n              <div class="acu-rule-target">${r(t.targetTable)}${t.targetColumn?'.'+r(t.targetColumn):n?' (æ•´è¡¨)':''}</div>\n            </div>\n            <div class="acu-rule-intercept ${o?'active':''}" data-rule-id="${r(t.id)}" title="${o?'ç‚¹å‡»å…³é—­æ‹¦æˆª':'ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰'}"><i class="fa-solid fa-shield-halved"></i></div>\n            <button class="acu-rule-edit" data-rule-id="${r(t.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n            <div class="acu-rule-toggle ${t.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n              <i class="fa-solid ${t.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${r(t.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n          </div>`}),u.find('#validation-rules-list').html(e)};u.find('#preset-select').on('change',function(){et.setActivePreset($(this).val())&&b()}),u.find('#btn-preset-dup').on('click',function(){const t=et.getActivePreset();if(!t)return;const e=et.duplicatePreset(t.id);e&&(u.find('#preset-select').append(`<option value="${r(e.id)}">${r(e.name)}</option>`),u.find('#preset-select').val(e.id).trigger('change'))}),u.find('#btn-preset-new').on('click',function(){const t=prompt('è¯·è¾“å…¥æ–°é¢„è®¾åç§°:','æˆ‘çš„é¢„è®¾');if(!t?.trim())return;const e=et.createPreset(t.trim());e&&(u.find('#preset-select').append(`<option value="${r(e.id)}">${r(e.name)}</option>`),u.find('#preset-select').val(e.id).trigger('change'))}),u.find('#btn-preset-del').on('click',function(){const t=et.getActivePreset();t&&('default'!==t.id?confirm(`ç¡®å®šåˆ é™¤é¢„è®¾"${t.name}"å—ï¼Ÿ`)&&et.deletePreset(t.id)&&(u.find(`#preset-select option[value="${t.id}"]`).remove(),u.find('#preset-select').val('default').trigger('change')):window.toastr&&window.toastr.warning('é»˜è®¤é¢„è®¾ä¸èƒ½åˆ é™¤'))}),u.find('#btn-preset-export').on('click',function(){const t=et.getActivePreset();if(!t)return;const e=et.exportPreset(t.id);if(e)try{const a=`acu_validation_preset_${t.name||t.id}_${Date.now()}.json`,n=new Blob([e],{type:'application/json'}),o=URL.createObjectURL(n),i=document.createElement('a');i.href=o,i.download=a,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(o)}catch(t){navigator.clipboard.writeText(e).then(()=>{}).catch(()=>{prompt('å¤åˆ¶ä»¥ä¸‹å†…å®¹:',e)})}}),u.find('#btn-preset-import').on('click',function(){const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=async t=>{const e=t.target.files?.[0];if(e)try{const t=await e.text();if(!t?.trim())return;let a;try{a=JSON.parse(t.trim())}catch{return void(window.toastr&&window.toastr.error('JSONæ ¼å¼æ— æ•ˆ'))}const n=a?.preset?.name||'å¯¼å…¥çš„é¢„è®¾',o=et.getAllPresets(),i=o.map(t=>t.name),c=i.includes(n),l=(e,i)=>{let s=t.trim();if(i&&a?.preset&&(a.preset.name=i,a.preset.id=`preset_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=JSON.stringify(a)),e&&c){const t=o.find(t=>t.name===n);t&&'default'!==t.id&&(et.deletePreset(t.id),u.find(`#preset-select option[value="${t.id}"]`).remove())}const l=et.importPreset(s,!1);if(l&&l.preset){const t=l.preset;u.find('#preset-select').append(`<option value="${r(t.id)}">${r(t.name)}</option>`),u.find('#preset-select').val(t.id).trigger('change'),l.needsMerge&&confirm('æ£€æµ‹åˆ°é¢„è®¾ç‰ˆæœ¬è¾ƒæ—§ï¼Œæ˜¯å¦è¦åˆå¹¶æ–°ç‰ˆæœ¬çš„é»˜è®¤å€¼ï¼Ÿ\n\nè¿™å°†ä¿ç•™æ‚¨çš„è‡ªå®šä¹‰è§„åˆ™ï¼Œå¹¶æ·»åŠ æ–°ç‰ˆæœ¬ä¸­çš„æ–°è§„åˆ™ã€‚')&&(et.mergePresetWithDefaults(t.id)?b():window.toastr&&window.toastr.error('åˆå¹¶å¤±è´¥'))}else window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼')};c?s({presetName:n,presetType:'æ•°æ®éªŒè¯',existingNames:i,onOverwrite:()=>l(!0),onRename:t=>l(!1,t),onCancel:()=>{}}):l(!1)}catch(t){console.error('[DICE]PresetManager å¯¼å…¥å¤±è´¥:',t),window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥: '+t.message)}},t.click()}),u.find('#btn-preset-reset').on('click',function(){confirm('ç¡®å®šè¦å°†é»˜è®¤é¢„è®¾æ¢å¤ä¸ºåˆå§‹çŠ¶æ€å—ï¼Ÿ\nè¿™å°†åˆ é™¤æ‰€æœ‰å¯¹é»˜è®¤é¢„è®¾çš„ä¿®æ”¹ã€‚')&&(et.resetDefaultPreset()?'default'===et.getActivePreset()?.id&&b():window.toastr&&window.toastr.error('æ¢å¤å¤±è´¥'))}),u.on('click','#regex-rules-list .acu-rule-toggle',function(){const t=$(this).closest('.acu-validation-rule-item').data('rule-id'),e=nt.getAllRules().find(e=>e.id===t)?.enabled,a=!e;nt.getRule(t);nt.toggleRuleEnabled(t,a),a||toastr.info('è§„åˆ™å·²ç¦ç”¨'),Ea()}),u.on('click','#regex-rules-list .acu-rule-edit',function(){const t=$(this).closest('.acu-validation-rule-item').data('rule-id');nt.getRule(t)&&Oa(t)}),u.on('click','#regex-rules-list .acu-rule-delete',function(){const t=$(this).closest('.acu-validation-rule-item').data('rule-id'),e=nt.getRule(t);e&&confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™"${e.name}"å—ï¼Ÿ`)&&(nt.removeRule(t),Ea())}),u.find('#regex-preset-select').on('change',function(){const t=$(this).val();ot.setActivePreset(String(t)),Ea()}),u.find('#btn-regex-preset-dup').on('click',function(){const t=ot.getActivePreset();if(!t)return;const e=prompt('è¯·è¾“å…¥æ–°é¢„è®¾åç§°:',`${t.name} (å‰¯æœ¬)`);if(!e)return;const a=ot.createPreset(e,t.id);if(a){const t=u.find('#regex-preset-select');t.append(`<option value="${r(a.id)}">${r(a.name)}</option>`),t.val(a.id),Ea()}else toastr.error('é¢„è®¾åç§°å·²å­˜åœ¨')}),u.find('#btn-regex-preset-new').on('click',function(){const t=prompt('è¯·è¾“å…¥é¢„è®¾åç§°:');if(!t)return;const e=ot.createPreset(t,null);if(e){ot.setActivePreset(e.id);const t=u.find('#regex-preset-select');t.append(`<option value="${r(e.id)}">${r(e.name)}</option>`),t.val(e.id),Ea()}else toastr.error('é¢„è®¾åç§°å·²å­˜åœ¨')}),u.find('#btn-regex-preset-del').on('click',function(){const t=ot.getActivePreset();if(t&&confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾"${t.name}"å—ï¼Ÿ`)){if(ot.deletePreset(t.id)){const e=u.find('#regex-preset-select');e.find(`option[value="${t.id}"]`).remove();const a=ot.getActivePreset()?.id;a&&e.val(a),Ea()}else toastr.error('ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªé¢„è®¾')}}),u.find('#btn-regex-preset-export').on('click',function(){const t=ot.getActivePreset();if(!t)return;const e=ot.exportPreset(t.id);if(e){const a=new Blob([e],{type:'application/json'}),n=URL.createObjectURL(a),o=document.createElement('a');o.href=n,o.download=`regex-preset-${t.name}-${Date.now()}.json`,o.click(),URL.revokeObjectURL(n)}}),u.find('#btn-regex-preset-import').on('click',function(){const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=async t=>{const e=t.target.files?.[0];if(e)try{const t=await e.text();if(!t?.trim())return;let a;try{a=JSON.parse(t.trim())}catch{return void toastr.error('JSONæ ¼å¼æ— æ•ˆ')}const n=a?.name||'å¯¼å…¥çš„é¢„è®¾',o=ot.getAllPresets(),i=o.map(t=>t.name),c=i.includes(n),l=(e,i)=>{let s=t.trim();if(i&&(a.name=i,a.id=`regex_preset_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s=JSON.stringify(a)),e&&c){const t=o.find(t=>t.name===n);t&&o.length>1&&(ot.deletePreset(t.id),u.find(`#regex-preset-select option[value="${t.id}"]`).remove())}const l=ot.importPreset(s);if(l){const t=u.find('#regex-preset-select');t.append(`<option value="${r(l.id)}">${r(l.name)}</option>`),t.val(l.id),ot.setActivePreset(l.id),Ae.set(L,l.rules||[]),nt.clearCache(),Ea()}else toastr.error('é¢„è®¾æ ¼å¼æ— æ•ˆ')};c?s({presetName:n,presetType:'æ­£åˆ™è½¬æ¢',existingNames:i,onOverwrite:()=>l(!0),onRename:t=>l(!1,t),onCancel:()=>{}}):l(!1)}catch(t){toastr.error('å¯¼å…¥å¤±è´¥: '+t.message)}},t.click()}),u.find('#btn-add-regex-rule').on('click',function(){Oa()}),u.find('#btn-import-tavern-regex').on('click',function(){const t=document.createElement('input');t.type='file',t.accept='.json,application/json',t.onchange=async t=>{const e=t.target.files?.[0];if(e)try{const t=await e.text();if(!t?.trim())return;let a;try{a=JSON.parse(t.trim())}catch{return void toastr.error('JSONæ ¼å¼æ— æ•ˆ')}const n=Array.isArray(a)?a:[a];if(!n.every(t=>t.scriptName&&t.findRegex))return void toastr.error('ä¸æ˜¯æœ‰æ•ˆçš„é…’é¦†æ­£åˆ™æ ¼å¼ï¼ˆéœ€è¦ scriptName å’Œ findRegex å­—æ®µï¼‰');const o=nt.getAllRules().map(t=>t.name);let i=0,r=0;const c=t=>{if(t>=n.length)return Ea(),void(r>0?toastr.info(`å¯¼å…¥å®Œæˆ: ${i} æ¡æˆåŠŸ, ${r} æ¡è·³è¿‡`):i>0&&toastr.success(`æˆåŠŸå¯¼å…¥ ${i} æ¡é…’é¦†æ­£åˆ™è§„åˆ™`));const e=function(t){const{pattern:e,flags:a}=function(t){const e=t.match(/^\/(.+)\/([gimsuy]*)$/s);if(e){const[,t,a]=e;return{pattern:t,flags:{global:a.includes('g'),caseInsensitive:a.includes('i'),multiline:a.includes('m'),unicode:a.includes('u'),sticky:a.includes('y')}}}return{pattern:t,flags:{global:!0}}}(t.findRegex),n=[];t.placement?.length&&n.push(`placement: [${t.placement.join(',')}]`),t.markdownOnly&&n.push('markdownOnly'),t.promptOnly&&n.push('promptOnly'),null!=t.minDepth&&n.push(`minDepth: ${t.minDepth}`),null!=t.maxDepth&&n.push(`maxDepth: ${t.maxDepth}`);const o=n.length>0?`[ä»é…’é¦†æ­£åˆ™å¯¼å…¥] ${n.join(', ')}`:'[ä»é…’é¦†æ­£åˆ™å¯¼å…¥]';return{id:`tavern_import_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t.scriptName,description:o,operation:'replace',pattern:e,flags:a,replacement:t.replaceString||'',scope:{type:'global'},enabled:!t.disabled,priority:50,executeMode:t.runOnEdit?'auto':'manual',security:{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4},createdAt:Date.now(),updatedAt:Date.now()}}(n[t]);o.includes(e.name)?s({presetName:e.name,presetType:'é…’é¦†æ­£åˆ™è§„åˆ™',existingNames:o,onOverwrite:()=>{const a=nt.getAllRules().find(t=>t.name===e.name);a&&nt.removeRule(a.id),nt.addCustomRule(e),o.push(e.name),i++,c(t+1)},onRename:a=>{e.name=a,e.id=`tavern_import_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,nt.addCustomRule(e),o.push(a),i++,c(t+1)},onCancel:()=>{r++,c(t+1)}}):(nt.addCustomRule(e),o.push(e.name),i++,c(t+1))};c(0)}catch(t){toastr.error('å¯¼å…¥å¤±è´¥: '+t.message)}},t.click()}),u.find('#btn-add-validation-rule').on('click',function(){Aa(u)}),u.find('#btn-open-debug-console').on('click',function(t){t.preventDefault(),t.stopPropagation(),u.remove(),ee=!1,Ra()});const m=()=>{ee=!1,u.remove(),nn()};u.on('click','#dlg-close-x, .acu-settings-header .acu-close-btn',m),u.on('click','#acu-help-btn',function(t){t.stopPropagation(),window.open('https://jerryzmtz.github.io/DiceSystemManual//','_blank')}),u.on('click','#acu-manual-update-btn',function(t){t.stopPropagation(),showManualUpdateConfirmDialog()}),c(u,'acu-edit-overlay',m)};let en=null,an=!1;const nn=()=>{ee?an||(console.info('[DICE]è®¾ç½®é¢æ¿æ‰“å¼€ä¸­ï¼Œè·³è¿‡ç•Œé¢æ¸²æŸ“'),an=!0):(en&&clearTimeout(en),en=setTimeout(()=>{en=null,an=!1,on()},50))},on=()=>{console.info('[DICE]å¼€å§‹æ¸²æŸ“ç•Œé¢...');const{$}=$e();if(!ne&&$('#chat').length){const t=$('#chat');let e=!1;ne=new MutationObserver(()=>{e||(e=!0,requestAnimationFrame(()=>{if('embedded'===ma().positionMode)return void(e=!1);const a=t.children().last()[0],n=$('.acu-wrapper')[0];n&&a&&a!==n&&($(a).hasClass('mes')||$(a).hasClass('message-body'))&&t.append(n);const o=xt();if(o&&o.hideDiceResultInChat){const e=t.children().last();(e.hasClass('mes')||e.hasClass('message-body'))&&e.addClass('acu-dice-result-revealing'),requestAnimationFrame(()=>{wt(),requestAnimationFrame(()=>{e.removeClass('acu-dice-result-revealing').addClass('acu-dice-result-revealed'),setTimeout(()=>{e.removeClass('acu-dice-result-revealed')},200)})})}e=!1}))}),ne.observe(t[0],{childList:!0})}let t,e=!1;if(re&&ie)t=ie;else{if(t=wa(),e=!0,t){let e=!1;for(const a in t){if(!a.startsWith('sheet_'))continue;const o=t[a];if(!o||!o.name||!o.content)continue;const i=n.applyLocks(o.name,o.content);i.modified&&(e=!0),i.restored.length}}if(t&&!le&&e)try{const e=nt.getEnabledRules();if(e.length>0){console.info(`[DICE]æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œåº”ç”¨ ${e.length} æ¡è§„åˆ™...`),le=!0;const a=it.applyToTable(t,e);a.totalApplied>0&&(console.info(`[DICE]è‡ªåŠ¨æ›¿æ¢å®Œæˆï¼Œå…±å½±å“ ${a.totalApplied} å¤„æ•°æ®`),$a(t).catch(t=>{console.warn('[DICE]è‡ªåŠ¨è½¬æ¢åä¿å­˜æ•°æ®å¤±è´¥:',t)})),a.errors.length>0?console.warn(`[DICE]è‡ªåŠ¨è½¬æ¢é‡åˆ° ${a.errors.length} ä¸ªé”™è¯¯:`,a.errors):0===a.totalApplied&&console.info('[DICE]è‡ªåŠ¨è½¬æ¢æ‰§è¡Œå®Œæˆï¼Œä½†æ²¡æœ‰åŒ¹é…åˆ°éœ€è¦è½¬æ¢çš„æ•°æ®'),le=!1}else le=!1}catch(t){le=!1;t instanceof Error?t.message:String(t);console.error('[DICE]è‡ªåŠ¨è½¬æ¢å¤±è´¥:',t)}if(t){ie='function'==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t));const e=Ne(),a=he(),n=e&&Object.keys(e).some(t=>t.startsWith('sheet_'));e&&n?e._contextId?e._contextId!==a&&(ie._contextId=a,Re(ie)):Re({...e,_contextId:a}):Re({...ie,_contextId:a})}}const a=$('.acu-search-input');if($('.acu-wrapper').length&&a.is(':focus')&&t){Qt||(ae=ha(t));const e=Ca(t),a=De(),n=a&&e[a]?a:null;if(n&&e[n]){const t=xn(e[n],n),a=$('<div>').html(t);return $('.acu-card-grid').replaceWith(a.find('.acu-card-grid')),$('.acu-panel-title').html(a.find('.acu-panel-title').html()),$n(e),void cn()}}let o=0,i=0;const c=$('.acu-panel-content');c.length&&(o=c.scrollLeft(),i=c.scrollTop()),$('.acu-wrapper').remove();const s=Ca(t||{});ae=Qt?new Set:ha(t);const l=Me();let u=Object.keys(s);l&&(u=l.filter(t=>s[t]).concat(u.filter(t=>!l.includes(t))));const d=Ue();u=u.filter(t=>!d.includes(t));const p=De();let g=p&&s[p]&&!d.includes(p)?p:null;const f=ma(),b=je(),m='vertical'===f.layout?'acu-layout-vertical':'',v=`acu-mode-${f.positionMode||'fixed'}`;let x=f.gridColumns;if('auto'===x){const t=u.length;if(t<=4)x=t<2?2:t;else{const e=3*Math.ceil(t/3)-t;x=4*Math.ceil(t/4)-t<=e?4:3}}let y='',w=null;if(!1!==f.showOptionPanel){const t=[];if(Object.keys(s).forEach(e=>{e.includes('é€‰é¡¹')&&t.push(s[e])}),t.length>0){const e=Pe(),a=e?'fa-chevron-right':'fa-chevron-down',n=e?'collapsed':'';let o=0,i=!1,c=[];t.forEach(t=>{t.rows&&t.rows.forEach(t=>{t.forEach((t,e)=>{e>0&&t&&String(t).trim()&&o++})})});let s=`\n                    <div class="acu-opt-header" data-action="toggle-options">\n                        <span>\n                            <i class="fa-solid ${a}" style="margin-right:6px;font-size:10px;"></i>\n                            è¡ŒåŠ¨é€‰é¡¹ (${o})\n                        </span>\n                    </div>`;t.forEach(t=>{t.rows&&t.rows.forEach(t=>{t.forEach((t,e)=>{if(e>0&&t&&String(t).trim()){const e=String(t).trim();s+=`<button class="acu-opt-btn" data-val="${encodeURIComponent(e)}">${r(e)}</button>`,c.push(e),i=!0}})})}),i&&(y=`<div class="acu-option-panel acu-theme-${f.theme} ${n}">${s}</div>`,w=c.join('|||')+(e?'_collapsed':'_expanded')+`_theme_${f.theme}`+`_optSize_${f.optionFontSize||12}`)}}const k=w!==pe;k&&null!==w&&(ge=!0),pe=w;let C=`<div class="acu-wrapper ${v} acu-theme-${f.theme} ${m}" style="--acu-card-width:${f.cardWidth}px; --acu-font-size:${f.fontSize}px; --acu-opt-font-size:${f.optionFontSize||12}px; --acu-grid-cols:${x}">`;if('embedded'===f.positionMode&&y&&ge&&(C+=y),b){const t=`acu-col-${f.collapseStyle||'bar'}`,e=`acu-align-${f.collapseAlign||'right'}`;C+=`\n                <div class="acu-expand-trigger ${t} ${e}" id="acu-btn-expand">\n                    <i class="fa-solid fa-table"></i> <span>æ•°æ®åº“åŠ©æ‰‹ (${Object.keys(s).length})</span>\n                </div>\n            `}else{const e=g?Oe()[g]:null,a=Ae.get(h,!1),n=Ae.get('acu_changes_panel_active',!1),o=De()===vt.MODULE_ID,i=(o?Oe()[vt.MODULE_ID]:null)||e;C+=`\n                <div class="acu-data-display ${a||n||o||g?'visible':''} ${i?'acu-manual-mode':''}" id="acu-data-area" style="${i?'height:'+i+'px;':''}">\n                    ${n?ln(t):a?mn(s):o?'<div class="acu-mvu-panel">'+vt.renderPanel()+'</div>':g?xn(s[g],g):''}\n                </div>\n                `;const c=`grid-template-columns: repeat(${x}, 1fr);`;C+=`\n                <div class="acu-nav-container ${'top'===f.actionsPosition?'acu-pos-top':''}" id="acu-nav-bar" style="${c}">\n                    <div class="acu-order-controls" id="acu-order-hint"><i class="fa-solid fa-arrows-alt"></i> æ‹–åŠ¨è°ƒæ•´é¡ºåºï¼Œå®Œæˆåç‚¹å‡»ä¿å­˜é€€å‡º</div>\n            `;const l=Ae.get('acu_changes_panel_active',!1),d=Ae.get('acu_favorites_panel_active',!1),p=Ae.get(J,!1);let b=0,m=0;if(t){const e=Ne();if(e){for(const a in t){if(!a.startsWith('sheet_'))continue;const n=t[a],o=e[a];if(!n?.content)continue;const i=n.content.slice(1),r=o?.content?.slice(1)||[],c=new Map;r.forEach((t,e)=>{const a=String(t[1]??'').trim();c.has(a)||c.set(a,[]),c.get(a).push({index:e,row:t})}),i.forEach((t,e)=>{const a=String(t[1]??'').trim();let n;if(a&&c.has(a)){const t=c.get(a);if(t.length>0){const e=t.shift();n=e.row}}else a||(n=r[e]);if(n){let e=!1;t.forEach((t,a)=>{0!==a&&String(t??'')!==String(n[a]??'')&&(e=!0)}),e&&b++}else b++});const s=new Map,l=new Map;i.forEach(t=>{const e=String(t[1]??'').trim();e&&s.set(e,(s.get(e)||0)+1)}),r.forEach(t=>{const e=String(t[1]??'').trim();e&&l.set(e,(l.get(e)||0)+1)}),l.forEach((t,e)=>{const a=s.get(e)||0;t>a&&(b+=t-a)});const u=r.filter(t=>!String(t[1]??'').trim()).length,d=i.filter(t=>!String(t[1]??'').trim()).length;u>d&&(b+=u-d)}for(const a in e)a.startsWith('sheet_')&&!t[a]&&b++}m=rt.getErrorCount(t)}const v=p?m:b,y=p&&m>0,w=Ue(),k=Me()||[],E=[{key:'__dice__',icon:'fa-dice-d20',label:'æ·éª°',id:'acu-btn-dice-nav',extraClass:'acu-dice-nav-btn'},{key:'__changes__',icon:'fa-code-compare',label:'å®¡æ ¸'+(v>0?'('+v+')':''),id:'acu-btn-changes',extraClass:'acu-changes-btn'+(y?' has-validation-errors':''),isActive:l,warningIcon:y},{key:'__mvu__',icon:'fa-code-branch',label:'å˜é‡',id:'acu-btn-mvu',extraClass:'acu-mvu-btn',isActive:De()===vt.MODULE_ID},{key:'__favorites__',icon:'fa-star',label:'æ”¶è—å¤¹',id:'acu-btn-favorites',extraClass:'acu-favorites-btn',isActive:d}];let A=[];if(E.forEach(t=>{w.includes(t.key)||'__mvu__'!==t.key&&t.checkAvailable&&!t.checkAvailable()||A.push({...t,isSpecial:!0})}),u.forEach(t=>{A.push({key:t,icon:Ce(t),label:t,isSpecial:!1,isActive:!a&&!l&&g===t})}),k.length>0){const t=new Map(k.map((t,e)=>[t,e]));A.sort((e,a)=>(t.has(e.key)?t.get(e.key):9999)-(t.has(a.key)?t.get(a.key):9999))}C+=`<button class="acu-nav-btn acu-dashboard-btn ${a?'active':''}" id="acu-btn-dashboard" style="order: 1;">\n                <i class="fa-solid fa-chart-line"></i><span>ä»ªè¡¨ç›˜</span>\n            </button>`,A.forEach((t,e)=>{const a=t.isActive?'active':'',n=t.extraClass||'',o=e+2;if(t.isSpecial){const e=t.warningIcon?'<i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>':'';C+=`<button class="acu-nav-btn ${n} ${a}" id="${t.id}" style="order: ${o};">\n                        <i class="fa-solid ${t.icon}"></i><span>${r(t.label)}</span>${e}\n                    </button>`}else C+=`<button class="acu-nav-btn ${a}" data-table="${r(t.key)}" style="order: ${o};">\n                        <i class="fa-solid ${t.icon}"></i><span>${r(t.label)}</span>\n                    </button>`}),C+='<div class="acu-actions-group" id="acu-active-actions" style="order: 9999;">',Kt.forEach(t=>{C+=`<button class="acu-action-btn" id="${t.id}" title="${t.title}"><i class="fa-solid ${t.icon}"></i></button>`}),C+='</div>',C+='</div>'}C+='</div>';const E=$('.acu-wrapper');if(E.length?E.replaceWith(C):sn(C),'embedded'!==f.positionMode&&y&&ge)if(k)rn(y);else{0===$('.acu-embedded-options-container').length&&rn(y)}else f.positionMode,$('.acu-embedded-options-container').remove();if($n(s),cn(),_e(),Ae.get('acu_changes_panel_active',!1)&&un(),Se()){const t=$('#acu-data-area');t.length&&(t.html('<div class="acu-mvu-panel">'+vt.renderPanel()+'</div>'),vt.bindEvents(t),vt.getDataWithRetry(5,800).then(e=>{e&&Se()&&(t.html('<div class="acu-mvu-panel">'+vt.renderPanel()+'</div>'),vt.bindEvents(t))}).catch(e=>{console.error('[DICE]MvuModule Error getting data:',e),Se()&&(t.html('<div class="acu-mvu-panel">'+vt.renderPanel()+'</div>'),vt.bindEvents(t))}))}setTimeout(()=>{const t=$('.acu-panel-content'),e=De(),a=be[e];t.length&&(a?(t.scrollTop(a.top),t.scrollLeft(a.left)):(i>0&&t.scrollTop(i),o>0&&t.scrollLeft(o)),a&&a.inner&&Object.keys(a.inner).forEach(e=>{const n=a.inner[e],o=t.find(`.acu-editable-title[data-row="${e}"]`);if(o.length){const t=o.closest('.acu-data-card');t.scrollTop(n),t.find('.acu-card-body').scrollTop(n)}}))},0),console.info('[DICE]ç•Œé¢æ¸²æŸ“å®Œæˆ')},rn=t=>{const{$}=$e();$('.acu-embedded-options-container').remove();const e=(()=>{const t=$('#chat .mes').filter(function(){const t=$(this);return'true'!==t.attr('is_user')&&'true'!==t.attr('is_system')&&!t.hasClass('sys_mes')&&('System'!==t.find('.name_text').text().trim()&&'true'!==t.attr('data-is-system')&&(0!==t.find('.mes_text').length&&'none'!==t.css('display')))});if(0===t.length)return null;const e=t.last(),a=e.find('.mes_text'),n=e.find('.mes_block');return a.length?a:n.length?n:e})();if(e&&e.length){const a=ma(),n=$(`<div class="acu-embedded-options-container acu-theme-${a.theme}" style="--acu-opt-font-size:${a.optionFontSize||12}px;"></div>`);n.html(t),e.append(n)}},cn=()=>{const{$}=$e();$('body').off('click.acu_opt').on('click.acu_opt','.acu-opt-btn',async function(t){t.preventDefault(),t.stopPropagation();const e=ma(),a=decodeURIComponent($(this).data('val'));if(!e.clickOptionToAutoSend)return l(a,'action'),void $('#send_textarea').focus();if(window.TavernHelper)try{if(window.TavernHelper.createChatMessages)return await window.TavernHelper.createChatMessages([{role:'user',message:a}],{refresh:'affected'}),void(window.TavernHelper.triggerSlash&&await window.TavernHelper.triggerSlash('/trigger'))}catch(t){console.warn('[DICE]ACU TavernHelper å‘é€å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ',t)}const n=window.SillyTavern||window.parent?.SillyTavern;if(n&&n.executeSlashCommandsWithOptions)try{const t=`/send raw=true "${a.replace(/\\/g,'\\\\').replace(/"/g,'\\"')}"`,e=await n.executeSlashCommandsWithOptions(t);if(!e.isError&&!e.isAborted)return void await n.executeSlashCommandsWithOptions('/trigger');console.warn('[DICE]ACU STæ¥å£ send å¤±è´¥:',e)}catch(t){console.warn('[DICE]ACU STæ¥å£å¤±è´¥ï¼Œå°è¯•æŒ‰é’®æ¨¡æ‹Ÿ',t)}const o=$('#send_textarea');if(o.length){o.val(a),o.trigger('input').trigger('change'),await new Promise(t=>setTimeout(t,50));const t=$('#send_but').filter(':visible');if(t.length)t[0].click();else{const t=$.Event('keydown',{keyCode:13,which:13,bubbles:!0});o.trigger(t)}}})},sn=t=>{const{$}=$e();if('embedded'===ma().positionMode){$('.acu-wrapper').remove();const e=(()=>{const t=$('#chat .mes').filter(function(){const t=$(this);if('true'===t.attr('is_user'))return!1;if('true'===t.attr('is_system'))return!1;if(t.hasClass('sys_mes'))return!1;if('System'===t.find('.name_text').text().trim())return!1;if('none'===t.css('display'))return!1;const e=t.find('.mes_text');if(0===e.length)return!1;const a=e.text().trim(),n=e.find('img').length>0;return!(0===a.length&&!n)});if(0===t.length)return $('#chat');let e=t.length-1;const a=t.eq(e),n=a.find('.mes_block');return n.length?n:a})();return void(e.length?e.hasClass('mes_block')||e.hasClass('mes')?0===e.find('.acu-wrapper').length?e.append(t):e.find('.acu-wrapper').replaceWith(t):0===$('#chat').find('.acu-wrapper').length&&e.append(t):$('body').append(t))}const e=$('#chat'),a=$('.acu-wrapper');a.length?a.replaceWith(t):e.length?e.append(t):$('body').append(t)},ln=t=>{const e=Ne(),a=ma(),n=t?rt.validateAllData(t):[];if(!(e&&t||0!==n.length))return'\n                <div class="acu-panel-header">\n                    <div class="acu-panel-title">\n                        <div class="acu-title-main"><i class="fa-solid fa-code-compare"></i> <span class="acu-title-text">æ›´æ–°å®¡æ ¸</span></div>\n                        <div class="acu-title-sub">å¯¹æ¯”ä¸Šæ¬¡ä¿å­˜çš„å¿«ç…§</div>\n                    </div>\n                    <div class="acu-header-actions">\n                        <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                </div>\n                <div class="acu-panel-content" style="display:flex;align-items:center;justify-content:center;">\n                    <div class="acu-empty-hint">æš‚æ— å¿«ç…§æ•°æ®</div>\n                </div>';const o=[];for(const a in t){if(!a.startsWith('sheet_'))continue;const n=t[a],i=e[a];if(!n?.name||!n?.content)continue;const r=n.name,c=n.content[0]||[],s=n.content.slice(1),l=i?.content?.slice(1)||[],u=new Map;l.forEach((t,e)=>{const a=String(t[1]??'').trim();u.has(a)||u.set(a,[]),u.get(a).push({index:e,row:t})}),s.forEach((t,e)=>{const n=String(t[1]??'').trim();let i,s;if(n&&u.has(n)){const t=u.get(n);if(t.length>0){const e=t.shift();i=e.row,s=e.index}}else n||(i=l[e],s=e);if(i){const n=[];if(t.forEach((t,e)=>{if(0===e)return;const a=String(i[e]??''),o=String(t??'');a!==o&&n.push({colIndex:e,header:c[e]||`åˆ—${e}`,oldValue:a,newValue:o})}),1===n.length){const i=n[0];o.push({type:'cell_modified',tableName:r,tableKey:a,rowIndex:e,colIndex:i.colIndex,header:i.header,oldValue:i.oldValue,newValue:i.newValue,rowTitle:t[1]||`è¡Œ ${e+1}`})}else n.length>1&&o.push({type:'row_modified',tableName:r,tableKey:a,rowIndex:e,headers:c,row:t,oldRow:i,changedFields:n,rowTitle:t[1]||`è¡Œ ${e+1}`})}else o.push({type:'row_added',tableName:r,tableKey:a,rowIndex:e,headers:c,row:t,title:t[1]||`è¡Œ ${e+1}`})});const d=new Map;s.forEach((t,e)=>{const a=String(t[1]??'').trim();a&&d.set(a,(d.get(a)||0)+1)});const p=new Map;l.forEach((t,e)=>{const a=String(t[1]??'').trim();a&&p.set(a,(p.get(a)||0)+1)});const g=new Set;l.forEach((t,e)=>{const n=String(t[1]??'').trim();if(n){if(!g.has(n)){g.add(n);const t=(p.get(n)||0)-(d.get(n)||0);if(t>0){l.map((t,e)=>({row:t,index:e})).filter(t=>String(t.row[1]??'').trim()===n).slice(-t).forEach(t=>{o.push({type:'row_deleted',tableName:r,tableKey:a,rowIndex:t.index,headers:c,row:t.row,title:n})})}}}else e>=s.length&&o.push({type:'row_deleted',tableName:r,tableKey:a,rowIndex:e,headers:c,row:t,title:`è¡Œ ${e+1}`})})}for(const a in e)if(a.startsWith('sheet_')&&!t[a]){const t=e[a];o.push({type:'table_deleted',tableName:t?.name||a,tableKey:a})}const i=Ae.get(J,!1);let c=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n                    <div class="acu-title-main"><i class="fa-solid ${i?'fa-shield-halved':'fa-code-compare'}"></i> <span class="acu-title-text">${i?'æ•°æ®éªŒè¯':'å®Œæ•´å®¡æ ¸'}</span></div>\n                </div>\n                <div class="acu-header-actions">\n                    ${i?'':'<button class="acu-changes-batch-btn acu-batch-accept" title="æ¥å—å…¨éƒ¨å˜æ›´"><i class="fa-solid fa-check-double"></i></button>'}\n                    <button class="acu-changes-batch-btn acu-batch-reject" title="${i?'å…¨éƒ¨å›æ»š':'æ‹’ç»å…¨éƒ¨å˜æ›´'}"><i class="fa-solid fa-rotate-left"></i></button>\n                    <button class="acu-changes-batch-btn acu-simple-mode-toggle ${i?'active':''}" title="${i?'åˆ‡æ¢åˆ°å®Œæ•´å®¡æ ¸æ¨¡å¼':'åˆ‡æ¢åˆ°æ•°æ®éªŒè¯æ¨¡å¼'}">\n                        <i class="fa-solid ${i?'fa-filter-circle-xmark':'fa-filter'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="å®¡æ ¸é¢æ¿" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                    </div>\n                    <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>`;if(c+=`<div class="acu-panel-content acu-changes-content ${'horizontal'===a.layout?'acu-changes-horizontal':''}">`,i)if(0===n.length)c+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                æ•°æ®éªŒè¯é€šè¿‡ï¼Œæ— è¿è§„é¡¹\n            </div>';else{const t=rt.groupErrorsByTable(n),e=Ae.get('acu_validation_collapsed_groups',[]);c+='<div class="acu-changes-list">';for(const a in t){const n=t[a],o=e.includes(a);c+=`<div class="acu-changes-group ${o?'collapsed':''}">\n                    <div class="acu-changes-group-header acu-validation-group-header" data-table="${r(a)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${o?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${Ce(a)}"></i> ${r(a)}\n                        <span class="acu-changes-count" style="background:var(--acu-error-text);">${n.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${o?'display:none;':''}">`,n.forEach(t=>{const e=t.rule?r(JSON.stringify({ruleId:t.ruleId,ruleType:t.ruleType,tableName:t.tableName,rowIndex:t.rowIndex,columnName:t.columnName||'',currentValue:t.currentValue||'',rowTitle:t.rowTitle||'',rule:t.rule})):'';c+=`<div class="acu-change-item acu-validation-error-item"\n                         data-table="${r(t.tableName)}"\n                         data-row="${t.rowIndex}"\n                         data-column="${r(t.columnName||'')}"\n                         data-rule-id="${r(t.ruleId||'')}"\n                         data-rule-type="${r(t.ruleType||'')}"\n                         data-rule-data="${e}">\n                        <span class="acu-change-badge" style="background:var(--acu-hl-manual-bg);color:var(--acu-hl-manual);">!</span>\n                        ${t.rowTitle&&t.rowIndex>=0?`<div class="acu-validation-row-title" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:2px;">${r(t.rowTitle)}</div>`:''}\n                        <span class="acu-change-title">${r(t.columnName||'æ•´è¡Œ')}${t.currentValue?`: ${r(t.currentValue.length>15?t.currentValue.substring(0,15)+'...':t.currentValue)}`:''}</span>\n                        <span class="acu-validation-error-msg">${r(t.errorMessage.length>25?t.errorMessage.substring(0,25)+'...':t.errorMessage)}</span>\n                        <div class="acu-change-actions">\n                            <button class="acu-change-action-btn acu-action-reject" title="å›æ»š"><i class="fa-solid fa-rotate-left"></i></button>\n                            <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                        </div>\n                    </div>`}),c+='</div></div>'}c+='</div>'}else if(0===o.length)c+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                å½“å‰æ•°æ®ä¸å¿«ç…§ä¸€è‡´ï¼Œæ— å˜æ›´\n            </div>';else{const t={};o.forEach(e=>{const a=e.tableName;t[a]||(t[a]=[]),t[a].push(e)}),c+='<div class="acu-changes-list">';const e=Ae.get('acu_changes_collapsed_groups',[]);for(const a in t){const n=t[a],o=e.includes(a);c+=`<div class="acu-changes-group ${o?'collapsed':''}">\n                    <div class="acu-changes-group-header" data-table="${r(a)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${o?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${Ce(a)}"></i> ${r(a)}\n                        <span class="acu-changes-count">${n.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${o?'display:none;':''}">`,n.forEach(t=>{if('row_added'===t.type)c+=`<div class="acu-change-item acu-change-added"\n                            data-change-type="row_added"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}">\n                            <span class="acu-change-badge acu-badge-added">æ–°</span>\n                            <span class="acu-change-title">${r(t.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="æ‹’ç»"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`;else if('row_deleted'===t.type)c+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="row_deleted"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}">\n                            <span class="acu-change-badge acu-badge-deleted">åˆ </span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">${r(t.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—åˆ é™¤"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="æ¢å¤æ­¤è¡Œ"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`;else if('cell_modified'===t.type){const e=t.oldValue.length>15?t.oldValue.substring(0,15)+'...':t.oldValue,a=t.newValue.length>15?t.newValue.substring(0,15)+'...':t.newValue;let n;n=t.tableName&&t.tableName.includes('é€‰é¡¹')?`${r(t.tableName)}.${r(t.header)}`:`${r(t.rowTitle)}.${r(t.header)}`,c+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="cell_modified"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}"\n                            data-col-index="${t.colIndex}"\n                            data-old-value="${encodeURIComponent(t.oldValue)}">\n                            <span class="acu-change-badge acu-badge-modified">æ›´</span>\n                            <span class="acu-change-field">${n}</span>\n                            <span class="acu-change-diff">\n                                <span class="acu-diff-old">${r(e||'(ç©º)')}</span>\n                                <span class="acu-diff-arrow">â†’</span>\n                                <span class="acu-diff-new">${r(a||'(ç©º)')}</span>\n                            </span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="æ‹’ç»"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else if('row_modified'===t.type){const e=t.changedFields.length,a=t.changedFields.slice(0,2).map(t=>t.header).join('ã€'),n=e>2?` ç­‰${e}é¡¹`:'';c+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="row_modified"\n                            data-table-key="${t.tableKey}"\n                            data-row-index="${t.rowIndex}">\n                            <span class="acu-change-badge acu-badge-modified">æ›´</span>\n                            <span class="acu-change-title">${r(t.rowTitle)}</span>\n                            <span class="acu-change-field-count">${r(a)}${n}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="æ‹’ç»"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else'table_deleted'===t.type&&(c+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="table_deleted"\n                            data-table-key="${t.tableKey}">\n                            <span class="acu-change-badge acu-badge-deleted">åˆ </span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">æ•´è¡¨å·²åˆ é™¤</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="æ¢å¤æ•´è¡¨"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`)}),c+='</div></div>'}c+='</div>'}return c+='</div>',c},un=()=>{const{$}=$e();$('.acu-changes-content').closest('.acu-data-display').find('.acu-close-btn').off('click').on('click',function(){Ae.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')});$('.acu-validation-error-item .acu-action-reject').off('click').on('click',async function(t){t.stopPropagation();const e=$(this).closest('.acu-validation-error-item'),a=e.data('table'),n=parseInt(e.data('row'),10),o=e.data('column'),i=Ne();if(i)try{const t=ie||wa();for(const e in t)if(t[e]?.name===a&&i[e]){const a=(t[e].content?.[0]||[]).indexOf(o);if(a>=0&&i[e].content?.[n+1]){const o=i[e].content[n+1][a];return t[e].content[n+1][a]=o,await ka(t,!1,!1),void nn()}break}window.toastr&&window.toastr.warning('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„å¿«ç…§æ•°æ®')}catch(t){console.error('[DICE]ACU æ¢å¤å¿«ç…§å€¼å¤±è´¥:',t),window.toastr&&window.toastr.error('æ¢å¤å¤±è´¥')}else window.toastr&&window.toastr.warning('æ— å¿«ç…§æ•°æ®å¯æ¢å¤')}),$('.acu-validation-error-item .acu-action-edit').off('click').on('click',function(t){t.stopPropagation();const e=$(this).closest('.acu-validation-error-item'),a=e.data('rule-data');if(a)try{const t='string'==typeof a?JSON.parse(a):a,n={ruleId:t.ruleId,ruleType:t.ruleType,rule:t.rule,tableName:e.data('table')||t.tableName||'',rowIndex:parseInt(e.data('row'),10)||t.rowIndex||0,columnName:e.data('column')||t.columnName||'',currentValue:t.currentValue||'',rowTitle:t.rowTitle||'',ruleName:t.ruleName||t.rule?.name||'',errorMessage:t.errorMessage||t.rule?.errorMessage||''};Da(n)}catch(t){console.error('[DICE]ACU è§£æè§„åˆ™æ•°æ®å¤±è´¥:',t),window.toastr&&window.toastr.error('è§£æè§„åˆ™æ•°æ®å¤±è´¥')}else window.toastr&&window.toastr.warning('æ— æ³•è·å–è§„åˆ™ä¿¡æ¯')});let t=null;$('.acu-validation-error-item').off('click touchstart touchend touchmove').on('touchstart',function(e){const a=e.originalEvent.touches[0];t={x:a.clientX,y:a.clientY}}).on('touchmove',function(e){if(!t)return;const a=e.originalEvent.touches[0],n=Math.abs(a.clientX-t.x),o=Math.abs(a.clientY-t.y);(n>10||o>10)&&(t=null)}).on('touchend',function(e){if(!t)return;if(t=null,$(e.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if(Ae.get(J,!1))return;const a=$(this).data('table'),n=$(this).data('row');Ae.set('acu_changes_panel_active',!1),Ie(a),nn(),setTimeout(()=>{const t=$(`.acu-data-card[data-row-index="${n}"]`);t.length&&(t[0].scrollIntoView({behavior:'smooth',block:'center'}),t.addClass('acu-highlight-flash'),setTimeout(()=>t.removeClass('acu-highlight-flash'),2e3))},300)}).on('click',function(t){if($(t.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if('ontouchstart'in window)return;if(Ae.get(J,!1))return;const e=$(this).data('table'),a=$(this).data('row');Ae.set('acu_changes_panel_active',!1),Ie(e),nn(),setTimeout(()=>{const t=$(`.acu-data-card[data-row-index="${a}"]`);t.length&&(t[0].scrollIntoView({behavior:'smooth',block:'center'}),t.addClass('acu-highlight-flash'),setTimeout(()=>t.removeClass('acu-highlight-flash'),2e3))},300)}),$('.acu-changes-group-header').off('click').on('click',function(t){if($(t.target).closest('.acu-change-item').length)return;const e=$(this).data('table'),a=$(this).closest('.acu-changes-group'),n=a.find('.acu-changes-group-body'),o=$(this).find('.acu-collapse-icon'),i=$(this).hasClass('acu-validation-group-header')?'acu_validation_collapsed_groups':'acu_changes_collapsed_groups';let r=Ae.get(i,[]);a.hasClass('collapsed')?(a.removeClass('collapsed'),n.slideDown(200),o.removeClass('fa-chevron-right').addClass('fa-chevron-down'),r=r.filter(t=>t!==e)):(a.addClass('collapsed'),n.slideUp(200),o.removeClass('fa-chevron-down').addClass('fa-chevron-right'),r.includes(e)||r.push(e)),Ae.set(i,r)}),$('.acu-change-item .acu-action-accept').off('click').on('click',async function(t){t.stopPropagation();const e=$(this).closest('.acu-change-item'),a=e.data('change-type'),n=e.data('table-key'),o=e.data('row-index'),i=e.data('col-index'),r=Ne(),c=ie||wa();r&&c&&('cell_modified'===a?r[n]?.content?.[o+1]&&c[n]?.content?.[o+1]&&(r[n].content[o+1][i]=c[n].content[o+1][i]):'row_modified'===a?r[n]?.content&&c[n]?.content?.[o+1]&&(r[n].content[o+1]=[...c[n].content[o+1]]):'row_added'===a?c[n]?.content?.[o+1]&&(r[n]?r[n].content[o+1]=[...c[n].content[o+1]]:r[n]=JSON.parse(JSON.stringify(c[n]))):'row_deleted'===a?r[n]?.content?.[o+1]&&r[n].content.splice(o+1,1):'table_deleted'===a&&delete r[n],Re(r),e.fadeOut(200,function(){$(this).remove(),dn()}))}),$('.acu-change-item .acu-action-reject').off('click').on('click',async function(t){t.stopPropagation();const e=$(this).closest('.acu-change-item'),a=e.data('change-type'),n=e.data('table-key'),o=e.data('row-index'),i=e.data('col-index'),r=decodeURIComponent(e.data('old-value')||''),c=Ne();let s=ie||wa();c&&s&&('cell_modified'===a?s[n]?.content?.[o+1]&&(s[n].content[o+1][i]=r):'row_modified'===a?c[n]?.content?.[o+1]&&s[n]?.content&&(s[n].content[o+1]=[...c[n].content[o+1]]):'row_added'===a&&s[n]?.content?.[o+1]&&s[n].content.splice(o+1,1),await $a(s),e.fadeOut(200,function(){$(this).remove(),dn()}))}),$('.acu-action-restore').off('click').on('click',async function(t){t.stopPropagation();const e=$(this).closest('.acu-change-item'),a=e.data('change-type'),n=e.data('table-key'),o=e.data('row-index'),i=Ne();let r=ie||wa();if(i&&r){if('row_deleted'===a){if(i[n]?.content?.[o+1]){const t=[...i[n].content[o+1]];r[n]||(r[n]=JSON.parse(JSON.stringify(i[n])),r[n].content=[i[n].content[0]]),r[n].content.splice(o+1,0,t)}}else'table_deleted'===a&&i[n]&&(r[n]=JSON.parse(JSON.stringify(i[n])));await $a(r),e.fadeOut(200,function(){$(this).remove(),dn()})}}),$('.acu-change-item:not(.acu-validation-error-item) .acu-action-edit').off('click').on('click',function(t){t.stopPropagation();const e=$(this).closest('.acu-change-item'),a=e.data('table-key'),n=e.data('row-index'),o=e.data('change-type');if(!a||void 0===n)return;const i=ie||wa();if(!i||!i[a])return;const r=i[a],c=r.content?r.content[0]:[],s=r.content?r.content[n+1]:null;if(s)if('row_modified'===o)bn(s,c,r.name||'ç¼–è¾‘',n,a);else if('cell_modified'===o){const t=e.data('col-index'),o=c[t]||`åˆ—${t}`,i=s[t]||'';fn(i,o,r.name,n,t,a)}else gn(s,c,r.name||'ç¼–è¾‘',n,a);else window.toastr&&window.toastr.warning('è¯¥è¡Œå¯èƒ½å·²è¢«åˆ é™¤')}),$('.acu-batch-accept').off('click').on('click',async function(){const t=ie||wa();t&&(Re(JSON.parse(JSON.stringify(t))),ae=new Set,dn())}),$('.acu-batch-reject').off('click').on('click',async function(){const t=Ne();if(!t)return void(window.toastr&&window.toastr.warning('æ— å¿«ç…§æ•°æ®'));const e=JSON.parse(JSON.stringify(t));ie=e,await ka(e,!1,!1)}),$('.acu-simple-mode-toggle').off('click').on('click',function(){const t=!Ae.get(J,!1);Ae.set(J,t);const e=ie||wa();$('#acu-data-area').html(ln(e)),un(),pn(e)}),$('.acu-changes-content').closest('.acu-data-display').find('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const e=this;e.setPointerCapture(t.pointerId),$(e).addClass('active');const a=$('#acu-data-area'),n=a.height(),o=t.clientY,i=$(e).data('table');e.onpointermove=function(t){const e=t.clientY-o;let i=n-e;i<C&&(i=C),i>E&&(i=E),a.css('height',i+'px')},e.onpointerup=function(t){$(e).removeClass('active'),e.releasePointerCapture(t.pointerId),e.onpointermove=null,e.onpointerup=null;const n=a.height(),o=Oe();o[i]=n,Be(o)}}).off('dblclick').on('dblclick',function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data('table');$('#acu-data-area').css('height','');const a=Oe();delete a[e],Be(a)});const e=$('.acu-changes-content.acu-changes-horizontal');e.length&&(e[0].addEventListener('touchstart',function(t){this._touchStartX=t.touches[0].clientX,this._touchStartY=t.touches[0].clientY,this._scrollDirection=null},{passive:!0}),e[0].addEventListener('touchmove',function(t){if(!this._touchStartX)return;const e=Math.abs(t.touches[0].clientX-this._touchStartX),a=Math.abs(t.touches[0].clientY-this._touchStartY);!this._scrollDirection&&(e>5||a>5)&&(this._scrollDirection=e>a?'horizontal':'vertical'),'horizontal'===this._scrollDirection&&e>10&&t.stopPropagation()},{passive:!1}),e[0].addEventListener('touchend',function(){this._touchStartX=null,this._touchStartY=null,this._scrollDirection=null},{passive:!0}))},dn=()=>{const{$}=$e(),t=ie||wa();ae=ha(t);const e=$('#acu-data-area');e.length&&Ae.get('acu_changes_panel_active',!1)&&(e.html(ln(t)),un(),pn(t))},pn=t=>{const{$}=$e(),e=Ne();let a=0;if(e&&t){for(const n in t){if(!n.startsWith('sheet_'))continue;const o=t[n],i=e[n];if(!o?.content)continue;const r=o.content.slice(1),c=i?.content?.slice(1)||[],s=new Map;c.forEach((t,e)=>{const a=String(t[1]??'').trim();s.has(a)||s.set(a,[]),s.get(a).push({index:e,row:t})}),r.forEach((t,e)=>{const n=String(t[1]??'').trim();let o;if(n&&s.has(n)){const t=s.get(n);if(t.length>0){const e=t.shift();o=e.row}}else n||(o=c[e]);if(o){let e=!1;t.forEach((t,a)=>{0!==a&&String(t??'')!==String(o[a]??'')&&(e=!0)}),e&&a++}else a++});const l=new Map,u=new Map;r.forEach(t=>{const e=String(t[1]??'').trim();e&&l.set(e,(l.get(e)||0)+1)}),c.forEach(t=>{const e=String(t[1]??'').trim();e&&u.set(e,(u.get(e)||0)+1)}),u.forEach((t,e)=>{const n=l.get(e)||0;t>n&&(a+=t-n)});const d=c.filter(t=>!String(t[1]??'').trim()).length,p=r.filter(t=>!String(t[1]??'').trim()).length;d>p&&(a+=d-p)}for(const n in e)n.startsWith('sheet_')&&!t[n]&&a++}const n=t?rt.getErrorCount(t):0,o=Ae.get(J,!1),i=o?n:a,r=o&&n>0,c=$('#acu-btn-changes'),s=c.find('span');s.html(i>0?`å®¡æ ¸(${i})`:'å®¡æ ¸'),r?(c.find('.acu-nav-warning-icon').length||s.append(' <i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>'),c.addClass('has-validation-errors')):(c.find('.acu-nav-warning-icon').remove(),c.removeClass('has-validation-errors'))},gn=(t,e,a,n,o)=>{const{$}=$e(),i=ma(),s=t.map((t,a)=>{if(0===a)return'';const n=e[a]||`åˆ— ${a}`,o=t||'';return`\n                <div class="acu-card-edit-field">\n                    <label class="acu-card-edit-label">${r(n)}</label>\n                    <textarea class="acu-card-edit-input acu-card-edit-textarea" data-col="${a}" spellcheck="false" rows="1">${r(o)}</textarea>\n                </div>`}).join(''),l=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${i.theme}">\n                    <div class="acu-edit-title">ç¼–è¾‘å˜æ›´ (#${n+1} - ${r(a)})</div>\n                    <div class="acu-settings-content acu-settings-content-scroll">\n                        ${s}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-change-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-change-save"><i class="fa-solid fa-check"></i> ä¿å­˜å¹¶ç¡®è®¤</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(l);const u=t=>{t.style.height='auto';const e=t.scrollHeight+2;t.style.height=Math.min(e,500)+'px',t.style.overflowY=e>500?'auto':'hidden'};requestAnimationFrame(()=>{l.find('textarea').each(function(){u(this)})}),l.find('textarea').on('input',function(){u(this)}),l.find('textarea').on('input',function(){u(this)});const d=()=>{ee=!1,l.remove()};l.find('#dlg-change-cancel').click(d),c(l,'acu-edit-overlay',d),l.find('#dlg-change-save').click(async()=>{let t=ie||wa();if(t&&t[o]){const e=t[o]?.content?.[n+1];if(!e)return void d();let a=!1;if(l.find('textarea').each(function(){const t=parseInt($(this).data('col')),n=$(this).val();String(e[t])!==String(n)&&(a=!0,e[t]=n)}),a){try{const e=$e().getDB();if(!e||!e.importTableAsJson)throw new Error('æ•°æ®åº“ API ä¸å¯ç”¨');const a={mate:t.mate||{type:'chatSheets',version:1}};let n;Object.keys(t).forEach(e=>{e.startsWith('sheet_')&&(a[e]=t[e])});try{n=JSON.stringify(a);const t=new Blob([n]).size/1048576;if(t>10)throw new Error(`æ•°æ®å¤ªå¤§ (${t.toFixed(2)}MB)ï¼Œè¶…è¿‡ 10MB é™åˆ¶`)}catch(t){throw console.error('[DICE]ACU JSON åºåˆ—åŒ–å¤±è´¥:',t),new Error(`æ•°æ®åºåˆ—åŒ–å¤±è´¥: ${t.message||t}`)}if(!1===await e.importTableAsJson(n))throw new Error('æ•°æ®å¯¼å…¥å¤±è´¥ï¼ˆè¿”å› falseï¼‰');ie=t}catch(t){console.error('[DICE]ACU ä¿å­˜å¤±è´¥:',t);let e=t.message||'ä¿å­˜å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼å’Œå¤§å°';const a=String(t);return(a.includes('Settings could not be saved')||a.includes('server connection')||a.includes('data loss'))&&(e='ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨è¿æ¥é—®é¢˜æˆ–æ•°æ®è¿‡å¤§ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å‡å°‘æ•°æ®é‡'),void(window.toastr?window.toastr.error(e,'ä¿å­˜å¤±è´¥',{timeOut:7e3}):alert(`ä¿å­˜å¤±è´¥: ${e}`))}const a=Ne();a&&a[o]&&a[o].content&&(a[o].content[n+1]=[...e],Re(a)),ae=ha(t);$('#acu-data-area').html(ln(t)),un()}}d()})},fn=(t,e,a,n,o,i)=>{const{$}=$e(),s=ma(),l=Ne(),u=l?.[i]?.content?.[n+1]?.[o]??'',d=''!==u&&String(u)!==String(t),p=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${s.theme}" style="max-width:450px;">\n                    <div class="acu-edit-title">ç¼–è¾‘: ${r(a)} - ${r(e)}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${d?`\n                        <div class="acu-diff-section acu-diff-old-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-clock-rotate-left"></i> åŸå§‹å€¼ï¼ˆå¿«ç…§ï¼‰\n                            </div>\n                            <div class="acu-diff-readonly">${r(u)}</div>\n                        </div>\n                        <div class="acu-diff-arrow-down">\n                            <i class="fa-solid fa-arrow-down"></i>\n                        </div>\n                        `:''}\n                        <div class="acu-diff-section acu-diff-new-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-pen"></i> ${d?'å½“å‰å€¼ï¼ˆå¯ç¼–è¾‘ï¼‰':'å†…å®¹'}\n                            </div>\n                            <textarea class="acu-change-single-input acu-edit-textarea" spellcheck="false"\n                                style="width:100%;min-height:60px;max-height:300px;padding:12px;resize:none;">${r(t)}</textarea>\n                        </div>\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-single-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        ${d?'<button class="acu-dialog-btn acu-btn-revert" id="dlg-single-revert"><i class="fa-solid fa-rotate-left"></i> æ¢å¤åŸå€¼</button>':''}\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-single-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(p);const g=p.find('.acu-change-single-input'),f=()=>{g[0].style.height='auto';const t=Math.max(60,Math.min(g[0].scrollHeight+2,300));g[0].style.height=t+'px'};setTimeout(f,0),g.on('input',f),g.focus();const b=()=>p.remove();p.find('#dlg-single-cancel').click(b),c(p,'acu-edit-overlay',b),p.find('#dlg-single-revert').click(function(){g.val(u).trigger('input')}),p.find('#dlg-single-save').click(async()=>{const t=g.val();let e=ie||wa();if(e&&e[i]&&e[i].content){const a=e[i].content[n+1];if(a&&String(a[o])!==String(t)){a[o]=t,await $a(e);const r=Ne();r&&r[i]&&r[i].content&&r[i].content[n+1]&&(r[i].content[n+1][o]=t,Re(r)),ae=ha(e),dn()}}b()})},bn=(t,e,a,n,o)=>{const{$}=$e(),i=ma(),s=Ne(),l=s?.[o]?.content?.[n+1]||[];let u='';for(let a=1;a<e.length;a++){const n=e[a]||`åˆ— ${a}`,o=l[a]??'',i=t[a]??'',c=String(o)!==String(i);u+=`\n                <div class="acu-row-edit-field ${c?'acu-field-changed':''}">\n                    <div class="acu-row-edit-label">${r(n)} ${c?'<span class="acu-changed-badge">å·²æ”¹</span>':''}</div>\n                    ${c?`<div class="acu-row-edit-old">${r(o)||'<span class="acu-empty-val">(ç©º)</span>'}</div>`:''}\n                    <textarea class="acu-row-edit-input acu-edit-textarea" data-col="${a}" spellcheck="false" rows="1">${r(i)}</textarea>\n                </div>\n            `}const d=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${i.theme}" style="max-width:550px;">\n                    <div class="acu-edit-title">æ•´ä½“ç¼–è¾‘: ${r(a)} - ${r(t[1]||'è¡Œ '+(n+1))}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px; max-height:60vh;">\n                        ${u}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-row-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn" id="dlg-row-revert"><i class="fa-solid fa-rotate-left"></i> å…¨éƒ¨æ¢å¤</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-row-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(d);const p=t=>{t.style.height='auto',t.style.height=Math.min(t.scrollHeight+2,200)+'px'};d.find('textarea').each(function(){p(this)}),d.find('textarea').on('input',function(){p(this)});const g=()=>d.remove();d.find('#dlg-row-cancel').click(g),c(d,'acu-edit-overlay',g),d.find('#dlg-row-revert').click(function(){d.find('textarea').each(function(){const t=parseInt($(this).data('col'));$(this).val(l[t]??'').trigger('input')})}),d.find('#dlg-row-save').click(async()=>{let t=ie||wa();if(!t?.[o]?.content?.[n+1])return void g();const e=t[o].content[n+1];let a=!1;if(d.find('textarea').each(function(){const t=parseInt($(this).data('col')),n=$(this).val();String(e[t])!==String(n)&&(a=!0,e[t]=n)}),a){await $a(t);const a=Ne();a?.[o]?.content&&(a[o].content[n+1]=[...e],Re(a)),ae=ha(t),dn()}g()})},mn=t=>{console.info('[DICE]å¼€å§‹æŠ“å–ä»ªè¡¨ç›˜æ•°æ®...');const e=ma(),a=Rt.findTable(t,'global'),n=Rt.findTable(t,'player'),o=Rt.findTable(t,'location'),i=Rt.findTable(t,'npc'),c=Rt.findTable(t,'quest'),s=Rt.findTable(t,'bag'),l=Rt.findTable(t,'skill'),u=Rt.findTable(t,'equip');let d={name:'ä¸»è§’',status:'æ­£å¸¸',position:'',attrs:'',money:'0'};const p=Rt.parseRows(n,'player');if(p.length>0){const t=p[0];if(d.name=t.name||'ä¸»è§’',d.status=t.status||'æ­£å¸¸',d.position=t.position||'',d.money=t.money||'',d.resources='',n?.data?.headers&&n?.data?.rows?.[0]){const t=n.data.headers,e=n.data.rows[0];let a='';t.forEach((t,n)=>{if(t&&t.includes('å±æ€§')){const t=e[n];t&&(a+=(a?'; ':'')+t)}}),d.attrs=a,t.forEach((t,a)=>{if(t&&(t.includes('èµ„æº')||t.includes('é‡‘é’±'))){const t=e[a];t&&(d.resources=t)}})}}const g=n?.data?.rows||[],f=n?.data?.headers||[];let b='',m='';if(a?.data?.rows?.length>0){const t=a.data.headers||[],e=a.data.rows[0],n=Rt.findColumnIndex(t,'detailLocation',a.config);n>=0&&e[n]&&(b=e[n]);const o=Rt.findColumnIndex(t,'currentLocation',a.config);m=o>=0&&e[o]?e[o]:e[2]||''}let v=b||m||(d.position.includes('-')?d.position.split('-')[0].trim():d.position);const h=i?.name||'é‡è¦äººç‰©è¡¨',x=i?.key||'',y=Rt.parseRows(i,'npc');let w=[],k=[];y.forEach(t=>{const e=String(t.inScene||'').toLowerCase(),a={name:t.name||'æœªçŸ¥',status:t.status||'',position:t.position||'',index:t._rowIndex};'true'===e||'åœ¨åœº'===e?w.push(a):k.push(a)});let C=[...w,...k];const E=c?.name||'å¤‡å¿˜äº‹é¡¹',A=Rt.parseRows(c,'quest'),D=Rt.applyFilter(A,'active','quest'),I=t=>{const e=String(t||'').toLowerCase();return e.includes('ä¸»çº¿')?0:e.includes('æ”¯çº¿')?1:e.includes('æ—¥å¸¸')?2:3};let F=D.map(t=>({name:t.name||'ä»»åŠ¡',type:t.type||'',progress:t.progress||'',_rowIndex:t._rowIndex})).sort((t,e)=>I(t.type)-I(e.type));const S=s?.name||'èƒŒåŒ…ç‰©å“è¡¨',M=Rt.parseRows(s,'bag');let j=M.map(t=>({name:t.name||'æœªçŸ¥ç‰©å“',count:t.count||'1',type:t.type||''}));const T=l?.name||'ä¸»è§’æŠ€èƒ½è¡¨',P=Rt.parseRows(l,'skill');let N=P.map(t=>({name:t.name||'æœªçŸ¥æŠ€èƒ½',level:t.level||'',type:t.type||''}));const R=u?.name||'è£…å¤‡è¡¨',O=Rt.parseRows(u,'equip');let B=Rt.applyFilter(O,'equipped','equip').map(t=>({name:t.name||'æœªçŸ¥è£…å¤‡',type:t.type||'',part:t.part||''}));const L=o?.name||'ä¸–ç•Œåœ°å›¾ç‚¹',U=o?.key||'',V=Rt.parseRows(o,'location');let q=`\n        <div class="acu-panel-header">\n            <div class="acu-panel-title">\n                <div class="acu-title-main"><i class="fa-solid fa-chart-line"></i> <span class="acu-title-text">ä»ªè¡¨ç›˜</span></div>\n                <div class="acu-title-sub">ç»¼åˆçŠ¶æ€æ€»è§ˆ</div>\n            </div>\n            <div class="acu-header-actions">\n                <div class="acu-height-control">\n                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="ä»ªè¡¨ç›˜" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                </div>\n                <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n            </div>\n        </div>\n        <div class="acu-panel-content acu-dashboard-content">\n            <div class="acu-dash-body ${'horizontal'===e.layout?'acu-dash-horizontal':''}">\n            \x3c!-- å·¦åˆ—ï¼šä¸»è§’çŠ¶æ€ + æŠ€èƒ½ --\x3e\n                <div class="acu-dash-player">\n                    <h3 class="acu-dash-clickable acu-dash-preview-trigger"\n                        data-table-key="${n?.key||''}"\n                        data-row-index="0"\n                        data-preview-type="player"\n                        style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-user-circle"></i> ${r(gt(d.name))}</span>\n                        <span style="font-size:11px;font-weight:normal;color:var(--acu-text-main);background:var(--acu-badge-bg);padding:2px 8px;border-radius:10px;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${r(d.status)}">${r(d.status.length>6?d.status.substring(0,6)+'..':d.status)}</span>\n                    </h3>\n                    <div class="acu-player-status" style="min-height:110px;max-height:110px;overflow-y:auto;margin-bottom:10px;">\n                        ${(()=>{const t=d.resources||d.money||'',e=Jt(t);let a=[];if(g.length>0&&f.length>0){const t=g[0];f.forEach((e,n)=>{if(e&&e.includes('å±æ€§')){Jt(t[n]||'').forEach(t=>{a.some(e=>e.name===t.name)||a.push(t)})}})}if(0===e.length&&0===a.length)return'<div class="acu-empty-hint">æš‚æ— ä¸»è§’ä¿¡æ¯</div>';let n='';return e.length>0&&(n+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:52px;overflow-y:auto;margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--acu-border);">\n                                    ${e.map(t=>`\n                                        <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;">\n                                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${r(t.name)}">${r(t.name.substring(0,3))}</span>\n                                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                                <span style="color:var(--acu-accent);font-size:11px;font-weight:bold;">${t.value}</span>\n                                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${t.value}" data-name="${r(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä»¥${t.name}(${t.value})è¿›è¡Œæ£€å®š"></i>\n                                            </div>\n                                        </div>\n                                    `).join('')}\n                                </div>`),a.length>0&&(n+=`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px 6px;max-height:98px;overflow-y:auto;overflow-x:hidden;">\n                                    ${a.map(t=>`\n                                        <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;border-bottom:1px dashed var(--acu-border);min-width:0;">\n                                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${r(t.name)}">${r(t.name.substring(0,2))}</span>\n                                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                                <span style="color:var(--acu-text-main);font-size:11px;font-weight:bold;">${t.value}</span>\n                                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${t.value}" data-name="${r(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä»¥${t.name}(${t.value})è¿›è¡Œæ£€å®š"></i>\n                                            </div>\n                                        </div>\n                                    `).join('')}\n                                </div>`),n})()}\n                    </div>\n\n                    <h4 class="acu-dash-table-link" data-table="${r(T)}" style="font-size:14px;color:var(--acu-accent);margin:10px 0 6px 0;"><i class="fa-solid fa-bolt"></i> æŠ€èƒ½ (${P.length})</h4>\n                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:2px 6px;max-height:78px;overflow-y:auto;overflow-x:hidden;">\n                    ${N.length>0?N.map((t,e)=>{const a=Yt(t.level),n=a>0,o=P.findIndex(e=>e.name===t.name);return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${l?.key||''}"\n                            data-row-index="${o>=0?o:e}"\n                            data-preview-type="skill"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;border-bottom:1px dashed var(--acu-border);min-width:0;cursor:pointer;">\n                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${r(t.name)}">${r(t.name.length>5?t.name.substring(0,5)+'..':t.name)}</span>\n                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                ${n?`<span style="color:var(--acu-text-main);font-size:11px;font-weight:bold;">${a}</span>\n                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${a}" data-name="${r(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä»¥${t.name}(${a})è¿›è¡Œæ£€å®š"></i>`:`<span style="color:var(--acu-text-sub);font-size:10px;">${r(t.level||'-')}</span>`}\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— æŠ€èƒ½</div>'}\n                    </div>\n                </div>\n\n                \x3c!-- ä¸­åˆ—ï¼šåœ°ç‚¹ + NPC --\x3e\n                <div class="acu-dash-locations">\n                    <h3 class="acu-dash-table-link" data-table="${r(L)}" style="display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-map"></i> åœ°ç‚¹ (${V.length})</span>\n                        <i class="fa-solid fa-map acu-dash-map-btn" title="åœ°å›¾å¯è§†åŒ–" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                    </h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;align-content:start;max-height:110px;overflow-y:auto;overflow-x:hidden;margin-bottom:10px;">\n                    ${V.length>0?V.map((t,e)=>{const a=t.name||'æœªçŸ¥',n=v&&(a.includes(v)||v.includes(a));return`<div class="acu-location-item acu-dash-clickable acu-dash-preview-trigger ${n?'acu-current-location':''}"\n                            data-table-key="${r(U)}"\n                            data-row-index="${t._rowIndex}"\n                            data-preview-type="location">\n                            <span>\n                                ${n?'<i class="fa-solid fa-location-dot"></i>':'<i class="fa-solid fa-map-pin" style="font-size:9px;opacity:0.4;"></i>'}\n                                <span title="${r(a)}">${r(a)}</span>\n                            </span>\n                            ${n?'<i class="fa-solid fa-street-view" style="flex-shrink:0;" title="æ‚¨åœ¨è¿™é‡Œ"></i>':`<i class="fa-solid fa-walking acu-dash-goto-btn" data-location="${r(a)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;flex-shrink:0;" title="å‰å¾€${a}"></i>`}\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— åœ°ç‚¹æ•°æ®</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${r(h)}" style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-users"></i> è§’è‰² (${C.length})</span>\n                        <span style="display:flex;gap:8px;">\n                            <i class="fa-solid fa-project-diagram acu-dash-relation-graph-btn" title="äººç‰©å…³ç³»å›¾" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                            <i class="fa-solid fa-user-circle acu-dash-avatar-manager-btn" title="å¤´åƒç®¡ç†" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                        </span>\n                    </h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;align-content:start;max-height:150px;overflow-y:auto;overflow-x:hidden;">\n                    ${C.length>0?C.map((t,e)=>{const a=w.some(e=>e.name===t.name),n=e===C.length-1,o=ft.get(t.name),i=ft.getOffsetX(t.name),c=ft.getOffsetY(t.name),s=ft.getScale(t.name),l=o?`background-image:url('${o}');background-size:${s}%;background-position:${i}% ${c}%;`:'',u=a?'':'filter:grayscale(80%) brightness(0.7);opacity:0.5;';return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${r(x)}"\n                            data-row-index="${t.index}"\n                            data-preview-type="npc"\n                            style="padding:6px 4px;${n?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <span class="acu-task-name" style="font-size:12px;display:flex;align-items:center;gap:6px;">\n                                    <span class="acu-dash-npc-avatar" style="width:22px;height:22px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:var(--acu-btn-bg);border:1.5px solid ${a?'var(--acu-accent)':'var(--acu-border)'};${l}${u}" title="${a?'åœ¨åœº':'ä¸åœ¨åœº'}">\n                                        ${o?'':`<span style="font-size:10px;font-weight:bold;color:var(--acu-text-sub);${u}">${r(t.name.charAt(0))}</span>`}\n                                    </span>\n                                    <span title="${r(t.name)}" style="${a?'':'opacity:0.6;'}">${r(t.name.length>4?t.name.substring(0,4)+'..':t.name)}</span>\n                                </span>\n                                <div style="display:flex;align-items:center;">\n                                    <i class="fa-solid fa-people-arrows acu-dash-contest-btn" data-npc="${r(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:8px;" title="ä¸${t.name}è¿›è¡Œå¯¹æŠ—æ£€å®š"></i>\n                                </div>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— é‡è¦äººç‰©</div>'}\n                    </div>\n                </div>\n\n                \x3c!-- å³åˆ—ï¼šèƒŒåŒ… + æŠ€èƒ½ + ä»»åŠ¡ --\x3e\n                <div class="acu-dash-intel">\n                    <h3 class="acu-dash-table-link" data-table="${r(S)}"><i class="fa-solid fa-bag-shopping"></i> ç‰©å“ (${M.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:90px;overflow-y:auto;margin-bottom:10px;">\n                    ${j.length>0?j.map((t,e)=>{const a=e===j.length-1;return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${s?.key||''}"\n                            data-row-index="${e}"\n                            data-preview-type="bag"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:5px 4px;font-size:11px;cursor:pointer;${a?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <span style="color:var(--acu-text-main);flex:1;white-space:nowrap;" title="${r(t.name)}">${r(t.name.length>4?t.name.substring(0,4)+'..':t.name)}</span>\n                            <div style="display:flex;align-items:center;gap:6px;">\n                                <i class="fa-solid fa-hand-pointer acu-dash-use-item-btn" data-item="${r(t.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä½¿ç”¨${t.name}"></i>\n                                <span style="color:var(--acu-accent);font-weight:bold;">${r(t.count)}</span>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— ç‰©å“</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${r(R)}" style="margin-top:10px;"><i class="fa-solid fa-shield-halved"></i> è£…å¤‡ (${B.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:80px;overflow-y:auto;margin-bottom:10px;">\n                    ${B.length>0?B.map((t,e)=>{const a=e===B.length-1;return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${u?.key||''}"\n                            data-row-index="${O.findIndex(e=>e.name===t.name)}"\n                            data-preview-type="equipment"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:5px 4px;font-size:11px;cursor:pointer;${a?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <span style="color:var(--acu-text-main);" title="${r(t.name)}">${r(t.name.length>5?t.name.substring(0,5)+'..':t.name)}</span>\n                            <span style="color:var(--acu-text-sub);font-size:10px;">${r(t.part||t.type)}</span>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— è£…å¤‡</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${r(E)}" style="margin-top:10px;"><i class="fa-solid fa-clipboard-list"></i> ä»»åŠ¡ (${F.length})</h3>\n                    <div style="max-height:50px;overflow-y:auto;">\n                    ${F.length>0?F.map((t,e)=>{const a=String(t.type||'').includes('ä¸»çº¿');let n=null;const o=String(t.progress||'').match(/(\d+)\s*%/);o&&(n=Math.min(100,Math.max(0,parseInt(o[1],10))));const i=null!==n?`<div style="width:40px;height:4px;background:var(--acu-border);border-radius:2px;overflow:hidden;"><div style="width:${n}%;height:100%;background:var(--acu-accent);"></div></div>`:'';return`<div class="acu-task-item acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${c?.key||''}"\n                            data-row-index="${void 0!==t._rowIndex?t._rowIndex:A.findIndex(e=>e.name===t.name)}"\n                            data-preview-type="quest"\n                            style="padding:4px 8px;margin-bottom:3px;cursor:pointer;">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <div class="acu-task-name" style="font-size:11px;${a?'font-weight:600;':''}">${r(t.name)}</div>\n                                ${i}\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— ä»»åŠ¡</div>'}\n                    </div>\n                </div>\n            </div>\n    `;const Y=[a?'å…¨å±€æ•°æ®':null,n?'ä¸»è§’ä¿¡æ¯':null,o?'åœ°ç‚¹':null,i?'NPC':null,c?'ä»»åŠ¡':null,s?'èƒŒåŒ…':null,l?'æŠ€èƒ½':null,u?'è£…å¤‡':null].filter(Boolean);return console.info(`[DICE]ä»ªè¡¨ç›˜æ•°æ®æŠ“å–å®Œæˆï¼Œå…±${Y.length}ä¸ªæ¨¡å—: ${Y.join(', ')}`),q},vn=async()=>{const t=await lt.getAll(),e=await lt.getAllTags(),a={},n=[];for(const e of t)if(e.tags&&e.tags.length>0)for(const t of e.tags)a[t]||(a[t]=[]),a[t].push(e);else n.push(e);const o=t=>{const e=t.header.map((e,a)=>`\n        <div class="acu-card-row">\n          <div class="acu-card-label">${r(e)}</div>\n          <div class="acu-card-value">${r(String(t.rowData[a]||''))}</div>\n        </div>\n      `).join(''),a=t.tags.map(t=>`<span class="acu-fav-tag">${r(t)}</span>`).join(''),n=t.sourceInfo?r(t.sourceInfo.tableName):'';return`\n        <div class="acu-data-card acu-fav-card" data-id="${r(t.id)}">\n          <div class="acu-card-header">\n            <span class="acu-card-index">${n}</span>\n            <span class="acu-editable-title">${r(String(t.rowData[0]||'æœªå‘½å'))}</span>\n          </div>\n          <div class="acu-card-body view-list">${e}</div>\n          ${a?`<div class="acu-fav-card-tags">${a}</div>`:''}\n        </div>\n      `},i=ma();let c='';for(const t of Object.keys(a).sort())c+=`\n        <div class="acu-fav-group">\n          <div class="acu-fav-group-title"><i class="fa-solid fa-tag"></i> ${r(t)}</div>\n          <div class="acu-card-grid">${a[t].map(o).join('')}</div>\n        </div>\n      `;return n.length>0&&(c+=`\n        <div class="acu-fav-group">\n          <div class="acu-fav-group-title"><i class="fa-solid fa-inbox"></i> æœªåˆ†ç±»</div>\n          <div class="acu-card-grid">${n.map(o).join('')}</div>\n        </div>\n      `),0===t.length&&(c+='\n        <div class="acu-fav-empty">\n          <i class="fa-solid fa-star"></i>\n          <p>æš‚æ— æ”¶è—</p>\n          <p>å³é”®ç‚¹å‡»è¡¨æ ¼è¡Œ â†’ é€‰æ‹©"æ”¶è—æ­¤è¡Œ"</p>\n        </div>\n      '),`\n      <div class="acu-fav-wrapper acu-theme-${i.theme}" style="--acu-card-width:${i.cardWidth}px; --acu-font-size:${i.fontSize}px;">\n      <div class="acu-panel-header">\n        <div class="acu-panel-title">\n          <div class="acu-title-main"><i class="fa-solid fa-star"></i> <span class="acu-title-text">æ”¶è—å¤¹</span></div>\n          <div class="acu-title-sub">(å…±${t.length}é¡¹)</div>\n        </div>\n        <div class="acu-header-actions">\n          <button class="acu-view-btn" id="acu-fav-import" title="å¯¼å…¥"><i class="fa-solid fa-file-import"></i></button>\n          <button class="acu-view-btn" id="acu-fav-export" title="å¯¼å‡º"><i class="fa-solid fa-file-export"></i></button>\n          <div class="acu-search-wrapper"><i class="fa-solid fa-search acu-search-icon"></i><input type="text" class="acu-search-input" id="acu-fav-search" placeholder="æœç´¢..." /></div>\n          <div class="acu-height-control"><i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="æ”¶è—å¤¹"></i></div>\n          <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n        </div>\n      </div>\n      <div class="acu-fav-panel-content">\n        <div class="acu-fav-tag-filter-collapsible collapsed">\n          <div class="acu-fav-tag-filter-header">\n            <span>æ ‡ç­¾è¿‡æ»¤</span>\n            <i class="fa-solid fa-chevron-down acu-fav-tag-toggle-icon"></i>\n          </div>\n          <div class="acu-fav-tag-filter-body">\n            ${n.length>0?'<button class="acu-fav-tag-btn active" data-tag="__untagged__">æœªåˆ†ç±»</button>':''}\n            ${e.map(t=>`<button class="acu-fav-tag-btn active" data-tag="${r(t)}">${r(t)}</button>`).join('')}\n          </div>\n        </div>\n        ${c}\n      </div>\n      </div>\n    `},hn=t=>{const{$}=$e(),e=ie||wa()||{};t.off('.favEvents'),function(){const e=t[0];if(!e)return;if(e._favSwipeFixApplied)return;e._favSwipeFixApplied=!0;let a=0,n=0,o=!1;const i=t=>{1===t.touches.length&&(a=t.touches[0].clientX,n=t.touches[0].clientY,o=!1)},r=t=>{if(1!==t.touches.length)return;const e=t.touches[0],i=Math.abs(e.clientX-a),r=Math.abs(e.clientY-n);(r<5?i>5&&i>2*r:i>1.5*r&&i>10)&&(o=!0,t.stopImmediatePropagation(),t.stopPropagation())},c=t=>{o&&(t.stopImmediatePropagation(),t.stopPropagation(),o=!1),a=0,n=0};e.addEventListener('touchstart',i,!0),e.addEventListener('touchmove',r,!0),e.addEventListener('touchend',c,!0),$(window).on('pagehide.favSwipeFix',()=>{e.removeEventListener('touchstart',i,!0),e.removeEventListener('touchmove',r,!0),e.removeEventListener('touchend',c,!0)})}(),t.on('click.favEvents','.acu-close-btn',function(e){e.stopPropagation(),Ae.set('acu_favorites_panel_active',!1),t.html(''),$('#acu-btn-favorites').removeClass('active')}),t.on('pointerdown.favEvents','.acu-height-drag-handle',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const e=this;e.setPointerCapture(t.pointerId),$(e).addClass('active');const a=$('#acu-data-area'),n=a.height()||400,o=t.clientY,i=$(e).data('table');e.onpointermove=function(t){const e=t.clientY-o;let i=n-e;i<C&&(i=C),i>E&&(i=E),a.css('height',i+'px')},e.onpointerup=function(t){if($(e).removeClass('active'),e.releasePointerCapture(t.pointerId),e.onpointermove=null,e.onpointerup=null,i){const t=Oe();t[i]=parseInt(a.css('height')),Be(t),a.addClass('acu-manual-mode')}}}),t.on('dblclick.favEvents','.acu-height-drag-handle',function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data('table');if(e){const t=Oe();delete t[e],Be(t),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),t.on('click.favEvents','.acu-fav-tag-filter-header',function(){$(this).closest('.acu-fav-tag-filter-collapsible').toggleClass('collapsed')}),t.on('click.favEvents','.acu-fav-tag-btn',function(){const e=$(this),a=e.data('tag'),n=e.hasClass('active');e.toggleClass('active'),'__untagged__'===a?t.find('.acu-fav-group').each(function(){$(this).find('.acu-fav-group-title').text().includes('æœªåˆ†ç±»')&&$(this).toggle(!n)}):t.find('.acu-fav-group').each(function(){const t=$(this).find('.acu-fav-group-title').text();t.includes(a)&&!t.includes('æœªåˆ†ç±»')&&$(this).toggle(!n)})}),t.find('#acu-fav-search').on('input.favEvents',_.debounce(function(){const e=$(this).val().toLowerCase().trim();t.find('.acu-fav-card').each(function(){const t=$(this).text().toLowerCase();$(this).toggle(t.includes(e))})},300));const a=(a,n)=>{$('.acu-cell-menu, .acu-menu-backdrop').remove();const o=$('<div class="acu-menu-backdrop"></div>');$('body').append(o);const i=ma(),c=$(`\n        <div class="acu-cell-menu acu-theme-${i.theme}" data-fav-id="${r(n)}">\n          <div class="acu-cell-menu-item" data-action="edit"><i class="fa-solid fa-pen"></i> ç¼–è¾‘</div>\n          <div class="acu-cell-menu-item" data-action="copy"><i class="fa-solid fa-copy"></i> å¤åˆ¶</div>\n          <div class="acu-cell-menu-item" data-action="send" style="color:#3498db"><i class="fa-solid fa-paper-plane"></i> å‘é€åˆ°è¡¨æ ¼</div>\n          <div class="acu-cell-menu-item" data-action="delete" style="color:#e74c3c"><i class="fa-solid fa-trash"></i> åˆ é™¤</div>\n          <div class="acu-cell-menu-item" data-action="close"><i class="fa-solid fa-times"></i> å…³é—­èœå•</div>\n        </div>\n      `);$('body').append(c);const s=$(window).width()||800,l=$(window).height()||600,u=c.outerWidth()||150,d=c.outerHeight()||150;let p=a.clientX||s/2,g=a.clientY||l/2;p+u>s&&(p=s-u-10),g+d>l&&(g=l-d-10),c.css({left:p,top:g}),o.on('click',()=>{$('.acu-cell-menu, .acu-menu-backdrop').remove()}),c.on('click','.acu-cell-menu-item',async function(){const a=$(this).data('action'),n=c.data('fav-id');if($('.acu-cell-menu, .acu-menu-backdrop').remove(),'close'===a)return;const o=await lt.getById(n);if(o)if('edit'===a)Qa(o,async e=>{await lt.updateFavorite(n,e),t.html(await vn()),hn(t)});else if('copy'===a){await lt.duplicateFavorite(n)&&(t.html(await vn()),hn(t))}else if('send'===a){const a=lt.findCompatibleTables(o,e);if(0===a.length)return void toastr.warning('å½“å‰èŠå¤©æ²¡æœ‰å…¼å®¹çš„è¡¨æ ¼');Za(o,a,e,async()=>{t.html(await vn()),hn(t)})}else'delete'===a&&(await lt.deleteFavorite(n),t.html(await vn()),hn(t))})};t.on('click.favEvents','.acu-fav-card',function(t){t.stopPropagation();const e=$(this).data('id'),n=$('.acu-cell-menu');n.length&&n.data('fav-id')===e?$('.acu-cell-menu, .acu-menu-backdrop').remove():a(t,e)}),t.on('click.favEvents','#acu-fav-import',async function(){const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=async e=>{const a=e.target.files?.[0];if(a){const e=await a.text(),n=await lt.importFavorites(e);n&&(n.added>0||n.updated>0)?(window.toastr&&window.toastr.success(`å¯¼å…¥æˆåŠŸ: æ–°å¢${n.added}æ¡, æ›´æ–°${n.updated}æ¡`),t.html(await vn()),hn(t)):window.toastr&&window.toastr.warning('å¯¼å…¥å¤±è´¥æˆ–æ— æœ‰æ•ˆæ•°æ®')}},e.click()}),t.on('click.favEvents','#acu-fav-export',async function(){const t=await lt.exportFavorites(),e=new Blob([t],{type:'application/json'}),a=URL.createObjectURL(e),n=document.createElement('a');n.href=a,n.download=`favorites_${(new Date).toISOString().slice(0,10)}.json`,n.click(),URL.revokeObjectURL(a),window.toastr&&window.toastr.success('å¯¼å‡ºæˆåŠŸ')}),console.log('[DICE] bindFavoritesEvents initialized')},xn=(t,e)=>{if(!t||!t.rows.length)return`\n            <div class="acu-panel-header"><div class="acu-panel-title"><i class="fa-solid ${Ce(e)}"></i> ${e}</div><button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button></div>\n            <div class="acu-panel-content"><div style="text-align:center;color:var(--acu-text-sub);padding:20px;">æš‚æ— æ•°æ®</div></div>`;const a=ma(),o=(t.headers||[]).slice(1),c='grid'===((Le()||{})[e]||'list');let s=1;if(1===t.headers.length)s=0;else if(e.includes('æ€»ç»“')||e.includes('å¤§çº²')){const e=t.headers.findIndex(t=>t&&(t.includes('ç´¢å¼•')||t.includes('ç¼–å·')||t.includes('ä»£ç ')));e>0&&(s=e)}let l=t.rows.map((a,o)=>{const r=n.getRowKey(e,a,t.headers);return{data:a,originalIndex:o,rowKey:r,isBookmarked:r&&i.isBookmarked(e,r)}});const u=(de[e]||'').toLowerCase().trim(),d=(t=>Ve().includes(t))(e);u?(l=l.filter(t=>t.data.some(t=>String(t).toLowerCase().includes(u))),l.sort((t,e)=>{if(t.isBookmarked&&!e.isBookmarked)return-1;if(!t.isBookmarked&&e.isBookmarked)return 1;const a=String(t.data[s]||'').toLowerCase(),n=String(e.data[s]||'').toLowerCase(),o=a.includes(u),i=n.includes(u);return a===u&&n!==u?-1:a!==u&&n===u?1:o&&!i?-1:!o&&i?1:t.originalIndex-e.originalIndex})):l.sort((t,e)=>t.isBookmarked&&!e.isBookmarked?-1:!t.isBookmarked&&e.isBookmarked?1:d?e.originalIndex-t.originalIndex:t.originalIndex-e.originalIndex);const p=a.itemsPerPage||50,g=l.length,f=Math.ceil(g/p)||1;let b=ue[e]||1;b>f&&(b=f),b<1&&(b=1),ue[e]=b;const m=(b-1)*p,v=m+p,h=l.slice(m,v),x=(t=>!!t&&['æ€»ç»“','å¤§çº²','æ—¥å¿—','è®°å½•','å†å²'].some(e=>t.includes(e)))(e),y=x?`\n            <button class="acu-view-btn acu-reverse-btn" data-table="${r(e)}" title="${d?'å½“å‰ï¼šå€’åºï¼ˆæ–°â†’æ—§ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢ä¸ºæ­£åº':'å½“å‰ï¼šæ­£åºï¼ˆæ—§â†’æ–°ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢ä¸ºå€’åº'}">\n                <i class="fa-solid ${d?'fa-sort-amount-up':'fa-sort-amount-down'}"></i>\n            </button>\n        `:'';let w=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n    <div class="acu-title-main"><i class="fa-solid ${Ce(e)}"></i> <span class="acu-title-text">${r(e)}</span></div>\n    <div class="acu-title-sub">(${m+1}-${Math.min(v,g)} / å…±${g}é¡¹)${d?' <span style="color:var(--acu-accent);">â†“å€’åº</span>':''}</div>\n</div>\n                <div class="acu-header-actions">\n                    ${e.includes('äººç‰©')?`<button class="acu-view-btn" id="acu-btn-relation-graph" data-table="${r(e)}" title="æŸ¥çœ‹äººç‰©å…³ç³»å›¾"><i class="fa-solid fa-project-diagram"></i></button>`:''}\n                    ${e.includes('åœ°å›¾')?'<button class="acu-view-btn acu-table-map-btn" title="åœ°å›¾å¯è§†åŒ–"><i class="fa-solid fa-map"></i></button>':''}\n                    ${y}\n                    <button class="acu-view-btn" id="acu-btn-switch-style" data-table="${r(e)}" title="ğŸ”„ ç‚¹å‡»åˆ‡æ¢è§†å›¾æ¨¡å¼ (å½“å‰: ${c?'åŒåˆ—ç½‘æ ¼':'å•åˆ—åˆ—è¡¨'})">\n                        <i class="fa-solid ${c?'fa-th-large':'fa-list'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${r(e)}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                    </div>\n\n                    <div class="acu-search-wrapper"><i class="fa-solid fa-search acu-search-icon"></i><input type="text" class="acu-search-input" placeholder="æœç´¢å…¨éƒ¨..." value="${(de[e]||'').replace(/"/g,'&quot;')}" /></div>\n                    <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>\n            <div class="acu-panel-content"><div class="acu-card-grid">`;if(w+=h.map(l=>{const u=l.originalIndex,d=l.data,p=d[s]||'æœªå‘½å',g=1===s,f=`${t.key}-${u}-${s}`,b=window.acuModifiedSet&&window.acuModifiedSet.has(f),m=ae.has(`${e}-row-${u}`);let v='';a.highlightNew&&(b?v='acu-highlight-manual':m&&(v='acu-highlight-diff'));const h=d.map((_,t)=>t).filter(t=>t>0&&t!==s),x=h.length%2==1,y=d.map((i,c)=>{if(c<=0||c===s)return'';if((o[c-1]||'').includes('äº¤äº’'))return'';const l=c===h[h.length-1]&&x,p=o[c-1]||'å±æ€§'+c,g=n.getRowKey(e,d,t.headers),f=g&&n.isFieldLocked(e,g,o[c-1])?'<i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:10px;opacity:0.7;margin-left:4px;" title="å·²é”å®š"></i>':'',b=p.replace(/[\(ï¼ˆ\[ã€][^)ï¼‰\]ã€‘]*[\)ï¼‰\]ã€‘]/g,'').trim(),m=t=>String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),v=String(i).trim(),y=gt(v),w=['-','--','â€”','null','none','æ— ','ç©º','n/a','undefined','/','nil'];if(w.includes(y.toLowerCase()))return'';let k='',C=!1;const E=/[;ï¼›]/,A=t=>{if(!t)return!1;return String(t).toLowerCase().includes('èº«ä»½')},D=A(p)?[]:Jt(y);if(A(p)){const t=Ee(y),e=''===m(y)&&'0'!==String(i)?'&nbsp;':m(y);k=t?'<span class="acu-badge '+t+'">'+e+'</span>':e}else if(Xt(y,b)){const t=Wt(y).filter(t=>!t.relation||!w.includes(t.relation.toLowerCase()));if(t.length>1){C=!0;let e='';for(let a=0;a<t.length;a++){const n=t[a];e+='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;'+(a<t.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'')+'">',e+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+m(n.name)+f+'</span>',n.relation&&(e+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+m(n.relation)+'</span>'),e+='</div>'}k='<div class="acu-relation-container">'+e+'</div>'}else if(1===t.length){C=!0;const e=t[0];k='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">',k+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+m(e.name)+f+'</span>',e.relation&&(k+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+m(e.relation)+'</span>'),k+='</div>'}}else if(D.length>1){C=!0;let t='';for(let e=0;e<D.length;e++){const a=D[e],n=!Q.isBlacklisted(a.name);t+='<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;">',t+='<span style="color:var(--acu-text-sub);font-size:0.9em;white-space:nowrap;" title="'+m(a.name)+'">'+m(a.name.length>3?a.name.substring(0,5):a.name)+f+'</span>',t+='<div style="display:flex;align-items:center;gap:4px;">',t+='<span style="color:var(--acu-text-main);font-weight:bold;font-size:0.95em;">'+a.value+'</span>',n&&(t+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+m(a.name)+'" data-attr-value="'+a.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:10px;" title="æ£€å®š"></i>'),t+='</div></div>'}k='<div class="acu-multi-attr-container">'+t+'</div>'}else if(1===D.length){C=!0;const t=D[0],e=!Q.isBlacklisted(t.name);k='<div style="display:flex;justify-content:space-between;align-items:center;">',k+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+m(t.name)+f+'</span>',k+='<div style="display:flex;align-items:center;gap:6px;">',k+='<span style="color:var(--acu-text-main);font-weight:bold;">'+t.value+'</span>',e&&(k+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+m(t.name)+'" data-attr-value="'+t.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>'),k+='</div></div>'}else if(y.length>0&&E.test(y)&&!y.includes('http')){const t=['-','--','â€”','null','none','æ— ','ç©º','n/a','undefined','/','nil'],e=y.split(E).map(t=>t.trim()).filter(e=>e&&!t.includes(e.toLowerCase()));if(e.length>1&&e.every(t=>t.length<=6)){k='<div class="acu-tag-container">'+e.map(t=>'<span class="acu-badge '+(Ee(t)||'acu-badge-neutral')+'">'+m(t)+'</span>').join('')+'</div>'}else k=e.length>0?m(e.join('; ')):''}else if(!qt(y)||y.includes(':')||y.includes('ï¼š')){const t=Ee(y),e=''===m(y)&&'0'!==String(i)?'&nbsp;':m(y);k=t?'<span class="acu-badge '+t+'">'+e+'</span>':e}else{const t=Yt(y),e=!Q.isBlacklisted(b);k='<div style="display:flex;justify-content:space-between;align-items:center;">',k+='<span>'+m(y)+'</span>',e&&(k+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+m(b)+'" data-attr-value="'+t+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>'),k+='</div>'}const I=ae.has(e+'-'+u+'-'+c),F=t.key+'-'+u+'-'+c,S=window.acuModifiedSet&&window.acuModifiedSet.has(F);let M='';a.highlightNew&&(S?M='acu-highlight-manual':I&&(M='acu-highlight-diff'));return'<div class="'+('acu-card-row acu-cell'+(l?' acu-grid-span-full':'')+(C?' acu-hide-label':''))+'" data-key="'+r(t.key)+'" data-tname="'+r(e)+'" data-row="'+u+'" data-col="'+c+'" data-val="'+encodeURIComponent(i??'')+'"><div class="acu-card-label">'+b+f+'</div><div class="acu-card-value '+M+'">'+k+'</div></div>'}).join(''),w=Vt(e,t.headers,d);let k='';if(w.length>0){d[s];k=`<div class="acu-card-actions">${w.map((t,e)=>`<button class="acu-action-item ${'check'===t.type?'check-type':''}" data-action-idx="${e}" data-row="${u}"><i class="fa-solid ${t.icon||'fa-play'}"></i> ${r(t.label)}</button>`).join('')}</div>`}const C=n.getRowKey(e,d,t.headers),E=C&&n.isRowLocked(e,C)?' <i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:11px;opacity:0.8;" title="æ•´è¡Œå·²é”å®š"></i>':'',A=n.getRowKey(e,d,t.headers),D=A&&i.isBookmarked(e,A),I=A?`<i class="${D?'fa-solid':'fa-regular'} fa-bookmark acu-bookmark-icon ${D?'bookmarked':''}" data-table="${r(e)}" data-row-key="${r(A)}" title="${D?'å–æ¶ˆä¹¦ç­¾':'æ·»åŠ ä¹¦ç­¾'}"></i>`:'';return`<div class="acu-data-card"><div class="acu-card-header"><span class="acu-card-index">${g?'#'+(u+1):''}</span><span class="acu-cell acu-editable-title ${v}" data-key="${r(t.key)}" data-tname="${r(e)}" data-row="${u}" data-col="${s}" data-val="${encodeURIComponent(p??'')}" title="ç‚¹å‡»ç¼–è¾‘æ ‡é¢˜">${r(p)}${E}</span>${I}</div><div class="acu-card-body ${c?'view-grid':'view-list'}">${y}</div>${k}</div>`}).join(''),w+='</div></div>',f>1){w+=`<div class="acu-panel-footer"><button class="acu-page-btn ${1===b?'disabled':''}" data-page="${b-1}" ${1===b?'disabled':''}><i class="fa-solid fa-chevron-left"></i></button>`;const t=[];if(f<=7)for(let e=1;e<=f;e++)t.push(e);else b<=4?t.push(1,2,3,4,5,'...',f):b>=f-3?t.push(1,'...',f-4,f-3,f-2,f-1,f):t.push(1,'...',b-1,b,b+1,'...',f);t.forEach(t=>{w+='...'===t?'<span class="acu-page-info">...</span>':`<button class="acu-page-btn ${t===b?'active':''}" data-page="${t}">${t}</button>`}),w+=`<button class="acu-page-btn ${b===f?'disabled':''}" data-page="${b+1}" ${b===f?'disabled':''}><i class="fa-solid fa-chevron-right"></i></button></div>`}return w},yn=()=>{const{$}=$e(),t=De(),e=$('.acu-panel-content');if(t&&e.length){const a={};e.find('.acu-data-card, .acu-card-body, .acu-edit-textarea').each(function(){if(this.scrollTop>0){const t=$(this).closest('.acu-data-card').find('.acu-editable-title').data('row'),e=$(this).hasClass('acu-edit-textarea');if(void 0!==t){a[e?`edit-${t}`:t]=this.scrollTop}}}),be[t]={left:e.scrollLeft(),top:e.scrollTop(),inner:a,timestamp:Date.now()}}},wn=()=>{const{$}=$e();yn(),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active'),Ie(null)},kn=t=>{const{$}=$e(),e=$('#acu-data-area');e.hasClass('visible')?t(e):(t(e),e.addClass('visible'))},$n=t=>{const{$}=$e(),e=$('.acu-wrapper');e.on('click','.acu-dash-relation-graph-btn',function(t){t.stopPropagation();const e=Ca(ie||wa()),a=Rt.findTable(e,'npc');a&&a.data?ua(a.data):window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°äººç‰©æ•°æ®')}),e.on('click','.acu-dash-map-btn',function(t){t.stopPropagation(),la()}),e.on('click','.acu-dash-avatar-manager-btn',function(t){t.stopPropagation();try{let t;try{const e=ie||wa();t=Ca(e)}catch(t){throw console.error('è·å–è¡¨æ ¼æ•°æ®å¤±è´¥:',t),new Error('æ— æ³•è¯»å–è¡¨æ ¼æ•°æ®')}if(!t||0===t.length)return void(window.toastr&&window.toastr.warning('ä»ªè¡¨ç›˜æ•°æ®ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ è¡¨æ ¼æ•°æ®'));const e=Rt.findTable(t,'npc'),a=Rt.findTable(t,'player'),n=[];if(a?.data?.rows?.[0]){const t=a.data.rows[0][1];t&&'string'==typeof t&&t.trim()&&n.push({name:t.trim(),isPlayer:!0})}if(e?.data?.rows&&Array.isArray(e.data.rows)&&e.data.rows.forEach((t,e)=>{if(Array.isArray(t)&&t[1]){const a=t[1];'string'==typeof a&&a.trim()&&n.push({name:a.trim(),isPlayer:!1,rowIndex:e})}}),0===n.length)return void(window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°è§’è‰²æ•°æ®ï¼Œè¯·å…ˆåœ¨ä»ªè¡¨ç›˜ä¸­æ·»åŠ ä¸»è§’æˆ–NPC'));try{pa(n,()=>nn())}catch(t){throw console.error('showAvatarManager æ‰§è¡Œå¤±è´¥:',t),new Error('å¤´åƒç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥')}}catch(t){console.error('å¤´åƒç®¡ç†æŒ‰é’®é”™è¯¯:',t);const e=t instanceof Error?t.message:'æœªçŸ¥é”™è¯¯';window.toastr&&window.toastr.error(`æ‰“å¼€å¤´åƒç®¡ç†å¤±è´¥: ${e}`)}}),e.on('click','.acu-dash-table-link',function(t){t.stopPropagation();const e=$(this).data('table');e&&(Ae.set(h,!1),Ie(e),nn())}),$('.acu-panel-content').off('touchstart.acu_swipe touchmove.acu_swipe').on('touchstart.acu_swipe',function(t){this._touchStartX=t.originalEvent.touches[0].clientX,this._touchStartY=t.originalEvent.touches[0].clientY}).on('touchmove.acu_swipe',function(t){if(!this._touchStartX)return;const e=Math.abs(t.originalEvent.touches[0].clientX-this._touchStartX);e>Math.abs(t.originalEvent.touches[0].clientY-this._touchStartY)&&e>10&&t.stopPropagation()}),$('body').off('click.acu_nav_toggle').on('click.acu_nav_toggle','.acu-nav-toggle-btn',function(t){if(t.stopPropagation(),t.preventDefault(),te)return;const e=je();Te(!e),nn()}),$('body').off('click.acu_opt_toggle').on('click.acu_opt_toggle','.acu-opt-header[data-action="toggle-options"]',function(t){t.stopPropagation(),t.preventDefault();const e=Pe();var a;a=!e,Ae.set(v,a),nn()});const a=$('.acu-panel-content');if(a.length){let t=null;a.off('scroll.acu_save').on('scroll.acu_save',function(){const e=$(this);t&&clearTimeout(t),t=setTimeout(()=>{const t=De();t&&(be[t]||(be[t]={top:0,left:0,inner:{}}),be[t].top=e.scrollTop(),be[t].left=e.scrollLeft())},200)})}$('body').off('click.acu_delegate').on('click.acu_delegate','.acu-wrapper',function(t){if(te)return;const e=$(t.target);if(e.closest('#acu-btn-settings').length)return t.stopPropagation(),t.preventDefault(),void tn();const a=e.closest('.acu-nav-btn');if(a.length){if('acu-btn-dashboard'===a.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const e=Ae.get(h,!1),n=$('#acu-data-area').hasClass('visible');return e&&n?(Ae.set(h,!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(Ae.set(h,!0),Ie(null),$('.acu-nav-btn').removeClass('active'),a.addClass('active'),kn(t=>{const e=ie||wa(),a=Ca(e||{});t.html(mn(a)),$n(a)})),!1}if('acu-btn-changes'===a.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const e=Ae.get('acu_changes_panel_active',!1),n=$('#acu-data-area').hasClass('visible');return e&&n?(Ae.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(Fe(),Ae.set('acu_changes_panel_active',!0),Ie(null),$('.acu-nav-btn').removeClass('active'),a.addClass('active'),kn(t=>{const e=ie||wa();t.html(ln(e)),un()})),!1}if('acu-btn-favorites'===a.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const e=Ae.get('acu_favorites_panel_active',!1),n=$('#acu-data-area').hasClass('visible');return e&&n?(Ae.set('acu_favorites_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(Fe(),Ae.set('acu_favorites_panel_active',!0),$('.acu-nav-btn').removeClass('active'),a.addClass('active'),kn(async t=>{t.html(await vn()),hn(t)})),!1}if('acu-btn-mvu'===a.attr('id')){t.preventDefault(),t.stopImmediatePropagation();const e=De()===vt.MODULE_ID,n=$('#acu-data-area').hasClass('visible');return e&&n?(Ie(null),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(Fe(),Ie(vt.MODULE_ID),$('.acu-nav-btn').removeClass('active'),a.addClass('active'),kn(t=>{try{const e=vt.renderPanel(),a=Oe()[vt.MODULE_ID];a?t.css('height',a+'px').addClass('acu-manual-mode'):t.css('height','').removeClass('acu-manual-mode'),t.html('<div class="acu-mvu-panel">'+e+'</div>'),vt.bindEvents(t)}catch(t){console.error('[MVU] Error rendering panel:',t)}vt.getDataWithRetry(5,800).then(e=>{e&&Se()&&(t.html('<div class="acu-mvu-panel">'+vt.renderPanel()+'</div>'),vt.bindEvents(t))}).catch(e=>{console.error('[DICE]MvuModule Error getting data:',e),Se()&&(t.html('<div class="acu-mvu-panel">'+vt.renderPanel()+'</div>'),vt.bindEvents(t))})})),!1}t.stopPropagation();const e=a.data('table'),n=De();return n===e&&$('#acu-data-area').hasClass('visible')?void wn():(Fe(),$('.acu-nav-btn').removeClass('active'),a.addClass('active'),$('.acu-panel-content').length&&n&&yn(),Ie(e),void setTimeout(()=>nn(),0))}const n=e.closest('.acu-cell');if(n.length)return t.stopPropagation(),void _n(t,n[0]);const o=e.closest('.acu-page-btn');if(o.length){if(t.stopPropagation(),o.hasClass('disabled')||o.hasClass('active'))return;const e=parseInt(o.data('page')),a=De();return void(a&&(ue[a]=e,nn(),requestAnimationFrame(()=>{$('.acu-panel-content').scrollTop(0)})))}}),$('#acu-btn-expand').off('click').on('click',t=>{t.stopPropagation(),te||(Te(!1),nn())}),$('#acu-btn-collapse').off('click').on('click',t=>{t.stopPropagation(),te||(Te(!0),nn())}),$('#acu-btn-refresh').off('click').on('click',async t=>{if(t.stopPropagation(),te)return;if(Qt)return void(window.toastr&&window.toastr.warning('â³ æ­£åœ¨åå°åŒæ­¥æ•°æ®ï¼Œæ— æ³•æ’¤é”€ï¼Œè¯·ç¨å...'));$(t.currentTarget).find('i');ie=null,re=!1,ae.clear(),window.acuModifiedSet&&window.acuModifiedSet.clear();const e=$('#acu-btn-save-global');e.find('i').removeClass('acu-icon-breathe'),e.attr('title','ä¿å­˜æ‰€æœ‰ä¿®æ”¹').css('color','');const a=Ne();a&&(ie=a),$('.acu-edit-overlay, .acu-cell-menu, .acu-menu-backdrop').remove(),nn()}),$('#acu-btn-force-update').off('click').on('click',async t=>{if(t.stopPropagation(),te)return;const e=$e().getDB();if(e&&'function'==typeof e.manualUpdate)try{await e.manualUpdate()}catch(t){console.error('[DICE]ACU æ‰‹åŠ¨æ›´æ–°å¤±è´¥:',t);const e=t.message||'æ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯';window.toastr?window.toastr.error(`æ›´æ–°å¤±è´¥: ${e}`,'é”™è¯¯',{timeOut:5e3}):alert(`æ›´æ–°å¤±è´¥: ${e}`)}else window.toastr&&window.toastr.warning('âš  åç«¯è„šæœ¬æœªæä¾› manualUpdate æ¥å£ï¼Œè¯·ç¡®ä¿åŒæ—¶ä¹Ÿæ›´æ–°äº†æœ€æ–°çš„åç«¯è„šæœ¬','',{timeOut:5e3})}),$('body').off('click.acu_settings').on('click.acu_settings','#acu-btn-settings',function(t){t.stopPropagation(),t.preventDefault(),te||tn()}),$('#acu-btn-dice-nav').off('click').on('click',t=>{t.stopPropagation(),te||oa({targetValue:null,targetName:'è‡ªç”±æ£€å®š'})}),$('#acu-btn-open-editor').off('click').on('click',t=>{if(t.stopPropagation(),te)return;const e=$e().getDB();e&&'function'==typeof e.openSettings?e.openSettings():window.toastr&&window.toastr.warning('åç«¯è„šæœ¬(ç¥Â·æ•°æ®åº“)æœªå°±ç»ªæˆ–ç‰ˆæœ¬è¿‡ä½')}),$('#acu-btn-refill').off('click').on('click',async t=>{if(t.stopPropagation(),te)return;const e=$e().getDB();if(e&&'function'==typeof e.manualUpdate)try{console.log('[DICE]ACU æ‰‹åŠ¨å¡«è¡¨è§¦å‘'),await e.manualUpdate()}catch(t){console.error('[DICE]ACU æ‰‹åŠ¨å¡«è¡¨å¤±è´¥:',t);const e=t.message||'å¡«è¡¨è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯';window.toastr?window.toastr.error(`å¡«è¡¨å¤±è´¥: ${e}`,'é”™è¯¯',{timeOut:5e3}):alert(`å¡«è¡¨å¤±è´¥: ${e}`)}else console.warn('[DICE]ACU manualUpdate API ä¸å¯ç”¨'),window.toastr&&window.toastr.warning('åç«¯è„šæœ¬æœªæä¾› manualUpdate æ¥å£','',{timeOut:3e3})}),$('#acu-btn-save-global').off('click').on('click',async function(t){if(t.stopPropagation(),te)return;let e=null;if(e=re&&ie?ie:wa(),e){await ka(e,!0,!0),$('.acu-highlight-manual').removeClass('acu-highlight-manual'),window.acuModifiedSet&&window.acuModifiedSet.clear(),re=!1;const t=$(this);t.find('i').removeClass('acu-icon-breathe fa-spinner fa-spin').addClass('fa-save'),t.attr('title','ä¿å­˜æ‰€æœ‰ä¿®æ”¹').css('color',''),t.prop('disabled',!1)}else window.toastr&&window.toastr.error('æ— æ³•è·å–æœ‰æ•ˆæ•°æ®ï¼Œä¿å­˜å¤±è´¥')});const o=$('.acu-search-input');if(o.length){let t,e=!1;o.off('compositionstart compositionend input').on('compositionstart',()=>{e=!0}).on('compositionend',function(){e=!1;const t=$(this).val(),a=De();a&&(de[a]=t,ue[a]=1,nn(),setTimeout(()=>{$('.acu-search-input').focus()},0))}).on('input',function(){if(e)return;const a=$(this).val(),n=this.selectionStart,o=this.selectionEnd;clearTimeout(t),t=setTimeout(()=>{const t=De();if(t){de[t]=a,ue[t]=1;const e=document.activeElement&&document.activeElement.classList.contains('acu-search-input');if(nn(),e){const t=$('.acu-search-input');if(t.focus(),t.length&&t[0].setSelectionRange)try{t[0].setSelectionRange(n,o)}catch(t){}}}},300)})}$('#acu-btn-relation-graph').off('click').on('click',function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data('table'),a=ie||wa();if(a)for(const t in a){const n=a[t];if(n?.name===e){const e={headers:n.content?.[0]||[],rows:n.content?.slice(1)||[],key:t};return void ua(e)}}window.toastr&&window.toastr.warning('æ— æ³•è·å–è¡¨æ ¼æ•°æ®')}),$('.acu-table-map-btn').off('click').on('click',function(t){t.preventDefault(),t.stopPropagation(),la()}),$('#acu-btn-switch-style').off('click').on('click',function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data('table'),a=Le(),n=a[e]||'list';var o;a[e]='grid'===n?'list':'grid',o=a,Ae.set(y,o),nn()}),$('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(t){if(0!==t.button)return;t.preventDefault(),t.stopPropagation();const e=this;e.setPointerCapture(t.pointerId),$(e).addClass('active');const a=$('#acu-data-area'),n=a.height(),o=t.clientY,i=$(e).data('table');e.onpointermove=function(t){const e=t.clientY-o;let i=n-e;i<C&&(i=C),i>E&&(i=E),a.css('height',i+'px')},e.onpointerup=function(t){if($(e).removeClass('active'),e.releasePointerCapture(t.pointerId),e.onpointermove=null,e.onpointerup=null,i){const t=Oe();t[i]=parseInt(a.css('height')),Be(t),a.addClass('acu-manual-mode')}}}),$('.acu-height-drag-handle').off('dblclick').on('dblclick',function(t){t.preventDefault(),t.stopPropagation();const e=$(this).data('table');if(e){const t=Oe();delete t[e],Be(t),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),e.on('click','.acu-reverse-btn',function(t){t.stopPropagation();const e=$(this).data('table');e&&(qe(e),nn())}),$('.acu-panel-header').off('dblclick.acu').on('dblclick.acu',function(t){if($(t.target).closest('.acu-search-input, .acu-close-btn, .acu-view-btn').length)return;t.preventDefault(),t.stopPropagation();const e=De();if(e){const t=Oe();delete t[e],Be(t),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),e.find('.acu-close-btn').off('click').on('click',function(t){t.stopPropagation();const e=$('.acu-search-input');if(e.length&&e.val())return void e.val('').trigger('input').focus();if(Ae.get(h,!1))return Ae.set(h,!1),Ie(null),void nn();if(De()===vt.MODULE_ID)return Ie(null),void nn();wn()}),$('body').off('click.acu_bookmark').on('click.acu_bookmark','.acu-bookmark-icon',function(t){t.stopPropagation(),t.preventDefault();const e=$(this),a=e.data('table'),n=e.data('row-key');a&&n&&(i.toggleBookmark(a,n),'function'==typeof nn&&nn())}),$('body').off('click.acu_action').on('click.acu_action','.acu-action-item',function(t){t.stopPropagation(),t.preventDefault();const e=$(this),a=parseInt(e.data('row'),10),n=parseInt(e.data('action-idx'),10),o=e.closest('.acu-data-card').find('.acu-editable-title'),i=o.data('key'),s=o.data('tname')||'',u=ie||wa();if(!u||!u[i])return;const d=u[i].content[0]||[],p=u[i].content[a+1]||[],g=Vt(s,d,p)[n];if(g&&'skill_check'===g.type){const t=p[1]||'æŠ€èƒ½';let e=null;const a=d.findIndex(t=>t&&t.includes('å±æ€§å€¼')),n=d.findIndex(t=>t&&(t.includes('ç†Ÿç»ƒ')||t.includes('ç­‰çº§')));if(a>0&&p[a]){const t=Yt(p[a]);t>0&&(e=t)}if(null===e&&n>0&&p[n]){const t=Yt(p[n]);t>0&&(e=t)}const o=Ht(g.template,p,d);return l(o,'action'),void(null!==e&&e>0?oa({targetValue:e,targetName:t,initiatorName:'<user>'}):$('#send_textarea').focus())}if(g&&g.template){const t=ie||wa();if(t&&t[i]){const e=t[i].content[0]||[],n=t[i].content[a+1]||[],o=n[1]||'å¯¹æ–¹';if('äº¤è°ˆ'===g.label){ma();$('.acu-msg-overlay').remove();const t=$(`\n                        <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:31200;display:flex;justify-content:center;align-items:center;">\n                            <div style="background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                                <div style="font-size:14px;font-weight:bold;color:var(--acu-accent);margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                                    <i class="fa-solid fa-comment"></i> å‘é€æ¶ˆæ¯ç»™ ${r(o)}\n                                </div>\n                                <input type="text" id="acu-msg-input" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..." style="width:100%;padding:10px 12px;background:var(--acu-input-bg) !important;border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main) !important;font-size:14px;box-sizing:border-box;" autofocus>\n                                <div style="display:flex;gap:8px;margin-top:12px;">\n                                    <button id="acu-msg-cancel" style="flex:1;padding:8px;background:var(--acu-input-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);cursor:pointer;">å–æ¶ˆ</button>\n                                    <button id="acu-msg-send" style="flex:1;padding:8px;background:var(--acu-btn-active-bg);border:none;border-radius:6px;color:var(--acu-btn-active-text);cursor:pointer;font-weight:bold;">å‘é€</button>\n                                </div>\n                            </div>\n                        </div>\n                    `);$('body').append(t);const e=t[0];e.style.setProperty('position','fixed','important'),e.style.setProperty('top','0','important'),e.style.setProperty('left','0','important'),e.style.setProperty('right','0','important'),e.style.setProperty('bottom','0','important'),e.style.setProperty('width','100vw','important'),e.style.setProperty('height','100vh','important'),e.style.setProperty('display','flex','important'),e.style.setProperty('justify-content','center','important'),e.style.setProperty('align-items','center','important'),e.style.setProperty('z-index','31100','important'),setTimeout(()=>t.find('#acu-msg-input').focus(),50);const a=()=>{const e=t.find('#acu-msg-input').val().trim();if(e){l(`<user>å¯¹${o}è¯´ï¼š"${e}"`,'action'),$('#send_textarea').focus()}t.remove()};return t.find('#acu-msg-send').click(a),t.find('#acu-msg-input').on('keydown',function(t){'Enter'===t.key&&(t.preventDefault(),a())}),t.find('#acu-msg-cancel').click(()=>t.remove()),void c(t,'acu-msg-overlay',()=>t.remove())}const s=Ht(g.template,n,e);l(s,'action'),$('#send_textarea').focus()}}}),$('body').off('click.acu_global_dice').on('click.acu_global_dice','#acu-btn-dice',function(t){t.stopPropagation(),oa({targetValue:50,targetName:'è‡ªå®šä¹‰æ£€å®š',diceType:'1d100'})}),$('body').off('click.acu_location_toggle').on('click.acu_location_toggle','.acu-location-header',function(t){t.stopPropagation();$(this).closest('.acu-location-group').toggleClass('expanded')}),$('body').off('click.acu_dash_jump').on('click.acu_dash_jump','.acu-dash-jump-link, .acu-dash-loc-item',function(t){t.stopPropagation();const e=$(this).data('table'),a=$(this).data('search')||'';e&&(Ae.set(h,!1),Ie(e),a&&(de[e]=a,ue[e]=1),nn(),a&&setTimeout(()=>{const t=$('.acu-search-input');t.length&&t.focus()},100))}),$('body').off('click.acu_inline_dice').on('click.acu_inline_dice','.acu-inline-dice-btn',function(t){t.stopPropagation(),t.preventDefault();const e=$(this).attr('data-attr-name')||'å±æ€§',a=parseInt($(this).attr('data-attr-value'),10)||50,n=$(this).closest('.acu-data-card'),o=n.find('.acu-editable-title').text().trim(),i=(n.find('.acu-editable-title').data('tname')||'').includes('ä¸»è§’');oa({attrValue:a,targetValue:null,targetName:e,initiatorName:i?'<user>':o})}),$('body').off('click.acu_dash_dice').on('click.acu_dash_dice','.acu-dash-dice-btn',function(t){t.stopPropagation(),t.preventDefault();const e=parseInt($(this).data('target'),10)||50,a=$(this).data('name')||'å±æ€§',n=$(this).data('npc')||'';if(n){const t=Je('<user>',a)||50;ia({initiatorName:'<user>',initiatorValue:t,opponentName:n,opponentValue:e})}else oa({targetValue:e,targetName:a,initiatorName:'<user>'})}),$('body').off('click.acu_dash_goto').on('click.acu_dash_goto','.acu-dash-goto-btn',function(t){t.stopPropagation(),t.preventDefault();const e=$(this).data('location')||'æœªçŸ¥åœ°ç‚¹';l(`<user>å‰å¾€${e}ã€‚`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_item').on('click.acu_dash_use_item','.acu-dash-use-item-btn',function(t){t.stopPropagation(),t.preventDefault();const e=$(this).data('item')||'ç‰©å“';l(`<user>ä½¿ç”¨${e}ã€‚`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_skill').on('click.acu_dash_use_skill','.acu-dash-use-skill-btn',function(t){t.stopPropagation(),t.preventDefault();const e=$(this).data('skill')||'æŠ€èƒ½',a=ie||wa();let n=null;if(a)for(const t in a){const o=a[t];if(o&&o.name&&o.content&&(o.name.includes('æŠ€èƒ½')||o.name.includes('èƒ½åŠ›'))){const t=o.content[0]||[],a=t.findIndex(t=>t&&(t.includes('åç§°')||t.includes('æŠ€èƒ½å')))||1,i=t.findIndex(t=>t&&t.includes('å±æ€§å€¼')),r=t.findIndex(t=>t&&(t.includes('ç†Ÿç»ƒ')||t.includes('ç­‰çº§')));for(let t=1;t<o.content.length;t++){const c=o.content[t];if(c&&c[-1===a?1:a]===e){if(i>0&&c[i]){const t=Yt(c[i]);if(t>0){n=t;break}}if(r>0&&c[r]){const t=Yt(c[r]);if(t>0){n=t;break}}break}}if(null!==n)break}}l(`<user>ä½¿ç”¨${e}ã€‚`,'action'),null!==n&&n>0?oa({targetValue:n,targetName:e,initiatorName:'<user>'}):$('#send_textarea').focus()}),$('body').off('click.acu_dash_track_task').on('click.acu_dash_track_task','.acu-dash-track-task-btn',function(t){t.stopPropagation(),t.preventDefault();const e=$(this).data('task')||'ä»»åŠ¡';l(`<user>å°†${e}è®¾ä¸ºå½“å‰è¿½è¸ªç›®æ ‡ã€‚`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_msg').on('click.acu_dash_msg','.acu-dash-msg-btn',function(t){t.stopPropagation(),t.preventDefault();const e=$(this).data('npc')||'å¯¹æ–¹';ma();$('.acu-msg-overlay').remove();const a=$(`\n            <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:31200;display:flex;justify-content:center;align-items:center;">\n                <div class="acu-msg-dialog" style="background:var(--acu-bg-panel);border:1px solid var(--acu-border);border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                    <div style="font-size:14px;font-weight:bold;color:var(--acu-accent);margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                        <i class="fa-solid fa-comment"></i> å‘é€æ¶ˆæ¯ç»™ ${r(e)}\n                    </div>\n                    <input type="text" id="acu-msg-input" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..." style="width:100%;padding:10px 12px;background:var(--acu-input-bg) !important;border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main) !important;font-size:14px;box-sizing:border-box;" autofocus>\n                    <div style="display:flex;gap:8px;margin-top:12px;">\n                        <button id="acu-msg-cancel" style="flex:1;padding:8px;background:var(--acu-input-bg);border:1px solid var(--acu-border);border-radius:6px;color:var(--acu-text-main);cursor:pointer;">å–æ¶ˆ</button>\n                        <button id="acu-msg-send" style="flex:1;padding:8px;background:var(--acu-btn-active-bg);border:none;border-radius:6px;color:var(--acu-btn-active-text);cursor:pointer;font-weight:bold;">å‘é€</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(a);const n=a[0];n.style.setProperty('position','fixed','important'),n.style.setProperty('top','0','important'),n.style.setProperty('left','0','important'),n.style.setProperty('right','0','important'),n.style.setProperty('bottom','0','important'),n.style.setProperty('width','100vw','important'),n.style.setProperty('height','100vh','important'),n.style.setProperty('display','flex','important'),n.style.setProperty('justify-content','center','important'),n.style.setProperty('align-items','center','important'),n.style.setProperty('z-index','31100','important'),setTimeout(()=>a.find('#acu-msg-input').focus(),50);const o=()=>{const t=a.find('#acu-msg-input').val().trim();if(t){l(`<user>å¯¹${e}è¯´ï¼š"${t}"`,'action'),$('#send_textarea').focus()}a.remove()};a.find('#acu-msg-send').click(o),a.find('#acu-msg-input').on('keydown',function(t){'Enter'===t.key&&(t.preventDefault(),o())}),a.find('#acu-msg-cancel').click(()=>a.remove()),c(a,'acu-msg-overlay',()=>a.remove())}),$('body').off('click.acu_dash_contest').on('click.acu_dash_contest','.acu-dash-contest-btn',function(t){t.stopPropagation(),t.preventDefault();const e=$(this).data('npc')||'',a=ie||wa();var n=50,o=50;if(a)for(var i in a){var r=a[i];if(r&&r.name&&r.content){if('ä¸»è§’ä¿¡æ¯'===r.name&&r.content[1])for(var c=(r.content[1][7]||'').split(/[,ï¼Œ;ï¼›\s]+/),s=0;s<c.length;s++){var l=c[s].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\sï¼š]\s*(\d+)/);if(l){n=parseInt(l[2],10);break}}if('é‡è¦äººç‰©è¡¨'===r.name&&e)for(var u=1;u<r.content.length;u++){var d=r.content[u];if(d&&d[1]===e){for(var p=(d[9]||'').split(/[,ï¼Œ;ï¼›\s]+/),g=0;g<p.length;g++){var f=p[g].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\sï¼š]\s*(\d+)/);if(f){o=parseInt(f[2],10);break}}break}}}}ia({initiatorName:'<user>',initiatorValue:n,opponentName:e,opponentValue:o,diceType:'1d100'})}),$('body').off('click.acu_preview_cell_menu').on('click.acu_preview_cell_menu','.acu-preview-overlay .acu-cell',function(t){if(console.log('[DICE] preview cell click triggered',this,$(this).data()),$(t.target).closest('.acu-preview-close').length)return;const e=$(this),a=$('.acu-cell-menu');if(a.length){if(a.data('cell-id')===`${e.data('key')}-${e.data('row')}-${e.data('col')}`)return void $('.acu-cell-menu, .acu-menu-backdrop').remove()}t.stopPropagation(),t.preventDefault(),_n(t,this);const n=`${e.data('key')}-${e.data('row')}-${e.data('col')}`;$('.acu-cell-menu').data('cell-id',n)}),$('body').off('click.acu_dash_preview').on('click.acu_dash_preview','.acu-dash-preview-trigger',function(t){t.stopPropagation();const e=$(this).data('table-key'),a=parseInt($(this).data('row-index'),10);if(!e||isNaN(a))return;const o=ie||wa();if(!o||!o[e])return;const i=o[e],s=i.name||'è¯¦æƒ…',l=i.content[0]||[],u=i.content[a+1];if(!u)return;const d=ma(),p=u[1]||'æœªå‘½å',g=a;let f='';u.forEach((t,a)=>{if(a<=0||1===a)return;if((l[a]||'').includes('äº¤äº’'))return;const o=l[a]||'å±æ€§'+a,i=String(t||'').trim();if(!i)return;const c=n.getRowKey(s,u,l),d=c&&n.isFieldLocked(s,c,o)?'<i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:10px;opacity:0.7;margin-left:4px;" title="å·²é”å®š"></i>':'';let p='',b=!1;const m=Jt(i);if(Xt(i,o)){const t=Wt(i);if(t.length>1){b=!0;let e='';t.forEach((a,n)=>{const o=n<t.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';e+=`<div style="display:flex;justify-content:flex-start;align-items:center;gap:8px;padding:3px 0;${o}">\n                              <span style="color:var(--acu-text-sub);font-size:0.95em;">${r(a.name)}${d}</span>\n                              ${a.relation?`<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${r(a.relation)}</span>`:''}\n                          </div>`}),p=`<div class="acu-relation-container">${e}</div>`}else if(1===t.length&&t[0].relation){b=!0;const e=t[0];p=`<div style="display:flex;justify-content:flex-start;align-items:center;gap:8px;">\n                          <span style="color:var(--acu-text-sub);">${r(e.name)}${d}</span>\n                          <span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${r(e.relation)}</span>\n                      </div>`}}else if(m.length>1){b=!0;let t='';m.forEach((e,a)=>{const n=!Q.isBlacklisted(e.name),o=a<m.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';t+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;${o}">\n                          <span style="color:var(--acu-text-sub);font-size:0.95em;">${r(e.name)}${d}</span>\n                          <div style="display:flex;align-items:center;gap:6px;">\n                              <span style="color:var(--acu-text-main);font-weight:bold;">${e.value}</span>\n                              ${n?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${r(e.name)}" data-attr-value="${e.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>`:''}\n                          </div></div>`}),p=`<div class="acu-multi-attr-container">${t}</div>`}else if(1===m.length){b=!0;const t=m[0],e=!Q.isBlacklisted(t.name);p=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                      <span style="color:var(--acu-text-sub);font-size:0.95em;">${r(t.name)}${d}</span>\n                      <div style="display:flex;align-items:center;gap:6px;">\n                          <span style="color:var(--acu-text-main);font-weight:bold;">${t.value}</span>\n                          ${e?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${r(t.name)}" data-attr-value="${t.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>`:''}\n                      </div></div>`}else if(!qt(i)||i.includes(':')||i.includes('ï¼š')){const t=Ee(i);p=t?`<span class="acu-badge ${t}">${r(i)}</span>`:r(i)}else{const t=Yt(i),e=!Q.isBlacklisted(o);p=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                      <span>${r(i)}</span>\n                      ${e?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${r(o)}" data-attr-value="${t}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;margin-left:6px;" title="æ£€å®š"></i>`:''}\n                  </div>`}f+=`<div class="${'acu-card-row acu-cell'+(b?' acu-hide-label':'')}" data-key="${r(e)}" data-tname="${r(s)}" data-row="${g}" data-col="${a}" data-val="${encodeURIComponent(t??'')}">\n                <div class="acu-card-label">${r(o)}</div>\n                <div class="acu-card-value">${p}</div>\n            </div>`});const b=Vt(s,l,u);let m='';if(b.length>0){m=`<div class="acu-card-actions">${b.map((t,e)=>`<button class="acu-action-item ${'check'===t.type?'check-type':''}" data-action-idx="${e}" data-row="${g}"><i class="fa-solid ${t.icon||'fa-play'}"></i> ${r(t.label)}</button>`).join('')}</div>`}const v=`\n            <div class="acu-preview-overlay acu-theme-${d.theme}" style="--acu-card-width:${d.cardWidth}px;--acu-font-size:${d.fontSize}px;">\n                <div class="acu-data-card" style="width:90vw;max-width:420px;max-height:85vh;overflow-y:auto;">\n                    <div class="acu-card-header">\n                        <span class="acu-card-index">#${g+1}</span>\n                        <span class="acu-cell acu-editable-title" data-key="${r(e)}" data-tname="${r(s)}" data-row="${g}" data-col="1" data-val="${encodeURIComponent(p)}">${r(p)}</span>\n                        <button class="acu-preview-close" style="margin-left:auto;background:none;border:none;color:var(--acu-text-sub);cursor:pointer;font-size:16px;padding:4px;"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-card-body view-list">${f}</div>\n                    ${m}\n                </div>\n            </div>\n        `;$('.acu-preview-overlay').remove(),$('body').append(v);const h=$('.acu-preview-overlay')[0];h&&(h.style.setProperty('position','fixed','important'),h.style.setProperty('top','0','important'),h.style.setProperty('left','0','important'),h.style.setProperty('right','0','important'),h.style.setProperty('bottom','0','important'),h.style.setProperty('width','100vw','important'),h.style.setProperty('height','100vh','important'),h.style.setProperty('display','flex','important'),h.style.setProperty('justify-content','center','important'),h.style.setProperty('align-items','center','important'),h.style.setProperty('z-index','31100','important'));const x=$('.acu-preview-overlay');c(x,'acu-preview-overlay',()=>x.remove()),x.on('click',function(t){$(t.target).closest('.acu-preview-close').length&&$(this).remove()})}),function(){const t=$(document);let e=0,a=0;t.on('touchstart.acuSwipeFix','#acu-data-area',function(t){1===t.originalEvent.touches.length&&(e=t.originalEvent.touches[0].clientX,a=t.originalEvent.touches[0].clientY)}),t.on('touchmove.acuSwipeFix','#acu-data-area',function(t){if(1!==t.originalEvent.touches.length)return;const n=t.originalEvent.touches[0],o=Math.abs(n.clientX-e);o>1.5*Math.abs(n.clientY-a)&&o>10&&(t.stopPropagation(),console.log('[DICE]ACU é˜»æ­¢æ°´å¹³æ»‘åŠ¨å†’æ³¡ï¼Œé˜²æ­¢ ST swipe'))})}()};const _n=(t,e)=>{const{$}=$e();$('.acu-cell-menu, .acu-menu-backdrop').remove();const a=$('<div class="acu-menu-backdrop"></div>');$('body').append(a);const o=parseInt($(e).data('row'),10),i=parseInt($(e).data('col'),10);if(isNaN(o)||isNaN(i))return console.warn('[DICE]ACU æ— æ•ˆçš„è¡Œ/åˆ—ç´¢å¼•'),void a.remove();const c=$(e).data('key'),s=$(e).data('tname')||$(e).closest('.acu-data-card').find('.acu-editable-title').text(),l=decodeURIComponent($(e).data('val')),u=ma(),d=`${c}-${o}-${i}`;window.acuModifiedSet||(window.acuModifiedSet=new Set);const p=window.acuModifiedSet.has(d),g=ie?.[c]?.content?.[0]||[],f=ie?.[c]?.content?.[o+1]||[],b=n.getRowKey(s,f,g),m=g[i]||'',v=b&&n.isFieldLocked(s,b,m),h=b&&n.hasAnyLock(s,b);let x='';b&&(x='<div style="border-top:1px dashed var(--acu-border); margin:4px 0;"></div>',x+=v?'<div class="acu-cell-menu-item" id="act-unlock-field" style="color:#27ae60;"><i class="fa-solid fa-unlock"></i> è§£é”æ­¤å•å…ƒæ ¼</div>':'<div class="acu-cell-menu-item" id="act-lock-field" style="color:#f39c12;"><i class="fa-solid fa-lock"></i> é”å®šæ­¤å•å…ƒæ ¼</div>',x+=h?'<div class="acu-cell-menu-item" id="act-unlock-row" style="color:#27ae60;"><i class="fa-solid fa-unlock"></i> è§£é”æ•´è¡Œ</div>':'<div class="acu-cell-menu-item" id="act-lock-row" style="color:#f39c12;"><i class="fa-solid fa-lock"></i> é”å®šæ•´è¡Œ</div>');const y=$(`\n            <div class="acu-cell-menu acu-theme-${u.theme}">\n                <div class="acu-cell-menu-item" id="act-edit"><i class="fa-solid fa-pen"></i> ç¼–è¾‘å†…å®¹</div>\n                <div class="acu-cell-menu-item" id="act-edit-card" style="color:#9b59b6"><i class="fa-solid fa-edit"></i> æ•´ä½“ç¼–è¾‘</div>\n                <div class="acu-cell-menu-item" id="act-insert" style="color:#2980b9"><i class="fa-solid fa-plus"></i> åœ¨ä¸‹æ–¹æ’å…¥æ–°è¡Œ</div>\n                <div class="acu-cell-menu-item" id="act-copy"><i class="fa-solid fa-copy"></i> å¤åˆ¶å†…å®¹</div>\n                <div class="acu-cell-menu-item" id="act-favorite" style="color:#f1c40f"><i class="fa-solid fa-star"></i> æ”¶è—æ­¤è¡Œ</div>\n                ${x}\n                ${p?'<div class="acu-cell-menu-item" id="act-undo" style="color:#e67e22; border-top:1px solid #eee;"><i class="fa-solid fa-undo"></i> æ’¤é”€æœ¬æ¬¡ä¿®æ”¹</div>':''}\n                <div class="acu-cell-menu-item" id="act-delete" style="color:#e74c3c"><i class="fa-solid fa-trash"></i> åˆ é™¤æ•´è¡Œ</div>\n                <div class="acu-cell-menu-item" id="act-close"><i class="fa-solid fa-times"></i> å…³é—­èœå•</div>\n            </div>\n        `);$('body').append(y);const w=$(window).width(),k=$(window).height(),C=y.outerWidth()||150,E=y.outerHeight()||150;let A=t.clientX,D=t.clientY;!A&&t.originalEvent&&t.originalEvent.touches&&t.originalEvent.touches.length?(A=t.originalEvent.touches[0].clientX,D=t.originalEvent.touches[0].clientY):!A&&t.changedTouches&&t.changedTouches.length&&(A=t.changedTouches[0].clientX,D=t.changedTouches[0].clientY),void 0===A&&(A=w/2),void 0===D&&(D=k/2);let I=A+5,F=D+5;I+C>w&&(I=A-C-5),F+E>k&&(F=D-E-5),I<5&&(I=5),F<5&&(F=5),y.css({top:F+'px',left:I+'px'});const S=()=>{y.remove(),a.remove()};a.on('click',S),y.find('#act-close').click(S),y.find('#act-lock-field').click(()=>{b&&m&&(n.lockField(s,b,m,l),nn()),S()}),y.find('#act-unlock-field').click(()=>{b&&m&&(n.unlockField(s,b,m),nn()),S()}),y.find('#act-lock-row').click(()=>{b&&(n.lockRow(s,b,f,g),nn()),S()}),y.find('#act-unlock-row').click(()=>{b&&(n.unlockRow(s,b),nn()),S()}),y.find('#act-copy').click(async t=>{if(t.stopPropagation(),window.TavernHelper&&window.TavernHelper.triggerSlash)try{const t=l.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\{/g,'\\{').replace(/\}/g,'\\}');return await window.TavernHelper.triggerSlash(`/clipboard-set "${t}"`),void S()}catch(t){console.warn('[DICE]ACU é…’é¦†æ¥å£å¤åˆ¶å¤±è´¥ï¼Œå°è¯•æµè§ˆå™¨åŸç”Ÿæ–¹æ³•',t)}const e=t=>{try{const e=document.createElement('textarea');e.value=t,e.style.position='fixed',e.style.left='-9999px',e.style.top='0',e.setAttribute('readonly',''),document.body.appendChild(e),e.select(),e.setSelectionRange(0,99999);const a=document.execCommand('copy');if(document.body.removeChild(e),!a)throw new Error('execCommand failed')}catch(e){console.error('[DICE]ACU å¤åˆ¶å¤±è´¥:',e),prompt('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰ä¸‹æ–¹æ–‡æœ¬æ‰‹åŠ¨å¤åˆ¶:',t)}};var a;a=l,navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(a).then(()=>{}).catch(()=>{e(a)}):e(a),S()}),y.find('#act-favorite').click(async()=>{try{const t=ie?.[c];if(!t||!t.content)return toastr.error('æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),void S();const e=(t.content[0]||[]).slice(1).map(t=>String(t||'')),a=(t.content[o+1]||[]).slice(1);if(0===e.length||0===a.length)return toastr.error('è¡Œæ•°æ®ä¸ºç©º'),void S();const n=prompt('è¯·è¾“å…¥æ ‡ç­¾ï¼ˆå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºåˆ™æ— æ ‡ç­¾ï¼‰ï¼š',''),i=n?n.split(',').map(t=>t.trim()).filter(t=>t.length>0):[];await lt.addFavorite(c,s,e,a,i)?toastr.success('æ”¶è—æˆåŠŸ'):toastr.error('æ”¶è—å¤±è´¥')}catch(t){console.error('[DICE]æ”¶è—å¤±è´¥:',t),toastr.error('æ”¶è—å¤±è´¥: '+(t instanceof Error?t.message:String(t)))}S()}),y.find('#act-undo').click(()=>{const t=Ne();let a=null;if(t&&t[c]?.content[o+1]&&(a=t[c].content[o+1][i]),null!==a){ie||(ie=wa()),ie&&ie[c]?.content[o+1]&&(ie[c].content[o+1][i]=a);const t=$(e);t.attr('data-val',encodeURIComponent(a)),t.data('val',encodeURIComponent(a));let n=t;t.find('.acu-card-value').length>0?n=t.find('.acu-card-value'):t.hasClass('acu-grid-item')?n=t.find('.acu-grid-value'):t.hasClass('acu-full-item')&&(n=t.find('.acu-full-value'));const r=Ee(a);r&&!t.hasClass('acu-editable-title')?n.html(`<span class="acu-badge ${r}">${a}</span>`):n.text(a),n.removeClass('acu-highlight-manual acu-highlight-diff'),t.hasClass('acu-editable-title')&&t.removeClass('acu-highlight-manual acu-highlight-diff'),window.acuModifiedSet.delete(d),0===window.acuModifiedSet.size&&(re=!1,_e())}else window.toastr&&window.toastr.warning('æ— æ³•æ‰¾åˆ°åŸå§‹æ•°æ®ï¼Œæ’¤é”€å¤±è´¥');S()}),y.find('#act-delete').click(async()=>{const t=$('.acu-panel-content'),a=t.length?t.scrollTop():0,n=t.length?t.scrollLeft():0;S();const i=$('.acu-map-overlay'),r=i.length>0;$('.acu-preview-overlay').remove(),r&&(i.find(`.acu-map-element-chip[data-table-key="${c}"][data-row-index="${o}"]`).remove(),i.find(`.acu-map-thumbnail[data-table-key="${c}"][data-row-index="${o}"]`).remove());const s=$(e).closest('.acu-data-card');if(s.length&&!r&&(s.css('transition','all 0.2s ease').css('opacity','0').css('transform','scale(0.9)'),setTimeout(()=>s.slideUp(200,()=>s.remove()),200)),ie||(ie=wa()||Ne()),ie&&ie[c]?.content){ie[c].content.splice(o+1,1);try{if(await $a(ie),ae=ha(ie),nn(),r){const t=i.data('refreshMapData');'function'==typeof t&&await t()}setTimeout(()=>{const t=$('.acu-panel-content');t.length&&(a>0||n>0)&&(t.scrollTop(a),t.scrollLeft(n))},60)}catch(t){console.error('[DICE]ACU åˆ é™¤ä¿å­˜å¤±è´¥:',t),toastr.error('åˆ é™¤ä¿å­˜å¤±è´¥: '+(t instanceof Error?t.message:String(t))),nn(),setTimeout(()=>{const t=$('.acu-panel-content');t.length&&(a>0||n>0)&&(t.scrollTop(a),t.scrollLeft(n))},60)}}}),y.find('#act-insert').click(async()=>{if(S(),ie||(ie=wa()),ie||(ie=Ne()),ie&&ie[c]?.content){const t=ie[c],e=t.content[0]?t.content[0].length:2,a=new Array(e).fill('');e>0&&(a[0]=String(t.content.length)),t.content.splice(o+2,0,a),await ka(ie,!1,!0),nn(),setTimeout(()=>{const t=$('.acu-panel-content');t.length&&t[0].scrollHeight>t.height()&&t.scrollTop(t.scrollTop()+10)},100)}}),y.find('#act-edit-card').click(()=>{S();const t=ie||wa();if(t&&t[c]){const e=t[c].content[0],a=t[c].content[o+1];a&&fa(a,e,s,o,c)}}),y.find('#act-edit').click(()=>{S(),Cn(l,async t=>{if(ie||(ie=wa()||Ne()),!ie||!ie[c]?.content[o+1])return void alert('æ•°æ®ç»“æ„å¼‚å¸¸ï¼Œæ— æ³•å†™å…¥ç¼“å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢');ie[c].content[o+1][i]=t;const a=$(e);a.attr('data-val',encodeURIComponent(t)).data('val',encodeURIComponent(t));let n=a;a.find('.acu-card-value').length?n=a.find('.acu-card-value'):a.hasClass('acu-grid-item')?n=a.find('.acu-grid-value'):a.hasClass('acu-editable-title')&&(n=a);const s=Ee(t);s&&!a.hasClass('acu-editable-title')?n.html(`<span class="acu-badge ${s}">${r(t)}</span>`):n.text(t),n.removeClass('acu-highlight-manual acu-highlight-diff'),a.hasClass('acu-editable-title')&&a.removeClass('acu-highlight-manual acu-highlight-diff');try{const t=ie[c].content[o+1];await _a(c,o,[...t])}catch(t){console.error('[DICE]ACU å•å…ƒæ ¼ä¿å­˜å¤±è´¥:',t),toastr.error('ä¿å­˜å¤±è´¥: '+(t instanceof Error?t.message:String(t)))}})})},Cn=(t,e)=>{const{$}=$e(),a=ma(),n=$(`\n            <div class="acu-edit-overlay">\n                \x3c!-- 2. [ä¿®æ”¹] åœ¨è¿™é‡ŒåŠ ä¸Š acu-theme-${a.theme} --\x3e\n                <div class="acu-edit-dialog acu-theme-${a.theme}">\n                    <div class="acu-edit-title">ç¼–è¾‘å•å…ƒæ ¼å†…å®¹</div>\n                    <textarea class="acu-edit-textarea" spellcheck="false">${r(t)}</textarea>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(n);n.find('textarea').on('input',function(){var t;(t=this).style.height='auto',t.style.height=t.scrollHeight+2+'px'}),n.find('#dlg-cancel').click(()=>n.remove()),c(n,'acu-edit-overlay',()=>n.remove()),n.find('#dlg-save').click(()=>{e(n.find('textarea').val()),n.remove()})},En=()=>{const{$}=$e();if(!$)return;$('.dice-conflict-dialog-overlay').remove();$('body').append('\n      <div class="dice-conflict-dialog-overlay" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0, 0, 0, 0.75);\n        backdrop-filter: blur(4px);\n        z-index: 31200;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 20px;\n        box-sizing: border-box;\n      ">\n        <div class="dice-conflict-dialog" style="\n          background: #fff;\n          border-radius: 16px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n          max-width: 500px;\n          width: 100%;\n          padding: 30px;\n          box-sizing: border-box;\n          animation: diceDialogPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n        ">\n          <div style="\n            text-align: center;\n            margin-bottom: 20px;\n          ">\n            <div style="\n              font-size: 48px;\n              color: #e74c3c;\n              margin-bottom: 15px;\n            ">âš ï¸</div>\n            <h2 style="\n              font-size: 24px;\n              font-weight: bold;\n              color: #333;\n              margin: 0 0 10px 0;\n            ">è„šæœ¬å†²çªæ£€æµ‹</h2>\n            <p style="\n              font-size: 16px;\n              color: #666;\n              line-height: 1.6;\n              margin: 0;\n            ">æ£€æµ‹åˆ°"å¯è§†åŒ–è¡¨æ ¼"è„šæœ¬æ­£åœ¨è¿è¡Œ</p>\n          </div>\n          <div style="\n            background: #fff3cd;\n            border: 1px solid #ffc107;\n            border-radius: 8px;\n            padding: 15px;\n            margin-bottom: 20px;\n          ">\n            <p style="\n              font-size: 14px;\n              color: #856404;\n              line-height: 1.6;\n              margin: 0;\n            ">\n              <strong>æç¤ºï¼š</strong>éª°å­ç³»ç»Ÿä¸å¯è§†åŒ–è¡¨æ ¼è„šæœ¬åŠŸèƒ½å†²çªï¼Œä¸èƒ½åŒæ—¶å¯ç”¨ã€‚<br>\n              è¯·åœ¨é…’é¦†åŠ©æ‰‹çš„è„šæœ¬ç®¡ç†ä¸­ï¼Œ<strong>å…³é—­å…¶ä¸­ä¸€ä¸ªè„šæœ¬ååˆ·æ–°é…’é¦†é¡µé¢</strong>ã€‚\n            </p>\n          </div>\n          <div style="\n            display: flex;\n            gap: 10px;\n            justify-content: center;\n            flex-wrap: wrap;\n          ">\n            <button id="dice-conflict-close" style="\n              background: #6c757d;\n              color: #fff;\n              border: none;\n              border-radius: 8px;\n              padding: 12px 24px;\n              font-size: 16px;\n              font-weight: bold;\n              cursor: pointer;\n              transition: all 0.2s;\n              min-width: 120px;\n            ">æˆ‘çŸ¥é“äº†</button>\n          </div>\n        </div>\n      </div>\n      <style>\n        @keyframes diceDialogPop {\n          from {\n            opacity: 0;\n            transform: translateY(20px) scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n          }\n        }\n        .dice-conflict-dialog button:hover {\n          transform: translateY(-2px);\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        }\n        .dice-conflict-dialog button:active {\n          transform: translateY(0);\n        }\n        @media (max-width: 768px) {\n          .dice-conflict-dialog {\n            padding: 20px !important;\n            margin: 10px !important;\n            max-width: calc(100% - 20px) !important;\n          }\n          .dice-conflict-dialog h2 {\n            font-size: 20px !important;\n          }\n          .dice-conflict-dialog p {\n            font-size: 14px !important;\n          }\n        }\n      </style>\n    '),$('#dice-conflict-close').on('click',function(){$('.dice-conflict-dialog-overlay').fadeOut(200,function(){$(this).remove()})});const t=$('.dice-conflict-dialog-overlay');c(t,'dice-conflict-dialog-overlay',()=>{t.fadeOut(200,function(){$(this).remove()})}),window.toastr&&window.toastr.error('è„šæœ¬å†²çªï¼šéª°å­ç³»ç»Ÿä¸å¯è§†åŒ–è¡¨æ ¼ä¸èƒ½åŒæ—¶å¯ç”¨','å†²çªæ£€æµ‹',{timeOut:0,extendedTimeOut:0,closeButton:!0,preventDuplicates:!0})},An=()=>{if(Gt)return;console.log('[DICE]å¼€å§‹åˆå§‹åŒ–éª°å­ç³»ç»Ÿ...');try{O.restore(),console.info('[DICE]ConsoleCaptureManager çŠ¶æ€å·²æ¢å¤')}catch(t){console.error('[DICE]æ¢å¤ ConsoleCaptureManager çŠ¶æ€å¤±è´¥:',t)}try{B.checkAndRestore(),console.info('[DICE]é”™è¯¯çŠ¶æ€æ£€æŸ¥å®Œæˆ')}catch(t){console.error('[DICE]åˆå§‹åŒ–æ—¶æ£€æŸ¥é”™è¯¯çŠ¶æ€å¤±è´¥:',t)}if((()=>{const{$}=$e();if(!$)return!1;const t=$('.acu-wrapper');if(t.length>0){const e=t.find('.acu-nav-container').length>0,a=t.find('.acu-data-display').length>0;if(t.attr('id'),t.attr('class'),e&&a&&!(t.find('[id*="dice"], [class*="dice"]').length>0))return!0}try{const t=document.querySelectorAll('script');for(const e of t){const t=e.textContent||e.innerHTML||'';if(t.includes('acu_visualizer_ui_v20_pagination')&&t.includes('acu_ui_config_v18'))return!0}}catch(t){}try{const t=localStorage.getItem('acu_ui_config_v18'),e=localStorage.getItem('acu_ui_config_v19');if(t&&!e&&!($('[id*="dice"], [class*="dice"]').length>0))return!0}catch(t){}return!1})())return En(),void console.error('[DICE]éª°å­ç³»ç»Ÿ æ£€æµ‹åˆ°å¯è§†åŒ–è¡¨æ ¼è„šæœ¬å†²çªï¼Œå·²é˜»æ­¢åˆå§‹åŒ–');console.info('[DICE]æ³¨å…¥ MVU æ ·å¼å’Œè‡ªå®šä¹‰æ ·å¼...'),vt.injectStyles(),ne&&(ne.disconnect(),ne=null,console.info('[DICE]æ¸…ç†æ—§çš„ MutationObserver')),ya();const t=ma(),e=ye.find(e=>e.id===t.fontFamily)?.val||ye[0].val;if(o(t.theme,e),window.SillyTavern&&window.SillyTavern.eventSource){console.info('[DICE]æ³¨å†Œ SillyTavern äº‹ä»¶ç›‘å¬å™¨...');const t=window.SillyTavern.eventTypes,e=window.SillyTavern.eventSource,a=[t.CHAT_CHANGED,t.MESSAGE_SWIPED,t.MESSAGE_DELETED,t.MESSAGE_UPDATED];oe||(oe=()=>{te?console.info('[DICE]æ­£åœ¨ç¼–è¾‘é¡ºåºï¼Œè·³è¿‡ç•Œé¢æ¸²æŸ“'):(console.info('[DICE]æ¶ˆæ¯æ›´æ–°äº‹ä»¶è§¦å‘ï¼Œå»¶è¿Ÿæ¸²æŸ“ç•Œé¢'),setTimeout(nn,500))}),window._acuBoundChatChangeHandler||(window._acuBoundChatChangeHandler=()=>{console.info('[DICE]èŠå¤©åˆ‡æ¢äº‹ä»¶è§¦å‘ï¼Œæ¸…ç†ç¼“å­˜å¹¶é‡æ–°æ¸²æŸ“'),ie=null,ue={},de={},be={},re=!1,ae.clear(),window.acuModifiedSet&&window.acuModifiedSet.clear(),setTimeout(nn,500)});const n=window._acuBoundChatChangeHandler;a.forEach(a=>{a&&(e.removeListener(a,oe),e.removeListener(a,n),a===t.CHAT_CHANGED?e.on(a,n):e.on(a,oe))}),console.info(`[DICE]å·²æ³¨å†Œ ${a.length} ä¸ªäº‹ä»¶ç›‘å¬å™¨`)}else console.warn('[DICE]SillyTavern äº‹ä»¶æºä¸å¯ç”¨ï¼Œè·³è¿‡äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ');const a=()=>{const t=$e().getDB();if(t?.exportTableAsJson){Gt=!0,console.log('[DICE]éª°å­ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ'),console.info('[DICE]æ•°æ®åº“ API å·²å°±ç»ª');const e=$('#chat');if(e.length&&!ne){console.info('[DICE]å¯åŠ¨èŠå¤©åŒºåŸŸ MutationObserver');let t=!1;ne=new MutationObserver(()=>{t||(t=!0,requestAnimationFrame(()=>{if('embedded'===ma().positionMode)return void(t=!1);const a=e.children().last()[0],n=$('.acu-wrapper')[0];n&&a&&a!==n&&($(a).hasClass('mes')||$(a).hasClass('message-body'))&&e.append(n);const o=xt();if(o&&o.hideDiceResultInChat){const t=e.children().last();(t.hasClass('mes')||t.hasClass('message-body'))&&t.addClass('acu-dice-result-revealing'),requestAnimationFrame(()=>{wt(),requestAnimationFrame(()=>{t.removeClass('acu-dice-result-revealing').addClass('acu-dice-result-revealed'),setTimeout(()=>{t.removeClass('acu-dice-result-revealed')},200)})})}t=!1}))}),ne.observe(e[0],{childList:!0})}else e.length||console.warn('[DICE]èŠå¤©åŒºåŸŸ (#chat) æœªæ‰¾åˆ°ï¼Œè·³è¿‡ MutationObserver è®¾ç½®');console.info('[DICE]æ‰§è¡Œé¦–æ¬¡ç•Œé¢æ¸²æŸ“...'),nn(),setTimeout(()=>{wt()},500),t.registerTableUpdateCallback?(t.registerTableUpdateCallback(me.handleUpdate),console.info('[DICE]å·²æ³¨å†Œè¡¨æ ¼æ›´æ–°å›è°ƒ'),t.registerTableFillStartCallback&&(t.registerTableFillStartCallback(()=>{const e=t.exportTableAsJson();e&&Re(e)}),console.info('[DICE]å·²æ³¨å†Œè¡¨æ ¼å¡«å……å¼€å§‹å›è°ƒ'))):console.warn('[DICE]æ•°æ®åº“ API ä¸æ”¯æŒå›è°ƒæ³¨å†Œ')}else Gt||(window._acuInitRetries=(window._acuInitRetries||0)+1,window._acuInitRetries<60?(window._acuInitRetries%10==0&&console.info(`[DICE]ç­‰å¾…æ•°æ®åº“ API å°±ç»ª... (${window._acuInitRetries}/60)`),setTimeout(a,1e3)):console.error('[DICE]æœªæ£€æµ‹åˆ°æ•°æ®åº“åç«¯ APIï¼Œåœæ­¢è½®è¯¢ã€‚è¯·ç¡®ä¿å·²å®‰è£…ç¥Â·æ•°æ®åº“è„šæœ¬ã€‚'))};a();setTimeout(()=>{const{$}=$e(),t=()=>{ge=!1,$('.acu-option-panel, .acu-embedded-options-container').fadeOut(200,function(){$(this).remove()})},e=new Map;let a=0;const n=t=>{const e='string'==typeof t?Number(t):t;return Number.isFinite(e)?e:null},o=t=>{if(!t)return!1;return/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g.test(t)||/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g.test(t)},i=(t,e)=>{if(!t||!e)return'';const a=/(<æœ¬è½®ç”¨æˆ·è¾“å…¥>)([\s\S]*?)(<\/æœ¬è½®ç”¨æˆ·è¾“å…¥>)/,n=t.match(a);if(!n)return'';const o=n[2];if(o.includes(e))return'';const i=o.startsWith('\n')?'\n':'',r=o.endsWith('\n')?'\n':'',c=o.trim(),s=c?`${c} ${e}`:e;return(t.includes(e)?t.replace(e,'').trim():t).replace(a,`${n[1]}${i}${s}${r}${n[3]}`)},r=(t,e,n)=>{if(n)return;const r=e&&'object'==typeof e?e:{},c='string'==typeof r.quiet_prompt?r.quiet_prompt:'',s=!0===r.automatic_trigger;if(!0===r._acu_crazy_applied||s)return;if('quiet'===t||c.trim().length>0)return;const l=Date.now();if(l-a<300)return;const u='string'==typeof r.prompt?r.prompt:'';if(!u||!u.trim())return;if(o(u))return;if(!Dt())return;const d=zt();if(!d)return;let p='';if(u.includes('<æœ¬è½®ç”¨æˆ·è¾“å…¥>')){const t=i(u,d);p=t&&t!==u?t:`${u.trim()} ${d}`.trim()}else p=`${u.trim()} ${d}`.trim();r.prompt=p,r._acu_crazy_applied=!0,a=l},c=()=>{const t=Date.now();if(t-a<300)return;const{$}=$e(),e=$('#send_textarea'),n=(e.val()||'').toString().trim();if(!n)return;if(o(n))return;if(!Dt())return;const i=zt();if(!i)return;l(i,'dice');const r=(e.val()||'').toString();if(r){const t=e[0];t.value=r,t.dispatchEvent(new Event('input',{bubbles:!0})),t.dispatchEvent(new Event('change',{bubbles:!0}))}a=t},s=t=>{const a=n(t);if(null===a)return;if(!Dt())return;const o=zt();o&&(e.set(a,{result:o,createdAt:Date.now()}),p(a))},p=async t=>{const a=n(t);if(null===a)return;const r=e.get(a);if(!r)return;if(Date.now()-r.createdAt>12e3)return void e.delete(a);const c=b?.chat||window.parent?.SillyTavern?.chat,s=c&&'number'==typeof a?c[a]:null,l=getChatMessages(a)[0];if(!(l&&'user'===l.role||s&&s.is_user))return void e.delete(a);const u=String(s?.mes??l?.message??'');if(o(u))return void e.delete(a);const d=l?.extra||s?.extra||{};if(d.acuCrazyModeApplied)return void e.delete(a);let p='';if(u.includes('<æœ¬è½®ç”¨æˆ·è¾“å…¥>')){const t=i(u,r.result);p=t&&t!==u?t:`${u} ${r.result}`.trim()}else p=u?`${u} ${r.result}`:r.result;e.delete(a),s&&s.is_user&&(s.mes=p);try{await setChatMessages([{message_id:a,message:p,extra:{...d,acuCrazyModeApplied:!0}}],{refresh:'affected'})}catch(t){console.warn('[DICE]ç–¯ç‹‚æ¨¡å¼: é™„åŠ éª°å­ç»“æœå¤±è´¥',t)}const{$}=$e(),g=$('#send_textarea');if(g.length){(g.val()||'').toString()===p&&g.val('').trigger('input').trigger('change')}},g=()=>{d();const t=document.getElementById('send_but');if(t){const e=()=>{c(),u()};t.addEventListener('click',e,!0),t.addEventListener('pointerup',e,!0),t.addEventListener('touchend',e,!0)}$(document).off('click.acu_restore_dice','#send_but').on('click.acu_restore_dice','#send_but',function(t){c(),u()});const e=document.getElementById('send_textarea');e&&(e.addEventListener('keydown',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),u())},!0),e.addEventListener('keyup',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),u())},!0)),$('#send_textarea').off('keydown.acu_restore_dice').on('keydown.acu_restore_dice',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),u())}).off('keyup.acu_restore_dice').on('keyup.acu_restore_dice',function(t){'Enter'!==t.key&&'NumpadEnter'!==t.key||(c(),u())});new MutationObserver(()=>{const t=$('#send_textarea');t.length&&!t[0]._acuValueIntercepted&&d()}).observe(document.body,{childList:!0,subtree:!0})},f=()=>{const t=window;t.__acuCrazyGenerateHookInstalled||t.TavernHelper&&'function'==typeof t.TavernHelper.generate&&(t.__acuCrazyGenerateOriginal=t.TavernHelper.generate,t.TavernHelper.generate=async function(...e){const n=e.length>0&&e[0]&&'object'==typeof e[0]?e[0]:null;if(n){const t='string'==typeof n.quiet_prompt?n.quiet_prompt:'',e=!0===n.automatic_trigger;if(!(!0===n._acu_crazy_applied)&&!e&&0===t.trim().length){let t='';const e=n.injects;if(Array.isArray(e)&&e.length>0){const a=e[0];if(a&&'object'==typeof a){const e=a.content;'string'==typeof e&&(t=e)}}if(t||'string'!=typeof n.prompt||(t=n.prompt),t||'string'!=typeof n.user_input||(t=n.user_input),t&&!o(t)&&Dt()){const o=zt();if(o){const i=`${t.trim()} ${o}`.trim();if(Array.isArray(e)&&e.length>0){const t=e[0];t&&'object'==typeof t&&(t.content=i)}else'string'==typeof n.prompt?n.prompt=i:n.user_input=i;n._acu_crazy_applied=!0,a=Date.now(),console.info('[DICE]ç–¯ç‹‚æ¨¡å¼: å·²æ³¨å…¥åˆ°ç”Ÿæˆè¯·æ±‚')}}}}return t.__acuCrazyGenerateOriginal.apply(this,e)},t.__acuCrazyGenerateHookInstalled=!0)},b=window.SillyTavern||window.parent?.SillyTavern,m=b?.eventTypes?.MESSAGE_SENT||(window.tavern_events?window.tavern_events.MESSAGE_SENT:'message_sent');if(b?.eventSource){b.eventSource.on(m,t),b.eventSource.on(m,t=>{s(t);const e=xt();e&&e.hideDiceResultInChat&&setTimeout(()=>{wt()},300)});const e=b?.eventTypes?.GENERATION_AFTER_COMMANDS||(window.tavern_events?window.tavern_events.GENERATION_AFTER_COMMANDS:'GENERATION_AFTER_COMMANDS');return e&&b.eventSource.on(e,(t,e,a)=>{r(t,e,a)}),f(),void g()}if('function'==typeof window.eventOn){window.eventOn(m,t),window.eventOn(m,t=>{s(t);const e=xt();e&&e.hideDiceResultInChat&&setTimeout(()=>{wt()},300)});const e=window.tavern_events?window.tavern_events.GENERATION_AFTER_COMMANDS:'GENERATION_AFTER_COMMANDS';return window.eventOn(e,(t,e,a)=>{r(t,e,a)}),f(),void g()}},2e3),setTimeout(()=>{d()},500);const n=window.eventOn||window.parent?.eventOn;'function'==typeof n?n('era:writeDone',t=>{'object'==typeof vt&&'function'==typeof vt.clearCache&&vt.clearCache();'era'===vt.detectMode()&&De()===vt.MODULE_ID&&(console.log('[DICE]ERAå˜é‡å·²æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°é¢æ¿'),nn())}):console.warn('[DICE]æ— æ³•ç›‘å¬ ERA äº‹ä»¶ï¼ŒeventOn ä¸å¯ç”¨'),$(window).off('beforeunload.acu pagehide.acu').on('beforeunload.acu pagehide.acu',()=>{try{localStorage.setItem(fe,JSON.stringify(be)),ne&&(ne.disconnect(),ne=null)}catch(t){}})};window.testPairedTableFix=function(){const t='AM',e='ç¼–ç ç´¢å¼•',a={name:'æ€»ç»“è¡¨',content:[['ç¼–ç ç´¢å¼•','æ—¶é—´è·¨åº¦','çºªè¦'],['AM0001','æ—¶é—´1','çºªè¦1'],['AM0002','æ—¶é—´2','çºªè¦2'],[null,'æ—¶é—´3-é”™è¯¯è¡Œ','çºªè¦3-é”™è¯¯è¡Œ'],['AM0030','æ—¶é—´4','çºªè¦4'],[null,'æ—¶é—´5-é”™è¯¯è¡Œ','çºªè¦5-é”™è¯¯è¡Œ']]},n={name:'æ€»ä½“å¤§çº²',content:[['ç¼–ç ç´¢å¼•','æ—¶é—´è·¨åº¦','å¤§çº²'],[null,'æ—¶é—´A-é”™è¯¯è¡Œ','å¤§çº²A-é”™è¯¯è¡Œ'],['AM0002','æ—¶é—´B','å¤§çº²B'],['AM0030','æ—¶é—´C','å¤§çº²C'],['AM0040','æ—¶é—´D','å¤§çº²D'],['AM0050','æ—¶é—´E','å¤§çº²E']]},o=Ia(a,e,t),i=Ia(n,e,t),r=Sa(a,0,n,0,e,Fa(o.allCodes,i.allCodes,t,1),t),c=e=>e.content.slice(1).map(t=>t[0]).filter(e=>e&&String(e).match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\d+$`))),s=c(a),l=c(n),u=a.content.slice(1).filter(e=>!e[0]||!String(e[0]).match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\d+$`))),d=n.content.slice(1).filter(e=>!e[0]||!String(e[0]).match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}\\d+$`))),p=(t,e,a)=>{const n=t.map(t=>{if(!t)return null;const a=t.match(new RegExp(`^${e.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));return a?parseInt(a[1],10):null}).filter(t=>null!==t);for(let t=0;t<n.length;t++)if(n[t]!==a+t)return!1;return!0},g=p(s,t,1),f=p(l,t,1),b=new Set(s),m=new Set(l),v=b.size===m.size&&[...b].every(t=>m.has(t)),h=u.some(t=>t[1]&&t[1].includes('é”™è¯¯è¡Œ')),x=d.some(t=>t[1]&&t[1].includes('é”™è¯¯è¡Œ'));return{table1Sheet:a,table2Sheet:n,result:r,codes1:s,codes2:l,emptyRows1:u,emptyRows2:d,isValid1:g,isValid2:f,setsEqual:v,emptyRowsPreserved1:h,emptyRowsPreserved2:x,isValid:g&&f&&v&&h&&x}},window.diagnoseDiceVariables=async function(){return void 0!==vt&&'function'==typeof vt.diagnoseVariableFramework?await vt.diagnoseVariableFramework():(console.error('[DICE]MvuModule æœªåˆå§‹åŒ–æˆ–è¯Šæ–­å·¥å…·ä¸å¯ç”¨'),null)};const{$}=$e();$?$(document).ready(An):window.addEventListener('load',An)}();
//# sourceMappingURL=stable.js.map