const e=[[/é­”æ³•|æ³•å¸ˆ/,'ğŸ§™â€â™‚ï¸'],[/ä¹¦|æ¡£æ¡ˆ/,'ğŸ“š'],[/æ•™å­¦æ¥¼|æ•™å®¤|è®²å ‚|å­¦æ ¡/,'ğŸ«'],[/ä½“è‚²é¦†|æ“åœº|è®­ç»ƒåœº/,'ğŸŸï¸'],[/å­¦é™¢|å­¦æ ¡|å­¦å›­|å¤§å­¦|ä¸­å­¦|å°å­¦|å¹¼å„¿å›­/,'ğŸ«'],[/åšç‰©é¦†|å±•è§ˆé¦†/,'ğŸ›ï¸'],[/æ‘„å½±æ£š|æ‹æ‘„|ç‰‡åœº|å½±æ£š/,'ğŸ¬'],[/èéº¦é¢|æ‹‰é¢|é¢åº—|é¢é¦†/,'ğŸœ'],[/RiNG|LiveHouse|æ¼”å”±ä¼š|æ¼”å‡º/,'ğŸ¸'],[/æ­¦å™¨åº—|é“åŒ é“º/,'âš”ï¸'],[/é˜²å…·åº—/,'ğŸ›¡ï¸'],[/é“å…·åº—|æ‚è´§é“º/,'ğŸ’'],[/æ—…é¦†|å®¢æ ˆ|é…’åº—/,'ğŸ¨'],[/ä¾¿åˆ©åº—|è¶…å¸‚|å•†åº—|ç™¾è´§|é›†å¸‚|å¸‚åœº/,'ğŸª'],[/å•†åŸ|è´­ç‰©ä¸­å¿ƒ/,'ğŸ¬'],[/é¤å…|é¥­åº—|é£Ÿå ‚|é…’é¦†|å®´ä¼šå…/,'ğŸ½ï¸'],[/å’–å•¡|èŒ¶å®¤/,'â˜•'],[/é…’å§|å¤œåº—/,'ğŸ·'],[/èµŒåœº|å¨±ä¹åŸ/,'ğŸ°'],[/æ¸©æ³‰|æ¾¡å ‚/,'â™¨ï¸'],[/å¨æˆ¿|çƒ¹é¥ª/,'ğŸ³'],[/æµ´å®¤|å•æ‰€|æ´—æ‰‹é—´|å«ç”Ÿé—´/,'ğŸš½'],[/é˜³å°|å¤©å°|éœ²å°/,'ğŸ”­'],[/åœ°ä¸‹å®¤|åœ°çª–/,'ğŸªœ'],[/èµ°å»Š|è¿‡é“|ç„å…³|é—¨å…/,'ğŸ‘£'],[/å®¿èˆ|å¯å®¤/,'ğŸ¢'],[/å…¬å¯“|å®¶|ä½å®…|å…¬é¦†|åˆ«å¢…|è±ªå®…|åºœé‚¸|ä½æ‰€|å±…æ‰€/,'ğŸ '],[/æˆ¿é—´|å§å®¤|å®¢æˆ¿|ç¡æˆ¿/,'ğŸ›Œ'],[/å®¢å…|èµ·å±…å®¤|å¤§å…/,'ğŸ›‹ï¸'],[/ä¹¦æˆ¿|å·¥ä½œå®¤/,'ğŸ“–'],[/é˜æ¥¼|é¡¶å±‚/,'ğŸ '],[/åº­é™¢|é™¢å­|åé™¢|å‰é™¢/,'ğŸŒ¿'],[/é—¨å»Š|é—¨é˜¶/,'ğŸšª'],[/é›ªå±±|å†°åŸ|å†»åœŸ|å¯’å†·/,'â„ï¸'],[/ç«å±±|ç†”å²©|ç‚çƒ­/,'ğŸŒ‹'],[/æ²™æ¼ |è’æ¼ |æ²™ä¸˜/,'ğŸŒµ'],[/æµ·æ»©|æµ·è¾¹|æµ·å²¸|æ¸¯å£|ç å¤´/,'ğŸ–ï¸'],[/æµ·æ´‹|æ·±æµ·|æ°´ä¸‹/,'ğŸŒŠ'],[/ç€‘å¸ƒ|æ²³æµ|æºªæµ|æ¹–æ³Š|æ°´æ½­/,'ğŸ’§'],[/æ´ç©´|å±±æ´|çŸ¿å‘|åœ°ç©´|å²©æ´/,'ğŸ•³ï¸'],[/æ£®æ—|æ ‘æ—|ä¸›æ—|å¯†æ—/,'ğŸŒ²'],[/è‰åŸ|å¹³åŸ|è‰åœ°|ç”°é‡/,'ğŸŒ¾'],[/å±±è„‰|æ‚¬å´–|å±±é¡¶|é«˜å±±/,'â›°ï¸'],[/æ²¼æ³½|æ³¥æ½­|æ¹¿åœ°/,'ğŸŠ'],[/å…¬å›­|èŠ±å›­|åº­é™¢|å¾¡è‹‘/,'ğŸŒ³'],[/ç‹åº§|å¤§æ®¿|ç‹å®«|çš‡å®«/,'ğŸ‘‘'],[/å®˜èˆ/,'ğŸ¢'],[/å®˜é“/,'ğŸ›¤ï¸'],[/é©¿ç«™|é©¿é¦†/,'ğŸ'],[/å¿è¡™|åºœè¡™/,'âš–ï¸'],[/å¤§å†…/,'ğŸ¯'],[/å®«æ®¿/,'ğŸ›ï¸'],[/åŸå ¡|è¦å¡|åŸå¢™/,'ğŸ°'],[/æ•™å ‚|å¤§æ•™å ‚|ä¿®é“é™¢/,'â›ª'],[/ç¥ç¤¾|ç¥æ®¿|å¯ºåº™|ç¥­å›|ç¥ å ‚/,'â›©ï¸'],[/å¢“åœ°|å¢“å›­|åŸåœº|ä¹±è‘¬å²—/,'ğŸª¦'],[/é—è¿¹|åºŸå¢Ÿ|å¤è¿¹/,'ğŸ›ï¸'],[/åœ°ç‰¢|åœ°ä¸‹åŸ|è¿·å®«|ç›‘ç‰¢/,'ğŸ•¸ï¸'],[/å¡”|é«˜å¡”|ç¯å¡”/,'ğŸ—¼'],[/å…¬ä¼š|å†’é™©è€…/,'ğŸ›¡ï¸'],[/ç«æŠ€åœº|å†³æ–—åœº/,'âš”ï¸'],[/å¼‚ç•Œ|è™šç©º|ä¼ é€/,'ğŸŒ€'],[/å®éªŒå®¤|ç ”ç©¶æ‰€|åŒ–éªŒå®¤/,'ğŸ§ª'],[/å·¥å‚|å‘ç”µå‚|æµæ°´çº¿/,'ğŸ­'],[/ä»“åº“|å‚¨è—å®¤/,'ğŸ“¦'],[/åŒ»é™¢|è¯Šæ‰€|åŒ»åŠ¡å®¤/,'ğŸ¥'],[/è­¦å¯Ÿå±€|æ´¾å‡ºæ‰€|ç›‘ç‹±/,'ğŸš“'],[/é“¶è¡Œ|é‡‘åº“/,'ğŸ¦'],[/åŠå…¬|å†™å­—æ¥¼|å…¬å¸|ä¼šè®®å®¤/,'ğŸ’¼'],[/ç”µæ¢¯/,'ğŸ›—'],[/ä¸‹æ°´é“/,'ğŸ€'],[/ç©ºé—´ç«™|å®‡å®™é£èˆ¹|å¤ªç©º/,'ğŸš€'],[/æœºåœº|åœæœºåª/,'âœˆï¸'],[/è½¦ç«™|åœ°é“|ç«è½¦ç«™|ç«™å°/,'ğŸš‰'],[/åœè½¦åœº|è½¦åº“/,'ğŸ…¿ï¸'],[/è¡—é“|è¡—è§’|é©¬è·¯|åå­—è·¯å£|å··å­/,'ğŸš¶'],[/æ¡¥|æ¡¥æ¢/,'ğŸŒ‰'],[/å¹¿åœº|ä¸­å¿ƒ/,'â›²'],[/åŸå¸‚|åŸé•‡|æ‘åº„|æ‘è½/,'ğŸ˜ï¸']],t=[[/BOSS|é¦–é¢†|é­”ç‹|å·¨é¾™/,'ğŸ²'],[/äº¡çµ|ä¸§å°¸|åƒµå°¸|éª·é«…|é¬¼é­‚|å¹½çµ/,'ğŸ’€'],[/é‡å…½|ç‹¼|ç†Š/,'ğŸº'],[/å²è±å§†|è½¯æ³¥/,'ğŸ’§'],[/æ¶é­”|æ€ªç‰©|é­”å…½/,'ğŸ‘¹'],[/æœºå™¨äºº|æœºæ¢°|æœºç”²/,'ğŸ¤–'],[/å•†äºº|åº—ä¸»/,'ğŸ’°'],[/å®ˆå«|å£«å…µ|éª‘å£«/,'ğŸ›¡ï¸'],[/é¾™å¥—|è·¯äºº|æ‘æ°‘|å­¦ç”Ÿ|å¸‚æ°‘/,'ğŸ‘¥'],[/é‡‘å¸|é’±è¢‹|é’±åŒ…/,'ğŸ’°'],[/ç²®ä»“|ç²®é£Ÿ|è°·ç‰©/,'ğŸŒ¾'],[/å®çŸ³|æ°´æ™¶|é’»çŸ³/,'ğŸ’'],[/æ­¦å™¨|å‰‘|åˆ€|æª/,'âš”ï¸'],[/é˜²å…·|ç›¾|ç›”ç”²|è¡£æœ/,'ğŸ‘•'],[/è¯æ°´|è¯å‰‚|æ¢å¤/,'ğŸ§ª'],[/é£Ÿç‰©|æ–™ç†|é£Ÿæ/,'ğŸ–'],[/é»„ç“œ/,'ğŸ¥’'],[/èŠ’æœ/,'ğŸ¥­'],[/ä¹¦ä¿¡|çº¸æ¡|ç¬”è®°|æ—¥è®°/,'ğŸ“„'],[/å‰§æœ¬/,'ğŸ“œ'],[/å‰ä»–/,'ğŸ¸'],[/é’¥åŒ™|é—¨å¡/,'ğŸ”‘'],[/åœ°å›¾/,'ğŸ—ºï¸'],[/å®ç®±|å®ç‰©/,'ğŸ'],[/ç‰©å“|é“å…·|æ‚ç‰©|è¡Œæ/,'ğŸ’'],[/å­˜æ¡£ç‚¹|è®°å½•ç‚¹|ç¥åƒ/,'ğŸ’¾'],[/ä¼ é€é—¨|ä¼ é€é˜µ/,'ğŸŒ€'],[/é™·é˜±|åœ°é›·|å°–åˆº/,'ğŸª¤'],[/å¼€å…³|æ‹‰æ†|æŒ‰é’®/,'ğŸ•¹ï¸'],[/é”|å°å°/,'ğŸ”’'],[/ç¯ç«|è¥ç«|ç«æŠŠ|ç«å †/,'ğŸ”¥'],[/è·¯ç‰Œ|å‘Šç¤º|æ ‡å¿—/,'ğŸª§'],[/æœºå…³|è£…ç½®|æœºæ¢°/,'âš™ï¸'],[/é—¨|å¤§é—¨|å…¥å£|å‡ºå£/,'ğŸšª'],[/çª—æˆ·|çª—/,'ğŸªŸ'],[/ç”µè„‘|æœåŠ¡å™¨|ç»ˆç«¯/,'ğŸ’»'],[/ä¹¦æ¶|ä¹¦æŸœ/,'ğŸ“š'],[/åºŠ|é“º/,'ğŸ›ï¸'],[/æ¡Œå­|å°å­|æŸœå°/,'ğŸªµ'],[/æ¤…å­|æ²™å‘/,'ğŸª‘'],[/é›•åƒ|çŸ³åƒ/,'ğŸ—¿'],[/è¡€è¿¹|è¡€æ³Š/,'ğŸ©¸'],[/è„šå°|ç—•è¿¹|è¸ªè¿¹/,'ğŸ‘£'],[/å°¸ä½“|æ®‹éª¸|ç™½éª¨/,'â˜ ï¸'],[/è¿·é›¾|çƒŸé›¾|æ¯’æ°”/,'ğŸŒ«ï¸'],[/å…‰|å…‰æº|ç¯/,'ğŸ’¡'],[/ç¯å¢ƒç‰©|çŸ³å¤´|å²©çŸ³|éšœç¢/,'ğŸª¨']];!function(){const n='acu_visualizer_ui_v19_6_ai_overlay',a={STORAGE_KEY_PREFIX:'acu_locked_fields_v2_',MAX_CONTEXTS:20,PRIMARY_KEYS:{å…¨å±€æ•°æ®è¡¨:null,ä¸–ç•Œåœ°å›¾ç‚¹:'è¯¦ç»†åœ°ç‚¹',åœ°å›¾å…ƒç´ è¡¨:'å…ƒç´ åç§°',ä¸»è§’ä¿¡æ¯:'å§“å',é‡è¦äººç‰©è¡¨:'å§“å',æŠ€èƒ½è¡¨:'æŠ€èƒ½åç§°',ç‰©å“è¡¨:'ç‰©å“åç§°',è£…å¤‡è¡¨:'è£…å¤‡åç§°',ä»»åŠ¡è¡¨:'åç§°',æ€»ç»“è¡¨:'ç¼–ç ç´¢å¼•',æ€»ä½“å¤§çº²:'ç¼–ç ç´¢å¼•',é‡è¦æƒ…æŠ¥:'æƒ…æŠ¥åç§°',åŠ¿åŠ›:'åç§°'},_cache:null,_currentContextId:null,_getStorageKey(e){return this.STORAGE_KEY_PREFIX+(e||rt())},_cleanupOldContexts(){try{const e=this.STORAGE_KEY_PREFIX,t=[];for(let n=0;n<localStorage.length;n++){const a=localStorage.key(n);a&&a.startsWith(e)&&t.push(a)}if(t.length<=this.MAX_CONTEXTS)return;const n=t.map(e=>{try{const t=JSON.parse(localStorage.getItem(e));return{key:e,time:t?._lastAccess||0}}catch{return{key:e,time:0}}});n.sort((e,t)=>t.time-e.time);const a=n.slice(this.MAX_CONTEXTS);a.forEach(e=>{localStorage.removeItem(e.key)}),a.length>0&&console.log(`[DICE]LockManager æ¸…ç†äº† ${a.length} ä¸ªè¿‡æœŸçš„é”å®šæ•°æ®`)}catch(e){console.warn('[DICE]LockManager æ¸…ç†å¤±è´¥',e)}},_load(){const e=rt();if(this._currentContextId!==e&&(this._cache=null,this._currentContextId=e),!this._cache)try{const e=localStorage.getItem(this._getStorageKey());this._cache=e?JSON.parse(e):{},delete this._cache._lastAccess}catch(e){this._cache={}}return this._cache},_save(){try{const e={...this._cache,_lastAccess:Date.now()};localStorage.setItem(this._getStorageKey(),JSON.stringify(e)),this._cleanupOldContexts()}catch(e){console.warn('[DICE]LockManager ä¿å­˜å¤±è´¥',e)}},getRowKey(e,t,n){const a=this.PRIMARY_KEYS[e];if(null===a)return'_row_0';let i=1;if(a){const e=n.indexOf(a);-1!==e&&(i=e)}return t[i]?`${a||n[i]}=${t[i]}`:null},lockField(e,t,n,a){const i=this._load();i[e]||(i[e]={}),i[e][t]||(i[e][t]={_fullRow:!1,_fields:{},_snapshot:null}),i[e][t]._fields[n]=a,this._save()},lockRow(e,t,n,a){const i=this._load();i[e]||(i[e]={});const o={};a.forEach((e,t)=>{e&&null!=n[t]&&''!==n[t]&&(o[e]=n[t])}),i[e][t]={_fullRow:!0,_fields:{},_snapshot:o},this._save()},unlockField(e,t,n){const a=this._load(),i=a[e]?.[t];i&&(i._fullRow&&i._snapshot?(delete i._snapshot[n],0===Object.keys(i._snapshot).length&&(delete a[e][t],0===Object.keys(a[e]).length&&delete a[e])):(delete i._fields[n],0===Object.keys(i._fields).length&&(delete a[e][t],0===Object.keys(a[e]).length&&delete a[e])),this._save())},unlockRow(e,t){const n=this._load();n[e]&&(delete n[e][t],0===Object.keys(n[e]).length&&delete n[e],this._save())},isFieldLocked(e,t,n){const a=this._load()[e]?.[t];return!!a&&(a._fullRow?a._snapshot?.hasOwnProperty(n):a._fields?.hasOwnProperty(n))},isRowLocked(e,t){return!0===this._load()[e]?.[t]?._fullRow},applyLocks(e,t){const n=this._load()[e];if(!n||!t||t.length<2)return{modified:!1,restored:[]};const a=t[0],i=[];let o=!1;const r={};for(let n=1;n<t.length;n++){const i=this.getRowKey(e,t[n],a);i&&(r[i]=n)}for(const[e,c]of Object.entries(n)){const n=r[e];if(void 0===n){const n=this._rebuildRow(a,c);n&&(t.push(n),i.push(e),o=!0);continue}const s=t[n],l=c._fullRow?c._snapshot:c._fields;if(l)for(const[e,t]of Object.entries(l)){const n=a.indexOf(e);-1!==n&&s[n]!==t&&(s[n]=t,o=!0)}}return{modified:o,restored:i}},_rebuildRow(e,t){const n=t._fullRow?t._snapshot:t._fields;if(!n||0===Object.keys(n).length)return null;const a=new Array(e.length).fill(null);for(const[t,i]of Object.entries(n)){const n=e.indexOf(t);-1!==n&&(a[n]=i)}return a},hasAnyLock(e,t){const n=this._load()[e]?.[t];return!!n&&(!!n._fullRow||Object.keys(n._fields||{}).length>0)},getLockedFields(e,t){const n=this._load()[e]?.[t];return n?n._fullRow?Object.keys(n._snapshot||{}):Object.keys(n._fields||{}):[]},clearCurrentContext(){localStorage.removeItem(this._getStorageKey()),this._cache=null}},i={STORAGE_KEY_PREFIX:'acu_bookmarks_v1_',MAX_CONTEXTS:20,_cache:null,_currentContextId:null,_getStorageKey(e){return this.STORAGE_KEY_PREFIX+(e||rt())},_cleanupOldContexts(){try{const e=this.STORAGE_KEY_PREFIX,t=[];for(let n=0;n<localStorage.length;n++){const a=localStorage.key(n);a&&a.startsWith(e)&&t.push(a)}if(t.length<=this.MAX_CONTEXTS)return;const n=t.map(e=>{try{const t=JSON.parse(localStorage.getItem(e));return{key:e,time:t?._lastAccess||0}}catch{return{key:e,time:0}}});n.sort((e,t)=>t.time-e.time);const a=n.slice(this.MAX_CONTEXTS);a.forEach(e=>{localStorage.removeItem(e.key)}),a.length>0&&console.log(`[DICE]BookmarkManager æ¸…ç†äº† ${a.length} ä¸ªè¿‡æœŸçš„bookmarkæ•°æ®ï¼ˆå½“å‰ä¿ç•™ ${this.MAX_CONTEXTS} ä¸ªèŠå¤©çš„æ•°æ®ï¼Œæ¸…ç†å‰å…±æœ‰ ${t.length} ä¸ªï¼‰`)}catch(e){console.warn('[DICE]BookmarkManager æ¸…ç†å¤±è´¥',e)}},_load(){const e=rt();if(this._currentContextId!==e&&(this._cache=null,this._currentContextId=e),!this._cache)try{const e=localStorage.getItem(this._getStorageKey());this._cache=e?JSON.parse(e):{},delete this._cache._lastAccess}catch(e){this._cache={}}return this._cache},_save(){try{const e={...this._cache,_lastAccess:Date.now()};localStorage.setItem(this._getStorageKey(),JSON.stringify(e)),this._cleanupOldContexts()}catch(e){console.warn('[DICE]BookmarkManager ä¿å­˜å¤±è´¥',e)}},isBookmarked(e,t){const n=this._load();return!(!n[e]||!n[e][t])},toggleBookmark(e,t){const n=this._load();n[e]||(n[e]={}),n[e][t]?(delete n[e][t],0===Object.keys(n[e]).length&&delete n[e]):n[e][t]=!0,this._save()},getBookmarks(e){const t=this._load();return t[e]?Object.keys(t[e]):[]},clearCurrentContext(){localStorage.removeItem(this._getStorageKey()),this._cache=null}},o=e=>String(e??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),r=(e,t)=>{const{$}=ut(),n=$('#send_textarea');if(!n.length)return;const a=(n.val()||'').trim(),i=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g,o=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g,r=/<user>(?:(?!<user>).)*?[ã€‚ï¼ï¼Ÿ]/g,c=/\[æŠ•éª°ç»“æœå·²éšè—\]/g,s=ge();let l=e,d=!1;if('dice'===t&&s.hideDiceResultFromUser&&(l='[æŠ•éª°ç»“æœå·²éšè—]',d=!0),!a){if(n.val(l).trigger('input').trigger('change'),'dice'===t){n.data('acu-original-dice-text',e);const t=n[0];t._acuOriginalDiceText=e,t._acuHasDiceData=!0}return}let u=a,p='',g='',f='';if(c.test(u)){const e=n.data('acu-original-dice-text')||'';e?(u=u.replace(c,e),g=e,f=e):u=u.replace(c,'').trim()}const b=u.match(o);b&&b.length>0&&(g=b[b.length-1],f=g,u=u.replace(o,'\0').trim(),console.log('[DICE]ACU SmartInsert Found and extracted contest roll:',g));const m=u.match(i);m&&m.length>0&&(g=m[m.length-1],f=g,u=u.replace(i,'\0').trim(),console.log('[DICE]ACU SmartInsert Found and extracted normal roll:',g));const h=u.match(r);h&&h.length>0&&(p=h[h.length-1],u=u.replace(r,'').trim(),console.log('[DICE]ACU SmartInsert Found and extracted action:',p));let v=u.replace(/[\u0000\u0001]/g,' ').replace(/\s+/g,' ').trim();if('dice'===t){g=l,f=e,n.data('acu-original-dice-text',e);const t=n[0];t._acuOriginalDiceText=e,t._acuHasDiceData=!0}else'action'===t&&(p=e);const x=[];v&&x.push(v),p&&x.push(p),g&&x.push(g);const y=x.join(' ');n.val(y).trigger('input').trigger('change')},c=()=>{const{$}=ut(),e=$('#send_textarea');if(!e.length)return;const t=e.val()||'',n=e.data('acu-original-dice-text');if(t.includes('[æŠ•éª°ç»“æœå·²éšè—]')&&n){const a=t.replace(/\[æŠ•éª°ç»“æœå·²éšè—\]/g,n);e.val(a),e.removeData('acu-original-dice-text');const i=e[0];i._acuOriginalDiceText=null,i._acuHasDiceData=!1}},s=()=>{const{$}=ut(),e=$('#send_textarea');if(!e.length)return;const t=e[0];if(!t||t._acuValueIntercepted)return;t._acuValueIntercepted=!0;const n=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,'value'),a=t.value;Object.defineProperty(t,'value',{get:function(){let e;if(e=n&&n.get?n.get.call(this):this._value||a||'',!this._acuHasDiceData)return e;const t=this._acuOriginalDiceText;return e&&'string'==typeof e&&e.includes('[æŠ•éª°ç»“æœå·²éšè—]')&&t?e.replace(/\[æŠ•éª°ç»“æœå·²éšè—\]/g,t):e},set:function(e){n&&n.set?n.set.call(this,e):this._value=e},configurable:!0})},l='acu_table_order',d='acu_action_order',u='acu_pending_deletions',p='acu_active_tab',g='acu_ui_config_v19',f='acu_data_snapshot_v19',b='acu_ui_collapsed_state',m='acu_dashboard_active',h='acu_table_heights_v19',v='acu_table_styles_v19',x='acu_hidden_tables_v19',y='acu_reverse_tables_v1',w=200,k=1200,C='acu_dice_config_v1',E='acu_attribute_presets_v1',A='acu_active_attr_preset_v1',S='acu_dice_crazy_mode',I={enabled:!1,crazyLevel:50,playerWeight:80,inSceneNpcWeight:15,offSceneNpcWeight:5},T='1.4.0',F=(e,t)=>{const n=e=>'number'==typeof e?`${e}.0.0`:'string'!=typeof e?'0.0.0':e,a=n(e),i=n(t),o=a.split('.').map(Number),r=i.split('.').map(Number);for(let e=0;e<Math.max(o.length,r.length);e++){const t=o[e]||0,n=r[e]||0;if(t<n)return-1;if(t>n)return 1}return 0},M='acu_avatar_map_v1',B='acu_map_focus_v1',D={logs:[],maxLogs:1e3,filters:{log:!0,info:!0,warn:!0,error:!0},originalMethods:{},isIntercepted:!1,enabled:!1,restore(){'true'===localStorage.getItem('acu_console_capture_enabled')&&this.enable()},enable(){this.enabled||(this.enabled=!0,localStorage.setItem('acu_console_capture_enabled','true'),this.intercept())},disable(){if(!this.enabled)return;this.enabled=!1,localStorage.setItem('acu_console_capture_enabled','false'),localStorage.removeItem('acu_script_error_detected');const e=document.getElementById('acu-emergency-debug-btn');e&&(e.style.display='none')},intercept(){this.isIntercepted||(this.isIntercepted=!0,['log','info','warn','error'].forEach(e=>{this.originalMethods[e]=console[e];const t=this;console[e]=function(...n){t.originalMethods[e].apply(console,n),t.enabled&&t.capture(e,n)}}))},capture(e,t){if(this.enabled)try{const n=new Date,a=n.toLocaleTimeString('zh-CN',{hour12:!1}),i=t.map(e=>{if('object'==typeof e)try{return JSON.stringify(e,null,2)}catch{return String(e)}return String(e)}).join(' ');let o=null;'error'===e&&t[0]instanceof Error&&(o=t[0].stack||null);const r={id:Date.now()+Math.random(),timestamp:n,timeStr:a,type:e,content:i,stack:o,rawArgs:t};this.logs.push(r),this.logs.length>this.maxLogs&&this.logs.shift()}catch(e){}},clear(){this.logs=[]},getFilteredLogs(){return this.logs.filter(e=>this.filters[e.type])},setFilters(e){this.filters={...this.filters,...e}}},P={errorCount:0,errorThreshold:3,lastErrorTime:0,errorWindow:5e3,fatalErrorDetected:!1,isFatalError(e,t,n,a,i){const o=[/jquery/i,/lodash/i,/vue/i,/react/i,/pixi/i,/gsap/i,/toastr/i,/node_modules/i],r=i||e?.stack||'',c=t||'';for(const e of o)if(e.test(r)||e.test(c))return!1;const s=[/acu_visualizer/i,/éª°å­ç³»ç»Ÿ/i,/LockManager/i,/Store/i,/ConsoleCaptureManager/i,/renderInterface/i,/init\s*\(/i];let l=!1;for(const e of s)if(e.test(r)||e.test(c)){l=!0;break}return l},handleError(e,t,n,a,i){try{if(!this.isFatalError(e,t,n,a,i))return;const o=Date.now();o-this.lastErrorTime>this.errorWindow&&(this.errorCount=0),this.errorCount++,this.lastErrorTime=o,this.errorCount>=this.errorThreshold&&!this.fatalErrorDetected&&(this.fatalErrorDetected=!0,this.triggerFatalError())}catch(e){console.error('[DICE]ErrorHandler å¤„ç†é”™è¯¯æ—¶å¤±è´¥:',e)}},triggerFatalError(){try{D.enabled||D.enable(),localStorage.setItem('acu_script_error_detected','true'),this.showEmergencyButton()}catch(e){console.error('[DICE]ErrorHandler è§¦å‘è‡´å‘½é”™è¯¯å¤„ç†æ—¶å¤±è´¥:',e)}},showEmergencyButton(){try{let e=document.getElementById('acu-emergency-debug-btn');if(e)return void(e.style.display='block');e=document.createElement('button'),e.id='acu-emergency-debug-btn',e.innerHTML='<i class="fa-solid fa-bug"></i> è°ƒè¯•',e.style.cssText='\n          position: fixed;\n          bottom: 20px;\n          right: 20px;\n          z-index: 99999;\n          padding: 10px 16px;\n          background: #e74c3c;\n          color: #fff;\n          border: none;\n          border-radius: 6px;\n          font-size: 14px;\n          font-weight: bold;\n          cursor: pointer;\n          box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);\n          display: flex;\n          align-items: center;\n          gap: 6px;\n          transition: all 0.2s;\n        ',e.onmouseenter=function(){this.style.background='#c0392b',this.style.transform='scale(1.05)'},e.onmouseleave=function(){this.style.background='#e74c3c',this.style.transform='scale(1)'},e.onclick=function(){try{'function'==typeof window.showDebugConsoleModal?window.showDebugConsoleModal():alert('è„šæœ¬å‡ºç°é”™è¯¯ï¼Œè¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰æŸ¥çœ‹æ§åˆ¶å°')}catch(e){console.error('[DICE]ç´§æ€¥å…¥å£æŒ‰é’®ç‚¹å‡»å¤±è´¥:',e),alert('è„šæœ¬å‡ºç°é”™è¯¯ï¼Œè¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰æŸ¥çœ‹æ§åˆ¶å°')}},document.body.appendChild(e)}catch(e){console.error('[DICE]æ˜¾ç¤ºç´§æ€¥å…¥å£æŒ‰é’®å¤±è´¥:',e)}},checkAndRestore(){try{'true'===localStorage.getItem('acu_script_error_detected')&&(D.enabled||D.enable(),this.showEmergencyButton())}catch(e){console.error('[DICE]ErrorHandler æ£€æŸ¥é”™è¯¯çŠ¶æ€å¤±è´¥:',e)}}};window.onerror=function(e,t,n,a,i){return P.handleError(i||e,t,n,a,i?.stack),!1},window.addEventListener('unhandledrejection',function(e){P.handleError(e.reason,null,null,null,e.reason?.stack)});const N='acu_regex_rules_v1',j='acu_regex_presets_v1',O='acu_regex_active_preset_v1',R='acu_regex_enabled_v1',L='acu_validation_enabled_v1',U='acu_validation_mode',V={tableReadonly:{name:'è¡¨çº§åªè¯»',scope:'table',icon:'fa-lock',desc:'ç¦æ­¢ä¿®æ”¹æ•´ä¸ªè¡¨'},rowLimit:{name:'è¡Œæ•°é™åˆ¶',scope:'table',icon:'fa-arrows-up-down',desc:'é™åˆ¶è¡¨çš„è¡Œæ•°èŒƒå›´'},sequence:{name:'åºåˆ—é€’å¢',scope:'table',icon:'fa-sort-numeric-up',desc:'æ£€æŸ¥å­—æ®µå€¼æ˜¯å¦ä¸¥æ ¼é€’å¢'},required:{name:'å¿…å¡«',scope:'field',icon:'fa-asterisk',desc:'å­—æ®µä¸èƒ½ä¸ºç©º'},format:{name:'æ ¼å¼éªŒè¯',scope:'field',icon:'fa-font',desc:'æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…'},enum:{name:'æšä¸¾éªŒè¯',scope:'field',icon:'fa-list',desc:'å€¼å¿…é¡»åœ¨åˆ—è¡¨ä¸­'},numeric:{name:'æ•°å€¼èŒƒå›´',scope:'field',icon:'fa-hashtag',desc:'æ•°å€¼å¿…é¡»åœ¨èŒƒå›´å†…'},relation:{name:'å…³è”éªŒè¯',scope:'field',icon:'fa-link',desc:'å¼•ç”¨å…¶ä»–è¡¨çš„å€¼'},keyValue:{name:'é”®å€¼å¯¹éªŒè¯',scope:'field',icon:'fa-key',desc:'éªŒè¯é”®å€¼å¯¹æ ¼å¼å’Œæ•°å€¼èŒƒå›´'}},Y=[{id:'summary_code_sequence',name:'æ€»ç»“è¡¨ç¼–ç é€’å¢',description:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ç»“è¡¨',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œå‘ç°è·³å·æˆ–é‡å¤'},{id:'outline_code_sequence',name:'æ€»ä½“å¤§çº²ç¼–ç é€’å¢',description:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ä½“å¤§çº²',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'ç¼–ç ç´¢å¼•å¿…é¡»ä»AM0001å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œå‘ç°è·³å·æˆ–é‡å¤'},{id:'summary_code_required',name:'æ€»ç»“è¡¨ç¼–ç ç´¢å¼•å¿…å¡«',description:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ç»“è¡¨',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'required',config:{},errorMessage:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º'},{id:'outline_code_required',name:'æ€»ä½“å¤§çº²ç¼–ç ç´¢å¼•å¿…å¡«',description:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º',enabled:!0,builtin:!0,intercept:!1,targetTable:'æ€»ä½“å¤§çº²',targetColumn:'ç¼–ç ç´¢å¼•',ruleType:'required',config:{},errorMessage:'ç¼–ç ç´¢å¼•ä¸èƒ½ä¸ºç©º'},{id:'quest_status_enum',name:'ä»»åŠ¡è¡¨çŠ¶æ€',description:'ä»»åŠ¡çŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'çŠ¶æ€',ruleType:'enum',config:{values:['è¿›è¡Œä¸­','å·²å®Œæˆ','å·²å¤±è´¥','å·²æ”¾å¼ƒ']},errorMessage:'çŠ¶æ€å¿…é¡»ä¸ºï¼šè¿›è¡Œä¸­ã€å·²å®Œæˆã€å·²å¤±è´¥ã€å·²æ”¾å¼ƒ'},{id:'quest_type_enum',name:'ä»»åŠ¡è¡¨ç±»å‹',description:'ä»»åŠ¡ç±»å‹å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'ç±»å‹',ruleType:'enum',config:{values:['ä¸»çº¿','æ”¯çº¿','æ—¥å¸¸']},errorMessage:'ç±»å‹å¿…é¡»ä¸ºï¼šä¸»çº¿ã€æ”¯çº¿ã€æ—¥å¸¸'},{id:'quest_priority_enum',name:'ä»»åŠ¡è¡¨ä¼˜å…ˆçº§',description:'ä»»åŠ¡ä¼˜å…ˆçº§å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'ä¼˜å…ˆçº§',ruleType:'enum',config:{values:['ç´§æ€¥','é‡è¦','æ™®é€š']},errorMessage:'ä¼˜å…ˆçº§å¿…é¡»ä¸ºï¼šç´§æ€¥ã€é‡è¦ã€æ™®é€š'},{id:'equip_status_enum',name:'è£…å¤‡è¡¨çŠ¶æ€',description:'è£…å¤‡çŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'è£…å¤‡è¡¨',targetColumn:'çŠ¶æ€',ruleType:'enum',config:{values:['å·²è£…å¤‡','é—²ç½®']},errorMessage:'çŠ¶æ€å¿…é¡»ä¸ºï¼šå·²è£…å¤‡ã€é—²ç½®'},{id:'equip_quality_enum',name:'è£…å¤‡è¡¨å“è´¨',description:'è£…å¤‡å“è´¨å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'è£…å¤‡è¡¨',targetColumn:'å“è´¨',ruleType:'enum',config:{values:['æ™®é€š','ä¼˜ç§€','ç¨€æœ‰','å²è¯—','ä¼ è¯´','ç¥è¯']},errorMessage:'å“è´¨å¿…é¡»ä¸ºï¼šæ™®é€šã€ä¼˜ç§€ã€ç¨€æœ‰ã€å²è¯—ã€ä¼ è¯´ã€ç¥è¯'},{id:'item_quality_enum',name:'ç‰©å“è¡¨å“è´¨',description:'ç‰©å“å“è´¨å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ç‰©å“è¡¨',targetColumn:'å“è´¨',ruleType:'enum',config:{values:['æ™®é€š','ä¼˜ç§€','ç¨€æœ‰','å²è¯—','ä¼ è¯´','ç¥è¯']},errorMessage:'å“è´¨å¿…é¡»ä¸ºï¼šæ™®é€šã€ä¼˜ç§€ã€ç¨€æœ‰ã€å²è¯—ã€ä¼ è¯´ã€ç¥è¯'},{id:'skill_type_enum',name:'æŠ€èƒ½è¡¨ç±»å‹',description:'æŠ€èƒ½ç±»å‹å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'æŠ€èƒ½è¡¨',targetColumn:'ç±»å‹',ruleType:'enum',config:{values:['ä¸»åŠ¨','è¢«åŠ¨','ç‰¹è´¨']},errorMessage:'ç±»å‹å¿…é¡»ä¸ºï¼šä¸»åŠ¨ã€è¢«åŠ¨ã€ç‰¹è´¨'},{id:'skill_quality_enum',name:'æŠ€èƒ½è¡¨å“è´¨',description:'æŠ€èƒ½å“è´¨å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'æŠ€èƒ½è¡¨',targetColumn:'å“è´¨',ruleType:'enum',config:{values:['æ™®é€š','ä¼˜ç§€','ç¨€æœ‰','å²è¯—','ä¼ è¯´','ç¥è¯']},errorMessage:'å“è´¨å¿…é¡»ä¸ºï¼šæ™®é€šã€ä¼˜ç§€ã€ç¨€æœ‰ã€å²è¯—ã€ä¼ è¯´ã€ç¥è¯'},{id:'skill_proficiency_range',name:'æŠ€èƒ½ç†Ÿç»ƒåº¦èŒƒå›´',description:'æŠ€èƒ½ç†Ÿç»ƒåº¦å¿…é¡»åœ¨ 0-100 ä¹‹é—´',enabled:!0,builtin:!0,intercept:!1,targetTable:'æŠ€èƒ½è¡¨',targetColumn:'ç†Ÿç»ƒåº¦',ruleType:'numeric',config:{min:0,max:100},errorMessage:'ç†Ÿç»ƒåº¦å¿…é¡»åœ¨ 0-100 ä¹‹é—´'},{id:'npc_presence_enum',name:'é‡è¦äººç‰©åœ¨åœºçŠ¶æ€',description:'åœ¨åœºçŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'åœ¨åœºçŠ¶æ€',ruleType:'enum',config:{values:['åœ¨åœº','ç¦»åœº']},errorMessage:'åœ¨åœºçŠ¶æ€å¿…é¡»ä¸ºï¼šåœ¨åœºã€ç¦»åœº'},{id:'map_explore_enum',name:'åœ°å›¾ç‚¹æ¢ç´¢çŠ¶æ€',description:'æ¢ç´¢çŠ¶æ€å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸–ç•Œåœ°å›¾ç‚¹',targetColumn:'æ¢ç´¢çŠ¶æ€',ruleType:'enum',config:{values:['æœªæ¢ç´¢','éƒ¨åˆ†æ¢ç´¢','å·²æ¢ç´¢']},errorMessage:'æ¢ç´¢çŠ¶æ€å¿…é¡»ä¸ºï¼šæœªæ¢ç´¢ã€éƒ¨åˆ†æ¢ç´¢ã€å·²æ¢ç´¢'},{id:'map_importance_enum',name:'åœ°å›¾ç‚¹é‡è¦åº¦',description:'é‡è¦åº¦å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸–ç•Œåœ°å›¾ç‚¹',targetColumn:'é‡è¦åº¦',ruleType:'enum',config:{values:['æ ¸å¿ƒ','é‡è¦','æ™®é€š']},errorMessage:'é‡è¦åº¦å¿…é¡»ä¸ºï¼šæ ¸å¿ƒã€é‡è¦ã€æ™®é€š'},{id:'intel_importance_enum',name:'æƒ…æŠ¥é‡è¦åº¦',description:'é‡è¦åº¦å¿…é¡»ä¸ºæŒ‡å®šå€¼ä¹‹ä¸€',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦æƒ…æŠ¥',targetColumn:'é‡è¦åº¦',ruleType:'enum',config:{values:['æ ¸å¿ƒ','é‡è¦','æ™®é€š']},errorMessage:'é‡è¦åº¦å¿…é¡»ä¸ºï¼šæ ¸å¿ƒã€é‡è¦ã€æ™®é€š'},{id:'player_location_relation',name:'ä¸»è§’åœ°ç‚¹å…³è”',description:'ä¸»è§’æ‰€åœ¨åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨',enabled:!1,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'æ‰€åœ¨åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'æ‰€åœ¨åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'npc_location_relation',name:'NPCåœ°ç‚¹å…³è”',description:'NPCæ‰€åœ¨åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨',enabled:!1,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'æ‰€åœ¨åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'æ‰€åœ¨åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'element_location_relation',name:'å…ƒç´ åœ°ç‚¹å…³è”',description:'å…ƒç´ æ‰€åœ¨åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨çš„è¯¦ç»†åœ°ç‚¹',enabled:!1,builtin:!0,intercept:!1,targetTable:'åœ°å›¾å…ƒç´ è¡¨',targetColumn:'æ‰€åœ¨åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'æ‰€åœ¨åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'global_detail_location_relation',name:'å…¨å±€è¯¦ç»†åœ°ç‚¹å…³è”',description:'å½“å‰è¯¦ç»†åœ°ç‚¹å¿…é¡»å­˜åœ¨äºä¸–ç•Œåœ°å›¾ç‚¹è¡¨',enabled:!0,builtin:!0,intercept:!1,targetTable:'å…¨å±€æ•°æ®è¡¨',targetColumn:'å½“å‰è¯¦ç»†åœ°ç‚¹',ruleType:'relation',config:{refTable:'ä¸–ç•Œåœ°å›¾ç‚¹',refColumn:'è¯¦ç»†åœ°ç‚¹'},errorMessage:'å½“å‰è¯¦ç»†åœ°ç‚¹å¿…é¡»æ˜¯ä¸–ç•Œåœ°å›¾ç‚¹è¡¨ä¸­å·²å­˜åœ¨çš„è¯¦ç»†åœ°ç‚¹'},{id:'player_base_attributes_keyvalue',name:'ä¸»è§’åŸºæœ¬å±æ€§',description:'åŸºæœ¬å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'åŸºç¡€å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'åŸºç¡€å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'player_special_attributes_keyvalue',name:'ä¸»è§’ç‰¹æœ‰å±æ€§',description:'ç‰¹æœ‰å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'ç‰¹æœ‰å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'ç‰¹æœ‰å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'player_relationships_keyvalue',name:'ä¸»è§’äººé™…å…³ç³»',description:'äººé™…å…³ç³»å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä¸»è§’ä¿¡æ¯',targetColumn:'äººé™…å…³ç³»',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'äººé™…å…³ç³»æ ¼å¼å¿…é¡»ä¸º"è§’è‰²å:å…³ç³»è¯;è§’è‰²å:å…³ç³»è¯"'},{id:'npc_base_attributes_keyvalue',name:'NPCåŸºæœ¬å±æ€§',description:'åŸºæœ¬å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'åŸºç¡€å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'åŸºç¡€å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'npc_special_attributes_keyvalue',name:'NPCç‰¹æœ‰å±æ€§',description:'ç‰¹æœ‰å±æ€§å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼ï¼Œæ•°å€¼èŒƒå›´[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'ç‰¹æœ‰å±æ€§',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'ç‰¹æœ‰å±æ€§æ ¼å¼å¿…é¡»ä¸º"å±æ€§å:æ•°å€¼;å±æ€§å:æ•°å€¼"ï¼Œæ•°å€¼èŒƒå›´[0,100]'},{id:'npc_relationships_keyvalue',name:'NPCäººé™…å…³ç³»',description:'äººé™…å…³ç³»å¿…é¡»ä¸ºé”®å€¼å¯¹æ ¼å¼',enabled:!0,builtin:!0,intercept:!1,targetTable:'é‡è¦äººç‰©è¡¨',targetColumn:'äººé™…å…³ç³»',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'äººé™…å…³ç³»æ ¼å¼å¿…é¡»ä¸º"è§’è‰²å:å…³ç³»è¯;è§’è‰²å:å…³ç³»è¯"'},{id:'quest_progress_format',name:'ä»»åŠ¡è¿›åº¦æ ¼å¼',description:'è¿›åº¦å¿…é¡»ä¸ºæ•°å­—+%æ ¼å¼ï¼Œå¦‚50%',enabled:!0,builtin:!0,intercept:!1,targetTable:'ä»»åŠ¡è¡¨',targetColumn:'è¿›åº¦',ruleType:'format',config:{pattern:'^\\d+%$'},errorMessage:'è¿›åº¦å¿…é¡»ä¸ºæ•°å­—+%æ ¼å¼ï¼ˆå¦‚50%ã€100%ï¼‰'}],q='acu_filter_blacklist_v1',H='acu_filter_blacklist_version',W=['æ—¶é—´','åœ°ç‚¹','å¤‡å¿˜','æ€»ç»“','æ—¥æœŸ','é€‰é¡¹','ä»»åŠ¡','çºªè¦','æœè£…','å¤–è²Œ','å¤´åƒ','å¤–è²Œ','è¿›åº¦','ç¼–ç ','ä¸Šé™','ç»éªŒå€¼','æ¶ˆè€—','æ•°é‡','ç­‰çº§','ä½ç½®','ID','ç¼–å·','ä¸‰å›´','measurements','ages','å¹´é¾„','order','å·ç ','time','cost'],X={getBlacklist(){const e=bt.get(q,null),t=bt.get(H,null);if(!e||!Array.isArray(e))return bt.set(q,[...W]),bt.set(H,T),[...W];if(!t||F(t,T)<0){console.log(`[DICE]BlacklistManager æ£€æµ‹åˆ°é»‘åå•ç‰ˆæœ¬è¾ƒæ—§ (${t||'æ— ç‰ˆæœ¬'})ï¼Œè‡ªåŠ¨åˆå¹¶æ–°ç‰ˆæœ¬`);new Set(e);const n=new Set(W),a=[...W];return e.forEach(e=>{n.has(e)||a.push(e)}),bt.set(q,a),bt.set(H,T),a}return e},setBlacklist:e=>Array.isArray(e)?(bt.set(q,e),bt.set(H,T),!0):(console.warn('[DICE]BlacklistManager è®¾ç½®å¤±è´¥ï¼šå¿…é¡»æ˜¯æ•°ç»„'),!1),resetToDefault:()=>(bt.set(q,[...W]),bt.set(H,T),!0),isBlacklisted(e){if(!e||'string'!=typeof e)return!1;const t=this.getBlacklist();if(0===t.length)return!1;const n=e.split(/>| > /).map(e=>e.trim()).filter(e=>e),a=n.length>0?n[n.length-1]:e;return t.some(e=>a.includes(e))}},J='acu_validation_presets_v1',K='acu_active_preset_id',G={_cache:null,getAllPresets(){const e=bt.get(J,null);if(!e)return this._initDefaultPreset(),this._cache;let t=!1;return e.forEach(e=>{if(!e.version||this._compareVersion(e.version,T)<0){console.log(`[DICE]PresetManager æ£€æµ‹åˆ°é¢„è®¾ "${e.name}" ç‰ˆæœ¬è¾ƒæ—§ (${e.version||'æ— ç‰ˆæœ¬'})ï¼Œè‡ªåŠ¨åˆå¹¶æ–°ç‰ˆæœ¬`);const n=e.rules.filter(e=>!e.builtin),a=new Set(Y.map(e=>e.id||e.targetTable+'_'+e.ruleType)),i=[...Y.map(e=>({...e,builtin:!0}))];n.forEach(e=>{const t=e.id||e.targetTable+'_'+e.ruleType;a.has(t)||i.push({...e,builtin:!1})}),e.rules=i,e.version=T,t=!0}}),t&&(this._save(e),Z.clearCache(),this._cache=null),!t&&this._cache?this._cache:(this._cache=e,e)},getActivePreset(){const e=this.getAllPresets(),t=bt.get(K,'default');return e.find(e=>e.id===t)||e[0]},setActivePreset(e){return!!this.getAllPresets().find(t=>t.id===e)&&(bt.set(K,e),Z.clearCache(),console.log('[DICE]PresetManager åˆ‡æ¢é¢„è®¾:',e),!0)},createPreset(e){const t=this.getAllPresets(),n={id:'preset_'+Date.now(),name:e||'æ–°é¢„è®¾',builtin:!1,rules:[],version:T,createdAt:(new Date).toISOString()};return t.push(n),this._save(t),n},duplicatePreset(e){const t=this.getAllPresets().find(t=>t.id===e);if(!t)return null;const n=this.getAllPresets(),a={id:'preset_'+Date.now(),name:t.name+' (å‰¯æœ¬)',builtin:!1,rules:JSON.parse(JSON.stringify(t.rules)),version:t.version||T,createdAt:(new Date).toISOString()};return n.push(a),this._save(n),console.log('[DICE]PresetManager å¤åˆ¶é¢„è®¾:',t.name,'->',a.name),a},deletePreset(e){const t=this.getAllPresets(),n=t.find(t=>t.id===e);if(!n||'default'===n.id)return!1;const a=t.filter(t=>t.id!==e);return this._save(a),bt.get(K)===e&&(bt.set(K,'default'),Z.clearCache()),console.log('[DICE]PresetManager åˆ é™¤é¢„è®¾:',e),!0},updatePresetRules(e,t){const n=this.getAllPresets(),a=n.find(t=>t.id===e);return!!a&&(a.rules=t,this._save(n),Z.clearCache(),!0)},exportPreset(e){const t=this.getAllPresets().find(t=>t.id===e);if(!t)return null;return JSON.stringify({format:'acu_preset_v1',version:T,preset:{name:t.name,rules:t.rules}},null,2)},_compareVersion:(e,t)=>F(e,t),mergePresetWithDefaults(e){const t=this.getAllPresets(),n=t.find(t=>t.id===e);if(!n)return!1;const a=n.rules.filter(e=>!e.builtin),i=new Set(Y.map(e=>e.id||e.targetTable+'_'+e.ruleType)),o=new Map;Y.forEach(e=>{const t=e.id||e.targetTable+'_'+e.ruleType;o.set(t,e)});const r=[],c=new Set;return Y.forEach(e=>{const t=e.id||e.targetTable+'_'+e.ruleType,a=n.rules.find(e=>(e.id||e.targetTable+'_'+e.ruleType)===t&&e.builtin);if(a){JSON.stringify(a)!==JSON.stringify(e)?r.push({...a,builtin:!0}):r.push({...e,builtin:!0})}else r.push({...e,builtin:!0});c.add(t)}),a.forEach(e=>{const t=e.id||e.targetTable+'_'+e.ruleType;i.has(t)||r.push({...e,builtin:!1})}),n.rules=r,n.version=T,this._save(t),Z.clearCache(),console.log('[DICE]PresetManager åˆå¹¶é¢„è®¾:',n.name),!0},importPreset(e,t=!1){try{const n=JSON.parse(e);if('acu_preset_v1'!==n.format||!n.preset)return null;const a=n.version||'0.0.0',i=this._compareVersion(a,T)<0,o=this.getAllPresets(),r={id:'imported_'+Date.now(),name:n.preset.name||'å¯¼å…¥çš„é¢„è®¾',builtin:!1,rules:n.preset.rules||[],version:a,createdAt:(new Date).toISOString()};return i&&t?(o.push(r),this._save(o),this.mergePresetWithDefaults(r.id),console.log('[DICE]PresetManager å¯¼å…¥å¹¶åˆå¹¶é¢„è®¾:',r.name)):(o.push(r),this._save(o),console.log('[DICE]PresetManager å¯¼å…¥é¢„è®¾:',r.name),i&&console.warn('[DICE]PresetManager é¢„è®¾ç‰ˆæœ¬è¾ƒæ—§ï¼Œå»ºè®®ä½¿ç”¨ mergePresetWithDefaults æ–¹æ³•åˆå¹¶æ–°ç‰ˆæœ¬çš„é»˜è®¤å€¼')),{preset:r,needsMerge:i&&!t}}catch(e){return console.error('[DICE]PresetManager å¯¼å…¥å¤±è´¥:',e),null}},_getBuiltinRulesVersion(){try{const e=JSON.stringify(Y);let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return t.toString(36)}catch(e){return console.error('[DICE]PresetManager è®¡ç®—ç‰ˆæœ¬å¤±è´¥:',e),'0'}},_initDefaultPreset(){const e=this._getBuiltinRulesVersion(),t=bt.get(J,null);if(t&&Array.isArray(t)){const n=t.find(e=>'default'===e.id);if(n&&n._builtinVersion!==e){console.log('[DICE]PresetManager æ£€æµ‹åˆ°å†…ç½®è§„åˆ™æ›´æ–°ï¼Œè‡ªåŠ¨æ›´æ–°é»˜è®¤é¢„è®¾');const a=n.rules.filter(e=>!e.builtin);return n.rules=[...Y.map(e=>({...e})),...a],n._builtinVersion=e,this._cache=t,this._save(t),void bt.set(K,'default')}}const n={id:'default',name:'é»˜è®¤é¢„è®¾',builtin:!0,rules:Y.map(e=>({...e})),version:T,_builtinVersion:e,createdAt:(new Date).toISOString()},a=bt.get('acu_validation_rules_v1',[]);a.length>0&&(n.rules.push(...a.map(e=>({...e,builtin:!1}))),console.log('[DICE]PresetManager è¿ç§»æ—§è§„åˆ™:',a.length,'æ¡')),this._cache=[n],this._save(this._cache),bt.set(K,'default')},resetDefaultPreset(){const e=this.getAllPresets(),t=e.find(e=>'default'===e.id);if(t){const n=t.rules.filter(e=>!e.builtin);return t.rules=[...Y.map(e=>({...e})),...n],t._builtinVersion=this._getBuiltinRulesVersion(),this._save(e),Z.clearCache(),!0}return!1},_save(e){bt.set(J,e),this._cache=e},clearCache(){this._cache=null}},Z={_cache:null,_enabledCache:null,getAllRules(){if(this._cache)return this._cache;const e=G.getActivePreset(),t=this.getEnabledStates(),n=(e?.rules||[]).map(e=>({...e,enabled:void 0!==t[e.id]?t[e.id]:e.enabled}));return this._cache=n,n},getEnabledStates(){return this._enabledCache||(this._enabledCache=bt.get(L,{})),this._enabledCache},toggleRuleEnabled(e,t){const n=this.getEnabledStates();n[e]=t,bt.set(L,n),this._enabledCache=n,this._cache=null},toggleRuleIntercept(e,t){const n=G.getActivePreset();if(!n)return!1;const a=n.rules.find(t=>t.id===e);return!!a&&(a.intercept=t,G.updatePresetRules(n.id,n.rules),!0)},getEnabledRules(){return this.getAllRules().filter(e=>e.enabled)},addCustomRule(e){if(!e.id||!e.name||!e.targetTable)return console.error('[DICE]ValidationRuleManager è§„åˆ™ç¼ºå°‘å¿…è¦å­—æ®µ'),!1;const t=G.getActivePreset();if(!t)return!1;if(t.rules.some(t=>t.id===e.id))return console.error('[DICE]ValidationRuleManager è§„åˆ™ ID å·²å­˜åœ¨:',e.id),!1;const n={...e,builtin:!1,enabled:!0};return t.rules.push(n),G.updatePresetRules(t.id,t.rules),console.log('[DICE]ValidationRuleManager æ·»åŠ è§„åˆ™:',n.name),!0},removeCustomRule(e){const t=G.getActivePreset();if(!t)return!1;const n=t.rules.findIndex(t=>t.id===e);if(-1===n)return!1;t.rules.splice(n,1),G.updatePresetRules(t.id,t.rules);const a=this.getEnabledStates();return delete a[e],bt.set(L,a),this._enabledCache=a,console.log('[DICE]ValidationRuleManager åˆ é™¤è§„åˆ™:',e),!0},updateCustomRule(e,t){const n=G.getActivePreset();if(!n)return!1;const a=n.rules.findIndex(t=>t.id===e);return-1!==a&&(n.rules[a]={...n.rules[a],...t,id:e},G.updatePresetRules(n.id,n.rules),!0)},getRule(e){return this.getAllRules().find(t=>t.id===e)},clearCache(){this._cache=null,this._enabledCache=null},getRulesByTable(e){return this.getEnabledRules().filter(t=>t.targetTable===e)}},Q={_cache:null,_enabledCache:null,_generateId:()=>`regex_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,getAllRules(){if(this._cache)return this._cache;const e=bt.get(N,[]),t=this.getEnabledStates(),n=e.map(e=>({...e,enabled:void 0!==t[e.id]?t[e.id]:e.enabled}));return this._cache=n,n},getEnabledStates(){return this._enabledCache||(this._enabledCache=bt.get(R,{})),this._enabledCache},_saveEnabledStates(e){bt.set(R,e),this._enabledCache=e},getEnabledRules(){return this.getAllRules().filter(e=>!1!==e.enabled)},getApplicableRules(e,t){return this.getEnabledRules().filter(n=>{switch(n.scope.type){case'global':return!0;case'table':return n.scope.tableNames&&n.scope.tableNames.includes(e);case'column':return n.scope.tableNames&&n.scope.tableNames.includes(e)&&n.scope.columnNames&&n.scope.columnNames.includes(t);default:return!1}}).sort((e,t)=>t.priority-e.priority)},toggleRuleEnabled(e,t){const n=this.getEnabledStates();n[e]=t,this._saveEnabledStates(n),this.clearCache()},addCustomRule(e){const t=bt.get(N,[]);if(!e.name||!e.pattern||!e.scope)return console.error('[DICE]RegexTransformationManager: è§„åˆ™ç¼ºå°‘å¿…å¡«å­—æ®µ'),!1;const n={id:this._generateId(),name:e.name,description:e.description,operation:e.operation||'replace',pattern:e.pattern,flags:e.flags||{},replacement:e.replacement,scope:e.scope,enabled:void 0===e.enabled||e.enabled,priority:e.priority||50,executeMode:e.executeMode||'auto',testCases:e.testCases||[],security:e.security||{maxMatchTime:100,maxMatches:1e3,maxInputLength:1e4},createdAt:Date.now(),updatedAt:Date.now()};return t.push(n),bt.set(N,t),this.clearCache(),n},removeRule(e){const t=bt.get(N,[]),n=t.findIndex(t=>t.id===e);return-1!==n&&(t.splice(n,1),bt.set(N,t),this.clearCache(),!0)},updateRule(e,t){const n=bt.get(N,[]),a=n.findIndex(t=>t.id===e);return-1!==a&&(n[a]={...n[a],...t,id:e,updatedAt:Date.now()},bt.set(N,n),this.clearCache(),!0)},getRule(e){return this.getAllRules().find(t=>t.id===e)},clearCache(){this._cache=null,this._enabledCache=null}},ee={_cache:null,getAllPresets(){if(this._cache)return this._cache;const e=bt.get(j,[]);if(0===e.length){const t={id:'regex_default',name:'é»˜è®¤é¢„è®¾',description:'ç³»ç»Ÿé»˜è®¤çš„æ­£åˆ™è½¬æ¢è§„åˆ™é¢„è®¾',version:'1.0.0',rules:[],createdAt:Date.now(),updatedAt:Date.now()};e.push(t),bt.set(j,e)}return this._cache=e,e},getActivePreset(){const e=bt.get(O,'regex_default'),t=this.getAllPresets();return t.find(t=>t.id===e)||t[0]},setActivePreset(e){return this.getAllPresets().find(t=>t.id===e)?(bt.set(O,e),Q.clearCache(),!0):(console.error('[DICE]RegexPresetManager: é¢„è®¾ä¸å­˜åœ¨',e),!1)},createPreset(e,t){const n=this.getAllPresets();if(n.some(t=>t.name===e))return console.error('[DICE]RegexPresetManager: é¢„è®¾åç§°å·²å­˜åœ¨',e),!1;const a=t?n.find(e=>e.id===t):this.getActivePreset(),i={id:`regex_preset_${Date.now()}`,name:e,description:a?.description,version:'1.0.0',rules:a?JSON.parse(JSON.stringify(a.rules)):[],createdAt:Date.now(),updatedAt:Date.now()};return n.push(i),this._save(n),i},updatePresetRules(e,t){const n=this.getAllPresets(),a=n.findIndex(t=>t.id===e);return-1!==a&&(n[a].rules=JSON.parse(JSON.stringify(t)),n[a].updatedAt=Date.now(),this._save(n),e===bt.get(O)&&Q.clearCache(),!0)},deletePreset(e){const t=this.getAllPresets();if(t.length<=1)return console.error('[DICE]RegexPresetManager: ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªé¢„è®¾'),!1;const n=t.findIndex(t=>t.id===e);return-1!==n&&(t.splice(n,1),this._save(t),e===bt.get(O)&&this.setActivePreset(t[0].id),!0)},exportPreset(e){const t=this.getAllPresets().find(t=>t.id===e);return t?JSON.stringify(t,null,2):null},importPreset(e){try{const t=JSON.parse(e);if(!t.name||!Array.isArray(t.rules))return console.error('[DICE]RegexPresetManager: é¢„è®¾æ ¼å¼æ— æ•ˆ'),!1;const n=this.getAllPresets(),a={id:`regex_preset_${Date.now()}`,name:t.name,description:t.description,version:t.version||'1.0.0',rules:t.rules.map(e=>({...e,id:Q._generateId()})),createdAt:Date.now(),updatedAt:Date.now()};return n.push(a),this._save(n),a}catch(e){return console.error('[DICE]RegexPresetManager: å¯¼å…¥é¢„è®¾å¤±è´¥',e),!1}},_save(e){bt.set(j,e),this._cache=e},clearCache(){this._cache=null}},te={_regexCache:new Map,_buildFlags(e){const t=[];return e.caseInsensitive&&t.push('i'),e.global&&t.push('g'),e.multiline&&t.push('m'),e.unicode&&t.push('u'),e.sticky&&t.push('y'),t.join('')},_getRegex(e,t){const n=e.includes('(?<')||e.includes('(?<='),a=e.includes('(?=')||e.includes('(?!');(n||a)&&!t.unicode&&(t={...t,unicode:!0});const i=this._buildFlags(t),o=`${e}/${i}`;if(this._regexCache.has(o)){const e=this._regexCache.get(o);return e.lastIndex=0,e}try{const t=new RegExp(e,i);return this._regexCache.set(o,t),t}catch(t){return console.error('[DICE]RegexTransformationEngine: æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯',e,t),null}},_scoreRegexComplexity(e){let t=0;/(\*|\+|\{)\1{2,}/.test(e)&&(t+=50),/(\.\*|\.\+)[^\[]*\1/.test(e)&&(t+=30);const n=(e.match(/\(/g)||[]).length;return t+=Math.min(5*n,20),t},_getTimeoutForRule(e){const t=this._scoreRegexComplexity(e.pattern),n=e.security?.maxMatchTime||100;return Math.max(n-2*t,50)},_safeReplace(e,t,n){const a=e,i=t.security?.maxInputLength||1e4;if(e.length>i)return{success:!1,oldValue:a,newValue:a,matched:!1,error:`è¾“å…¥é•¿åº¦è¶…è¿‡é™åˆ¶(${i})`};try{const i=this._getTimeoutForRule(t),o=Date.now();let r;switch(t.operation){case'replace':r=e.replace(n,t.replacement||'');break;case'delete':r=e.replace(n,'');break;case'validate':n.test(e);r=e;break;default:r=e}const c=Date.now()-o;if(c>i)return console.warn('[DICE]RegexTransformationEngine: æ­£åˆ™åŒ¹é…è¶…æ—¶',t.pattern,c),{success:!1,oldValue:a,newValue:a,matched:!1,error:`åŒ¹é…è¶…æ—¶(${c}ms > ${i}ms)`};return{success:!0,oldValue:a,newValue:r,matched:a!==r||n.test(a)}}catch(e){return console.error('[DICE]RegexTransformationEngine: æ­£åˆ™æ›¿æ¢é”™è¯¯',t.pattern,e),{success:!1,oldValue:a,newValue:a,matched:!1,error:String(e)}}},applyToValue(e,t){if(null==e)return{success:!0,oldValue:'',newValue:'',matched:!1};const n=String(e);let a=t.pattern,i=t.flags||{};const o=this._extractFlags(a);o.patternWithoutFlags!==a&&(a=o.patternWithoutFlags,i={...i,...o.flags}),void 0===i.global&&(i.global=!0);const r=this._getRegex(a,i);return r?this._safeReplace(n,t,r):{success:!1,oldValue:n,newValue:n,matched:!1,error:'æ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼'}},_extractFlags(e){const t={global:!1,caseInsensitive:!1,multiline:!1,unicode:!1,sticky:!1},n=e.match(/^\/(.+)\/([gimuy]*)$/);if(n){const[,e,a]=n;return a.includes('g')&&(t.global=!0),a.includes('i')&&(t.caseInsensitive=!0),a.includes('m')&&(t.multiline=!0),a.includes('u')&&(t.unicode=!0),a.includes('y')&&(t.sticky=!0),{flags:t,patternWithoutFlags:e}}return{flags:t,patternWithoutFlags:e}},applyToTable(e,t){let n=0;const a=[];try{let i=!1,o=new Map;if('name'in e&&'headers'in e&&'rows'in e){i=!0;const t=e;o.set(t.name,{sheet:t,sheetKey:t.name,name:t.name,headers:t.headers,contentRowIndex:-1})}else{const t=e;Object.keys(t).forEach(e=>{if(!e.startsWith('sheet_'))return;const n=t[e];if(!n||!n.content||!Array.isArray(n.content)||n.content.length<1)return void console.warn(`[DICE]applyToTable: è·³è¿‡æ— æ•ˆè¡¨æ ¼ ${e}`);const a=n.name||e;o.set(a,{sheet:n,sheetKey:e,name:a,headers:n.content[0]||[],contentRowIndex:0})})}if(0===o.size)return console.warn('[DICE]applyToTable: æ²¡æœ‰æœ‰æ•ˆçš„è¡¨æ ¼æ•°æ®'),{totalApplied:0,errors:['æ²¡æœ‰æœ‰æ•ˆçš„è¡¨æ ¼æ•°æ®']};for(const[e,r]of o.entries()){const{sheet:o,headers:c,contentRowIndex:s}=r;for(const r of t){if(!r.enabled)continue;const t=r.scope;if('global'===t.type||t.tableNames?.includes(e))try{if(i){const i=o.rows;for(let o=0;o<i.length;o++){const s=i[o];for(let i=0;i<s.length;i++){const o=c[i];if('column'===t.type&&!t.columnNames?.includes(o))continue;const l=this.applyToValue(s[i],r);l.success?l.matched&&(s[i]=l.newValue,n++):a.push(`${r.name} [${e}]: ${l.error}`)}}}else{const i=o.content;for(let o=1;o<i.length;o++){const s=i[o];if(Array.isArray(s))for(let i=0;i<s.length;i++){const l=c[i];if('column'===t.type&&!t.columnNames?.includes(l))continue;const d=s[i],u=this.applyToValue(d,r);u.success?u.matched&&(s[i]=u.newValue,n++,console.debug(`[DICE]æ­£åˆ™è½¬æ¢: ${e}[${o}].${l}`,`"${u.oldValue}" -> "${u.newValue}"`)):a.push(`${r.name} [${e}]: ${u.error}`)}}}}catch(t){const n=t instanceof Error?t.message:String(t);console.error(`[DICE]applyToTable: å¤„ç†è¡¨æ ¼ ${e} æ—¶å‡ºé”™:`,t),a.push(`${r.name} [${e}]: å¤„ç†è¡¨æ ¼æ—¶å‡ºé”™ - ${n}`)}}}n>0&&console.info(`[DICE]applyToTable: æˆåŠŸåº”ç”¨ ${n} å¤„è½¬æ¢`),a.length>0&&console.warn(`[DICE]applyToTable: é‡åˆ° ${a.length} ä¸ªé”™è¯¯`)}catch(e){const t=e instanceof Error?e.message:String(e);console.error('[DICE]applyToTable: æ‰§è¡Œå¤±è´¥:',e),a.push(`æ‰§è¡Œå¤±è´¥: ${t}`)}return{totalApplied:n,errors:a}},applyToCell(e,t,n,a){const i=Q.getApplicableRules(t,n);if(0===i.length)return{success:!0,oldValue:e||'',newValue:e||'',matched:!1};let o=i;if(a&&(o=i.filter(e=>e.executeMode===a||'auto'===e.executeMode)),0===o.length)return{success:!0,oldValue:e||'',newValue:e||'',matched:!1};let r=e||'',c=!1;for(const e of o){const t=this.applyToValue(r,e);if(!t.success)return t;t.matched&&(c=!0),r=t.newValue}return{success:!0,oldValue:e||'',newValue:r,matched:c}},applyToRow(e,t,n,a){return e.map((e,i)=>{const o=t[i];return this.applyToCell(e,n,o,a).newValue})},previewBatchTransform(e,t){const n=e.name,a=Q.getApplicableRules(n,null).filter(e=>'global'===e.scope.type||e.scope.tableNames?.includes(n)),i=[];for(const t of a){const a=[];let o=0;for(let i=0;i<e.rows.length;i++){const r=e.rows[i];for(let c=0;c<r.length;c++){const s=e.headers[c],l=r[c];if('column'===t.scope.type){if(!t.scope.columnNames?.includes(s)||!t.scope.tableNames?.includes(n))continue}else if('table'===t.scope.type&&!t.scope.tableNames?.includes(n))continue;const d=this.applyToValue(l,t);d.matched&&d.oldValue!==d.newValue&&(a.push({tableName:n,rowIndex:i,columnIndex:c,columnName:s,oldValue:d.oldValue,newValue:d.newValue}),o++)}}o>0&&i.push({rule:t,affectedCells:a,totalAffected:o})}return i},clearRegexCache(){this._regexCache.clear()}},ne={validateFormat(e,t){if(null==e||''===e)return!0;try{return new RegExp(t).test(String(e))}catch(e){return console.error('[DICE]ValidationEngine æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯:',t,e),!0}},validateEnum:(e,t)=>null==e||''===e||(!Array.isArray(t)||0===t.length||t.includes(String(e))),validateNumeric(e,t,n){if(null==e||''===e)return!0;const a=String(e);let i;if(a.endsWith('%'))i=parseFloat(a);else if(a.includes('/')){const e=a.split('/');i=parseFloat(e[0])}else if(a.includes(':')){const e=a.split(':');i=parseFloat(e[e.length-1])}else i=parseFloat(a);return!isNaN(i)&&(!(null!=t&&i<t)&&!(null!=n&&i>n))},validateRelation(e,t,n,a){if(null==e||''===e)return!0;if(!t||!n||!a)return!0;let i=null;for(const e in t)if(t[e]?.name===n){i=t[e];break}if(!i||!i.content||i.content.length<2)return!0;const o=i.content[0],r=String(e),c=Array.isArray(a)?a:[a];for(const e of c){const t=o.indexOf(e);if(-1!==t)for(let e=1;e<i.content.length;e++)if(String(i.content[e][t]||'')===r)return!0}return 0===c.length},validateRequired:e=>null!=e&&''!==String(e).trim(),validateKeyValue(e,t){if(null==e||''===e)return!0;const n=t?.valueType||'text',a=t?.valueMin,i=t?.valueMax;let o=String(e);o=o.replace(/ï¼š/g,':').replace(/ï¼›/g,';').replace(/ï¼Œ/g,';'),o=o.replace(/\s+/g,'');const r=o.split(';').filter(e=>e.trim());if(0===r.length)return!1;for(const e of r){const t=e.indexOf(':');if(-1===t||0===t||t===e.length-1)return!1;const o=e.substring(0,t),r=e.substring(t+1);if(!o||!r)return!1;if('numeric'===n){if(!/^-?\d+(\.\d+)?$/.test(r.trim()))return!1;const e=parseFloat(r);if(isNaN(e))return!1;if(null!=a&&e<a)return!1;if(null!=i&&e>i)return!1}}return!0},validateTableReadonly:(e,t)=>!e||!t||JSON.stringify(e)===JSON.stringify(t),validateRowLimit:(e,t,n)=>!(null!=t&&e<t)&&!(null!=n&&e>n),validateSequence(e,t,n){if(!e||!e.content||e.content.length<2)return!0;if(!t||!n)return!0;const a=e.content[0]||[],i=e.content.slice(1)||[],o=a.indexOf(t);if(o<0)return!0;const r=n.prefix||'',c=void 0!==n.startFrom?n.startFrom:1,s=[],l=[];for(let e=0;e<i.length;e++){const t=i[e]?.[o];if(l.push({rowIndex:e,rawValue:t,type:typeof t}),null==t||''===t)continue;const n=String(t).trim();if(n)if(r){const t=new RegExp(`^${r}(\\d+)$`),a=n.match(t);if(a){const t=parseInt(a[1],10);isNaN(t)||s.push({rowIndex:e,value:n,num:t})}}else{const t=parseInt(n,10);isNaN(t)||s.push({rowIndex:e,value:n,num:t})}}if(0===s.length)return!0;s.sort((e,t)=>e.rowIndex-t.rowIndex);if(new Set(s.map(e=>e.num)).size!==s.length)return!1;for(let e=0;e<s.length;e++){const t=c+e;if(s[e].num!==t)return!1}return!0},checkTableRules(e,t,n){const a=[];if(!e||!t||!n)return a;for(const i of n){if(!i.enabled||!i.intercept)continue;const n=V[i.ruleType];if(!n)continue;let o=null,r=null;for(const t in e)if(e[t]?.name===i.targetTable){o=e[t];break}for(const e in t)if(t[e]?.name===i.targetTable){r=t[e];break}if(r)if('table'===n.scope)if('tableReadonly'===i.ruleType)this.validateTableReadonly(o?.content,r?.content)||a.push({rule:i,tableName:i.targetTable,message:i.errorMessage||`è¡¨ "${i.targetTable}" ä¸ºåªè¯»ï¼Œä¸å…è®¸ä¿®æ”¹`});else if('rowLimit'===i.ruleType){const e=(r.content?.length||1)-1;this.validateRowLimit(e,i.config?.min,i.config?.max)||a.push({rule:i,tableName:i.targetTable,message:i.errorMessage||`è¡¨ "${i.targetTable}" è¡Œæ•° ${e} è¶…å‡ºé™åˆ¶ (${i.config?.min||0}-${i.config?.max||'âˆ'})`})}else'sequence'===i.ruleType&&i.targetColumn&&(this.validateSequence(r,i.targetColumn,i.config||{})||a.push({rule:i,tableName:i.targetTable,message:i.errorMessage||`å­—æ®µ "${i.targetColumn}" çš„ç¼–ç ç´¢å¼•å¿…é¡»ä»${i.config?.prefix||''}${String(i.config?.startFrom||1).padStart(4,'0')}å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤`}));else if('field'===n.scope&&i.targetColumn){const e=(r.content?.[0]||[]).indexOf(i.targetColumn);if(-1===e)continue;for(let n=1;n<(r.content?.length||0);n++){const o=r.content[n],c=o?.[e];if(!this.validateValue(c,i,t)){a.push({rule:i,tableName:i.targetTable,rowIndex:n,columnName:i.targetColumn,currentValue:String(c??''),message:i.errorMessage||`å­—æ®µ "${i.targetColumn}" éªŒè¯å¤±è´¥`});break}}}}return a},validateValue(e,t,n){switch(t.ruleType){case'format':return this.validateFormat(e,t.config?.pattern);case'enum':return this.validateEnum(e,t.config?.values);case'numeric':return this.validateNumeric(e,t.config?.min,t.config?.max);case'relation':return this.validateRelation(e,n,t.config?.refTable,t.config?.refColumn);case'required':return this.validateRequired(e);case'keyValue':return this.validateKeyValue(e,t.config);default:return!0}},validateRow(e,t,n,a,i,o){const r=[],c=e[1]||e[0]||`è¡Œ ${a+1}`;for(const s of i){if(s.targetTable!==n)continue;if(!s.enabled)continue;const i=t.indexOf(s.targetColumn);if(-1===i)continue;const l=e[i];this.validateValue(l,s,o)||r.push({ruleId:s.id,ruleName:s.name,ruleType:s.ruleType,rule:s,tableName:n,rowIndex:a,columnName:s.targetColumn,currentValue:String(l??''),rowTitle:c,errorMessage:s.errorMessage,severity:'error'})}return r},validateAllData(e){if(!e)return[];const t=Z.getEnabledRules();if(0===t.length)return[];const n=[];for(const a in e){if(!a.startsWith('sheet_'))continue;const i=e[a];if(!i?.name||!i?.content||i.content.length<2)continue;const o=i.name,r=i.content[0],c=t.filter(e=>e.targetTable===o);if(0===c.length)continue;for(const e of c){const t=V[e.ruleType];if('table'===t?.scope)if('rowLimit'===e.ruleType){const t=i.content.length-1;this.validateRowLimit(t,e.config?.min,e.config?.max)||n.push({ruleId:e.id,ruleName:e.name,ruleType:e.ruleType,rule:e,tableName:o,rowIndex:-1,columnName:'',currentValue:`${t} è¡Œ`,errorMessage:e.errorMessage||`è¡Œæ•° ${t} è¶…å‡ºé™åˆ¶ (${e.config?.min||0}-${e.config?.max||'âˆ'})`,severity:'warning'})}else if('sequence'===e.ruleType&&e.targetColumn){if(!this.validateSequence(i,e.targetColumn,e.config||{})){const t={ruleId:e.id,ruleName:e.name,ruleType:e.ruleType,rule:e,tableName:o,rowIndex:-1,columnName:e.targetColumn,currentValue:'',errorMessage:e.errorMessage||`å­—æ®µ "${e.targetColumn}" çš„ç¼–ç ç´¢å¼•å¿…é¡»ä»${e.config?.prefix||''}${String(e.config?.startFrom||1).padStart(4,'0')}å¼€å§‹ä¸¥æ ¼é€’å¢ï¼Œä¸å¯è·³å·æˆ–é‡å¤`,severity:'error'};n.push(t)}}}const s=c.filter(e=>'table'!==V[e.ruleType]?.scope);for(let t=1;t<i.content.length;t++){const a=i.content[t],c=this.validateRow(a,r,o,t-1,s,e);n.push(...c)}}return n},validateTable(e,t){if(!e)return[];const n=Z.getRulesByTable(t);if(0===n.length)return[];let a=null;for(const n in e)if(e[n]?.name===t){a=e[n];break}if(!a||!a.content||a.content.length<2)return[];const i=a.content[0],o=[];for(let r=1;r<a.content.length;r++){const c=a.content[r],s=this.validateRow(c,i,t,r-1,n,e);o.push(...s)}return o},groupErrorsByTable(e){const t={};for(const n of e)t[n.tableName]||(t[n.tableName]=[]),t[n.tableName].push(n);return t},getErrorCount(e){return this.validateAllData(e).length}},ae={DB_NAME:'acu_local_avatars',STORE_NAME:'avatars',DB_VERSION:1,_db:null,_urlCache:new Map,async init(){return this._db?this._db:new Promise((e,t)=>{const n=indexedDB.open(this.DB_NAME,this.DB_VERSION);n.onerror=()=>{console.error('[DICE]LocalAvatarDB æ‰“å¼€æ•°æ®åº“å¤±è´¥:',n.error),t(n.error)},n.onsuccess=()=>{this._db=n.result,e(this._db)},n.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.STORE_NAME)||t.createObjectStore(this.STORE_NAME,{keyPath:'name'})}})},async save(e,t){if(!e||!t)return!1;try{const n=await this.init();return new Promise((a,i)=>{const o=n.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME);this._urlCache.has(e)&&(URL.revokeObjectURL(this._urlCache.get(e)),this._urlCache.delete(e));const r={name:e,blob:t,size:t.size,type:t.type,updatedAt:Date.now()},c=o.put(r);c.onsuccess=()=>a(!0),c.onerror=()=>{console.error('[DICE]LocalAvatarDB ä¿å­˜å¤±è´¥:',c.error),i(c.error)}})}catch(e){return console.error('[DICE]LocalAvatarDB save error:',e),!1}},async get(e){if(!e)return null;if(this._urlCache.has(e))return this._urlCache.get(e);try{const t=await this.init();return new Promise(n=>{const a=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).get(e);a.onsuccess=()=>{const t=a.result;if(t&&t.blob){const a=URL.createObjectURL(t.blob);this._urlCache.set(e,a),n(a)}else n(null)},a.onerror=()=>n(null)})}catch(e){return console.error('[DICE]LocalAvatarDB get error:',e),null}},async has(e){if(!e)return!1;try{const t=await this.init();return new Promise(n=>{const a=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getKey(e);a.onsuccess=()=>n(void 0!==a.result),a.onerror=()=>n(!1)})}catch(e){return!1}},async delete(e){if(!e)return!1;try{this._urlCache.has(e)&&(URL.revokeObjectURL(this._urlCache.get(e)),this._urlCache.delete(e));const t=await this.init();return new Promise(n=>{const a=t.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).delete(e);a.onsuccess=()=>n(!0),a.onerror=()=>n(!1)})}catch(e){return console.error('[DICE]LocalAvatarDB delete error:',e),!1}},async getAllNames(){try{const e=await this.init();return new Promise(t=>{const n=e.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAllKeys();n.onsuccess=()=>t(n.result||[]),n.onerror=()=>t([])})}catch(e){return[]}},async getStats(){try{const e=await this.init();return new Promise(t=>{const n=e.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAll();n.onsuccess=()=>{const e=n.result||[],a=e.reduce((e,t)=>e+(t.size||0),0);t({count:e.length,totalSize:a,totalSizeMB:(a/1024/1024).toFixed(2)})},n.onerror=()=>t({count:0,totalSize:0,totalSizeMB:'0'})})}catch(e){return{count:0,totalSize:0,totalSizeMB:'0'}}},async clearAll(){try{this._urlCache.forEach(e=>URL.revokeObjectURL(e)),this._urlCache.clear();const e=await this.init();return new Promise(t=>{const n=e.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).clear();n.onsuccess=()=>t(!0),n.onerror=()=>t(!1)})}catch(e){return console.error('[DICE]LocalAvatarDB clearAll error:',e),!1}}},ie=()=>{const e=Je||('function'==typeof ln?ln():null);if(e)for(const t in e){const n=e[t];if(n?.name?.includes('ä¸»è§’')&&n.content?.[1]?.[1])return n.content[1][1]}return null},oe=()=>{try{const e=window.parent||window;if(e.SillyTavern?.getContext){const t=e.SillyTavern.getContext();if(t?.name1)return t.name1}if('undefined'!=typeof name1&&name1)return name1;if(e.name1)return e.name1;const $=e.jQuery||window.jQuery;if($){const e=$('#user_avatar_block .avatar-name, #persona_name_input').first();if(e.length){const t=e.val?.()||e.text?.();if(t&&t.trim())return t.trim()}}}catch(e){console.warn('[DICE]ACU getPersonaName error:',e)}return null},re=()=>oe()||ie()||'ä¸»è§’',ce=e=>{if(!e||'string'!=typeof e)return e;const t=re();let n=e.replace(/<user>/gi,t);return n=n.replace(/\{\{user\}\}/gi,t),n},se={_cache:null,load(){if(!this._cache){const e=bt.get(M,{});this._cache={};for(const t in e)'string'==typeof e[t]?this._cache[t]={url:e[t],offsetX:50,offsetY:50,scale:150,aliases:[]}:this._cache[t]={url:e[t].url||'',offsetX:e[t].offsetX??50,offsetY:e[t].offsetY??50,scale:e[t].scale??150,aliases:e[t].aliases||[]}}return this._cache},save(){bt.set(M,this._cache||{}),this._cache=null},get(e){const t=this.load()[e];if(t&&t.url)return t.url;for(const t in this._cache)if(this._cache[t].aliases&&this._cache[t].aliases.includes(e)&&this._cache[t].url)return this._cache[t].url;return null},async getAsync(e){if(!e)return null;const t=ie(),n='<user>'===e||'ä¸»è§’'===e||t&&e===t,a=await ae.get(e);if(a)return a;if(n&&'<user>'!==e){const e=await ae.get('<user>');if(e)return e}const i=this.getPrimaryName(e);if(i!==e){const e=await ae.get(i);if(e)return e}return this.get(e)},async hasLocalAvatar(e){if(!e)return!1;if(await ae.has(e))return!0;const t=this.getPrimaryName(e);return t!==e&&await ae.has(t)},saveLocalAvatar:async(e,t)=>await ae.save(e,t),deleteLocalAvatar:async e=>await ae.delete(e),getOffsetX(e){const t=this._resolveByAlias(e);return t?t.offsetX??50:50},getOffsetY(e){const t=this._resolveByAlias(e);return t?t.offsetY??50:50},getScale(e){const t=this._resolveByAlias(e);return t?t.scale??150:150},_resolveByAlias(e){const t=this.load()[e];if(t)return t;for(const t in this._cache)if(this._cache[t].aliases&&this._cache[t].aliases.includes(e))return this._cache[t];return null},getPrimaryName(e){if(this.load()[e])return e;for(const t in this._cache)if(this._cache[t].aliases&&this._cache[t].aliases.includes(e))return t;return e},set(e,t,n=50,a=50,i=150,o=[]){this.load()[e]={url:t,offsetX:n,offsetY:a,scale:i,aliases:o},this.save()},setPosition(e,t,n){const a=this.load()[e];a&&(a.offsetX=t,a.offsetY=n,this.save())},setScale(e,t){const n=this.load()[e];n&&(n.scale=t,this.save())},setAliases(e,t){const n=this.load()[e];n&&(n.aliases=t,this.save())},remove(e){delete this.load()[e],this.save()},getAll(){return this.load()},exportData(){return{version:1,exportTime:(new Date).toISOString(),avatars:this.load()}},importData(e,t=!0){if(!e||!e.avatars)throw new Error('æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼');const n=this.load(),a={added:0,updated:0,skipped:0};for(const i in e.avatars){const o=e.avatars[i];o.url&&(n[i]?t?(n[i]={url:o.url,offsetX:o.offsetX??50,offsetY:o.offsetY??50,scale:o.scale??150,aliases:o.aliases||[]},a.updated++):a.skipped++:(n[i]={url:o.url,offsetX:o.offsetX??50,offsetY:o.offsetY??50,scale:o.scale??150,aliases:o.aliases||[]},a.added++))}return this.save(),a},analyzeImport(e){if(!e||!e.avatars)return{valid:!1,error:'æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼'};const t=this.load(),n={valid:!0,total:0,newItems:[],conflicts:[]};for(const a in e.avatars)e.avatars[a].url&&(n.total++,t[a]?n.conflicts.push(a):n.newItems.push(a));return n}},le=t=>{if(!t)return null;for(const[n,a]of e)if(n.test(t))return a;return null},de=(e,n)=>{if(!e&&!n)return null;for(const[n,a]of t)if(e&&n.test(e))return a;for(const[e,a]of t)if(n&&e.test(n))return a;return null},ue=function(){const e='__mvu__';let t=null;function n(){if(t&&t._source)return t._source;const e=window.eventEmit||window.parent?.eventEmit,n=window.eventOn||window.parent?.eventOn;return'function'==typeof e&&'function'==typeof n?(console.log('[DICE]MvuModule æ™ºèƒ½æ£€æµ‹åˆ° ERA æ¡†æ¶'),'era'):void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData?(console.log('[DICE]MvuModule æ™ºèƒ½æ£€æµ‹åˆ° MVU æ¡†æ¶'),'mvu'):(console.log('[DICE]MvuModule æœªæ£€æµ‹åˆ°æ¡†æ¶ï¼Œé»˜è®¤ä½¿ç”¨ MVU æ¨¡å¼'),'mvu')}async function a(){return new Promise(e=>{const n=setTimeout(()=>{console.warn('[DICE]MvuModule ERAæŸ¥è¯¢è¶…æ—¶'),e(null)},5e3),a=window.eventEmit||window.parent?.eventEmit,i=window.eventOn||window.parent?.eventOn,o=window.eventOff||window.parent?.eventOff,r=a=>{if(clearTimeout(n),'function'==typeof o)try{o('era:queryResult',r)}catch(e){console.warn('[DICE]MvuModule ç§»é™¤äº‹ä»¶ç›‘å¬å¤±è´¥:',e)}if(console.log('[DICE]MvuModule æ”¶åˆ°ERAæŸ¥è¯¢ç»“æœ:',JSON.stringify(a,null,2)),console.log('[DICE]MvuModule detail.result:',JSON.stringify(a.result,null,2)),a.result&&a.result.error)return console.error('[DICE]MvuModule ERAæŸ¥è¯¢å¤±è´¥:',a.result.error),void e(null);const i=a.result?.statWithoutMeta||null;console.log('[DICE]MvuModule æå–çš„ stat_data:',JSON.stringify(i,null,2));const c={stat_data:i,delta_data:{},schema:null,_source:'era'};t=c,e(c)};try{if(console.log('[DICE]MvuModule å¼€å§‹è·å–ERAæ•°æ®...'),console.log('[DICE]MvuModule ERA API æ£€æŸ¥:',{eventEmit:'function'==typeof a,eventOn:'function'==typeof i,eventOff:'function'==typeof o}),'function'!=typeof i)return console.error('[DICE]MvuModule eventOn ä¸å¯ç”¨'),clearTimeout(n),void e(null);if('function'!=typeof a)return console.error('[DICE]MvuModule eventEmit ä¸å¯ç”¨'),clearTimeout(n),void e(null);i('era:queryResult',r),a('era:getCurrentVars')}catch(t){clearTimeout(n),console.error('[DICE]MvuModule ERA APIè°ƒç”¨å¤±è´¥:',t),e(null)}})}function i(e){return String(e??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}function o(){if('era'===n()){const e=window.eventEmit||window.parent?.eventEmit,t=window.eventOn||window.parent?.eventOn;return'function'==typeof e&&'function'==typeof t}return void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData}function r(){if(console.warn('[DICE]è­¦å‘Š: getData() æ˜¯åŒæ­¥å‡½æ•°ï¼Œå¯èƒ½æ— æ³•æ­£ç¡®è·å– MVU æ•°æ®ã€‚å»ºè®®ä½¿ç”¨ getDataWithRetry()'),t)return t;try{if(void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData){const e=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(e&&e.stat_data){const n={stat_data:e.stat_data||null,display_data:e.display_data||{},delta_data:e.delta_data||{},schema:e.schema||null,_source:'mvu'};return t=n,n}}}catch(e){console.warn('[DICE]åŒæ­¥è·å– MVU æ•°æ®å¤±è´¥:',e)}return null}async function c(e=3,n=500){try{if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)try{await Promise.race([waitGlobalInitialized('Mvu'),new Promise((_,e)=>setTimeout(()=>e(new Error('ç­‰å¾… MVU åˆå§‹åŒ–è¶…æ—¶')),3e3))])}catch(e){console.warn('[DICE]ç­‰å¾… MVU åˆå§‹åŒ–å¤±è´¥ï¼Œå°è¯•ç›´æ¥è·å–:',e.message)}for(let a=1;a<=e;a++){try{if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)throw new Error('MVU API ä¸å¯ç”¨');const e=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(e&&e.stat_data){const n={stat_data:e.stat_data||null,display_data:e.display_data||{},delta_data:e.delta_data||{},schema:e.schema||null,_source:'mvu'};return t=n,console.log('[DICE]MVU æ•°æ®è·å–æˆåŠŸ'),n}}catch(t){console.warn(`[DICE]MVU æ•°æ®è·å–å¤±è´¥ (å°è¯• ${a}/${e}):`,t)}a<e&&await new Promise(e=>setTimeout(e,n))}return null}catch(e){return console.error('[DICE]MVU åˆå§‹åŒ–å¤±è´¥:',e),null}}function s(e){return Array.isArray(e)&&2===e.length&&'string'==typeof e[1]&&('number'==typeof e[0]||'string'==typeof e[0]||'boolean'==typeof e[0])}function l(e){return!!Array.isArray(e)&&e.every(e=>'string'==typeof e||'number'==typeof e||'boolean'==typeof e||null===e)}function d(e){return Array.isArray(e)?s(e)?0:e.length:e&&'object'==typeof e?Object.keys(e).filter(e=>!e.startsWith('$')).length:0}function u(e,t=!1){if(null==e)return'';if(t||Array.isArray(e))return s(e)?String(e[0]):l(e)?e.map(e=>String(e??'')).join(', '):String(e);const n=String(e).trim();if(/^-?\d+(\.\d+)?%?$/.test(n))return n;const a=n.match(/^(-?\d+(?:\.\d+)?%?)(,\s*\[[^\]]+\])?\s+/);if(a)return a[2]?a[1]+a[2].trim():a[1];const i=n.match(/^(-?\d+(?:\.\d+)?%?\/-?\d+(?:\.\d+)?%?),/);if(i)return i[1];const o=n.match(/^(-?\d+(?:\.\d+)?%?),/);if(o)return o[1];const r=n.match(/^(-?\d+(?:\.\d+)?%?)\s+[^\d]/);return r?r[1]:n}function p(e){if(!e)return 0;const t=String(e).trim().match(/^(-?\d+(?:\.\d+)?)/);if(t){const e=parseFloat(t[1]);return isNaN(e)?0:e}return 0}function g(e,t,n,a){const o=function(e,t){if(!t||!e)return'';const n=e.split('.');let a=t;for(const e of n){if(null==a)return'';a=a[e]}if(!a)return'';if('string'==typeof a&&a.includes('->')){const e=a.match(/^(-?[\d.]+)->(-?[\d.]+)/);if(e){const t=parseFloat(e[1]),n=parseFloat(e[2]);if(!isNaN(t)&&!isNaN(n))return n>t?'â†‘':n<t?'â†“':''}return'â€¢'}return''}(n,a),r=o?'mvu-changed':'';let c,d='mvu-value';s(t)?c=String(t[0]):l(t)?(c=t.map(e=>String(e??'')).join(', '),d+=' mvu-array-value'):c=u(t??'',!1);let g='';try{if('function'==typeof De&&De(c)){const t=p(c);if(t>0){let a=e;if(e.includes('.')){const t=e.split('.');a=t[t.length-1]}if(n&&n.includes('.')){const t=n.split('.'),i=t[t.length-1];i&&!/^\d+$/.test(i)&&i!==e&&(a=i)}g=`<i class="fa-solid fa-dice-d20 mvu-dice-icon" data-path="${i(n)}" data-attr-name="${i(a)}" data-attr-value="${t}" style="cursor:pointer;color:var(--acu-accent);opacity:0.6;font-size:calc(var(--acu-font-size, 13px) * 0.85);flex-shrink:0;" title="å¿«æ·æŠ•éª°"></i>`}}}catch(e){console.warn('[DICE]MvuModule renderRow: åˆ¤æ–­æ•°å­—æ—¶å‡ºé”™',e)}return`\n                <div class="mvu-row ${r}">\n                    <div class="mvu-key">${i(e)}</div>\n                    <div class="mvu-value-wrap">\n                        <span class="${d}" data-path="${i(n)}">${i(c)}</span>\n                        ${g}\n                        ${o?`<span class="mvu-change-indicator">${o}</span>`:''}\n                    </div>\n                </div>\n            `}function f(e,t,n,a,o,r,c){const u=d(t),p=r?'':'collapsed';let b='',m=!1,h=0,v=0;if(!Array.isArray(t)||s(t)||l(t)){if(t&&'object'==typeof t&&!s(t)){const e=Object.entries(t).filter(([e])=>!e.startsWith('$'));for(const[t,i]of e){const e=n?`${n}.${t}`:t;!i||'object'!=typeof i||s(i)||l(i)?(v++,b+=g(t,i,e,a)):(m=!0,h++,b+=f(t,i,e,a,o+1,!1,c))}}}else t.forEach((e,t)=>{const i=`${n}[${t}]`;!e||'object'!=typeof e||s(e)||l(e)?(v++,b+=g(`[${t}]`,e,i,a)):(m=!0,h++,b+=f(`[${t}]`,e,i,a,o+1,!1,c))});const x=Array.isArray(t)?`[${u}]`:`(${u})`,y=c&&m?'mvu-card-body horizontal-nested':'mvu-card-body';let w=!1;if(c&&m&&0===o)if(!Array.isArray(t)||s(t)||l(t)){if(t&&'object'==typeof t&&!s(t)){const e=Object.entries(t).filter(([e])=>!e.startsWith('$'));for(const[t,n]of e)if(n&&'object'==typeof n&&!s(n)&&!l(n)){d(n)>=2&&(w=!0)}}}else t.forEach(e=>{if(e&&'object'==typeof e&&!s(e)&&!l(e)){d(e)>=2&&(w=!0)}});return`\n                <div class="mvu-card${c&&m&&(0===o&&(h>=2&&v<=1||w)||o>0&&0===v&&h>=2)?' has-nested-cards':''} ${p}" data-path="${i(n)}" data-depth="${o}">\n                    <div class="mvu-card-header">\n                        <div class="mvu-card-title">\n                            <span>${i(e)}</span>\n                            <span class="mvu-card-count">${x}</span>\n                        </div>\n                        <span class="mvu-card-toggle">â–¼</span>\n                    </div>\n                    <div class="${y}">\n                        ${b}\n                    </div>\n                </div>\n            `}return{MODULE_ID:e,isAvailable:o,getData:r,getDataWithRetry:async function(e=3,n=500){try{const i=await async function(){const e=window.eventEmit||window.parent?.eventEmit,t=window.eventOn||window.parent?.eventOn;if('function'==typeof e&&'function'==typeof t)try{const e=await Promise.race([a(),new Promise((_,e)=>setTimeout(()=>e(new Error('ERA timeout')),2e3))]);if(e&&e.stat_data)return console.log('[DICE]æ£€æµ‹åˆ° ERA æ¡†æ¶ä¸”æ•°æ®å¯ç”¨'),{mode:'era',data:e}}catch(e){console.warn('[DICE]ERA æ¡†æ¶å­˜åœ¨ä½†æ•°æ®ä¸å¯ç”¨:',e.message)}try{if(await waitGlobalInitialized('Mvu'),void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData){const e=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(e&&e.stat_data)return console.log('[DICE]æ£€æµ‹åˆ° MVU æ¡†æ¶ä¸”æ•°æ®å¯ç”¨'),{mode:'mvu',data:{stat_data:e.stat_data||null,display_data:e.display_data||{},delta_data:e.delta_data||{},schema:e.schema||null,_source:'mvu'}}}}catch(e){console.warn('[DICE]MVU æ¡†æ¶æ£€æµ‹å¤±è´¥:',e)}return console.warn('[DICE]æœªæ£€æµ‹åˆ°å¯ç”¨çš„å˜é‡æ¡†æ¶ï¼Œé»˜è®¤ä½¿ç”¨ MVU æ¨¡å¼'),{mode:'mvu',data:null}}();if(i.data)return t=i.data,i.data;if('era'===i.mode){for(let i=1;i<=e;i++){try{const e=await a();if(e&&e.stat_data)return t=e,e}catch(t){console.warn(`[DICE]ERA æ•°æ®è·å–å¤±è´¥ (å°è¯• ${i}/${e}):`,t)}i<e&&await new Promise(e=>setTimeout(e,n))}return console.warn('[DICE]ERA æ•°æ®è·å–å¤±è´¥ï¼Œå°è¯•é™çº§åˆ° MVU'),await c(e,n)}return await c(e,n)}catch(e){return console.error('[DICE]æ•°æ®è·å–å¤±è´¥:',e),null}},diagnoseVariableFramework:async function(){const e={timestamp:(new Date).toISOString(),era:{available:!1,eventEmit:'function'==typeof(window.eventEmit||window.parent?.eventEmit),eventOn:'function'==typeof(window.eventOn||window.parent?.eventOn),dataAvailable:!1,error:null},mvu:{available:!1,apiExists:void 0!==window.Mvu,getDataExists:'function'==typeof window.Mvu?.getMvuData,dataAvailable:!1,error:null},cache:{hasCache:!!t,cacheKeys:t?Object.keys(t):[]},recommendation:''};if(e.era.eventEmit&&e.era.eventOn)try{const t=await Promise.race([a(),new Promise((_,e)=>setTimeout(()=>e(new Error('Timeout')),2e3))]);e.era.available=!0,e.era.dataAvailable=!(!t||!t.stat_data)}catch(t){e.era.error=t.message}if(e.mvu.apiExists&&e.mvu.getDataExists)try{await Promise.race([waitGlobalInitialized('Mvu'),new Promise((_,e)=>setTimeout(()=>e(new Error('ç­‰å¾…è¶…æ—¶')),2e3))]);const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});e.mvu.available=!0,e.mvu.dataAvailable=!(!t||!t.stat_data)}catch(t){e.mvu.error=t.message}return e.era.dataAvailable?e.recommendation='ERA æ¡†æ¶å¯ç”¨ä¸”æ•°æ®æ­£å¸¸':e.mvu.dataAvailable?e.recommendation='MVU æ¡†æ¶å¯ç”¨ä¸”æ•°æ®æ­£å¸¸':e.era.available||e.mvu.available?e.recommendation='æ¡†æ¶å·²å®‰è£…ä½†æ•°æ®ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥è§’è‰²å¡æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–å˜é‡':e.recommendation='æœªæ£€æµ‹åˆ°ä»»ä½•å˜é‡æ¡†æ¶ï¼Œè¯·ç¡®è®¤å·²å®‰è£… MVU æˆ– ERA æ’ä»¶',e},injectStyles:function(){const e=window.parent?.document||document;if(e.getElementById('mvu-module-styles'))return;const t=e.createElement('style');t.id='mvu-module-styles',t.textContent='\n            /* MVU é¢æ¿å®¹å™¨ */\n            .acu-mvu-panel {\n                height: 100%;\n                display: flex;\n                flex-direction: column;\n                min-height: 300px; /* ç¡®ä¿é¢æ¿æœ‰è¶³å¤Ÿçš„æœ€å°é«˜åº¦ï¼Œé¿å…æ˜¾ç¤ºä¸ºç™½æ¡ */\n                overflow: hidden; /* ä¸åœ¨è¿™é‡Œæ»šåŠ¨ï¼Œè®©çˆ¶å®¹å™¨å¤„ç† */\n            }\n            .acu-mvu-panel .acu-panel-header {\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                padding: 10px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                flex-shrink: 0;\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title i {\n                color: var(--acu-accent);\n            }\n            .acu-mvu-panel .acu-header-actions {\n                display: flex;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn {\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                padding: 5px 10px;\n                font-size: 13px;\n                border-radius: 4px;\n                transition: all 0.2s;\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n            .acu-mvu-panel .mvu-header-btn.active {\n                background: var(--acu-accent);\n                color: #fff;\n                border-color: var(--acu-accent);\n            }\n            /* [æ–°å¢] æ•°å€¼æ¨¡å¼æ ·å¼ */\n            .mvu-numeric-mode {\n                padding: 0;\n            }\n            .mvu-numeric-level-controls {\n                position: sticky;\n                top: 0;\n                z-index: 10;\n            }\n            /* [æ–°å¢] å¯æŠ˜å å±‚çº§æ§åˆ¶æ ·å¼ */\n            .mvu-level-controls-collapsible {\n                margin-bottom: 8px;\n            }\n            .mvu-level-controls-header {\n                transition: background 0.2s;\n            }\n            .mvu-level-controls-header:hover {\n                background: var(--acu-table-hover) !important;\n            }\n            .mvu-level-controls-body {\n                overflow-y: auto;\n                overflow-x: hidden;\n                transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, border-bottom 0.3s ease-out;\n                max-height: 300px; /* é™åˆ¶æœ€å¤§é«˜åº¦ï¼Œè¶…å‡ºæ—¶å¯æ»šåŠ¨ */\n                scrollbar-width: thin;\n            }\n            /* ç§»åŠ¨ç«¯ä½¿ç”¨æ›´å°çš„æœ€å¤§é«˜åº¦ */\n            @media (max-width: 768px) {\n                .mvu-level-controls-body {\n                    max-height: 200px;\n                }\n            }\n            .mvu-level-controls-body::-webkit-scrollbar {\n                width: 6px;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-track {\n                background: transparent;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-thumb {\n                background: var(--acu-border);\n                border-radius: 3px;\n            }\n            .mvu-level-controls-body::-webkit-scrollbar-thumb:hover {\n                background: var(--acu-text-sub);\n            }\n            .mvu-level-controls-collapsible.collapsed .mvu-level-controls-body {\n                max-height: 0 !important;\n                padding-top: 0 !important;\n                padding-bottom: 0 !important;\n                border-bottom: none !important;\n                margin: 0 !important;\n            }\n            .mvu-level-controls-toggle-icon {\n                transition: transform 0.3s ease-out;\n            }\n            .mvu-level-controls-collapsible.collapsed .mvu-level-controls-toggle-icon {\n                transform: rotate(-90deg);\n            }\n            .mvu-numeric-items {\n                max-height: calc(100vh - 200px);\n                overflow-y: auto;\n            }\n            .mvu-numeric-item {\n                transition: background 0.2s;\n            }\n            .mvu-numeric-item:hover {\n                background: var(--acu-table-hover) !important;\n            }\n            .mvu-dice-icon {\n                transition: opacity 0.2s, transform 0.2s;\n            }\n            .mvu-dice-icon:hover {\n                opacity: 1 !important;\n                transform: scale(1.1);\n            }\n            .mvu-level-toggle:hover {\n                opacity: 1 !important;\n            }\n            .mvu-level-toggle[data-visible="true"]:hover {\n                background: var(--acu-accent) !important;\n                color: #fff !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .mvu-level-toggle[data-visible="false"]:hover,\n            .mvu-level-toggle[data-visible=""]:hover {\n                background: var(--acu-table-hover) !important;\n                color: var(--acu-text-sub) !important;\n                border-color: var(--acu-border) !important;\n            }\n\n            /* MVU å†…å®¹åŒº - å§‹ç»ˆä½¿ç”¨ç«–å‘æ»šåŠ¨æ¨¡å¼ */\n            .mvu-content {\n                display: flex;\n                flex-direction: column;\n                overflow-x: hidden;\n                overflow-y: auto; /* ç›´æ¥åœ¨å†…å®¹åŒºå¯ç”¨æ»šåŠ¨ */\n                flex: 1 1 auto;\n                min-height: 0; /* å…³é”®ï¼šå…è®¸ flex å­é¡¹ç¼©å°ä»¥å¯ç”¨æ»šåŠ¨ */\n                max-height: 100%; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºçˆ¶å®¹å™¨ */\n                padding: 12px;\n                scrollbar-width: thin;\n            }\n            .mvu-content::-webkit-scrollbar {\n                display: none;\n            }\n            .mvu-content .mvu-card {\n                flex: 0 0 auto; /* ä¸æ‹‰ä¼¸ï¼Œä¿æŒè‡ªç„¶é«˜åº¦ */\n                min-width: 100%;\n                max-width: 100%;\n                width: 100%;\n            }\n            /* MVUé¢æ¿å§‹ç»ˆæ”¯æŒæ»šåŠ¨ */\n            .acu-mvu-panel {\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                flex: 1 1 0; /* å…³é”®ï¼šä½¿ç”¨ flex-basis: 0 è®©å®¹å™¨å¯ä»¥æ­£ç¡®è®¡ç®—æ»šåŠ¨ */\n                min-height: 300px; /* ç¡®ä¿é¢æ¿æœ‰è¶³å¤Ÿçš„æœ€å°é«˜åº¦ï¼Œé¿å…æ˜¾ç¤ºä¸ºç™½æ¡ */\n            }\n\n            /* MVU å¡ç‰‡ */\n            .mvu-card {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 10px;\n                overflow: hidden;\n            }\n            .mvu-card:last-child {\n                margin-bottom: 0;\n            }\n            .mvu-card-header {\n                background: var(--acu-table-head);\n                padding: 8px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.2s;\n            }\n            .mvu-card-header:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-card-title {\n                font-weight: 600;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .mvu-card-count {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: normal;\n            }\n            .mvu-card-toggle {\n                color: var(--acu-text-sub);\n                font-size: 10px;\n                transition: transform 0.2s;\n            }\n            .mvu-card.collapsed .mvu-card-toggle {\n                transform: rotate(-90deg);\n            }\n            .mvu-card-body {\n                padding: 8px 12px;\n                display: block;\n                overflow: hidden; /* ä¸º slideUp/slideDown åŠ¨ç”»æä¾›æ”¯æŒ */\n            }\n            .mvu-card.collapsed .mvu-card-body {\n                display: none;\n            }\n\n            /* åµŒå¥—å¡ç‰‡ */\n            .mvu-card .mvu-card {\n                background: var(--acu-table-head);\n                margin: 6px 0;\n            }\n            .mvu-card .mvu-card .mvu-card-header {\n                background: rgba(128,128,128,0.1);\n                padding: 6px 10px;\n            }\n            .mvu-card .mvu-card .mvu-card-body {\n                padding: 6px 10px;\n            }\n\n            /* åµŒå¥—å¡ç‰‡æ¨ªå‘å¸ƒå±€ - åªå¯¹åµŒå¥—å¡ç‰‡ç”Ÿæ•ˆï¼Œé”®å€¼å¯¹ä¿æŒæ­£å¸¸å—çº§æ˜¾ç¤º */\n            .mvu-card-body.horizontal-nested {\n                display: flex;\n                flex-direction: row;\n                flex-wrap: nowrap;\n                gap: 12px;\n                overflow-x: auto;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: touch;\n                padding-bottom: 8px;\n                align-items: flex-start;\n            }\n            /* å¦‚æœçˆ¶å¡ç‰‡æœ‰ has-nested-cards ç±»ï¼Œä½¿ç”¨ wrap å¸ƒå±€ï¼Œè®©é”®å€¼å¯¹å’ŒåµŒå¥—å¡ç‰‡å¯ä»¥æ¢è¡Œ */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested {\n                flex-wrap: wrap;\n            }\n            /* é”®å€¼å¯¹è¡Œä¿æŒæ­£å¸¸å—çº§æ˜¾ç¤ºï¼Œå æ»¡ä¸€è¡Œ */\n            .mvu-card-body.horizontal-nested > .mvu-row {\n                display: flex;\n                flex: 0 0 100%;\n                width: 100%;\n                max-width: 100%; /* ç¡®ä¿ä¸è¶…è¿‡å®¹å™¨å®½åº¦ */\n                box-sizing: border-box;\n            }\n            /* å¦‚æœçˆ¶å¡ç‰‡æœ‰ has-nested-cards ç±»ï¼Œé”®å€¼å¯¹åº”è¯¥æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ï¼Œä½†ä»ç„¶å æ»¡ä¸€è¡Œ */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                flex: 0 0 auto; /* æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */\n                min-width: 100%; /* ç¡®ä¿å æ»¡ä¸€è¡Œ */\n                width: auto; /* æ ¹æ®å†…å®¹è‡ªé€‚åº”å®½åº¦ */\n                max-width: 450px; /* é™åˆ¶é”®å€¼å¯¹çš„æœ€å¤§å®½åº¦ï¼Œé¿å…å ç”¨è¿‡å¤šæ¨ªå‘ç©ºé—´ */\n                box-sizing: border-box;\n            }\n            @media (min-width: 769px) {\n                .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                    max-width: 550px; /* å¤§å±å¹•ä¸‹ä¹Ÿé™åˆ¶é”®å€¼å¯¹çš„æœ€å¤§å®½åº¦ */\n                }\n            }\n            /* åªæœ‰åµŒå¥—å¡ç‰‡æ‰æ¨ªå‘æ’åˆ— - æ™ºèƒ½å®½åº¦ */\n            .mvu-card-body.horizontal-nested > .mvu-card {\n                flex: 0 0 auto; /* æ ¹æ®å†…å®¹è‡ªåŠ¨è°ƒæ•´å®½åº¦ */\n                min-width: 200px;\n                max-width: 350px;\n                width: auto;\n            }\n            /* å¦‚æœåµŒå¥—å¡ç‰‡å†…éƒ¨ä¹Ÿæœ‰æ¨ªå‘æ’åˆ—çš„å­å¡ç‰‡ï¼Œç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå…è®¸æ ¹æ®å†…å®¹è‡ªé€‚åº” */\n            .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                min-width: 400px; /* ä¸ºåŒ…å«åµŒå¥—å¡ç‰‡çš„åµŒå¥—å¡ç‰‡è®¾ç½®æ›´å¤§çš„æœ€å°å®½åº¦ */\n                max-width: none; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå…è®¸æ ¹æ®å†…å®¹è‡ªé€‚åº” */\n            }\n            @media (min-width: 769px) {\n                .mvu-card-body.horizontal-nested > .mvu-card {\n                    min-width: 240px;\n                    max-width: 400px;\n                }\n                .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                    min-width: 500px; /* ä¸ºåŒ…å«åµŒå¥—å¡ç‰‡çš„åµŒå¥—å¡ç‰‡è®¾ç½®æ›´å¤§çš„æœ€å°å®½åº¦ */\n                    max-width: none; /* ç§»é™¤æœ€å¤§å®½åº¦é™åˆ¶ï¼Œå…è®¸æ ¹æ®å†…å®¹è‡ªé€‚åº” */\n                }\n            }\n\n            /* é”®å€¼å¯¹è¡Œ */\n            .mvu-row {\n                display: flex;\n                align-items: flex-start;\n                padding: 5px 0;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .mvu-row:last-child {\n                border-bottom: none;\n            }\n            .mvu-key {\n                color: var(--acu-text-sub);\n                min-width: 80px;\n                max-width: 120px;\n                flex-shrink: 0;\n                font-size: 12px;\n                padding-right: 8px;\n                word-break: break-all;\n            }\n            .mvu-value-wrap {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                min-width: 0;\n            }\n            .mvu-value {\n                color: var(--acu-text-main);\n                font-size: var(--acu-font-size, 13px);\n                cursor: pointer;\n                padding: 1px 6px;\n                border-radius: 4px;\n                transition: background 0.2s;\n                word-break: break-word;\n                flex: 0 1 auto;\n            }\n            .mvu-value:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-value.mvu-array-value {\n                font-size: calc(var(--acu-font-size, 13px) * 0.92);\n                color: var(--acu-text-sub);\n            }\n            .mvu-change-indicator {\n                color: var(--acu-success-text);\n                font-weight: bold;\n                font-size: 12px;\n                flex-shrink: 0;\n            }\n            .mvu-row.mvu-changed {\n                background: var(--acu-success-bg);\n                margin: 0 -12px;\n                padding: 5px 12px;\n                border-radius: 4px;\n            }\n            .mvu-card .mvu-card .mvu-row.mvu-changed {\n                margin: 0 -10px;\n                padding: 5px 10px;\n            }\n\n            /* ç©ºçŠ¶æ€ */\n            .mvu-empty {\n                text-align: center;\n                padding: 40px 20px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 100%;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n            }\n            .mvu-empty i {\n                font-size: 32px;\n                margin-bottom: 12px;\n                display: block;\n                opacity: 0.5;\n            }\n            .mvu-empty p {\n                margin: 0 0 6px 0;\n            }\n            .mvu-empty .mvu-empty-hint {\n                font-size: 12px;\n                opacity: 0.7;\n            }\n\n            /* ç¼–è¾‘å¼¹çª— */\n            .mvu-edit-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0,0,0,0.6);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 99999;\n                animation: mvuFadeIn 0.15s ease-out;\n            }\n            .mvu-edit-dialog {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                padding: 16px;\n                width: 90%;\n                max-width: 400px;\n                animation: mvuSlideIn 0.2s ease-out;\n            }\n            .mvu-edit-title {\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 12px;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .mvu-edit-path {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                padding: 6px 10px;\n                border-radius: 4px;\n                margin-bottom: 12px;\n                word-break: break-all;\n                font-family: monospace;\n            }\n            .mvu-edit-textarea {\n                width: 100%;\n                min-height: 80px;\n                padding: 10px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-input-bg, var(--acu-bg-panel));\n                color: var(--acu-text-main);\n                font-size: 13px;\n                resize: vertical;\n                box-sizing: border-box;\n            }\n            .mvu-edit-textarea:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .mvu-edit-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-top: 8px;\n                opacity: 0.7;\n            }\n            .mvu-edit-btns {\n                display: flex;\n                justify-content: flex-end;\n                gap: 8px;\n                margin-top: 16px;\n            }\n            .mvu-edit-btn {\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 13px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                transition: all 0.2s;\n            }\n            .mvu-edit-btn.mvu-btn-cancel {\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-sub);\n            }\n            .mvu-edit-btn.mvu-btn-cancel:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-edit-btn.mvu-btn-save {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: #fff;\n            }\n            .mvu-edit-btn.mvu-btn-save:hover {\n                opacity: 0.9;\n            }\n\n            @keyframes mvuFadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n            @keyframes mvuSlideIn {\n                from { transform: translateY(-20px); opacity: 0; }\n                to { transform: translateY(0); opacity: 1; }\n            }\n\n            /* å¯¼èˆªæŒ‰é’® */\n            .acu-nav-btn.acu-mvu-btn.active {\n                background: var(--acu-btn-active-bg);\n                color: var(--acu-btn-active-text);\n            }\n        ',e.head.appendChild(t)},renderNavButton:function(t){return`<button class="acu-nav-btn acu-mvu-btn $${t?'active':''}" id="acu-btn-mvu" data-table="$${e}" style="order:-1;">\n                    <i class="fa-solid fa-code-branch"></i><span>å˜é‡</span>\n                </button>`},renderPanel:function(){const e=r(),t='era'===n();let a=!1;try{a='true'===localStorage.getItem('acu_mvu_numeric_mode')}catch(e){console.warn('[DICE]MvuModule è¯»å–æ•°å€¼æ¨¡å¼çŠ¶æ€å¤±è´¥',e)}const o='vertical-layout',c=t?'ERA å˜é‡':'MVU å˜é‡';if(!e)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span></div>\n                                <div class="acu-title-sub">(0é¡¹)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${ue.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="å…³é—­">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${o}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-exclamation-circle"></i>\n                                <p>æ— æ³•è·å– ${t?'ERA':'MVU'} æ•°æ®</p>\n                                <p class="mvu-empty-hint">è¯·ç¡®ä¿è§’è‰²å¡å·²é…ç½® ${t?'ERA æ¡†æ¶':'MVU æ¡†æ¶'}ï¼Œæˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®è‡ªåŠ¨é‡è¯•è·å–å˜é‡</p>\n                            </div>\n                        </div>\n                    `;if(!e.stat_data||'object'==typeof e.stat_data&&0===Object.keys(e.stat_data).length)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span></div>\n                                <div class="acu-title-sub">(0é¡¹)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${ue.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="å…³é—­">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${o}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-inbox"></i>\n                                <p>å½“å‰æ²¡æœ‰å˜é‡æ•°æ®</p>\n                                <p class="mvu-empty-hint">å˜é‡æ•°æ®å°†åœ¨ AI å›å¤åè‡ªåŠ¨åˆå§‹åŒ–ï¼Œæˆ–ç‚¹å‡»åˆ·æ–°æŒ‰é’®è‡ªåŠ¨é‡è¯•è·å–å˜é‡</p>\n                            </div>\n                        </div>\n                    `;if(a){const t=function(e){if(!e||!e.stat_data)return'<div class="mvu-empty"><i class="fa-solid fa-inbox"></i><p>å½“å‰æ²¡æœ‰å˜é‡æ•°æ®</p></div>';let t={};try{const e=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');e&&(t=JSON.parse(e))}catch(e){console.warn('[DICE]MvuModule è¯»å–å±‚çº§æ˜¾ç¤ºåå¥½å¤±è´¥',e)}const n=[];function a(e,t,i){if(e&&'object'==typeof e)if(Array.isArray(e))s(e)||l(e)?e.forEach((e,a)=>{const o=t?`${t}[${a}]`:`[${a}]`,r=String(e??'').trim();if('function'==typeof De&&De(r)){const e=p(u(r,!1));e>0&&n.push({path:o,key:`[${a}]`,value:r,numericValue:e,levelNames:[...i]})}}):e.forEach((e,n)=>{a(e,t?`${t}[${n}]`:`[${n}]`,[...i,`[${n}]`])});else{const o=Object.entries(e).filter(([e])=>!e.startsWith('$'));for(const[e,r]of o){const o=t?`${t}.${e}`:e,c=[...i,e];if(!r||'object'!=typeof r||s(r)||l(r)){const t=String(r??'').trim();if('function'==typeof De&&De(t)){const a=p(u(t,!1));a>0&&n.push({path:o,key:e,value:t,numericValue:a,levelNames:c})}}else a(r,o,c)}}}const o=Object.keys(e.stat_data).filter(e=>!e.startsWith('$'));for(const t of o)a(e.stat_data[t],t,[t]);const r=n.filter(e=>{let t=e.key;const n=e.levelNames.filter(e=>e&&!e.startsWith('['));if(n.length>0)t=n[n.length-1];else if(e.path&&e.path.includes('.')){const n=e.path.split('.');t=n[n.length-1]}return!X.isBlacklisted(t)});if(0===r.length)return'<div class="mvu-empty"><i class="fa-solid fa-filter"></i><p>å½“å‰æ²¡æœ‰æ•°å€¼é¡¹</p></div>';const c=new Set;r.forEach(e=>{(e.levelNames.length>1?e.levelNames.slice(0,-1):[]).forEach(e=>{e&&!e.startsWith('[')&&c.add(e)})});const d=Array.from(c).sort();let g='';if(d.length>0){const e=Me(),n=e.buttonTextOnAccent||e.textMain||'#6B4A5A';let a='';d.forEach(e=>{const o=!1!==t[e],r=o?`background:var(--acu-accent);color:${n};border-color:var(--acu-accent);opacity:1;`:'background:transparent;color:var(--acu-text-sub);border-color:var(--acu-border);opacity:0.5;';a+=`<button class="mvu-level-toggle" data-level="${i(e)}" data-visible="${o}" style="display:flex;align-items:center;gap:4px;font-size:calc(var(--acu-font-size, 13px) * 0.85);cursor:pointer;padding:2px 6px;border-radius:4px;border:1px solid;${r}transition:all 0.2s;" title="${o?'éšè—':'æ˜¾ç¤º'}å±‚çº§: ${i(e)}"><span>${i(e)}</span></button>`}),g=`\n          <div class="mvu-level-controls-collapsible collapsed">\n            <div class="mvu-level-controls-header" style="padding:6px 8px;background:var(--acu-table-head);border-bottom:1px solid var(--acu-border);cursor:pointer;display:flex;align-items:center;justify-content:space-between;user-select:none;">\n              <span style="font-size:calc(var(--acu-font-size, 13px) * 0.85);color:var(--acu-text-sub);">æ˜¾ç¤ºå±‚çº§</span>\n              <i class="fa-solid fa-chevron-down mvu-level-controls-toggle-icon" style="font-size:10px;color:var(--acu-text-sub);transition:transform 0.2s;"></i>\n            </div>\n            <div class="mvu-level-controls-body" style="padding:8px;background:var(--acu-table-head);border-bottom:1px solid var(--acu-border);display:flex;flex-wrap:wrap;gap:6px;align-items:center;">\n              ${a}\n            </div>\n          </div>\n        `}let f='';return r.forEach(e=>{const t=e.levelNames.filter(e=>!e.startsWith('[')),n=e.levelNames.filter(e=>{if(e.startsWith('['))return!1;try{const t=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');if(t)return!1!==JSON.parse(t)[e]}catch(e){}return!0}),a=n.length>1?n.slice(0,-1):[],o=t.length>1?t.slice(0,-1):[],r=o.every(e=>{try{const t=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');if(t)return!1!==JSON.parse(t)[e]}catch(e){}return!0}),c=a.length>0?a.join(' > '):'';let s=e.key;if(e.path&&e.path.includes('.')){const t=e.path.split('.');s=t[t.length-1]}const l=`<i class="fa-solid fa-dice-d20 mvu-dice-icon" data-path="${i(e.path)}" data-attr-name="${i(s)}" data-attr-value="${e.numericValue}" style="cursor:pointer;color:var(--acu-accent);opacity:0.6;font-size:calc(var(--acu-font-size, 13px) * 0.85);flex-shrink:0;" title="å¿«æ·æŠ•éª°"></i>`;let d=u(e.value,!1);d=d.replace(/,\s*\[[^\]]+\]/g,'');const p=r?'':'display:none;',g=JSON.stringify(o);f+=`\n          <div class="mvu-numeric-item" data-levels='${i(g)}' style="${p}display:flex;align-items:center;padding:6px 8px;margin-bottom:4px;background:var(--acu-table-hover);border-radius:4px;border-left:3px solid var(--acu-accent);">\n            <div style="flex:1;min-width:0;">\n              <div class="mvu-path-display" style="font-size:calc(var(--acu-font-size, 13px) * 0.77);color:var(--acu-text-sub);margin-bottom:2px;">${i(c)}</div>\n              <div style="display:flex;align-items:center;gap:6px;">\n                <span style="font-size:calc(var(--acu-font-size, 13px) * 0.92);color:var(--acu-text-main);font-weight:bold;">${i(s)}</span>\n                <span class="mvu-value" data-path="${i(e.path)}" style="font-size:var(--acu-font-size, 13px);color:var(--acu-accent);font-weight:bold;cursor:pointer;" title="ç‚¹å‡»ç¼–è¾‘">${i(d)}</span>\n                ${l}\n              </div>\n            </div>\n          </div>\n        `}),g+'<div class="mvu-numeric-items" style="padding:0 8px;">'+f+'</div>'}(e);return`\n                    <div class="acu-panel-header">\n                        <div class="acu-panel-title">\n                            <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span> <span style="font-size:calc(var(--acu-font-size,13px) * 0.85);color:var(--acu-text-sub);margin-left:6px;">(æ•°å€¼æ¨¡å¼)</span></div>\n                            <div class="acu-title-sub">(æ•°å€¼è¿‡æ»¤)</div>\n                        </div>\n                        <div class="acu-header-actions">\n                            <div class="acu-height-control">\n                                <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${ue.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                            </div>\n                            <button class="mvu-header-btn mvu-btn-numeric-mode active" title="åˆ‡æ¢åˆ°æ™®é€šæ¨¡å¼">\n                                <i class="fa-solid fa-list"></i>\n                            </button>\n                            <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                            <button class="acu-close-btn" title="å…³é—­">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="mvu-content ${o} mvu-numeric-mode">\n                        ${t}\n                    </div>\n                `}const b=Object.keys(e.stat_data).filter(e=>!e.startsWith('$'));let m='';for(const t of b){const n=e.stat_data[t];d(n);!n||'object'!=typeof n||s(n)||l(n)?m+=`\n                            <div class="mvu-card" data-path="${i(t)}" data-depth="0">\n                                <div class="mvu-card-body">\n                                    ${g(t,n,t,e.delta_data)}\n                                </div>\n                            </div>\n                        `:m+=f(t,n,t,e.delta_data,0,!0,!1)}return`\n                    <div class="acu-panel-header">\n                        <div class="acu-panel-title">\n                            <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">${c}</span></div>\n                            <div class="acu-title-sub">(${b.length}é¡¹)</div>\n                        </div>\n                        <div class="acu-header-actions">\n                            <div class="acu-height-control">\n                                <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${ue.MODULE_ID}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                            </div>\n                            <button class="mvu-header-btn mvu-btn-numeric-mode" title="åˆ‡æ¢åˆ°æ•°å€¼æ¨¡å¼ï¼ˆä»…æ˜¾ç¤ºæ•°å€¼é¡¹ï¼‰">\n                                <i class="fa-solid fa-filter"></i>\n                            </button>\n                            <button class="mvu-header-btn mvu-btn-refresh" title="åˆ·æ–°ï¼ˆè‡ªåŠ¨é‡è¯•è·å–å˜é‡ï¼‰">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                            <button class="acu-close-btn" title="å…³é—­">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="mvu-content ${o}">\n                        ${m}\n                    </div>\n                `},bindEvents:function(e){const $=window.parent?.jQuery||window.jQuery;if(!$||!e||!e.length)return void console.warn('[DICE]MvuModule bindEvents: jQuery or container not available');const t=$('#acu-data-area');t.length?(t.off('.mvu'),t.on('click.mvu','.mvu-card-header',function(e){e.stopPropagation();const t=$(this).closest('.mvu-card'),n=t.find('> .mvu-card-body').first();n.is(':animated')||n.hasClass('animating')||(t.hasClass('collapsed')?(n.hide(),t.removeClass('collapsed'),n.addClass('animating').slideDown(180,function(){$(this).removeClass('animating')})):n.addClass('animating').slideUp(180,function(){t.addClass('collapsed'),$(this).removeClass('animating')}))}),t.on('click.mvu','.mvu-btn-refresh',function(e){e.stopPropagation(),ue.refresh(t)}),t.on('click.mvu','.mvu-btn-numeric-mode',function(e){e.stopPropagation();try{const e=!$(this).hasClass('active');if(localStorage.setItem('acu_mvu_numeric_mode',String(e)),'function'==typeof ht){const e=mt();ht(e)}'function'==typeof Sn&&Sn()}catch(e){console.warn('[DICE]MvuModule åˆ‡æ¢æ•°å€¼æ¨¡å¼å¤±è´¥',e),window.toastr&&window.toastr.error('åˆ‡æ¢æ¨¡å¼å¤±è´¥')}}),t.on('click.mvu','.mvu-level-controls-header',function(e){e.stopPropagation();$(this).closest('.mvu-level-controls-collapsible').toggleClass('collapsed')}),t.on('click.mvu','.mvu-level-toggle',function(e){e.stopPropagation();const t=$(this),n=t.data('level'),a=!('true'===t.data('visible')||!0===t.data('visible'));try{const e=localStorage.getItem('acu_mvu_numeric_mode_visible_levels'),i=e?JSON.parse(e):{};i[n]=a,localStorage.setItem('acu_mvu_numeric_mode_visible_levels',JSON.stringify(i));const o=Me(),r=o.buttonTextOnAccent||o.textMain||'#6B4A5A';t.data('visible',a),a?(t.css({background:'var(--acu-accent)',color:r,borderColor:'var(--acu-accent)',opacity:'1'}),t.attr('title',`éšè—å±‚çº§: ${n}`)):(t.css({background:'transparent',color:'var(--acu-text-sub)',borderColor:'var(--acu-border)',opacity:'0.5'}),t.attr('title',`æ˜¾ç¤ºå±‚çº§: ${n}`)),$('.mvu-numeric-item').each(function(){const e=$(this);try{const t=JSON.parse(e.attr('data-levels')||'[]');if(t.includes(n)){const n=t.filter(e=>{const t=localStorage.getItem('acu_mvu_numeric_mode_visible_levels');return!1!==(t?JSON.parse(t):{})[e]}),a=n,i=a.length>0?a.join(' > '):'';e.find('.mvu-path-display').text(i)}}catch(e){console.warn('[DICE]MvuModule æ›´æ–°è·¯å¾„æ˜¾ç¤ºå¤±è´¥',e)}})}catch(e){console.warn('[DICE]MvuModule æ›´æ–°å±‚çº§æ˜¾ç¤ºåå¥½å¤±è´¥',e)}}),t.on('click.mvu','.mvu-value',function(e){e.stopPropagation();const t=$(this),n=t.data('path');if(!n)return void console.warn('[DICE]MvuModule No path on value element');const a=t.text().replace(/\s*\$\s*$/,'').trim();ue.showEditDialog(n,a,async function(e){if(null!==e&&e!==a){const a=await ue.setValue(n,e),toastr=window.parent?.toastr||window.toastr;a?(t.text(e),t.css('background','var(--acu-success-bg)'),setTimeout(()=>t.css('background',''),1500)):toastr&&toastr.error('ä¿å­˜å¤±è´¥')}})}),t.on('click.mvu','.mvu-dice-icon',function(e){e.stopPropagation(),e.preventDefault();const t=$(this),n=t.data('path'),a=t.data('attr-name')||'å±æ€§',i=parseInt(t.data('attr-value'),10)||50;if(!n)return void console.warn('[DICE]MvuModule éª°å­å›¾æ ‡ç¼ºå°‘è·¯å¾„ä¿¡æ¯');if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)return console.warn('[DICE]MvuModule MVU æ¡†æ¶æœªåŠ è½½ï¼Œé™çº§ä¸ºæ™®é€šæŠ•éª°'),void('function'==typeof qt&&qt({attrValue:i,targetValue:null,targetName:a,initiatorName:'<user>',fromMvu:!1}));let o=null;try{o=function(e){try{if(!e||'string'!=typeof e)return{initiator:null,attrName:null,candidates:[]};const t=e.split('.').filter(e=>e&&e.trim());if(0===t.length)return{initiator:null,attrName:null,candidates:[]};const n=['è§’è‰²åˆ—è¡¨','ç³»ç»Ÿ','åˆ—è¡¨','è¡¨','æ•°æ®','ä¿¡æ¯','å˜é‡','å±æ€§','çŠ¶æ€','stat_data','delta_data'],a=t.filter(e=>!n.includes(e));let i=null;a.length>=2?i=a[a.length-2]:1===a.length&&(i=a[0]);let o=null;return a.length>0?o=a[a.length-1]:t.length>0&&(o=t[t.length-1]),{initiator:i||null,attrName:o||null,candidates:a.length>0?a:t.slice(-1)}}catch(e){return console.warn('[DICE]parseMvuPathForDice è§£æè·¯å¾„æ—¶å‡ºé”™',e),{initiator:null,attrName:null,candidates:[]}}}(n)}catch(e){console.warn('[DICE]MvuModule è§£æè·¯å¾„æ—¶å‡ºé”™',e)}'function'==typeof qt&&qt({attrValue:i,targetValue:null,targetName:a,initiatorName:o?.initiator||'<user>',fromMvu:!0,mvuPath:n,mvuParsedInfo:o})}),function(){const e=window.parent?.document||document,t=$(e);t.off('touchstart.mvuSwipeFix touchmove.mvuSwipeFix touchend.mvuSwipeFix','#acu-data-area');let n=0,a=0,i=!1;t.on('touchstart.mvuSwipeFix','#acu-data-area',function(e){$(e.target).closest('.acu-mvu-panel').length>0&&1===e.originalEvent.touches.length&&(n=e.originalEvent.touches[0].clientX,a=e.originalEvent.touches[0].clientY,i=!1)}),t.on('touchmove.mvuSwipeFix','#acu-data-area',function(e){if(!($(e.target).closest('.acu-mvu-panel').length>0))return;if(1!==e.originalEvent.touches.length)return;const t=e.originalEvent.touches[0],o=Math.abs(t.clientX-n),r=Math.abs(t.clientY-a);(r<5?o>5&&o>2*r:o>1.5*r&&o>10)&&(i=!0,e.stopImmediatePropagation(),e.stopPropagation())}),t.on('touchend.mvuSwipeFix','#acu-data-area',function(e){if(!($(e.target).closest('.acu-mvu-panel').length>0))return i=!1,n=0,void(a=0);i&&(e.stopImmediatePropagation(),e.stopPropagation(),i=!1),n=0,a=0});e.addEventListener('touchstart',function(e){$(e.target).closest('.acu-mvu-panel').length>0&&e.touches&&1===e.touches.length&&(n=e.touches[0].clientX,a=e.touches[0].clientY)},!0),e.addEventListener('touchmove',function(e){if($(e.target).closest('.acu-mvu-panel').length>0&&e.touches&&1===e.touches.length&&n&&a){const t=e.touches[0],i=Math.abs(t.clientX-n),o=Math.abs(t.clientY-a);(o<5?i>5&&i>2*o:i>1.5*o&&i>10)&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault())}},!0),e.addEventListener('touchend',function(e){$(e.target).closest('.acu-mvu-panel').length>0&&i&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault())},!0)}(),t.on('click.mvu','.acu-close-btn',function(e){e.stopPropagation();const n=t.find('.acu-search-input');n.length&&n.val()?n.val('').trigger('input').focus():('function'==typeof ht&&ht(null),'function'==typeof Sn&&Sn())}),t.on('pointerdown.mvu','.acu-height-drag-handle',function(e){if(0!==e.button)return;e.preventDefault(),e.stopPropagation();const n=this;n.setPointerCapture(e.pointerId),$(n).addClass('active');const a=t.height(),i=e.clientY,o=$(n).data('table'),r=void 0!==window.MIN_PANEL_HEIGHT?window.MIN_PANEL_HEIGHT:200,c=void 0!==window.MAX_PANEL_HEIGHT?window.MAX_PANEL_HEIGHT:800;n.onpointermove=function(e){const n=e.clientY-i;let o=a-n;o<r&&(o=r),o>c&&(o=c),t.css('height',o+'px')},n.onpointerup=function(e){if($(n).removeClass('active'),n.releasePointerCapture(e.pointerId),n.onpointermove=null,n.onpointerup=null,o&&'function'==typeof Et&&'function'==typeof At){const e=Et();e[o]=parseInt(t.css('height')),At(e),t.addClass('acu-manual-mode')}}}),t.on('dblclick.mvu','.acu-height-drag-handle',function(e){e.preventDefault(),e.stopPropagation();const n=$(this).data('table');if(n&&'function'==typeof Et&&'function'==typeof At){const e=Et();delete e[n],At(e),t.css('height','').removeClass('acu-manual-mode')}}),t.on('dblclick.mvu','.acu-panel-header',function(e){if($(e.target).closest('.acu-search-input, .acu-close-btn, .mvu-header-btn').length)return;e.preventDefault(),e.stopPropagation();const n=ue.MODULE_ID;if(n&&'function'==typeof Et&&'function'==typeof At){const e=Et();delete e[n],At(e),t.css('height','').removeClass('acu-manual-mode')}})):console.warn('[DICE]MvuModule bindEvents: #acu-data-area not found')},showEditDialog:function(e,t,n){const $=window.parent?.jQuery||window.jQuery,a=window.parent?.document||document;if(!$)return;$(a).find('.mvu-edit-overlay').remove();const o=`\n                    <div class="mvu-edit-overlay acu-edit-overlay acu-theme-${('function'==typeof an?an().theme:null)||'retro'}">\n                        <div class="mvu-edit-dialog acu-edit-dialog">\n                            <div class="acu-edit-title">\n                                <i class="fa-solid fa-edit" style="opacity:0.7;"></i>\n                                <span>ç¼–è¾‘å˜é‡</span>\n                            </div>\n                            <div class="mvu-edit-path">${i(e)}</div>\n                            <textarea class="mvu-edit-textarea acu-edit-textarea">${i(t)}</textarea>\n                            <div class="mvu-edit-hint">Ctrl+Enter ä¿å­˜ | Esc å–æ¶ˆ</div>\n                            <div class="acu-dialog-btns">\n                                <button class="acu-dialog-btn mvu-btn-cancel">\n                                    <i class="fa-solid fa-times"></i> å–æ¶ˆ\n                                </button>\n                                <button class="acu-dialog-btn acu-btn-confirm mvu-btn-save">\n                                    <i class="fa-solid fa-check"></i> ä¿å­˜\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                `;$(a.body).append(o);const r=$(a).find('.mvu-edit-overlay'),c=r.find('.mvu-edit-textarea');setTimeout(()=>c.focus().select(),50),r.on('click','.mvu-btn-cancel',function(e){e.preventDefault(),e.stopPropagation(),r.remove(),n(null)}),r.on('click','.mvu-btn-save',function(e){e.preventDefault(),e.stopPropagation();const t=c.val();r.remove(),n(t)}),r.on('click',function(e){$(e.target).hasClass('mvu-edit-overlay')&&(r.remove(),n(null))}),c.on('keydown',function(e){if('Escape'===e.key)e.preventDefault(),r.remove(),n(null);else if('Enter'===e.key&&e.ctrlKey){e.preventDefault();const t=c.val();r.remove(),n(t)}})},setValue:async function(e,t){if(!o())return!1;const a=n();try{let n=t;if('true'===t?n=!0:'false'===t?n=!1:isNaN(Number(t))||''===String(t).trim()||(n=Number(t)),'era'===a)return await async function(e,t){return new Promise(n=>{const a=setTimeout(()=>{console.warn('[DICE]MvuModule ERAå†™å…¥è¶…æ—¶'),n(!1)},5e3),i=window.eventEmit||window.parent?.eventEmit,o=window.eventOn||window.parent?.eventOn,r=window.eventOff||window.parent?.eventOff,c=e=>{clearTimeout(a),'function'==typeof r&&r('era:writeDone',c),console.log('[DICE]MvuModule ERAå†™å…¥æˆåŠŸ'),n(!0)};try{if(console.log('[DICE]MvuModule å¼€å§‹è®¾ç½®ERAå˜é‡:',e,t),'function'!=typeof o)return console.error('[DICE]MvuModule eventOn ä¸å¯ç”¨'),clearTimeout(a),void n(!1);if('function'!=typeof i)return console.error('[DICE]MvuModule eventEmit ä¸å¯ç”¨'),clearTimeout(a),void n(!1);o('era:writeDone',c),i('era:updateByPath',{path:e,value:t})}catch(e){clearTimeout(a),console.error('[DICE]MvuModule ERA APIè°ƒç”¨å¤±è´¥:',e),n(!1)}})}(e,n);{const t=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(!t)return console.error('[DICE]MvuModule æ— æ³•è·å– MVU æ•°æ®'),!1;const a=await window.Mvu.setMvuVariable(t,e,n,{reason:'æ‰‹åŠ¨ç¼–è¾‘',is_recursive:!1});return a?await window.Mvu.replaceMvuData(t,{type:'message',message_id:'latest'}):console.warn('[DICE]MvuModule setMvuVariable è¿”å› false'),a}}catch(e){return console.error('[DICE]MvuModule setValue error:',e),!1}},isModuleTab:function(t){return t===e},clearCache:function(){t=null,console.log('[DICE]MvuModule å·²æ¸…é™¤ ERA ç¼“å­˜')},detectMode:function(){return n()},refresh:function(e){if(this.clearCache(),!e||!e.length){const t=$('#acu-data-area');if(!t.length)return;e=t}const t=e.find('.mvu-btn-refresh');t.length&&t.find('i').addClass('fa-spin'),this.getDataWithRetry(10,1e3).then(n=>{t.length&&t.find('i').removeClass('fa-spin'),e.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(e);const toastr=window.parent?.toastr||window.toastr,a=this.getData();toastr&&!a&&toastr.warning('æ— æ³•è·å–å˜é‡æ•°æ®ï¼Œè¯·ç¨åé‡è¯•æˆ–ç¡®ä¿è§’è‰²å¡å·²é…ç½® MVU æ¡†æ¶')}).catch(n=>{console.error('[DICE]MvuModule Error refreshing data:',n),t.length&&t.find('i').removeClass('fa-spin'),e.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(e);const toastr=window.parent?.toastr||window.toastr,a=this.getData();toastr&&!a&&toastr.error('è·å–å˜é‡æ•°æ®æ—¶å‡ºé”™')})}}}(),pe={critSuccessMax:5,hardSuccessDiv:5,difficultSuccessDiv:2,critFailMin:96,ruleType:'high_good',lastDiceType:'1d100',dndCritSuccess:20,dndCritFail:1,contestTieRule:'initiator_lose',hideDiceResultFromUser:!1,hideDiceResultInChat:!1},ge=()=>bt.get(C,pe),fe=e=>{const t=ge(),n={...t,...e};bt.set(C,n);const a=Object.keys(e).filter(e=>t[e]!==n[e]);a.length>0&&console.info(`[DICE]æŠ•éª°é…ç½®å·²æ›´æ–°: ${a.join(', ')}`)},be=()=>{try{const e=ge(),t=void 0!==e.hideDiceResultFromUser&&e.hideDiceResultFromUser,n=void 0!==e.hideDiceResultInChat&&e.hideDiceResultInChat;try{const e=$('#send_textarea');if(e.length){let n=e.val()||'',a=n;if(t){const e=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g,t=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g;e.test(a)&&(a=a.replace(e,'[æŠ•éª°ç»“æœå·²éšè—]')),t.test(a)&&(a=a.replace(t,'[æŠ•éª°ç»“æœå·²éšè—]'))}else{const t=e.data('acu-original-dice-text');t&&n.includes('[æŠ•éª°ç»“æœå·²éšè—]')&&(a=n.replace(/\[æŠ•éª°ç»“æœå·²éšè—\]/g,t),e.removeData('acu-original-dice-text'))}a!==n&&e.val(a).trigger('input').trigger('change')}}catch(e){console.warn('[DICE]ACU å¤„ç†è¾“å…¥æ æŠ•éª°ç»“æœå¤±è´¥:',e)}let a;try{a=getLastMessageId()}catch(e){return}if(a<0)return;try{const e=getChatMessages(`0-${a}`,{role:'user'});if(!e||0===e.length)return;if(n){let t=0;e.forEach(e=>{try{const n=retrieveDisplayedMessage(e.message_id);if(!n||!n.length)return;let a=n.find('.mes_text');a&&a.length||(a=n.find('.message-text, .text, [class*="text"], [class*="message"]').first(),a&&a.length||(a=n));const i=a.text();if(i.includes('[æŠ•éª°ç»“æœå·²éšè—]'))return;const o=e.message||'';if(!o)return;let r=o;const c=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g;c.test(r)&&(r=r.replace(c,'[æŠ•éª°ç»“æœå·²éšè—]'));const s=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g;if(s.test(r)&&(r=r.replace(s,'[æŠ•éª°ç»“æœå·²éšè—]')),r!==o&&r!==i){const e=a.html();let n=e;const i=/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g;i.test(e)&&(n=n.replace(i,'[æŠ•éª°ç»“æœå·²éšè—]'));const o=/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g;o.test(e)&&(n=n.replace(o,'[æŠ•éª°ç»“æœå·²éšè—]')),n!==e&&(a.html(n),t++)}}catch(t){console.warn(`[DICE]ACU éšè—ç¬¬ ${e.message_id} æ¥¼æŠ•éª°ç»“æœå¤±è´¥:`,t)}}),t>0&&console.info(`[DICE]å·²éšè— ${t} æ¡æ¶ˆæ¯çš„æŠ•éª°ç»“æœ`)}else{let t=0;e.forEach(e=>{try{const n=retrieveDisplayedMessage(e.message_id);if(!n||!n.length)return;const a=n.find('.mes_text');if(!a||!a.length)return;if(a.text().includes('[æŠ•éª°ç»“æœå·²éšè—]')){const n=e.message||'';n&&(a.text(n),t++)}}catch(e){}}),t>0&&console.info(`[DICE]å·²æ¢å¤ ${t} æ¡æ¶ˆæ¯çš„æŠ•éª°ç»“æœ`)}}catch(e){n&&console.warn('[DICE]ACU å¤„ç†èŠå¤©è®°å½•æŠ•éª°ç»“æœå¤±è´¥:',e)}}catch(e){const t=ge();t&&(t.hideDiceResultFromUser||t.hideDiceResultInChat)&&console.warn('[DICE]ACU éšè—æŠ•éª°ç»“æœå¤±è´¥:',e)}},me=[{format:'acu_attr_preset_v1',version:T,id:'coc7',name:'ç®€åŒ–COCè§„åˆ™',builtin:!0,description:'åŸºäºå…‹è‹é²çš„å‘¼å”¤ç¬¬7ç‰ˆè§„åˆ™çš„å±æ€§é¢„è®¾ã€‚åŒ…å«8æ¡åŸºæœ¬å±æ€§å’Œ16æ¡ç‰¹æ®Šå±æ€§ã€‚',baseAttributes:[{name:'åŠ›é‡',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'ä½“è´¨',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'æ•æ·',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'å¤–è²Œ',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'æ„å¿—',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'å¹¸è¿',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'æ™ºåŠ›',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'},{name:'æ•™è‚²',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'}],specialAttributes:[{name:'ä¾¦æŸ¥',formula:'10+5d20',range:[15,95]},{name:'è†å¬',formula:'10+5d20',range:[15,95]},{name:'å¿ƒç†å­¦',formula:'10+5d20',range:[15,95]},{name:'è¯´æœ',formula:'5+4d20',range:[9,85]},{name:'è¯æœ¯',formula:'5+4d20',range:[9,85]},{name:'æ½œè¡Œ',formula:'5+4d20',range:[9,85]},{name:'æ ¼æ–—',formula:'5+4d20',range:[9,85]},{name:'å°„å‡»',formula:'5+4d20',range:[9,85]},{name:'é­…æƒ‘',formula:'5+3d20',range:[8,65]},{name:'æå“',formula:'5+3d20',range:[8,65]},{name:'å›¾ä¹¦é¦†ä½¿ç”¨',formula:'5+3d20',range:[8,65]},{name:'æ€¥æ•‘',formula:'5+3d20',range:[8,65]},{name:'ç¥ç§˜å­¦',formula:'1+2d20',range:[3,41]},{name:'é—ªé¿',formula:'æ•æ·/2',range:[1,99]},{name:'SANå€¼',formula:'æ„å¿—',range:[1,99]},{name:'å…‹è‹é²ç¥è¯',formula:'1d5',range:[1,5]}]},{format:'acu_attr_preset_v1',version:T,id:'dnd5e',name:'ç®€åŒ–DNDè§„åˆ™',builtin:!0,description:'åŸºäºé¾™ä¸åœ°ä¸‹åŸç¬¬5ç‰ˆè§„åˆ™çš„å±æ€§é¢„è®¾ã€‚åŒ…å«6æ¡åŸºæœ¬å±æ€§å’Œ8æ¡ç‰¹æ®Šå±æ€§ã€‚',baseAttributes:[{name:'åŠ›é‡',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'æ•æ·',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'ä½“è´¨',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'æ™ºåŠ›',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'æ„ŸçŸ¥',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'é­…åŠ›',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'}],specialAttributes:[{name:'å¯Ÿè§‰',formula:'8+2d6',range:[10,20]},{name:'éšåŒ¿',formula:'8+2d6',range:[10,20]},{name:'è¿åŠ¨',formula:'5+2d6',range:[7,17]},{name:'å·§æ‰‹',formula:'5+2d6',range:[7,17]},{name:'æ´æ‚‰',formula:'5+2d6',range:[7,17]},{name:'æ¸¸è¯´',formula:'5+2d6',range:[7,17]},{name:'å¥¥ç§˜',formula:'2+2d6',range:[4,14]},{name:'æ¬ºç’',formula:'2+2d6',range:[4,14]}]}],he=(()=>{let e=null;return{getAllPresets(){const t=bt.get(E,[]);let n=!1;return t.forEach(e=>{const t=e.version||'0.0.0';F(t,T)<0&&(console.log(`[DICE]AttributePresetManager æ£€æµ‹åˆ°é¢„è®¾ "${e.name}" ç‰ˆæœ¬è¾ƒæ—§ (${t})ï¼Œè‡ªåŠ¨æ›´æ–°åˆ° ${T}`),e.version=T,n=!0)}),n&&(bt.set(E,t),e=null),!n&&e||(e=[...me,...t]),e},getActivePreset(){const e=bt.get(A,null);return e&&this.getAllPresets().find(t=>t.id===e)||null},setActivePreset(t){try{const n=''===t||void 0===t?null:t;return bt.set(A,n),e=null,console.log('[DICE]AttributePresetManager åˆ‡æ¢é¢„è®¾:',n),!0}catch(e){return console.error('[DICE]AttributePresetManager è®¾ç½®é¢„è®¾å¤±è´¥:',e),!1}},createPreset(t){const n=bt.get(E,[]),a={...t,id:t.id||'custom_'+Date.now(),builtin:!1,version:t.version||T,createdAt:(new Date).toISOString()};return n.push(a),bt.set(E,n),e=null,console.log('[DICE]AttributePresetManager åˆ›å»ºé¢„è®¾:',a.name),a},updatePreset(t,n){const a=bt.get(E,[]),i=a.findIndex(e=>e.id===t);return!(i<0)&&(a[i]={...a[i],...n},bt.set(E,a),e=null,console.log('[DICE]AttributePresetManager æ›´æ–°é¢„è®¾:',t),!0)},deletePreset(t){const n=bt.get(E,[]),a=n.filter(e=>e.id!==t);return a.length!==n.length&&(bt.set(E,a),e=null,bt.get(A)===t&&bt.set(A,null),console.log('[DICE]AttributePresetManager åˆ é™¤é¢„è®¾:',t),!0)},exportPreset(e){const t=this.getAllPresets().find(t=>t.id===e);if(!t)return null;const n={format:'acu_attr_preset_v1',version:T,...t};return delete n.builtin,JSON.stringify(n,null,2)},importPreset(e,t=!1){try{const n=JSON.parse(e);if('acu_attr_preset_v1'!==n.format)throw new Error('ä¸æ”¯æŒçš„é¢„è®¾æ ¼å¼');if(!n.name||!n.baseAttributes||!Array.isArray(n.baseAttributes))throw new Error('é¢„è®¾æ•°æ®ä¸å®Œæ•´');const a=n.version||'0.0.0',i=F(a,T)<0,o={...n,id:'imported_'+Date.now(),builtin:!1,version:t&&i?T:a,createdAt:(new Date).toISOString()},r=this.createPreset(o);return r&&i&&!t&&console.warn(`[DICE]AttributePresetManager å¯¼å…¥çš„é¢„è®¾ "${r.name}" ç‰ˆæœ¬è¾ƒæ—§ (${a})ï¼Œå»ºè®®æ›´æ–°åˆ° ${T}`),r}catch(e){return console.error('[DICE]AttributePresetManager å¯¼å…¥å¤±è´¥:',e),null}},clearCache(){e=null}}})(),ve=()=>{const e=bt.get(S,null);return e?{...I,...e}:{...I}},xe=e=>{bt.set(S,e)},ye=()=>{const e=ve();if(!e.enabled)return!1;return 100*Math.random()<e.crazyLevel},we=()=>{const e=ve(),t=Je||ln();if(!t)return null;const n=pn(t||{}),a=Ie.findTable(n,'player'),i=Ie.findTable(n,'npc'),o=[];if(a?.data?.rows?.length>0){const t=re()||'ä¸»è§’',n=Lt('<user>');o.push({name:t,attrs:n,isPlayer:!0,inScene:!0,weight:e.playerWeight})}if(i){Ie.parseRows(i,'npc').forEach(t=>{if(!t.name)return;const n=String(t.inScene||'').toLowerCase(),a='true'===n||'åœ¨åœº'===n,i=Lt(t.name);o.push({name:t.name,attrs:i,isPlayer:!1,inScene:a,weight:a?e.inSceneNpcWeight:e.offSceneNpcWeight})})}return 0===o.length?null:(e=>{if(!e||0===e.length)return null;const t=e.reduce((e,t)=>e+(t.weight||1),0);let n=Math.random()*t;for(const t of e)if(n-=t.weight||1,n<=0)return t;return e[e.length-1]})(o)},ke=e=>{if(!e)return{name:'å¹¸è¿',value:50};if(e.attrs&&e.attrs.length>0){const t=e.attrs[Math.floor(Math.random()*e.attrs.length)];return{name:t.name,value:t.value}}const t=he.getActivePreset();if(t){const e=[...t.baseAttributes||[],...t.specialAttributes||[]];if(e.length>0){const t=e[Math.floor(Math.random()*e.length)],n=t.range||[0,100],a=Math.floor((n[0]+n[1])/2);return{name:t.name,value:a}}}const n=Pt();if(n&&n.length>0){return{name:n[Math.floor(Math.random()*n.length)],value:50}}return{name:'å¹¸è¿',value:50}},$e=()=>Math.floor(100*Math.random())+1,Ce=(e,t)=>e<=5?'å¤§æˆåŠŸ':e>=96?'å¤§å¤±è´¥':e<=t?'æˆåŠŸ':'å¤±è´¥',_e=()=>{if('normal'===(e=>{if(e<50)return'normal';const t=e<=75?.3:.5;return Math.random()<t?'contest':'normal'})(ve().crazyLevel)){const e=we();if(!e)return null;const t=ke(e),n=$e(),a=Ce(n,t.value);return`ï¼ˆå…ƒå™äº‹ï¼š${e.name}å‘èµ·äº†ã€${t.name}ã€‘æ£€å®šï¼Œæ·å‡º${n}ï¼Œç›®æ ‡${t.value}ï¼Œã€${a}ã€‘ï¼‰`}{const e=we();if(!e)return null;let t=null;for(let n=0;n<5;n++){const n=we();if(n&&n.name!==e.name){t=n;break}}if(!t){const t=ke(e),n=$e(),a=Ce(n,t.value);return`ï¼ˆå…ƒå™äº‹ï¼š${e.name}å‘èµ·äº†ã€${t.name}ã€‘æ£€å®šï¼Œæ·å‡º${n}ï¼Œç›®æ ‡${t.value}ï¼Œã€${a}ã€‘ï¼‰`}const n=ke(e),a=ke(t),i=$e(),o=$e(),r=Ce(i,n.value),c=Ce(o,a.value),s=n.value-i,l=a.value-o;let d;return d=s>l?`${e.name}èƒœå‡º`:l>s?`${t.name}èƒœå‡º`:'å¹³å±€',`ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€${e.name} ${n.name} vs ${t.name} ${a.name}ã€‘çš„å¯¹æŠ—æ£€å®šã€‚${e.name} ${n.name} (ç›®æ ‡${n.value}) æ·å‡º ${i}ï¼Œåˆ¤å®šä¸ºã€${r}ã€‘ï¼›${t.name} ${a.name} (ç›®æ ‡${a.value}) æ·å‡º ${o}ï¼Œåˆ¤å®šä¸ºã€${c}ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€${d}ã€‘ï¼‰`}},Ee=e=>{const t=e.match(/^(\d+)d(\d+)(kh\d+|kl\d+|dh\d+|dl\d+)?$/i);if(!t)return NaN;const[,n,a,i]=t,o=parseInt(n,10),r=parseInt(a,10);let c=Array.from({length:o},()=>(e=>Math.floor(Math.random()*e)+1)(r));if(i){const e=i.toLowerCase(),t=parseInt(e.slice(2),10);c.sort((e,t)=>t-e),e.startsWith('kh')?c=c.slice(0,t):e.startsWith('kl')?c=c.slice(-t):e.startsWith('dh')?c=c.slice(t):e.startsWith('dl')&&(c=c.slice(0,-t))}return c.reduce((e,t)=>e+t,0)},Ae=(e,t,n)=>{let a=((e,t={})=>{if(!e)return 0;let n=String(e).trim();const a=Object.keys(t).sort((e,t)=>t.length-e.length);for(const e of a){const a=t[e];'number'!=typeof a||isNaN(a)||(n=n.split(e).join(`(${a})`))}if(n=n.replace(/\d+d\d+(kh\d+|kl\d+|dh\d+|dl\d+)?/gi,e=>{const t=Ee(e);return isNaN(t)?'0':String(t)}),!/^[\d\s+\-*/().]+$/.test(n))return console.warn('[DICE]evaluateFormula å…¬å¼åŒ…å«éæ³•å­—ç¬¦:',e,'â†’',n),0;try{const e=new Function(`return (${n})`)();return Math.round(e)}catch(t){return console.error('[DICE]evaluateFormula å…¬å¼è®¡ç®—å¤±è´¥:',e,'â†’',n,t),0}})(e,n);return t&&Array.isArray(t)&&2===t.length&&(a=Math.max(t[0],Math.min(t[1],a))),a},Se={global:{tableKeywords:['å…¨å±€æ•°æ®è¡¨','å…¨å±€æ•°æ®','å…¨å±€'],columns:{detailLocation:{keywords:['å½“å‰è¯¦ç»†åœ°ç‚¹','è¯¦ç»†åœ°ç‚¹','å…·ä½“ä½ç½®','å½“å‰ä½ç½®'],fallbackIndex:null},currentLocation:{keywords:['å½“å‰æ¬¡è¦åœ°åŒº','å½“å‰æ‰€åœ¨åœ°ç‚¹','å½“å‰åœ°ç‚¹','æ‰€åœ¨åœ°ç‚¹'],fallbackIndex:2}}},player:{tableKeywords:['ä¸»è§’ä¿¡æ¯','ä¸»è§’','ç©å®¶','è§’è‰²ä¿¡æ¯','player','ç”¨æˆ·','user','<user>'],columns:{name:{keywords:['å§“å','åç§°','äººç‰©åç§°','name'],fallbackIndex:1},status:{keywords:['çŠ¶æ€å…³é”®è¯','çŠ¶æ€å…³é”®å­—','çŠ¶æ€æ ‡ç­¾','çŠ¶æ€'],fallbackIndex:null},position:{keywords:['å…·ä½“ä½ç½®','ä½ç½®','æ‰€åœ¨åœ°'],fallbackIndex:null},attrs:{keywords:['åŸºç¡€å±æ€§','å±æ€§'],fallbackIndex:null,isMultiple:!0},money:{keywords:['é‡‘é’±','èµ„é‡‘','é‡‘å¸','è´§å¸','ä½™é¢','çµçŸ³','ç§¯åˆ†','ä»£å¸','ä¿¡ç”¨ç‚¹'],fallbackIndex:null},resources:{keywords:['èµ„æºæ•°æ®','èµ„æº','resources'],fallbackIndex:null}}},location:{tableKeywords:['ä¸–ç•Œåœ°å›¾ç‚¹','åœ°å›¾ç‚¹','åœ°å›¾','åœ°ç‚¹','åœ°ç‚¹è¡¨','åœ°å›¾è¡¨','åœºæ™¯','åŒºåŸŸ','ç§˜å¢ƒ','å‰¯æœ¬','æ´åºœ','ç©ºé—´','ä½é¢','ç•ŒåŸŸ'],columns:{name:{keywords:['è¯¦ç»†åœ°ç‚¹','å…·ä½“ä½ç½®','å½“å‰åœ°ç‚¹','æ¬¡è¦åœ°åŒº','ä¸»è¦åœ°åŒº','åœ°åŒº','åœ°ç‚¹å','åç§°'],fallbackIndex:1},description:{keywords:['ç¯å¢ƒæè¿°','æè¿°','è¯´æ˜','ä»‹ç»','æ°›å›´æè¿°'],fallbackIndex:null}}},npc:{tableKeywords:['é‡è¦äººç‰©è¡¨','é‡è¦äººç‰©','NPC','äººç‰©è¡¨','äººç‰©','è§’è‰²è¡¨','è§’è‰²','character','å¼Ÿå­','æˆå‘˜','é˜Ÿå‹','ä¼™ä¼´','å® ç‰©','çµå® '],columns:{name:{keywords:['å§“å','åç§°'],fallbackIndex:1},status:{keywords:['è‡ªèº«çŠ¶æ€','çŠ¶æ€'],fallbackIndex:null},position:{keywords:['å…·ä½“ä½ç½®','ä½ç½®','æ‰€åœ¨åœ°ç‚¹','æ‰€åœ¨'],fallbackIndex:null},inScene:{keywords:['åœ¨åœºçŠ¶æ€','åœ¨åœº','æ˜¯å¦ç¦»åœº','ç¦»åœº'],fallbackIndex:null}}},quest:{tableKeywords:['ä»»åŠ¡è¡¨','å¤‡å¿˜äº‹é¡¹','ä»»åŠ¡','äº‹é¡¹','ç›®æ ‡','å¾…åŠ','ä¸»çº¿','æ”¯çº¿','å§”æ‰˜','æ‚¬èµ'],columns:{name:{keywords:['äº‹é¡¹åç§°','ä»»åŠ¡å','åç§°'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»','äº‹é¡¹ç±»å‹'],fallbackIndex:2},progress:{keywords:['è¿›åº¦','å®Œæˆåº¦','è¿›åº¦/ç»“æœ'],fallbackIndex:5},status:{keywords:['çŠ¶æ€'],fallbackIndex:6}},filters:{active:{column:'status',includes:['æ´»è·ƒ','è¿›è¡Œä¸­','è¿›è¡Œ'],excludeColumn:'type',excludes:['è§„åˆ™']}}},bag:{tableKeywords:['èƒŒåŒ…ç‰©å“','èƒŒåŒ…','ç‰©å“','é“å…·','åº“å­˜','å‚¨ç‰©è¢‹','ç©ºé—´æˆ’æŒ‡','æŒæœ‰ç‰©å“è¡¨'],columns:{name:{keywords:['ç‰©å“åç§°','åç§°','ç‰©å“å'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»','ç‰©å“ç±»å‹'],fallbackIndex:2},count:{keywords:['æ•°é‡','ä¸ªæ•°','æŒæœ‰æ•°'],fallbackIndex:3}}},skill:{tableKeywords:['ä¸»è§’æŠ€èƒ½','æŠ€èƒ½è¡¨','æŠ€èƒ½','èƒ½åŠ›','é­”æ³•','è¶…èƒ½åŠ›','å¼‚èƒ½','ç¥é€š','é“æ³•','åŠŸæ³•','è¡€è„‰','å¤©èµ‹','ä¹‰ä½“æ”¹é€ ','è¶…å‡¡èƒ½åŠ›','è¯æ¡'],columns:{name:{keywords:['æŠ€èƒ½åç§°','åç§°','æŠ€èƒ½å'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»'],fallbackIndex:2},level:{keywords:['ç­‰çº§','çº§åˆ«','ç†Ÿç»ƒåº¦','lv'],fallbackIndex:3}}},equip:{tableKeywords:['è£…å¤‡è¡¨','è£…å¤‡','æ­¦å™¨','é˜²å…·','æ³•å®','çµå™¨','ä»™å™¨','ç¥å™¨','ä¹‰ä½“','ç¥è£…'],columns:{name:{keywords:['è£…å¤‡åç§°','åç§°','è£…å¤‡å'],fallbackIndex:1},type:{keywords:['ç±»å‹','åˆ†ç±»'],fallbackIndex:2},part:{keywords:['éƒ¨ä½','è£…å¤‡éƒ¨ä½','ä½ç½®'],fallbackIndex:3},isEquipped:{keywords:['çŠ¶æ€','æ˜¯å¦è£…å¤‡','è£…å¤‡çŠ¶æ€','è£…å¤‡ä¸­'],fallbackIndex:4}},filters:{equipped:{column:'isEquipped',includes:['å·²è£…å¤‡','è£…å¤‡ä¸­','true','æ˜¯','yes','equipped']}}}},Ie={findTable(e,t){const n=Se[t];if(!n)return console.info(`[DICE]ä»ªè¡¨ç›˜æŸ¥æ‰¾è¡¨æ ¼: æ¨¡å—"${t}"é…ç½®ä¸å­˜åœ¨`),null;for(const a of n.tableKeywords)for(const i in e)if(i.includes(a))return console.info(`[DICE]ä»ªè¡¨ç›˜æŸ¥æ‰¾è¡¨æ ¼: æ¨¡å—"${t}"æ‰¾åˆ°è¡¨æ ¼"${i}" (å…³é”®è¯: "${a}")`),{data:e[i],name:i,key:e[i].key,config:n};return console.info(`[DICE]ä»ªè¡¨ç›˜æŸ¥æ‰¾è¡¨æ ¼: æ¨¡å—"${t}"æœªæ‰¾åˆ°åŒ¹é…è¡¨æ ¼ (å…³é”®è¯: ${n.tableKeywords.join(', ')})`),null},findColumnIndex(e,t,n){const a=n.columns[t];if(!a)return-1;for(let t=0;t<e.length;t++){const n=String(e[t]||'').toLowerCase();if(a.keywords.some(e=>n.includes(e.toLowerCase())))return t}return a.fallbackIndex??-1},getValue(e,t,n,a){const i=this.findColumnIndex(t,n,a);return i<0||i>=e.length?null:e[i]},getColumnMap(e,t){const n=Se[t];if(!n)return{};const a={};for(const t in n.columns)a[t]=this.findColumnIndex(e,t,n);return a},parseRows(e,t){if(!e||!e.data)return console.info(`[DICE]ä»ªè¡¨ç›˜è§£ææ•°æ®: æ¨¡å—"${t}"æ— æ•°æ®ï¼Œè·³è¿‡è§£æ`),[];const{data:n,config:a}=e,i=n.headers||[],o=n.rows||[],r=this.getColumnMap(i,t),c=o.map((e,t)=>{const n={_rowIndex:t,_raw:e};for(const t in r){const a=r[t];n[t]=a>=0&&a<e.length?e[a]:null}return n});return console.info(`[DICE]ä»ªè¡¨ç›˜è§£ææ•°æ®: æ¨¡å—"${t}"è§£æå®Œæˆï¼Œå…±${c.length}è¡Œ`),c},applyFilter(e,t,n){const a=Se[n];if(!a||!a.filters||!a.filters[t])return e;const i=a.filters[t];return e.some(e=>null!==e[i.column]&&void 0!==e[i.column])?e.filter(e=>{const t=String(e[i.column]||'').toLowerCase(),n=i.includes.some(e=>t.includes(e.toLowerCase()));if(i.excludeColumn&&i.excludes){const t=String(e[i.excludeColumn]||'').toLowerCase(),a=i.excludes.some(e=>t.includes(e.toLowerCase()));return n&&!a}return n}):e}},Te={enabled:!0,diceSystem:'1d100',showDiceIcon:!0,autoSendPrompt:!0,action_groups:[{table_keywords:['åœ°ç‚¹','åœ°å›¾','Location','Map','ä¸–ç•Œ','åœºæ‰€'],actions:[{label:'å‰å¾€',icon:'fa-walking',type:'prompt',template:'<user>å‰å¾€{Name}ã€‚',auto_send:!0},{label:'æ¢ç´¢',icon:'fa-search',type:'prompt',template:'<user>æ¢ç´¢{Name}ã€‚',auto_send:!0},{label:'åœç•™',icon:'fa-clock',type:'prompt',template:'<user>åœ¨{Name}åœç•™ã€‚',auto_send:!0}]},{table_keywords:['äººç‰©','NPC','é‡è¦äººç‰©','è§’è‰²','å¥³ä¸»'],actions:[{label:'äº¤è°ˆ',icon:'fa-comments',type:'prompt',template:'<user>ä¸{Name}äº¤è°ˆã€‚',auto_send:!0},{label:'è§‚å¯Ÿ',icon:'fa-eye',type:'prompt',template:'<user>è§‚å¯Ÿ{Name}ã€‚',auto_send:!0},{label:'æˆ˜æ–—',icon:'fa-hand-fist',type:'prompt',template:'<user>ä¸{Name}æˆ˜æ–—ã€‚',auto_send:!0}]},{table_keywords:['ç‰©å“','èƒŒåŒ…','é“å…·'],actions:[{label:'ä½¿ç”¨',icon:'fa-hand-pointer',type:'prompt',template:'<user>ä½¿ç”¨äº†{Name}ã€‚',auto_send:!0},{label:'æŸ¥çœ‹',icon:'fa-eye',type:'prompt',template:'<user>æŸ¥çœ‹äº†{Name}ã€‚',auto_send:!0},{label:'ä¸¢å¼ƒ',icon:'fa-trash',type:'prompt',template:'<user>ä¸¢å¼ƒäº†{Name}ã€‚',auto_send:!0}]},{table_keywords:['è£…å¤‡','æ­¦å™¨','é˜²å…·'],actions:[{label:'è£…å¤‡',icon:'fa-shield-halved',type:'prompt',template:'<user>è£…å¤‡äº†{Name}ã€‚',auto_send:!0},{label:'å¸ä¸‹',icon:'fa-circle-xmark',type:'prompt',template:'<user>å¸ä¸‹äº†{Name}ã€‚',auto_send:!0},{label:'å–å‡º',icon:'fa-coins',type:'prompt',template:'<user>å–å‡ºäº†{Name}ã€‚',auto_send:!0}]},{table_keywords:['æŠ€èƒ½','èƒ½åŠ›'],actions:[{label:'ä½¿ç”¨',icon:'fa-wand-magic-sparkles',type:'skill_check',template:'<user>ä½¿ç”¨{Name}ã€‚',auto_send:!0},{label:'ç»ƒä¹ ',icon:'fa-dumbbell',type:'prompt',template:'<user>ç»ƒä¹ {Name}ã€‚',auto_send:!0}]},{table_keywords:['å¤‡å¿˜','ä»»åŠ¡','äº‹é¡¹'],actions:[{label:'è¿½è¸ª',icon:'fa-crosshairs',type:'prompt',template:'<user>å°†{Name}è®¾ä¸ºå½“å‰è¿½è¸ªç›®æ ‡ã€‚',auto_send:!0},{label:'æ•´ç†',icon:'fa-list-check',type:'prompt',template:'<user>æ•´ç†å…³äº{Name}çš„ä¿¡æ¯ã€‚',auto_send:!0},{label:'æ”¾å¼ƒ',icon:'fa-circle-xmark',type:'prompt',template:'<user>æ”¾å¼ƒäº†{Name}ã€‚',auto_send:!0}]},{table_keywords:['åŠ¿åŠ›','ç»„ç»‡','é˜µè¥'],actions:[{label:'æ‰“æ¢',icon:'fa-ear-listen',type:'prompt',template:'<user>æ‰“æ¢{Name}çš„æƒ…æŠ¥ã€‚',auto_send:!0},{label:'åŠ å…¥',icon:'fa-user-plus',type:'prompt',template:'<user>ç”³è¯·åŠ å…¥{Name}ã€‚',auto_send:!0},{label:'åˆä½œ',icon:'fa-handshake',type:'prompt',template:'<user>å‘{Name}è¯·æ±‚åˆä½œã€‚',auto_send:!0}]}]},Fe={retro:{bgPanel:'#e6e2d3',border:'#dcd0c0',textMain:'#5e4b35',textSub:'#8a7a6a',btnBg:'#dcd0c0',btnHover:'#cbbba8',accent:'#7a695f',tableHead:'#efebe4',successText:'#27ae60',successBg:'rgba(39, 174, 96, 0.15)',inputBg:'#f5f2eb',inputText:'#5e4b35',placeholderText:'#a09080',btnActiveBg:'#8d7b6f',btnActiveText:'#fdfaf5',failureText:'#e74c3c',failureBg:'rgba(231, 76, 60, 0.15)',warningText:'#f39c12',warningBg:'rgba(243, 156, 18, 0.15)',critSuccessText:'#9b59b6',critSuccessBg:'rgba(155, 89, 182, 0.15)',critFailureText:'#c0392b',critFailureBg:'rgba(192, 57, 43, 0.15)',extremeSuccessText:'#2980b9',extremeSuccessBg:'rgba(41, 128, 185, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#e74c3c',errorBg:'rgba(231, 76, 60, 0.15)',errorBorder:'rgba(231, 76, 60, 0.5)',warningIcon:'#e67e22',buttonTextOnAccent:'#fff'},dark:{bgPanel:'rgba(30, 30, 30, 0.98)',border:'#444',textMain:'#eee',textSub:'#999',btnBg:'rgba(60, 60, 60, 0.9)',btnHover:'#505050',accent:'#9b8cd9',tableHead:'rgba(45, 45, 45, 0.95)',successText:'#4cd964',successBg:'rgba(76, 217, 100, 0.2)',inputBg:'rgba(50, 50, 50, 0.95)',inputText:'#eee',placeholderText:'#777',btnActiveBg:'#6a5acd',btnActiveText:'#fff',failureText:'#ff6b6b',failureBg:'rgba(255, 107, 107, 0.2)',warningText:'#ffa726',warningBg:'rgba(255, 167, 38, 0.2)',critSuccessText:'#ba68c8',critSuccessBg:'rgba(186, 104, 200, 0.2)',critFailureText:'#d32f2f',critFailureBg:'rgba(211, 47, 47, 0.2)',extremeSuccessText:'#42a5f5',extremeSuccessBg:'rgba(66, 165, 245, 0.2)',overlayBg:'rgba(0,0,0,0.75)',overlayBgLight:'rgba(0,0,0,0.65)',shadowBg:'rgba(0,0,0,0.6)',lightBg:'rgba(255,255,255,0.05)',veryLightBg:'rgba(255,255,255,0.02)',buttonText:'#fff',grayBg:'rgba(255,255,255,0.1)',errorText:'#ff6b6b',errorBg:'rgba(255, 107, 107, 0.2)',errorBorder:'rgba(255, 107, 107, 0.5)',warningIcon:'#ffa726',buttonTextOnAccent:'#fff'},modern:{bgPanel:'#f8f9fa',border:'#e0e0e0',textMain:'#333',textSub:'#666',btnBg:'#e9ecef',btnHover:'#dee2e6',accent:'#007bff',tableHead:'#f1f3f5',successText:'#28a745',successBg:'rgba(40, 167, 69, 0.15)',inputBg:'#fff',inputText:'#333',placeholderText:'#999',btnActiveBg:'#007bff',btnActiveText:'#fff',failureText:'#dc3545',failureBg:'rgba(220, 53, 69, 0.15)',warningText:'#ffc107',warningBg:'rgba(255, 193, 7, 0.15)',critSuccessText:'#6f42c1',critSuccessBg:'rgba(111, 66, 193, 0.15)',critFailureText:'#c82333',critFailureBg:'rgba(200, 35, 51, 0.15)',extremeSuccessText:'#17a2b8',extremeSuccessBg:'rgba(23, 162, 184, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#dc3545',errorBg:'rgba(220, 53, 69, 0.15)',errorBorder:'rgba(220, 53, 69, 0.5)',warningIcon:'#fd7e14',buttonTextOnAccent:'#fff'},forest:{bgPanel:'#e8f5e9',border:'#a5d6a7',textMain:'#2e7d32',textSub:'#66bb6a',btnBg:'#c8e6c9',btnHover:'#a5d6a7',accent:'#43a047',tableHead:'#dcedc8',successText:'#2e7d32',successBg:'rgba(46, 125, 50, 0.2)',inputBg:'#f1f8e9',inputText:'#2e7d32',placeholderText:'#81c784',btnActiveBg:'#43a047',btnActiveText:'#fff',failureText:'#c62828',failureBg:'rgba(198, 40, 40, 0.15)',warningText:'#f57c00',warningBg:'rgba(245, 124, 0, 0.15)',critSuccessText:'#7b1fa2',critSuccessBg:'rgba(123, 31, 162, 0.15)',critFailureText:'#b71c1c',critFailureBg:'rgba(183, 28, 28, 0.15)',extremeSuccessText:'#0277bd',extremeSuccessBg:'rgba(2, 119, 189, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#c62828',errorBg:'rgba(198, 40, 40, 0.15)',errorBorder:'rgba(198, 40, 40, 0.5)',warningIcon:'#e67e22',buttonTextOnAccent:'#fff'},ocean:{bgPanel:'#e3f2fd',border:'#90caf9',textMain:'#1565c0',textSub:'#42a5f5',btnBg:'#bbdefb',btnHover:'#90caf9',accent:'#1976d2',tableHead:'#bbdefb',successText:'#0288d1',successBg:'rgba(2, 136, 209, 0.15)',inputBg:'#e1f5fe',inputText:'#1565c0',placeholderText:'#64b5f6',btnActiveBg:'#1976d2',btnActiveText:'#fff',failureText:'#d32f2f',failureBg:'rgba(211, 47, 47, 0.15)',warningText:'#f57c00',warningBg:'rgba(245, 124, 0, 0.15)',critSuccessText:'#7b1fa2',critSuccessBg:'rgba(123, 31, 162, 0.15)',critFailureText:'#b71c1c',critFailureBg:'rgba(183, 28, 28, 0.15)',extremeSuccessText:'#0277bd',extremeSuccessBg:'rgba(2, 119, 189, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#d32f2f',errorBg:'rgba(211, 47, 47, 0.15)',errorBorder:'rgba(211, 47, 47, 0.5)',warningIcon:'#f57c00',buttonTextOnAccent:'#fff'},cyber:{bgPanel:'#0a0a0a',border:'#00ffcc33',textMain:'#00ffcc',textSub:'#00cc99',btnBg:'rgba(0, 255, 204, 0.1)',btnHover:'rgba(0, 255, 204, 0.2)',accent:'#00ffcc',tableHead:'rgba(0, 255, 204, 0.05)',successText:'#0f0',successBg:'rgba(0, 255, 0, 0.15)',inputBg:'rgba(0, 0, 0, 0.6)',inputText:'#00ffcc',placeholderText:'#006655',btnActiveBg:'#ff00ff',btnActiveText:'#fff',failureText:'#ff0066',failureBg:'rgba(255, 0, 102, 0.2)',warningText:'#ffaa00',warningBg:'rgba(255, 170, 0, 0.2)',critSuccessText:'#ff00ff',critSuccessBg:'rgba(255, 0, 255, 0.2)',critFailureText:'#ff0000',critFailureBg:'rgba(255, 0, 0, 0.2)',extremeSuccessText:'#00ffff',extremeSuccessBg:'rgba(0, 255, 255, 0.2)',overlayBg:'rgba(0,0,0,0.8)',overlayBgLight:'rgba(0,0,0,0.7)',shadowBg:'rgba(0,255,204,0.3)',lightBg:'rgba(0,255,204,0.05)',veryLightBg:'rgba(0,255,204,0.02)',buttonText:'#fff',grayBg:'rgba(0,255,204,0.1)',buttonBg:'rgba(0, 200, 150, 0.6)',buttonBgActive:'rgba(0, 180, 130, 0.7)',presetButtonBg:'rgba(0, 200, 150, 0.3)',presetButtonBgActive:'rgba(0, 200, 150, 0.6)',errorText:'#ff0066',errorBg:'rgba(255, 0, 102, 0.2)',errorBorder:'rgba(255, 0, 102, 0.5)',warningIcon:'#ffaa00',buttonTextOnAccent:'#000'},nightowl:{bgPanel:'#011627',border:'#132e45',textMain:'#e0e6f2',textSub:'#a6b8cc',btnBg:'#1f3a52',btnHover:'#2a4a68',accent:'#7fdbca',tableHead:'#0a2133',successText:'#addb67',successBg:'rgba(173, 219, 103, 0.15)',inputBg:'#00101c',inputText:'#e0e6f2',placeholderText:'#6a8090',btnActiveBg:'#7fdbca',btnActiveText:'#011627',failureText:'#ff6b6b',failureBg:'rgba(255, 107, 107, 0.2)',warningText:'#ffa726',warningBg:'rgba(255, 167, 38, 0.2)',critSuccessText:'#c792ea',critSuccessBg:'rgba(199, 146, 234, 0.2)',critFailureText:'#ef5350',critFailureBg:'rgba(239, 83, 80, 0.2)',extremeSuccessText:'#82aaff',extremeSuccessBg:'rgba(130, 170, 255, 0.2)',overlayBg:'rgba(0,0,0,0.75)',overlayBgLight:'rgba(0,0,0,0.65)',shadowBg:'rgba(0,0,0,0.6)',lightBg:'rgba(255,255,255,0.05)',veryLightBg:'rgba(255,255,255,0.02)',buttonText:'#fff',grayBg:'rgba(255,255,255,0.1)',buttonBg:'rgba(127, 219, 202, 0.4)',buttonBgActive:'rgba(127, 219, 202, 0.5)',presetButtonBg:'rgba(127, 219, 202, 0.2)',presetButtonBgActive:'rgba(127, 219, 202, 0.4)',errorText:'#ff6b6b',errorBg:'rgba(255, 107, 107, 0.2)',errorBorder:'rgba(255, 107, 107, 0.5)',warningIcon:'#ffa726',buttonTextOnAccent:'#000'},sakura:{bgPanel:'#F9F0EF',border:'#EBDCD9',textMain:'#6B5552',textSub:'#C08D8D',btnBg:'#EBDCD9',btnHover:'#D8C7C4',accent:'#C08D8D',tableHead:'#F9F0EF',successText:'#6B5552',successBg:'rgba(192, 141, 141, 0.12)',inputBg:'#F9F0EF',inputText:'#6B5552',placeholderText:'#C08D8D',btnActiveBg:'#C08D8D',btnActiveText:'#F9F0EF',failureText:'#9B7A7A',failureBg:'rgba(155, 122, 122, 0.12)',warningText:'#A68A7A',warningBg:'rgba(166, 138, 122, 0.12)',critSuccessText:'#8B7A7A',critSuccessBg:'rgba(139, 122, 122, 0.12)',critFailureText:'#8B6F6F',critFailureBg:'rgba(139, 111, 111, 0.12)',extremeSuccessText:'#9B8A8A',extremeSuccessBg:'rgba(155, 138, 138, 0.12)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(107, 85, 82, 0.3)',lightBg:'rgba(192, 141, 141, 0.08)',veryLightBg:'rgba(192, 141, 141, 0.02)',buttonText:'#F9F0EF',grayBg:'rgba(192, 141, 141, 0.08)',buttonBg:'rgba(192, 141, 141, 0.4)',buttonBgActive:'rgba(192, 141, 141, 0.5)',presetButtonBg:'rgba(192, 141, 141, 0.2)',presetButtonBgActive:'rgba(192, 141, 141, 0.4)',errorText:'#9B7A7A',errorBg:'rgba(155, 122, 122, 0.12)',errorBorder:'rgba(155, 122, 122, 0.4)',warningIcon:'#A68A7A',buttonTextOnAccent:'#fff'},minepink:{bgPanel:'#1a1a1a',border:'#333333',textMain:'#ffb3d9',textSub:'#ff80c1',btnBg:'#2a2a2a',btnHover:'#3a3a3a',accent:'#ff80c1',tableHead:'#252525',successText:'#ff80c1',successBg:'rgba(255, 128, 193, 0.2)',inputBg:'#222222',inputText:'#ffb3d9',placeholderText:'#666666',btnActiveBg:'#ff80c1',btnActiveText:'#1a1a1a',failureText:'#ff6b6b',failureBg:'rgba(255, 107, 107, 0.2)',warningText:'#ffa726',warningBg:'rgba(255, 167, 38, 0.2)',critSuccessText:'#ff80c1',critSuccessBg:'rgba(255, 128, 193, 0.2)',critFailureText:'#ff4444',critFailureBg:'rgba(255, 68, 68, 0.2)',extremeSuccessText:'#ffb3d9',extremeSuccessBg:'rgba(255, 179, 217, 0.2)',overlayBg:'rgba(0,0,0,0.8)',overlayBgLight:'rgba(0,0,0,0.7)',shadowBg:'rgba(0,0,0,0.6)',lightBg:'rgba(255, 128, 193, 0.1)',veryLightBg:'rgba(255, 128, 193, 0.02)',buttonText:'#1a1a1a',grayBg:'rgba(255, 128, 193, 0.1)',buttonBg:'rgba(255, 128, 193, 0.7)',buttonBgActive:'rgba(255, 128, 193, 0.8)',presetButtonBg:'rgba(255, 128, 193, 0.2)',presetButtonBgActive:'rgba(255, 128, 193, 0.4)',errorText:'#ff6b6b',errorBg:'rgba(255, 107, 107, 0.2)',errorBorder:'rgba(255, 107, 107, 0.5)',warningIcon:'#ffa726',buttonTextOnAccent:'#000'},purple:{bgPanel:'#f3e5f5',border:'#ce93d8',textMain:'#6a1b9a',textSub:'#9c27b0',btnBg:'#e1bee7',btnHover:'#ce93d8',accent:'#9c27b0',tableHead:'#f8e1f5',successText:'#6a1b9a',successBg:'rgba(106, 27, 154, 0.15)',inputBg:'#fce4ec',inputText:'#6a1b9a',placeholderText:'#ba68c8',btnActiveBg:'#9c27b0',btnActiveText:'#fff',failureText:'#d32f2f',failureBg:'rgba(211, 47, 47, 0.15)',warningText:'#f57c00',warningBg:'rgba(245, 124, 0, 0.15)',critSuccessText:'#7b1fa2',critSuccessBg:'rgba(123, 31, 162, 0.15)',critFailureText:'#b71c1c',critFailureBg:'rgba(183, 28, 28, 0.15)',extremeSuccessText:'#6a1b9a',extremeSuccessBg:'rgba(106, 27, 154, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(156, 39, 176, 0.1)',veryLightBg:'rgba(156, 39, 176, 0.02)',buttonText:'#fff',grayBg:'rgba(156, 39, 176, 0.1)',buttonBg:'rgba(156, 39, 176, 0.6)',buttonBgActive:'rgba(156, 39, 176, 0.7)',presetButtonBg:'rgba(156, 39, 176, 0.3)',presetButtonBgActive:'rgba(156, 39, 176, 0.6)',errorText:'#d32f2f',errorBg:'rgba(211, 47, 47, 0.15)',errorBorder:'rgba(211, 47, 47, 0.5)',warningIcon:'#f57c00',buttonTextOnAccent:'#fff'},wechat:{bgPanel:'#F7F7F7',border:'#E5E5E5',textMain:'#333333',textSub:'#666666',btnBg:'#E5E5E5',btnHover:'#D5D5D5',accent:'#09B83E',tableHead:'#F0F0F0',successText:'#09B83E',successBg:'rgba(9, 184, 62, 0.12)',inputBg:'#FFFFFF',inputText:'#333333',placeholderText:'#999999',btnActiveBg:'#09B83E',btnActiveText:'#FFFFFF',failureText:'#E53E3E',failureBg:'rgba(229, 62, 62, 0.12)',warningText:'#FF9500',warningBg:'rgba(255, 149, 0, 0.12)',critSuccessText:'#07A832',critSuccessBg:'rgba(7, 168, 50, 0.15)',critFailureText:'#C53030',critFailureBg:'rgba(197, 48, 48, 0.15)',extremeSuccessText:'#09B83E',extremeSuccessBg:'rgba(9, 184, 62, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.2)',lightBg:'rgba(9, 184, 62, 0.08)',veryLightBg:'rgba(9, 184, 62, 0.02)',buttonText:'#FFFFFF',grayBg:'rgba(9, 184, 62, 0.08)',buttonBg:'rgba(9, 184, 62, 0.7)',buttonBgActive:'rgba(9, 184, 62, 0.85)',presetButtonBg:'rgba(9, 184, 62, 0.3)',presetButtonBgActive:'rgba(9, 184, 62, 0.6)',errorText:'#E53E3E',errorBg:'rgba(229, 62, 62, 0.12)',errorBorder:'rgba(229, 62, 62, 0.5)',warningIcon:'#FF9500',buttonTextOnAccent:'#fff'},educational:{bgPanel:'#000000',border:'#1B1B1B',textMain:'#FFFFFF',textSub:'#CCCCCC',btnBg:'#1B1B1B',btnHover:'#2B2B2B',accent:'#FF9900',tableHead:'#1B1B1B',successText:'#FF9900',successBg:'rgba(255, 153, 0, 0.15)',inputBg:'#1B1B1B',inputText:'#FFFFFF',placeholderText:'#666666',btnActiveBg:'#FF9900',btnActiveText:'#000000',failureText:'#FF6B6B',failureBg:'rgba(255, 107, 107, 0.2)',warningText:'#FFAA00',warningBg:'rgba(255, 170, 0, 0.2)',critSuccessText:'#FF9900',critSuccessBg:'rgba(255, 153, 0, 0.2)',critFailureText:'#FF4444',critFailureBg:'rgba(255, 68, 68, 0.2)',extremeSuccessText:'#FFB84D',extremeSuccessBg:'rgba(255, 184, 77, 0.2)',overlayBg:'rgba(0,0,0,0.8)',overlayBgLight:'rgba(0,0,0,0.7)',shadowBg:'rgba(0,0,0,0.6)',lightBg:'rgba(255, 153, 0, 0.1)',veryLightBg:'rgba(255, 153, 0, 0.02)',buttonText:'#FFFFFF',grayBg:'rgba(255, 255, 255, 0.1)',buttonBg:'rgba(255, 153, 0, 0.7)',buttonBgActive:'rgba(255, 153, 0, 0.85)',presetButtonBg:'rgba(255, 153, 0, 0.3)',presetButtonBgActive:'rgba(255, 153, 0, 0.6)',errorText:'#FF6B6B',errorBg:'rgba(255, 107, 107, 0.2)',errorBorder:'rgba(255, 107, 107, 0.5)',warningIcon:'#FFAA00',buttonTextOnAccent:'#000000'},galgame:{bgPanel:'#FFF0F5',border:'#F0D4E4',textMain:'#6B4A5A',textSub:'#B08A9A',btnBg:'#FFE4E9',btnHover:'#FFD4E4',accent:'#E8B4D9',tableHead:'#FFF5F9',successText:'#D4A5C8',successBg:'rgba(212, 165, 200, 0.15)',inputBg:'#FFF8FA',inputText:'#6B4A5A',placeholderText:'#C8A5B0',btnActiveBg:'#E8B4D9',btnActiveText:'#6B4A5A',failureText:'#C88A9A',failureBg:'rgba(200, 138, 154, 0.15)',warningText:'#D4A5A5',warningBg:'rgba(212, 165, 165, 0.15)',critSuccessText:'#E8B4D9',critSuccessBg:'rgba(232, 180, 217, 0.2)',critFailureText:'#C88A9A',critFailureBg:'rgba(200, 138, 154, 0.2)',extremeSuccessText:'#D4A5C8',extremeSuccessBg:'rgba(212, 165, 200, 0.2)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(232, 180, 217, 0.25)',lightBg:'rgba(232, 180, 217, 0.08)',veryLightBg:'rgba(232, 180, 217, 0.02)',buttonText:'#6B4A5A',grayBg:'rgba(232, 180, 217, 0.1)',buttonBg:'rgba(232, 180, 217, 0.6)',buttonBgActive:'rgba(232, 180, 217, 0.75)',presetButtonBg:'rgba(232, 180, 217, 0.3)',presetButtonBgActive:'rgba(232, 180, 217, 0.6)',errorText:'#C88A9A',errorBg:'rgba(200, 138, 154, 0.15)',errorBorder:'rgba(200, 138, 154, 0.4)',warningIcon:'#D4A5A5',buttonTextOnAccent:'#6B4A5A'},vaporwave:{bgPanel:'#191970',border:'rgba(0, 255, 255, 0.3)',textMain:'#00FFFF',textSub:'#FF00FF',btnBg:'rgba(25, 25, 112, 0.8)',btnHover:'rgba(0, 255, 255, 0.2)',accent:'#00FFFF',tableHead:'rgba(25, 25, 112, 0.9)',successText:'#00FFFF',successBg:'rgba(0, 255, 255, 0.15)',inputBg:'rgba(25, 25, 112, 0.6)',inputText:'#00FFFF',placeholderText:'#FF00FF',btnActiveBg:'#FF00FF',btnActiveText:'#F0F8FF',failureText:'#FF00FF',failureBg:'rgba(255, 0, 255, 0.2)',warningText:'#FF00FF',warningBg:'rgba(255, 0, 255, 0.15)',critSuccessText:'#00FFFF',critSuccessBg:'rgba(0, 255, 255, 0.2)',critFailureText:'#FF00FF',critFailureBg:'rgba(255, 0, 255, 0.25)',extremeSuccessText:'#00FFFF',extremeSuccessBg:'rgba(0, 255, 255, 0.2)',overlayBg:'rgba(25, 25, 112, 0.85)',overlayBgLight:'rgba(25, 25, 112, 0.75)',shadowBg:'rgba(0, 255, 255, 0.3)',lightBg:'rgba(0, 255, 255, 0.05)',veryLightBg:'rgba(0, 255, 255, 0.02)',buttonText:'#F0F8FF',grayBg:'rgba(0, 255, 255, 0.1)',buttonBg:'rgba(0, 255, 255, 0.6)',buttonBgActive:'rgba(255, 0, 255, 0.7)',presetButtonBg:'rgba(0, 255, 255, 0.3)',presetButtonBgActive:'rgba(0, 255, 255, 0.6)',errorText:'#FF00FF',errorBg:'rgba(255, 0, 255, 0.2)',errorBorder:'rgba(255, 0, 255, 0.5)',warningIcon:'#FF00FF',buttonTextOnAccent:'#191970'},classicpackaging:{bgPanel:'#000000',border:'#FFFF00',textMain:'#FFFF00',textSub:'#CCCC00',btnBg:'#FF0000',btnHover:'#CC0000',accent:'#FF0000',tableHead:'#1a1a1a',successText:'#0000FF',successBg:'rgba(0, 0, 255, 0.2)',inputBg:'#1a1a1a',inputText:'#FFFF00',placeholderText:'#666600',btnActiveBg:'#0000FF',btnActiveText:'#FFFF00',failureText:'#FF0000',failureBg:'rgba(255, 0, 0, 0.2)',warningText:'#FF0000',warningBg:'rgba(255, 0, 0, 0.15)',critSuccessText:'#0000FF',critSuccessBg:'rgba(0, 0, 255, 0.2)',critFailureText:'#FF0000',critFailureBg:'rgba(255, 0, 0, 0.25)',extremeSuccessText:'#0000FF',extremeSuccessBg:'rgba(0, 0, 255, 0.2)',overlayBg:'rgba(0, 0, 0, 0.9)',overlayBgLight:'rgba(0, 0, 0, 0.8)',shadowBg:'rgba(0, 0, 0, 0.6)',lightBg:'rgba(255, 255, 0, 0.1)',veryLightBg:'rgba(255, 255, 0, 0.02)',buttonText:'#FFFF00',grayBg:'rgba(255, 255, 0, 0.1)',buttonBg:'#FF0000',buttonBgActive:'#CC0000',presetButtonBg:'rgba(255, 0, 0, 0.7)',presetButtonBgActive:'#FF0000',errorText:'#FF0000',errorBg:'rgba(255, 0, 0, 0.2)',errorBorder:'rgba(255, 0, 0, 0.8)',warningIcon:'#FF0000',buttonTextOnAccent:'#FFFF00'},terminal:{bgPanel:'#0c0c0c',border:'#00ff00',textMain:'#00ff00',textSub:'#00cc00',btnBg:'#1a1a1a',btnHover:'#2a2a2a',accent:'#00ff00',tableHead:'#0a0a0a',successText:'#00ff00',successBg:'rgba(0, 255, 0, 0.15)',inputBg:'#0c0c0c',inputText:'#00ff00',placeholderText:'#008800',btnActiveBg:'#00ff00',btnActiveText:'#0c0c0c',failureText:'#ff0000',failureBg:'rgba(255, 0, 0, 0.15)',warningText:'#ffff00',warningBg:'rgba(255, 255, 0, 0.15)',critSuccessText:'#00ffff',critSuccessBg:'rgba(0, 255, 255, 0.15)',critFailureText:'#ff00ff',critFailureBg:'rgba(255, 0, 255, 0.15)',extremeSuccessText:'#00ff00',extremeSuccessBg:'rgba(0, 255, 0, 0.2)',overlayBg:'rgba(0, 0, 0, 0.9)',overlayBgLight:'rgba(0, 0, 0, 0.8)',shadowBg:'rgba(0, 0, 0, 0.7)',lightBg:'rgba(0, 255, 0, 0.05)',veryLightBg:'rgba(0, 255, 0, 0.02)',buttonText:'#0c0c0c',grayBg:'rgba(0, 255, 0, 0.05)',errorText:'#ff0000',errorBg:'rgba(255, 0, 0, 0.15)',errorBorder:'rgba(255, 0, 0, 0.5)',warningIcon:'#ffff00',buttonTextOnAccent:'#0c0c0c'}},Me=()=>{const e=Fe[an().theme]||Fe.retro;if(e.buttonBg||(e.buttonBg=e.accent,e.buttonBgActive=e.accent,e.presetButtonBg=e.btnBg,e.presetButtonBgActive=e.accent),!e.buttonTextOnAccent){const t=e.bgPanel&&(e.bgPanel.startsWith('#F')||e.bgPanel.startsWith('#f')||e.bgPanel.startsWith('#e')||e.bgPanel.startsWith('#E')||e.bgPanel.includes('255')||e.bgPanel.includes('fff'));e.buttonTextOnAccent=t?e.textMain||'#333':'#fff'}return e},ze=(e,t)=>{const n={critSuccess:{bg:t.critSuccessText,text:'#fff'},extremeSuccess:{bg:t.extremeSuccessText,text:'#fff'},success:{bg:t.successText,text:'#fff'},warning:{bg:t.warningText,text:'#fff'},failure:{bg:t.failureText,text:'#fff'},critFailure:{bg:t.critFailureText,text:'#fff'}},a=n[e]||n.failure;return{'background-color':a.bg,color:a.text,padding:'3px 8px','border-radius':'6px','font-size':'11px','font-weight':'bold','white-space':'nowrap',display:'inline-flex','align-items':'center'}},Be=e=>{const t=bt.get('acu_gm_engine_config_v1',Te);if(!t.enabled||!t.action_groups)return[];const n=e.toLowerCase();for(const e of t.action_groups){if(e.table_keywords.some(e=>n.includes(e.toLowerCase())))return e.actions||[]}return[]},De=e=>{if(null==e||''===e)return!1;const t=String(e).trim();return/^-?\d+(\.\d+)?%?$/.test(t)||/^\d+\/\d+$/.test(t)||/^[\u4e00-\u9fa5a-zA-Z]+[:\sï¼š]\s*\d+/i.test(t)||/\d+/.test(t)},Pe=e=>{if(!e)return 0;const t=String(e).trim();if(/^\d+\/\d+$/.test(t))return parseInt(t.split('/')[0],10);if(t.endsWith('%'))return parseInt(t.replace('%',''),10);const n=t.match(/\d+/g);return n&&n.length>0?parseInt(n[n.length-1],10):0},Ne=e=>{if(!e)return[];const t=[],n=String(e).trim();if(n.startsWith('{')&&n.endsWith('}'))try{const e=JSON.parse(n);for(const n in e){const a=e[n];'number'==typeof a?t.push({name:n,value:a}):'string'==typeof a&&/^\d+$/.test(a)&&t.push({name:n,value:parseInt(a,10)})}if(t.length>0)return t}catch(e){}const a=n.split(/[,;ï¼Œï¼›\s]+/);for(const e of a){const n=e.match(/^"?([\u4e00-\u9fa5a-zA-Z_]+)"?[:\sï¼š]\s*"?(-?\d+)"?/);n&&t.push({name:n[1],value:parseInt(n[2],10)})}return t},je=e=>{if(!e)return[];const t=[],n=String(e).trim().split(/[;ï¼›]/);for(const e of n){const n=e.trim();if(!n)continue;const a=n.match(/^ä¸?(.+?)[:ï¼š](.+)$/);if(a){const e=a[1].trim(),n=a[2].trim();if(e&&n){t.push({name:e,relation:n});continue}}const i=n.match(/^([^(ï¼ˆ]+)[(ï¼ˆ]([^)ï¼‰]+)[)ï¼‰]$/);i?t.push({name:i[1].trim(),relation:i[2].trim()}):n.length>0&&t.push({name:n,relation:''})}return t},Oe=(e,t)=>{if(!e)return!1;const n=String(e).trim(),a=(t||'').toLowerCase();return!(!a.includes('å…³ç³»')&&!a.includes('äººé™…'))||/^[^(ï¼ˆ;ï¼›]+[(ï¼ˆ][^)ï¼‰]+[)ï¼‰]([;ï¼›][^(ï¼ˆ;ï¼›]+[(ï¼ˆ][^)ï¼‰]+[)ï¼‰])*$/.test(n)},Re=(e,t,n)=>{if(!e||!t)return e;let a=e;const i=t[1]||'æœªçŸ¥';return a=a.replace(/\{Name\}/gi,i),a=a.replace(/\{RowIndex\}/gi,t[0]||'0'),n&&n.length>0&&n.forEach((e,n)=>{if(e&&n<t.length){const i=t[n]||'æœªçŸ¥',o=new RegExp(`\\{${e}\\}`,'gi');a=a.replace(o,i)}}),a=a.replace(/\{[^}]+\}/g,'æœªçŸ¥'),a},Le=[{id:'acu-btn-save-global',icon:'fa-save',title:'ä¿å­˜æ‰€æœ‰ä¿®æ”¹'},{id:'acu-btn-refresh',icon:'fa-sync-alt',title:'é‡æ–°åŠ è½½'},{id:'acu-btn-collapse',icon:'fa-chevron-down',title:'æ”¶èµ·é¢æ¿'},{id:'acu-btn-refill',icon:'fa-bolt',title:'é‡æ–°å¡«è¡¨'},{id:'acu-btn-settings',icon:'fa-cog',title:'å…¨èƒ½è®¾ç½®'}];let Ue=!1,Ve=!1,Ye=!1,qe=!1,He=new Set,We=null,Xe=null,Je=null,Ke=!1,Ge=!1,Ze={},Qe={},et=null,tt=!1;const nt='acu_scroll_v19_fixed';let at={};try{const e=localStorage.getItem(nt);e&&(at=JSON.parse(e))}catch(e){console.warn('[DICE]ACU Error:',e)}const it={_lastValidationCount:0,_isRollingBack:!1,handleUpdate:()=>{if(!it._isRollingBack){try{const e=Ct(),t=ln();if(e&&t){const n=Z.getEnabledRules(),a=ne.checkTableRules(e,t,n);if(a.length>0){console.warn('[DICE]ACU è§„åˆ™æ‹¦æˆªè§¦å‘ï¼Œæ‰§è¡Œå›æ»š:',a),it._isRollingBack=!0;const t=ut().getDB();if(t?.fillTable)try{t.fillTable(e),window.toastr&&window.toastr.error(a[0].message,'å·²å›æ»š',{timeOut:5e3,positionClass:'toast-bottom-right'})}catch(e){console.error('[DICE]ACU fillTable å›æ»šå¤±è´¥:',e),window.toastr&&window.toastr.error(`è§„åˆ™æ‹¦æˆª: ${a[0].message}ï¼ˆå›æ»šæ“ä½œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°ï¼‰`,'é”™è¯¯',{timeOut:7e3,positionClass:'toast-bottom-right'})}return void setTimeout(()=>{it._isRollingBack=!1},500)}}}catch(e){console.error('[DICE]ACU æ‹¦æˆªæ£€æŸ¥å¤±è´¥:',e)}Sn(),setTimeout(()=>{try{const e=Je||ln();if(e){const t=ne.validateAllData(e).length;it._lastValidationCount,it._lastValidationCount=t,ot(t)}}catch(e){console.error('[DICE]ACU éªŒè¯æ‰§è¡Œå¤±è´¥:',e)}},100)}}},ot=e=>{const{$}=ut(),t=$('.acu-validation-indicator');e>0?t.length&&(t.find('.acu-validation-count').text(e),t.show()):t.hide()},rt=()=>{try{if('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId)return SillyTavern.getCurrentChatId();if('undefined'!=typeof SillyTavern&&SillyTavern.chatId)return SillyTavern.chatId;if(window.parent?.SillyTavern?.getCurrentChatId)return window.parent.SillyTavern.getCurrentChatId()}catch(e){console.warn('[DICE]ACU getCurrentContextFingerprint error:',e)}return'unknown_context'},ct={layout:'horizontal',collapseStyle:'bar',collapseAlign:'right',fontFamily:'default',theme:'retro',cardWidth:260,fontSize:13,highlightNew:!0,itemsPerPage:50,actionsPosition:'bottom',gridColumns:'auto',positionMode:'fixed',showOptionPanel:!0,clickOptionToAutoSend:!0,optionFontSize:12},st=[{id:'default',name:'ç³»ç»Ÿé»˜è®¤ (Modern)',val:'\'Segoe UI\', \'Microsoft YaHei\', sans-serif'},{id:'hanchan',name:'å¯’è‰å…¨åœ†ä½“',val:'"å¯’è‰å…¨åœ†ä½“", sans-serif'},{id:'maple',name:'Maple Mono (ä»£ç é£)',val:'"Maple Mono NF CN", monospace'},{id:'huiwen',name:'æ±‡æ–‡æ˜æœä½“ (Huiwen)',val:'"Huiwen-mincho", serif'},{id:'cooper',name:'Cooperæ­£æ¥·',val:'"CooperZhengKai", serif'},{id:'yffyt',name:'YFFYT (è‰ºæœ¯ä½“)',val:'"YFFYT", sans-serif'},{id:'fusion',name:'Fusion Pixel (åƒç´ é£)',val:'"Fusion Pixel 12px M latin", monospace'},{id:'wenkai',name:'éœé¹œæ–‡æ¥· (WenKai)',val:'"LXGW WenKai", serif'},{id:'notosans',name:'æ€æºé»‘ä½“ (Noto Sans)',val:'"Noto Sans CJK", sans-serif'},{id:'zhuque',name:'æœ±é›€ä»¿å®‹ (Zhuque)',val:'"Zhuque Fangsong (technical preview)", serif'}],lt=[{id:'retro',name:'å¤å¤ç¾Šçš® (Retro)',icon:'fa-scroll'},{id:'dark',name:'æå¤œæ·±ç©º (Dark)',icon:'fa-moon'},{id:'modern',name:'ç°ä»£æ¸…çˆ½ (Modern)',icon:'fa-sun'},{id:'forest',name:'æ£®ä¹‹ç‰©è¯­ (Forest)',icon:'fa-tree'},{id:'ocean',name:'æ·±æµ·å¹½è“ (Ocean)',icon:'fa-water'},{id:'cyber',name:'èµ›åšéœ“è™¹ (Cyber)',icon:'fa-bolt'},{id:'nightowl',name:'æ·±è“ç£¨ç ‚ (Night Owl)',icon:'fa-feather'},{id:'sakura',name:'æš–ç²‰æ‰‹è´¦ (Warm Pink)',icon:'fa-heart'},{id:'minepink',name:'é‡äº§åœ°é›· (Mine Pink)',icon:'fa-skull'},{id:'galgame',name:'ç²‰æ¢¦ç‰©è¯­ (Galgame Pink)',icon:'fa-heart'},{id:'purple',name:'ç´«ç½—å…°æ¢¦ (Purple)',icon:'fa-gem'},{id:'wechat',name:'ç»¿è‰²æ³¡æ³¡ (Green Bubble)',icon:'fa-weixin'},{id:'educational',name:'å­¦ä¹ èµ„æ–™ (Educational)',icon:'fa-book'},{id:'vaporwave',name:'éœ“è™¹æ€€æ—§ (Vaporwave)',icon:'fa-palette'},{id:'classicpackaging',name:'ç»å…¸åŒ…è£… (Classic Packaging)',icon:'fa-box'},{id:'terminal',name:'ç»ˆç«¯ç»¿å± (Terminal)',icon:'fa-terminal'}];let dt=null;const ut=()=>{const e=window.parent||window,$=window.jQuery||e.jQuery;if(dt&&dt.$)return dt;const t={$,getDB:()=>e.AutoCardUpdaterAPI||window.AutoCardUpdaterAPI,clipboard:e.navigator.clipboard,ST:window.SillyTavern||e.SillyTavern||(()=>{try{return window.top?window.top.SillyTavern:null}catch(e){return null}})()};return $&&(dt=t),t},pt=()=>{const{$}=ut(),e=$('#acu-btn-save-global'),t=e.find('i'),n=vt();let a=!1;if(n)for(const e in n)if(n[e]&&n[e].length>0){a=!0;break}Ke||a?(t.addClass('acu-icon-breathe'),e.attr('title','ä½ æœ‰æœªä¿å­˜çš„æ‰‹åŠ¨ä¿®æ”¹æˆ–åˆ é™¤æ“ä½œ')):(t.removeClass('acu-icon-breathe'),e.attr('title','ä¿å­˜'),e.css('color',''))},gt=e=>{if(!e)return'fa-table';const t=e.toLowerCase();return t.includes('ä¸»è§’')||t.includes('è§’è‰²')?'fa-user-circle':t.includes('é€šç”¨')||t.includes('å…¨å±€')?'fa-globe-asia':t.includes('è£…å¤‡')||t.includes('èƒŒåŒ…')?'fa-briefcase':t.includes('æŠ€èƒ½')||t.includes('æ­¦é­‚')?'fa-dragon':t.includes('å…³ç³»')||t.includes('å‘¨è¾¹')?'fa-user-friends':t.includes('ä»»åŠ¡')||t.includes('æ—¥å¿—')?'fa-scroll':t.includes('äººç‰©')||t.includes('å…³é”®äººç‰©')?'fa-address-book':t.includes('æ€»ç»“')||t.includes('å¤§çº²')?'fa-book-reader':t.includes('åœ°å›¾ç‚¹')||t.includes('ä¸–ç•Œåœ°å›¾')?'fa-map-location-dot':t.includes('åœ°å›¾å…ƒç´ ')||t.includes('æœºå…³')||t.includes('çº¿ç´¢')?'fa-bullseye':t.includes('åŠ¿åŠ›')||t.includes('é˜µè¥')?'fa-shield-halved':t.includes('ç‰©å“')?'fa-gem':t.includes('æƒ…æŠ¥')||t.includes('ä¿¡æ¯')?'fa-file-lines':t.includes('é€‰é¡¹')?'fa-list-check':'fa-table'},ft=e=>{if(!e)return'';const t=String(e).trim();return/^[0-9]+%?$/.test(t)||/^Lv\.\d+$/.test(t)?'acu-badge-green':t.length<=6&&!t.includes('http')||['æ˜¯','å¦','æœ‰','æ— ','æ­»äº¡','å­˜æ´»'].includes(t)?'acu-badge-neutral':''},bt={get:(e,t=null)=>{try{return JSON.parse(localStorage.getItem(e))??t}catch{return t}},set:(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(n){if('QuotaExceededError'===n.name||n.message.includes('quota')){console.warn('[DICE]ACU å­˜å‚¨ç©ºé—´å·²æ»¡ï¼Œè§¦å‘é™é»˜æ¸…ç†ç­–ç•¥...');try{localStorage.removeItem(f),localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error('[DICE]ACU Store æ¸…ç†åä¾ç„¶å¤±è´¥',e),window.toastr&&!window._acuQuotaAlerted&&(window.toastr.warning('âš ï¸ æµè§ˆå™¨å­˜å‚¨ç©ºé—´ä¸¥é‡ä¸è¶³ï¼Œé…ç½®ä¿å­˜å¤±è´¥'),window._acuQuotaAlerted=!0,setTimeout(()=>window._acuQuotaAlerted=!1,1e4))}}else console.error('[DICE]ACU Store',n)}}},mt=()=>bt.get(p),ht=e=>bt.set(p,e),vt=()=>bt.get(u,{}),xt=e=>bt.set(u,e),yt=()=>bt.get(l),wt=e=>bt.set(l,e),kt=()=>bt.get(b,!1),$t=e=>bt.set(b,e),Ct=()=>{const e=bt.get(f);if(!e)return null;const t=rt();return e._contextId&&e._contextId!==t?null:e},_t=e=>{e&&('object'==typeof e&&(e._contextId=rt()),bt.set(f,e))},Et=()=>bt.get(h,{}),At=e=>bt.set(h,e),St=()=>bt.get(v,{}),It=()=>bt.get(x,[]),Tt=()=>bt.get(y,[]),Ft=e=>{const t=Tt(),n=t.indexOf(e);var a;n>=0?t.splice(n,1):t.push(e),a=t,bt.set(y,a),console.log('[DICE]ACU toggleTableReverse:',e,'reversed:',n<0)},Mt=e=>{const t=Je||ln();if(!t)return[];const n=!e||'<user>'===e||''===e.trim();for(const a in t){const i=t[a];if(!i||!i.name||!i.content)continue;const o=i.name;if(n&&(o.includes('ä¸»è§’')||o.includes('ç©å®¶')||o.toLowerCase().includes('player'))&&i.content[1]){const e=i.content[0]||[],t=i.content[1];let n=[];if(e.forEach((e,a)=>{if(e&&e.includes('å±æ€§')){Ne(t[a]||'').forEach(e=>{n.includes(e.name)||n.push(e.name)})}}),n.length>0)return n}if(!n&&(o.includes('äººç‰©')||o.includes('NPC')||o.includes('è§’è‰²')||o.toLowerCase().includes('character'))){const t=i.content[0]||[];let n=1;for(let e=0;e<t.length;e++)if(t[e]&&(t[e].includes('å§“å')||t[e].includes('åç§°')||t[e].toLowerCase().includes('name'))){n=e;break}for(let a=1;a<i.content.length;a++){const o=i.content[a];if(o&&o[n]===e){let e=[];return t.forEach((t,n)=>{if(t&&t.includes('å±æ€§')){Ne(o[n]||'').forEach(t=>{e.includes(t.name)||e.push(t.name)})}}),e}}}}return[]},zt=(e,t)=>{const n=Je||ln();if(!n||!t)return null;const a=!e||'<user>'===e||''===e.trim();for(const i in n){const o=n[i];if(!o||!o.name||!o.content)continue;const r=o.name;if(a&&(r.includes('ä¸»è§’')||r.includes('ç©å®¶')||r.toLowerCase().includes('player'))&&o.content[1]){const e=o.content[0]||[],n=o.content[1];for(let a=0;a<e.length;a++){const i=e[a];if(i&&i.includes('å±æ€§')){const e=Ne(n[a]||'').find(e=>e.name===t);if(e)return e.value}}}if(!a&&(r.includes('äººç‰©')||r.includes('NPC')||r.includes('è§’è‰²')||r.toLowerCase().includes('character'))){const n=o.content[0]||[];let a=1;for(let e=0;e<n.length;e++)if(n[e]&&(n[e].includes('å§“å')||n[e].includes('åç§°')||n[e].toLowerCase().includes('name'))){a=e;break}for(let i=1;i<o.content.length;i++){const r=o.content[i];if(r&&r[a]===e)for(let e=0;e<n.length;e++){const a=n[e];if(a&&a.includes('å±æ€§')){const n=Ne(r[e]||'').find(e=>e.name===t);if(n)return n.value}}}}}return null},Bt=['åŠ›é‡','æ•æ·','ä½“è´¨','æ™ºåŠ›','æ„ŸçŸ¥','é­…åŠ›'],Dt=()=>{const e=he.getActivePreset();return e&&e.baseAttributes?e.baseAttributes.map(e=>e.name):Bt},Pt=()=>{try{const e=he.getActivePreset();if(e){const t=new Set;return e.baseAttributes&&Array.isArray(e.baseAttributes)&&e.baseAttributes.forEach(e=>{const n='string'==typeof e?e:e&&e.name;n&&t.add(n)}),e.specialAttributes&&Array.isArray(e.specialAttributes)&&e.specialAttributes.forEach(e=>{const n='string'==typeof e?e:e&&e.name;n&&t.add(n)}),Array.from(t)}const t=he.getAllPresets()||[],n=new Set(Nt||[]);return Array.isArray(t)&&t.forEach(e=>{e&&(e.baseAttributes&&Array.isArray(e.baseAttributes)&&e.baseAttributes.forEach(e=>{const t='string'==typeof e?e:e&&e.name;t&&n.add(t)}),e.specialAttributes&&Array.isArray(e.specialAttributes)&&e.specialAttributes.forEach(e=>{const t='string'==typeof e?e:e&&e.name;t&&n.add(t)}))}),Array.from(n)}catch(e){return console.error('[DICE]ACU getRandomSkillPool é”™è¯¯:',e),Nt||[]}},Nt=['æ‚æŠ€','ç‰¹æŠ€','è¿åŠ¨','æ ¼æ–—','æ–—æ®´','æ”€çˆ¬','å¥åº·','é—ªé¿','èº«æ³•','é©¾é©¶','è€åŠ›','çµå·§','å·§æ‰‹','æˆæ³•','è·‘é…·','é£è¡Œ','æ½œè¡Œ','æ¸—é€','éª‘æœ¯','æ¸¸æ³³','æŠ•æ·','è·³è·ƒ','ä½“æ“','åŠŸå¤«','æ­¦æœ¯','è¡Œæ”¿','å®˜åƒš','æƒå¨','å‘½ä»¤','äº¤æ˜“','æ®å®¢','æ¬ºè¯ˆ','è¯±éª—','è°è¨€ä¾¦æµ‹','ç‹‚æ¬¢','äº¤é™…','æ‘†å¸ƒ','é•‡å®š','é»‘è¯','è¡Œè¯','ç¤¼èŠ‚','ç¤¼ä»ª','ä¿¡èª‰','è´¢åŠ›','æˆå‰§','è¡¨æ¼”','å…±æƒ…','æ´å¯Ÿ','æƒ…æ„Ÿ','å›¢é˜Ÿç²¾ç¥','è¯æœ¯','åšå¼ˆ','èµŒåš','é˜…äºº','å°é€æ˜','å®¡è®¯','æå“','æŒ‘è¡…','é¢†å¯¼','è°ˆåˆ¤','æ¼”è¯´','ç²¾ç¥åˆ†æ','è¡—å¤´æ™ºæ…§','è¾¹ç¼˜çŸ¥è¯†','æ®‹é…·çœŸç›¸','æ„å¿—','å†³å¿ƒ','è¯´æœ','é­…æƒ‘','å¨å“','æ¸¸è¯´','äº¤æ¶‰','å¯Ÿè¨€è§‚è‰²','æ¬ºéª—','æ´æ‚‰','æ¬ºç’','æ ‡æ–°ç«‹å¼‚','è„‘å†…å‰§åœº','ç¥æ¸¸å¤ªè™š','è¸©åœ°é›·','é¡¾å·¦å³è€Œè¨€ä»–','ä¸»è§’å…‰ç¯','åšé¢œæ— è€»','ç”©é”…','é€ å‡','åºŸè¯æ–‡å­¦','ä¸Šå¤´','ç ´é˜²','ç§è‰','ç¤¾æ­»','ç‚¹å­','æƒŠä¸–æ™ºæ…§','å¥¶é¾™ä¹‹åŠ›','ç‹—å±è¿','å¤©æ„','æ¡ƒèŠ±è¿','å»ºç­‘å­¦','å†›æ¢°','æªæ¢°åˆ¶é€ ','å·¥åŒ ','æŠ€è‰º','ç”Ÿç‰©ç§‘æŠ€','éœ²è¥','åŒ–å­¦','è¯ç†','åˆ›ä½œ','ç”µè„‘','é»‘å®¢','èµ›åšæŠ€æœ¯','çˆ†ç ´','ç”µå­å­¦','å·¥ç¨‹å­¦','æ€¥æ•‘','ä¼ªé€ ','ä¿¡æ¯å®‰å…¨','ä¿®è¡¥','æ£é¼“','å¼€é”','æœºæ¢°','ä¿®ç†','åŒ»å­¦','æ‘„å½±','ç¼–ç¨‹','é”»é€ ','ç¼–è¯‘','ç§‘æŠ€ä½¿ç”¨','æœºæ¢°ç»´ä¿®','ç”µæ°”ç»´ä¿®','é”åŒ ','æ“ä½œé‡å‹æœºæ¢°','è¯å­¦','è‰ºæœ¯','ä¼šè®¡','äººç±»å­¦','æ™ºæ…§ç”Ÿç‰©å­¦','è€ƒå¤å­¦','çµè§†','å¯¼èˆª','æ–¹å‘','å¤©æ–‡å­¦','ç”Ÿç‰©å­¦','çŠ¯ç½ªå­¦','ç¥è¯','ç¦å¿ŒçŸ¥è¯†','æ–‡åŒ–','ä¹ ä¿—','æ³•åŒ»','æœè¯','å†å²','äººåŠ›æƒ…æŠ¥','è°ƒæŸ¥','æœç´¢','è¯­è¨€','è¯­è¨€å­¦','æ³•å¾‹','å›¾ä¹¦é¦†ä½¿ç”¨','ç ”ç©¶','å­¦è¯†','ä¾¦å¯Ÿ','ç¥ç§˜å­¦','ç‰©ç†','æœ‰å¤‡æ— æ‚£','ä¿¡å·æƒ…æŠ¥','ç”Ÿå­˜','æˆ˜æœ¯','ç¥å­¦','é€šè¯†','ä¾¦æŸ¥','è†å¬','å¿ƒç†å­¦','è¿½è¸ª','åšç‰©å­¦','å…‹è‹é²ç¥è¯','åœ°è´¨å­¦','æ°”è±¡å­¦','å¥¥ç§˜','è‡ªç„¶','å®—æ•™','å¯Ÿè§‰','æ±‚ç”Ÿ','æƒ…æŠ¥æ”¶é›†','ä¼°ä»·','å¯†è¯­','è¯»å”‡','æ‰‹è¯­','å¼“æœ¯','ç‚®æœ¯','å¼•å¯¼','å¬å”¤','ä¿¡ä»°','å¥‡è¿¹','å‡»å‰‘','æªæ¢°','å°„å‡»','é‡æ­¦å™¨','å…ˆæ”»','ç¥å°„','ç‹™å‡»','æ­¦è‰º','è¿‘æˆ˜','å…µå™¨','é¢„å…†','è¿æ°”','æ ¼æŒ¡','çµèƒ½','å·«æœ¯','æ–½æ³•','èŒ¶é“','ç ´å','å‰‘æœ¯','æ–§æœ¯','é­æœ¯','èº²è—','ä¹”è£…','éšåŒ¿','é©¯å…½','åŒ»ç–—','å‚¬çœ ','ä¼ªè£…','æ—¶é«¦å€¼'],jt=(e=void 0)=>{if('boolean'==typeof e){const t=e,n=e=>Math.floor(Math.random()*e)+1,a=()=>n(6)+n(6)+n(6),i=()=>{if(t){const e=a(),t=n(4)-2;return Math.max(3,Math.min(18,e+t))}{const e=5*a(),t=n(10)-5;return Math.max(5,Math.min(95,e+t))}},o={};return Bt.forEach(e=>{o[e]=i()}),o}const t=e||he.getActivePreset();if(!t){const e=e=>Math.floor(Math.random()*e)+1,t=()=>e(6)+e(6)+e(6),n={};return Bt.forEach(a=>{const i=5*t(),o=e(10)-5;n[a]=Math.max(5,Math.min(95,i+o))}),{base:n,special:{}}}const n={};t.baseAttributes.forEach(e=>{const t=e.modifier?`${e.formula}+${e.modifier}`:e.formula;n[e.name]=Ae(t,e.range,{})});const a={};return t.specialAttributes&&Array.isArray(t.specialAttributes)&&t.specialAttributes.forEach(e=>{a[e.name]=Ae(e.formula,e.range,n)}),{base:n,special:a}},Ot=async e=>{const t=Je||ln();if(!t)return console.error('[DICE]ACU clearPresetAttributesForCharacter: æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),window.toastr&&window.toastr.error('æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),{success:!1};const n=!e||'<user>'===e||''===e.trim();let a=null,i=-1,o=-1,r=null;for(const c in t){const s=t[c];if(!s||!s.name||!s.content)continue;const l=s.name,d=s.content[0]||[];if(n&&(l.includes('ä¸»è§’')||l.includes('ç©å®¶')||l.toLowerCase().includes('player'))&&s.content[1]){a=s,i=1,r=c;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('åŸºç¡€å±æ€§')){o=e;break}if(o<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('å±æ€§')){o=e;break}break}if(!n&&(l.includes('äººç‰©')||l.includes('NPC')||l.includes('è§’è‰²')||l.toLowerCase().includes('character'))){let t=1;for(let e=0;e<d.length;e++)if(d[e]&&(d[e].includes('å§“å')||d[e].includes('åç§°')||d[e].toLowerCase().includes('name'))){t=e;break}for(let n=1;n<s.content.length;n++){const l=s.content[n];if(l&&l[t]===e){a=s,i=n,r=c;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('åŸºç¡€å±æ€§')){o=e;break}if(o<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('å±æ€§')){o=e;break}break}}if(i>0)break}}if(!a||i<0)return console.error('[DICE]ACU clearPresetAttributesForCharacter: æ‰¾ä¸åˆ°è§’è‰²',e),window.toastr&&window.toastr.error(`æ‰¾ä¸åˆ°è§’è‰²ã€Œ${e||'<user>'}ã€`),{success:!1};if(o<0)return console.error('[DICE]ACU clearPresetAttributesForCharacter: æ‰¾ä¸åˆ°å±æ€§åˆ—'),window.toastr&&window.toastr.error('æ‰¾ä¸åˆ°å±æ€§åˆ—'),{success:!1};const c=a.content[i][o]||'',s=Ne(c),l=Dt(),d=he.getActivePreset(),u=new Set(l);d&&d.specialAttributes&&d.specialAttributes.forEach(e=>u.add(e.name));const p=s.filter(e=>!u.has(e.name)).map(e=>`${e.name}:${e.value}`).join(';');return a.content[i][o]=p,Je=t,await un(t),{success:!0,attrString:p}},Rt=async(e,t,n=!1)=>{const a=Je||ln();if(!a)return console.error('[DICE]ACU writeAttributesToCharacter: æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),window.toastr&&window.toastr.error('æ— æ³•è·å–è¡¨æ ¼æ•°æ®'),{success:!1};const i=!e||'<user>'===e||''===e.trim();let o=null,r=-1,c=-1,s=null;for(const t in a){const n=a[t];if(!n||!n.name||!n.content)continue;const l=n.name,d=n.content[0]||[];if(i&&(l.includes('ä¸»è§’')||l.includes('ç©å®¶')||l.toLowerCase().includes('player'))&&n.content[1]){o=n,r=1,s=t;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('åŸºç¡€å±æ€§')){c=e;break}if(c<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('å±æ€§')){c=e;break}break}if(!i&&(l.includes('äººç‰©')||l.includes('NPC')||l.includes('è§’è‰²')||l.toLowerCase().includes('character'))){let a=1;for(let e=0;e<d.length;e++)if(d[e]&&(d[e].includes('å§“å')||d[e].includes('åç§°')||d[e].toLowerCase().includes('name'))){a=e;break}for(let i=1;i<n.content.length;i++){const l=n.content[i];if(l&&l[a]===e){o=n,r=i,s=t;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('åŸºç¡€å±æ€§')){c=e;break}if(c<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('å±æ€§')){c=e;break}break}}if(r>0)break}}if(!o||r<0)return console.error('[DICE]ACU writeAttributesToCharacter: æ‰¾ä¸åˆ°è§’è‰²',e),window.toastr&&window.toastr.error(`æ‰¾ä¸åˆ°è§’è‰²ã€Œ${e||'<user>'}ã€`),{success:!1};if(c<0)return console.error('[DICE]ACU writeAttributesToCharacter: æ‰¾ä¸åˆ°å±æ€§åˆ—'),window.toastr&&window.toastr.error('æ‰¾ä¸åˆ°å±æ€§åˆ—ï¼ˆéœ€è¦åŒ…å«"å±æ€§"å…³é”®è¯çš„åˆ—ï¼‰'),{success:!1};const l=o.content[r][c]||'',d=Ne(l),u={};d.forEach(e=>{u[e.name]=e.value});const p=Dt(),g=he.getActivePreset(),f=new Set(p);g&&g.specialAttributes&&g.specialAttributes.forEach(e=>f.add(e.name));let b=0;p.forEach(e=>{void 0!==u[e]&&b++});const m=b===p.length,h=[];d.forEach(e=>{f.has(e.name)||h.push({name:e.name,value:e.value})});const v=[];p.forEach(e=>{if(m){const n=void 0!==t[e]?t[e]:u[e];void 0!==n&&v.push(`${e}:${n}`)}else void 0!==u[e]?v.push(`${e}:${u[e]}`):void 0!==t[e]&&v.push(`${e}:${t[e]}`)}),Object.keys(t).forEach(e=>{p.includes(e)||(m||!u[e]?v.push(`${e}:${t[e]}`):v.push(`${e}:${u[e]}`))}),h.forEach(e=>{v.push(`${e.name}:${e.value}`)});const x=v.join(';');o.content[r][c]=x,Je=a,await un(a);const y=[];return p.forEach(e=>{y.push({name:e,value:t[e]})}),{success:!0,attrs:y,attrString:x,wasComplete:m}},Lt=e=>{const t=Je||ln();if(!t)return[];const n=!e||'<user>'===e||''===e.trim();let a=[];for(const i in t){const o=t[i];if(!o||!o.name||!o.content)continue;const r=o.name;if(n&&(r.includes('ä¸»è§’')||r.includes('ç©å®¶')||r.toLowerCase().includes('player'))&&o.content[1]){const e=o.content[0]||[],t=o.content[1];if(e.forEach((e,n)=>{if(e&&e.includes('å±æ€§')){Ne(t[n]||'').forEach(e=>{a.some(t=>t.name===e.name)||a.push(e)})}}),a.length>0)break}if(!n&&(r.includes('äººç‰©')||r.includes('NPC')||r.includes('è§’è‰²')||r.toLowerCase().includes('character'))){const t=o.content[0]||[];let n=1;for(let e=0;e<t.length;e++)if(t[e]&&(t[e].includes('å§“å')||t[e].includes('åç§°')||t[e].toLowerCase().includes('name'))){n=e;break}for(let i=1;i<o.content.length;i++){const r=o.content[i];if(r&&r[n]===e){t.forEach((e,t)=>{if(e&&e.includes('å±æ€§')){Ne(r[t]||'').forEach(e=>{a.some(t=>t.name===e.name)||a.push(e)})}});break}}if(a.length>0)break}}return a},Ut=(e,t,n)=>{const{$}=ut(),a=n||{},i=e.attr('id')||'dd_'+Math.random().toString(36).substr(2,9);e.attr('id',i),e.parent().find('.acu-dropdown-list').remove(),e.parent().hasClass('acu-dropdown-wrapper')||e.wrap('<div class="acu-dropdown-wrapper"></div>');const r=$(`<div class="acu-dropdown-list" data-for="${i}"></div>`);r.css({background:a.bgPanel||'#fff','border-color':a.border||'#ccc'}),e.after(r);const c=(e='')=>{const n=e.toLowerCase(),i=t.filter(e=>e.toLowerCase().includes(n));0===i.length?r.html(`<div class="acu-dropdown-empty" style="color:${a.textSub||'#999'};">æ— åŒ¹é…é¡¹</div>`):r.html(i.map(e=>`<div class="acu-dropdown-item" data-value="${o(e)}" style="color:${a.textMain||'#333'};">${o(e)}</div>`).join(''))},s=()=>{r.removeClass('visible')};e.off('.acudd').on('focus.acudd click.acudd',function(t){t.stopPropagation(),$('.acu-dropdown-list').removeClass('visible'),c(e.val()),r.addClass('visible')}),e.on('input.acudd',function(){c($(this).val())}),r.on('mouseenter','.acu-dropdown-item',function(){$(this).css('background',a.tableHead||'rgba(128,128,128,0.15)')}).on('mouseleave','.acu-dropdown-item',function(){$(this).css('background','transparent')}),r.on('click','.acu-dropdown-item',function(t){t.stopPropagation(),t.preventDefault();const n=$(this).data('value');e.val(n).trigger('change'),s()}),r.on('click',function(e){e.stopPropagation()}),e.closest('.acu-dice-panel, .acu-contest-panel').off('click.acudd_'+i).on('click.acudd_'+i,function(e){$(e.target).closest('.acu-dropdown-wrapper').length||s()})},Vt=(e,t,n)=>{const{$}=ut(),a=n||{};e.find(t).each(function(){const e=$(this);if(e.parent().hasClass('acu-input-wrapper'))return;e.wrap('<div class="acu-input-wrapper"></div>');const t=$(`<button type="button" class="acu-clear-btn" title="æ¸…é™¤" style="color:${a.textSub||'#999'};"><i class="fa-solid fa-times"></i></button>`);e.after(t),t.on('click',function(t){t.preventDefault(),t.stopPropagation(),e.val('').trigger('input').trigger('change').focus()}),t.on('mouseenter',function(){$(this).css({color:a.accent||'#7a695f',opacity:'1'})}).on('mouseleave',function(){$(this).css({color:a.textSub||'#999',opacity:'0.5'})})})},Yt=(e=!1)=>{const{$}=ut();$('.acu-dice-config-overlay').remove();const t=an(),n=ge(),a=e?'DND è§„åˆ™è®¾ç½®':'COC è§„åˆ™è®¾ç½®',i=e?'æ¢å¤ DND é»˜è®¤':'æ¢å¤ COC é»˜è®¤',o=e?{critSuccess:20,critFail:1}:{critSuccess:5,critFail:96,hardDiv:2,extremeDiv:5},r=e?void 0!==n.dndCritSuccess&&n.dndCritSuccess!==o.critSuccess?n.dndCritSuccess:'':void 0!==n.critSuccessMax&&n.critSuccessMax!==o.critSuccess?n.critSuccessMax:'',c=e?void 0!==n.dndCritFail&&n.dndCritFail!==o.critFail?n.dndCritFail:'':void 0!==n.critFailMin&&n.critFailMin!==o.critFail?n.critFailMin:'',s=e||void 0===n.difficultSuccessDiv||n.difficultSuccessDiv===o.hardDiv?'':n.difficultSuccessDiv,l=e||void 0===n.hardSuccessDiv||n.hardSuccessDiv===o.extremeDiv?'':n.hardSuccessDiv,d=n.contestTieRule||'initiator_lose',u=void 0!==n.hideDiceResultFromUser&&n.hideDiceResultFromUser,p=void 0!==n.hideDiceResultInChat&&n.hideDiceResultInChat,g=e?'':`\n            <div class="acu-dice-cfg-row">\n                <div class="acu-dice-cfg-item">\n                    <label>å›°éš¾ (Ã·)</label>\n                    <div class="acu-stepper" data-id="cfg-hard-div" data-min="2" data-max="5" data-step="1">\n                        <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                        <span class="acu-stepper-value">${s||o.hardDiv}</span>\n                        <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                    </div>\n                </div>\n                <div class="acu-dice-cfg-item">\n                    <label>æéš¾ (Ã·)</label>\n                    <div class="acu-stepper" data-id="cfg-extreme-div" data-min="3" data-max="10" data-step="1">\n                        <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                        <span class="acu-stepper-value">${l||o.extremeDiv}</span>\n                        <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                    </div>\n                </div>\n            </div>\n        `,f=`\n            <div class="acu-dice-config-overlay">\n                <div class="acu-dice-config-dialog acu-theme-${t.theme}">\n                    <div class="acu-dice-cfg-header">\n                        <span><i class="fa-solid fa-cog"></i> ${a}</span>\n                        <button class="acu-config-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-dice-cfg-body">\n                        <div class="acu-dice-cfg-row">\n                            <div class="acu-dice-cfg-item">\n                                <label>å¤§æˆåŠŸé˜ˆå€¼</label>\n                                <div class="acu-stepper" data-id="cfg-crit-success" data-min="1" data-max="100" data-step="1">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${r||o.critSuccess}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                            <div class="acu-dice-cfg-item">\n                                <label>å¤§å¤±è´¥é˜ˆå€¼</label>\n                                <div class="acu-stepper" data-id="cfg-crit-fail" data-min="1" data-max="100" data-step="1">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${c||o.critFail}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                        </div>\n                        ${g}\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item">\n                                <label>å¯¹æŠ—å¹³æ‰‹è§„åˆ™</label>\n                                <select id="cfg-tie-rule">\n                                    <option value="initiator_lose" ${'initiator_lose'===d?'selected':''}>ç”²æ–¹åˆ¤è´Ÿ (é»˜è®¤)</option>\n                                    <option value="tie" ${'tie'===d?'selected':''}>åŒæ–¹å¹³æ‰‹</option>\n                                    <option value="initiator_win" ${'initiator_win'===d?'selected':''}>ç”²æ–¹åˆ¤èƒœ</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item acu-cfg-toggle-item">\n                                <label>éšè—è¾“å…¥æ ä¸­çš„æ£€å®šç»“æœ</label>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-hide-dice-result" ${u?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item acu-cfg-toggle-item">\n                                <label>éšè—èŠå¤©è®°å½•ä¸­çš„æ£€å®šç»“æœ</label>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-hide-dice-result-chat" ${p?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-actions">\n                            <button id="cfg-reset-dice">${i}</button>\n                            <button id="cfg-save-dice">ä¿å­˜</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,b=$(f);$('body').append(b),b.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',background:'rgba(0,0,0,0.6)','z-index':'2147483655',display:'flex','align-items':'center','justify-content':'center',padding:'20px','box-sizing':'border-box'});const m=Me();b.find('#cfg-reset-dice, #cfg-save-dice').css({background:m.btnBg,color:m.textMain,borderColor:m.border}),b.find('#cfg-reset-dice, #cfg-save-dice').hover(function(){$(this).css({background:m.btnHover,borderColor:m.btnHover})},function(){$(this).css({background:m.btnBg,borderColor:m.border})});const h=()=>b.remove();b.find('.acu-config-close').click(h),b.on('click',e=>{$(e.target).hasClass('acu-dice-config-overlay')&&h()}),b.find('.acu-stepper').each(function(){const e=$(this),t=(e.data('id'),parseInt(e.data('min'))),n=parseInt(e.data('max')),a=parseInt(e.data('step')),i=e.find('.acu-stepper-value'),o=e=>{e=Math.max(t,Math.min(n,e)),i.text(e)},r=()=>{const e=i.text().replace(/[^\d]/g,'');return parseInt(e)||t};e.find('.acu-stepper-dec').on('click',function(){o(r()-a)}),e.find('.acu-stepper-inc').on('click',function(){o(r()+a)})}),b.find('#cfg-save-dice').click(function(){const t={contestTieRule:$('#cfg-tie-rule').val()},n=e=>{const t=b.find(`.acu-stepper[data-id="${e}"]`);if(t.length){const e=t.find('.acu-stepper-value').text().replace(/[^\d]/g,'');return''!==e?parseInt(e,10):null}return null},a=n('cfg-crit-success'),i=n('cfg-crit-fail');if(e)t.dndCritSuccess=null!==a?a:o.critSuccess,t.dndCritFail=null!==i?i:o.critFail;else{t.critSuccessMax=null!==a?a:o.critSuccess,t.critFailMin=null!==i?i:o.critFail;const e=n('cfg-hard-div'),r=n('cfg-extreme-div');t.difficultSuccessDiv=null!==e?e:o.hardDiv,t.hardSuccessDiv=null!==r?r:o.extremeDiv}t.hideDiceResultFromUser=$('#cfg-hide-dice-result').is(':checked'),t.hideDiceResultInChat=$('#cfg-hide-dice-result-chat').is(':checked'),fe(t),console.info('[DICE]åº”ç”¨æŠ•éª°ç»“æœéšè—/æ˜¾ç¤ºè®¾ç½®...'),be(),h()}),b.find('#cfg-reset-dice').click(function(){const t=(e,t)=>{const n=b.find(`.acu-stepper[data-id="${e}"]`);n.length&&n.find('.acu-stepper-value').text(t)};t('cfg-crit-success',o.critSuccess),t('cfg-crit-fail',o.critFail),e||(t('cfg-hard-div',o.hardDiv),t('cfg-extreme-div',o.extremeDiv))})},qt=(e={})=>{const{$}=ut();$('.acu-dice-panel, .acu-dice-overlay').remove();const t=an();let n=ge().lastDiceType||'1d100';/^\d+d\d+$/i.test(n)||(n='1d100');const a=Je||ln();let i=['<user>'],c=[];if(a)for(const e in a){const t=a[e];if(t&&t.name&&t.content){if('é‡è¦äººç‰©è¡¨'===t.name)for(let e=1;e<t.content.length;e++){const n=t.content[e];n&&n[1]&&i.push(n[1])}if('ä¸»è§’ä¿¡æ¯'===t.name&&t.content[1]){const e=t.content[1];(t.content[0]||[]).forEach((t,n)=>{if(t&&t.includes('å±æ€§')){Ne(e[n]||'').forEach(e=>{c.includes(e.name)||c.push(e.name)})}})}}}const{targetValue:s=null,targetName:l='ç›®æ ‡',attrValue:d=null,diceType:u=n,successCriteria:p='lte',onResult:g=null,initiatorName:f='',fromMvu:b=!1,mvuPath:m=null,mvuParsedInfo:h=null}=e;let v=d,x=s;null!==d&&null===s&&(x='1d20'===u||'gte'===p?Math.max(0,20-d):d);const y=Me(),w='cyber'===an().theme?'#ff00ff':y.inputText,k=y.buttonTextOnAccent||y.textMain||'#6B4A5A',C=`width:100%;padding:5px;background:${y.inputBg} !important;border:1px solid ${y.border};border-radius:4px;color:${w} !important;font-size:12px;text-align:center;box-sizing:border-box;`,E=$(`<div class="acu-dice-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:${y.overlayBgLight};z-index:2147483647;"></div>`);let A=p;'1d100'===u?A='lte':'1d20'===u&&(A='gte');const S=$(`\n            <div class="acu-dice-panel acu-theme-${t.theme}" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                width: 340px;\n                max-width: 90vw;\n                background: ${y.bgPanel};\n                border: 1px solid ${y.border};\n                border-radius: 12px;\n                box-shadow: 0 20px 60px ${y.shadowBg};\n                z-index: 2147483648;\n                overflow: hidden;\n            ">\n                <div style="padding: 12px 15px; background: ${y.tableHead}; border-bottom: 1px solid ${y.border}; display: flex; justify-content: space-between; align-items: center;">\n                    <div style="font-size: 15px; font-weight: bold; color: ${y.accent}; display: flex; align-items: center; gap: 8px;">\n                        <i class="fa-solid fa-dice-d20"></i> æ™®é€šæ£€å®š\n                    </div>\n                    <div style="display: flex; align-items: center; gap: 8px;">\n                        <button id="dice-switch-contest-top" style="background: none; border: none; color: ${y.textSub}; cursor: pointer; font-size: 14px; padding: 4px; transition: all 0.2s;" title="åˆ‡æ¢åˆ°å¯¹æŠ—æ£€å®š"><i class="fa-solid fa-people-arrows"></i></button>\n                        <button class="acu-dice-config-btn" style="background: none; border: none; color: ${y.textSub}; cursor: pointer; font-size: 14px; padding: 4px; transition: all 0.2s;" title="æ·éª°è§„åˆ™è®¾ç½®">\n                            <i class="fa-solid fa-cog"></i>\n                        </button>\n                        <button class="acu-dice-close" style="background: none; border: none; color: ${y.textSub}; cursor: pointer; font-size: 16px; padding: 4px;">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    </div>\n                </div>\n                <div style="padding: 15px; max-height: 70vh; overflow-y: auto;">\n                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; align-items: center;" class="acu-dice-presets">\n                        <button class="acu-dice-preset ${'1d20'===u?'active':''}" data-dice="1d20" data-criteria="gte" style="padding: 4px 10px; background: ${'1d20'===u?y.presetButtonBgActive||y.accent:y.presetButtonBg||y.btnBg}; border: 1px solid ${y.border}; border-radius: 4px; color: ${'1d20'===u?k:y.textMain}; font-size: 11px; cursor: pointer;">1d20</button>\n                        <button class="acu-dice-preset ${'1d100'===u?'active':''}" data-dice="1d100" data-criteria="lte" style="padding: 4px 10px; background: ${'1d100'===u?y.presetButtonBgActive||y.accent:y.presetButtonBg||y.btnBg}; border: 1px solid ${y.border}; border-radius: 4px; color: ${'1d100'===u?k:y.textMain}; font-size: 11px; cursor: pointer;">1d100</button>\n                        <button class="acu-dice-preset acu-dice-custom-btn" data-dice="custom" style="padding: 4px 10px; background: ${['1d20','1d100'].includes(u)?y.presetButtonBg||y.btnBg:y.presetButtonBgActive||y.accent}; border: 1px solid ${y.border}; border-radius: 4px; color: ${['1d20','1d100'].includes(u)?y.textMain:k}; font-size: 11px; cursor: pointer;">è‡ªå®šä¹‰</button>\n                        <input type="text" id="dice-custom-input" placeholder="å¦‚2d6" value="${['1d20','1d100'].includes(u)?'':u}" style="width:60px;">\n                    </div>\n\n                    \x3c!-- å¿«æ·é€‰æ‹©è§’è‰² --\x3e\n                    <div style="margin-bottom: 10px;">\n                        <div style="font-size: 11px; color: ${y.accent}; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;"><i class="fa-solid fa-user"></i> å¿«æ·é€‰æ‹©</div>\n                        <div id="dice-char-buttons" style="display: flex; flex-wrap: wrap; gap: 4px; max-height: 60px; overflow-y: auto;"></div>\n                    </div>\n\n                    \x3c!-- ç¬¬1è¡Œï¼šåå­— + å±æ€§å --\x3e\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">\n                        <div>\n                            <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">åå­—</div>\n                            <input type="text" id="dice-initiator-name" value="${o(f)}" placeholder="<user>" style="${C}">\n                        </div>\n                        <div>\n                            <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center; gap: 6px;">\n                                å±æ€§å\n                                <button type="button" class="acu-random-skill-btn" id="dice-random-skill" title="éšæœºæŠ€èƒ½" style="width: 18px; height: 18px; padding: 0; background: transparent; border: 1px dashed ${y.accent}; border-radius: 4px; color: ${y.accent}; font-size: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center;">\n                                    <i class="fa-solid fa-dice"></i>\n                                </button>\n                            </div>\n                            <input type="text" id="dice-attr-name" value="${o(l||'')}" placeholder="è‡ªç”±æ£€å®š" style="${C}">\n                        </div>\n                    </div>\n\n                    \x3c!-- ç¬¬2è¡Œï¼šå±æ€§å€¼ + ç›®æ ‡å€¼ --\x3e\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">\n                        <div>\n                            <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">å±æ€§å€¼</div>\n                            <input type="text" id="dice-attr-value" value="${null!==v?v:''}" placeholder="ç•™ç©º=50%æœ€å¤§å€¼" style="${C}">\n                        </div>\n                        <div>\n                            <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;" id="dice-target-label">ç›®æ ‡å€¼</div>\n                            <input type="text" id="dice-target" value="${null!==x?x:''}" placeholder="ç•™ç©º=å±æ€§å€¼" style="${C}">\n                        </div>\n                    </div>\n\n                    \x3c!-- ç¬¬3è¡Œï¼šæˆåŠŸæ ‡å‡† + éš¾åº¦ç­‰çº§ + ä¿®æ­£å€¼ --\x3e\n                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 6px;" id="dice-row-3">\n                        <div>\n                            <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center; justify-content: center;">æˆåŠŸæ ‡å‡†</div>\n                            <select id="dice-success-criteria" class="acu-dice-select">\n                                ${[{id:'lte',name:'â‰¤ (COC)'},{id:'gte',name:'â‰¥ (DND)'}].map(e=>`<option value="${e.id}" ${e.id===A?'selected':''}>${e.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div id="dice-difficulty-wrapper">\n                            <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center; justify-content: center;">éš¾åº¦ç­‰çº§</div>\n                            <select id="dice-difficulty" class="acu-dice-select">\n                                <option value="normal" selected>æ™®é€š</option>\n                                <option value="hard">å›°éš¾</option>\n                                <option value="extreme">æéš¾</option>\n                                <option value="critical">å¤§æˆåŠŸ</option>\n                            </select>\n                        </div>\n                        <div>\n                            <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">ä¿®æ­£å€¼</div>\n                            <input type="text" id="dice-modifier" value="0" style="${C}">\n                        </div>\n                    </div>\n\n                    \x3c!-- å¿«æ·é€‰æ‹©å±æ€§ --\x3e\n                    <div style="margin-bottom: 10px;">\n                        <div style="font-size: 10px; color: ${y.textSub}; margin-bottom: 4px;"><i class="fa-solid fa-sliders"></i> å¿«æ·é€‰æ‹©å±æ€§</div>\n                        <div id="dice-attr-buttons" style="display: flex; flex-wrap: wrap; gap: 4px; max-height: 80px; overflow-y: auto;"></div>\n                    </div>\n                    \x3c!-- éšè—çš„éª°å­å…¬å¼ --\x3e\n                    <input type="hidden" id="dice-formula" value="${u}">\n\n                    <button id="dice-roll-btn" style="width: 100%; padding: 12px; background: ${y.buttonBg||y.accent}; border: none; border-radius: 8px; color: ${y.buttonText}; font-size: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative;">\n                        <i class="fa-solid fa-dice"></i> æ·éª°ï¼\n                    </button>\n                </div>\n            </div>\n        `);$('body').append(E).append(S);const I=e=>{const t=S.find('#dice-attr-buttons'),n=t.parent(),a=Lt(e);n.show();let i='';if(b&&h&&h.attrName){const t=h.attrName,n=zt(e,t)||s||'',a=y.buttonTextOnAccent||y.textMain||'#6B4A5A';i+=n?`<button class="acu-dice-attr-btn acu-dice-attr-btn-mvu" data-name="${o(t)}" data-value="${n}" style="padding:3px 8px;background:${y.accent};border:1px solid ${y.accent};border-radius:4px;color:${a};font-size:11px;cursor:pointer;font-weight:bold;" title="ä»å˜é‡è·¯å¾„æå–: ${o(t)}">${o(t)}:${n}</button>`:`<button class="acu-dice-attr-btn acu-dice-attr-btn-mvu" data-name="${o(t)}" data-value="" style="padding:3px 8px;background:${y.accent};border:1px solid ${y.accent};border-radius:4px;color:${a};font-size:11px;cursor:pointer;font-weight:bold;" title="ä»å˜é‡è·¯å¾„æå–: ${o(t)}">${o(t)}</button>`}a.forEach(e=>{i+=`<button class="acu-dice-attr-btn" data-name="${o(e.name)}" data-value="${e.value}" style="padding:3px 8px;background:${y.inputBg};border:1px solid ${y.border};border-radius:4px;color:${y.inputText};font-size:11px;cursor:pointer;">${o(e.name)}:${e.value}</button>`}),i+=`<button class="acu-dice-gen-attr-btn" style="padding:3px 8px;background:transparent;border:1px dashed ${y.accent};border-radius:4px;color:${y.accent};font-size:11px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;" title="ä¸ºå½“å‰è§’è‰²ç”Ÿæˆå±æ€§"><i class="fa-solid fa-dice"></i></button>`,i+=`<button class="acu-dice-clear-attr-btn" style="padding:3px 8px;background:transparent;border:1px dashed ${y.errorText};border-radius:4px;color:${y.errorText};font-size:11px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-left:4px;" title="æ¸…ç©ºå½“å‰è§„åˆ™çš„å±æ€§ï¼ˆä¿ç•™è‡ªå®šä¹‰å±æ€§ï¼‰"><i class="fa-solid fa-trash-alt"></i></button>`,t.html(i),t.find('.acu-dice-attr-btn').click(function(){const e=$(this).data('name'),t=$(this).data('value');S.find('#dice-attr-name').val(e),S.find('#dice-attr-value').val(t);const n='gte'===(S.find('#dice-success-criteria').val()||'lte'),a=parseInt(t,10)||0;n?S.find('#dice-target').val(20-a):S.find('#dice-target').val(t),S.find('#dice-attr-value').trigger('change')}),t.find('.acu-dice-gen-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;t.prop('disabled',!0).css('opacity','0.5');const n=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const a=it.handleUpdate;it.handleUpdate=()=>{console.log('[DICE]ACU å±æ€§ç”Ÿæˆä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{const e=S.find('#dice-initiator-name').val().trim()||'<user>';console.log('[DICE]ACU ç”Ÿæˆå±æ€§ for:',e);const t=jt(),n=t.base||t,a=t.special||{},i={...n,...a};(await Rt(e,i)).success&&I(e)}catch(e){console.error('[DICE]ACU ç”Ÿæˆå±æ€§å¤±è´¥:',e),window.toastr&&window.toastr.error('ç”Ÿæˆå±æ€§å¤±è´¥')}finally{it.handleUpdate=a,t.prop('disabled',!1).css('opacity','1').html(n)}}),t.find('.acu-dice-clear-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;const n=S.find('#dice-initiator-name').val().trim()||'<user>';if(!confirm(`ç¡®å®šè¦æ¸…ç©ºã€Œ${n}ã€çš„è§„åˆ™é¢„è®¾å±æ€§å—ï¼Ÿ\n\nï¼ˆç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ä¼šä¿ç•™ï¼‰`))return;t.prop('disabled',!0).css('opacity','0.5');const a=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const i=it.handleUpdate;it.handleUpdate=()=>{console.log('[DICE]ACU æ¸…ç©ºå±æ€§ä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{console.log('[DICE]ACU æ¸…ç©ºå±æ€§ for:',n);(await Ot(n)).success&&I(n)}catch(e){console.error('[DICE]ACU æ¸…ç©ºå±æ€§å¤±è´¥:',e),window.toastr&&window.toastr.error('æ¸…ç©ºå±æ€§å¤±è´¥')}finally{it.handleUpdate=i,t.prop('disabled',!1).css('opacity','1').html(a)}})};(()=>{const e=S.find('#dice-char-buttons');let t='';if(b&&h&&h.initiator){const e=h.initiator,n=e.length>4?e.substring(0,4)+'..':e,a=y.buttonTextOnAccent||y.textMain||'#6B4A5A';t+=`<button class="acu-dice-char-btn acu-dice-char-btn-mvu" data-char="${o(e)}" style="padding:3px 8px;background:${y.accent};border:1px solid ${y.accent};border-radius:4px;color:${a};font-size:11px;cursor:pointer;white-space:nowrap;font-weight:bold;" title="ä»å˜é‡è·¯å¾„æå–: ${o(e)}">${o(n)}</button>`}i.forEach(e=>{const n='<user>'===e?re():ce(e),a=n.length>4?n.substring(0,4)+'..':n;t+=`<button class="acu-dice-char-btn" data-char="${o(e)}" style="padding:3px 8px;background:${y.btnBg};border:1px solid ${y.border};border-radius:4px;color:${y.textMain};font-size:11px;cursor:pointer;white-space:nowrap;" title="${o(n)}">${o(a)}</button>`}),b&&h&&h.candidates&&h.candidates.length>0&&h.candidates.forEach(e=>{if(h.initiator&&e===h.initiator)return;const n=e.length>4?e.substring(0,4)+'..':e;t+=`<button class="acu-dice-char-btn acu-dice-char-btn-mvu-candidate" data-char="${o(e)}" style="padding:3px 8px;background:${y.inputBg};border:1px dashed ${y.accent};border-radius:4px;color:${y.accent};font-size:11px;cursor:pointer;white-space:nowrap;" title="ä»å˜é‡è·¯å¾„æå–: ${o(e)}">${o(n)}</button>`}),e.html(t||`<div style="font-size:11px;color:${y.textSub};">æ— è§’è‰²æ•°æ®</div>`),e.find('.acu-dice-char-btn').click(function(){const e=$(this).data('char');S.find('#dice-initiator-name').val(e).trigger('change')})})(),I('<user>'),S.find('#dice-random-skill').click(function(e){e.preventDefault(),e.stopPropagation();const t=Pt(),n=t[Math.floor(Math.random()*t.length)];S.find('#dice-attr-name').val(n).trigger('change')}),Ut(S.find('#dice-initiator-name'),i,y),Ut(S.find('#dice-attr-name'),c,y),Vt(S,'#dice-initiator-name, #dice-attr-name, #dice-attr-value, #dice-target',y),S.find('#dice-initiator-name').on('change.acuattr input.acuattr',function(){const e=$(this).val().trim()||'<user>',t=Mt(e);Ut(S.find('#dice-attr-name'),t.length>0?t:c,y),I(e)}),S.find('#dice-attr-name').on('change.acuval',function(){const e=S.find('#dice-initiator-name').val().trim()||'<user>',t=$(this).val().trim(),n=zt(e,t);if(null!==n){S.find('#dice-attr-value').val(n);const e='gte'===(S.find('#dice-success-criteria').val()||'lte');S.find('#dice-target').val(e?20-n:n)}});const T=(e,t,n)=>{if(!e||''===e)return'';const a=parseInt(e,10);if(isNaN(a))return e;const i=e=>{const t=e.match(/(\d+)d(\d+)/i);return t?parseInt(t[1],10)*parseInt(t[2],10):100},o=i(t),r=i(n),c=a/o,s=Math.round(c*r);return Math.max(1,Math.min(s,r))},F=()=>{const e='gte'===S.find('#dice-success-criteria').val(),t=S.find('#dice-target'),n=S.find('#dice-difficulty-wrapper'),a=S.find('#dice-row-3');e?(t.attr('placeholder','ç•™ç©º=20-å±æ€§å€¼'),S.find('#dice-target-label').text('DC'),n.hide(),a.css('grid-template-columns','1fr 1fr')):(t.attr('placeholder','ç•™ç©º=å±æ€§å€¼'),S.find('#dice-target-label').text('ç›®æ ‡å€¼'),n.show(),a.css('grid-template-columns','1fr 1fr 1fr'))};S.find('#dice-success-criteria').on('change',F),F();let M=u;S.find('.acu-dice-preset').click(function(){const e=$(this).data('dice');if('custom'===e)return;S.find('.acu-dice-preset').css({background:y.presetButtonBg||y.btnBg,color:y.textMain}),$(this).css({background:y.presetButtonBgActive||y.accent,color:y.buttonText}),fe({lastDiceType:e});const t=$(this).data('criteria')||'lte',n=S.find('#dice-target'),a=n.val().trim();if(''!==a){const t=T(a,M,e);n.val(t)}const i=(e=>{const t=e.match(/(\d+)d(\d+)/i);return t?parseInt(t[1],10)*parseInt(t[2],10):100})(e);S.find('#dice-target-auto').text(`(è‡ªåŠ¨: 1~${i})`),M=e,S.find('#dice-formula').val(e),S.find('#dice-success-criteria').val(t).trigger('change')}),S.find('.acu-dice-custom-btn').click(function(){S.find('.acu-dice-preset').css({background:y.presetButtonBg||y.btnBg,color:y.textMain}),$(this).css({background:y.presetButtonBgActive||y.accent,color:y.buttonText});const e=S.find('#dice-custom-input').val().trim();if(!e)return void S.find('#dice-custom-input').focus();if(!/^\d+d\d+$/i.test(e))return void(window.toastr&&window.toastr.warning('æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥å¦‚ 4d6'));const t=S.find('#dice-target'),n=t.val().trim();if(''!==n){const a=T(n,M,e);t.val(a)}S.find('#dice-formula').val(e),M=e,fe({lastDiceType:e}),S.find('#dice-success-criteria').val('gte').trigger('change')}),S.find('#dice-custom-input').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),S.find('.acu-dice-custom-btn').click())});const B=function(){const e=S.find('#dice-formula').val().trim()||'1d100',t=function(e){if(!e||''===e.trim())return 0;const t=e.trim(),n=parseFloat(t);if(!isNaN(n)&&isFinite(n)&&t.match(/^-?\d+(\.\d+)?$/))return n;let a=0,i=t;const o=/(\d+)d(\d+)(kh\d+|kl\d+|dh\d+|dl\d+)?/gi;let r;for(;null!==(r=o.exec(i));){const e=Ee(r[0]);isNaN(e)||(a+=e),i=i.replace(r[0],'')}const c=/([+-]?\d+(\.\d+)?)/g;let s;for(;null!==(s=c.exec(i));){const e=parseFloat(s[0]);!isNaN(e)&&isFinite(e)&&(a+=e)}return a}(S.find('#dice-modifier').val().trim()||'0'),n=S.find('#dice-attr-name').val().trim()||'è‡ªç”±æ£€å®š',a=S.find('#dice-success-criteria').val()||'lte',i=S.find('#dice-difficulty').val()||'normal',o='gte'===a,c=ge(),s=c.difficultSuccessDiv||2,l=c.hardSuccessDiv||5,d=o?c.dndCritFail||1:c.critSuccessMax||5,u=o?c.dndCritSuccess||20:c.critFailMin||96;let p,f=S.find('#dice-target').val().trim(),b=S.find('#dice-attr-value').val().trim(),m=''!==b?parseInt(b,10):0,h=!1;const v=e=>{const t=e.match(/(\d+)d(\d+)/i);if(t){const e=parseInt(t[1],10)*parseInt(t[2],10);return Math.round(e/2)}return 50};''!==f?p=parseInt(f,10)||v(e):o?m>0?(p=20-m,h=!0):(p=10,h=!0):m>0?(p=m,h=!0):(p=v(e),h=!0);const x=(e=>{const t=e.match(/(\d+)d(\d+)([+-]\d+)?/i);if(!t)return{total:0,rolls:[],formula:e};const n=parseInt(t[1],10),a=parseInt(t[2],10),i=t[3]?parseInt(t[3],10):0,o=[];for(let e=0;e<n;e++)o.push(Math.floor(Math.random()*a)+1);return{total:o.reduce((e,t)=>e+t,0)+i,rolls:o,sides:a,count:n,modifier:i,formula:e}})(e),w=x.total+t;let k=p,C='',E=1;if(!o)switch(i){case'hard':k=Math.floor(p/s),C='å›°éš¾',E=s;break;case'extreme':k=Math.floor(p/l),C='æéš¾',E=l;break;case'critical':k=d,C='å¤§æˆåŠŸ';break;default:C=''}let A=!1,I=!1,T=!1,F='',M='';if(o?(A=w>=u,I=w<=d):(A=w<=d,I=w>=u),T=o?w>=k:w<=k,A)F='å¤§æˆåŠŸï¼',M='success',T=!0;else if(I)F='å¤§å¤±è´¥ï¼',M='failure',T=!1;else if(T){if(o)F='æˆåŠŸ';else if('hard'===i)F='å›°éš¾æˆåŠŸ';else if('extreme'===i)F='æéš¾æˆåŠŸ';else{const e=Math.floor(p/l),t=Math.floor(p/s);F=w<=e?'æéš¾æˆåŠŸ':w<=t?'å›°éš¾æˆåŠŸ':'æˆåŠŸ'}M='success'}else F='å¤±è´¥',M='failure';const D=o?'â‰¥':'â‰¤',P=void 0!==c.hideDiceResultFromUser&&c.hideDiceResultFromUser,N=P?'ï¼Ÿï¼Ÿ':w,j=P?'':F;let O;O=A?'critSuccess':I?'critFailure':T?'extreme'===i||'normal'===i&&w<=Math.floor(p/l)?'extremeSuccess':'hard'===i||'normal'===i&&w<=Math.floor(p/s)?'success':'warning':'failure';const R=ze(O,y),L=Object.entries(R).map(([e,t])=>`${e}:${t}`).join(';'),U=S.find('#dice-roll-btn');U.html(`\n        <div style="display:flex; align-items:center; justify-content:center; width:100%; gap:8px;">\n          <span style="font-size:22px; font-weight:bold; color:${y.buttonText};">${N}</span>\n          <span style="font-size:11px; color:${y.buttonText}; opacity:0.9;">${D}${k}${C?'('+C+')':''}</span>\n          ${j?`<span style="${L}">${j}</span>`:''}\n          <button class="dice-retry-btn" style="background:transparent; border:none; color:${y.buttonText}; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center; opacity:0.8; transition:opacity 0.2s;" title="é‡æ–°æŠ•éª°">\n            <i class="fa-solid fa-rotate-right"></i>\n          </button>\n        </div>\n      `),U.off('click','.dice-retry-btn').on('click','.dice-retry-btn',function(e){e.stopPropagation(),e.preventDefault(),B()});const V=S.find('#dice-initiator-name').val().trim()||'<user>';let Y='';if(A)Y=o?`${w}â‰¥${u}`:`${w}â‰¤${d}`;else if(I)Y=o?`${w}â‰¤${d}`:`${w}â‰¥${u}`;else if(o)Y=T?`éœ€${D}${k}ï¼Œ${w}â‰¥${k}`:`éœ€${D}${k}ï¼Œ${w}<${k}`;else if('critical'===i)Y=`éœ€â‰¤${d}ï¼Œ${w}>${d}`;else if('normal'!==i)Y=T?`éœ€â‰¤${p}/${E}ï¼Œ${w}â‰¤${k}`:`éœ€â‰¤${p}/${E}ï¼Œ${w}>${k}`;else if(T){const e=Math.floor(p/l),t=Math.floor(p/s);Y=w<=e?`éœ€â‰¤${p}ï¼Œ${w}â‰¤${p}/${l}`:w<=t?`éœ€â‰¤${p}ï¼Œ${w}â‰¤${p}/${s}`:`éœ€â‰¤${p}ï¼Œ${w}â‰¤${p}`}else Y=`éœ€â‰¤${p}ï¼Œ${w}>${p}`;r(`ï¼ˆå…ƒå™äº‹ï¼š${V}å‘èµ·äº†ã€${n}ã€‘æ£€å®šï¼Œæ·å‡º${w}ï¼Œ${Y}ï¼Œã€${F}ã€‘ï¼‰`,'dice'),g&&g({success:T,total:w,target:p,outcomeText:F,attrName:n,criteria:a,isAutoTarget:h,formula:formulaText})};S.find('#dice-roll-btn').click(function(){B()}),S.find('#dice-switch-contest-top').click(function(){S.find('#dice-target').val().trim();const e=S.find('#dice-attr-value').val().trim(),t=S.find('#dice-formula').val()||'1d100',n=S.find('#dice-initiator-name').val().trim();D(),Ht({initiatorName:n&&'<user>'!==n?n:'',initiatorValue:''!==e?parseInt(e,10):void 0,diceType:t})});const D=()=>{E.remove(),S.remove()};E.click(D),S.find('.acu-dice-close').click(D),S.find('.acu-dice-config-btn').click(function(e){e.stopPropagation();const t=S.find('#dice-success-criteria').val();Yt('gte'===t)})},Ht=(e={})=>{const{$}=ut();$('.acu-dice-panel, .acu-dice-overlay, .acu-contest-panel, .acu-contest-overlay').remove();const t=an();let n=ge().lastDiceType||'1d100';/^\d+d\d+$/i.test(n)||(n='1d100');const a=e.opponentName||'',i=e.diceType||n,c=e.initiatorName||'',s=e.initiatorValue,l=e.opponentValue,d=Je||ln();let u=[],p=[],g=['<user>'];if(d)for(const e in d){const t=d[e];if(t&&'é‡è¦äººç‰©è¡¨'===t.name&&t.content){for(let e=1;e<t.content.length;e++){const n=t.content[e];n&&n[1]&&g.push(n[1])}break}}let f=[];if(d)for(const e in d){const t=d[e];if(t&&'ä¸»è§’ä¿¡æ¯'===t.name&&t.content&&t.content[1]){const e=t.content[0]||[],n=t.content[1];e.forEach((e,t)=>{if(e&&e.includes('å±æ€§')){Ne(n[t]||'').forEach(e=>{f.includes(e.name)||f.push(e.name)})}});break}}if(d)for(const e in d){const t=d[e];if(t&&t.name&&t.content){if('ä¸»è§’ä¿¡æ¯'===t.name&&t.content[1]){const e=t.content[1][7]||'';u=Ne(e)}if('é‡è¦äººç‰©è¡¨'===t.name&&a)for(let e=1;e<t.content.length;e++){const n=t.content[e];if(n&&n[1]===a){const e=n[9]||'';p=Ne(e);break}}}}const b=Me(),m='cyber'===an().theme?'#ff00ff':b.inputText,h=`width:100%;padding:5px;background:${b.inputBg} !important;border:1px solid ${b.border};border-radius:4px;color:${m} !important;font-size:12px;text-align:center;box-sizing:border-box;`,v=(e,t)=>{let n='';for(let a=0;a<e.length;a++){const i=e[a];n+='<button class="acu-contest-attr-btn" data-val="'+i.value+'" data-aname="'+o(i.name)+'" data-type="'+t+'" style="padding:3px 8px;background:'+b.inputBg+';border:1px solid '+b.border+';border-radius:4px;color:'+b.inputText+';font-size:11px;cursor:pointer;margin:2px;">'+o(i.name)+': '+i.value+'</button>'}return n+='<button class="acu-contest-gen-attr-btn" data-type="'+t+'" style="padding:2px 6px;background:transparent;border:1px dashed '+b.accent+';border-radius:3px;color:'+b.accent+';font-size:10px;cursor:pointer;display:inline-flex;align-items:center;gap:3px;margin:2px;" title="ç”Ÿæˆå±æ€§"><i class="fa-solid fa-dice"></i></button>',n+='<button class="acu-contest-clear-attr-btn" data-type="'+t+'" style="padding:2px 6px;background:transparent;border:1px dashed '+b.errorText+';border-radius:3px;color:'+b.errorText+';font-size:10px;cursor:pointer;display:inline-flex;align-items:center;gap:3px;margin:2px;" title="æ¸…ç©ºè§„åˆ™å±æ€§"><i class="fa-solid fa-trash-alt" style="font-size:9px;"></i></button>',n},x=$('<div class="acu-contest-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:'+b.overlayBg+';z-index:2147483647;"></div>'),y='<div class="acu-contest-panel acu-theme-'+t.theme+'" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:360px;max-width:92vw;background:'+b.bgPanel+';border:1px solid '+b.border+';border-radius:12px;box-shadow:0 20px 60px '+b.shadowBg+';z-index:2147483648;overflow:hidden;"><div style="padding:12px 15px;background:'+b.tableHead+';border-bottom:1px solid '+b.border+';display:flex;justify-content:space-between;align-items:center;"><div style="font-size:15px;font-weight:bold;color:'+b.accent+';display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-people-arrows"></i> å¯¹æŠ—æ£€å®š</div><div style="display:flex;align-items:center;gap:8px;"><button id="contest-switch-normal" style="background:none;border:none;color:'+b.textSub+';cursor:pointer;font-size:14px;padding:4px;transition:all 0.2s;" title="åˆ‡æ¢åˆ°æ™®é€šæ£€å®š"><i class="fa-solid fa-dice-d20"></i></button><button class="acu-contest-config-btn" style="background:none;border:none;color:'+b.textSub+';cursor:pointer;font-size:14px;padding:4px;transition:all 0.2s;" title="æ·éª°è§„åˆ™è®¾ç½®"><i class="fa-solid fa-cog"></i></button><button class="acu-contest-close" style="background:none;border:none;color:'+b.textSub+';cursor:pointer;font-size:16px;padding:4px;"><i class="fa-solid fa-times"></i></button></div></div><div style="padding:15px;max-height:70vh;overflow-y:auto;"><div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;align-items:center;"><button class="acu-contest-preset'+('1d20'===i?' active':'')+'" data-dice="1d20" style="padding:4px 10px;background:'+('1d20'===i?b.presetButtonBgActive||b.accent:b.presetButtonBg||b.btnBg)+';border:1px solid '+b.border+';border-radius:4px;color:'+('1d20'===i?'#fff':b.textMain)+';font-size:11px;cursor:pointer;">1d20</button><button class="acu-contest-preset'+('1d100'===i?' active':'')+'" data-dice="1d100" style="padding:4px 10px;background:'+('1d100'===i?b.presetButtonBgActive||b.accent:b.presetButtonBg||b.btnBg)+';border:1px solid '+b.border+';border-radius:4px;color:'+('1d100'===i?'#fff':b.textMain)+';font-size:11px;cursor:pointer;">1d100</button><button class="acu-contest-preset acu-contest-custom-btn" data-dice="custom" style="padding:4px 10px;background:'+(['1d20','1d100'].includes(i)?b.presetButtonBg||b.btnBg:b.presetButtonBgActive||b.accent)+';border:1px solid '+b.border+';border-radius:4px;color:'+(['1d20','1d100'].includes(i)?b.textMain:'#fff')+';font-size:11px;cursor:pointer;">è‡ªå®šä¹‰</button><input type="text" id="contest-custom-dice" placeholder="å¦‚2d6" value="'+(['1d20','1d100'].includes(i)?'':i)+'" style="width:60px;padding:4px 6px;background:'+b.inputBg+' !important;border:1px solid '+b.border+';border-radius:4px;color:'+m+' !important;font-size:11px;text-align:center;box-sizing:border-box;" /></div><input type="hidden" id="contest-dice-type" value="'+i+'"><div style="font-size:11px;color:'+b.accent+';font-weight:bold;margin-bottom:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><span><i class="fa-solid fa-user"></i> ç”²æ–¹</span><div id="contest-init-char-buttons" style="display:flex;flex-wrap:wrap;gap:3px;"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">åå­—</div><input type="text" id="contest-init-display" value="" placeholder="<user>" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;gap:6px;">å±æ€§å<button type="button" class="acu-random-skill-btn" id="contest-init-random-skill" title="éšæœºæŠ€èƒ½" style="width:18px;height:18px;padding:0;background:transparent;border:1px dashed '+b.accent+';border-radius:4px;color:'+b.accent+';font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-dice"></i></button></div><input type="text" id="contest-init-name" value="" placeholder="è‡ªç”±æ£€å®š" style="'+h+'"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">å±æ€§å€¼</div><input type="text" id="contest-init-value" value="'+(void 0!==s?s:'')+'" placeholder="ç•™ç©º=50%æœ€å¤§å€¼" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">ç›®æ ‡å€¼</div><input type="text" id="contest-init-target" value="" placeholder="è‡ªåŠ¨" style="'+h+'"></div></div><div id="init-attr-buttons" style="display:flex;flex-wrap:wrap;gap:2px;margin-bottom:8px;max-height:50px;overflow-y:auto;">'+v(u,'init')+'</div><div style="font-size:11px;color:'+b.accent+';font-weight:bold;margin-bottom:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><span><i class="fa-solid fa-user"></i> ä¹™æ–¹</span><div id="contest-opp-char-buttons" style="display:flex;flex-wrap:wrap;gap:3px;"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">åå­—</div><input type="text" id="contest-opponent-display" value="'+o(a)+'" placeholder="å¯¹æ‰‹" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;gap:6px;">å±æ€§å<button type="button" class="acu-random-skill-btn" id="contest-opp-random-skill" title="éšæœºæŠ€èƒ½" style="width:18px;height:18px;padding:0;background:transparent;border:1px dashed '+b.accent+';border-radius:4px;color:'+b.accent+';font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-dice"></i></button></div><input type="text" id="contest-opp-name" value="" placeholder="åŒç”²æ–¹" style="'+h+'"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">å±æ€§å€¼</div><input type="text" id="contest-opp-value" value="'+(void 0!==l?l:'')+'" placeholder="ç•™ç©º=50%æœ€å¤§å€¼" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">ç›®æ ‡å€¼</div><input type="text" id="contest-opp-target" value="" placeholder="è‡ªåŠ¨" style="'+h+'"></div></div><div id="opp-attr-buttons" style="display:flex;flex-wrap:wrap;gap:2px;margin-bottom:10px;max-height:50px;overflow-y:auto;">'+v(p,'opp')+'</div><div id="contest-result-display" style="display:none;margin-bottom:10px;padding:8px;background:'+b.inputBg+';border:1px solid '+b.border+';border-radius:6px;"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;width:100%;"><div id="contest-result-init" style="display:flex;align-items:center;gap:4px;min-width:0;flex:1;"></div><span style="color:'+b.textSub+';opacity:0.9;font-size:11px;font-weight:bold;white-space:nowrap;">VS</span><div id="contest-result-opp" style="display:flex;align-items:center;gap:4px;min-width:0;flex:1;justify-content:flex-end;"></div></div></div><button id="contest-roll-btn" style="width:100%;padding:12px;background:'+(b.buttonBg||b.accent)+';border:none;border-radius:8px;color:'+b.buttonText+';font-size:15px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;position:relative;"><i class="fa-solid fa-dice"></i> å¼€å§‹å¯¹æŠ—ï¼</button></div></div>',w=$(y);$('body').append(x).append(w);const k=e=>{const t='init'===e?'#contest-init-char-buttons':'#contest-opp-char-buttons',n=w.find(t);let a='';g.forEach(t=>{const n='<user>'===t?re():ce(t),i=n.length>4?n.substring(0,4)+'..':n;a+='<button class="acu-contest-char-btn" data-char="'+o(t)+'" data-type="'+e+'" style="padding:3px 8px;background:'+b.btnBg+';border:1px solid '+b.border+';border-radius:4px;color:'+b.textMain+';font-size:11px;cursor:pointer;white-space:nowrap;" title="'+o(n)+'">'+o(i)+'</button>'}),n.html(a),n.find('.acu-contest-char-btn').click(function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('char');'init'===$(this).data('type')?w.find('#contest-init-display').val(t).trigger('change'):w.find('#contest-opponent-display').val(t).trigger('change')})},C=(e,t)=>{const n='init'===t?'#init-attr-buttons':'#opp-attr-buttons',a=w.find(n);a.show();let i='';e.length>0&&e.forEach(e=>{i+='<button class="acu-contest-attr-btn" data-val="'+e.value+'" data-aname="'+o(e.name)+'" data-type="'+t+'" style="padding:2px 6px;background:'+b.inputBg+';border:1px solid '+b.border+';border-radius:3px;color:'+b.inputText+';font-size:10px;cursor:pointer;">'+o(e.name)+':'+e.value+'</button>'}),i+='<button class="acu-contest-gen-attr-btn" data-type="'+t+'" style="padding:2px 6px;background:transparent;border:1px dashed '+b.accent+';border-radius:3px;color:'+b.accent+';font-size:10px;cursor:pointer;display:inline-flex;align-items:center;gap:3px;" title="ç”Ÿæˆå±æ€§"><i class="fa-solid fa-dice"></i></button>',i+='<button class="acu-contest-clear-attr-btn" data-type="'+t+'" style="padding:2px 6px;background:transparent;border:1px dashed '+b.errorText+';border-radius:3px;color:'+b.errorText+';font-size:10px;cursor:pointer;display:inline-flex;align-items:center;gap:3px;margin-left:4px;" title="æ¸…ç©ºè§„åˆ™å±æ€§"><i class="fa-solid fa-trash-alt" style="font-size:9px;"></i></button>',a.html(i),a.find('.acu-contest-attr-btn').click(function(){const e=$(this).attr('data-val'),t=$(this).attr('data-aname');'init'===$(this).attr('data-type')?(w.find('#contest-init-value').val(e),w.find('#contest-init-name').val(t)):(w.find('#contest-opp-value').val(e),w.find('#contest-opp-name').val(t))}),a.find('.acu-contest-gen-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;const n=t.attr('data-type');t.prop('disabled',!0).css('opacity','0.5');const a=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const i=it.handleUpdate;it.handleUpdate=()=>{console.log('[DICE]ACU å¯¹æŠ—å±æ€§ç”Ÿæˆä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{let e;if(e='init'===n?w.find('#contest-init-display').val().trim()||'<user>':w.find('#contest-opponent-display').val().trim(),!e)return void(window.toastr&&window.toastr.warning('è¯·å…ˆé€‰æ‹©è§’è‰²'));console.log('[DICE]ACU å¯¹æŠ—é¢æ¿ç”Ÿæˆå±æ€§ for:',e,'type:',n);const t=jt(),a=t.base||t,i=t.special||{},o={...a,...i};if((await Rt(e,o)).success){const t=Lt(e);C(t,n)}}catch(e){console.error('[DICE]ACU å¯¹æŠ—é¢æ¿ç”Ÿæˆå±æ€§å¤±è´¥:',e),window.toastr&&window.toastr.error('ç”Ÿæˆå±æ€§å¤±è´¥')}finally{it.handleUpdate=i,t.prop('disabled',!1).css('opacity','1').html(a)}}),a.find('.acu-contest-clear-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;const n=t.attr('data-type');let a;if(a='init'===n?w.find('#contest-init-display').val().trim()||'<user>':w.find('#contest-opponent-display').val().trim(),!a)return void(window.toastr&&window.toastr.warning('è¯·å…ˆé€‰æ‹©è§’è‰²'));if(!confirm(`ç¡®å®šè¦æ¸…ç©ºã€Œ${a}ã€çš„è§„åˆ™é¢„è®¾å±æ€§å—ï¼Ÿ\n\nï¼ˆç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ä¼šä¿ç•™ï¼‰`))return;t.prop('disabled',!0).css('opacity','0.5');const i=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const o=it.handleUpdate;it.handleUpdate=()=>{console.log('[DICE]ACU æ¸…ç©ºå±æ€§ä¸­ï¼Œè·³è¿‡è‡ªåŠ¨åˆ·æ–°')};try{console.log('[DICE]ACU å¯¹æŠ—é¢æ¿æ¸…ç©ºå±æ€§ for:',a,'type:',n);if((await Ot(a)).success){const e=Lt(a);C(e,n)}}catch(e){console.error('[DICE]ACU å¯¹æŠ—é¢æ¿æ¸…ç©ºå±æ€§å¤±è´¥:',e),window.toastr&&window.toastr.error('æ¸…ç©ºå±æ€§å¤±è´¥')}finally{it.handleUpdate=o,t.prop('disabled',!1).css('opacity','1').html(i)}})};k('init'),k('opp'),w.find('#contest-init-random-skill').click(function(e){e.preventDefault(),e.stopPropagation();const t=Pt();var n=t[Math.floor(Math.random()*t.length)];w.find('#contest-init-name').val(n).trigger('change')}),w.find('#contest-opp-random-skill').click(function(e){e.preventDefault(),e.stopPropagation();const t=Pt();var n=t[Math.floor(Math.random()*t.length)];w.find('#contest-opp-name').val(n).trigger('change')});const E=Lt(c||'<user>');C(E,'init');const A=Lt(a||'');C(A,'opp'),Ut(w.find('#contest-init-display'),g,b),Ut(w.find('#contest-opponent-display'),g,b),Ut(w.find('#contest-init-name'),f,b),Ut(w.find('#contest-opp-name'),f,b),Vt(w,'#contest-init-display, #contest-init-name, #contest-init-value, #contest-init-target, #contest-opponent-display, #contest-opp-name, #contest-opp-value, #contest-opp-target',b),w.find('#contest-init-display').on('change.acuattr input.acuattr',function(){const e=$(this).val().trim()||'<user>',t=Mt(e);Ut(w.find('#contest-init-name'),t.length>0?t:f,b);const n=Lt(e);C(n,'init')}),w.find('#contest-opponent-display').on('change.acuattr input.acuattr',function(){const e=$(this).val().trim(),t=Mt(e);Ut(w.find('#contest-opp-name'),t.length>0?t:f,b);const n=Lt(e);C(n,'opp')}),w.find('#contest-init-name').on('change.acuval',function(){const e=w.find('#contest-init-display').val().trim()||'<user>',t=$(this).val().trim(),n=zt(e,t);null!==n&&w.find('#contest-init-value').val(n)}),w.find('#contest-opp-name').on('change.acuval',function(){const e=w.find('#contest-opponent-display').val().trim(),t=$(this).val().trim(),n=zt(e,t);null!==n&&w.find('#contest-opp-value').val(n)}),w.find('.acu-contest-preset').click(function(){const e=$(this).data('dice');'custom'!==e&&(w.find('.acu-contest-preset').css({background:b.presetButtonBg||b.btnBg,color:b.textMain}),$(this).css({background:b.presetButtonBgActive||b.accent,color:b.buttonText}),w.find('#contest-dice-type').val(e),fe({lastDiceType:e}))}),w.find('.acu-contest-custom-btn').click(function(){w.find('.acu-contest-preset').css({background:b.presetButtonBg||b.btnBg,color:b.textMain}),$(this).css({background:b.presetButtonBgActive||b.accent,color:b.buttonText});var e=w.find('#contest-custom-dice').val().trim();e?/^\d+d\d+$/i.test(e)?(w.find('#contest-dice-type').val(e),fe({lastDiceType:e})):window.toastr&&window.toastr.warning('æ ¼å¼é”™è¯¯ï¼Œè¯·è¾“å…¥å¦‚ 4d6'):w.find('#contest-custom-dice').focus()}),w.find('#contest-custom-dice').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),w.find('.acu-contest-custom-btn').click())});const S=function(e){const t=e.match(/(\d+)d(\d+)([+-]\d+)?/i);if(!t)return{total:0,rolls:[],sides:100};const n=parseInt(t[1],10),a=parseInt(t[2],10),i=t[3]?parseInt(t[3],10):0,o=[];for(let e=0;e<n;e++)o.push(Math.floor(Math.random()*a)+1);return{total:o.reduce(function(e,t){return e+t},0)+i,rolls:o,sides:a}},I=function(e,t,n){const a=Me();return 100===n?e<=5?{level:3,name:'å¤§æˆåŠŸ',color:a.critSuccessText}:e>=96?{level:-1,name:'å¤§å¤±è´¥',color:a.critFailureText}:e<=Math.floor(t/5)?{level:2,name:'æéš¾æˆåŠŸ',color:a.extremeSuccessText}:e<=Math.floor(t/2)?{level:1,name:'å›°éš¾æˆåŠŸ',color:a.successText}:e<=t?{level:0,name:'æ™®é€šæˆåŠŸ',color:a.warningText}:{level:-1,name:'å¤±è´¥',color:a.failureText}:20===e?{level:3,name:'å¤§æˆåŠŸ',color:a.critSuccessText}:1===e?{level:-1,name:'å¤§å¤±è´¥',color:a.critFailureText}:e>=t?{level:0,name:'æˆåŠŸ',color:a.successText}:{level:-1,name:'å¤±è´¥',color:a.failureText}},T=function(){var e,t=w.find('#contest-dice-type').val()||'1d100',n=w.find('#contest-init-display').val().trim()||'<user>',a=w.find('#contest-init-name').val().trim()||'è‡ªç”±æ£€å®š',i=function(e){var t=e.match(/(\d+)d(\d+)/i);return t?Math.round(parseInt(t[1],10)*parseInt(t[2],10)/2):50},c=w.find('#contest-init-value').val().trim();e=''===c?i(t):parseInt(c,10)||i(t);var s,l=w.find('#contest-init-target').val().trim();s=''!==l?parseInt(l,10):e;var d,u=w.find('#contest-opponent-display').val().trim()||'å¯¹æ‰‹',p=w.find('#contest-opp-name').val().trim()||a,g=w.find('#contest-opp-value').val().trim();d=''===g?i(t):parseInt(g,10)||i(t);var f,m=w.find('#contest-opp-target').val().trim();f=''!==m?parseInt(m,10):d;var h,v,x=S(t),y=S(t),k=I(x.total,s,x.sides),C=I(y.total,f,y.sides),E=ge(),A=E.contestTieRule||'initiator_lose',F=void 0!==E.hideDiceResultFromUser&&E.hideDiceResultFromUser,M=F?'ï¼Ÿï¼Ÿ':x.total,B=F?'ï¼Ÿï¼Ÿ':y.total,D=F?'':k.name,P=F?'':C.name;k.level>C.level?(h=n+' èƒœåˆ©',v=b.successText,k.name,C.name):k.level<C.level?(h=u+' èƒœåˆ©',v=b.failureText,C.name,k.name):('åŒæ–¹å‡ä¸º '+k.name,'initiator_win'===A?(h='å¹³æ‰‹ï¼Œ'+n+' åˆ¤èƒœ',v=b.successText):'tie'===A?(h='åŒæ–¹å¹³æ‰‹',v=b.warningText):(h='å¹³æ‰‹ï¼Œ'+n+' åˆ¤è´Ÿ',v=b.failureText));var N=F?'':h;const j=e=>3===e.level?'critSuccess':2===e.level?'extremeSuccess':1===e.level?'success':0===e.level?'warning':-1===e.level&&'å¤§å¤±è´¥'===e.name?'critFailure':'failure',O=j(k),R=j(C),L=ze(O,b),U=ze(R,b),V=ze(v===b.successText?'success':v===b.warningText?'warning':'failure',b),Y=Object.entries(L).map(([e,t])=>`${e}:${t}`).join(';'),q=Object.entries(U).map(([e,t])=>`${e}:${t}`).join(';'),H=Object.entries(V).map(([e,t])=>`${e}:${t}`).join(';'),W=w.find('#contest-result-display'),X=w.find('#contest-result-init'),J=w.find('#contest-result-opp');X.html('<span style="font-size:11px;color:'+b.textMain+';opacity:0.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px;">'+o(n)+'</span><span style="font-size:16px;font-weight:bold;color:'+b.textMain+';">'+M+'</span>'+(D?'<span style="'+Y+'">'+D+'</span>':'')),J.html((P?'<span style="'+q+'">'+P+'</span>':'')+'<span style="font-size:16px;font-weight:bold;color:'+b.textMain+';">'+B+'</span><span style="font-size:11px;color:'+b.textMain+';opacity:0.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px;">'+o(u)+'</span>'),W.show();const K=w.find('#contest-roll-btn');K.html('<div style="display:flex; align-items:center; justify-content:center; width:100%; gap:8px;">'+(N?'<span style="'+H+'">'+N+'</span>':'')+'<button class="contest-retry-btn" style="background:transparent; border:none; color:'+b.buttonText+'; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center; opacity:0.8; transition:opacity 0.2s;" title="é‡æ–°æŠ•éª°"><i class="fa-solid fa-rotate-right"></i></button></div>'),K.off('click','.contest-retry-btn').on('click','.contest-retry-btn',function(e){e.stopPropagation(),e.preventDefault(),T()});const G=`ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€${n} ${a} vs ${u} ${p}ã€‘çš„å¯¹æŠ—æ£€å®šã€‚${n} ${a} (ç›®æ ‡${s}) æ·å‡º ${x.total}ï¼Œåˆ¤å®šä¸ºã€${k.name}ã€‘ï¼›${u} ${p} (ç›®æ ‡${f}) æ·å‡º ${y.total}ï¼Œåˆ¤å®šä¸ºã€${C.name}ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€${h}ã€‘ï¼‰`;r(G,'dice')};w.find('#contest-roll-btn').click(function(){T()}),w.find('#contest-switch-normal').click(function(){var e=w.find('#contest-init-value').val().trim(),t=w.find('#contest-init-name').val()||'',n=w.find('#contest-dice-type').val()||'1d100',a=w.find('#contest-init-display').val().trim();F(),qt({targetValue:''!==e?parseInt(e,10):null,targetName:t,diceType:n,initiatorName:a})}),w.find('.acu-contest-config-btn').click(function(e){e.stopPropagation();const t=w.find('#contest-dice-type').val()||'1d100';Yt('1d20'===t)});var F=function(){x.remove(),w.remove()};x.click(F),w.find('.acu-contest-close').click(F)},Wt=(e,t)=>{const n=String(e||'').trim().toLowerCase(),a=String(t||'').toLowerCase();return!!n&&(a.includes('ç¦»åœº')?'å¦'===n||'false'===n||'no'===n:n.startsWith('åœ¨åœº')||'true'===n||'æ˜¯'===n||'yes'===n)},Xt=async()=>{const e=Je||ln(),t=pn(e||{});if(!e||0===Object.keys(t).length)return null;const n=Ie.findTable(t,'global'),a=Ie.findTable(t,'location'),i=Ie.findTable(t,'npc'),o=Ie.findTable(t,'player'),r=(()=>{const e=['åœ°å›¾å…ƒç´ ','å…ƒç´ è¡¨','åœ°å›¾è¦ç´ ','æœºå…³','çº¿ç´¢'];for(const n in t)if(e.some(e=>n.includes(e)))return{data:t[n],name:n,key:t[n].key};return null})(),c=n?.data?.headers||[],s=(n?.data?.rows||[])[0]||[],l=Se.global,d=Ie.findColumnIndex(c,'detailLocation',l),u=Ie.findColumnIndex(c,'currentLocation',l),p=d>=0?String(s[d]||'').trim():'',g=u>=0?String(s[u]||'').trim():'';if(!a?.data)return null;const f=(e,t,n=null)=>{for(let n=0;n<e.length;n++){const a=String(e[n]||'').toLowerCase();if(t.some(e=>a.includes(e.toLowerCase())))return n}return n??-1},b=new Map,m=a.data.headers||[],h=a.data.rows||[],v=f(m,['è¯¦ç»†åœ°ç‚¹','å…·ä½“ä½ç½®','åœ°ç‚¹å','åœ°ç‚¹','åç§°'],1),x=f(m,['æ¬¡è¦åœ°åŒº','æ¬¡è¦åŒºåŸŸ','åŒºåŸŸ','åœ°åŒº'],null),y=f(m,['åœ°ç‚¹ç±»å‹','åœ°ç‚¹ç±»åˆ«','ç±»å‹'],null),w=f(m,['ç¯å¢ƒæè¿°','æè¿°','è¯´æ˜','ä»‹ç»','æ°›å›´æè¿°'],null),k=f(m,['é‡è¦åº¦','é‡è¦æ€§'],null),C=f(m,['æ¢ç´¢çŠ¶æ€','æ¢ç´¢è¿›åº¦','çŠ¶æ€'],null);h.forEach((e,t)=>{const n=String(e[v]||'').trim();if(!n)return;const i={name:n,region:x>=0?String(e[x]||'').trim():'',locationType:y>=0&&e[y]||'',description:w>=0&&e[w]||'',importance:k>=0&&e[k]||'',exploreStatus:C>=0&&e[C]||'',emoji:le(n),tableKey:a.key||'',rowIndex:t};b.set(n,i)});const E=new Map;if(r?.data){const e=r.data.headers||[],t=r.data.rows||[],n=f(e,['å…ƒç´ åç§°','åç§°','å…ƒç´ å'],1),a=f(e,['å…ƒç´ ç±»å‹','ç±»å‹','å…ƒç´ åˆ†ç±»'],2),i=f(e,['æ‰€åœ¨åœ°ç‚¹','ä½ç½®','åœ°ç‚¹'],3),o=f(e,['å…ƒç´ æè¿°','æè¿°','è¯´æ˜'],null),c=f(e,['çŠ¶æ€','äº¤äº’çŠ¶æ€'],null),s=f(e,['äº¤äº’é€‰é¡¹','äº¤äº’','äº’åŠ¨','å¯äº¤äº’'],null);t.forEach((e,t)=>{const l=String(e[n]||'').trim();if(!l)return;const d=String(e[i]||'').trim();if(!d)return;if(g&&b.size>0&&!b.has(d))return;const u=s>=0?e[s]:'',p=String(u||'').split(/[,ï¼Œã€;ï¼›]/).map(e=>e.trim()).filter(Boolean),f=a>=0&&e[a]||'';((e,t)=>{E.has(e)||E.set(e,[]),E.get(e).push(t)})(d,{name:l,type:f,location:d,description:o>=0&&e[o]||'',status:c>=0&&e[c]||'',interactions:p,emoji:de(l,f),tableKey:r.key||'',rowIndex:t})})}const A=new Map,S=async e=>{const t=await se.getAsync(e.name),n={...e,avatarUrl:t,avatarOffsetX:se.getOffsetX(e.name),avatarOffsetY:se.getOffsetY(e.name),avatarScale:se.getScale(e.name)};A.has(n.location)||A.set(n.location,[]),A.get(n.location).push(n)};let I='';if(o?.data){const e=Se.player,t=o.data.headers||[],n=(o.data.rows||[])[0]||[],a=Ie.findColumnIndex(t,'name',e),i=Ie.findColumnIndex(t,'position',e),r=a>=0?n[a]:ie(),c=i>=0?n[i]:'',s=String(r||'').trim();I=String(c||'').trim(),!I&&p&&(I=p),s&&I&&await S({name:s,location:I,isPlayer:!0,isInScene:!0,tableKey:o.key||'',rowIndex:0})}if(i?.data){const e=Se.npc,t=i.data.headers||[],n=i.data.rows||[],a=Ie.findColumnIndex(t,'name',e),o=Ie.findColumnIndex(t,'position',e),r=Ie.findColumnIndex(t,'inScene',e);for(let e=0;e<n.length;e++){const c=n[e],s=String(c[a]||'').trim();if(!s)continue;const l=String(c[o]||'').trim();if(!l)continue;if(g&&b.size>0&&!b.has(l))continue;const d=r>=0?c[r]:'',u=t[r]||'',p=Wt(d,u);await S({name:s,location:l,isPlayer:!1,isInScene:p,tableKey:i.key||'',rowIndex:e})}}const T=b.values().next().value,F=[...new Set(Array.from(b.values()).map(e=>e.region||'å…¶ä»–'))].sort(),M=F.indexOf('å…¶ä»–');M>-1&&(F.splice(M,1),F.push('å…¶ä»–'));const B=(()=>{if(p&&b.has(p))return p;if(I&&b.has(I))return I;const e=F[0];if(e){const t=(e=>{const t=e||'å…¶ä»–';return Array.from(b.values()).filter(e=>(e.region||'å…¶ä»–')===t).sort((e,t)=>{const n=(A.get(e.name)?.length||0)+(E.get(e.name)?.length||0);return(A.get(t.name)?.length||0)+(E.get(t.name)?.length||0)-n})})(e);if(t.length>0)return t[0].name}return T?T.name:''})();return{currentRegion:g||b.get(I)?.region||'å…¶ä»–',detailLocation:p,focusLocation:B,playerLocation:I,locations:b,elements:E,characters:A,allRegions:F}};let Jt=!1;const Kt=async()=>{const{$}=ut();if(Jt)return;Jt=!0,$('.acu-map-overlay').remove();let e=await Xt();if(!e)return Jt=!1,void(window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°åœ°å›¾æ•°æ®'));const t=an(),n=new Map,a=e.detailLocation||'',i=e.playerLocation||'';let r='',c=e.currentRegion;if(a&&e.locations.has(a)){r=a;const t=e.locations.get(a);c=t?.region||e.currentRegion||'å…¶ä»–'}else if(i&&e.locations.has(i)){r=i;const t=e.locations.get(i);c=t?.region||e.currentRegion||'å…¶ä»–'}else if(e.focusLocation&&e.locations.has(e.focusLocation)){r=e.focusLocation;const t=e.locations.get(r);c=t?.region||e.currentRegion||'å…¶ä»–'}r&&(bt.set(B,r),n.set(c,r));const s=$(`\n            <div class="acu-map-overlay acu-theme-${t.theme}">\n                <div class="acu-map-container">\n                    <div class="acu-panel-header">\n                        <div class="acu-map-title">\n                            <i class="fa-solid fa-map-location-dot"></i>\n                            <span class="acu-map-region-name">${o(e.currentRegion||'åœ°å›¾')}</span>\n                        </div>\n                        <div class="acu-map-region-tabs"></div>\n                        <div class="acu-map-actions">\n                            <button class="acu-map-back-btn" title="å›åˆ°å½“å‰åœ°ç‚¹"><i class="fa-solid fa-location-crosshairs"></i></button>\n                            <button class="acu-close-btn acu-map-close"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-map-body">\n                        <div class="acu-map-focus-area"></div>\n                        <div class="acu-map-thumbnails"></div>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(s);const l=s[0];l.style.setProperty('position','fixed','important'),l.style.setProperty('top','0','important'),l.style.setProperty('left','0','important'),l.style.setProperty('right','0','important'),l.style.setProperty('bottom','0','important'),l.style.setProperty('width','100vw','important'),l.style.setProperty('height','100vh','important'),l.style.setProperty('display','flex','important'),l.style.setProperty('justify-content','center','important'),l.style.setProperty('align-items','center','important'),l.style.setProperty('z-index','2147483650','important');const d=s.find('.acu-map-focus-area'),u=s.find('.acu-map-thumbnails'),p=e=>{const t=e.name||e.type||'å…ƒç´ ',n=e.emoji?`<span class="acu-map-chip-emoji">${e.emoji}</span>`:'';return`\n                 <div class="acu-map-element-chip acu-dash-preview-trigger" data-table-key="${o(e.tableKey||'')}" data-row-index="${e.rowIndex}">\n                     ${n}\n                     <span class="acu-map-chip-name" title="${o(t)}">${o(t)}</span>\n                 </div>\n             `},g=()=>{d.html(((e,t)=>{const n=e.locations.get(t);if(!n)return'<div class="acu-map-loading" style="grid-column: 1 / -1;"><div class="acu-map-spinner"></div></div>';const a=e.characters.get(t)||[],i=e.elements.get(t)||[],r=a.slice(0,Math.ceil(a.length/2)),c=a.slice(Math.ceil(a.length/2)),s=i.slice(0,Math.ceil(i.length/2)),l=i.slice(Math.ceil(i.length/2)),d=e=>{const t=ce(e.name),n=e.avatarUrl?`background-image:url('${e.avatarUrl}');background-size:${e.avatarScale}%;background-position:${e.avatarOffsetX}% ${e.avatarOffsetY}%;`:'';return`\n            <div class="acu-map-avatar acu-dash-preview-trigger" data-table-key="${o(e.tableKey||'')}" data-row-index="${e.rowIndex}">\n                <div class="acu-map-avatar-circle" style="${n}">\n                    ${e.avatarUrl?'':`<span>${o(t.charAt(0))}</span>`}\n                </div>\n                <div class="acu-map-avatar-name" title="${o(t)}">${o(t.length>4?t.substring(0,4)+'..':t)}</div>\n            </div>\n        `},u=r.length?r.map(d).join(''):'',g=c.length?c.map(d).join(''):'',f=s.length?s.map(e=>p(e)).join(''):'',b=l.length?l.map(e=>p(e)).join(''):'',m=n.emoji?`<div class="acu-map-location-emoji">${n.emoji}</div>`:`<div class="acu-map-location-text">${o(n.name.charAt(0)||'â–¡')}</div>`;return`\n        <div class="acu-map-wing left">\n            <div class="acu-map-avatar-group acu-group-left">${u||''}</div>\n            <div class="acu-map-element-group acu-group-left">${f||''}</div>\n        </div>\n        <div class="acu-map-stage-center acu-dash-preview-trigger" data-table-key="${o(n.tableKey)}" data-row-index="${n.rowIndex}">\n            ${m}\n            <div class="acu-map-location-name" title="${o(n.name)}">${o(n.name)}</div>\n        </div>\n        <div class="acu-map-wing right">\n            <div class="acu-map-avatar-group acu-group-right">${g||''}</div>\n            <div class="acu-map-element-group acu-group-right">${b||''}</div>\n        </div>\n        <div class="acu-map-mobile-stack">\n            <div class="acu-map-mobile-avatars">${u||''}${g||''}</div>\n            <div class="acu-map-mobile-elements">${f||''}${b||''}</div>\n        </div>\n    `})(e,r));const t=Array.from(e.locations.values()).filter(e=>e.region===c).sort((t,n)=>{const a=(e.characters.get(t.name)?.length||0)+(e.elements.get(t.name)?.length||0);return(e.characters.get(n.name)?.length||0)+(e.elements.get(n.name)?.length||0)-a}).map(t=>((e,t,n)=>{const a=(e.characters.get(t.name)||[]).length+(e.elements.get(t.name)||[]).length,i=t.emoji?`<div class="acu-map-thumbnail-emoji">${t.emoji}</div>`:`<div class="acu-map-thumbnail-placeholder">${o(t.name.charAt(0)||'â–¡')}</div>`,r=a>0?`<div class="acu-map-thumbnail-badge">${a}</div>`:'';return`\n        <div class="acu-map-thumbnail ${n?'active':''}" data-location="${o(t.name)}">\n            ${r}\n            ${i}\n            <div class="acu-map-thumbnail-name" title="${o(t.name)}">${o(t.name.length>6?t.name.substring(0,6)+'..':t.name)}</div>\n        </div>\n    `})(e,t,t.name===r)).join('');var n,a;u.html(t||'<div class="acu-map-empty">è¯¥åœ°åŒºæš‚æ— å…¶ä»–åœ°ç‚¹</div>'),s.find('.acu-map-region-name').text(c||'åœ°å›¾'),s.find('.acu-map-region-tabs').html((n=e.allRegions,a=c,n.length<=1?'':n.map(e=>`<button class="acu-map-region-tab ${e===a?'active':''}" data-region="${o(e)}">${o(e)}</button>`).join('')))};g(),s.on('click','.acu-map-close',()=>{s.remove()}),s.on('click','.acu-map-region-tab',function(){const t=$(this).data('region');if(t===c)return;c=t;const a=Array.from(e.locations.values()).filter(e=>e.region===c);if(!a.find(e=>e.name===r)&&a.length>0){const t=n.get(c);if(t&&a.find(e=>e.name===t))r=t;else{const t=(t=>{const n=t||'å…¶ä»–';return Array.from(e.locations.values()).filter(e=>(e.region||'å…¶ä»–')===n).sort((t,n)=>{const a=(e.characters.get(t.name)?.length||0)+(e.elements.get(t.name)?.length||0);return(e.characters.get(n.name)?.length||0)+(e.elements.get(n.name)?.length||0)-a})})(c);r=t.length>0?t[0].name:a[0].name}bt.set(B,r)}g()}),s.on('click',function(e){$(e.target).hasClass('acu-map-overlay')&&s.remove()}),s.on('click','.acu-map-thumbnail',function(){const e=$(this).data('location');var t;e&&((t=e)&&(r=t,bt.set(B,r),n.set(c,r),g()))}),s.on('click','.acu-map-back-btn',()=>{const t=e.focusLocation,n=e.detailLocation||'',a=e.playerLocation||'';let i='';if(n&&e.locations.has(n)?i=n:a&&e.locations.has(a)?i=a:t&&e.locations.has(t)&&(i=t),!i)return;const o=e.locations.get(i),s=o?.region||e.currentRegion||'å…¶ä»–';s!==c&&(c=s),r=i,bt.set(B,r),g()}),Jt=!1},Gt=e=>{console.info('[DICE]å¼€å§‹æŠ“å–äººç‰©å…³ç³»è¡¨æ•°æ®...');const{$}=ut();$('.acu-relation-graph-overlay').remove();const t=an(),n=Me(),a=e.headers||[],i=e.rows||[],r=a.findIndex(e=>e&&(e.includes('å§“å')||e.includes('åç§°')))||1,c=a.findIndex(e=>e&&e.includes('äººé™…å…³ç³»')),s=e.key||'';if(console.info(`[DICE]äººç‰©å…³ç³»è¡¨æŸ¥æ‰¾: è¡¨æ ¼"${s||'æœªçŸ¥'}"ï¼Œå…±${i.length}è¡Œæ•°æ®`),c<0)return console.warn('[DICE]äººç‰©å…³ç³»è¡¨æŸ¥æ‰¾: æœªæ‰¾åˆ°"äººé™…å…³ç³»"åˆ—'),void(window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°"äººé™…å…³ç³»"åˆ—'));const l=new Map,d=[],u=e=>(e=>{if(!e)return e;const t=ie(),n=oe(),a=['<user>','{{user}}'].some(t=>e===t||e.toLowerCase()===t.toLowerCase()),i=n&&e===n,o=!!t&&(e===t||se.getPrimaryName(e)===t);return a||i||o?'{{user}}':se.getPrimaryName(e)})(e),p=Je||ln();let g='ä¸»è§’';if(p)for(const e in p){const t=p[e];if(t?.name?.includes('ä¸»è§’')&&t.content?.[1]){g=t.content[1][1]||'ä¸»è§’';break}}const f=u(g),b=(()=>{for(const e in p)if(p[e]?.name?.includes('ä¸»è§’'))return e;return''})();l.set(f,{name:f,isPlayer:!0,x:0,y:0,tableKey:b,rowIndex:0});const m=a.findIndex(e=>e&&e.includes('åœ¨åœº'));i.forEach((e,t)=>{const n=e[r];if(!n)return;const o=u(n);let p=!1;if(m>0){const t=String(e[m]||'').trim().toLowerCase();p=String(a[m]||'').toLowerCase().includes('ç¦»åœº')?'å¦'===t||'false'===t||'no'===t:t.startsWith('åœ¨åœº')||'true'===t||'æ˜¯'===t||'yes'===t}l.has(o)||l.set(o,{name:o,isPlayer:!1,x:0,y:0,tableKey:s,rowIndex:t,isInScene:p});const g=e[c]||'';je(g).forEach(e=>{if(!e.name)return;const t=u(e.name);if(t===o)return;if(!l.has(t)){let e=-1,n=!1;for(let o=0;o<i.length;o++)if(u(i[o][r])===t){if(e=o,m>0){const e=String(i[o][m]||'').trim().toLowerCase();n=String(a[m]||'').toLowerCase().includes('ç¦»åœº')?'å¦'===e||'false'===e||'no'===e:e.startsWith('åœ¨åœº')||'true'===e||'æ˜¯'===e||'yes'===e}break}l.set(t,{name:t,isPlayer:t===f,x:0,y:0,tableKey:e>=0?s:'',rowIndex:e>=0?e:void 0,isInScene:n})}const n=(e=>{if(!e)return[];const t=String(e).split(/[,ï¼Œã€;ï¼›\/\|]+|\s*[å’Œä¸&]\s*|\s{2,}|\n/).map(e=>e.trim()).filter(e=>e&&e.length<30),n=['æ‹äºº','æƒ…ä¾£','å¤«å¦»','ä¼´ä¾£','çˆ±äºº','ç”·å‹','å¥³å‹','å‰ç”·å‹','å‰å¥³å‹','æœ‹å‹','å¥½å‹','æŒšå‹','å¯†å‹','é—ºèœœ','æ­»å…š','çŸ¥å·±','æŸå‹','åŒå­¦','æ ¡å‹','åŒçª—','å­¦é•¿','å­¦å§','å­¦å¼Ÿ','å­¦å¦¹','å‰è¾ˆ','åè¾ˆ','åŒäº‹','ä¸Šå¸','ä¸‹å±','è€æ¿','å‘˜å·¥','æ­æ¡£','é˜Ÿå‹','æˆ˜å‹','ä¼™ä¼´','å¸ˆçˆ¶','å¸ˆå‚…','å¾’å¼Ÿ','å¼Ÿå­','è€å¸ˆ','å­¦ç”Ÿ','å¯¼å¸ˆ','é—¨ç”Ÿ','çˆ¶äº²','æ¯äº²','å„¿å­','å¥³å„¿','å…„å¼Ÿ','å§å¦¹','å“¥å“¥','å§å§','å¼Ÿå¼Ÿ','å¦¹å¦¹','çˆ·çˆ·','å¥¶å¥¶','å¤–å…¬','å¤–å©†','å”å”','é˜¿å§¨','èˆ…èˆ…','å§‘å§‘','è¡¨å“¥','è¡¨å§','è¡¨å¼Ÿ','è¡¨å¦¹','å ‚å…„','å ‚å¼Ÿ','å ‚å§','å ‚å¦¹','å®¶äºº','äº²äºº','äº²æˆš','è¡€äº²','ä¹‰çˆ¶','ä¹‰æ¯','ä¹‰å…„','ä¹‰å¦¹','æ•Œäºº','ä»‡äºº','å¯¹æ‰‹','åŠ²æ•Œ','å®¿æ•Œ','æƒ…æ•Œ','æ­»æ•Œ','å†¤å®¶','é‚»å±…','å®¤å‹','æˆ¿ä¸œ','ç§Ÿå®¢','å®¢æˆ·','å•†äºº','é›‡ä¸»','é›‡å‘˜','ä¿¡å¾’','æ•™å¾’','è¿½éšè€…','å´‡æ‹œè€…','ç²‰ä¸','é™Œç”Ÿäºº','ç†Ÿäºº','è·¯äºº','è¿‡å®¢'];return t.map(e=>{const t=(e=e.replace(/[ï¼ˆ(][^ï¼‰)]*[ï¼‰)]/g,'').trim()).match(/^(.+)çš„(ç›®æ ‡|å¯¹è±¡)$/);if((e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=t?t[1]:e.replace(/^[\u4e00-\u9fa5]{2,4}çš„(?=[\u4e00-\u9fa5]{1,4}$)/,'')).replace(/^(?:å±äº|ä½œä¸º|èº«ä¸º|æ˜¯å…¶?|ä¸ºå…¶?|ä¹ƒ)/,'')).replace(/^(?:æ›¾ç»æ˜¯?|ä»¥å‰æ˜¯?|åŸæœ¬æ˜¯?|å‰)/,'å‰')).replace(/^(?:äº’ä¸º|å½¼æ­¤æ˜¯?|ç›¸äº’æ˜¯?)/,'')).replace(/å…³ç³»$/,'')).replace(/å¯¹è±¡$/,'')).replace(/ç›®æ ‡$/,'')).replace(/^å…³ç³»å¤æ‚$/,'å¤æ‚')).replace(/^å…³ç³»ä¸æ˜$/,'ä¸æ˜')).replace(/^å…³ç³»å¾®å¦™$/,'å¾®å¦™')).replace(/^å…³ç³»ç´§å¼ $/,'ç´§å¼ ')).replace(/^å…³ç³»äº²å¯†$/,'äº²å¯†')).replace(/^å…³ç³»ç–è¿œ$/,'ç–è¿œ')).replace(/^(?:ä¸è®¤è¯†|ä¸ç†Ÿæ‚‰|é™Œç”Ÿäºº?)$/,'é™Œç”Ÿ')).replace(/^(?:è®¤è¯†|ç†Ÿäºº)$/,'ç†Ÿäºº')).replace(/^(?:å¥½æœ‹å‹|æŒšå‹|å¯†å‹|è‡³äº¤)$/,'æŒšå‹')).replace(/^(?:ç”·æœ‹å‹|ç”·å‹)$/,'ç”·å‹')).replace(/^(?:å¥³æœ‹å‹|å¥³å‹)$/,'å¥³å‹')).replace(/^(?:å‰ç”·å‹|å‰ç”·æœ‹å‹)$/,'å‰ç”·å‹')).replace(/^(?:å‰å¥³å‹|å‰å¥³æœ‹å‹)$/,'å‰å¥³å‹')).replace(/^(?:æš—æ‹å¯¹è±¡|æš—æ‹)$/,'æš—æ‹')).replace(/^(?:å•ç›¸æ€|å•æ‹)$/,'å•æ‹')).replace(/^(?:é’æ¢…ç«¹é©¬|å„¿æ—¶ç©ä¼´|å‘å°)$/,'é’æ¢…ç«¹é©¬')).replace(/^(?:åŒç­åŒå­¦|åŒçº§åŒå­¦)$/,'åŒå­¦')).replace(/^(?:å·¥ä½œä¼™ä¼´|åˆä½œä¼™ä¼´|æ­æ¡£)$/,'æ­æ¡£')).trim()).length>8){for(const t of n)if(e.endsWith(t))return t;const t=e.slice(-4);for(const e of n)if(t.includes(e))return e;return e.slice(-3)}return e}).filter(e=>e&&e.length>0&&e.length<=8)})(e.relation);0===n.length&&n.push('');let c=d.find(e=>e.source===o&&e.target===t||e.source===t&&e.target===o);if(c)if(c.source===o){const e=[...c.labelsFromSource||[],...n];c.labelsFromSource=[...new Set(e)].slice(0,2)}else{const e=[...c.labelsFromTarget||[],...n];c.labelsFromTarget=[...new Set(e)].slice(0,2)}else d.push({source:o,target:t,labelsFromSource:n.slice(0,2),labelsFromTarget:[]})})});const h=Array.from(l.values());console.info(`[DICE]äººç‰©å…³ç³»è¡¨æ•°æ®æŠ“å–å®Œæˆï¼Œå…±${h.length}ä¸ªèŠ‚ç‚¹ï¼Œ${d.length}æ¡è¾¹`);const v=new Map;h.forEach(e=>v.set(e.name,0)),d.forEach(e=>{v.set(e.source,(v.get(e.source)||0)+1),v.set(e.target,(v.get(e.target)||0)+1)});const x=window.innerWidth<=768,y=x?22:28,w=x?38:50,k=x?28:35,C=x?2.5:3.5;let E=1,A=!1,S=!1;const I=(e,t)=>{const n=t?k:y,a=v.get(e)||0;return Math.min(w,n+Math.sqrt(a)*C)*E};h.forEach(e=>{e.radius=I(e.name,e.isPlayer)});const T=()=>`acu-relation-graph-layout-cache-${h.map(e=>e.name).sort().join('|')}`,F=()=>{try{const e=T(),t=localStorage.getItem(e);if(!t)return!1;const n=JSON.parse(t);let a=!0;for(const e of h)if(!n[e.name]){a=!1;break}return!!a&&(h.forEach(e=>{const t=n[e.name];t&&(e.x=t.x,e.y=t.y,e.vx=0,e.vy=0)}),!0)}catch(e){return console.warn('[DICE]å…³ç³»å›¾ åŠ è½½å¸ƒå±€ç¼“å­˜å¤±è´¥:',e),!1}},M=()=>{h.forEach(e=>{if(e.isPlayer)e.x=400,e.y=300,e.vx=0,e.vy=0;else{const t=2*Math.random()*Math.PI,n=50+100*Math.random();e.x=400+Math.cos(t)*n,e.y=300+Math.sin(t)*n,e.vx=0,e.vy=0}});const e=new Map;h.forEach(t=>e.set(t.name,t));for(let t=0;t<300;t++){for(let e=0;e<h.length;e++){const t=h[e];for(let n=e+1;n<h.length;n++){const e=h[n],a=e.x-t.x,i=e.y-t.y;let o=a*a+i*i;o<1&&(o=1);const r=Math.sqrt(o),c=2e4/o,s=a/r*c,l=i/r*c;t.isPlayer||(t.vx-=s,t.vy-=l),e.isPlayer||(e.vx+=s,e.vy+=l)}}d.forEach(t=>{const n=e.get(t.source),a=e.get(t.target);if(!n||!a)return;const i=a.x-n.x,o=a.y-n.y,r=Math.sqrt(i*i+o*o)||1,c=.02*(r-250),s=i/r*c,l=o/r*c;n.isPlayer||(n.vx+=s,n.vy+=l),a.isPlayer||(a.vx-=s,a.vy-=l)}),h.forEach(e=>{if(e.isPlayer)return;const t=400-e.x,n=300-e.y;e.vx+=.01*t,e.vy+=.01*n});const n=50*(1-t/300);h.forEach(e=>{if(e.isPlayer)return;e.vx*=.8,e.vy*=.8;const t=Math.sqrt(e.vx*e.vx+e.vy*e.vy);t>n&&(e.vx=e.vx/t*n,e.vy=e.vy/t*n),e.x+=.5*e.vx,e.y+=.5*e.vy})}(()=>{try{const e=T(),t={};h.forEach(e=>{t[e.name]={x:e.x,y:e.y}}),localStorage.setItem(e,JSON.stringify(t))}catch(e){console.warn('[DICE]å…³ç³»å›¾ ä¿å­˜å¸ƒå±€ç¼“å­˜å¤±è´¥:',e)}})()};F()||M();let B=1,D=0,P=0;const N=$(`\n            <div class="acu-relation-graph-overlay acu-theme-${t.theme}">\n                <div class="acu-relation-graph-container">\n                    <div class="acu-panel-header">\n                        <div class="acu-graph-title">\n                            <i class="fa-solid fa-project-diagram"></i>\n                            <button class="acu-graph-btn acu-filter-toggle" id="filter-in-scene" title="åªæ˜¾ç¤ºä¸»è§’å’Œåœ¨åœºè§’è‰²" style="margin-left:8px;padding:4px 6px;font-size:12px;"><i class="fa-solid fa-map-marker-alt"></i></button>\n                            <button class="acu-graph-btn acu-filter-toggle" id="filter-direct-only" title="åªæ˜¾ç¤ºä¸ä¸»è§’ç›´æ¥ç›¸å…³" style="padding:4px 6px;font-size:12px;"><i class="fa-solid fa-link"></i></button>\n                        </div>\n                        <div class="acu-graph-actions">\n                            <button class="acu-graph-btn" id="graph-relayout" title="é‡æ–°å¸ƒå±€ï¼ˆæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°è®¡ç®—èŠ‚ç‚¹ä½ç½®ï¼‰"><i class="fa-solid fa-sync"></i></button>\n                            <button class="acu-graph-btn" id="graph-manage-avatar" title="ç®¡ç†å¤´åƒ"><i class="fa-solid fa-user-circle"></i></button>\n                            <button class="acu-graph-btn acu-graph-close" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-graph-canvas-wrapper">\n                        <svg class="acu-graph-svg" viewBox="0 0 800 600">\n                            <defs>\n                                <marker id="arrowhead-end" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 6 2.5, 0 5" fill="${n.textSub}" />\n                                </marker>\n                                <marker id="arrowhead-start" markerWidth="6" markerHeight="5" refX="1" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="6 0, 0 2.5, 6 5" fill="${n.textSub}" />\n                                </marker>\n                                <marker id="arrowhead-end-hl" markerWidth="7" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 7 3, 0 6" fill="${n.accent}" />\n                                </marker>\n                                <marker id="arrowhead-start-hl" markerWidth="7" markerHeight="6" refX="1" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="7 0, 0 3, 7 6" fill="${n.accent}" />\n                                </marker>\n                            </defs>\n                            <g class="acu-graph-transform">\n                                <g class="acu-graph-edges"></g>\n                                <g class="acu-graph-nodes"></g>\n                            </g>\n                        </svg>\n                        <div class="acu-node-size-slider-container" style="\n                            position: absolute;\n                            display: none;\n                            width: 200px;\n                            padding: 10px;\n                            background: ${n.bgPanel};\n                            border: 1px solid ${n.border};\n                            border-radius: 8px;\n                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n                            z-index: 10;\n                        ">\n                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">\n                                <span style="font-size:11px;color:${n.textSub};white-space:nowrap;">èŠ‚ç‚¹å¤§å°</span>\n                                <span id="slider-size-display" style="font-size:11px;color:${n.accent};font-weight:bold;min-width:35px;text-align:right;">${Math.round(100*E)}%</span>\n                            </div>\n                            <input type="range" id="node-size-slider" min="0.5" max="2.0" step="0.1" value="${E}" style="\n                                width: 100%;\n                                height: 8px;\n                                border-radius: 4px;\n                                background: ${n.btnBg};\n                                outline: none;\n                                cursor: pointer;\n                                -webkit-appearance: none;\n                            " />\n                        </div>\n                    </div>\n                    <div class="acu-graph-legend">\n                        <button class="acu-graph-btn" id="graph-zoom-reset" title="é‡ç½®è§†å›¾å’ŒèŠ‚ç‚¹å¤§å°" style="width:auto;height:auto;padding:4px 10px;font-size:11px;display:flex;align-items:center;gap:4px;"><i class="fa-solid fa-compress-arrows-alt"></i><span>é‡ç½®</span></button>\n                        <div class="acu-node-size-stepper-wrapper" style="display:flex;align-items:center;justify-content:center;gap:6px;">\n                            <span style="font-size:11px;color:var(--acu-text-sub);white-space:nowrap;">èŠ‚ç‚¹:</span>\n                            <div class="acu-stepper" data-id="graph-node-size" data-min="50" data-max="200" data-step="10" style="display:flex;align-items:center;">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value" id="node-size-display" style="display:flex;align-items:center;justify-content:center;">${Math.round(100*E)}%</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <span class="acu-zoom-display" style="display:flex;align-items:center;gap:4px;color:var(--acu-text-sub);font-size:11px;">\n                            <span>è§†å›¾:</span>\n                            <span>${Math.round(100*B)}%</span>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(N);const j=N.find('.acu-graph-svg'),O=N.find('.acu-graph-transform'),R=N.find('.acu-graph-edges'),L=N.find('.acu-graph-nodes'),U=N.find('.acu-zoom-display span:last-child'),V=N.find('#node-size-display'),Y=N.find('.acu-graph-canvas-wrapper'),q=()=>{O.attr('transform',`translate(${D}, ${P}) scale(${B})`),U.text(`${Math.round(100*B)}%`)},H=()=>{V.length&&V.text(`${Math.round(100*E)}%`)},W=(e,t=400,n=300)=>{const a=B;B=Math.max(.3,Math.min(4,e));const i=B/a;D=t-(t-D)*i,P=n-(n-P)*i,q()},X=async()=>{const e=(()=>{if(!A&&!S)return h;let e=null;return S&&(e=new Set([f]),d.forEach(t=>{t.source===f&&e.add(t.target),t.target===f&&e.add(t.source)})),h.filter(t=>{const n=!A||t.isInScene||t.isPlayer,a=!S||e.has(t.name);return n&&a})})(),t=new Set(e.map(e=>e.name)),n=d.filter(e=>t.has(e.source)&&t.has(e.target));let a='';n.forEach((e,t)=>{const n=l.get(e.source),i=l.get(e.target);if(!n||!i)return;const r=i.x-n.x,c=i.y-n.y,s=Math.sqrt(r*r+c*c)||1,d=r/s,u=c/s,p=-u,g=d,f=e.labelsFromSource&&e.labelsFromSource.length>0&&e.labelsFromSource.some(e=>e),b=e.labelsFromTarget&&e.labelsFromTarget.length>0&&e.labelsFromTarget.some(e=>e),m=n.radius||28,h=i.radius||28,v=n.x+d*(m+10),x=n.y+u*(m+10),y=i.x-d*(h+10),w=i.y-u*(h+10);let k=(e.labelsFromSource||[]).filter(e=>e),C=(e.labelsFromTarget||[]).filter(e=>e);const E=new Set(k),A=new Set(C),S=[...E].filter(e=>A.has(e)),I=k.filter(e=>!S.includes(e)),T=C.filter(e=>!S.includes(e));let F='',M='';f&&(M='url(#arrowhead-end)'),b&&(F='url(#arrowhead-start)'),a+=`<line class="acu-graph-edge" x1="${v}" y1="${x}" x2="${y}" y2="${w}"\n                    ${M?`marker-end="${M}"`:''}\n                    ${F?`marker-start="${F}"`:''}\n                    data-edge-idx="${t}" />`;const B=(n.x+i.x)/2,D=(n.y+i.y)/2,P=Math.sqrt(r*r+c*c);if(f&&b&&S.length>0&&0===I.length&&0===T.length)S.slice(0,2).forEach((e,n)=>{if(!e)return;const i=0===n?1:-1,r=6+10*n;a+=`<text class="acu-graph-edge-label" x="${B+p*i*r}" y="${D+g*i*r}" data-edge-idx="${t}">${o(e)}</text>`});else{const e=Math.max(30,Math.min(.25*P,60)),n=[{emoji:'ğŸ’•',keywords:['æ‹äºº','æ‹çˆ±','çˆ±æƒ…','æ‹æƒ…','æƒ…ä¾£','ç”·å‹','å¥³å‹','æš—æ‹','å•æ‹','å¿ƒåŠ¨','å–œæ¬¢','çˆ±æ…•','å€¾å¿ƒ','é’Ÿæƒ…','æƒ…äºº','çˆ±äºº']},{emoji:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§',keywords:['å®¶äºº','äº²äºº','çˆ¶æ¯','çˆ¶äº²','æ¯äº²','å…„å¼Ÿ','å§å¦¹','å…„å¦¹','å§å¼Ÿ','å„¿å­','å¥³å„¿','çˆ·çˆ·','å¥¶å¥¶','å¤–å…¬','å¤–å©†','å”å”','é˜¿å§¨','è¡¨äº²','å ‚äº²','è¡€äº²']},{emoji:'ğŸ˜Š',keywords:['æœ‹å‹','å‹äºº','å¥½å‹','å‹æƒ…','ä¼™ä¼´','æ­æ¡£','é˜Ÿå‹','æˆ˜å‹','åŒä¼´','ç›Ÿå‹','æŒšå‹','å¯†å‹','è‡³äº¤','é—ºèœœ','æ­»å…š','çŸ¥å·±','è«é€†']},{emoji:'ğŸ“',keywords:['å¸ˆçˆ¶','å¸ˆå‚…','å¾’å¼Ÿ','å¸ˆå¾’','è€å¸ˆ','å­¦ç”Ÿ','å¯¼å¸ˆ','å¼Ÿå­','é—¨ç”Ÿ','åŒå­¦','åŒçª—','åŒçº§','åŒç­','å‰è¾ˆ','åè¾ˆ','å­¦é•¿','å­¦å§','å­¦å¼Ÿ','å­¦å¦¹']},{emoji:'ğŸ’°',keywords:['äº¤æ˜“','åˆä½œ','ç”Ÿæ„','å®¢æˆ·','å•†ä¸š','åˆ©ç›Š','é›‡ä½£','å¥‘çº¦','åˆåŒ']},{emoji:'âš”ï¸',keywords:['å¯¹æ‰‹','ç«äº‰','åŠ²æ•Œ','å®¿æ•Œ','æƒ…æ•Œ','æ­»å¯¹å¤´','å†¤å®¶']},{emoji:'ğŸ’¢',keywords:['æ•Œäºº','ä»‡äºº','ä»‡æ¨','æ•Œå¯¹','ä»‡æ•Œ','æ­»æ•Œ','æ†æ¨','æ€¨æ¨','ä»‡æ€¨']},{emoji:'ğŸ™',keywords:['ä¿¡ä»°','å´‡æ‹œ','æ•¬ä»°','ä»°æ…•','è¿½éš','ä¿¡å¾’','æ•™å¾’','ç‹‚ä¿¡']},{emoji:'ğŸŒ€',keywords:['å¤æ‚','å¾®å¦™','çº è‘›','ç¾ç»Š','çº ç¼ ']}],i=e=>{if(!e)return'';for(const t of n)for(const n of t.keywords)if(e.includes(n))return e+t.emoji;return e},r=(e,t=4)=>{if(!e)return'';const n=e.length>t?e.substring(0,t)+'..':e;return i(n)};if(S.length>0&&S.slice(0,1).forEach((e,n)=>{if(!e)return;a+=`<text class="acu-graph-edge-label" x="${B+8*p}" y="${D+8*g-3}" data-edge-idx="${t}">${o(r(e,5))}</text>`}),I.length>0||f&&!b&&0===S.length){const n=I.length>0?I:k,i=B-d*e,c=D-u*e;n.slice(0,2).forEach((e,n)=>{if(!e)return;const s=10*(0===n?1:-1);a+=`<text class="acu-graph-edge-label" x="${i+p*s}" y="${c+g*s}" data-edge-idx="${t}">${o(r(e,5))}</text>`})}if(T.length>0||b&&!f&&0===S.length){const n=T.length>0?T:C,i=B+d*e,c=D+u*e;n.slice(0,2).forEach((e,n)=>{if(!e)return;const s=10*(0===n?-1:1);a+=`<text class="acu-graph-edge-label" x="${i+p*s}" y="${c+g*s}" data-edge-idx="${t}">${o(r(e,5))}</text>`})}}}),R.html(a);let i='';for(const t of e){const e=await se.getAsync(t.name),n=(t.isPlayer,.28*t.radius),a=.65*t.radius,r=t.isInScene?`<circle class="acu-node-inscene-indicator" cx="${-a}" cy="${-a}" r="${n}" style="fill:var(--acu-accent);stroke:var(--acu-bg-panel);stroke-width:2;" />`:'',c=ce(t.name);i+=`\n                <g class="acu-graph-node acu-dash-preview-trigger" data-name="${o(t.name)}" data-table-key="${t.tableKey||''}" data-row-index="${void 0!==t.rowIndex?t.rowIndex:''}" transform="translate(${t.x}, ${t.y})">\n                    <circle class="acu-node-bg" r="${t.radius}" />\n                    ${e?(()=>{const n=se.getOffsetX(t.name),a=se.getOffsetY(t.name),i=se.getScale(t.name),o=2*(t.radius-2),r=o+8,c=r/2;return`<foreignObject x="${-c}" y="${-c}" width="${r}" height="${r}">\n                            <div class="acu-node-avatar" xmlns="http://www.w3.org/1999/xhtml" style="\n                                width: ${o}px;\n                                height: ${o}px;\n                                margin: 4px;\n                                border-radius: 50%;\n                                background-image: url('${e}');\n                                background-size: ${i}%;\n                                background-position: ${n}% ${a}%;\n                                background-repeat: no-repeat;\n                            "></div>\n                        </foreignObject>`})():`<text class="acu-node-char" dy="0.35em">${o(c.charAt(0))}</text>`}\n                    ${r}\n                    <text class="acu-node-label" dy="${t.radius+14}">${o(c)}</text>\n                </g>\n            `}L.html(i)},J=e=>{j.addClass('highlighting'),L.find('.acu-graph-node').each(function(){$(this).data('name')===e&&$(this).addClass('highlighted')});const t=new Set([e]);d.forEach(n=>{if(n.source===e||n.target===e){const a=n.source===e?n.target:n.source;t.add(a)}}),L.find('.acu-graph-node').each(function(){t.has($(this).data('name'))&&$(this).addClass('highlighted')});const n=new Set;d.forEach((t,a)=>{t.source!==e&&t.target!==e||n.add(a)}),R.find('.acu-graph-edge').each(function(){const e=parseInt($(this).attr('data-edge-idx'),10);n.has(e)&&($(this).addClass('highlighted'),$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end-hl)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start-hl)'))}),R.find('.acu-graph-edge-label').each(function(){const e=parseInt($(this).attr('data-edge-idx'),10);n.has(e)&&$(this).addClass('highlighted')})},K=()=>{j.removeClass('highlighting'),L.find('.highlighted').removeClass('highlighted'),R.find('.highlighted').removeClass('highlighted'),R.find('.acu-graph-edge').each(function(){$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start)')})};if(!window.matchMedia('(pointer: fine)').matches){let e=null;L.on('pointerdown','.acu-graph-node',function(t){const n=$(this),a=n.data('name'),i=t.clientX,o=t.clientY,r=Date.now();let c=!1,s=!1;if(e)return K(),e=null,t.preventDefault(),void t.stopPropagation();const l=setTimeout(()=>{!c&&a&&(s=!0,e=a,J(a),navigator.vibrate&&navigator.vibrate(30))},300);$(document).on('pointermove.mobilenode',e=>{const t=Math.abs(e.clientX-i),n=Math.abs(e.clientY-o);(t>8||n>8)&&(c=!0,clearTimeout(l))}),$(document).on('pointerup.mobilenode pointercancel.mobilenode',()=>{$(document).off('pointermove.mobilenode pointerup.mobilenode pointercancel.mobilenode'),clearTimeout(l);const e=Date.now()-r;if(!s&&!c&&e<300){const e=n.data('name'),t=se.getPrimaryName(e),a=n.data('table-key');let i=n.data('row-index');if(!a||''===i||void 0===i){const e=Je||ln();if(e)for(const n in e){const a=e[n];if(!a?.content||!a.name?.includes('NPC'))continue;const i=(a.content[0]||[]).findIndex(e=>e&&(e.includes('å§“å')||e.includes('åç§°')||e.includes('åå­—')));if(!(i<0))for(let e=1;e<a.content.length;e++){const o=String(a.content[e][i]||'').trim();if(o===t||se.getPrimaryName(o)===t){const t=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',n).data('row-index',e-1);return $('body').append(t),t.trigger('click.acu_dash_preview'),void t.remove()}}}return void(window.toastr&&window.toastr.info(`ã€Œ${t}ã€æš‚æ— è¯¦ç»†èµ„æ–™`,'',{timeOut:2e3}))}const o=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',a).data('row-index',parseInt(i,10));$('body').append(o),o.trigger('click.acu_dash_preview'),o.remove()}})}),Y.on('pointerup.mobileclear',function(t){e&&!$(t.target).closest('.acu-graph-node').length&&(K(),e=null)})}else L.on('pointerenter.pchover','.acu-graph-node',function(){const e=$(this).data('name');e&&J(e)}),L.on('pointerleave.pchover','.acu-graph-node',function(){K()}),L.on('click.pcclick','.acu-graph-node',function(e){e.stopPropagation();const t=$(this),n=t.data('name'),a=se.getPrimaryName(n),i=t.data('table-key');let o=t.data('row-index');if(!i||''===o||void 0===o){const e=Je||ln();if(e)for(const t in e){const n=e[t];if(!n?.content||!n.name?.includes('NPC'))continue;const i=(n.content[0]||[]).findIndex(e=>e&&(e.includes('å§“å')||e.includes('åç§°')||e.includes('åå­—')));if(!(i<0))for(let e=1;e<n.content.length;e++){const o=String(n.content[e][i]||'').trim();if(o===a||se.getPrimaryName(o)===a){const n=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',t).data('row-index',e-1);return $('body').append(n),n.trigger('click.acu_dash_preview'),void n.remove()}}}return void(window.toastr&&window.toastr.info(`ã€Œ${a}ã€æš‚æ— è¯¦ç»†èµ„æ–™`,'',{timeOut:2e3}))}const r=$('<div class="acu-dash-preview-trigger" style="display:none;"></div>').data('table-key',i).data('row-index',parseInt(o,10));$('body').append(r),r.trigger('click.acu_dash_preview'),r.remove()});X().then(()=>{q()});let G=!1,Z=0,Q=0,ee=0,te=0,ne=0,ae=null;const re=Y[0],le=j[0];re.onpointerdown=function(e){0===e.button&&($(e.target).closest('.acu-graph-node').length||$(e.target).closest('.acu-node-size-slider-container').length||(e.preventDefault(),re.setPointerCapture(e.pointerId),ae=e.pointerId,G=!0,Z=e.clientX,Q=e.clientY,ee=D,te=P,le.style.cursor='grabbing'))},re.onpointermove=function(e){if(!G||e.pointerId!==ae)return;const t=e.clientX-Z,n=e.clientY-Q,a=le.getBoundingClientRect();D=ee+t/a.width*800,P=te+n/a.height*600,q()},re.onpointerup=function(e){e.pointerId===ae&&(re.releasePointerCapture(e.pointerId),G=!1,ae=null,le.style.cursor='grab')},re.onpointercancel=function(e){e.pointerId===ae&&(G=!1,ae=null,le.style.cursor='grab')},re.onwheel=function(e){e.preventDefault();const t=e.deltaY>0?-.15:.15;W(B+t)},re.addEventListener('touchstart',function(e){2===e.touches.length&&(e.preventDefault(),G=!1,ne=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY))},{passive:!1}),re.addEventListener('touchmove',function(e){if(2===e.touches.length){e.preventDefault();const t=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);ne>0&&W(B*(t/ne)),ne=t}},{passive:!1}),re.addEventListener('touchend',function(e){e.touches.length<2&&(ne=0)});const de=N.find('#node-size-slider'),ue=N.find('#slider-size-display'),pe=N.find('.acu-node-size-slider-container'),ge=N.find('#node-size-display-trigger');N.find('.acu-graph-legend');let fe=!1,be=null;const me=()=>{fe&&(be&&(clearTimeout(be),be=null),fe=!1,pe.hide())},he=()=>{be&&clearTimeout(be),be=setTimeout(()=>{me()},4e3)};N.on('click','#node-size-display-trigger, #node-size-display-trigger *',function(e){e.stopPropagation(),fe?me():(()=>{if(fe)return;be&&(clearTimeout(be),be=null),fe=!0;const e=ge[0].getBoundingClientRect(),t=Y[0].getBoundingClientRect(),n=t.height-60-10,a=e.left-t.left;pe.css({display:'block',top:`${n}px`,left:`${a}px`}),he()})()}),de.on('input mousedown touchstart',function(e){e.stopPropagation(),fe&&he()}),pe.on('pointerdown mousedown touchstart',function(e){e.stopPropagation()}),$(document).on('click.slider-hide',function(e){!fe||pe.is(e.target)||0!==pe.has(e.target).length||ge.is(e.target)||0!==ge.has(e.target).length||me()}),de.on('input',function(){E=parseFloat($(this).val()),ue.text(Math.round(100*E)+'%'),H(),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),X(),he()});const ve=N.find('#filter-in-scene'),xe=N.find('#filter-direct-only'),ye=()=>{ve.css({background:A?n.accent:n.btnBg,color:A?n.btnActiveText:n.textMain,borderColor:A?n.accent:n.border}),xe.css({background:S?n.accent:n.btnBg,color:S?n.btnActiveText:n.textMain,borderColor:S?n.accent:n.border})};ye(),ve.click(function(e){e.stopPropagation(),A=!A,ye(),X()}),xe.click(function(e){e.stopPropagation(),S=!S,ye(),X()}),N.find('#graph-zoom-reset').click(()=>{B=1,D=0,P=0,q(),E=1,de.val(1),ue.text('100%'),H();const e=N.find('.acu-stepper[data-id="graph-node-size"]');e.length&&e.find('.acu-stepper-value').text('100%'),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),F()||M(),X()});const we=N.find('.acu-stepper[data-id="graph-node-size"]');if(we.length){const e=parseInt(we.data('min')),t=parseInt(we.data('max')),n=parseInt(we.data('step')),a=we.find('.acu-stepper-value'),i=n=>{n=Math.max(e,Math.min(t,n)),E=n/100,a.text(`${n}%`),H(),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),X()},o=()=>{const e=a.text().replace(/[^\d]/g,'');return parseInt(e)||100};we.find('.acu-stepper-dec').on('click',function(){i(o()-n)}),we.find('.acu-stepper-inc').on('click',function(){i(o()+n)})}N.find('#graph-relayout').click(()=>{(()=>{try{const e=T();localStorage.removeItem(e)}catch(e){console.warn('[DICE]å…³ç³»å›¾ æ¸…é™¤å¸ƒå±€ç¼“å­˜å¤±è´¥:',e)}})(),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),M(),X()}),N.find('#graph-manage-avatar').click(()=>{Qt(h,()=>{h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),X()})});const ke=()=>{re.onpointerdown=null,re.onpointermove=null,re.onpointerup=null,re.onpointercancel=null,re.onwheel=null,be&&(clearTimeout(be),be=null),$(document).off('click.slider-hide'),N.remove()};N.find('.acu-graph-close').click(ke),N.on('click',function(e){$(e.target).hasClass('acu-relation-graph-overlay')&&ke()})},Zt=(e,t,n)=>{const{$}=ut();$('.acu-crop-modal-overlay').remove();const a=an();Me();let i=150,r=50,c=50;const s=se.getAll()[t];s&&(i=s.scale??150,r=s.offsetX??50,c=s.offsetY??50);const l=`\n            <div class="acu-crop-modal-overlay acu-theme-${a.theme}">\n                <div class="acu-crop-modal">\n                    <div class="acu-crop-header">\n                        <span><i class="fa-solid fa-crop-simple"></i> è°ƒæ•´å¤´åƒ - ${o(t)}</span>\n                        <button class="acu-crop-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-crop-body">\n                        <div class="acu-crop-container">\n                            <div class="acu-crop-image" style="\n                                background-image: url('${e}');\n                                background-size: ${i}%;\n                                background-position: ${r}% ${c}%;\n                            "></div>\n                            <div class="acu-crop-mask"></div>\n                        </div>\n                        <div class="acu-crop-hint">æ‹–æ‹½ç§»åŠ¨ Â· æ»šè½®/åŒæŒ‡ç¼©æ”¾</div>\n                    </div>\n                    <div class="acu-crop-footer">\n                        <label class="acu-crop-btn acu-crop-reupload" title="é‡æ–°ä¸Šä¼ ">\n                            <i class="fa-solid fa-camera"></i>\n                            <input type="file" accept="image/*" class="acu-crop-file-input" style="display:none;" />\n                        </label>\n                        <button class="acu-crop-btn acu-crop-cancel">å–æ¶ˆ</button>\n                        <button class="acu-crop-btn acu-crop-confirm"><i class="fa-solid fa-check"></i> ç¡®å®š</button>\n                    </div>\n                </div>\n            </div>\n        `,d=$(l);$('body').append(d),d.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',display:'flex','align-items':'center','justify-content':'center','z-index':'2147483658'});const u=d.find('.acu-crop-image'),p=d.find('.acu-crop-container')[0],g=u[0],f=()=>{g.style.backgroundSize=`${i}%`,g.style.backgroundPosition=`${r}% ${c}%`};let b=!1,m=0,h=0,v=0,x=0,y=null;g.addEventListener('pointerdown',e=>{null===y&&(e.preventDefault(),e.stopPropagation(),b=!0,y=e.pointerId,m=e.clientX,h=e.clientY,v=r,x=c,g.setPointerCapture(e.pointerId),g.style.cursor='grabbing')}),g.addEventListener('pointermove',e=>{if(!b||e.pointerId!==y)return;e.preventDefault(),e.stopPropagation();const t=e.clientX-m,n=e.clientY-h,a=100/i;r=Math.max(0,Math.min(100,v-t*a)),c=Math.max(0,Math.min(100,x-n*a)),f()}),g.addEventListener('pointerup',e=>{e.pointerId===y&&(b=!1,y=null,g.releasePointerCapture(e.pointerId),g.style.cursor='grab')}),g.addEventListener('pointercancel',e=>{e.pointerId===y&&(b=!1,y=null,g.style.cursor='grab')}),p.addEventListener('wheel',e=>{e.preventDefault(),e.stopPropagation();const t=e.deltaY>0?-10:10;i=Math.max(100,Math.min(300,i+t)),f()},{passive:!1});let w=0,k=i;p.addEventListener('touchstart',e=>{2===e.touches.length&&(e.preventDefault(),w=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY),k=i)},{passive:!1}),p.addEventListener('touchmove',e=>{if(2===e.touches.length){e.preventDefault();const t=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);if(w>0){const e=t/w;i=Math.max(100,Math.min(300,k*e)),f()}}},{passive:!1}),p.addEventListener('touchend',e=>{e.touches.length<2&&(w=0,k=i)}),d.find('.acu-crop-file-input').on('change',async function(n){const a=n.target.files[0];if(a)if(a.type.startsWith('image/'))if(a.size>5242880)window.toastr&&window.toastr.warning('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB');else{try{if(await se.saveLocalAvatar(t,a)){const n=await ae.get(t);e=n,i=150,r=50,c=50,u.css('background-image',`url('${n}')`),f()}}catch(e){console.error('[DICE]ACU é‡æ–°ä¸Šä¼ å¤±è´¥:',e),window.toastr&&window.toastr.error('ä¸Šä¼ å¤±è´¥')}$(this).val('')}else window.toastr&&window.toastr.warning('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶')}),d.find('.acu-crop-close, .acu-crop-cancel').on('click',()=>{d.remove()}),d.find('.acu-crop-confirm').on('click',()=>{n({scale:i,offsetX:r,offsetY:c}),d.remove()}),d.on('click',e=>{$(e.target).hasClass('acu-crop-modal-overlay')&&d.remove()})},Qt=(e,t)=>{try{const{$}=ut();$('.acu-avatar-manager-overlay').remove();const n=an(),a=Me(),i=se.getAll(),r=e=>{if(!e)return e;const t=ie(),n=oe(),a=['<user>','{{user}}'].some(t=>e===t||e.toLowerCase()===t.toLowerCase()),i=n&&e===n,o=(()=>{if(!t)return!1;if(e===t)return!0;return se.getPrimaryName(e)===t})();return a||i||o?'{{user}}':se.getPrimaryName(e)},c=async()=>{let t='';const n=e.find(e=>'{{user}}'===r(e.name)),a=e.filter(e=>'{{user}}'!==r(e.name));if(n){const e={...n,name:'{{user}}'},a=i[e.name]||{};let r=a.url||'';const c=await se.hasLocalAvatar(e.name);let s='',l='';c?(s=await ae.get(e.name),l='<span class="acu-avatar-source acu-source-local">æœ¬åœ°</span>'):r&&(s=r,l='<span class="acu-avatar-source acu-source-url">URL</span>');const d=(a.aliases||[]).join(', '),u=!!s;t+=`\n                    <div class="acu-avatar-item" data-name="${o(e.name)}" data-has-local="${c}" data-display-url="${o(s)}">\n                        <div class="acu-avatar-preview-wrap">\n                            <div class="acu-avatar-preview ${u?'has-image':''}" style="${u?`background-image: url('${s}'); background-position: ${a.offsetX??50}% ${a.offsetY??50}%; background-size: ${a.scale??150}%;`:''}">\n                                ${u?'':`<span>${o(e.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                            </div>\n                            ${l}\n                        </div>\n                        <div class="acu-avatar-info">\n                            <div class="acu-avatar-name-row">\n                                <div class="acu-avatar-name">${o(e.name)}</div>\n                                <div class="acu-avatar-actions">\n                                    <button class="acu-avatar-save-btn" title="ä¿å­˜"><i class="fa-solid fa-check"></i></button>\n                                    <button class="acu-avatar-clear-btn" title="æ¸…é™¤"><i class="fa-solid fa-trash"></i></button>\n                                </div>\n                            </div>\n                            <input type="text" class="acu-avatar-url" placeholder="ç²˜è´´URL..." value="${o(r)}" />\n                            <input type="text" class="acu-avatar-aliases" placeholder="åˆ«åï¼ˆé€—å·åˆ†éš”ï¼‰..." value="${o(d)}" title="ä¾‹å¦‚: ç¦, ç¦å¤´" />\n                            <input type="file" accept="image/*" class="acu-avatar-file-input" style="display:none;" />\n                        </div>\n                    </div>\n                `}for(const e of a){const n=i[e.name]||{};let a=n.url||'';const r=await se.hasLocalAvatar(e.name);let c='',s='';r?(c=await ae.get(e.name),s='<span class="acu-avatar-source acu-source-local">æœ¬åœ°</span>'):a&&(c=a,s='<span class="acu-avatar-source acu-source-url">URL</span>');const l=(n.aliases||[]).join(', '),d=!!c;t+=`\n                    <div class="acu-avatar-item" data-name="${o(e.name)}" data-has-local="${r}" data-display-url="${o(c)}">\n                        <div class="acu-avatar-preview-wrap">\n                            <div class="acu-avatar-preview ${d?'has-image':''}" style="${d?`background-image: url('${c}'); background-position: ${n.offsetX??50}% ${n.offsetY??50}%; background-size: ${n.scale??150}%;`:''}">\n                                ${d?'':`<span>${o(e.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                            </div>\n                            ${s}\n                        </div>\n                        <div class="acu-avatar-info">\n                            <div class="acu-avatar-name-row">\n                                <div class="acu-avatar-name">${o(e.name)}</div>\n                                <div class="acu-avatar-actions">\n                                    <button class="acu-avatar-save-btn" title="ä¿å­˜"><i class="fa-solid fa-check"></i></button>\n                                    <button class="acu-avatar-clear-btn" title="æ¸…é™¤"><i class="fa-solid fa-trash"></i></button>\n                                </div>\n                            </div>\n                            <input type="text" class="acu-avatar-url" placeholder="ç²˜è´´URL..." value="${o(a)}" />\n                            <input type="text" class="acu-avatar-aliases" placeholder="åˆ«åï¼ˆé€—å·åˆ†éš”ï¼‰..." value="${o(l)}" title="ä¾‹å¦‚: ç¦, ç¦å¤´" />\n                            <input type="file" accept="image/*" class="acu-avatar-file-input" style="display:none;" />\n                        </div>\n                    </div>\n                `}return t},s=`\n            <div class="acu-avatar-manager-overlay acu-theme-${n.theme}">\n                <div class="acu-avatar-manager">\n                    <div class="acu-panel-header">\n                        <div class="acu-avatar-title"><i class="fa-solid fa-user-circle"></i> å¤´åƒç®¡ç†</div>\n                        <div style="display:flex;gap:4px;align-items:center;">\n                            <button class="acu-avatar-import-btn" title="å¯¼å…¥"><i class="fa-solid fa-file-import"></i></button>\n                            <button class="acu-avatar-export-btn" title="å¯¼å‡º"><i class="fa-solid fa-file-export"></i></button>\n                            <button class="acu-avatar-close"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-avatar-list" id="acu-avatar-list-container">\n                        <div style="text-align:center;padding:20px;color:${a.textSub};">\n                            <i class="fa-solid fa-spinner fa-spin"></i> åŠ è½½ä¸­...\n                        </div>\n                    </div>\n                </div>\n                <input type="file" id="acu-avatar-file-input" accept=".json" style="display:none;" />\n            </div>\n        `,l=$(s);$('body').append(l),c().then(e=>{l.find('#acu-avatar-list-container').html(e),u()});const d=async e=>{const t=l.find(`.acu-avatar-item[data-name="${e}"]`);if(!t.length)return;const n=se.getAll()[e]||{},a=await se.hasLocalAvatar(e);let i='',r='';a?(i=await ae.get(e),r='<span class="acu-avatar-source acu-source-local">æœ¬åœ°</span>'):n.url&&(i=n.url,r='<span class="acu-avatar-source acu-source-url">URL</span>');const c=t.find('.acu-avatar-preview');t.find('.acu-avatar-source').remove(),i?(c.addClass('has-image').css({'background-image':`url('${i}')`,'background-position':`${n.offsetX??50}% ${n.offsetY??50}%`,'background-size':`${n.scale??150}%`}).find('span').remove(),t.find('.acu-avatar-preview-wrap').append(r)):c.removeClass('has-image').css({'background-image':'','background-position':'','background-size':''}).html(`<span>${o(e.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`),t.attr('data-has-local',a),t.attr('data-display-url',i)},u=()=>{l.on('click','.acu-avatar-preview',async function(e){e.stopPropagation();const n=$(this).closest('.acu-avatar-item'),a=n.data('name'),i=n.attr('data-display-url');i?Zt(i,a,async e=>{const n=se.getAll()[a]||{};se.set(a,n.url||'',e.offsetX,e.offsetY,e.scale,n.aliases||[]),await d(a),t&&t()}):n.find('.acu-avatar-file-input').click()}),l.on('change','.acu-avatar-file-input',async function(e){const n=e.target.files[0];if(!n)return;if(!n.type.startsWith('image/'))return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶'));if(n.size>5242880)return void(window.toastr&&window.toastr.warning('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 5MB'));const a=$(this).closest('.acu-avatar-item').data('name');try{if(await se.saveLocalAvatar(a,n)){const e=await ae.get(a);await d(a),Zt(e,a,async e=>{const n=se.getAll()[a]||{};se.set(a,n.url||'',e.offsetX,e.offsetY,e.scale,n.aliases||[]),await d(a),t&&t()})}}catch(e){console.error('[DICE]ACU ä¸Šä¼ å¤´åƒå¤±è´¥:',e),window.toastr&&window.toastr.error('ä¸Šä¼ å¤±è´¥')}$(this).val('')}),l.on('click','.acu-avatar-save-btn',async function(){const e=$(this).closest('.acu-avatar-item'),n=e.data('name'),a=e.find('.acu-avatar-url').val().trim(),i=e.find('.acu-avatar-aliases').val().trim(),o=i?i.split(/[,ï¼Œ]/).map(e=>e.trim()).filter(e=>e&&e!==n):[],r=se.getAll()[n]||{};se.set(n,a,r.offsetX??50,r.offsetY??50,r.scale??150,o);const c='true'===e.attr('data-has-local');a&&!c?(await d(n),Zt(a,n,async e=>{se.set(n,a,e.offsetX,e.offsetY,e.scale,o),await d(n),t&&t()})):(await d(n),t&&t())}),l.on('click','.acu-avatar-clear-btn',async function(){const e=$(this).closest('.acu-avatar-item'),n=e.data('name');await se.deleteLocalAvatar(n),se.remove(n),e.find('.acu-avatar-url').val(''),e.find('.acu-avatar-aliases').val(''),await d(n),t&&t()}),l.on('click','.acu-avatar-export-btn',function(){const e=se.exportData(),t=JSON.stringify(e,null,2),n=new Blob([t],{type:'application/json'}),a=URL.createObjectURL(n),i=document.createElement('a');i.href=a,i.download=`avatar-config-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}),l.on('click','.acu-avatar-import-btn',function(){l.find('#acu-avatar-file-input').click()}),l.on('change','#acu-avatar-file-input',function(n){const a=n.target.files[0];if(!a)return;const i=new FileReader;i.onload=function(n){try{const a=JSON.parse(n.target.result),i=se.analyzeImport(a);if(!i.valid)return void(window.toastr&&window.toastr.error(i.error));en(a,i,()=>{l.remove(),Qt(e,t),t&&t()})}catch(e){console.error('[DICE]ACU å¯¼å…¥è§£æå¤±è´¥:',e),window.toastr&&window.toastr.error('æ–‡ä»¶è§£æå¤±è´¥')}},i.readAsText(a),$(this).val('')})},p=()=>l.remove();l.on('click','.acu-avatar-close',p),l.on('click',function(e){$(e.target).hasClass('acu-avatar-manager-overlay')&&p()})}catch(e){if(console.error('å¤´åƒç®¡ç†å™¨é”™è¯¯:',e),window.toastr){const t=e instanceof Error?e.message:'æœªçŸ¥é”™è¯¯';window.toastr.error(`å¤´åƒç®¡ç†å™¨åŠ è½½å¤±è´¥: ${t}`)}$('.acu-avatar-manager-overlay').remove()}},en=(e,t,n)=>{const{$}=ut();$('.acu-import-confirm-overlay').remove();const a=Me(),i=an(),r=t.conflicts.length>0,c=t.conflicts.length>0?`<div style="max-height:80px;overflow-y:auto;background:rgba(0,0,0,0.1);border-radius:4px;padding:6px 8px;margin-top:6px;font-size:11px;color:${a.textSub};">${t.conflicts.map(e=>o(e)).join(', ')}</div>`:'',s=`\n            <div class="acu-import-confirm-overlay acu-theme-${i.theme}">\n                <div class="acu-import-confirm-dialog">\n                    <div class="acu-import-confirm-header">\n                        <i class="fa-solid fa-file-import"></i> å¯¼å…¥å¤´åƒé…ç½®\n                    </div>\n                    <div class="acu-import-confirm-body">\n                        <div class="acu-import-stats">\n                            <div class="acu-import-stat">\n                                <span class="acu-stat-num">${t.total}</span>\n                                <span class="acu-stat-label">æ€»è®¡</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-new">\n                                <span class="acu-stat-num">${t.newItems.length}</span>\n                                <span class="acu-stat-label">æ–°å¢</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-conflict">\n                                <span class="acu-stat-num">${t.conflicts.length}</span>\n                                <span class="acu-stat-label">å†²çª</span>\n                            </div>\n                        </div>\n\n                        ${r?`\n                            <div class="acu-import-conflict-section">\n                                <div style="font-size:12px;font-weight:bold;color:${a.textMain};margin-bottom:4px;">\n                                    <i class="fa-solid fa-exclamation-triangle" style="color:${a.warningIcon};"></i> ä»¥ä¸‹è§’è‰²å·²å­˜åœ¨ï¼š\n                                </div>\n                                ${c}\n                                <div class="acu-import-conflict-options">\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="overwrite" checked />\n                                        <span>ç”¨å¯¼å…¥çš„è¦†ç›–æœ¬åœ°</span>\n                                    </label>\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="skip" />\n                                        <span>ä¿ç•™æœ¬åœ°çš„ä¸å˜</span>\n                                    </label>\n                                </div>\n                            </div>\n                        `:`\n                            <div style="text-align:center;padding:10px;color:${a.successText};">\n                                <i class="fa-solid fa-check-circle"></i> æ— å†²çªï¼Œå¯ç›´æ¥å¯¼å…¥\n                            </div>\n                        `}\n                    </div>\n                    <div class="acu-import-confirm-footer">\n                        <button class="acu-import-cancel-btn">å–æ¶ˆ</button>\n                        <button class="acu-import-confirm-btn">ç¡®è®¤å¯¼å…¥</button>\n                    </div>\n                </div>\n            </div>\n        `,l=$(s);$('body').append(l);l[0].style.cssText='\n            position: fixed !important;\n            top: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            bottom: 0 !important;\n            width: 100vw !important;\n            height: 100vh !important;\n            background: rgba(0,0,0,0.6) !important;\n            z-index: 2147483655 !important;\n            display: flex;\n            justify-content: center !important;\n            align-items: center !important;\n            padding: 16px;\n            box-sizing: border-box !important;\n        ';const d=()=>l.remove();l.find('.acu-import-cancel-btn').click(d),l.on('click',function(e){$(e.target).hasClass('acu-import-confirm-overlay')&&d()}),l.find('.acu-import-confirm-btn').click(function(){const t='skip'!==l.find('input[name="conflict-mode"]:checked').val();try{se.importData(e,t);d(),n&&n()}catch(e){console.error('[DICE]ACU å¯¼å…¥å¤±è´¥:',e),window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥ï¼š'+e.message)}})},tn=(e,t,n,a,i)=>{const{$}=ut(),r=an();let c=Je||ln()||Ct(),s=e;c&&c[i]&&c[i]?.content?.[a+1]&&(s=c[i]?.content?.[a+1]);const l=s.map((e,n)=>{if(0===n)return'';const a=t[n]||`åˆ— ${n}`,i=e||'';return`\n                <div class="acu-card-edit-field" style="margin-bottom: 10px;">\n                    <label style="display:block;font-size:12px;color:var(--acu-accent);font-weight:bold;margin-bottom:4px;">${o(a)}</label>\n                    <textarea class="acu-card-edit-input acu-edit-textarea" data-col="${n}" spellcheck="false" rows="1"\n                    style="width:100%;min-height:40px;max-height:500px;padding:10px;resize:none;overflow-y:hidden;">${o(i)}</textarea>\n                </div>`}).join(''),d=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${r.theme}">\n                    <div class="acu-edit-title">æ•´ä½“ç¼–è¾‘ (#${a+1} - ${o(n)})</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${l}\n                    </div>\n                     <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-card-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-card-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(d);const u=e=>{e.style.height='auto';const t=e.scrollHeight+2;e.style.height=Math.min(t,500)+'px',e.style.overflowY=t>500?'auto':'hidden'};requestAnimationFrame(()=>{d.find('textarea').each(function(){u(this)})}),d.find('textarea').on('input',function(){u(this)});const p=()=>d.remove();d.find('#dlg-card-cancel').click(p),d.find('#dlg-card-save').click(async()=>{let e=Je||ln()||Ct();if(e&&e[i]){const t=e[i]?.content?.[a+1];if(!t)return void p();let n=!1;if(d.find('textarea').each(function(){const e=parseInt($(this).data('col')),a=$(this).val();String(t[e])!==String(a)&&(n=!0,t[e]=a)}),n)try{await dn(e,!1,!0),Sn()}catch(e){return void console.error('[DICE]ACU ä¿å­˜å¤±è´¥:',e)}}p()}),d.on('click',function(e){($(e.target).hasClass('acu-edit-overlay')||$(e.target).closest('#dlg-close-x, #dlg-close, .acu-close-btn').length)&&p()})};let nn=null;const an=()=>(nn||(nn={...ct,...bt.get(g,{})}),nn),on=e=>{nn={...an(),...e},bt.set(g,nn),cn(nn)},rn=e=>{const t=Ct(),n=new Set;if(!t)return n;for(const a in e){const i=e[a],o=t[a];if(!i||!i.name)continue;const r=i.name;if(!o){i.content&&i.content.forEach((e,t)=>{t>0&&n.add(`${r}-row-${t-1}`)});continue}const c=i.content||[],s=o.content||[];c.forEach((e,t)=>{if(0===t)return;const a=s[t];a?e.forEach((e,i)=>{if(0===i)return;const o=a[i];String(e)!==String(o)&&n.add(`${r}-${t-1}-${i}`)}):n.add(`${r}-row-${t-1}`)})}return n},cn=e=>{const{$}=ut(),t=$('.acu-wrapper'),n=st.find(t=>t.id===e.fontFamily)?.val||st[0].val,a=$('#acu-dynamic-font');if(a.data('font-id')!==e.fontFamily){a.remove();const t='\n                @import url("https://fontsapi.zeoseven.com/3/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/442/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/256/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/482/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/446/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/570/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/292/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/69/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/7/main/result.css");\n            ';$('head').append(`\n                <style id="acu-dynamic-font" data-font-id="${e.fontFamily}">\n                    ${t}\n                    .acu-wrapper, .acu-edit-dialog, .acu-cell-menu, .acu-nav-container, .acu-data-card, .acu-panel-title, .acu-settings-label, .acu-btn-block, .acu-nav-btn, .acu-edit-textarea,\n                    .acu-dice-panel, .acu-contest-panel, .acu-dice-config-dialog,\n                    .acu-relation-graph-container, .acu-avatar-manager, .acu-import-confirm-dialog {\n                        font-family: ${n} !important;\n                    }\n                </style>\n            `)}const i={'--acu-card-width':`${e.cardWidth}px`,'--acu-font-size':`${e.fontSize}px`,'--acu-opt-font-size':`${e.optionFontSize||12}px`,'--acu-grid-cols':e.gridColumns};t.length&&(t.removeClass((e,t)=>(t.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),t.addClass(`acu-theme-${e.theme}`),t.css(i));const o=$('.acu-embedded-options-container');o.length&&(o.removeClass((e,t)=>(t.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),o.addClass(`acu-theme-${e.theme}`),o.css(i))},sn=()=>{if(window._acuStylesInjected&&$(`#${n}-styles`).length)return;window._acuStylesInjected=!0;const{$}=ut();$('style').each(function(){this.id&&this.id.startsWith('acu_')&&this.id.endsWith('-styles')&&this.id!==`${n}-styles`&&$(this).remove()}),$(`#${n}-styles`).remove();const e=`\n        <style id="${n}-styles">\n    /* ========== æ ¸å¿ƒéš”ç¦»å±‚ ========== */\n    .acu-wrapper,\n    .acu-wrapper *:not(i[class*="fa-"]),\n    .acu-edit-overlay,\n    .acu-edit-overlay *:not(i[class*="fa-"]),\n    .acu-cell-menu,\n    .acu-cell-menu *:not(i[class*="fa-"]),\n    .acu-dice-panel,\n    .acu-dice-panel *:not(i[class*="fa-"]),\n    .acu-contest-panel,\n    .acu-contest-panel *:not(i[class*="fa-"]),\n    .acu-relation-graph-overlay,\n    .acu-relation-graph-overlay *:not(i[class*="fa-"]),\n    .acu-avatar-manager-overlay,\n    .acu-avatar-manager-overlay *:not(i[class*="fa-"]),\n    .acu-preview-overlay,\n    .acu-preview-overlay *:not(i[class*="fa-"]),\n    .acu-import-confirm-overlay,\n    .acu-import-confirm-overlay *:not(i[class*="fa-"]),\n    .acu-embedded-options-container,\n    .acu-embedded-options-container *:not(i[class*="fa-"]) {\n        box-sizing: border-box;\n        -webkit-tap-highlight-color: transparent;\n        -webkit-font-smoothing: antialiased;\n    }\n    /* ========== åŸºç¡€æ ·å¼ ========== */\n    .acu-wrapper,\n    .acu-edit-overlay,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-embedded-options-container,\n    .acu-cell-menu {\n        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;\n        font-size: 13px;\n        line-height: 1.5;\n        color: var(--acu-text-main);\n    }\n    /* æŠ•éª°é¢æ¿ç»Ÿä¸€æ ·å¼ (éœ€è¦ !important è¦†ç›– SillyTavern å…¨å±€æ ·å¼å’Œå†…è”æ ·å¼) */\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    .acu-dice-panel input[type="text"],\n    .acu-dice-panel input[type="number"],\n    .acu-dice-panel input:not([type]),\n    .acu-dice-panel select,\n    .acu-contest-panel input[type="text"],\n    .acu-contest-panel input[type="number"],\n    .acu-contest-panel input:not([type]),\n    .acu-contest-panel select,\n    .acu-dice-config-dialog input[type="text"],\n    .acu-dice-config-dialog input[type="number"],\n    .acu-dice-config-dialog input:not([type]),\n    .acu-dice-config-dialog select {\n        width: 100%;\n        padding: 6px;\n        background: var(--acu-input-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 4px;\n        color: var(--acu-text-main) !important;\n        font-size: 12px;\n    }\n    /* éšè—numberç±»å‹è¾“å…¥æ¡†çš„æ­¥æ•°å™¨ */\n    .acu-dice-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-outer-spin-button {\n        -webkit-appearance: none;\n        margin: 0;\n    }\n    .acu-dice-panel input[type="number"],\n    .acu-contest-panel input[type="number"],\n    .acu-dice-config-dialog input[type="number"] {\n        -moz-appearance: textfield;\n        text-align: center;\n        box-sizing: border-box;\n    }\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-dice-config-dialog input::placeholder {\n        color: var(--acu-text-sub) !important;\n        opacity: 0.7;\n    }\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-dice-config-dialog input:focus,\n    .acu-dice-config-dialog select:focus {\n        outline: none;\n        border-color: var(--acu-accent) !important;\n    }\n    .acu-dice-panel select option,\n    .acu-contest-panel select option,\n    .acu-dice-config-dialog select option {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    /* æŠ•éª°é¢æ¿ä¸‹æ‹‰æ¡†ç»Ÿä¸€æ ·å¼ */\n    .acu-dice-select {\n        width: 100%;\n        padding: 6px 4px;\n        background: var(--acu-input-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 4px;\n        color: var(--acu-text-main) !important;\n        font-size: 11px;\n        box-sizing: border-box;\n        cursor: pointer;\n        -webkit-appearance: none;\n        text-align: center;\n        appearance: none;\n    }\n    .acu-dice-select:focus {\n        outline: none;\n        border-color: var(--acu-accent) !important;\n    }\n    .acu-dice-select option {\n        background: var(--acu-bg-panel) !important;\n        color: var(--acu-text-main) !important;\n    }\n    /* æœç´¢æ¡†æ ·å¼ */\n    .acu-wrapper .acu-search-input {\n        background-color: var(--acu-input-bg) !important;\n        color: var(--acu-text-main) !important;\n        border: 1px solid var(--acu-border);\n    }\n    .acu-wrapper .acu-search-input:focus {\n        outline: none;\n        border-color: var(--acu-accent);\n        box-shadow: none !important;\n    }\n    .acu-wrapper .acu-search-input::placeholder {\n        color: var(--acu-text-sub) !important;\n        opacity: 0.7;\n    }\n    /* ========== é€šç”¨ç»„ä»¶åŸºç±» ========== */\n    /* æŒ‰é’®åŸºç±» */\n    .acu-wrapper button,\n    .acu-edit-overlay button,\n    .acu-dice-panel button,\n    .acu-contest-panel button,\n    .acu-relation-graph-overlay button,\n    .acu-avatar-manager-overlay button,\n    .acu-preview-overlay button,\n    .acu-embedded-options-container button {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        cursor: pointer;\n        border: 1px solid var(--acu-border);\n        border-radius: 6px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        transition: all 0.2s ease;\n        outline: none;\n    }\n    .acu-wrapper button:hover,\n    .acu-edit-overlay button:hover,\n    .acu-dice-panel button:hover,\n    .acu-contest-panel button:hover,\n    .acu-relation-graph-overlay button:hover,\n    .acu-avatar-manager-overlay button:hover,\n    .acu-preview-overlay button:hover,\n    .acu-embedded-options-container button:hover {\n        background: var(--acu-btn-hover);\n    }\n    .acu-wrapper button:focus,\n    .acu-edit-overlay button:focus,\n    .acu-dice-panel button:focus,\n    .acu-contest-panel button:focus,\n    .acu-relation-graph-overlay button:focus,\n    .acu-avatar-manager-overlay button:focus,\n    .acu-preview-overlay button:focus,\n    .acu-embedded-options-container button:focus {\n        outline: none;\n        box-shadow: none;\n    }\n\n    /* è¾“å…¥æ¡†åŸºç±» */\n    .acu-wrapper input,\n    .acu-wrapper textarea,\n    .acu-wrapper select,\n    .acu-edit-overlay input,\n    .acu-edit-overlay textarea,\n    .acu-edit-overlay select,\n    .acu-dice-panel input,\n    .acu-dice-panel select,\n    .acu-contest-panel input,\n    .acu-contest-panel select,\n    .acu-avatar-manager-overlay input {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        border: 1px solid var(--acu-border);\n        border-radius: 4px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        outline: none;\n        transition: border-color 0.2s;\n    }\n    .acu-wrapper input:focus,\n    .acu-wrapper textarea:focus,\n    .acu-wrapper select:focus,\n    .acu-edit-overlay input:focus,\n    .acu-edit-overlay textarea:focus,\n    .acu-edit-overlay select:focus,\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-avatar-manager-overlay input:focus {\n        border-color: var(--acu-accent);\n        box-shadow: none;\n        outline: none;\n    }\n    .acu-wrapper input::placeholder,\n    .acu-wrapper textarea::placeholder,\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-avatar-manager-overlay input::placeholder {\n        color: var(--acu-text-sub);\n        opacity: 0.7;\n    }\n\n    /* å¼¹çª—é®ç½©å±‚åŸºç±» */\n    .acu-edit-overlay,\n    .acu-dice-overlay,\n    .acu-contest-overlay,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-dice-config-overlay,\n    .acu-crop-modal-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0,0,0,0.6);\n        z-index: 2147483646;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 16px;\n        backdrop-filter: blur(2px);\n    }\n\n    /* å¼¹çª—å®¹å™¨åŸºç±» */\n    .acu-edit-dialog,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-container,\n    .acu-avatar-manager,\n    .acu-import-confirm-dialog,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        border: 1px solid var(--acu-border);\n        border-radius: 12px;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.4);\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n    }\n\n    /* å¼¹çª—å¤´éƒ¨åŸºç±» - ç»Ÿä¸€ä½¿ç”¨ .acu-panel-header */\n    .acu-panel-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 15px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        flex-shrink: 0;\n    }\n\n    /* å…³é—­æŒ‰é’®åŸºç±» - æ‰€æœ‰å…³é—­æŒ‰é’®ç»Ÿä¸€ä½¿ç”¨ .acu-close-btn */\n    .acu-close-btn {\n        background: none;\n        border: none;\n        color: var(--acu-text-sub);\n        cursor: pointer;\n        font-size: 16px;\n        padding: 4px 8px;\n        border-radius: 4px;\n        transition: all 0.2s;\n    }\n    .acu-close-btn:hover {\n        background: var(--acu-error-bg, rgba(231, 76, 60, 0.15));\n        color: var(--acu-error-text, #e74c3c);\n    }\n\n    /* æ»šåŠ¨æ¡å…¨å±€éšè— */\n    [class^="acu-"], [class^="acu-"] * { scrollbar-width: none; -ms-overflow-style: none; }\n    [class^="acu-"] *::-webkit-scrollbar { display: none !important; }\n\n    /* ========== ä¸»é¢˜å˜é‡å®šä¹‰ ========== */\n    .acu-theme-retro { --acu-bg-nav: #e6e2d3; --acu-bg-panel: #e6e2d3; --acu-border: #dcd0c0; --acu-text-main: #5e4b35; --acu-text-sub: #999; --acu-btn-bg: #dcd0c0; --acu-btn-hover: #cbbba8; --acu-btn-active-bg: #8d7b6f; --acu-btn-active-text: #fdfaf5; --acu-accent: #7a695f; --acu-table-head: #efebe4; --acu-table-hover: #f0ebe0; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #fffef9; --acu-badge-bg: #efebe4; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #27ae60; --acu-success-bg: rgba(39, 174, 96, 0.15); --acu-scrollbar-track: #e6e2d3; --acu-scrollbar-thumb: #cbbba8; --acu-input-bg: #f5f2eb;--acu-hl-manual: #d35400; --acu-hl-manual-bg: rgba(211, 84, 0, 0.15); --acu-hl-diff: #2980b9; --acu-hl-diff-bg: rgba(41, 128, 185, 0.15); --acu-error-text: #e74c3c; --acu-error-bg: rgba(231, 76, 60, 0.15); --acu-error-border: rgba(231, 76, 60, 0.5); --acu-warning-icon: #e67e22; --acu-failure-text: #e74c3c; --acu-failure-bg: rgba(231, 76, 60, 0.15); --acu-warning-text: #f39c12; --acu-warning-bg: rgba(243, 156, 18, 0.15); --acu-crit-success-text: #9b59b6; --acu-crit-success-bg: rgba(155, 89, 182, 0.15); --acu-crit-failure-text: #c0392b; --acu-crit-failure-bg: rgba(192, 57, 43, 0.15); --acu-extreme-success-text: #2980b9; --acu-extreme-success-bg: rgba(41, 128, 185, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #5e4b35; --acu-gray-bg: rgba(128,128,128,0.1); }\n    .acu-theme-dark { --acu-bg-nav: #2b2b2b; --acu-bg-panel: #252525; --acu-border: #444; --acu-text-main: #eee; --acu-text-sub: #aaa; --acu-btn-bg: #3a3a3a; --acu-btn-hover: #4a4a4a; --acu-btn-active-bg: #6a5acd; --acu-btn-active-text: #fff; --acu-accent: #9b8cd9; --acu-table-head: #333333; --acu-table-hover: #3a3a3a; --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #2d3035; --acu-badge-bg: #3a3f4b; --acu-menu-bg: #333; --acu-menu-text: #eee; --acu-success-text: #4cd964; --acu-success-bg: rgba(76, 217, 100, 0.2); --acu-scrollbar-track: #2b2b2b; --acu-scrollbar-thumb: #555; --acu-hl-manual: #ff6b81; --acu-hl-manual-bg: rgba(255, 107, 129, 0.2); --acu-hl-diff: #00d2d3; --acu-hl-diff-bg: rgba(0, 210, 211, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-failure-text: #ff6b6b; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-crit-success-text: #ba68c8; --acu-crit-success-bg: rgba(186, 104, 200, 0.2); --acu-crit-failure-text: #d32f2f; --acu-crit-failure-bg: rgba(211, 47, 47, 0.2); --acu-extreme-success-text: #42a5f5; --acu-extreme-success-bg: rgba(66, 165, 245, 0.2); --acu-overlay-bg: rgba(0,0,0,0.75); --acu-overlay-bg-light: rgba(0,0,0,0.65); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255,255,255,0.05); --acu-very-light-bg: rgba(255,255,255,0.02); --acu-button-text: #fff; --acu-gray-bg: rgba(255,255,255,0.1); }\n    .acu-theme-modern { --acu-bg-nav: #ffffff; --acu-bg-panel: #f8f9fa; --acu-border: #e0e0e0; --acu-text-main: #333; --acu-text-sub: #666; --acu-btn-bg: #f1f3f5; --acu-btn-hover: #e9ecef; --acu-btn-active-bg: #007bff; --acu-btn-active-text: #fff; --acu-accent: #007bff; --acu-table-head: #f8f9fa; --acu-table-hover: #f1f3f5; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #f1f3f5; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #28a745; --acu-success-bg: rgba(40, 167, 69, 0.15); --acu-scrollbar-track: #fff; --acu-scrollbar-thumb: #ccc; --acu-hl-manual: #fd7e14; --acu-hl-manual-bg: rgba(253, 126, 20, 0.15); --acu-hl-diff: #0d6efd; --acu-hl-diff-bg: rgba(13, 110, 253, 0.15); --acu-error-text: #dc3545; --acu-error-bg: rgba(220, 53, 69, 0.15); --acu-error-border: rgba(220, 53, 69, 0.5); --acu-warning-icon: #fd7e14; --acu-failure-text: #dc3545; --acu-failure-bg: rgba(220, 53, 69, 0.15); --acu-warning-text: #ffc107; --acu-warning-bg: rgba(255, 193, 7, 0.15); --acu-crit-success-text: #6f42c1; --acu-crit-success-bg: rgba(111, 66, 193, 0.15); --acu-crit-failure-text: #c82333; --acu-crit-failure-bg: rgba(200, 35, 51, 0.15); --acu-extreme-success-text: #17a2b8; --acu-extreme-success-bg: rgba(23, 162, 184, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #333; --acu-gray-bg: rgba(128,128,128,0.1); }\n    .acu-theme-forest { --acu-bg-nav: #e8f5e9; --acu-bg-panel: #e8f5e9; --acu-border: #c8e6c9; --acu-text-main: #2e7d32; --acu-text-sub: #81c784; --acu-btn-bg: #c8e6c9; --acu-btn-hover: #a5d6a7; --acu-btn-active-bg: #43a047; --acu-btn-active-text: #fff; --acu-accent: #4caf50; --acu-table-head: #dcedc8; --acu-table-hover: #f1f8e9; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #dcedc8; --acu-menu-bg: #fff; --acu-menu-text: #2e7d32; --acu-success-text: #2e7d32; --acu-success-bg: rgba(46, 125, 50, 0.2); --acu-scrollbar-track: #e8f5e9; --acu-scrollbar-thumb: #a5d6a7; --acu-hl-manual: #e67e22; --acu-hl-manual-bg: rgba(230, 126, 34, 0.15); --acu-hl-diff: #1e8449; --acu-hl-diff-bg: rgba(30, 132, 73, 0.2); --acu-button-text: #2e7d32; }\n    .acu-theme-ocean { --acu-bg-nav: #e3f2fd; --acu-bg-panel: #e3f2fd; --acu-border: #90caf9; --acu-text-main: #1565c0; --acu-text-sub: #64b5f6; --acu-btn-bg: #bbdefb; --acu-btn-hover: #90caf9; --acu-btn-active-bg: #1976d2; --acu-btn-active-text: #fff; --acu-accent: #2196f3; --acu-table-head: #bbdefb; --acu-table-hover: #e1f5fe; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #e3f2fd; --acu-menu-bg: #fff; --acu-menu-text: #1565c0; --acu-success-text: #0288d1; --acu-success-bg: rgba(2, 136, 209, 0.15); --acu-scrollbar-track: #e3f2fd; --acu-scrollbar-thumb: #90caf9; --acu-hl-manual: #ff4757; --acu-hl-manual-bg: rgba(255, 71, 87, 0.15); --acu-hl-diff: #0277bd; --acu-hl-diff-bg: rgba(2, 119, 189, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-failure-text: #d32f2f; --acu-failure-bg: rgba(211, 47, 47, 0.15); --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-crit-success-text: #7b1fa2; --acu-crit-success-bg: rgba(123, 31, 162, 0.15); --acu-crit-failure-text: #b71c1c; --acu-crit-failure-bg: rgba(183, 28, 28, 0.15); --acu-extreme-success-text: #0277bd; --acu-extreme-success-bg: rgba(2, 119, 189, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #1565c0; --acu-gray-bg: rgba(128,128,128,0.1); }\n    .acu-theme-cyber { --acu-bg-nav: #000000; --acu-bg-panel: #0a0a0a; --acu-border: #333; --acu-text-main: #00ffcc; --acu-text-sub: #ff00ff; --acu-btn-bg: #111; --acu-btn-hover: #222; --acu-btn-active-bg: #ff00ff; --acu-btn-active-text: #fff; --acu-accent: #00ffcc; --acu-table-head: #050505; --acu-table-hover: #111; --acu-shadow: 0 0 15px rgba(0,255,204,0.15); --acu-card-bg: #050505; --acu-badge-bg: #1a1a1a; --acu-menu-bg: #111; --acu-menu-text: #00ffcc; --acu-success-text: #0f0; --acu-success-bg: rgba(0, 255, 0, 0.15); --acu-scrollbar-track: #000; --acu-scrollbar-thumb: #333; --acu-hl-manual: #ff9f43; --acu-hl-manual-bg: rgba(255, 159, 67, 0.2); --acu-hl-diff: #0abde3; --acu-hl-diff-bg: rgba(10, 189, 227, 0.2); }\n    .acu-theme-cyber .acu-nav-btn { border-color: #222; }\n    .acu-theme-cyber .acu-data-card { border-color: #222; }\n    .acu-theme-cyber .acu-dice-panel input::placeholder,\n    .acu-theme-cyber .acu-contest-panel input::placeholder {\n        color: #ff00ff !important;\n        opacity: 0.7;\n    }\n    .acu-theme-cyber .acu-dice-panel input[type="text"],\n    .acu-theme-cyber .acu-dice-panel input[type="number"],\n    .acu-theme-cyber .acu-dice-panel input:not([type]),\n    .acu-theme-cyber .acu-contest-panel input[type="text"],\n    .acu-theme-cyber .acu-contest-panel input[type="number"],\n    .acu-theme-cyber .acu-contest-panel input:not([type]) {\n        color: #ff00ff !important;\n    }\n    .acu-theme-nightowl { --acu-bg-nav: #0a2133; --acu-bg-panel: #011627; --acu-border: #132e45; --acu-text-main: #e0e6f2; --acu-text-sub: #a6b8cc; --acu-btn-bg: #1f3a52; --acu-btn-hover: #2a4a68; --acu-btn-active-bg: #7fdbca; --acu-btn-active-text: #011627; --acu-accent: #7fdbca; --acu-table-head: #0a2133; --acu-table-hover: #01294a; --acu-shadow: rgba(0,0,0,0.5); --acu-card-bg: #0a2133; --acu-badge-bg: #1f3a52; --acu-menu-bg: #011627; --acu-menu-text: #e0e6f2; --acu-success-text: #addb67; --acu-success-bg: rgba(173, 219, 103, 0.15); --acu-scrollbar-track: #011627; --acu-scrollbar-thumb: #1f3a52; --acu-hl-manual: #ff8f66; --acu-hl-manual-bg: rgba(255, 143, 102, 0.2); --acu-hl-diff: #82aaff; --acu-hl-diff-bg: rgba(130, 170, 255, 0.2); }\n    .acu-theme-sakura { --acu-bg-nav: #F9F0EF; --acu-bg-panel: #F9F0EF; --acu-border: #EBDCD9; --acu-text-main: #6B5552; --acu-text-sub: #C08D8D; --acu-btn-bg: #EBDCD9; --acu-btn-hover: #D8C7C4; --acu-btn-active-bg: #C08D8D; --acu-btn-active-text: #F9F0EF; --acu-accent: #C08D8D; --acu-table-head: #F9F0EF; --acu-table-hover: #F5EAE8; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #F9F0EF; --acu-menu-bg: #fff; --acu-menu-text: #6B5552; --acu-success-text: #6B5552; --acu-success-bg: rgba(192, 141, 141, 0.12); --acu-scrollbar-track: #F9F0EF; --acu-scrollbar-thumb: #EBDCD9; --acu-hl-manual: #A68A7A; --acu-hl-manual-bg: rgba(166, 138, 122, 0.12); --acu-hl-diff: #9B7A7A; --acu-hl-diff-bg: rgba(155, 122, 122, 0.2); --acu-error-text: #9B7A7A; --acu-error-bg: rgba(155, 122, 122, 0.12); --acu-error-border: rgba(155, 122, 122, 0.4); --acu-warning-icon: #A68A7A; --acu-failure-text: #9B7A7A; --acu-failure-bg: rgba(155, 122, 122, 0.12); --acu-warning-text: #A68A7A; --acu-warning-bg: rgba(166, 138, 122, 0.12); --acu-crit-success-text: #8B7A7A; --acu-crit-success-bg: rgba(139, 122, 122, 0.12); --acu-crit-failure-text: #8B6F6F; --acu-crit-failure-bg: rgba(139, 111, 111, 0.12); --acu-extreme-success-text: #9B8A8A; --acu-extreme-success-bg: rgba(155, 138, 138, 0.12); --acu-overlay-bg: rgba(107, 85, 82, 0.6); --acu-overlay-bg-light: rgba(107, 85, 82, 0.5); --acu-shadow-bg: rgba(107, 85, 82, 0.3); --acu-light-bg: rgba(192, 141, 141, 0.08); --acu-very-light-bg: rgba(192, 141, 141, 0.02); --acu-button-text: #6B5552; --acu-gray-bg: rgba(192, 141, 141, 0.08); }\n    .acu-theme-minepink { --acu-bg-nav: #1a1a1a; --acu-bg-panel: #1a1a1a; --acu-border: #333333; --acu-text-main: #ffb3d9; --acu-text-sub: #ff80c1; --acu-btn-bg: #2a2a2a; --acu-btn-hover: #3a3a3a; --acu-btn-active-bg: #ff80c1; --acu-btn-active-text: #1a1a1a; --acu-accent: #ff80c1; --acu-table-head: #252525; --acu-table-hover: #2a2a2a; --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #222222; --acu-badge-bg: #2a2a2a; --acu-menu-bg: #1a1a1a; --acu-menu-text: #ffb3d9; --acu-success-text: #ff80c1; --acu-success-bg: rgba(255, 128, 193, 0.2); --acu-scrollbar-track: #1a1a1a; --acu-scrollbar-thumb: #333333; --acu-hl-manual: #ffa726; --acu-hl-manual-bg: rgba(255, 167, 38, 0.2); --acu-hl-diff: #ff80c1; --acu-hl-diff-bg: rgba(255, 128, 193, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-failure-text: #ff6b6b; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-crit-success-text: #ff80c1; --acu-crit-success-bg: rgba(255, 128, 193, 0.2); --acu-crit-failure-text: #ff4444; --acu-crit-failure-bg: rgba(255, 68, 68, 0.2); --acu-extreme-success-text: #ffb3d9; --acu-extreme-success-bg: rgba(255, 179, 217, 0.2); --acu-overlay-bg: rgba(0,0,0,0.8); --acu-overlay-bg-light: rgba(0,0,0,0.7); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255, 128, 193, 0.1); --acu-very-light-bg: rgba(255, 128, 193, 0.02); --acu-button-text: #1a1a1a; --acu-gray-bg: rgba(255, 128, 193, 0.1); }\n    .acu-theme-purple { --acu-bg-nav: #f3e5f5; --acu-bg-panel: #f3e5f5; --acu-border: #ce93d8; --acu-text-main: #6a1b9a; --acu-text-sub: #9c27b0; --acu-btn-bg: #e1bee7; --acu-btn-hover: #ce93d8; --acu-btn-active-bg: #9c27b0; --acu-btn-active-text: #fff; --acu-accent: #9c27b0; --acu-table-head: #f8e1f5; --acu-table-hover: #fce4ec; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #f8e1f5; --acu-menu-bg: #fff; --acu-menu-text: #6a1b9a; --acu-success-text: #6a1b9a; --acu-success-bg: rgba(106, 27, 154, 0.15); --acu-scrollbar-track: #f3e5f5; --acu-scrollbar-thumb: #ce93d8; --acu-hl-manual: #f57c00; --acu-hl-manual-bg: rgba(245, 124, 0, 0.15); --acu-hl-diff: #6a1b9a; --acu-hl-diff-bg: rgba(106, 27, 154, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-failure-text: #d32f2f; --acu-failure-bg: rgba(211, 47, 47, 0.15); --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-crit-success-text: #7b1fa2; --acu-crit-success-bg: rgba(123, 31, 162, 0.15); --acu-crit-failure-text: #b71c1c; --acu-crit-failure-bg: rgba(183, 28, 28, 0.15); --acu-extreme-success-text: #6a1b9a; --acu-extreme-success-bg: rgba(106, 27, 154, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(156, 39, 176, 0.1); --acu-very-light-bg: rgba(156, 39, 176, 0.02); --acu-button-text: #6a1b9a; --acu-gray-bg: rgba(156, 39, 176, 0.1); }\n    .acu-theme-wechat { --acu-bg-nav: #F7F7F7; --acu-bg-panel: #F7F7F7; --acu-border: #E5E5E5; --acu-text-main: #333333; --acu-text-sub: #666666; --acu-btn-bg: #E5E5E5; --acu-btn-hover: #D5D5D5; --acu-btn-active-bg: #09B83E; --acu-btn-active-text: #FFFFFF; --acu-accent: #09B83E; --acu-table-head: #F0F0F0; --acu-table-hover: #EBEBEB; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #F0F0F0; --acu-menu-bg: #fff; --acu-menu-text: #333333; --acu-success-text: #09B83E; --acu-success-bg: rgba(9, 184, 62, 0.12); --acu-scrollbar-track: #F7F7F7; --acu-scrollbar-thumb: #E5E5E5; --acu-hl-manual: #FF9500; --acu-hl-manual-bg: rgba(255, 149, 0, 0.12); --acu-hl-diff: #09B83E; --acu-hl-diff-bg: rgba(9, 184, 62, 0.2); --acu-error-text: #E53E3E; --acu-error-bg: rgba(229, 62, 62, 0.12); --acu-error-border: rgba(229, 62, 62, 0.5); --acu-warning-icon: #FF9500; --acu-failure-text: #E53E3E; --acu-failure-bg: rgba(229, 62, 62, 0.12); --acu-warning-text: #FF9500; --acu-warning-bg: rgba(255, 149, 0, 0.12); --acu-crit-success-text: #07A832; --acu-crit-success-bg: rgba(7, 168, 50, 0.15); --acu-crit-failure-text: #C53030; --acu-crit-failure-bg: rgba(197, 48, 48, 0.15); --acu-extreme-success-text: #09B83E; --acu-extreme-success-bg: rgba(9, 184, 62, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.2); --acu-light-bg: rgba(9, 184, 62, 0.08); --acu-very-light-bg: rgba(9, 184, 62, 0.02); --acu-button-text: #333333; --acu-gray-bg: rgba(9, 184, 62, 0.08); }\n    .acu-theme-educational { --acu-bg-nav: #000000; --acu-bg-panel: #000000; --acu-border: #1B1B1B; --acu-text-main: #FFFFFF; --acu-text-sub: #CCCCCC; --acu-btn-bg: #1B1B1B; --acu-btn-hover: #2B2B2B; --acu-btn-active-bg: #FF9900; --acu-btn-active-text: #000000; --acu-accent: #FF9900; --acu-table-head: #1B1B1B; --acu-table-hover: #2B2B2B; --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #1B1B1B; --acu-badge-bg: #1B1B1B; --acu-menu-bg: #000000; --acu-menu-text: #FFFFFF; --acu-success-text: #FF9900; --acu-success-bg: rgba(255, 153, 0, 0.15); --acu-scrollbar-track: #000000; --acu-scrollbar-thumb: #1B1B1B; --acu-input-bg: #1B1B1B; --acu-hl-manual: #FF9900; --acu-hl-manual-bg: rgba(255, 153, 0, 0.15); --acu-hl-diff: #FFB84D; --acu-hl-diff-bg: rgba(255, 184, 77, 0.2); --acu-error-text: #FF6B6B; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #FFAA00; --acu-failure-text: #FF6B6B; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #FFAA00; --acu-warning-bg: rgba(255, 170, 0, 0.2); --acu-crit-success-text: #FF9900; --acu-crit-success-bg: rgba(255, 153, 0, 0.2); --acu-crit-failure-text: #FF4444; --acu-crit-failure-bg: rgba(255, 68, 68, 0.2); --acu-extreme-success-text: #FFB84D; --acu-extreme-success-bg: rgba(255, 184, 77, 0.2); --acu-overlay-bg: rgba(0,0,0,0.8); --acu-overlay-bg-light: rgba(0,0,0,0.7); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255, 153, 0, 0.1); --acu-very-light-bg: rgba(255, 153, 0, 0.02); --acu-button-text: #FFFFFF; --acu-gray-bg: rgba(255, 255, 255, 0.1); }\n    .acu-theme-vaporwave { --acu-bg-nav: #191970; --acu-bg-panel: #191970; --acu-border: rgba(0, 255, 255, 0.3); --acu-text-main: #00FFFF; --acu-text-sub: #FF00FF; --acu-btn-bg: rgba(25, 25, 112, 0.8); --acu-btn-hover: rgba(0, 255, 255, 0.2); --acu-btn-active-bg: #FF00FF; --acu-btn-active-text: #F0F8FF; --acu-accent: #00FFFF; --acu-table-head: rgba(25, 25, 112, 0.9); --acu-table-hover: rgba(0, 255, 255, 0.1); --acu-shadow: 0 0 15px rgba(0, 255, 255, 0.3); --acu-card-bg: rgba(25, 25, 112, 0.95); --acu-badge-bg: rgba(25, 25, 112, 0.8); --acu-menu-bg: #191970; --acu-menu-text: #00FFFF; --acu-success-text: #00FFFF; --acu-success-bg: rgba(0, 255, 255, 0.15); --acu-scrollbar-track: #191970; --acu-scrollbar-thumb: rgba(0, 255, 255, 0.3); --acu-input-bg: rgba(25, 25, 112, 0.6); --acu-hl-manual: #00FFFF; --acu-hl-manual-bg: rgba(0, 255, 255, 0.2); --acu-hl-diff: #FF00FF; --acu-hl-diff-bg: rgba(255, 0, 255, 0.2); --acu-error-text: #FF00FF; --acu-error-bg: rgba(255, 0, 255, 0.2); --acu-error-border: rgba(255, 0, 255, 0.5); --acu-warning-icon: #FF00FF; --acu-failure-text: #FF00FF; --acu-failure-bg: rgba(255, 0, 255, 0.2); --acu-warning-text: #FF00FF; --acu-warning-bg: rgba(255, 0, 255, 0.15); --acu-crit-success-text: #00FFFF; --acu-crit-success-bg: rgba(0, 255, 255, 0.2); --acu-crit-failure-text: #FF00FF; --acu-crit-failure-bg: rgba(255, 0, 255, 0.25); --acu-extreme-success-text: #00FFFF; --acu-extreme-success-bg: rgba(0, 255, 255, 0.2); --acu-overlay-bg: rgba(25, 25, 112, 0.85); --acu-overlay-bg-light: rgba(25, 25, 112, 0.75); --acu-shadow-bg: rgba(0, 255, 255, 0.3); --acu-light-bg: rgba(0, 255, 255, 0.05); --acu-very-light-bg: rgba(0, 255, 255, 0.02); --acu-button-text: #F0F8FF; --acu-gray-bg: rgba(0, 255, 255, 0.1); }\n    .acu-theme-vaporwave .acu-nav-btn { border-color: rgba(0, 255, 255, 0.3); }\n    .acu-theme-vaporwave .acu-data-card { border-color: rgba(0, 255, 255, 0.3); }\n    .acu-theme-vaporwave .acu-dice-panel input::placeholder,\n    .acu-theme-vaporwave .acu-contest-panel input::placeholder {\n        color: #FF00FF !important;\n        opacity: 0.7;\n    }\n    .acu-theme-vaporwave .acu-dice-panel input[type="text"],\n    .acu-theme-vaporwave .acu-dice-panel input[type="number"],\n    .acu-theme-vaporwave .acu-dice-panel input:not([type]),\n    .acu-theme-vaporwave .acu-contest-panel input[type="text"],\n    .acu-theme-vaporwave .acu-contest-panel input[type="number"],\n    .acu-theme-vaporwave .acu-contest-panel input:not([type]) {\n        color: #00FFFF !important;\n    }\n    .acu-theme-classicpackaging { --acu-bg-nav: #000000; --acu-bg-panel: #000000; --acu-border: #FFFF00; --acu-text-main: #FFFF00; --acu-text-sub: #CCCC00; --acu-btn-bg: #FF0000; --acu-btn-hover: #CC0000; --acu-btn-active-bg: #0000FF; --acu-btn-active-text: #FFFF00; --acu-accent: #FF0000; --acu-table-head: #1a1a1a; --acu-table-hover: #2a2a2a; --acu-shadow: rgba(255,255,0,0.3); --acu-card-bg: #1a1a1a; --acu-badge-bg: #FF0000; --acu-menu-bg: #000000; --acu-menu-text: #FFFF00; --acu-success-text: #0000FF; --acu-success-bg: rgba(0, 0, 255, 0.2); --acu-scrollbar-track: #000000; --acu-scrollbar-thumb: #FFFF00; --acu-input-bg: #1a1a1a; --acu-hl-manual: #FF0000; --acu-hl-manual-bg: rgba(255, 0, 0, 0.2); --acu-hl-diff: #0000FF; --acu-hl-diff-bg: rgba(0, 0, 255, 0.2); --acu-error-text: #FF0000; --acu-error-bg: rgba(255, 0, 0, 0.2); --acu-error-border: rgba(255, 0, 0, 0.8); --acu-warning-icon: #FF0000; --acu-failure-text: #FF0000; --acu-failure-bg: rgba(255, 0, 0, 0.2); --acu-warning-text: #FF0000; --acu-warning-bg: rgba(255, 0, 0, 0.15); --acu-crit-success-text: #0000FF; --acu-crit-success-bg: rgba(0, 0, 255, 0.2); --acu-crit-failure-text: #FF0000; --acu-crit-failure-bg: rgba(255, 0, 0, 0.25); --acu-extreme-success-text: #0000FF; --acu-extreme-success-bg: rgba(0, 0, 255, 0.2); --acu-overlay-bg: rgba(0,0,0,0.9); --acu-overlay-bg-light: rgba(0,0,0,0.8); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255,255,0,0.1); --acu-very-light-bg: rgba(255,255,0,0.02); --acu-button-text: #FFFF00; --acu-gray-bg: rgba(255,255,0,0.1); }\n    .acu-theme-classicpackaging .acu-nav-btn { border-color: #FFFF00; border-width: 2px; font-weight: bold; }\n    .acu-theme-classicpackaging .acu-data-card { border-color: #FFFF00; border-width: 2px; }\n    .acu-theme-classicpackaging .acu-dice-panel input::placeholder,\n    .acu-theme-classicpackaging .acu-contest-panel input::placeholder {\n        color: #666600 !important;\n        opacity: 0.7;\n    }\n    .acu-theme-classicpackaging .acu-dice-panel input[type="text"],\n    .acu-theme-classicpackaging .acu-dice-panel input[type="number"],\n    .acu-theme-classicpackaging .acu-dice-panel input:not([type]),\n    .acu-theme-classicpackaging .acu-contest-panel input[type="text"],\n    .acu-theme-classicpackaging .acu-contest-panel input[type="number"],\n    .acu-theme-classicpackaging .acu-contest-panel input:not([type]) {\n        color: #FFFF00 !important;\n        font-weight: bold;\n    }\n    .acu-theme-galgame { --acu-bg-nav: #FFF0F5; --acu-bg-panel: #FFF0F5; --acu-border: #F0D4E4; --acu-text-main: #6B4A5A; --acu-text-sub: #B08A9A; --acu-btn-bg: #FFE4E9; --acu-btn-hover: #FFD4E4; --acu-btn-active-bg: #E8B4D9; --acu-btn-active-text: #6B4A5A; --acu-accent: #E8B4D9; --acu-table-head: #FFF5F9; --acu-table-hover: #FFF0F8; --acu-shadow: rgba(232, 180, 217, 0.25); --acu-card-bg: #ffffff; --acu-badge-bg: #FFF5F9; --acu-menu-bg: #fff; --acu-menu-text: #6B4A5A; --acu-success-text: #D4A5C8; --acu-success-bg: rgba(212, 165, 200, 0.15); --acu-scrollbar-track: #FFF0F5; --acu-scrollbar-thumb: #F0D4E4; --acu-input-bg: #FFF8FA; --acu-hl-manual: #D4A5A5; --acu-hl-manual-bg: rgba(212, 165, 165, 0.15); --acu-hl-diff: #E8B4D9; --acu-hl-diff-bg: rgba(232, 180, 217, 0.2); --acu-error-text: #C88A9A; --acu-error-bg: rgba(200, 138, 154, 0.15); --acu-error-border: rgba(200, 138, 154, 0.4); --acu-warning-icon: #D4A5A5; --acu-failure-text: #C88A9A; --acu-failure-bg: rgba(200, 138, 154, 0.15); --acu-warning-text: #D4A5A5; --acu-warning-bg: rgba(212, 165, 165, 0.15); --acu-crit-success-text: #E8B4D9; --acu-crit-success-bg: rgba(232, 180, 217, 0.2); --acu-crit-failure-text: #C88A9A; --acu-crit-failure-bg: rgba(200, 138, 154, 0.2); --acu-extreme-success-text: #D4A5C8; --acu-extreme-success-bg: rgba(212, 165, 200, 0.2); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(232, 180, 217, 0.25); --acu-light-bg: rgba(232, 180, 217, 0.08); --acu-very-light-bg: rgba(232, 180, 217, 0.02); --acu-button-text: #6B4A5A; --acu-button-text-on-accent: #6B4A5A; --acu-gray-bg: rgba(232, 180, 217, 0.1); }\n    .acu-theme-galgame .acu-nav-btn { border-radius: 8px; transition: all 0.3s ease; }\n    .acu-theme-galgame .acu-data-card { border-radius: 12px; box-shadow: 0 4px 12px rgba(232, 180, 217, 0.15); transition: all 0.3s ease; }\n    .acu-theme-galgame .acu-data-card:hover { box-shadow: 0 6px 20px rgba(232, 180, 217, 0.25); transform: translateY(-2px); }\n    .acu-theme-galgame .acu-nav-btn:hover { box-shadow: 0 2px 8px rgba(232, 180, 217, 0.2); }\n    .acu-theme-terminal { --acu-bg-nav: #0c0c0c; --acu-bg-panel: #0c0c0c; --acu-border: #00ff00; --acu-text-main: #00ff00; --acu-text-sub: #00cc00; --acu-btn-bg: #1a1a1a; --acu-btn-hover: #2a2a2a; --acu-btn-active-bg: #00ff00; --acu-btn-active-text: #0c0c0c; --acu-accent: #00ff00; --acu-table-head: #0a0a0a; --acu-table-hover: #1a1a1a; --acu-shadow: rgba(0,255,0,0.2); --acu-card-bg: #0c0c0c; --acu-badge-bg: #1a1a1a; --acu-menu-bg: #0c0c0c; --acu-menu-text: #00ff00; --acu-success-text: #00ff00; --acu-success-bg: rgba(0, 255, 0, 0.15); --acu-scrollbar-track: #0c0c0c; --acu-scrollbar-thumb: #00ff00; --acu-input-bg: #0c0c0c; --acu-hl-manual: #ffff00; --acu-hl-manual-bg: rgba(255, 255, 0, 0.15); --acu-hl-diff: #00ffff; --acu-hl-diff-bg: rgba(0, 255, 255, 0.15); --acu-error-text: #ff0000; --acu-error-bg: rgba(255, 0, 0, 0.15); --acu-error-border: rgba(255, 0, 0, 0.5); --acu-warning-icon: #ffff00; --acu-failure-text: #ff0000; --acu-failure-bg: rgba(255, 0, 0, 0.15); --acu-warning-text: #ffff00; --acu-warning-bg: rgba(255, 255, 0, 0.15); --acu-crit-success-text: #00ffff; --acu-crit-success-bg: rgba(0, 255, 255, 0.15); --acu-crit-failure-text: #ff00ff; --acu-crit-failure-bg: rgba(255, 0, 255, 0.15); --acu-extreme-success-text: #00ff00; --acu-extreme-success-bg: rgba(0, 255, 0, 0.2); --acu-overlay-bg: rgba(0,0,0,0.9); --acu-overlay-bg-light: rgba(0,0,0,0.8); --acu-shadow-bg: rgba(0,0,0,0.7); --acu-light-bg: rgba(0,255,0,0.05); --acu-very-light-bg: rgba(0,255,0,0.02); --acu-button-text: #0c0c0c; --acu-gray-bg: rgba(0,255,0,0.05); font-family: 'Courier New', 'Consolas', 'Monaco', monospace; }\n    .acu-theme-terminal .acu-nav-btn { border-color: #00ff00; text-shadow: 0 0 5px rgba(0,255,0,0.5); }\n    .acu-theme-terminal .acu-data-card { border-color: #00ff00; text-shadow: 0 0 2px rgba(0,255,0,0.3); }\n    .acu-theme-terminal .acu-dice-panel input::placeholder,\n    .acu-theme-terminal .acu-contest-panel input::placeholder {\n        color: #008800 !important;\n        opacity: 0.7;\n    }\n    .acu-theme-terminal .acu-dice-panel input[type="text"],\n    .acu-theme-terminal .acu-dice-panel input[type="number"],\n    .acu-theme-terminal .acu-dice-panel input:not([type]),\n    .acu-theme-terminal .acu-contest-panel input[type="text"],\n    .acu-theme-terminal .acu-contest-panel input[type="number"],\n    .acu-theme-terminal .acu-contest-panel input:not([type]) {\n        color: #00ff00 !important;\n    }\n    /* Night Owlä¸»é¢˜ï¼šæ•°æ®éªŒè¯å’Œè¡¨æ ¼ç®¡ç†æ¡†æ¡†ä½¿ç”¨æ›´æš—çš„è¾¹æ¡† */\n    .acu-theme-nightowl .acu-table-manager-item,\n    .acu-theme-nightowl .acu-validation-rule-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-table-manager-item:hover,\n    .acu-theme-nightowl .acu-validation-rule-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    /* Night Owlä¸»é¢˜ï¼šé¢„è®¾å¡ç‰‡æ¡†æ¡†ä½¿ç”¨æ›´æš—çš„è¾¹æ¡† */\n    .acu-theme-nightowl .acu-preset-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-preset-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    .acu-wrapper { position: relative; width: 100%; margin: 15px 0; z-index: 2147483640 !important; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column-reverse; }\n    .acu-wrapper.acu-mode-embedded { position: relative !important; width: 100% !important; margin-top: 8px !important; z-index: 2147483641 !important; clear: both; display: flex; flex-direction: column-reverse !important; padding: 0; }\n    .acu-wrapper.acu-mode-embedded .acu-nav-container { position: relative !important; z-index: 2147483642 !important; }\n    .acu-wrapper.acu-mode-embedded .acu-data-display { position: absolute !important; bottom: 100% !important; left: 0 !important; right: 0 !important; width: 100% !important; box-shadow: 0 -10px 30px rgba(0,0,0,0.25) !important; border: 1px solid var(--acu-border); margin-bottom: 5px; z-index: 2147483647 !important; max-height: 70vh !important; overflow-y: auto !important; }\n    .acu-nav-container { display: grid; grid-template-columns: repeat(var(--acu-grid-cols, 3), 1fr); gap: 4px; padding: 6px; background: var(--acu-bg-nav); border: 1px solid var(--acu-border); border-radius: 10px; align-items: center; box-shadow: 0 2px 6px var(--acu-shadow); position: relative; z-index: 2147483641 !important; }\n    .acu-nav-btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 3px; padding: 4px 2px; border: 1px solid transparent; border-radius: 6px; background: var(--acu-btn-bg); color: var(--acu-text-main); font-weight: 600; font-size: 11px; cursor: pointer; transition: all 0.2s ease; user-select: none; overflow: hidden; height: 28px; }\n    .acu-nav-btn span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-top: 1px; }\n    .acu-nav-btn:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n    .acu-nav-btn:focus, .acu-nav-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n    /* [æ–°å¢] ç§»æ¤åŠŸèƒ½æ ·å¼ */\n/* --- 1. å¤–å±‚å®¹å™¨ï¼šé˜²æ­¢è¯¯è§¦è¾¹ç¼˜ --- */\n.acu-height-control {\n    display: flex;\n    align-items: center;\n    margin-right: 8px;\n    cursor: ns-resize;\n    padding: 4px;\n    border-radius: 4px;\n    color: var(--acu-text-sub);\n    transition: all 0.2s;\n    /* å…³é”®å±æ€§ï¼šç¦æ­¢åœ¨æ­¤åŒºåŸŸè§¦å‘æµè§ˆå™¨é»˜è®¤æ‰‹åŠ¿ */\n    touch-action: none;\n}\n\n/* äº¤äº’åé¦ˆ */\n.acu-height-control:hover, .acu-height-control.active {\n    color: var(--acu-accent);\n    background: var(--acu-table-hover);\n}\n\n/* --- 2. [åŠ ä¿é™©] å†…éƒ¨å›¾æ ‡ï¼šè¿™æ˜¯äº‹ä»¶ç»‘å®šçš„ä¸»ä½“ï¼Œå¿…é¡»ç¦æ­¢è§¦æ‘¸ --- */\n.acu-height-drag-handle {\n    cursor: ns-resize;\n    /* åŒé‡ä¿é™©ï¼šç¡®ä¿ç›´æ¥æŒ‰åœ¨å›¾æ ‡ä¸Šä¹Ÿä¸ä¼šè§¦å‘æ»šåŠ¨ */\n    touch-action: none;\n}\n\n            /* è§†å›¾åˆ‡æ¢æ ·å¼ */\n            .acu-view-btn { background: transparent !important; border: none; color: var(--acu-text-main) !important; cursor: pointer; padding: 4px; margin-right: 5px; font-size: 14px; opacity: 0.7; }\n            .acu-view-btn:hover { opacity: 1; color: var(--acu-accent) !important; background: var(--acu-table-hover) !important; border-radius: 4px; }\n            .acu-view-btn.acu-reverse-btn.active, .acu-reverse-btn[data-reversed="true"] { color: var(--acu-accent) !important; opacity: 1; }\n            /* Grid è§†å›¾ (åŒåˆ—) */\n            .acu-card-body.view-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }\n            /* ä¿®å¤ç‰ˆï¼šå¼ºåˆ¶ Grid æ¨¡å¼ä½¿ç”¨ Flex å¸ƒå±€å¹¶å…è®¸é«˜åº¦è‡ªé€‚åº” */\n.acu-card-body.view-grid .acu-card-row { display: flex; height: auto !important; min-height: fit-content; border: 1px solid var(--acu-border); border-radius: 6px; padding: 4px 6px; flex-direction: column !important; align-items: flex-start !important; background: rgba(0,0,0,0.02); box-sizing: border-box; }\n            .acu-card-body.view-grid .acu-card-row.acu-grid-span-full { grid-column: 1 / -1; }\n            .acu-card-body.view-grid .acu-card-label { width: 100% !important; font-size: 0.85em; opacity: 0.8; margin-bottom: 2px; }\n            .acu-card-body.view-grid .acu-card-value { width: 100% !important; }\n\n            /* List è§†å›¾ (å•åˆ— - åŸç‰ˆå¢å¼º) */\n            .acu-nav-btn.active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); outline: none; border-color: transparent; }\n            .acu-nav-btn.active:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); transform: none; }\n            .acu-nav-btn.active:focus, .acu-nav-btn.active:focus-visible { outline: none; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2) !important; }\n            .acu-nav-btn.has-validation-errors { border-color: rgba(231, 76, 60, 0.5); }\n            .acu-nav-btn .acu-nav-warning-icon { color: var(--acu-error-text, #e74c3c); font-size: 10px; margin-left: 2px; animation: pulse 1.5s infinite; }\n            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }\n            .acu-action-btn { flex: 1; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--acu-btn-bg); border-radius: 8px; color: var(--acu-text-sub); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; margin: 0; }\n            .acu-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }\n            .acu-action-btn:focus, .acu-action-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n            #acu-btn-save-global { color: var(--acu-btn-active-bg); } #acu-btn-save-global:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); }\n\n            .acu-data-display { position: absolute; bottom: calc(100% + 10px); left: 0; right: 0; max-height: 80vh; height: auto; background: var(--acu-bg-panel); border: 1px solid var(--acu-border); border-radius: 8px; box-shadow: 0 8px 30px var(--acu-shadow); display: flex; flex-direction: column; z-index: 2147483642 !important; opacity: 0; visibility: hidden; transition: opacity 0.2s ease-out, visibility 0s linear 0.2s; pointer-events: none; }\n            .acu-data-display.visible { opacity: 1; visibility: visible; transition: opacity 0.2s ease-in, visibility 0s linear 0s; pointer-events: auto; }\n            @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }\n            @keyframes highlightFlash { 0%, 100% { box-shadow: none; } 50% { box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.6); } }\n            .acu-highlight-flash { animation: highlightFlash 0.5s ease-in-out 3; }\n\n            .acu-panel-header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); border-radius: 8px 8px 0 0; }\n            /* æ ¸å¿ƒä¿®æ”¹ï¼šå¢åŠ äº† flex: 1 å’Œ min-width: 0ï¼Œå¼ºåˆ¶æ ‡é¢˜åœ¨ç©ºé—´ä¸è¶³æ—¶è‡ªåŠ¨å˜çŸ­æ˜¾ç¤ºçœç•¥å· */\n/* --- æ–°çš„æ ‡é¢˜å¸ƒå±€ï¼šçºµå‘æ’åˆ— --- */\n.acu-panel-title {\n    display: flex;\n    flex-direction: column; /* å‚ç›´å †å  */\n    justify-content: center;\n    align-items: flex-start;\n    flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */\n    min-width: 0; /* å…è®¸å‹ç¼© */\n    margin-right: 8px;\n    overflow: hidden;\n}\n\n/* ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ä¸»ä½“ (åŠ ç²—ï¼Œç¨å¤§) */\n.acu-title-main {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    width: 100%;\n    font-size: 13px; /* ä½ è¦æ±‚çš„ï¼šå­—ä½“å˜å°ä¸€ç‚¹ï¼Œä½†ä¿æŒåŠ ç²— */\n    font-weight: bold;\n    color: var(--acu-text-main);\n    line-height: 1.2;\n}\n\n/* æ ‡é¢˜æ–‡å­—æœ¬èº« (æº¢å‡ºçœç•¥) */\n.acu-title-text {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n/* ç¬¬äºŒè¡Œï¼šé¡µç ä¿¡æ¯ (ç°è‰²ï¼Œæ›´å°) */\n.acu-title-sub {\n    font-size: 10px;\n    color: var(--acu-text-sub);\n    font-weight: normal;\n    opacity: 0.8;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    width: 100%;\n    line-height: 1.2;\n    margin-top: 1px;\n}\n            /* å¢åŠ äº† flex-shrink: 0; é˜²æ­¢è¢«æ ‡é¢˜æŒ¤å‹ */\n/* æ ¸å¿ƒä¿®æ”¹ï¼šflex-shrink: 0 ç¡®ä¿è¿™ä¸€å—åŒºåŸŸæ°¸è¿œä¸ä¼šè¢«å‹ç¼© */\n.acu-header-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }\n            .acu-search-wrapper { position: relative; display: flex; align-items: center; }\n            .acu-wrapper input.acu-search-input { background: var(--acu-btn-bg) !important; border: 1px solid var(--acu-border) !important; color: var(--acu-text-main) !important; padding: 4px 8px 4px 24px; border-radius: 12px; font-size: 12px; width: 120px; transition: width 0.2s, border-color 0.2s; }\n            .acu-wrapper input.acu-search-input::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            .acu-wrapper input.acu-search-input:focus { width: 160px; outline: none !important; border-color: var(--acu-accent) !important; box-shadow: none !important; }\n            .acu-search-input::placeholder { color: var(--acu-text-sub) ; opacity: 0.7; }\n            .acu-search-icon { position: absolute; left: 8px; font-size: 10px; color: var(--acu-text-sub); pointer-events: none; }\n            /* å¢åŠ äº† min-width å’Œ flex-shrink: 0 */\n            .acu-panel-content { flex: 1; overflow-x: auto; overflow-y: hidden; padding: 15px; background: transparent; scrollbar-width: thin; scrollbar-color: var(--acu-scrollbar-thumb) var(--acu-scrollbar-track); overscroll-behavior-x: contain; overscroll-behavior-y: auto; touch-action: pan-x pan-y; -webkit-overflow-scrolling: touch; }\n            /* å¢åŠ äº† height: 100%; è®©ç½‘æ ¼å®¹å™¨å¡«æ»¡é¢æ¿çš„é«˜åº¦ */\n.acu-card-grid { display: flex; flex-wrap: nowrap; gap: 12px; align-items: flex-start; }\n            .acu-layout-vertical .acu-panel-content { overflow-x: hidden !important; overflow-y: auto !important; overscroll-behavior: auto; touch-action: manipulation; min-height: 0; }\n            /* ç«–å‘å¸ƒå±€æ—¶æ¢å¤ auto é«˜åº¦ */\n.acu-layout-vertical .acu-card-grid { flex-wrap: wrap !important; justify-content: center; padding-bottom: 20px; height: auto; }\n.acu-wrapper:not(.acu-layout-vertical) .acu-manual-mode .acu-card-grid { height: 100%; } .acu-manual-mode .acu-data-card { max-height: 100% !important; overscroll-behavior-y: auto; } .acu-data-card { flex: 0 0 var(--acu-card-width, 260px); width: var(--acu-card-width, 260px); background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; height: auto; max-height: 60vh; overflow-y: auto; overscroll-behavior-y: auto; touch-action: manipulation; transition: all 0.2s ease; display: flex; flex-direction: column; position: relative; }\n            .acu-data-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--acu-shadow); border-color: var(--acu-accent); }\n            .acu-data-card.pending-deletion { opacity: 0.6; border: 1px dashed var(--acu-error-text, #e74c3c); }\n            .acu-data-card.pending-deletion::after { content: "å¾…åˆ é™¤"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--acu-error-text, #e74c3c); font-size: 24px; font-weight: bold; border: 2px solid var(--acu-error-text, #e74c3c); padding: 5px 10px; border-radius: 8px; opacity: 0.8; pointer-events: none; }\n            @keyframes pulse-highlight { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }\n            .acu-highlight-manual { color: var(--acu-hl-manual) !important; background-color: var(--acu-hl-manual-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-highlight-diff { color: var(--acu-hl-diff) !important; background-color: var(--acu-hl-diff-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-editable-title.acu-highlight-manual, .acu-editable-title.acu-highlight-diff { width: auto; display: inline-block; }\n            .acu-card-header { flex: 0 0 auto; padding: 8px 10px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); font-weight: bold; color: var(--acu-text-main); font-size: 14px; display: flex; flex-direction: row !important; align-items: center !important; justify-content: flex-start !important; gap: 8px; min-height: 40px; height: auto !important; position: relative; }\n            .acu-editable-title { flex: 1; width: auto !important; cursor: pointer; border-bottom: 1px dashed transparent; transition: all 0.2s; white-space: pre-wrap !important; overflow: visible !important; word-break: break-word !important; text-align: center; line-height: 1.3; margin: 0; }\n            .acu-editable-title:hover { border-bottom-color: var(--acu-accent); color: var(--acu-accent); }\n            .acu-card-index { position: static !important; transform: none !important; margin: 0; flex-shrink: 0; font-size: 11px; color: var(--acu-text-sub); font-weight: normal; background: var(--acu-badge-bg); padding: 2px 6px; border-radius: 4px; }\n            .acu-bookmark-icon { position: absolute; top: 8px; right: 8px; color: var(--acu-accent); cursor: pointer; font-size: 16px; opacity: 0.3; transition: opacity 0.2s, color 0.2s, transform 0.2s; z-index: 10; }\n            .acu-bookmark-icon:hover { opacity: 0.6; transform: scale(1.1); }\n            .acu-bookmark-icon.bookmarked { color: var(--acu-accent); opacity: 1; }\n            .acu-card-body { padding: 6px 12px; display: flex; flex-direction: column; gap: 0; font-size: var(--acu-font-size, 13px); flex: 1; }\n            .acu-card-row { display: block; padding: 6px 0; border-bottom: 1px dashed var(--acu-border); cursor: pointer; overflow: hidden; }\n            .acu-card-row:last-child { border-bottom: none; }\n            .acu-card-actions { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 10px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); }\n            .acu-action-item { padding: 4px 10px; font-size: 11px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.15s; white-space: nowrap; }\n            .acu-action-item:hover { background: var(--acu-btn-hover); border-color: var(--acu-accent); color: var(--acu-accent); transform: translateY(-1px); }\n            .acu-action-item:active { transform: translateY(0); }\n            .acu-action-item.check-type { border-style: dashed; }\n            .acu-action-item i { font-size: 10px; opacity: 0.7; }\n            .acu-card-row:hover { background: var(--acu-table-hover); }\n            .acu-card-label { float: left !important; clear: left; width: auto !important; margin-right: 8px !important; color: var(--acu-text-sub); font-size: 0.9em; line-height: 1.5; padding-top: 0; }\n            .acu-hide-label .acu-card-label { display: none; }\n            .acu-hide-label .acu-card-value { width: 100% !important; }\n            .acu-inline-dice-btn:hover { opacity: 1 !important; transform: scale(1.2); }\n            .acu-card-value { display: block; width: auto !important; margin: 0; text-align: left !important; word-break: break-all !important; white-space: pre-wrap !important; line-height: 1.5 !important; color: var(--acu-text-main); font-size: 1em; }\n            .acu-tag-container { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; margin-top: 2px; }\n            .acu-multi-attr-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 8px; }\n            .acu-badge { display: inline-block; padding: 1px 8px; border-radius: 12px; font-size: 0.9em; font-weight: 500; line-height: 1.2; }\n            .acu-badge-green { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-neutral { background: var(--acu-badge-bg); color: var(--acu-text-main); border: 1px solid var(--acu-border); }\n            .acu-panel-footer { flex: 0 0 auto; padding: 8px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); display: flex; justify-content: center; align-items: center; gap: 5px; flex-wrap: wrap; }\n            .acu-page-btn { padding: 4px 10px; min-width: 32px; height: 28px; border-radius: 4px; border: 1px solid var(--acu-border); background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }\n            .acu-page-btn:hover:not(.disabled):not(.active) { background: var(--acu-btn-hover); transform: translateY(-1px); }\n            .acu-page-btn.active { background: var(--acu-accent); color: var(--acu-button-text-on-accent, #fff); border-color: var(--acu-accent); font-weight: bold; }\n            .acu-page-btn.disabled { opacity: 0.5; cursor: not-allowed; }\n            .acu-page-info { font-size: 12px; color: var(--acu-text-sub); margin: 0 10px; }\n            /* --- [æ–°å¢] è¡ŒåŠ¨é€‰é¡¹é¢æ¿æ ·å¼ --- */\n            /* æ”¹ä¸º Flex Column å‚ç›´å¸ƒå±€ */\n            /* --- [ä¿®æ”¹] è¢–çå‹Â·å‚ç›´ç´§å‡‘å¸ƒå±€ --- */\n            .acu-option-panel {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;                 /* é—´è·æå°ï¼Œæ’åˆ—æ›´ç´§å¯† */\n                padding: 4px;             /* å®¹å™¨å†…è¾¹è·ç¼©å° */\n                background: var(--acu-bg-nav);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;       /* åœ†è§’ç¼©å° */\n                margin-top: 0;\n                margin-bottom: 4px;\n                backdrop-filter: blur(5px);\n                width: 100%;\n                box-sizing: border-box;\n                z-index: 2147483641;\n                animation: acuFadeIn 0.3s ease;\n            }\n\n            .acu-embedded-options-container {\n                width: 100%;\n                max-width: 100%;\n                margin-top: 6px;\n                clear: both;\n                animation: acuFadeIn 0.3s ease;\n            }\n\n            .acu-opt-header {\n                text-align: center;\n                font-size: 10px;          /* æ ‡é¢˜å­—ä½“æ›´å° */\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                padding-bottom: 2px;\n                border-bottom: 1px dashed var(--acu-border);\n                margin-bottom: 2px;\n            }\n\n            /* --- [ä¿®æ”¹] è¢–çæŒ‰é’®æ ·å¼ --- */\n            .acu-opt-btn {\n                background: var(--acu-btn-bg);\n                border: 1px solid transparent; /* é»˜è®¤æ— è¾¹æ¡†ï¼Œæ›´å¹²å‡€ */\n                padding: 3px 6px;              /* æçª„å†…è¾¹è· */\n                border-radius: 4px;\n                cursor: pointer;\n                color: var(--acu-text-main);\n                font-size: var(--acu-opt-font-size, 12px) !important; /* [ä¿®æ”¹] ä½¿ç”¨ç‹¬ç«‹å˜é‡ */\n                transition: all 0.15s;\n                font-weight: normal;           /* å»é™¤åŠ ç²— */\n                text-align: left;              /* å·¦å¯¹é½ */\n                white-space: pre-wrap;\n                word-break: break-word;\n                min-height: 22px;              /* å‹ä½é«˜åº¦ï¼Œè¶…è–„ */\n                line-height: 1.3;\n                display: flex;\n                align-items: center;\n                justify-content: flex-start;\n                opacity: 0.9;\n            }\n\n            .acu-opt-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent); /* æ‚¬åœæ—¶æ˜¾ç¤ºè¾¹æ¡† */\n                transform: translateX(3px);      /* æ‚¬åœæ—¶è½»å¾®å³ç§»åé¦ˆ */\n                opacity: 1;\n            }\n            .acu-opt-btn:active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); }\n            @keyframes acuFadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }\n\n            /* [æ–°å¢] éª°å­ç»“æœéšè—åŠ¨ç”»ï¼šæ¶ˆé™¤é—ªçƒ */\n            .acu-dice-result-revealing {\n                opacity: 0 !important;\n                transform: translateY(3px) !important;\n                transition: opacity 0.18s ease-out, transform 0.18s ease-out !important;\n            }\n            .acu-dice-result-revealed {\n                opacity: 1 !important;\n                transform: translateY(0) !important;\n            }\n            /* ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”»æ—¶é•¿ */\n            @media (max-width: 768px) {\n                .acu-dice-result-revealing {\n                    transition: opacity 0.15s ease-out, transform 0.15s ease-out !important;\n                }\n            }\n            /* å°Šé‡ç”¨æˆ·çš„å‡å¼±åŠ¨ç”»åå¥½è®¾ç½® */\n            @media (prefers-reduced-motion: reduce) {\n                .acu-dice-result-revealing {\n                    transition: none !important;\n                    opacity: 1 !important;\n                    transform: none !important;\n                }\n            }\n\n            .acu-menu-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: transparent; z-index: 2147483645 !important; }\n            /* 1. èœå•å®¹å™¨ï¼šèƒŒæ™¯è‰²ã€è¾¹æ¡†ã€é˜´å½±å…¨éƒ¨è·Ÿéšä¸»é¢˜å˜é‡ */\n.acu-cell-menu {\n    position: fixed !important;\n    background: var(--acu-menu-bg) !important;\n    border: 1px solid var(--acu-border);\n    box-shadow: 0 6px 20px var(--acu-shadow) !important;\n    z-index: 2147483647 !important;\n    border-radius: 8px;\n    overflow: hidden;\n    min-width: 150px;\n    color: var(--acu-menu-text);\n}\n\n/* 2. èœå•é¡¹ï¼šæ–‡å­—é¢œè‰²è·Ÿéšä¸»é¢˜ */\n.acu-cell-menu-item {\n    padding: 12px 16px;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    gap: 12px;\n    align-items: center;\n    color: var(--acu-menu-text);\n    font-weight: 500;\n    background: transparent;\n    transition: background 0.2s;\n}\n\n/* 3. æ‚¬åœæ•ˆæœï¼šä½¿ç”¨ä¸»é¢˜å®šä¹‰çš„é€šç”¨æ‚¬åœè‰² */\n.acu-cell-menu-item:hover {\n    background: var(--acu-table-hover);\n}\n\n/* 4. ç‰¹æ®ŠæŒ‰é’®ä¼˜åŒ– */\n            .acu-cell-menu-item#act-delete { color: var(--acu-error-text, #e74c3c); }\n            .acu-cell-menu-item#act-delete:hover { background: var(--acu-error-bg, rgba(231, 76, 60, 0.1)); } /* çº¢è‰²åŠé€æ˜èƒŒæ™¯ï¼Œä»»ä½•ä¸»é¢˜éƒ½é€‚é… */\n            .acu-cell-menu-item#act-close { border-top: 1px dashed var(--acu-border); color: var(--acu-text-sub); }\n            .acu-edit-overlay { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.75) !important; z-index: 2147483646 !important; display: flex; justify-content: center !important; align-items: center !important; backdrop-filter: blur(2px); }\n            .acu-edit-dialog { background: var(--acu-bg-panel); width: 95%; max-width: 500px; max-height: 95vh; padding: 16px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 15px 50px rgba(0,0,0,0.6); color: var(--acu-text-main); border: 1px solid var(--acu-border); overflow: hidden; flex-shrink: 0; }\n            @media (min-width: 768px) { .acu-edit-dialog { max-width: 900px; width: 90%; } .acu-edit-dialog.acu-settings-dialog { max-width: 400px; width: 400px; } }\n            .acu-edit-title { margin: 0; font-size: 16px; font-weight: bold; color: var(--acu-text-main); padding-bottom: 8px; border-bottom: 1px solid var(--acu-border); }\n            .acu-edit-content { background: var(--acu-bg-panel); }\n            .acu-edit-textarea { width: 100%; height: auto; padding: 12px; border: 1px solid var(--acu-border) !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; line-height: 1.6; overflow-y: auto !important; }\n            .acu-edit-textarea:focus { outline: none; border-color: var(--acu-accent) !important; }\n            .acu-edit-textarea::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            @media (min-width: 768px) { .acu-edit-textarea { height: auto !important; font-size: 15px !important; } }\n            .acu-edit-textarea:focus { outline: 1px solid #aaa; }\n            .acu-dialog-btns { display: flex; justify-content: flex-end; gap: 20px; margin-top: 10px; }\n            .acu-dialog-btn { background: none; border: none; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 6px; color: var(--acu-text-sub); transition: color 0.2s; }\n            .acu-dialog-btn:hover { color: var(--acu-text-main); } .acu-btn-confirm { color: var(--acu-success-text); } .acu-btn-confirm:hover { opacity: 0.8; }\n            /* --- [UI Optimization] PC-First Edit Mode Styles --- */\n            .acu-order-controls { grid-column: 1 / -1; order: -2; display: none; width: 100%; text-align: left; background: var(--acu-accent); color: var(--acu-button-text-on-accent, var(--acu-text-main)); padding: 6px 12px; margin: 0 0 8px 0; border-radius: 4px; font-weight: bold; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }\n            .acu-order-controls.visible { display: flex; align-items: center; justify-content: space-between; }\n\n            .acu-nav-container.editing-order { border: 2px solid var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-nav-container.editing-order .acu-nav-btn, .acu-nav-container.editing-order .acu-action-btn { opacity: 1 !important; cursor: grab !important; border: 1px solid var(--acu-border); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }\n            .acu-nav-container.editing-order .acu-nav-btn:hover, .acu-nav-container.editing-order .acu-action-btn:hover { border-color: var(--acu-accent); transform: translateY(-1px); }\n\n            .acu-swap-selected { background-color: var(--acu-accent) !important; color: var(--acu-button-text-on-accent, var(--acu-text-main)) !important; border-color: var(--acu-accent); box-shadow: 0 0 0 2px rgba(255,255,255,0.5), 0 4px 12px rgba(0,0,0,0.2); transform: scale(1.05); z-index: 10; }\n            .acu-drag-over { border: 2px dashed var(--acu-accent); opacity: 0.5; transform: scale(0.95); background: rgba(var(--acu-accent-rgb), 0.1); }\n\n            /* --- [PC Style] Unused Pool Optimization (å·¥å…·æ¶æ ·å¼) --- */\n            .acu-unused-pool {\n                grid-column: 1 / -1;\n                display: none;\n                flex-wrap: wrap;\n                gap: 8px;\n                background: var(--acu-table-head); /* ä½¿ç”¨è¡¨å¤´èƒŒæ™¯è‰²ï¼Œæ›´èåˆ */\n                border: 1px dashed var(--acu-border); /* è™šçº¿æ¡†è¡¨ç¤ºè¿™æ˜¯ç¼–è¾‘åŒºåŸŸ */\n                padding: 10px 15px;\n                margin: 0 0 10px 0;\n                border-radius: 8px;\n                justify-content: flex-start;\n                align-items: center;\n                min-height: 50px;\n                box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);\n            }\n            .acu-unused-pool.visible { display: flex; animation: acuFadeIn 0.2s ease-out; }\n\n            /* PCç«¯æ¸…æ™°çš„æ–‡å­—å¼•å¯¼ */\n            .acu-unused-pool::before {\n                content: "å¤‡é€‰åŠŸèƒ½æ±  (æ‹–æ‹½å›¾æ ‡åˆ°ä¸‹æ–¹å¯ç”¨ â†˜)";\n                display: flex;\n                align-items: center;\n                height: 32px;\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                margin-right: 15px;\n                padding-right: 15px;\n                border-right: 1px solid var(--acu-border);\n                white-space: nowrap;\n                opacity: 0.8;\n            }\n\n            .acu-actions-group { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 4px; border-top: 1px dashed var(--acu-border); padding-top: 8px; margin-top: 4px; min-height: 36px; transition: all 0.2s; }\n\n            /* [ä¿®å¤] ç§»åŠ¨ç«¯é¡¶éƒ¨å¸ƒå±€é€‚é…ï¼šå¼ºåˆ¶æå‡é¡ºåº */\n            .acu-pos-top .acu-actions-group { order: -1; border-top: none; border-bottom: 1px dashed var(--acu-border); margin-top: 0; margin-bottom: 6px; padding-top: 0; padding-bottom: 8px; }\n\n            /* [ä¿®å¤] ç¼–è¾‘æ¨¡å¼ä¸‹ï¼Œå¤‡é€‰æ± ä¹Ÿè·Ÿéšç½®é¡¶ */\n            .acu-pos-top .acu-unused-pool { order: -1; margin-bottom: 10px; border-bottom: 1px dashed var(--acu-border); }\n            .acu-actions-group.dragging-over { background: rgba(127, 127, 127, 0.05); box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }\n\n            /* ä»ªè¡¨ç›˜æ¨ªå‘æ»šåŠ¨æ¨¡å¼ */\n                .acu-dash-body.acu-dash-horizontal {\n                    display: flex;\n                    flex-wrap: nowrap;\n                    gap: 15px;\n                    overflow-x: auto;\n                    overflow-y: hidden;\n                    padding-bottom: 10px;\n                }\n                .acu-dash-body.acu-dash-horizontal > div {\n                    flex: 0 0 280px;\n                    min-width: 280px;\n                    max-height: 60vh;\n                    overflow-y: auto;\n                }\n                @media (min-width: 769px) {\n                    .acu-dash-body.acu-dash-horizontal > div {\n                        flex: 0 0 320px;\n                        min-width: 320px;\n                    }\n                }\n            /* Mobile adjustments to keep it usable there */\n            @media (max-width: 768px) {\n                .acu-unused-pool { justify-content: center; background: rgba(0,0,0,0.05); border: 1px dashed var(--acu-border); border-bottom: none; margin: 0 0 8px 0; border-radius: 6px; }\n                .acu-unused-pool::before { display: block; width: 100%; text-align: center; margin-bottom: 4px; content: "å¯é€‰åŠŸèƒ½æ±  (æ‹–æ‹½æˆ–ç‚¹å‡»)"; }\n                .acu-order-controls { flex-direction: column; gap: 6px; text-align: center; }\n            }\n            .acu-actions-group.dragging-over { background: rgba(var(--acu-accent-rgb), 0.1); border-color: var(--acu-accent); }\n            .acu-settings-item { margin-bottom: 15px; }\n            .acu-settings-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #ccc; }\n            .acu-settings-val { float: right; color: #4cd964; font-size: 12px; }\n            .acu-slider { width: 100%; height: 4px; background: #555; border-radius: 2px; outline: none; -webkit-appearance: none; }\n            .acu-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; }\n            .acu-select { width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; border-radius: 4px; outline: none; }\n            .acu-edit-overlay input[type="checkbox"].acu-checkbox { margin-right: 10px; accent-color: var(--acu-accent) !important; background: transparent !important; background-color: transparent !important; }\n            .acu-btn-block { width: 100%; padding: 10px; background: #444; color: #eee; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }\n            .acu-btn-block:hover { background: #555; color: #fff; }\n            .acu-expand-trigger { background: var(--acu-bg-nav); border: 1px solid var(--acu-border); box-shadow: 0 2px 6px var(--acu-shadow); cursor: pointer; color: var(--acu-text-main); font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 2147483645 !important; }\n            .acu-expand-trigger:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n            .acu-col-bar { width: 100%; justify-content: center; padding: 8px 10px; border-radius: 6px; }\n            .acu-col-pill { width: auto !important; padding: 6px 16px; border-radius: 50px; }\n            .acu-col-mini { width: 40px !important; height: 40px !important; padding: 0; justify-content: center; border-radius: 50%; }\n            .acu-col-mini span { display: none; }\n            /* [ä¼˜åŒ–] å°çœ¼ç›å›¾æ ‡æ‚¬åœæ•ˆæœ */\n            .acu-nav-toggle-btn:hover { opacity: 1 !important; transform: translateY(-50%) scale(1.2); color: var(--acu-accent); }\n            .acu-align-right { margin-left: auto; align-self: flex-end; }\n            .acu-align-left { margin-right: auto; margin-left: 0; align-self: flex-start; }\n            .acu-nav-container.acu-left-mode .acu-actions-group { order: -1; margin-left: 0; margin-right: 10px; }\n            #acu-btn-collapse { color: var(--acu-text-sub); }\n            #acu-btn-collapse:hover { color: var(--acu-text-main); background: rgba(0,0,0,0.05); }\n            @keyframes acu-breathe { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.85); color: #ff7e67; } 100% { opacity: 1; transform: scale(1); } } .acu-icon-breathe { animation: acu-breathe 3s infinite ease-in-out !important; display: inline-block; }\n\n            @media (min-width: 768px) {\n                .acu-wrapper.acu-mode-embedded .acu-nav-container { width: fit-content !important; min-width: 300px; max-width: 100%; margin: 0 auto; border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; border: 1px solid var(--acu-border); padding: 6px 20px; background: var(--acu-bg-nav) !important; }\n                .acu-wrapper.acu-mode-embedded .acu-data-display { bottom: calc(100% + 12px) !important; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important; }\n                .acu-nav-container { display: flex; flex-wrap: wrap !important; gap: 6px !important; padding: 6px 10px; grid-template-columns: none !important; flex-direction: row !important; justify-content: flex-start !important; align-items: center !important; height: auto !important; }\n                .acu-nav-container .acu-nav-btn { width: fit-content !important; flex: 0 0 auto !important; height: 32px !important; padding: 0 12px; font-size: 13px !important; min-width: auto !important; }\n                .acu-nav-btn span { max-width: 200px; }\n                .acu-action-btn { flex: 0 0 32px !important; width: 32px !important; height: 32px !important; background: transparent !important; color: var(--acu-text-sub) !important; border-radius: 6px; border: 1px solid transparent; }\n                .acu-action-btn:hover { background: var(--acu-btn-hover) !important; color: var(--acu-text-main) !important; transform: scale(1.1); box-shadow: none; }\n                #acu-btn-save-global { color: var(--acu-accent) !important; }\n                #acu-btn-save-global:hover { background: var(--acu-accent) !important; color: #fff !important; }\n                .acu-order-controls { margin: 0 0 8px 0; padding: 4px; }\n                .acu-actions-group { width: auto !important; margin-left: auto !important; border-top: none !important; border-bottom: none !important; padding: 0; margin-top: 0 !important; margin-bottom: 0 !important; gap: 4px !important; background: transparent; justify-content: flex-end; order: 9999 !important; display: flex; }\n                .acu-pos-top .acu-actions-group { order: -1 !important; margin-left: 0 !important; margin-right: 10px !important; justify-content: flex-start !important; }\n            }\n            @media (max-width: 768px) {\n                .acu-panel-content { -webkit-overflow-scrolling: touch !important; overscroll-behavior-y: auto; }\n                .acu-data-card { box-shadow: none !important; border: 1px solid var(--acu-border); transform: translateZ(0); }\n                .acu-data-card:hover { transform: none !important; box-shadow: none !important; }\n                .acu-nav-btn:hover { transform: none !important; }\n            }\n            /* === ç§»åŠ¨ç«¯æŠ•éª°é¢æ¿é€‚é… === */\n            @media (max-width: 768px) {\n                .acu-dice-panel, .acu-contest-panel {\n                    position: fixed !important;\n                    top: 5% !important;\n                    left: 50% !important;\n                    transform: translateX(-50%) !important;\n                    width: 92vw !important;\n                    max-width: 400px !important;\n                    max-height: 88vh !important;\n                    overflow-y: auto !important;\n                }\n                .acu-dice-panel > div:last-child, .acu-contest-panel > div:last-child {\n                    max-height: none !important;\n                    overflow-y: visible !important;\n                }\n                .acu-dice-overlay, .acu-contest-overlay {\n                    align-items: flex-start !important;\n                    padding-top: 5vh !important;\n                }\n            }\n                /* === ä»ªè¡¨ç›˜æ–°å¢æ ·å¼ï¼šå¯å±•å¼€åœ°ç‚¹åˆ—è¡¨ === */\n                .acu-dash-body {\n                    display: grid;\n                    grid-template-columns: 1fr 1.2fr 1fr;\n                    gap: 15px;\n                    margin: 15px 0;\n                }\n\n                .acu-dash-locations {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-locations h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-location-group {\n                    margin-bottom: 8px;\n                    border-radius: 6px;\n                    overflow: hidden;\n                    background: var(--acu-card-bg);\n                    border: 1px solid transparent;\n                    transition: all 0.2s;\n                }\n\n                .acu-location-group.expanded {\n                    border-color: var(--acu-accent);\n                }\n\n                .acu-location-header {\n                    padding: 8px 10px;\n                    cursor: pointer;\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                    background: var(--acu-table-head);\n                    transition: all 0.2s;\n                    user-select: none;\n                }\n\n                .acu-location-header:hover {\n                    background: var(--acu-table-hover);\n                }\n\n                .acu-expand-icon {\n                    font-size: 10px;\n                    transition: transform 0.2s;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-group.expanded .acu-expand-icon {\n                    transform: rotate(90deg);\n                    color: var(--acu-accent);\n                }\n\n                .acu-region-name {\n                    flex: 1;\n                    font-weight: bold;\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-location-count {\n                    font-size: 11px;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-list {\n                    max-height: 0;\n                    overflow: hidden;\n                    transition: max-height 0.3s ease;\n                }\n\n                .acu-location-group.expanded .acu-location-list {\n                    max-height: 500px;\n                }\n\n                .acu-location-item {\n                    padding: 6px 10px 6px 26px;\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                    font-size: 12px;\n                    border-bottom: 1px dashed rgba(0,0,0,0.05);\n                    transition: all 0.15s;\n                }\n\n                /* ä»ªè¡¨ç›˜åœ°ç‚¹åç§°å•è¡Œçœç•¥æ ·å¼ */\n                .acu-dash-locations .acu-location-item {\n                    padding: 4px 8px !important;\n                    min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */\n                    overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child {\n                    display: flex !important;\n                    align-items: center;\n                    gap: 6px;\n                    flex: 1;\n                    min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */\n                    overflow: hidden;\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child i {\n                    flex-shrink: 0; /* å›¾æ ‡ä¸æ”¶ç¼© */\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child > span {\n                    white-space: nowrap;\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    flex: 1;\n                    min-width: 0; /* å…è®¸flexå­å…ƒç´ æ”¶ç¼© */\n                }\n\n                .acu-location-item:last-child {\n                    border-bottom: none;\n                }\n\n                .acu-location-item:hover {\n                    background: var(--acu-table-hover);\n                    transform: translateX(4px);\n                }\n\n                .acu-location-item.current {\n                    background: var(--acu-hl-diff-bg);\n                    font-weight: bold;\n                    color: var(--acu-hl-diff);\n                }\n\n                .acu-location-item i {\n                    font-size: 10px;\n                    opacity: 0.6;\n                }\n\n                .acu-current-badge {\n                    margin-left: auto;\n                    font-size: 10px;\n                    padding: 2px 6px;\n                    background: var(--acu-btn-active-bg);\n                    color: var(--acu-btn-active-text);\n                    border-radius: 3px;\n                    font-weight: bold;\n                }\n                /* === ä»ªè¡¨ç›˜æ ¸å¿ƒæ ·å¼ï¼ˆè¡¥å……ï¼‰ === */\n                .acu-dash-context {\n                    background: linear-gradient(135deg, var(--acu-table-head), var(--acu-bg-panel));\n                    padding: 15px;\n                    border-radius: 8px;\n                    margin-bottom: 15px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-location {\n                    font-size: 18px;\n                    font-weight: bold;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                }\n\n                .acu-dash-location-desc {\n                    font-size: 13px;\n                    color: var(--acu-text-sub);\n                    margin-top: 6px;\n                    line-height: 1.5;\n                }\n\n                .acu-dash-player, .acu-dash-intel {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-player h3, .acu-dash-intel h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-player-status {\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-task-item {\n                    padding: 8px;\n                    margin-bottom: 6px;\n                    background: rgba(0,0,0,0.03);\n                    border-radius: 6px;\n                    border-left: 3px solid var(--acu-border);\n                }\n\n                .acu-task-name {\n                    font-size: 13px;\n                    font-weight: 500;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-empty-hint {\n                    font-size: 12px;\n                    color: var(--acu-text-sub);\n                    text-align: center;\n                    padding: 15px;\n                    opacity: 0.7;\n                }\n                /* å®¡æ ¸é¢æ¿ç©ºçŠ¶æ€å±…ä¸­ */\n                .acu-changes-content .acu-empty-hint {\n                    flex: 1;\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    justify-content: center;\n                    min-height: 200px;\n                }\n\n                .acu-dashboard-content {\n                    padding: 15px;\n                    overflow-y: auto !important;\n                    overflow-x: hidden !important;\n                    -webkit-overflow-scrolling: touch !important;\n                    touch-action: pan-y !important;\n                    overscroll-behavior-y: contain;\n                    max-height: calc(80vh - 60px);\n                }\n\n                /* === ä»ªè¡¨ç›˜äº¤äº’æŒ‰é’®ä¼˜åŒ– === */\n                h3.acu-dash-table-link,\n                h4.acu-dash-table-link {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    padding: 2px 4px;\n                    margin: -2px -4px;\n                    border-radius: 4px;\n                }\n                h3.acu-dash-table-link:hover,\n                h4.acu-dash-table-link:hover {\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                }\n\n                /* ä»ªè¡¨ç›˜æ“ä½œå›¾æ ‡ - ç»Ÿä¸€æ”¾å¤§+å¢åŠ ç‚¹å‡»çƒ­åŒº */\n                .acu-dash-dice-btn,\n                .acu-dash-goto-btn,\n                .acu-dash-use-item-btn,\n                .acu-dash-use-skill-btn,\n                .acu-dash-track-task-btn,\n                .acu-dash-msg-btn,\n                .acu-dash-contest-btn,\n                .acu-dash-dice-free,\n                .acu-dash-relation-graph-btn,\n                .acu-dash-avatar-manager-btn {\n                    cursor: pointer;\n                    color: var(--acu-text-sub);\n                    opacity: 0.5;\n                    font-size: 14px !important;\n                    padding: 6px;\n                    margin: -4px;\n                    border-radius: 4px;\n                    transition: all 0.15s;\n                    display: inline-flex;\n                    align-items: center;\n                    justify-content: center;\n                    min-width: 28px;\n                    min-height: 28px;\n                }\n                .acu-dash-dice-btn:hover,\n                .acu-dash-goto-btn:hover,\n                .acu-dash-use-item-btn:hover,\n                .acu-dash-use-skill-btn:hover,\n                .acu-dash-track-task-btn:hover,\n                .acu-dash-msg-btn:hover,\n                .acu-dash-contest-btn:hover,\n                .acu-dash-dice-free:hover {\n                    opacity: 1;\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                    transform: scale(1.1);\n                }\n\n                /* ä»ªè¡¨ç›˜å¯ç‚¹å‡»é¡¹ - å¢å¼ºåé¦ˆ */\n                .acu-dash-clickable {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    border-radius: 4px;\n                }\n                .acu-dash-clickable:hover {\n                    background: var(--acu-table-hover);\n                }\n                .acu-dash-clickable:active {\n                    transform: scale(0.98);\n                }\n\n                @media (max-width: 768px) {\n                    .acu-dash-body {\n                        grid-template-columns: 1fr;\n                        max-height: none;\n                        overflow: visible;\n                    }\n\n                    .acu-dashboard-content {\n                        max-height: calc(75vh - 50px) !important;\n                        padding-bottom: 20px !important;\n                    }\n\n                    /* ç§»åŠ¨ç«¯è¿›ä¸€æ­¥æ”¾å¤§æ“ä½œæŒ‰é’® */\n                    .acu-dash-dice-btn,\n                    .acu-dash-goto-btn,\n                    .acu-dash-use-item-btn,\n                    .acu-dash-use-skill-btn,\n                    .acu-dash-track-task-btn,\n                    .acu-dash-msg-btn,\n                    .acu-dash-contest-btn,\n                    .acu-dash-dice-free {\n                        font-size: 16px !important;\n                        padding: 8px;\n                        min-width: 36px;\n                        min-height: 36px;\n                    }\n                }\n            /* === ä»ªè¡¨ç›˜é¢„è§ˆå¡ç‰‡æ ·å¼ === */\n            .acu-preview-overlay {\n                z-index: 2147483650;\n                backdrop-filter: blur(3px);\n                animation: acuFadeIn 0.2s ease;\n            }\n\n                .acu-preview-overlay .acu-data-card {\n                    width: 90vw;\n                    max-width: 400px;\n                    flex: none;\n                }\n                @media (min-width: 768px) {\n                    .acu-preview-overlay .acu-data-card {\n                        max-width: 550px;\n                    }\n                }\n\n            .acu-preview-close:hover {\n                background: var(--acu-error-bg, rgba(231, 76, 60, 0.1));\n                color: var(--acu-error-text, #e74c3c);\n            }\n\n            .acu-dash-clickable {\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n\n            .acu-dash-clickable:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-current-location span {\n                color: var(--acu-accent);\n                font-weight: 600;\n            }\n            .acu-current-location i {\n                color: var(--acu-accent);\n            }\n            /* === è‡ªå®šä¹‰ä¸‹æ‹‰èœå•æ ·å¼ === */\n            .acu-dropdown-wrapper { position: relative; width: 100%; }\n            .acu-dropdown-list {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                max-height: 150px;\n                overflow-y: auto;\n                border: 1px solid;\n                border-radius: 4px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                z-index: 2147483649;\n                display: none;\n            }\n            .acu-dropdown-list.visible { display: block; }\n            .acu-dropdown-item {\n                padding: 6px 10px;\n                font-size: 12px;\n                cursor: pointer;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                background: transparent;\n                transition: background 0.1s;\n            }\n            .acu-dropdown-empty {\n                padding: 8px 10px;\n                font-size: 12px;\n                text-align: center;\n                opacity: 0.7;\n            }\n            /* === è¾“å…¥æ¡†æ¸…é™¤æŒ‰é’®æ ·å¼ === */\n            .acu-input-wrapper { position: relative; display: flex; align-items: center; width: 100%; }\n            .acu-input-wrapper input { padding-right: 24px !important; }\n            .acu-clear-btn { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background: transparent !important; border: none !important; font-size: 12px; cursor: pointer; padding: 4px; line-height: 1; opacity: 0.5; transition: opacity 0.2s; z-index: 5; }\n            .acu-clear-btn:hover { background: transparent !important; border: none !important; opacity: 1 !important; }\n\n            /* ========== äººç‰©å…³ç³»å›¾æ ·å¼ ========== */\n            .acu-relation-graph-overlay {\n                background: rgba(0,0,0,0.8);\n                z-index: 2147483650;\n                backdrop-filter: blur(4px);\n            }\n            .acu-relation-graph-container {\n                width: 95%;\n                max-width: 900px;\n                height: 85vh;\n                max-height: 700px;\n            }\n            .acu-graph-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-graph-actions {\n                display: flex;\n                gap: 8px;\n            }\n            .acu-graph-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-graph-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-graph-canvas-wrapper {\n                flex: 1;\n                overflow: hidden;\n                position: relative;\n                min-height: 0;\n            }\n            .acu-graph-svg {\n                width: 100%;\n                height: 100%;\n                cursor: grab;\n            }\n            .acu-graph-svg:active { cursor: grabbing; }\n            .acu-graph-edge {\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                opacity: 0.6;\n            }\n            .acu-graph-edge-label {\n                font-size: 11px;\n                fill: var(--acu-text-sub);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-graph-node { cursor: grab; }\n            .acu-graph-node:active { cursor: grabbing; }\n            .acu-node-bg {\n                fill: var(--acu-btn-bg);\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                transition: all 0.2s;\n            }\n            .acu-node-bg.player {\n                fill: var(--acu-accent);\n                stroke: var(--acu-btn-active-text);\n            }\n            .acu-graph-node:hover .acu-node-bg {\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n                filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));\n            }\n            .acu-graph-node:hover .acu-node-avatar {\n                box-shadow: 0 0 0 2px var(--acu-accent);\n            }\n            .acu-graph-svg.highlighting .acu-graph-node {\n                opacity: 0.2;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted {\n                opacity: 1;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted .acu-node-bg {\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted .acu-node-avatar {\n                box-shadow: 0 0 0 2px var(--acu-accent);\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge.highlighted {\n                opacity: 1;\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label.highlighted {\n                opacity: 1;\n                fill: var(--acu-accent);\n                font-weight: bold;\n            }\n            .acu-node-char {\n                font-size: 16px;\n                font-weight: bold;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-bg.player + text.acu-node-char,\n            .acu-node-bg.player ~ text.acu-node-char {\n                fill: var(--acu-btn-active-text);\n            }\n            .acu-node-label {\n                font-size: 12px;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-inscene-indicator {\n                fill: var(--acu-accent);\n                stroke: var(--acu-bg-panel);\n                stroke-width: 2;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));\n            }\n            .acu-graph-legend {\n                display: flex;\n                gap: 16px;\n                justify-content: center;\n                padding: 10px;\n                border-top: 1px solid var(--acu-border);\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n            }\n            .acu-graph-legend span {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-zoom-display {\n                background: var(--acu-btn-bg);\n                padding: 2px 8px;\n                border-radius: 4px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                min-width: 45px;\n                text-align: center;\n            }\n            .acu-node-size-slider-container input[type="range"] {\n                -webkit-appearance: none;\n                appearance: none;\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n                outline: none;\n                cursor: pointer;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb {\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-track {\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n            }\n            @media (max-width: 768px) {\n                .acu-relation-graph-container {\n                    width: 100%;\n                    height: 80vh;\n                    max-height: none;\n                    border-radius: 12px;\n                }\n                .acu-graph-legend {\n                    gap: 8px;\n                    flex-wrap: nowrap;\n                    padding: 8px 6px;\n                }\n            }\n\n            /* ========== åœ°å›¾å¯è§†åŒ–æ ·å¼ ========== */\n            .acu-map-overlay {\n                background: rgba(0,0,0,0.8);\n                z-index: 2147483650;\n                backdrop-filter: blur(4px);\n            }\n            .acu-map-container {\n                width: 95%;\n                max-width: 500px;\n                max-height: 85vh;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                display: flex;\n                flex-direction: column;\n                overflow: hidden;\n                box-shadow: 0 10px 40px rgba(0,0,0,0.45);\n            }\n            .acu-map-title {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-map-actions {\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-map-actions button {\n                width: 28px;\n                height: 28px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n            }\n            .acu-map-actions button:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n            .acu-map-body {\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                padding: 12px;\n                overflow: hidden;\n            }\n            /* ç„¦ç‚¹åŒºåŸŸ - 3åˆ—Gridå¸ƒå±€ */\n            .acu-map-focus-area {\n                display: grid;\n                grid-template-columns: 1fr auto 1fr;\n                gap: 12px;\n                align-items: center;\n                border: 1px dashed var(--acu-border);\n                border-radius: 12px;\n                padding: 16px;\n                background: var(--acu-btn-bg);\n            }\n\n            /* ä¾§ç¿¼ */\n            .acu-map-wing {\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                min-width: 0;\n                align-self: flex-start; /* ä¾§ç¿¼é¡¶éƒ¨å¯¹é½ */\n            }\n            .acu-map-wing.left { align-items: flex-end; text-align: right; }\n            .acu-map-wing.right { align-items: flex-start; text-align: left; }\n\n            .acu-map-mobile-stack {\n                display: none;\n            }\n\n            /* å¤´åƒç»„ */\n            .acu-map-avatar-group {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 6px;\n                align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */\n                min-height: 70px; /* ç¡®ä¿æœ‰æœ€å°é«˜åº¦ */\n            }\n            .acu-map-wing.left .acu-map-avatar-group { justify-content: flex-end; }\n            .acu-map-wing.right .acu-map-avatar-group { justify-content: flex-start; }\n\n            /* å¤´åƒæ™ºèƒ½å †å  */\n            .acu-map-wing.left .acu-map-avatar:not(:last-child) { margin-right: -12px; }\n            .acu-map-wing.right .acu-map-avatar:not(:first-child) { margin-left: -12px; }\n            .acu-map-avatar:hover { transform: scale(1.1); z-index: 10; position: relative; }\n\n            .acu-map-avatar {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 4px;\n                min-width: 56px;\n                cursor: pointer;\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            .acu-map-avatar-circle {\n                width: 46px;\n                height: 46px;\n                border-radius: 50%;\n                border: 2px solid var(--acu-accent);\n                background: var(--acu-btn-bg);\n                background-size: cover;\n                background-position: center;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--acu-text-sub);\n                font-weight: bold;\n                font-size: 16px;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n            .acu-map-avatar-name {\n                font-size: 11px;\n                color: var(--acu-text-main);\n                text-shadow: 0 1px 2px rgba(0,0,0,0.3);\n            }\n\n            /* å…ƒç´ ç»„ */\n            .acu-map-element-group {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                max-width: 140px;\n            }\n            .acu-map-element-chip {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                padding: 4px 8px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-bg-panel);\n                font-size: 11px;\n                color: var(--acu-text-main);\n                cursor: pointer;\n                transition: all 0.15s;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-map-element-chip:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n                transform: translateX(2px);\n            }\n\n            /* ä¸­å¤®èˆå° */\n            .acu-map-stage-center {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                min-width: 100px;\n                z-index: 2;\n                cursor: pointer;\n            }\n\n            /* é€æ˜èƒŒæ™¯å¤§å·Emoji */\n            .acu-map-location-emoji {\n                background: transparent;\n                border: none;\n                width: auto;\n                height: auto;\n                font-size: 4rem;\n                line-height: 1;\n                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));\n                transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n            .acu-map-location-emoji:hover { transform: scale(1.1) rotate(5deg); }\n\n            /* æ— emojiæ—¶çš„æ–‡å­—å ä½ */\n            .acu-map-location-text {\n                width: 64px;\n                height: 64px;\n                border-radius: 12px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 28px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n            }\n\n            /* åœ°ç‚¹å */\n            .acu-map-location-name {\n                margin-top: 8px;\n                font-weight: 700;\n                font-size: 1.1em;\n                max-width: 140px;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                color: var(--acu-text-main);\n            }\n\n            /* ç¼©ç•¥å›¾æ ·å¼ */\n            .acu-map-thumbnails {\n                display: grid;\n                grid-template-columns: repeat(3, minmax(0, 1fr));\n                gap: 12px;\n                max-height: 50vh;\n                overflow-y: auto;\n                overflow-x: hidden;\n                padding: 12px;\n                box-sizing: border-box;\n            }\n            .acu-map-thumbnail {\n                position: relative;\n                border: 1px solid var(--acu-border);\n                border-radius: 10px;\n                padding: 8px;\n                background: var(--acu-btn-bg);\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 4px;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-map-thumbnail.active {\n                border-color: var(--acu-accent);\n                box-shadow: 0 0 0 1px var(--acu-accent);\n            }\n            .acu-map-thumbnail:hover {\n                border-color: var(--acu-accent);\n                transform: translateY(-2px);\n            }\n            .acu-map-thumbnail-emoji {\n                width: 36px;\n                height: 36px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 24px;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));\n            }\n            .acu-map-thumbnail-placeholder {\n                width: 36px;\n                height: 36px;\n                border-radius: 8px;\n                background: var(--acu-bg-panel);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                border: 1px solid var(--acu-border);\n            }\n            .acu-map-thumbnail-name { font-size: 11px; color: var(--acu-text-main); }\n\n            /* è§’æ ‡ */\n            .acu-map-thumbnail-badge {\n                position: absolute;\n                top: -8px;\n                right: -8px;\n                min-width: 22px;\n                height: 22px;\n                padding: 0 6px;\n                border-radius: 99px;\n                background: var(--acu-accent);\n                color: #ffffff;\n                font-size: 0.75rem;\n                font-weight: 800;\n                font-variant-numeric: tabular-nums;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                box-shadow: 0 3px 6px rgba(0,0,0,0.25);\n                border: 3px solid var(--acu-btn-bg);\n                z-index: 10;\n                transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);\n            }\n\n            .acu-map-thumbnail:hover .acu-map-thumbnail-badge {\n                transform: scale(1.1);\n            }\n\n            /* åœ°åŒºæ ‡ç­¾é¡µ */\n            .acu-map-region-tabs {\n                display: flex;\n                gap: 4px;\n                margin-left: auto;\n                margin-right: 8px;\n            }\n            .acu-map-region-tab {\n                padding: 4px 10px;\n                border-radius: 6px;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-map-region-tab.active,\n            .acu-map-region-tab:hover {\n                background: var(--acu-accent);\n                color: white;\n                border-color: var(--acu-accent);\n            }\n\n            .acu-map-empty {\n                text-align: center;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                padding: 8px 0;\n            }\n            .acu-map-loading {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                padding: 40px;\n                width: 100%;\n            }\n            .acu-map-spinner {\n                width: 32px;\n                height: 32px;\n                border: 3px solid var(--acu-border);\n                border-top-color: var(--acu-accent);\n                border-radius: 50%;\n                animation: acu-map-spin 0.8s linear infinite;\n            }\n            @keyframes acu-map-spin { to { transform: rotate(360deg); } }\n            @media (max-width: 768px) {\n                .acu-map-container {\n                    width: 96%;\n                    max-height: 92vh;\n                }\n                .acu-map-focus-area {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 12px;\n                    padding: 16px 12px;\n                    background: var(--acu-btn-bg);\n                }\n                .acu-map-stage-center {\n                    width: 100%;\n                    margin-bottom: 4px;\n                    flex-direction: row;\n                    justify-content: center;\n                    gap: 12px;\n                }\n                .acu-map-location-emoji {\n                    font-size: 2.5rem;\n                    width: 48px;\n                    height: 48px;\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                }\n                .acu-map-location-text {\n                    width: 48px;\n                    height: 48px;\n                    font-size: 20px;\n                }\n                .acu-map-location-name {\n                    margin-top: 0;\n                    font-size: 1.25rem;\n                    max-width: none;\n                    text-align: left;\n                    align-self: center;\n                }\n                .acu-map-wing {\n                    display: none;\n                }\n                .acu-map-mobile-stack {\n                    display: flex;\n                    flex-direction: column;\n                    gap: 10px;\n                    width: 100%;\n                }\n                .acu-map-mobile-avatars,\n                .acu-map-mobile-elements {\n                    display: flex;\n                    flex-wrap: wrap;\n                    justify-content: center;\n                    gap: 8px;\n                    max-height: 168px;\n                    overflow-y: auto;\n                    padding: 2px 4px;\n                }\n                .acu-map-mobile-avatars:empty,\n                .acu-map-mobile-elements:empty {\n                    display: none;\n                }\n                .acu-map-avatar {\n                    min-width: auto;\n                    width: 52px;\n                }\n                .acu-map-avatar-circle {\n                    width: 42px;\n                    height: 42px;\n                }\n                .acu-map-element-chip {\n                    font-size: 12px;\n                    padding: 6px 10px;\n                    background: var(--acu-bg-panel);\n                }\n                .acu-map-thumbnails {\n                    grid-template-columns: repeat(3, minmax(0, 1fr));\n                    gap: 10px;\n                }\n            }\n\n            /* ========== å¤´åƒç®¡ç†å¼¹çª—æ ·å¼ ========== */\n            .acu-avatar-manager-overlay {\n                background: rgba(0,0,0,0.7);\n                z-index: 2147483655;\n            }\n            .acu-avatar-manager {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n            }\n            .acu-avatar-title {\n                font-size: 15px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-avatar-list {\n                flex: 1;\n                overflow-y: auto;\n                padding: 12px;\n                min-height: 0;\n            }\n            .acu-avatar-item {\n                display: flex;\n                align-items: flex-start;\n                gap: 12px;\n                padding: 10px;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .acu-avatar-item:last-child { border-bottom: none; }\n            .acu-avatar-preview {\n                width: 48px;\n                height: 48px;\n                border-radius: 50%;\n                background: var(--acu-btn-bg);\n                background-size: cover;\n                background-position: center;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                border: 2px solid var(--acu-border);\n                flex-shrink: 0;\n                position: relative;\n                cursor: pointer;\n            }\n            .acu-avatar-preview span {\n                font-size: 18px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-camera-hint {\n                position: absolute;\n                bottom: 2px;\n                right: 2px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                opacity: 0.5;\n                pointer-events: none;\n            }\n            .acu-avatar-preview:hover .acu-avatar-camera-hint {\n                opacity: 0.8;\n                color: var(--acu-accent);\n            }\n            .acu-avatar-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-avatar-name {\n                font-size: 13px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-avatar-name-row {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-url,\n            .acu-avatar-manager-overlay input.acu-avatar-aliases {\n                width: 100%;\n                padding: 6px 8px;\n                font-size: 12px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-main) !important;\n                box-sizing: border-box;\n                -webkit-appearance: none;\n                appearance: none;\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-url:focus,\n            .acu-avatar-manager-overlay input.acu-avatar-aliases:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n                box-shadow: none !important;\n            }\n            /* å¤´åƒè¾“å…¥è¡Œï¼ˆURL + ä¸Šä¼ æŒ‰é’®ï¼‰ */\n            .acu-avatar-input-row {\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-avatar-input-row .acu-avatar-url {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-avatar-upload-btn {\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                flex-shrink: 0;\n                transition: all 0.15s;\n            }\n            .acu-avatar-upload-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n            .acu-avatar-upload-btn:active {\n                transform: scale(0.95);\n            }\n            /* å¤´åƒæ¥æºæ ‡ç­¾ */\n            .acu-avatar-source {\n                position: absolute;\n                bottom: -10px;\n                left: 50%;\n                transform: translateX(-50%);\n                font-size: 9px;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-weight: bold;\n                white-space: nowrap;\n            }\n            .acu-avatar-preview-wrap {\n                position: relative;\n                flex-shrink: 0;\n            }\n            .acu-source-local,\n            .acu-source-url,\n            .acu-source-auto {\n                background: var(--acu-badge-bg);\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-aliases {\n                padding: 4px 8px;\n                font-size: 11px;\n                margin-top: 4px;\n            }\n            .acu-avatar-manager-overlay input::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7;\n            }\n            .acu-avatar-actions {\n                display: flex;\n                flex-direction: row;\n                gap: 4px;\n                flex-shrink: 0;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-actions button {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-sub) !important;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-actions button:hover {\n                background: var(--acu-btn-hover) !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-avatar-save-btn:hover { color: var(--acu-success-text, #27ae60) !important; }\n            .acu-avatar-clear-btn:hover { color: var(--acu-error-text, #e74c3c) !important; }\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 12px;\n                transition: all 0.2s;\n            }\n            .acu-avatar-import-btn:hover,\n            .acu-avatar-export-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-avatar-crop-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-top: 6px;\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-crop-row.hidden { display: none; }\n            .acu-avatar-manager-overlay .acu-avatar-scale {\n                flex: 1;\n                height: 6px !important;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n                margin: 0 8px;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-runnable-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer !important;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;\n                margin-top: -5px !important;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-thumb {\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                border: 2px solid var(--acu-bg-panel);\n                cursor: pointer !important;\n            }\n            @media (max-width: 768px) {\n                .acu-avatar-manager {\n                    width: 95%;\n                    max-height: 85vh;\n                }\n            }\n\n            /* ========== å¯¼å…¥ç¡®è®¤å¼¹çª—æ ·å¼ ========== */\n            .acu-import-confirm-overlay {\n                z-index: 2147483660;\n            }\n            .acu-import-confirm-dialog {\n                width: 90%;\n                max-width: 320px;\n            }\n            .acu-import-confirm-body {\n                padding: 16px;\n            }\n            .acu-import-stats {\n                display: flex;\n                justify-content: space-around;\n                margin-bottom: 16px;\n            }\n            .acu-import-stat {\n                text-align: center;\n            }\n            .acu-stat-num {\n                display: block;\n                font-size: 24px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-stat-label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-stat-new .acu-stat-num { color: var(--acu-success-text); }\n            .acu-stat-conflict .acu-stat-num { color: #e67e22; }\n            .acu-import-conflict-section {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-import-conflict-options {\n                margin-top: 10px;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n            .acu-import-radio {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-import-radio input {\n                accent-color: var(--acu-accent);\n            }\n            .acu-import-confirm-footer {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-import-cancel-btn,\n            .acu-import-confirm-btn {\n                flex: 1;\n                padding: 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: bold;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-import-cancel-btn {\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-import-cancel-btn:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-import-confirm-btn {\n                background: var(--acu-accent);\n                border: none;\n                color: #fff;\n            }\n            .acu-import-confirm-btn:hover {\n                opacity: 0.9;\n            }\n            /* ========== å¤´åƒå¯¼å…¥/å¯¼å‡ºç›¸å…³æ ·å¼ ========== */\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n            }\n\n            /* ========== ç»Ÿä¸€éª°å­è®¾ç½®é¢æ¿æ ·å¼ ========== */\n            .acu-dice-config-dialog {\n                width: 320px;\n                max-width: 92vw;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 15px 40px rgba(0,0,0,0.4);\n                overflow: hidden;\n            }\n            .acu-dice-cfg-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 14px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-dice-cfg-header .acu-config-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                font-size: 14px;\n                padding: 4px;\n            }\n            .acu-dice-cfg-header .acu-config-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-body {\n                padding: 12px;\n            }\n            .acu-dice-cfg-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n            .acu-dice-cfg-row.acu-cfg-full-row {\n                grid-template-columns: 1fr;\n            }\n            .acu-dice-cfg-item {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n            .acu-dice-cfg-item label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: 500;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item {\n                flex-direction: row;\n                align-items: center;\n                justify-content: space-between;\n                padding: 8px 0;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item > label {\n                margin: 0;\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input,\n            .acu-dice-cfg-item select {\n                width: 100%;\n                padding: 7px 8px;\n                background: var(--acu-input-bg) !important;\n                border: 1px solid var(--acu-border);\n                border-radius: 5px;\n                color: var(--acu-text-main) !important;\n                font-size: 13px;\n                text-align: center;\n                box-sizing: border-box;\n            }\n            .acu-dice-cfg-item input::placeholder {\n                color: var(--acu-text-sub);\n                opacity: 0.6;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item select {\n                text-align: left;\n                cursor: pointer;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input:focus,\n            .acu-dice-cfg-item select:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .acu-cfg-hint {\n                font-size: 9px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n                text-align: center;\n            }\n            .acu-dice-cfg-actions {\n                display: flex;\n                gap: 8px;\n                margin-top: 12px;\n                padding: 10px 12px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-dice-cfg-actions button {\n                flex: 1;\n                padding: 9px 12px;\n                border-radius: 6px;\n                font-size: 12px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-actions button:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-dice-cfg-actions button.primary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-btn-bg);\n                color: var(--acu-button-text);\n            }\n            .acu-dice-cfg-actions button.primary:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-btn-hover);\n            }\n            /* ========== æ–°ç‰ˆè®¾ç½®é¢æ¿æ ·å¼ ========== */\n            .acu-settings-dialog {\n                width: 380px;\n                max-width: 380px;\n                max-height: 85vh;\n                padding: 0;\n                gap: 0;\n            }\n            @media (max-width: 768px) {\n                .acu-settings-dialog {\n                    width: 92vw;\n                    max-width: 92vw;\n                    max-height: 85vh;\n                }\n                .acu-settings-body {\n                    max-height: calc(85vh - 110px);\n                    -webkit-overflow-scrolling: touch;\n                }\n                .acu-table-manager-list {\n                    max-height: 40vh;\n                    -webkit-overflow-scrolling: touch;\n                }\n            }\n            .acu-settings-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 14px 16px;\n                border-bottom: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-settings-title-group {\n                display: flex;\n                align-items: center;\n                gap: 12px;\n            }\n            .acu-settings-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-header-actions {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-version-badge {\n                display: inline-flex;\n                align-items: center;\n                line-height: 1.2;\n                white-space: nowrap;\n                letter-spacing: 0.5px;\n                background: var(--acu-badge-bg, rgba(0, 0, 0, 0.05));\n                color: var(--acu-text-sub);\n                border-radius: 4px;\n                padding: 2px 6px;\n                font-size: 10px;\n                font-weight: normal;\n                margin-left: 6px;\n                opacity: 0.8;\n            }\n            .acu-help-btn {\n                background: none !important;\n                border: none !important;\n                box-shadow: none !important;\n                outline: none !important;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                font-size: 16px;\n                padding: 6px;\n                margin: 0;\n                border-radius: 4px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-help-btn:hover {\n                color: var(--acu-text-main);\n                background: var(--acu-table-hover) !important;\n            }\n            .acu-settings-body {\n                flex: 1;\n                min-height: 0;\n                overflow-y: auto;\n                overflow-x: hidden;\n                padding: 8px;\n                -webkit-overflow-scrolling: touch;\n            }\n            .acu-settings-group {\n                background: var(--acu-card-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 8px;\n            }\n            .acu-settings-group-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 12px 14px;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: var(--acu-table-head);\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.15s;\n            }\n            .acu-settings-group-title:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-group-chevron {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                width: 12px;\n                transition: transform 0.2s;\n            }\n            .acu-settings-group-body {\n                padding: 4px 12px 8px;\n            }\n            .acu-settings-group.collapsed .acu-settings-group-body {\n                display: none;\n            }\n            .acu-settings-group-body.acu-animating {\n                display: block !important;\n                overflow: hidden;\n            }\n            .acu-settings-group:last-child {\n                margin-bottom: 0;\n            }\n            .acu-setting-row {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 0;\n                border-bottom: 1px dashed var(--acu-border);\n                gap: 12px;\n                min-height: 44px;\n            }\n            .acu-setting-row:last-child {\n                border-bottom: none;\n            }\n            .acu-setting-row-slider {\n                flex-direction: column;\n                align-items: stretch;\n            }\n            .acu-setting-info {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-setting-label {\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-setting-hint {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-setting-value {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                margin-left: auto;\n            }\n            .acu-setting-select {\n                padding: 6px 10px;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px;\n                min-width: 120px;\n                cursor: pointer;\n                -webkit-appearance: none;\n                appearance: none;\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L2 4h8z'/%3E%3C/svg%3E");\n                background-repeat: no-repeat;\n                background-position: right 8px center;\n                padding-right: 28px;\n            }\n            .acu-setting-select:focus {\n                outline: none;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-setting-select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-select-short {\n                min-width: 80px;\n            }\n            .acu-setting-slider {\n                width: 100%;\n                height: 6px;\n                margin-top: 8px;\n                -webkit-appearance: none;\n                appearance: none;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n            }\n            .acu-setting-slider::-webkit-slider-runnable-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n            }\n            .acu-setting-slider::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n                margin-top: -6px;\n            }\n            .acu-setting-slider::-moz-range-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-setting-slider::-moz-range-thumb {\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n            }\n            .acu-setting-slider:focus {\n                outline: none;\n            }\n            .acu-setting-mini-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 11px;\n                flex-shrink: 0;\n                transition: all 0.15s;\n            }\n            .acu-setting-mini-btn:hover, .acu-setting-mini-btn.active {\n                background: var(--acu-accent);\n                color: #fff;\n                border-color: var(--acu-accent);\n            }\n\n            /* ========== å±æ€§é¢„è®¾ç®¡ç†é¢æ¿æ ·å¼ ========== */\n            .acu-preset-item {\n                padding: 12px;\n                background: var(--acu-card-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 10px;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                gap: 12px;\n                transition: all 0.2s;\n            }\n            .acu-preset-item:hover {\n                background: var(--acu-table-hover);\n                border-color: var(--acu-accent);\n            }\n            .acu-preset-info {\n                flex: 1;\n            }\n            .acu-preset-name {\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-preset-desc {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-bottom: 4px;\n            }\n            .acu-preset-stats {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n            }\n            .acu-preset-actions {\n                display: flex;\n                gap: 8px;\n                flex-shrink: 0;\n                align-items: center;\n            }\n            .acu-preset-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 13px;\n                transition: all 0.15s;\n            }\n            .acu-preset-btn:hover {\n                background: var(--acu-accent);\n                color: #fff;\n                border-color: var(--acu-accent);\n            }\n            .acu-preset-btn.acu-preset-delete:hover {\n                background: rgba(231, 76, 60, 0.2);\n                color: #e74c3c;\n                border-color: #e74c3c;\n            }\n            /* é¢„è®¾ç¼–è¾‘å™¨è¾“å…¥æ¡†æ ·å¼ï¼ˆé˜²æ­¢è¢«ä¸»é¢˜è¦†ç›–ï¼‰ */\n            .acu-preset-editor-input,\n            .acu-preset-editor-textarea {\n                background: var(--acu-input-bg) !important;\n                color: var(--acu-text-main) !important;\n                border: 1px solid var(--acu-border) !important;\n            }\n            .acu-preset-editor-input:focus,\n            .acu-preset-editor-textarea:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n                box-shadow: 0 0 0 2px rgba(var(--acu-accent-rgb, 100, 150, 200), 0.2) !important;\n            }\n            .acu-preset-editor-textarea {\n                font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;\n            }\n            /* Toggle å¼€å…³ */\n            .acu-toggle {\n                position: relative;\n                width: 44px;\n                height: 24px;\n                flex-shrink: 0;\n            }\n            .acu-toggle input {\n                opacity: 0;\n                width: 0;\n                height: 0;\n            }\n            .acu-toggle-slider {\n                position: absolute;\n                cursor: pointer;\n                top: 0; left: 0; right: 0; bottom: 0;\n                background: rgba(120, 120, 128, 0.16);\n                border: none;\n                border-radius: 24px;\n                transition: all 0.3s ease;\n            }\n            .acu-toggle-slider:before {\n                position: absolute;\n                content: "";\n                height: 20px;\n                width: 20px;\n                left: 2px;\n                top: 2px;\n                background: #fff;\n                border-radius: 50%;\n                transition: all 0.3s ease;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.15);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider {\n                background: var(--acu-accent);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider:before {\n                transform: translateX(20px);\n                box-shadow: 0 2px 8px rgba(0,0,0,0.2);\n            }\n            /* Debugæ§åˆ¶å°è¿‡æ»¤æ ·å¼ - å¢åŠ ä¼˜å…ˆçº§é˜²æ­¢è¢«é…’é¦†æ ·å¼è¦†ç›– */\n            .acu-debug-console-dialog .acu-debug-filter,\n            .acu-debug-console-dialog label input.acu-debug-filter {\n                cursor: pointer !important;\n                width: auto !important;\n                height: auto !important;\n                margin: 0 !important;\n                padding: 0 !important;\n                appearance: checkbox !important;\n                -webkit-appearance: checkbox !important;\n                -moz-appearance: checkbox !important;\n            }\n            .acu-debug-console-dialog label {\n                display: flex !important;\n                align-items: center !important;\n                gap: 4px !important;\n                cursor: pointer !important;\n                font-size: 12px !important;\n            }\n            .acu-setting-action-btn {\n                width: 100%;\n                padding: 10px 14px;\n                margin-bottom: 6px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: all 0.15s;\n            }\n            /* Stepper æ­¥è¿›å™¨ */\n            .acu-stepper {\n                display: flex;\n                align-items: center;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                overflow: hidden;\n                background: transparent !important;\n                flex-shrink: 0;\n            }\n            .acu-stepper-btn {\n                width: 36px;\n                height: 34px;\n                border: none !important;\n                background: transparent !important;\n                background-color: transparent !important;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n            }\n            .acu-stepper-btn:hover {\n                background: var(--acu-table-hover) !important;\n                color: var(--acu-accent);\n            }\n            .acu-stepper-btn:active {\n                transform: scale(0.95);\n                background: var(--acu-accent) !important;\n                color: var(--acu-button-text);\n            }\n            .acu-stepper-value {\n                min-width: 60px;\n                height: 34px;\n                line-height: 34px;\n                text-align: center;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: transparent !important;\n                border-left: 1px solid var(--acu-border);\n                border-right: 1px solid var(--acu-border);\n            }\n            /* ========== å˜æ›´å®¡æ ¸é¢æ¿æ ·å¼ ========== */\n            .acu-changes-content {\n                padding: 10px;\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                -webkit-overflow-scrolling: touch !important;\n                touch-action: pan-y !important;\n                overscroll-behavior-y: contain;\n            }\n            /* ========== éªŒè¯é”™è¯¯æ¶ˆæ¯æ ·å¼ ========== */\n            .acu-validation-error-msg {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 0;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n            /* æ•°æ®éªŒè¯æ¨¡å¼æç¤º - å›ºå®šåœ¨é¢æ¿é¡¶éƒ¨ï¼Œä¸å‚ä¸æ¨ªå‘æ»šåŠ¨ */\n            .acu-validation-mode-hint {\n                padding: 8px 12px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                border-radius: 6px;\n                margin: 0 0 10px 0;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            /* å®¡æ ¸é¢æ¿æ¨ªå‘æ»šåŠ¨æ¨¡å¼ */\n            .acu-changes-content.acu-changes-horizontal {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                align-items: flex-start !important;\n                gap: 12px;\n                overflow-x: auto !important;\n                overflow-y: visible !important;\n                touch-action: pan-x pan-y !important;\n                padding-bottom: 5px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-x: contain;\n                overscroll-behavior-y: auto;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-list {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                gap: 12px;\n                align-items: flex-start;\n                min-width: max-content;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                flex: 0 0 280px;\n                min-width: 280px;\n                max-width: 280px;\n                max-height: none;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: auto;\n                overscroll-behavior-y: auto;\n            }\n            @media (min-width: 769px) {\n                .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                    flex: 0 0 320px;\n                    min-width: 320px;\n                    max-width: 320px;\n                }\n            }\n            .acu-changes-list { display: flex; flex-direction: column; gap: 10px; }\n            .acu-changes-group { background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; overflow: hidden; }\n            .acu-changes-group-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--acu-table-head); font-weight: bold; font-size: 13px; color: var(--acu-text-main); }\n            .acu-changes-count { margin-left: auto; background: var(--acu-accent); color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: normal; }\n            .acu-changes-group-body { padding: 6px; display: flex; flex-direction: column; gap: 4px; }\n            .acu-change-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 6px; font-size: 12px; background: rgba(0,0,0,0.02); flex-wrap: wrap; transition: all 0.15s; }\n            .acu-change-item:hover { background: var(--acu-table-hover); }\n            .acu-change-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }\n            .acu-badge-added { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-deleted { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); }\n            .acu-badge-modified { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); }\n            .acu-change-title { color: var(--acu-text-main); font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-field { color: var(--acu-text-sub); font-size: 11px; flex-shrink: 0; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-diff { display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0; overflow: hidden; }\n            .acu-diff-old { color: var(--acu-hl-manual); text-decoration: line-through; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            .acu-diff-arrow { color: var(--acu-text-sub); flex-shrink: 0; }\n            .acu-diff-new { color: var(--acu-success-text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            /* å˜æ›´æ“ä½œæŒ‰é’® */\n            .acu-change-actions { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }\n            .acu-change-action-btn { width: 24px; height: 24px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; transition: all 0.15s; padding: 0; }\n            .acu-change-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: scale(1.1); }\n            .acu-action-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-action-reject:hover, .acu-action-restore:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-action-edit:hover { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); border-color: var(--acu-hl-diff); }\n            /* æ‰¹é‡æ“ä½œæŒ‰é’® - å¢å¼ºæ·±è‰²ä¸»é¢˜ä¸‹çš„å¯¹æ¯”åº¦ */\n            .acu-changes-batch-btn { width: 32px; height: 32px; border: 1.5px solid rgba(255,255,255,0.4); border-radius: 6px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.85); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: all 0.15s; }\n            .acu-changes-batch-btn:hover { background: rgba(255,255,255,0.2); color: #fff; border-color: rgba(255,255,255,0.6); }\n            .acu-batch-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-batch-reject:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-simple-mode-toggle.active { background: var(--acu-accent); color: #fff; border-color: var(--acu-accent); }\n            .acu-simple-mode-toggle:hover { background: var(--acu-accent); color: #fff; border-color: var(--acu-accent); }\n            .acu-changes-group.collapsed .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group:not(.collapsed) .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group-header:hover { background: var(--acu-table-hover); }\n            /* å˜æ›´å¯¹æ¯”ç¼–è¾‘å¼¹çª—æ ·å¼ */\n            .acu-diff-section { margin-bottom: 12px; }\n            .acu-diff-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }\n            .acu-diff-readonly { padding: 10px 12px; background: var(--acu-table-head); border: 1px dashed var(--acu-border); border-radius: 6px; color: var(--acu-text-main); font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; max-height: 150px; overflow-y: auto; opacity: 0.8; }\n            .acu-diff-arrow-down { text-align: center; color: var(--acu-text-sub); font-size: 14px; margin: 8px 0; opacity: 0.5; }\n            /* å¯ç¼–è¾‘åŒºåŸŸé«˜äº®æ ·å¼ */\n            .acu-diff-new-section { padding: 12px; background: var(--acu-input-bg); border: 2px solid var(--acu-accent); border-radius: 6px; box-shadow: 0 0 0 3px rgba(127, 127, 255, 0.1); }\n            .acu-diff-new-section .acu-diff-label { color: var(--acu-accent); font-weight: 600; }\n            .acu-diff-new-section textarea,\n            .acu-diff-new-section input { background: var(--acu-input-bg) !important; border-color: var(--acu-border) !important; }\n            .acu-diff-new-section textarea:focus,\n            .acu-diff-new-section input:focus { border-color: var(--acu-accent) !important; box-shadow: 0 0 0 2px rgba(127, 127, 255, 0.15); }\n            /* å•å­—æ®µç¼–è¾‘å¼¹çª—æŒ‰é’®ä¼˜åŒ– */\n            .acu-edit-dialog .acu-dialog-btns {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n                margin: 0 -16px -16px -16px;\n                border-radius: 0 0 12px 12px;\n            }\n            .acu-edit-dialog .acu-dialog-btn {\n                flex: 1;\n                padding: 10px 12px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                white-space: nowrap;\n                transition: all 0.15s;\n            }\n            .acu-edit-dialog .acu-dialog-btn:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-edit-dialog .acu-btn-confirm {\n                background: var(--acu-accent);\n                border-color: var(--acu-accent);\n                color: #fff;\n            }\n            .acu-edit-dialog .acu-btn-confirm:hover {\n                opacity: 0.9;\n            }\n            @media (max-width: 768px) {\n                .acu-edit-dialog .acu-dialog-btns {\n                    flex-wrap: nowrap;\n                }\n                .acu-edit-dialog .acu-dialog-btn {\n                    padding: 10px 8px;\n                    font-size: 12px;\n                    min-width: 0;\n                }\n                .acu-edit-dialog .acu-dialog-btn i {\n                    font-size: 11px;\n                }\n            }\n            @media (max-width: 768px) {\n                .acu-change-item { padding: 8px 6px; }\n                .acu-change-diff { flex-basis: 100%; margin-top: 4px; order: 10; }\n                .acu-change-actions { order: 5; }\n                .acu-diff-old, .acu-diff-new { max-width: 100px; }\n                .acu-change-action-btn { width: 28px; height: 28px; }\n            }\n            .acu-change-field-count { font-size: 11px; color: var(--acu-text-sub); margin-left: 4px; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            /* å¤šå­—æ®µæ•´ä½“ç¼–è¾‘å¼¹çª—æ ·å¼ */\n            .acu-row-edit-field { margin-bottom: 12px; padding: 10px; background: var(--acu-table-head); border-radius: 6px; border: 1px solid transparent; }\n            .acu-row-edit-field.acu-field-changed { border-color: var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-row-edit-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }\n            .acu-changed-badge { font-size: 10px; padding: 1px 6px; background: var(--acu-accent); color: #fff; border-radius: 3px; font-weight: normal; }\n            .acu-row-edit-old { font-size: 12px; color: var(--acu-text-sub); padding: 6px 8px; background: var(--acu-table-head); border-radius: 4px; margin-bottom: 6px; text-decoration: line-through; opacity: 0.7; white-space: pre-wrap; word-break: break-word; }\n            .acu-row-edit-input { width: 100%; min-height: 36px; max-height: 200px; padding: 8px; resize: none; }\n            .acu-empty-val { opacity: 0.5; font-style: italic; }\n            /* ========== è¡¨æ ¼ç®¡ç†åˆ—è¡¨æ ·å¼ ========== */\n            .acu-table-manager-list {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                max-height: 300px;\n                overflow-y: auto;\n                padding: 4px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-y: contain;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                cursor: default;\n                transition: all 0.15s;\n                user-select: none;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-table-manager-item.hidden-table {\n                opacity: 0.5;\n                border-color: var(--acu-border);\n                border-style: dashed;\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-name {\n                text-decoration: line-through;\n            }\n            .acu-table-item-check {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                color: var(--acu-accent);\n                border-radius: 4px;\n                transition: all 0.15s;\n            }\n            .acu-table-item-check:hover {\n                background: var(--acu-table-hover);\n                transform: scale(1.1);\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-check {\n                color: var(--acu-text-sub);\n            }\n            .acu-table-item-icon {\n                width: 20px;\n                text-align: center;\n                color: var(--acu-accent);\n                font-size: 12px;\n            }\n            .acu-table-item-name {\n                flex: 1;\n                font-size: 13px;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-table-item-handle {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--acu-text-sub);\n                cursor: grab;\n                opacity: 0.4;\n                transition: all 0.15s;\n                border-radius: 4px;\n            }\n            .acu-table-item-handle:hover {\n                opacity: 1;\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n            }\n            .acu-table-manager-item.acu-dragging {\n                opacity: 0.9;\n                background: var(--acu-accent);\n                border-color: var(--acu-accent);\n                box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n                z-index: 100;\n            }\n            .acu-table-manager-item.acu-dragging .acu-table-item-name,\n            .acu-table-manager-item.acu-dragging .acu-table-item-check,\n            .acu-table-manager-item.acu-dragging .acu-table-item-icon,\n            .acu-table-manager-item.acu-dragging .acu-table-item-handle {\n                color: #fff;\n            }\n            .acu-table-manager-item.acu-drag-above {\n                border-top: 2px solid var(--acu-accent);\n                margin-top: -1px;\n            }\n            .acu-table-manager-item.acu-drag-below {\n                border-bottom: 2px solid var(--acu-accent);\n                margin-bottom: -1px;\n            }\n            @media (max-width: 768px) {\n                .acu-table-item-handle {\n                    opacity: 0.6;\n                }\n            }\n            /* ç‰¹æ®ŠæŒ‰é’®æ ·å¼ï¼ˆæŠ•éª°/å®¡æ ¸/å˜é‡ï¼‰ */\n            .acu-table-manager-item.acu-special-item {\n                background: linear-gradient(135deg, rgba(var(--acu-accent-rgb, 128, 128, 128), 0.08), transparent);\n                border-style: dashed;\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-icon {\n                color: var(--acu-accent);\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-name {\n                font-weight: 500;\n            }\n            /* ========== æ•°æ®éªŒè¯è§„åˆ™æ ·å¼ ========== */\n            .acu-validation-rules-list {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                max-height: 280px;\n                overflow-y: auto;\n                padding: 2px;\n            }\n            .acu-validation-rule-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                transition: all 0.2s ease;\n            }\n            .acu-validation-rule-item.disabled {\n                opacity: 0.5;\n            }\n            .acu-validation-rule-item:hover {\n                border-color: var(--acu-accent);\n            }\n            .acu-rule-toggle {\n                cursor: pointer;\n                font-size: 18px;\n                color: var(--text-sub);\n                transition: all 0.2s;\n                flex-shrink: 0;\n                background: none;\n                border: none;\n                border-radius: 4px;\n                padding: 4px 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-rule-toggle:hover {\n                opacity: 0.8;\n            }\n            .acu-rule-toggle.active {\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-rule-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-rule-name {\n                font-size: 12px;\n                font-weight: 500;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-rule-target {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                margin-top: 2px;\n            }\n            .acu-rule-type-icon {\n                width: 20px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n                text-align: center;\n                background: none !important;\n            }\n            .acu-rule-delete {\n                background: none;\n                border: none;\n                color: var(--text-sub);\n                cursor: pointer;\n                padding: 4px;\n                opacity: 0.6;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-delete:hover {\n                color: #e74c3c;\n                opacity: 1;\n            }\n            .acu-rule-edit {\n                background: none;\n                border: none;\n                color: var(--text-sub);\n                cursor: pointer;\n                padding: 4px;\n                opacity: 0.6;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-edit:hover {\n                color: var(--accent-color);\n                opacity: 1;\n            }\n            .acu-rule-delete:hover {\n                color: #e74c3c;\n                opacity: 1;\n            }\n            .acu-rule-intercept {\n                cursor: pointer;\n                font-size: 14px;\n                color: var(--acu-text-sub);\n                padding: 4px 6px;\n                border-radius: 4px;\n                opacity: 0.5;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-intercept:hover {\n                opacity: 0.8;\n                background: var(--acu-hover-bg);\n            }\n            .acu-rule-intercept.active {\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-add-rule-btn {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                width: 100%;\n                padding: 10px;\n                margin-top: 8px;\n                background: var(--acu-btn-bg);\n                border: 1px dashed var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-add-rule-btn:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n                background: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.1);\n            }\n            /* éªŒè¯è§„åˆ™å¼¹çª— */\n            .acu-validation-modal-overlay {\n                z-index: 2147483659;\n            }\n            .acu-validation-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 420px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-validation-modal-body {\n                padding: 16px;\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                max-height: 60vh;\n                overflow-y: auto;\n            }\n            .acu-validation-modal-body .acu-setting-row {\n                flex-wrap: wrap;\n            }\n            .acu-validation-modal-body .acu-panel-input,\n            .acu-validation-modal input[type="text"],\n            .acu-validation-modal input[type="number"],\n            .acu-validation-modal select {\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                padding: 8px 10px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n            }\n            .acu-validation-modal-body .acu-panel-input:focus,\n            .acu-validation-modal input[type="text"]:focus,\n            .acu-validation-modal input[type="number"]:focus,\n            .acu-validation-modal select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-validation-modal-body .acu-panel-input::placeholder,\n            .acu-validation-modal input[type="text"]::placeholder,\n            .acu-validation-modal input[type="number"]::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-validation-modal select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-validation-modal select option[value=""] {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-rule-config-section {\n                padding: 8px 0;\n            }\n            .acu-validation-modal-footer {\n                display: flex;\n                justify-content: center;\n                gap: 12px;\n                padding: 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-validation-modal-footer .acu-btn {\n                flex: 1;\n                padding: 10px 12px !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n            }\n            /* æ™ºèƒ½ä¿®æ”¹å¼¹çª—æ ·å¼ */\n            .acu-smart-fix-meta {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 0 !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-separator {\n                color: var(--acu-border) !important;\n                opacity: 0.5 !important;\n            }\n            .acu-smart-fix-diff {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                padding: 6px 0 !important;\n                margin: 4px 0 !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-diff-old-text {\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n                font-size: 13px !important;\n                white-space: nowrap !important;\n                overflow: hidden !important;\n                text-overflow: ellipsis !important;\n                max-width: 150px !important;\n            }\n            .acu-smart-fix-diff-arrow {\n                color: var(--acu-text-sub) !important;\n                flex-shrink: 0 !important;\n            }\n            .acu-smart-fix-empty {\n                opacity: 0.5 !important;\n                font-style: italic !important;\n            }\n            .acu-smart-fix-diff-input-wrapper {\n                flex: 1 !important;\n                min-width: 120px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input,\n            .acu-smart-fix-diff-input-wrapper select {\n                width: 100% !important;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                padding: 4px 8px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n                -moz-appearance: none !important;\n                appearance: none !important;\n                min-height: 26px !important;\n                line-height: 1.3 !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input:focus,\n            .acu-smart-fix-diff-input-wrapper select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select {\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23666' d='M5 7L1 3h8z'/%3E%3C/svg%3E") !important;\n                background-repeat: no-repeat !important;\n                background-position: right 6px center !important;\n                padding-right: 24px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select option {\n                background: var(--acu-card-bg) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-suggest {\n                padding: 10px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-suggest-label {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                margin-bottom: 6px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 4px !important;\n            }\n            .acu-smart-fix-suggest-label i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-suggest-value {\n                font-size: 13px !important;\n                color: var(--acu-success-text) !important;\n                font-weight: 500 !important;\n                padding: 6px 8px !important;\n                background: var(--acu-success-bg) !important;\n                border-radius: 4px !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-suggest-value:hover {\n                background: var(--acu-success-text) !important;\n                color: white !important;\n            }\n            .acu-smart-fix-suggest-options {\n                display: flex !important;\n                flex-wrap: wrap !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-suggest-options-scroll {\n                max-height: 120px !important;\n                overflow-y: auto !important;\n                padding-right: 4px !important;\n            }\n            .acu-smart-fix-option {\n                display: inline-block !important;\n                font-size: 12px !important;\n                padding: 4px 10px !important;\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                color: var(--acu-text-main) !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-option:hover {\n                background: var(--acu-btn-hover) !important;\n                border-color: var(--acu-accent) !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-option-current {\n                background: var(--acu-hl-manual-bg) !important;\n                border-color: var(--acu-hl-manual) !important;\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n            }\n            .acu-smart-fix-error-hint {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-card-bg) !important;\n                border-radius: 4px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-error-hint i {\n                color: var(--acu-accent) !important;\n                flex-shrink: 0 !important;\n            }\n            @media (max-width: 600px) {\n                .acu-smart-fix-diff {\n                    flex-direction: column !important;\n                    align-items: stretch !important;\n                }\n                .acu-smart-fix-diff-arrow {\n                    transform: rotate(90deg) !important;\n                }\n            }\n            .acu-btn {\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid transparent;\n            }\n            .acu-btn-secondary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-btn-secondary:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-btn-primary {\n                background: var(--acu-accent);\n                color: white;\n            }\n            .acu-btn-primary:hover {\n                opacity: 0.9;\n            }\n            /* æ™ºèƒ½ä¿®æ”¹å¼¹çª—æ–°å¢æ ·å¼ */\n            .acu-smart-fix-rule-info {\n                padding: 10px 12px !important;\n                background: var(--acu-table-head) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-left: 3px solid var(--acu-accent) !important;\n                border-radius: 4px !important;\n                margin-bottom: 12px !important;\n            }\n            .acu-smart-fix-rule-header {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                font-size: 13px !important;\n                font-weight: 600 !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-rule-header i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-rule-desc {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                line-height: 1.4 !important;\n            }\n            .acu-smart-fix-suggest-section {\n                margin-top: 12px !important;\n            }\n            .acu-smart-fix-suggest code {\n                background: var(--acu-table-head) !important;\n                padding: 2px 6px !important;\n                border-radius: 3px !important;\n                font-size: 11px !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-quick-btn {\n                display: inline-flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                padding: 6px 12px !important;\n                background: var(--acu-accent) !important;\n                color: var(--acu-btn-active-text) !important;\n                border: 1px solid var(--acu-accent) !important;\n                border-radius: 4px !important;\n                font-size: 12px !important;\n                font-weight: 500 !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-quick-btn:hover {\n                background: var(--acu-btn-active-bg) !important;\n                color: var(--acu-btn-active-text) !important;\n                border-color: var(--acu-btn-active-bg) !important;\n            }\n            .acu-smart-fix-table-summary {\n                padding: 12px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n            }\n            .acu-smart-fix-stat {\n                font-size: 13px !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 8px !important;\n            }\n            .acu-smart-fix-stat strong {\n                color: var(--acu-hl-manual) !important;\n            }\n            .acu-smart-fix-change-list {\n                max-height: 150px !important;\n                overflow-y: auto !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-change-item {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 3px !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-hint {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 4px !important;\n                margin-top: 8px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-hint i {\n                color: var(--acu-accent) !important;\n            }\n            /* ========== å¤´åƒè£å‰ªå¼¹çª—æ ·å¼ ========== */\n            .acu-crop-modal-overlay {\n                z-index: 2147483658;\n            }\n            .acu-crop-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 360px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-crop-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-crop-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                font-size: 16px;\n                cursor: pointer;\n                padding: 4px;\n            }\n            .acu-crop-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-crop-body {\n                padding: 20px;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 12px;\n            }\n            .acu-crop-container {\n                position: relative;\n                width: 200px;\n                height: 200px;\n                border-radius: 50%;\n                overflow: hidden;\n                touch-action: none;\n                user-select: none;\n            }\n            .acu-crop-image {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-repeat: no-repeat;\n                cursor: grab;\n            }\n            .acu-crop-mask {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                border: 3px solid var(--acu-accent);\n                border-radius: 50%;\n                pointer-events: none;\n                box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);\n            }\n            .acu-crop-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-crop-footer {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-top: 1px solid var(--acu-border);\n            }\n            .acu-crop-btn {\n                flex: 1;\n                padding: 10px 16px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-crop-cancel {\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-crop-cancel:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-crop-confirm {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: #fff;\n            }\n            .acu-crop-confirm:hover {\n                opacity: 0.9;\n            }\n            .acu-crop-reupload {\n                flex: 0 0 auto;\n                padding: 10px 14px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-crop-reupload:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n    </style>\n    `;$('head').append(e)},ln=()=>{const e=ut().getDB();if(!e||!e.exportTableAsJson)return console.warn('[DICE]æ•°æ®åº“ API ä¸å¯ç”¨ï¼Œæ— æ³•è·å–è¡¨æ ¼æ•°æ®'),null;try{const t=e.exportTableAsJson();if(t){const e=Object.keys(t).filter(e=>e.startsWith('sheet_')).length;console.info(`[DICE]å·²åŠ è½½è¡¨æ ¼æ•°æ®ï¼ŒåŒ…å« ${e} ä¸ªå·¥ä½œè¡¨`)}return t}catch(e){return console.error('[DICE]è·å–è¡¨æ ¼æ•°æ®å¤±è´¥:',e),null}},dn=async(e,t=!1,n=!1)=>{if(Ve)return void console.warn('[DICE]ä¿å­˜æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡é‡å¤è¯·æ±‚');console.info('[DICE]å¼€å§‹ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“...'),Ve=!0;const{$}=ut(),a=$('#acu-btn-save-global');!t&&a.length&&(a.find('i').removeClass('fa-save').addClass('fa-spinner fa-spin'),a.prop('disabled',!0));try{const a={};if(e.mate?a.mate=e.mate:a.mate={type:'chatSheets',version:1},Object.keys(e).forEach(t=>{t.startsWith('sheet_')&&(a[t]=e[t])}),n){const e=vt();Object.keys(e).forEach(t=>{a[t]&&a[t].content&&e[t].sort((e,t)=>t-e).forEach(e=>{a[t].content[e+1]&&a[t].content.splice(e+1,1)})}),xt({})}let i;try{i=JSON.stringify(a);const e=new Blob([i]).size/1048576;if(e>10)throw new Error(`æ•°æ®å¤ªå¤§ (${e.toFixed(2)}MB)ï¼Œè¶…è¿‡ 10MB é™åˆ¶`);console.info(`[DICE]æ•°æ®åºåˆ—åŒ–å®Œæˆï¼Œå¤§å°: ${e.toFixed(2)}MB`)}catch(e){throw console.error('[DICE]ACU JSON åºåˆ—åŒ–å¤±è´¥:',e),new Error(`æ•°æ®åºåˆ—åŒ–å¤±è´¥: ${e.message||e}`)}const o=ut().getDB();if(!o||!o.importTableAsJson)throw new Error('æ•°æ®åº“ API ä¸å¯ç”¨');try{if(!1===await o.importTableAsJson(i))throw new Error('æ•°æ®å¯¼å…¥å¤±è´¥ï¼ˆè¿”å› falseï¼‰');console.info('[DICE]æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“')}catch(e){console.error('[DICE]ACU API ä¿å­˜å¤±è´¥:',e);const t=e.message||String(e);if(t.includes('Settings could not be saved')||t.includes('server connection')||t.includes('data loss'))throw new Error('ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨è¿æ¥é—®é¢˜æˆ–æ•°æ®è¿‡å¤§ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å‡å°‘æ•°æ®é‡');throw new Error(`ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥: ${t}`)}Je=a,_t(a),Ke=!1,He=new Set,window.acuModifiedSet&&window.acuModifiedSet.clear(),console.info('[DICE]æœ¬åœ°çŠ¶æ€å·²æ›´æ–°ï¼Œæœªä¿å­˜æ›´æ”¹å·²æ¸…é™¤'),t||Sn()}catch(e){const t=e.message||'ä¿å­˜å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼å’Œå¤§å°';throw console.error('[DICE]ä¿å­˜æ•°æ®å¤±è´¥:',{error:e,message:t,stack:e.stack}),window.toastr?window.toastr.error(t,'ä¿å­˜å¤±è´¥',{timeOut:5e3}):alert(`ä¿å­˜å¤±è´¥: ${t}`),e}finally{Ve=!1,console.info('[DICE]ä¿å­˜æ“ä½œå®Œæˆ'),!t&&a.length&&(a.find('i').removeClass('fa-spinner fa-spin').addClass('fa-save'),a.prop('disabled',!1))}},un=async e=>{try{const t={};let n;e.mate?t.mate=e.mate:t.mate={type:'chatSheets',version:1},Object.keys(e).forEach(n=>{n.startsWith('sheet_')&&(t[n]=e[n])});try{n=JSON.stringify(t);const e=new Blob([n]).size/1048576;if(e>10)throw new Error(`æ•°æ®å¤ªå¤§ (${e.toFixed(2)}MB)ï¼Œè¶…è¿‡ 10MB é™åˆ¶`)}catch(e){throw console.error('[DICE]ACU JSON åºåˆ—åŒ–å¤±è´¥:',e),new Error(`æ•°æ®åºåˆ—åŒ–å¤±è´¥: ${e.message||e}`)}const a=ut().getDB();if(!a||!a.importTableAsJson)throw new Error('æ•°æ®åº“ API ä¸å¯ç”¨');try{if(!1===await a.importTableAsJson(n))throw new Error('æ•°æ®å¯¼å…¥å¤±è´¥ï¼ˆè¿”å› falseï¼‰')}catch(e){console.error('[DICE]ACU API ä¿å­˜å¤±è´¥:',e);const t=e.message||String(e);if(t.includes('Settings could not be saved')||t.includes('server connection')||t.includes('data loss'))throw new Error('ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨è¿æ¥é—®é¢˜æˆ–æ•°æ®è¿‡å¤§ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å‡å°‘æ•°æ®é‡');throw new Error(`ä¿å­˜åˆ°æ•°æ®åº“å¤±è´¥: ${t}`)}Je=t}catch(e){throw console.error('[DICE]ACU saveDataOnly error:',e),e}},pn=e=>{const t={};if(!e||'object'!=typeof e)return t;for(const n in e)if(e[n]?.name){const a=e[n];t[a.name]={key:n,headers:a.content&&a.content[0]||[],rows:a.content?a.content.slice(1):[],rawContent:a.content||[],exportConfig:a.exportConfig||{},updateConfig:a.updateConfig||{},...a}}return t};const gn=()=>{const{$}=ut(),e=$('.acu-settings-dialog');if(!e.length)return;const t=e.find('#regex-rules-list');if(!t.length)return;const n=Q.getAllRules().map(e=>{const t='global'===e.scope.type?'fa-globe':'table'===e.scope.type?'fa-table':'fa-columns',n='global'===e.scope.type?'å…¨å±€':'table'===e.scope.type?e.scope.tableNames?.join(','):`${e.scope.tableNames?.join(',')}.${e.scope.columnNames?.join(',')}`;return`\n          <div class="acu-validation-rule-item ${e.enabled?'':'disabled'}" data-rule-id="${o(e.id)}">\n              <div class="acu-rule-type-icon" title="ä½œç”¨åŸŸ: ${o(e.scope.type)}">\n                  <i class="fa-solid ${t}"></i>\n              </div>\n              <div class="acu-rule-info">\n                  <div class="acu-rule-name">${o(e.name)}</div>\n                  <div class="acu-rule-target" style="font-size:10px;">${o(n)} | ${o(e.operation)}</div>\n              </div>\n              <button class="acu-rule-edit" data-rule-id="${o(e.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n              <div class="acu-rule-toggle ${e.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n                  <i class="fa-solid ${e.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n              </div>\n              <button class="acu-rule-delete" data-rule-id="${o(e.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n          </div>\n      `}).join('');t.html(n)},fn=e=>{const{$}=ut(),t=`acu-theme-${an().theme}`,n=Je||ln(),a=pn(n||{}),i=Object.keys(a),r=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${t}">\n          <div class="acu-dice-cfg-header">\n            <span><i class="fa-solid fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰éªŒè¯è§„åˆ™</span>\n            <button class="acu-config-close" id="dlg-rule-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-validation-modal-body">\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™åç§°</span></div>\n              <input type="text" id="rule-name" class="acu-panel-input" placeholder="å¦‚ï¼šç‰©å“æ•°é‡é™åˆ¶" style="flex:1;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">ç›®æ ‡è¡¨æ ¼</span></div>\n              <select id="rule-table" class="acu-setting-select">\n                <option value="">è¯·é€‰æ‹©...</option>\n                ${i.map(e=>`<option value="${o(e)}">${o(e)}</option>`).join('')}\n              </select>\n            </div>\n            <div class="acu-setting-row" id="row-column">\n              <div class="acu-setting-info"><span class="acu-setting-label">ç›®æ ‡åˆ—</span></div>\n              <select id="rule-column" class="acu-setting-select" disabled>\n                <option value="">è¯·å…ˆé€‰æ‹©è¡¨æ ¼...</option>\n              </select>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™ç±»å‹</span></div>\n              <select id="rule-type" class="acu-setting-select">\n                <optgroup label="â”€â”€ è¡¨çº§è§„åˆ™ â”€â”€">\n                  <option value="tableReadonly">è¡¨çº§åªè¯»ï¼ˆç¦æ­¢ä¿®æ”¹ï¼‰</option>\n                  <option value="rowLimit">è¡Œæ•°é™åˆ¶</option>\n                  <option value="sequence">åºåˆ—é€’å¢</option>\n                </optgroup>\n                <optgroup label="â”€â”€ å­—æ®µçº§è§„åˆ™ â”€â”€">\n                  <option value="required">å¿…å¡«</option>\n                  <option value="format">æ ¼å¼éªŒè¯ï¼ˆæ­£åˆ™ï¼‰</option>\n                  <option value="enum">æšä¸¾éªŒè¯ï¼ˆå¯é€‰å€¼ï¼‰</option>\n                  <option value="numeric">æ•°å€¼èŒƒå›´</option>\n                  <option value="relation">å…³è”éªŒè¯ï¼ˆå¼•ç”¨å…¶ä»–è¡¨ï¼‰</option>\n                  <option value="keyValue">é”®å€¼å¯¹éªŒè¯</option>\n                </optgroup>\n              </select>\n            </div>\n            \x3c!-- è¡¨çº§åªè¯»æ— éœ€é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-tableReadonly">\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> å¯ç”¨å,è¯¥è¡¨å°†ä¸å…è®¸ä»»ä½•ä¿®æ”¹\n              </div>\n            </div>\n            \x3c!-- è¡Œæ•°é™åˆ¶é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-rowLimit" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">æœ€å°‘è¡Œæ•°</span></div>\n                <input type="number" id="cfg-row-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">æœ€å¤šè¡Œæ•°</span></div>\n                <input type="number" id="cfg-row-max" class="acu-panel-input" placeholder="ä¸é™" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- åºåˆ—é€’å¢é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-sequence" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">ç¼–ç å‰ç¼€</span></div>\n                <input type="text" id="cfg-sequence-prefix" class="acu-panel-input" placeholder="å¦‚ï¼šAM" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">èµ·å§‹æ•°å­—</span></div>\n                <input type="number" id="cfg-sequence-start" class="acu-panel-input" placeholder="1" value="1" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">é…å¯¹è¡¨ï¼ˆå¯é€‰ï¼‰</span></div>\n                <select id="cfg-sequence-paired-table" class="acu-setting-select" style="flex:1;">\n                  <option value="">æ— ï¼ˆå•è¡¨ä¿®å¤ï¼‰</option>\n                  ${i.map(e=>`<option value="${o(e)}">${o(e)}</option>`).join('')}\n                </select>\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> æ£€æŸ¥æŒ‡å®šåˆ—çš„å€¼æ˜¯å¦ä»"å‰ç¼€+èµ·å§‹æ•°å­—"å¼€å§‹ä¸¥æ ¼é€’å¢(å¦‚AM0001, AM0002, AM0003...),ä¸å¯è·³å·æˆ–é‡å¤ã€‚éœ€è¦æŒ‡å®šç›®æ ‡åˆ—ã€‚<br>\n                <i class="fa-solid fa-link" style="margin-top:4px;display:block;color:var(--acu-warning-icon);margin-right:6px;"></i> å¦‚æœè®¾ç½®äº†é…å¯¹è¡¨,ä¿®å¤æ—¶ä¼šåŒæ—¶ä¿®å¤ä¸¤ä¸ªè¡¨çš„ç¼–ç ,ç¡®ä¿ç›¸åŒç¼–ç å€¼ä¿®å¤åä»ç„¶ç›¸åŒã€‚\n              </div>\n            </div>\n            \x3c!-- å¿…å¡«æ— éœ€é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-required" style="display:none;">\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> è¯¥å­—æ®µä¸èƒ½ä¸ºç©º\n              </div>\n            </div>\n            \x3c!-- æ ¼å¼éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-format" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">æ­£åˆ™è¡¨è¾¾å¼</span></div>\n                <input type="text" id="cfg-pattern" class="acu-panel-input" placeholder="å¦‚ï¼š^AM\\d{3}$" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- æšä¸¾éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-enum" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å…è®¸çš„å€¼</span></div>\n                <input type="text" id="cfg-values" class="acu-panel-input" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼šè¿›è¡Œä¸­,å·²å®Œæˆ,å·²å¤±è´¥" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- æ•°å€¼èŒƒå›´é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-numeric" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">æœ€å°å€¼</span></div>\n                <input type="number" id="cfg-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">æœ€å¤§å€¼</span></div>\n                <input type="number" id="cfg-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- å…³è”éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-relation" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å…³è”è¡¨æ ¼</span></div>\n                <select id="cfg-ref-table" class="acu-setting-select">\n                  <option value="">è¯·é€‰æ‹©...</option>\n                  ${i.map(e=>`<option value="${o(e)}">${o(e)}</option>`).join('')}\n                </select>\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å…³è”åˆ—</span></div>\n                <select id="cfg-ref-column" class="acu-setting-select" multiple style="flex:1;min-height:80px;">\n                  <option value="">è¯·å…ˆé€‰æ‹©å…³è”è¡¨æ ¼...</option>\n                </select>\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> å¯é€‰æ‹©å¤šåˆ—,ä»»ä¸€åˆ—åŒ¹é…å³é€šè¿‡éªŒè¯(OR é€»è¾‘)ã€‚ä½¿ç”¨ Ctrl/Cmd é”®å¯é€‰æ‹©å¤šä¸ªåˆ—ã€‚\n              </div>\n            </div>\n            \x3c!-- é”®å€¼å¯¹éªŒè¯é…ç½® --\x3e\n            <div class="acu-rule-config-section" id="config-keyValue" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">å€¼ç±»å‹</span></div>\n                <select id="cfg-keyvalue-type" class="acu-setting-select">\n                  <option value="text">æ–‡æœ¬å‹ï¼ˆåªéªŒè¯æ ¼å¼ï¼‰</option>\n                  <option value="numeric">æ•°å€¼å‹ï¼ˆéªŒè¯æ ¼å¼å’Œæ•°å€¼èŒƒå›´ï¼‰</option>\n                </select>\n              </div>\n              <div class="acu-setting-row" id="row-keyvalue-range" style="display:none;">\n                <div class="acu-setting-info"><span class="acu-setting-label">æœ€å°å€¼</span></div>\n                <input type="number" id="cfg-keyvalue-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">æœ€å¤§å€¼</span></div>\n                <input type="number" id="cfg-keyvalue-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n              <div style="font-size:12px;color:var(--acu-warning-text);padding:10px 12px;background:var(--acu-warning-bg);border-left:3px solid var(--acu-warning-icon);border-radius:6px;line-height:1.5;margin-top:8px;">\n                <i class="fa-solid fa-info-circle" style="color:var(--acu-warning-icon);margin-right:6px;"></i> æ ¼å¼:é”®:å€¼;é”®:å€¼(ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹,è‡ªåŠ¨å»é™¤ç©ºæ ¼)ã€‚æ•°å€¼å‹ä¼šéªŒè¯æ¯ä¸ªå€¼çš„èŒƒå›´ã€‚\n              </div>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">é”™è¯¯æç¤º</span></div>\n              <input type="text" id="rule-error-msg" class="acu-panel-input" placeholder="éªŒè¯å¤±è´¥æ—¶æ˜¾ç¤ºçš„æç¤ºä¿¡æ¯" style="flex:1;">\n            </div>\n          </div>\n          <div class="acu-dice-cfg-actions">\n            <button id="dlg-rule-cancel">å–æ¶ˆ</button>\n            <button id="dlg-rule-save">æ·»åŠ </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(r);const c=e=>{const t=e.val();t&&''!==t?(e.css('color','var(--acu-text-main)'),e.css('opacity','1')):(e.css('color','var(--acu-text-sub)'),e.css('opacity','0.7'))};r.find('select').each(function(){c($(this)),$(this).on('change',function(){c($(this))})}),r.find('#rule-table').on('change',function(){const e=$(this).val(),t=r.find('#rule-column'),n=r.find('#cfg-sequence-paired-table');if(c($(this)),n.length>0){const t=n.val();n.empty(),n.append('<option value="">æ— ï¼ˆå•è¡¨ä¿®å¤ï¼‰</option>'),i.filter(t=>t!==e).forEach(e=>{n.append(`<option value="${o(e)}">${o(e)}</option>`)}),t&&t!==e&&n.val(t),c(n)}if(!e||!a[e])return t.html('<option value="">è¯·å…ˆé€‰æ‹©è¡¨æ ¼...</option>').prop('disabled',!0),void c(t);const s=(a[e].headers||[]).filter((e,t)=>t>0&&e).map(e=>`<option value="${o(e)}">${o(e)}</option>`).join('');t.html('<option value="">è¯·é€‰æ‹©...</option>'+s).prop('disabled',!1),c(t)}),r.find('#cfg-ref-table').on('change',function(){const e=$(this).val(),t=r.find('#cfg-ref-column');if(c($(this)),!e||!a[e])return t.html('<option value="">è¯·å…ˆé€‰æ‹©å…³è”è¡¨æ ¼...</option>').prop('disabled',!0),void c(t);const n=(a[e].headers||[]).filter((e,t)=>t>0&&e).map(e=>`<option value="${o(e)}">${o(e)}</option>`).join('');t.html(n).prop('disabled',!1),c(t)}),r.find('#rule-type').on('change',function(){const e=$(this).val(),t=V[e],n='table'===t?.scope;c($(this)),r.find('.acu-rule-config-section').hide(),r.find('#config-'+e).show(),n&&'sequence'!==e?(r.find('#row-column').hide(),r.find('#rule-column').val('').prop('disabled',!0)):(r.find('#row-column').show(),r.find('#rule-table').val()&&r.find('#rule-column').prop('disabled',!1))}),r.find('#cfg-keyvalue-type').on('change',function(){'numeric'===$(this).val()?r.find('#row-keyvalue-range').show():r.find('#row-keyvalue-range').hide()});const s=()=>r.remove();r.on('click','#dlg-rule-close, #dlg-rule-cancel',s),r.on('click',function(e){$(e.target).hasClass('acu-validation-modal-overlay')&&s()}),r.find('#dlg-rule-save').on('click',function(){const t=r.find('#rule-name').val()?.trim(),n=r.find('#rule-table').val(),a=r.find('#rule-column').val(),i=r.find('#rule-type').val(),c=r.find('#rule-error-msg').val()?.trim(),l=V[i],d='table'===l?.scope;if(!t)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥è§„åˆ™åç§°'));if(!n)return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©ç›®æ ‡è¡¨æ ¼'));if(!(d&&'sequence'!==i||a))return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©ç›®æ ‡åˆ—'));const u={};if('tableReadonly'===i);else if('rowLimit'===i){const e=r.find('#cfg-row-min').val(),t=r.find('#cfg-row-max').val();''!==e&&(u.min=parseInt(e,10)),''!==t&&(u.max=parseInt(t,10))}else if('required'===i);else if('format'===i){const e=r.find('#cfg-pattern').val()?.trim();if(!e)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥æ­£åˆ™è¡¨è¾¾å¼'));try{new RegExp(e)}catch(e){return void(window.toastr&&window.toastr.error('æ­£åˆ™è¡¨è¾¾å¼æ— æ•ˆ'))}u.pattern=e}else if('enum'===i){const e=r.find('#cfg-values').val()?.trim();if(!e)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥å…è®¸çš„å€¼'));u.values=e.split(',').map(e=>e.trim()).filter(e=>e)}else if('numeric'===i){const e=r.find('#cfg-min').val(),t=r.find('#cfg-max').val();''!==e&&(u.min=parseFloat(e)),''!==t&&(u.max=parseFloat(t))}else if('relation'===i){const e=r.find('#cfg-ref-table').val(),t=r.find('#cfg-ref-column').val();if(!e)return void(window.toastr&&window.toastr.warning('è¯·é€‰æ‹©å…³è”è¡¨æ ¼'));const n=Array.isArray(t)?t:t?[t]:[];if(0===n.length||1===n.length&&!n[0])return void(window.toastr&&window.toastr.warning('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—ä½œä¸ºå…³è”åˆ—'));u.refTable=e,u.refColumn=1===n.length?n[0]:n}else if('keyValue'===i){const e=r.find('#cfg-keyvalue-type').val();if(u.valueType=e||'text','numeric'===e){const e=r.find('#cfg-keyvalue-min').val(),t=r.find('#cfg-keyvalue-max').val();''!==e&&(u.valueMin=parseFloat(e)),''!==t&&(u.valueMax=parseFloat(t))}}else if('sequence'===i){const e=r.find('#cfg-sequence-prefix').val()?.trim()||'',t=r.find('#cfg-sequence-start').val(),n=r.find('#cfg-sequence-paired-table').val()?.trim()||null;if(u.prefix=e,u.startFrom=''!==t?parseInt(t,10):1,isNaN(u.startFrom))return void(window.toastr&&window.toastr.warning('èµ·å§‹æ•°å­—å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—'));n&&(u.pairedTable=n)}const p='custom_'+Date.now()+'_'+Math.random().toString(36).substr(2,6),g={id:p,name:t,description:'',targetTable:n,targetColumn:d&&'sequence'!==i?'':a,ruleType:i,config:u,errorMessage:c||l?.desc||'æ•°æ®éªŒè¯å¤±è´¥',intercept:!1};if(Z.addCustomRule(g)){s();const r=e.find('#validation-rules-list'),c=`\n          <div class="acu-validation-rule-item" data-rule-id="${o(p)}">\n            <div class="acu-rule-type-icon" title="${o(l?.name||i)}${d?' (è¡¨çº§)':''}">\n              <i class="fa-solid ${l?.icon||'fa-question'}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${o(t)}</div>\n              <div class="acu-rule-target">${o(n)}${d&&'sequence'!==i?' (æ•´è¡¨)':'.'+o(a)}</div>\n            </div>\n            <div class="acu-rule-intercept" data-rule-id="${o(p)}" title="ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰"><i class="fa-solid fa-shield-halved"></i></div>\n            <div class="acu-rule-toggle active" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n              <i class="fa-solid fa-toggle-on"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${o(p)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n          </div>\n        `;r.append(c)}else window.toastr&&window.toastr.error('è§„åˆ™æ·»åŠ å¤±è´¥')})},bn=e=>{if(!e||!e.rule)return void(window.toastr&&window.toastr.warning('æ— æ³•è·å–è§„åˆ™ä¿¡æ¯'));const{$}=ut(),t=`acu-theme-${an().theme}`,n=e.rule,a=e.ruleType||n.ruleType,i=V[a]||{name:a,icon:'fa-question'},r='table'===i?.scope,c=Je||ln(),s=Ct();if(!e.rowTitle&&e.rowIndex>=0&&c&&e.tableName)for(const t in c)if(c[t]?.name===e.tableName){const n=c[t].content?.[e.rowIndex+1];n&&(e.rowTitle=n[1]||n[0]||`è¡Œ ${e.rowIndex+1}`);break}let l='';if(!r&&s&&e.tableName&&void 0!==e.columnName)for(const t in s)if(s[t]?.name===e.tableName){const n=(s[t].content?.[0]||[]).indexOf(e.columnName),a=e.rowIndex+1;n>=0&&s[t].content?.[a]&&(l=s[t].content[a][n]??'');break}const d=''!==l&&String(l)!==String(e.currentValue||'');if(r)return void xn(e,n,a,c,s,t);let u='';u=('enum'===a&&n.config?.values||'relation'===a&&n.config?.refTable&&n.config?.refColumn||'numeric'===a||'format'===a&&n.config,`<textarea id="smart-fix-value" class="acu-edit-textarea" spellcheck="false"\n        style="width:100%;min-height:60px;max-height:200px;resize:none;">${o(e.currentValue||'')}</textarea>`);let p='';if('required'===a){const t=function(e,t,n,a,i=5){const o=new Set;if(!e||!t||!a)return[];for(const i in a)if(a[i]?.name===e){const e=a[i].content?.[0]||[],r=a[i].content?.slice(1)||[],c=e.indexOf(t);c>=0&&r.forEach((e,t)=>{if(t!==n){const t=e?.[c];null!=t&&''!==String(t).trim()&&o.add(String(t).trim())}});break}return Array.from(o).slice(0,i)}(e.tableName,e.columnName,e.rowIndex,c,5);t.length>0&&(p=`\n          <div class="acu-smart-fix-suggest">\n            <div class="acu-smart-fix-suggest-label">\n              <i class="fa-solid fa-lightbulb"></i> åŒåˆ—ç¤ºä¾‹å€¼:\n            </div>\n            <div class="acu-smart-fix-suggest-options">\n              ${t.map(e=>`\n                <span class="acu-smart-fix-option" data-value="${o(e)}" title="ç‚¹å‡»å¡«å……">\n                  ${o(e.length>20?e.substring(0,20)+'...':e)}\n                </span>\n              `).join('')}\n            </div>\n          </div>\n        `)}else if('enum'===a&&n.config?.values){p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-list"></i> å…è®¸çš„å€¼ (ç‚¹å‡»é€‰æ‹©):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll">\n            ${n.config.values.map(t=>`\n              <span class="acu-smart-fix-option ${e.currentValue===t?'acu-smart-fix-option-current':''}"\n                    data-value="${o(t)}" title="${e.currentValue===t?'å½“å‰å€¼ï¼ˆæ— æ•ˆï¼‰':'ç‚¹å‡»é€‰æ‹©'}">\n                ${o(t)}\n              </span>\n            `).join('')}\n          </div>\n        </div>\n      `}else if('format'===a&&n.config?.pattern){let t=null;if(c&&e.tableName)for(const n in c)if(c[n]?.name===e.tableName){t=c[n];break}const a=function(e,t,n=[],a=null){if(!e||void 0===t||t<0)return null;try{const n=e.match(/^\^?([A-Za-z]+)\\d\{(\d+)\}\$?$/);if(n){const e=n[1],i=parseInt(n[2],10);if(a&&('æ€»ç»“è¡¨'===a.name||'æ€»ä½“å¤§çº²'===a.name)){const t=a.content?.[0]||[],n=a.content?.slice(1)||[],o=t.indexOf('ç¼–ç ç´¢å¼•');if(o>=0){const t=[];n.forEach(n=>{const a=n?.[o];if(a&&'string'==typeof a){const n=a.match(new RegExp(`^${e}(\\d+)$`));if(n){const e=parseInt(n[1],10);isNaN(e)||t.push(e)}}});const a=t.length>0?Math.max(...t):0,r=String(a+1).padStart(i,'0');return e+r}}const o=String(t+1).padStart(i,'0');return e+o}const i=e.match(/^\^?\\d\{(\d+)\}\$?$/);if(i){const e=parseInt(i[1],10);return String(t+1).padStart(e,'0')}}catch(e){console.error('[DICE]ACU æ ¼å¼æ¨ç®—å¤±è´¥:',e)}return null}(n.config.pattern,e.rowIndex,[],t);p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-font"></i> æ ¼å¼è¦æ±‚: <code>${o(n.config.pattern)}</code>\n          </div>\n          ${a?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-suggest-label" style="margin-bottom:4px;display:block;">\n                <i class="fa-solid fa-lightbulb"></i> æ¨èå€¼:\n              </span>\n              <span class="acu-smart-fix-quick-btn" data-value="${o(a)}">\n                <i class="fa-solid fa-magic"></i> ${o(a)}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('numeric'===a){const t=n.config?.min,a=n.config?.max,i=parseFloat(e.currentValue),o=!isNaN(i)&&(void 0!==t&&i<t||void 0!==a&&i>a),r=o?function(e,t,n){const a=parseFloat(e);return isNaN(a)?void 0!==t?t:0:void 0!==t&&a<t?t:void 0!==n&&a>n?n:a}(e.currentValue,t,a):null;p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-hashtag"></i> å…è®¸èŒƒå›´: ${void 0!==t?t:'-âˆ'} ~ ${void 0!==a?a:'+âˆ'}\n          </div>\n          ${o&&null!==r?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${r}">\n                <i class="fa-solid fa-arrow-right"></i> ä¿®æ­£ä¸º ${r}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('relation'===a&&n.config?.refTable&&n.config?.refColumn){const t=function(e,t,n){const a=new Set;if(!e||!t||!n)return Array.from(a);const i=Array.isArray(t)?t:[t];for(const t in n)if(n[t]?.name===e){const e=n[t].content?.[0]||[],o=n[t].content?.slice(1)||[];i.forEach(t=>{const n=e.indexOf(t);n>=0&&o.forEach(e=>{const t=e?.[n];null!=t&&''!==String(t).trim()&&a.add(String(t).trim())})});break}return Array.from(a).sort()}(n.config.refTable,n.config.refColumn,c),a=Array.isArray(n.config.refColumn)?n.config.refColumn:[n.config.refColumn],i=a.length>1,r=String(e.currentValue||'').trim(),s=function(e,t,n,a){if(!(e&&t&&n&&a))return!1;if(''===String(e).trim())return!1;const i=Array.isArray(n)?n:[n],o=String(e).trim();for(const e in a)if(a[e]?.name===t){const t=a[e].content?.[0]||[],n=a[e].content?.slice(1)||[];for(const e of i){const a=t.indexOf(e);if(-1!==a)for(let e=0;e<n.length;e++){const t=n[e]?.[a];if(null!=t&&String(t).trim()===o)return!0}}break}return!1}(r,n.config.refTable,n.config.refColumn,c);let l='';t.length>0&&(l=`\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-link"></i> å…³è”è¡¨ "${o(n.config.refTable)}" å¯ç”¨å€¼ (${t.length}é¡¹):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll" id="smart-fix-options-container">\n            ${t.map(t=>`\n              <span class="acu-smart-fix-option ${e.currentValue===t?'acu-smart-fix-option-current':''}"\n                    data-value="${o(t)}" title="${e.currentValue===t?'å½“å‰å€¼ï¼ˆæ— æ•ˆï¼‰':'ç‚¹å‡»é€‰æ‹©'}">\n                ${o(t)}\n              </span>\n            `).join('')}\n          </div>\n        `);let d='';r&&!s&&(d=i?`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--acu-border);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> åå‘å†™å…¥åˆ°å…³è”è¡¨:\n              </div>\n              <div style="margin-top:8px;">\n                <select id="smart-fix-reverse-column" class="acu-edit-select" style="width:100%;margin-bottom:8px;">\n                  ${a.map(e=>`<option value="${o(e)}">${o(e)}</option>`).join('')}\n                </select>\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> å°† "${o(r.length>30?r.substring(0,30)+'...':r)}" å†™å…¥åˆ° "${o(n.config.refTable)}"\n                </button>\n              </div>\n            </div>\n          `:`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid var(--acu-border);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> åå‘å†™å…¥åˆ°å…³è”è¡¨:\n              </div>\n              <div style="margin-top:8px;">\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" data-column="${o(a[0])}" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> å°† "${o(r.length>30?r.substring(0,30)+'...':r)}" å†™å…¥åˆ° "${o(n.config.refTable)}.${o(a[0])}"\n                </button>\n              </div>\n            </div>\n          `),(l||d)&&(p=`\n          <div class="acu-smart-fix-suggest">\n            ${l}\n            ${d}\n          </div>\n        `)}else if('keyValue'===a){const t=n.config?.valueType||'text',a=n.config?.valueMin,i=n.config?.valueMax;let r=String(e.currentValue||'');r=r.replace(/ï¼š/g,':').replace(/ï¼›/g,';').replace(/ï¼Œ/g,';').replace(/\s+/g,'');const c=r.split(';').filter(e=>e.trim()),s=[],l=[];for(const e of c){const n=e.indexOf(':');if(-1===n||0===n||n===e.length-1){s.push({pair:e,error:'æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘å†’å·æˆ–é”®/å€¼ä¸ºç©º'});continue}const o=e.substring(0,n),r=e.substring(n+1);if(!o||!r){s.push({pair:e,error:'é”®æˆ–å€¼ä¸èƒ½ä¸ºç©º'});continue}let c=r,d=!1;if('numeric'===t){const t=parseFloat(r);isNaN(t)?(s.push({pair:e,error:`"${r}" ä¸æ˜¯æœ‰æ•ˆæ•°å­—`}),d=!0):null!=a&&t<a?(c=String(a),s.push({pair:e,error:`æ•°å€¼ ${t} å°äºæœ€å°å€¼ ${a}`}),d=!0):null!=i&&t>i&&(c=String(i),s.push({pair:e,error:`æ•°å€¼ ${t} å¤§äºæœ€å¤§å€¼ ${i}`}),d=!0)}l.push({key:o,val:c,originalVal:r,hasIssue:d})}const d=l.map(e=>`${e.key}:${e.val}`).join(';'),u=s.length>0||l.some(e=>e.hasIssue);let g='';u&&(g=`\n          <div class="acu-smart-fix-suggest-label" style="margin-bottom:8px;">\n            <i class="fa-solid fa-exclamation-triangle"></i> é—®é¢˜åˆ—è¡¨:\n          </div>\n          <div style="margin-bottom:8px;">\n            ${s.map(e=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">âŒ</span> ${o(e.pair)} - ${o(e.error)}\n              </div>\n            `).join('')}\n            ${l.filter(e=>e.hasIssue).map(e=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">âš ï¸</span> ${o(e.key)}:${o(e.originalVal)} â†’ ${o(e.val)}\n              </div>\n            `).join('')}\n          </div>\n        `),p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-key"></i> æ ¼å¼è¦æ±‚: é”®:å€¼;é”®:å€¼ï¼ˆä½¿ç”¨è‹±æ–‡æ ‡ç‚¹ï¼Œè‡ªåŠ¨å»é™¤ç©ºæ ¼ï¼‰\n          </div>\n          ${'numeric'===t?`\n            <div class="acu-smart-fix-suggest-label" style="margin-top:8px;">\n              <i class="fa-solid fa-hashtag"></i> æ•°å€¼èŒƒå›´: ${void 0!==a?a:'-âˆ'} ~ ${void 0!==i?i:'+âˆ'}\n            </div>\n          `:''}\n          ${g}\n          ${u?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${o(d)}">\n                <i class="fa-solid fa-magic"></i> ä¸€é”®ä¿®æ­£æ‰€æœ‰é—®é¢˜\n              </span>\n            </div>\n            <div style="margin-top:8px;padding:8px;background:var(--acu-card-bg);border-radius:4px;font-size:11px;color:var(--acu-text-sub);">\n              <div style="margin-bottom:4px;"><strong>ä¿®æ­£åé¢„è§ˆ:</strong></div>\n              <code style="color:var(--acu-success-text);">${o(d)}</code>\n            </div>\n          `:'\n            <div style="margin-top:8px;padding:8px;background:var(--acu-success-bg);border-radius:4px;font-size:11px;color:var(--acu-success-text);">\n              <i class="fa-solid fa-check-circle"></i> æ ¼å¼æ­£ç¡®\n            </div>\n          '}\n        </div>\n      `}const g=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${t}" style="max-width:450px;">\n          <div class="acu-edit-title">æ™ºèƒ½ä¿®æ”¹: ${o(e.tableName||'')} - ${o(e.columnName||'')}</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            \x3c!-- è§„åˆ™è¯´æ˜ --\x3e\n            <div class="acu-smart-fix-rule-info">\n              <div class="acu-smart-fix-rule-header">\n                <i class="fa-solid ${i.icon}"></i>\n                <span>${o(e.ruleName||n.name||'')}</span>\n              </div>\n              <div class="acu-smart-fix-rule-desc">${o(e.errorMessage||n.errorMessage||i.desc||'')}</div>\n            </div>\n\n            \x3c!-- å¿«ç…§å€¼ï¼ˆåªè¯»ï¼‰ --\x3e\n            ${d?`\n              <div class="acu-diff-section acu-diff-old-section">\n                <div class="acu-diff-label">\n                  <i class="fa-solid fa-clock-rotate-left"></i> å¿«ç…§å€¼ï¼ˆåŸå§‹ï¼‰\n                </div>\n                <div class="acu-diff-readonly">${o(l)}</div>\n              </div>\n              <div class="acu-diff-arrow-down"><i class="fa-solid fa-arrow-down"></i></div>\n            `:''}\n\n            \x3c!-- å½“å‰å€¼ï¼ˆå¯ç¼–è¾‘ï¼‰ --\x3e\n            <div class="acu-diff-section acu-diff-new-section">\n              ${e.rowTitle&&e.rowIndex>=0?`<div style="font-size:12px;color:var(--acu-text-sub);margin-bottom:8px;padding:4px 8px;background:var(--acu-bg-sub);border-radius:4px;">\n                <i class="fa-solid fa-tag" style="margin-right:4px;"></i>${o(e.rowTitle)}\n              </div>`:''}\n              <div class="acu-diff-label">\n                <i class="fa-solid fa-pen"></i> å½“å‰å€¼ï¼ˆå¯ç¼–è¾‘ï¼‰\n              </div>\n              ${u}\n            </div>\n\n            \x3c!-- æ™ºèƒ½å»ºè®® --\x3e\n            ${p?`\n              <div class="acu-smart-fix-suggest-section">\n                ${p}\n              </div>\n            `:''}\n          </div>\n          <div class="acu-dialog-btns">\n            <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n            ${d?'<button class="acu-dialog-btn acu-btn-revert" id="smart-fix-revert"><i class="fa-solid fa-rotate-left"></i> æ¢å¤å¿«ç…§å€¼</button>':''}\n            <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-confirm"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(g),g.on('click','.acu-smart-fix-option, .acu-smart-fix-quick-btn',function(){if('smart-fix-reverse-write-btn'===$(this).attr('id'))return;if($(this).hasClass('acu-smart-fix-option-current'))return;const e=$(this).data('value')||$(this).text().trim();g.find('#smart-fix-value').val(e).trigger('input')}),g.on('click','#smart-fix-reverse-write-btn',async function(){const t=String(e.currentValue||'').trim();if(!t)return void(window.toastr&&window.toastr.warning('æ— æ³•å†™å…¥ç©ºå€¼'));let i;if('relation'===a&&n.config?.refColumn){{const e=Array.isArray(n.config.refColumn)?n.config.refColumn:[n.config.refColumn];i=e.length>1?g.find('#smart-fix-reverse-column').val():$(this).data('column')||e[0]}if(i&&n.config?.refTable)try{const e=Je||ln();let a=null,o=null;for(const t in e)if(e[t]?.name===n.config.refTable){a=e[t],o=t;break}if(!a||!a.content)return void(window.toastr&&window.toastr.error(`æ‰¾ä¸åˆ°å…³è”è¡¨ "${n.config.refTable}"`));const r=a.content[0]||[],c=r.indexOf(i);if(-1===c)return void(window.toastr&&window.toastr.error(`å…³è”è¡¨ä¸­ä¸å­˜åœ¨åˆ— "${i}"`));const s=new Array(r.length).fill('');s[c]=t,a.content.push(s),await dn(e,!1,!1),f(),Sn()}catch(e){console.error('[DICE]ACU åå‘å†™å…¥å¤±è´¥:',e),window.toastr&&window.toastr.error('åå‘å†™å…¥å¤±è´¥: '+(e.message||'æœªçŸ¥é”™è¯¯'))}else window.toastr&&window.toastr.error('æ— æ³•ç¡®å®šç›®æ ‡è¡¨æˆ–åˆ—')}else window.toastr&&window.toastr.error('æ— æ³•ç¡®å®šç›®æ ‡åˆ—')}),g.on('click','#smart-fix-revert',function(){g.find('#smart-fix-value').val(l)});const f=()=>g.remove();g.on('click','#smart-fix-close, #smart-fix-cancel',f),g.on('click',function(e){$(e.target).hasClass('acu-validation-modal-overlay')&&f()}),g.find('#smart-fix-confirm').on('click',async function(){const t=g.find('#smart-fix-value').val()?.trim()||'';if(''!==t||'required'!==a)try{const n=Je||ln();let a=!1;for(const i in n)if(n[i]?.name===e.tableName){const o=n[i],r=o.content?.[0]||[];if(e.rowIndex>=0&&e.columnName){const n=r.indexOf(e.columnName),i=e.rowIndex+1;if(n>=0&&o.content&&o.content[i]){o.content[i][n]=t,a=!0;break}}}a?(await dn(n,!1,!1),f(),Sn()):window.toastr&&window.toastr.error('æ— æ³•æ‰¾åˆ°ç›®æ ‡å•å…ƒæ ¼')}catch(e){console.error('[DICE]ACU æ›´æ–°å•å…ƒæ ¼å¤±è´¥:',e),window.toastr&&window.toastr.error('æ›´æ–°å¤±è´¥: '+(e.message||'æœªçŸ¥é”™è¯¯'))}else window.toastr&&window.toastr.warning('å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º')})};function mn(e,t,n){if(!e||!e.content||e.content.length<2)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const a=e.content[0]||[],i=e.content.slice(1)||[],o=a.indexOf(t);if(o<0)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const r=new Map,c=new Set,s=new Map;for(let e=0;e<i.length;e++){const t=i[e]?.[o];if(null==t||''===t)continue;const a=String(t).trim();if(!a)continue;let r=!1;if(n){a.match(new RegExp(`^${n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(r=!0)}else{const e=parseInt(a,10);isNaN(e)||(r=!0)}r&&(c.add(a),s.has(a)||s.set(a,[]),s.get(a).push(e))}return{codes:r,allCodes:c,codeToRows:s}}function hn(e,t,n,a){const i=new Set([...e,...t]),o=[];for(const e of i){let t=null;if(n){const a=e.match(new RegExp(`^${n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));a&&(t=parseInt(a[1],10))}else t=parseInt(e,10);isNaN(t)||o.push({code:e,num:t})}o.sort((e,t)=>e.num-t.num);const r=new Map;for(let e=0;e<o.length;e++){const t=o[e].code,i=n+String(a+e).padStart(4,'0');r.set(t,i)}return r}function vn(e,t,n,a,i,o,r,c,s){if(!e||!n)return{fixedCount1:0,fixedCount2:0};const l=e.content[0]||[],d=e.content.slice(1)||[],u=l.indexOf(i),p=n.content[0]||[],g=n.content.slice(1)||[],f=p.indexOf(i);if(u<0||f<0)return{fixedCount1:0,fixedCount2:0};let b=0,m=0;const h=new Map;for(const[e,t]of o.entries())h.set(t,e);const v=Array.from(o.values()).sort((e,t)=>parseInt(e.replace(r,''),10)-parseInt(t.replace(r,''),10)),x=(e,t)=>{const n=[],a=[];for(let i=0;i<e.length;i++){const o=e[i]?.[t],c=null==o?'':String(o).trim();let s=!1;if(c&&r){c.match(new RegExp(`^${r.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(s=!0)}else if(c){const e=parseInt(c,10);isNaN(e)||(s=!0)}s?n.push({rowIndex:i,oldCode:c,row:e[i]}):a.push({rowIndex:i,row:e[i],prevOldCode:null,nextOldCode:null})}for(const e of a){let t=null,a=null;for(const i of n)if(i.rowIndex<e.rowIndex&&(t=i.oldCode),i.rowIndex>e.rowIndex&&null===a){a=i.oldCode;break}e.prevOldCode=t,e.nextOldCode=a}return{codeRows:n,emptyRows:a}},y=x(d,u),w=x(g,f),k=(e,t,n,a)=>{const i=[],r=new Map;for(const t of e.codeRows)r.set(t.oldCode,t.row);for(const e of v){const a=h.get(e);if(r.has(a)){const t=r.get(a).map(e=>e);t[n]=e,i.push({newCode:e,row:t,isCodeRow:!0})}else{const a=new Array(t.length).fill(null);a[n]=e,i.push({newCode:e,row:a,isCodeRow:!0,isInserted:!0})}}const c=[];let s=0;for(const t of e.emptyRows)if(null===t.prevOldCode&&null!==t.nextOldCode){const e=o.get(t.nextOldCode);for(;s<i.length&&i[s].newCode!==e;)c.push(i[s].row),s++;c.push(t.row)}else null===t.prevOldCode&&null===t.nextOldCode&&c.push(t.row);for(;s<i.length;s++){c.push(i[s].row);const t=i[s].newCode,n=h.get(t);for(const t of e.emptyRows)t.prevOldCode===n&&c.push(t.row)}for(const t of e.emptyRows)null!==t.prevOldCode&&t.nextOldCode;return c},C=k(y,l,u,new Set(y.codeRows.map(e=>e.oldCode))),E=k(w,p,f,new Set(w.codeRows.map(e=>e.oldCode))),A=(e,t,n)=>{let a=0;const i=new Set(e.codeRows.map(e=>e.oldCode)),r=new Set;for(const e of t){const t=e[n];t&&r.add(t)}for(const[e,t]of o.entries())i.has(e)&&e!==t&&a++;for(const e of v){const t=h.get(e);i.has(t)||a++}return a};return b=A(y,C,u),m=A(w,E,f),e.content=[l,...C],n.content=[p,...E],{fixedCount1:b,fixedCount2:m}}const xn=(e,t,n,a,i,r)=>{const{$}=ut();let c='',s='';if('tableReadonly'===n){let t=0,n=[];if(i&&a)for(const o in a)if(a[o]?.name===e.tableName&&i[o]){const e=a[o].content?.slice(1)||[],r=i[o].content?.slice(1)||[];if(e.forEach((e,a)=>{const i=r[a];if(i){for(let o=0;o<e.length;o++)if(String(e[o]||'')!==String(i[o]||'')){n.push(`ç¬¬${a+1}è¡Œ: æœ‰ä¿®æ”¹`),t++;break}}else n.push(`ç¬¬${a+1}è¡Œ: æ–°å¢`),t++}),r.length>e.length)for(let a=e.length;a<r.length;a++)n.push(`ç¬¬${a+1}è¡Œ: å·²åˆ é™¤`),t++;break}c=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-lock"></i>\n            <span>è¡¨åªè¯»ä¿æŠ¤</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">æ­¤è¡¨è¢«è®¾ç½®ä¸ºåªè¯»ï¼Œä½†æ£€æµ‹åˆ°æœ‰ä¿®æ”¹ã€‚</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            æ£€æµ‹åˆ° <strong>${t}</strong> å¤„ä¿®æ”¹\n          </div>\n          ${n.length>0?`\n            <div class="acu-smart-fix-change-list">\n              ${n.slice(0,10).map(e=>`<div class="acu-smart-fix-change-item">${o(e)}</div>`).join('')}\n              ${n.length>10?`<div class="acu-smart-fix-change-item">... è¿˜æœ‰ ${n.length-10} å¤„</div>`:''}\n            </div>\n          `:''}\n        </div>\n      `,s='\n        <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n        <button class="acu-dialog-btn acu-btn-revert" id="smart-fix-restore-table"><i class="fa-solid fa-rotate-left"></i> æ¢å¤æ•´è¡¨</button>\n      '}else if('rowLimit'===n){const n=t.config?.min,i=t.config?.max;let r=0,l=[];for(const t in a)if(a[t]?.name===e.tableName){r=(a[t].content?.length||1)-1;break}const d=void 0!==i&&r>i,u=void 0!==n&&r<n;if(d)for(let e=i+1;e<=r;e++)l.push(e);c=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-arrows-up-down"></i>\n            <span>è¡Œæ•°é™åˆ¶</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${o(e.errorMessage||t.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            å½“å‰è¡Œæ•°: <strong>${r}</strong> è¡Œ\n            ${void 0!==n||void 0!==i?` | é™åˆ¶: ${void 0!==n?n:0} ~ ${void 0!==i?i:'âˆ'} è¡Œ`:''}\n          </div>\n          ${d&&l.length>0?`\n            <div class="acu-smart-fix-excess-rows">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-trash"></i> éœ€åˆ é™¤çš„è¡Œ (ç¬¬ ${l[0]} è¡ŒåŠä¹‹å):\n              </div>\n              <div class="acu-smart-fix-change-list">\n                ${l.slice(0,10).map(e=>`<div class="acu-smart-fix-change-item">ç¬¬ ${e} è¡Œ</div>`).join('')}\n                ${l.length>10?`<div class="acu-smart-fix-change-item">... å…± ${l.length} è¡Œ</div>`:''}\n              </div>\n            </div>\n          `:''}\n          ${u?`\n            <div class="acu-smart-fix-hint">\n              <i class="fa-solid fa-info-circle"></i> éœ€è¦æ·»åŠ  ${n-r} è¡Œæ‰èƒ½æ»¡è¶³æœ€å°è¡Œæ•°è¦æ±‚\n            </div>\n          `:''}\n        </div>\n      `,s=d&&l.length>0?`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-delete-rows" data-start="${i}" data-table="${o(e.tableName)}">\n            <i class="fa-solid fa-trash"></i> åˆ é™¤å¤šä½™çš„ ${l.length} è¡Œ\n          </button>\n        `:'<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å…³é—­</button>'}else if('sequence'===n&&t.targetColumn){const n=t.config?.prefix||'',i=void 0!==t.config?.startFrom?t.config?.startFrom:1;let r=null,l=[],d=[];for(const t in a)if(a[t]?.name===e.tableName){r=a[t];break}if(r&&r.content&&r.content.length>1){const e=r.content[0]||[],a=r.content.slice(1)||[],o=e.indexOf(t.targetColumn);if(o>=0){const e=[];for(let t=0;t<a.length;t++){const i=a[t]?.[o];if(null==i||''===i)continue;const r=String(i).trim();if(!r)continue;let c=null;if(n){const e=r.match(new RegExp(`^${n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));e&&(c=parseInt(e[1],10))}else c=parseInt(r,10);isNaN(c)||e.push({rowIndex:t,value:r,num:c,originalRowIndex:t+2})}e.sort((e,t)=>e.rowIndex-t.rowIndex);const t=new Map,r=[],c=[],s=[];for(let n=0;n<e.length;n++){const a=e[n].num;t.has(a)||t.set(a,[]),t.get(a).push(n)}for(let n=0;n<e.length;n++){const a=i+n,o=e[n].num,l=e[n].originalRowIndex,d=t.get(o)||[];d.length>1&&d[0]===n&&r.push({rowNum:l,value:e[n].value,num:o,expectedNum:a,count:d.length}),o!==a&&(o<a?s.push({rowNum:l,value:e[n].value,num:o,expectedNum:a}):c.push({rowNum:l,value:e[n].value,num:o,expectedNum:a}))}for(let t=0;t<e.length;t++){const a=i+t,o=e[t].num,c=e[t].originalRowIndex,s=e[t].value,l=n+String(a).padStart(4,'0');(o!==a||r.some(e=>e.num===o&&e.rowNum===c))&&d.push({rowNum:c,currentValue:s,fixedValue:l,reason:o<a?'é‡å¤æˆ–é¡ºåºé”™è¯¯':o>a?'è·³å·':'é‡å¤'})}const u=new Set;r.forEach(e=>{u.add(`ç¬¬${e.rowNum}è¡Œ: "${e.value}" é‡å¤ (å‡ºç°${e.count}æ¬¡)`)}),c.forEach(e=>{u.add(`ç¬¬${e.rowNum}è¡Œ: "${e.value}" åº”ä¸º "${n}${String(e.expectedNum).padStart(4,'0')}" (è·³å·)`)}),s.forEach(e=>{u.add(`ç¬¬${e.rowNum}è¡Œ: "${e.value}" åº”ä¸º "${n}${String(e.expectedNum).padStart(4,'0')}" (é¡ºåºé”™è¯¯)`)}),l=Array.from(u)}}if(c=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-sort-numeric-up"></i>\n            <span>åºåˆ—é€’å¢éªŒè¯</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${o(e.errorMessage||t.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            æ£€æµ‹åˆ° <strong>${l.length}</strong> ä¸ªé—®é¢˜\n          </div>\n          ${l.length>0?`\n            <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n              ${l.slice(0,20).map(e=>`<div class="acu-smart-fix-change-item">${o(e)}</div>`).join('')}\n              ${l.length>20?`<div class="acu-smart-fix-change-item">... è¿˜æœ‰ ${l.length-20} ä¸ªé—®é¢˜</div>`:''}\n            </div>\n          `:''}\n          ${d.length>0?`\n            <div class="acu-smart-fix-suggest" style="margin-top:12px;">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-lightbulb"></i> ä¿®å¤å»ºè®®:\n              </div>\n              <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n                ${d.slice(0,20).map(e=>`\n                  <div class="acu-smart-fix-change-item">\n                    <span style="color:var(--acu-text-sub);">ç¬¬${e.rowNum}è¡Œ:</span>\n                    <span style="color:var(--acu-hl-manual);">${o(e.currentValue)}</span>\n                    <span style="color:var(--acu-text-sub);"> â†’ </span>\n                    <span style="color:var(--acu-hl-auto);">${o(e.fixedValue)}</span>\n                    <span style="color:var(--acu-text-sub);font-size:11px;"> (${o(e.reason)})</span>\n                  </div>\n                `).join('')}\n                ${d.length>20?`<div class="acu-smart-fix-change-item">... è¿˜æœ‰ ${d.length-20} å¤„éœ€è¦ä¿®å¤</div>`:''}\n              </div>\n            </div>\n          `:''}\n        </div>\n      `,d.length>0){const a=t.config?.pairedTable||('æ€»ç»“è¡¨'===e.tableName?'æ€»ä½“å¤§çº²':'æ€»ä½“å¤§çº²'===e.tableName?'æ€»ç»“è¡¨':null),r=a?`data-paired-table="${o(a)}"`:'';s=`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-fix-sequence" data-table="${o(e.tableName)}" data-column="${o(t.targetColumn)}" data-prefix="${o(n)}" data-start="${i}" ${r}>\n            <i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤ ${d.length} å¤„\n          </button>\n        `}else s='<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> å…³é—­</button>'}const l=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${r}" style="max-width:450px;">\n          <div class="acu-edit-title">æ™ºèƒ½ä¿®æ”¹: ${o(e.tableName||'')} (è¡¨çº§è§„åˆ™)</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            ${c}\n          </div>\n          <div class="acu-dialog-btns">\n            ${s}\n          </div>\n        </div>\n      </div>\n    `);$('body').append(l);const d=()=>l.remove();l.on('click','#smart-fix-cancel',d),l.on('click',function(e){$(e.target).hasClass('acu-validation-modal-overlay')&&d()}),l.on('click','#smart-fix-restore-table',async function(){if(i)try{for(const t in a)if(a[t]?.name===e.tableName&&i[t]){a[t]=JSON.parse(JSON.stringify(i[t]));break}await dn(a,!1,!1),d(),Sn()}catch(e){console.error('[DICE]ACU æ¢å¤è¡¨å¤±è´¥:',e),window.toastr&&window.toastr.error('æ¢å¤å¤±è´¥: '+(e.message||'æœªçŸ¥é”™è¯¯'))}else window.toastr&&window.toastr.warning('æ— å¿«ç…§æ•°æ®')}),l.on('click','#smart-fix-fix-sequence',async function(){const e=$(this),t=e.data('table'),n=e.data('column'),i=e.data('prefix')||'',o=parseInt(e.data('start')||'1',10),r=e.data('paired-table')||null;try{e.prop('disabled',!0).html('<i class="fa-solid fa-spinner fa-spin"></i> ä¿®å¤ä¸­...');let c=null,s=null;for(const e in a)if(a[e]?.name===t){c=a[e],s=e;break}if(!c||!c.content||c.content.length<2)return window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°ç›®æ ‡è¡¨'),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');const l=c.content[0]||[],u=c.content.slice(1)||[],p=l.indexOf(n);if(p<0)return window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°ç›®æ ‡åˆ—'),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');if(r){let t=null,s=null;for(const e in a)if(a[e]?.name===r){t=a[e],s=e;break}if(!t||!t.content||t.content.length<1)return window.toastr&&window.toastr.warning(`æœªæ‰¾åˆ°é…å¯¹è¡¨: ${r}`),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');const l=t.content[0]||[];if(l.indexOf(n)<0)return window.toastr&&window.toastr.warning(`é…å¯¹è¡¨ä¸­æœªæ‰¾åˆ°ç›®æ ‡åˆ—: ${n}`),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤');const u=mn(c,n,i),p=mn(t,n,i),g=hn(u.allCodes,p.allCodes,i,o),{fixedCount1:f,fixedCount2:b}=vn(c,0,t,0,n,g,i);await dn(a,!1,!1),d(),Sn()}else{const e=[];for(let t=0;t<u.length;t++){const n=u[t]?.[p];if(null==n||''===n)continue;const a=String(n).trim();if(!a)continue;let o=null;if(i){const e=a.match(new RegExp(`^${i.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));e&&(o=parseInt(e[1],10))}else o=parseInt(a,10);isNaN(o)||e.push({rowIndex:t,value:a,num:o})}e.sort((e,t)=>e.rowIndex-t.rowIndex);let t=0;for(let n=0;n<e.length;n++){const a=o+n,r=e[n].num,c=e[n].rowIndex;if(r!==a){const e=i+String(a).padStart(4,'0');u[c][p]=e,t++}}await dn(a,!1,!1),d(),Sn()}}catch(t){console.error('[DICE]ACU ä¿®å¤åºåˆ—é€’å¢å¤±è´¥:',t),window.toastr&&window.toastr.error('ä¿®å¤å¤±è´¥: '+(t.message||'æœªçŸ¥é”™è¯¯')),e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> è‡ªåŠ¨ä¿®å¤')}}),l.on('click','#smart-fix-delete-rows',async function(){const e=parseInt($(this).data('start'),10),t=$(this).data('table');try{for(const n in a)if(a[n]?.name===t){a[n].content=a[n].content.slice(0,e+1);break}await dn(a,!1,!1),d(),Sn()}catch(e){console.error('[DICE]ACU åˆ é™¤è¡Œå¤±è´¥:',e),window.toastr&&window.toastr.error('åˆ é™¤å¤±è´¥: '+(e.message||'æœªçŸ¥é”™è¯¯'))}})},yn=()=>{const{$}=ut(),e=an(),t=Me();$('.acu-blacklist-manager-overlay').remove();X.getBlacklist();const n=`\n      <div class="acu-blacklist-manager-overlay">\n        <div class="acu-edit-dialog acu-theme-${e.theme}" style="max-width: 600px; width: 90%;">\n          <div class="acu-edit-title" style="position: relative;">\n            <i class="fa-solid fa-filter"></i> è¿‡æ»¤é»‘åå•ç®¡ç†\n            <button class="acu-close-btn" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: ${t.textMain}; cursor: pointer; font-size: 18px; z-index: 10;">\n              <i class="fa-solid fa-times"></i>\n            </button>\n          </div>\n          <div class="acu-settings-content" style="flex: 1; overflow-y: auto; padding: 20px;">\n            <div style="margin-bottom: 15px;">\n              <div style="margin-bottom: 8px; font-size: 12px; color: ${t.textSub};">\n                é»‘åå•ä¸­çš„å…³é”®è¯å¯¹åº”çš„æœ€ä¸‹å±‚å˜é‡åæˆ–åˆ—åå°†ä¸ä¼šæ˜¾ç¤ºå¿«æ·éª°å­å›¾æ ‡\n              </div>\n              <textarea id="blacklist-textarea" style="width: 100%; min-height: 120px; max-height: 300px; padding: 10px !important; border: 1px solid ${t.border} !important; border-radius: 4px !important; background: ${t.inputBg} !important; color: ${t.textMain} !important; font-size: 13px !important; box-sizing: border-box !important; resize: vertical; font-family: monospace; line-height: 1.5;" placeholder="è¾“å…¥å…³é”®è¯ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆæ”¯æŒä¸­è‹±æ–‡é€—å·ï¼‰"></textarea>\n              <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: nowrap;">\n                <input type="text" id="blacklist-input" placeholder="è¾“å…¥å…³é”®è¯..." style="flex: 1; min-width: 0; padding: 8px !important; border: 1px solid ${t.border} !important; border-radius: 4px !important; background: ${t.inputBg} !important; color: ${t.textMain} !important; font-size: 13px !important; box-sizing: border-box !important;">\n                <button id="blacklist-add-btn" style="padding: 8px 16px; background: ${t.accent}; color: ${t.buttonTextOnAccent||t.textMain||'#6B4A5A'}; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; white-space: nowrap; flex-shrink: 0;">\n                  <i class="fa-solid fa-plus"></i> æ·»åŠ \n                </button>\n              </div>\n            </div>\n            <div style="display: flex; gap: 8px; margin-top: 15px;">\n              <button id="blacklist-reset-btn" style="flex: 1; padding: 10px; background: ${t.btnBg}; color: ${t.textMain}; border: 1px solid ${t.border}; border-radius: 4px; cursor: pointer; font-size: 13px;">\n                <i class="fa-solid fa-undo"></i> é‡ç½®ä¸ºé»˜è®¤\n              </button>\n              <button id="blacklist-close-btn" style="flex: 1; padding: 10px; background: ${t.accent}; color: ${t.buttonTextOnAccent||t.textMain||'#6B4A5A'}; border: none; border-radius: 4px; cursor: pointer; font-size: 13px;">\n                <i class="fa-solid fa-check"></i> å®Œæˆ\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,a=$(n);$('body').append(a),a.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',background:'rgba(0,0,0,0.6)','z-index':'2147483655',display:'flex','align-items':'center','justify-content':'center',padding:'20px','box-sizing':'border-box'});const i=()=>{const e=X.getBlacklist();a.find('#blacklist-textarea').val(e.join('ï¼Œ'))};i(),a.find('#blacklist-textarea').on('input',function(){(()=>{const e=a.find('#blacklist-textarea').val().trim();if(!e)return void X.setBlacklist([]);const t=e.split(/[ï¼Œ,]/).map(e=>e.trim()).filter(e=>e.length>0),n=[...new Set(t)];X.setBlacklist(n),n.length!==t.length&&i()})()}),a.find('#blacklist-add-btn').click(function(){const e=a.find('#blacklist-input'),t=e.val().trim();if(!t)return;const n=t.split(/[ï¼Œ,]/).map(e=>e.trim()).filter(e=>e.length>0);if(0===n.length)return;const o=X.getBlacklist(),r=new Set(o),c=[];n.forEach(e=>{r.has(e)||(o.push(e),r.add(e),c.push(e))}),0!==c.length?(X.setBlacklist(o),e.val(''),i(),window.toastr&&window.toastr.success(`å·²æ·»åŠ  ${c.length} é¡¹`)):window.toastr&&window.toastr.warning('æ‰€æœ‰é¡¹å·²å­˜åœ¨')}),a.find('#blacklist-input').on('keypress',function(e){13===e.which&&a.find('#blacklist-add-btn').click()}),a.find('#blacklist-reset-btn').click(function(){confirm('ç¡®å®šè¦é‡ç½®é»‘åå•ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')&&(X.resetToDefault(),i(),window.toastr&&window.toastr.success('å·²é‡ç½®ä¸ºé»˜è®¤å€¼'))});const o=()=>{a.remove(),Sn()};a.find('#blacklist-close-btn, .acu-close-btn').click(o),a.on('click',function(e){$(e.target).hasClass('acu-blacklist-manager-overlay')&&o()})},wn=()=>{const{$}=ut();$('.acu-edit-overlay').remove();const e=an(),t=Me(),n=he.getAllPresets(),a=bt.get(A,null),i=null===a,r=`\n      <div class="acu-preset-item" data-id="__default__">\n        <div class="acu-preset-info">\n          <div class="acu-preset-name">\n            å…­ç»´å±æ€§ç™¾åˆ†åˆ¶\n            <span style="font-size: 10px; color: ${t.textSub}; margin-left: 6px;">(é»˜è®¤)</span>\n          </div>\n          <div class="acu-preset-desc">ä½¿ç”¨ç™¾åˆ†åˆ¶ç”Ÿæˆå…­ç»´åŸºç¡€å±æ€§ï¼ˆåŠ›é‡ã€æ•æ·ã€ä½“è´¨ã€æ™ºåŠ›ã€æ„ŸçŸ¥ã€é­…åŠ›ï¼‰ï¼ŒèŒƒå›´5-95</div>\n          <div class="acu-preset-stats">\n            åŸºç¡€å±æ€§: 6 | ç‰¹åˆ«å±æ€§: 0\n          </div>\n        </div>\n        <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n          <label class="acu-toggle" style="margin: 0;">\n            <input type="checkbox" class="acu-preset-toggle" data-id="__default__" ${i?'checked':''}>\n            <span class="acu-toggle-slider"></span>\n          </label>\n        </div>\n      </div>\n    `+n.map(e=>{const n=e.id===a,i=e.builtin;return`\n        <div class="acu-preset-item" data-id="${e.id}">\n          <div class="acu-preset-info">\n            <div class="acu-preset-name">\n              ${o(e.name)}\n              ${i?`<span style="font-size: 10px; color: ${t.textSub}; margin-left: 6px;">(å†…ç½®)</span>`:''}\n            </div>\n            ${e.description?`<div class="acu-preset-desc">${o(e.description)}</div>`:''}\n            <div class="acu-preset-stats">\n              åŸºç¡€å±æ€§: ${e.baseAttributes.length} | ç‰¹åˆ«å±æ€§: ${e.specialAttributes?.length||0}\n            </div>\n          </div>\n          <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n            <label class="acu-toggle" style="margin: 0;">\n              <input type="checkbox" class="acu-preset-toggle" data-id="${e.id}" ${n?'checked':''}>\n              <span class="acu-toggle-slider"></span>\n            </label>\n            ${i?'':`<button class="acu-preset-btn acu-preset-edit" data-id="${e.id}" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>`}\n            <button class="acu-preset-btn acu-preset-export" data-id="${e.id}" title="å¯¼å‡º"><i class="fa-solid fa-download"></i></button>\n            ${i?'':`<button class="acu-preset-btn acu-preset-delete" data-id="${e.id}" title="åˆ é™¤" style="color: #e74c3c;"><i class="fa-solid fa-trash"></i></button>`}\n          </div>\n        </div>\n      `}).join(''),c=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${e.theme}" style="width: 600px; max-width: 92vw; max-height: 80vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid ${t.border};">\n            <div style="font-size: 16px; font-weight: bold; color: ${t.textMain};">\n              <i class="fa-solid fa-dice-d20"></i> å±æ€§è§„åˆ™é¢„è®¾ç®¡ç†\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div id="acu-presets-list">\n              ${r||`<div style="text-align: center; padding: 40px; color: ${t.textSub};">æš‚æ— é¢„è®¾</div>`}\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid ${t.border};">\n            <button id="acu-preset-new" style="flex: 1; padding: 10px; background: ${t.buttonBg||t.accent}; border: none; border-radius: 6px; color: ${t.buttonText}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-plus"></i> æ–°å»ºé¢„è®¾\n            </button>\n            <button id="acu-preset-import" style="flex: 1; padding: 10px; background: ${t.btnBg}; border: 1px solid ${t.border}; border-radius: 6px; color: ${t.textMain}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-file-import"></i> å¯¼å…¥\n            </button>\n            <button id="acu-preset-back" style="padding: 10px 16px; background: ${t.btnBg}; border: 1px solid ${t.border}; border-radius: 6px; color: ${t.textMain}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-arrow-left"></i> è¿”å›\n            </button>\n          </div>\n\n          <input type="file" id="acu-preset-file-input" accept=".json" style="display: none;" />\n        </div>\n      </div>\n    `);$('body').append(c),c.find('.acu-close-btn, #acu-preset-back').on('click',()=>{c.remove(),_n()}),c.on('change','.acu-preset-toggle',function(){const e=$(this),t=e.data('id');if(e.is(':checked')){const e='__default__'===t?null:t;he.setActivePreset(e),c.find('.acu-preset-toggle').each(function(){const e=$(this);e.data('id')!==t&&e.prop('checked',!1)})}else he.setActivePreset(null)}),c.on('click','.acu-preset-edit',function(){const e=$(this).data('id');c.remove(),kn(e)}),c.on('click','.acu-preset-export',function(){const e=$(this).data('id'),t=he.exportPreset(e);if(!t)return void(window.toastr&&window.toastr.error('å¯¼å‡ºå¤±è´¥'));const a=n.find(t=>t.id===e),i=`acu_preset_${a?.name||e}_${Date.now()}.json`,o=new Blob([t],{type:'application/json'}),r=URL.createObjectURL(o),c=document.createElement('a');c.href=r,c.download=i,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}),c.on('click','.acu-preset-delete',function(){const e=$(this).data('id'),t=n.find(t=>t.id===e);if(confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾ã€Œ${t?.name}ã€å—ï¼Ÿ`)){he.deletePreset(e)?(c.remove(),wn()):window.toastr&&window.toastr.error('åˆ é™¤å¤±è´¥')}}),c.find('#acu-preset-new').on('click',()=>{c.remove(),kn()}),c.find('#acu-preset-import').on('click',()=>{c.find('#acu-preset-file-input').click()}),c.find('#acu-preset-file-input').on('change',function(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{he.importPreset(e.target.result)?(c.remove(),wn()):window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥ï¼šæ ¼å¼ä¸æ­£ç¡®')}catch(e){console.error('[DICE]ACU å¯¼å…¥é¢„è®¾å¤±è´¥:',e),window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥')}},n.readAsText(t),$(this).val('')}),c.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&(c.remove(),_n())})},kn=(e=null)=>{const{$}=ut();$('.acu-edit-overlay').remove();const t=an(),n=Me(),a=!!e,i=a?he.getAllPresets().find(t=>t.id===e):null,r={name:i?.name||'æ–°è§„åˆ™é¢„è®¾',description:i?.description||'',baseAttributes:i?.baseAttributes||[{name:'åŠ›é‡',formula:'3d6',range:[3,18]},{name:'æ•æ·',formula:'3d6',range:[3,18]},{name:'ä½“è´¨',formula:'3d6',range:[3,18]},{name:'æ™ºåŠ›',formula:'3d6',range:[3,18]},{name:'æ„ŸçŸ¥',formula:'3d6',range:[3,18]},{name:'é­…åŠ›',formula:'3d6',range:[3,18]}],specialAttributes:i?.specialAttributes||[]},c=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="width: 650px; max-width: 95vw; max-height: 85vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid ${n.border};">\n            <div style="font-size: 16px; font-weight: bold; color: ${n.textMain};">\n              <i class="fa-solid fa-pen"></i> ${a?'ç¼–è¾‘':'æ–°å»º'}è§„åˆ™é¢„è®¾\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: ${n.textSub}; margin-bottom: 4px;">é¢„è®¾åç§°</label>\n              <input id="preset-name" type="text" value="${o(r.name)}" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid ${n.border} !important; border-radius: 6px; background: ${n.inputBg} !important; color: ${n.textMain} !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: ${n.textSub}; margin-bottom: 4px;">æè¿°</label>\n              <input id="preset-desc" type="text" value="${o(r.description)}" placeholder="å¯é€‰" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid ${n.border} !important; border-radius: 6px; background: ${n.inputBg} !important; color: ${n.textMain} !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: ${n.textSub}; margin-bottom: 8px;">\n                JSONé…ç½® <span style="font-size: 10px; color: ${n.textSub};">(æ”¯æŒç›´æ¥ç¼–è¾‘æˆ–å¯¼å…¥)</span>\n              </label>\n              <textarea id="preset-json" class="acu-preset-editor-textarea" style="width: 100%; height: 320px; padding: 10px; border: 1px solid ${n.border} !important; border-radius: 6px; background: ${n.inputBg} !important; color: ${n.textMain} !important; font-family: 'Consolas', 'Monaco', monospace !important; font-size: 12px; resize: vertical; box-sizing: border-box;"></textarea>\n            </div>\n\n            <div style="font-size: 11px; color: ${n.textSub}; padding: 8px; background: var(--acu-table-head); border-radius: 6px; line-height: 1.6;">\n              <strong>é…ç½®æ ¼å¼è¯´æ˜ï¼š</strong><br/>\n              â€¢ baseAttributes: åŸºæœ¬å±æ€§æ•°ç»„ï¼Œæ¯é¡¹åŒ…å« nameã€formulaã€rangeã€modifier(å¯é€‰)<br/>\n              â€¢ specialAttributes: ç‰¹åˆ«å±æ€§æ•°ç»„ï¼Œæ¯é¡¹åŒ…å« nameã€formulaã€range(å¯é€‰)<br/>\n              â€¢ å…¬å¼æ”¯æŒ: 3d6, 4d6kh3, å˜é‡å¼•ç”¨(åŠ›é‡/2), æ•°å­¦è¿ç®—(+ã€-ã€*ã€/)\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid ${n.border};">\n            <button id="preset-save" style="flex: 1; padding: 10px; background: ${n.buttonBg||n.accent}; border: none; border-radius: 6px; color: ${n.buttonText}; cursor: pointer; font-size: 13px; font-weight: bold;">\n              <i class="fa-solid fa-check"></i> ä¿å­˜\n            </button>\n            <button id="preset-cancel" style="padding: 10px 16px; background: ${n.btnBg}; border: 1px solid ${n.border}; border-radius: 6px; color: ${n.textMain}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-times"></i> å–æ¶ˆ\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(c);const s=c.find('#preset-json');(()=>{const e={baseAttributes:r.baseAttributes,specialAttributes:r.specialAttributes};s.val(JSON.stringify(e,null,2))})(),c.find('.acu-close-btn, #preset-cancel').on('click',()=>{c.remove(),wn()}),c.find('#preset-save').on('click',()=>{try{const t=c.find('#preset-name').val().trim(),n=c.find('#preset-desc').val().trim(),i=s.val().trim();if(!t)return void(window.toastr&&window.toastr.warning('è¯·è¾“å…¥é¢„è®¾åç§°'));const o=JSON.parse(i);if(!o.baseAttributes||!Array.isArray(o.baseAttributes)||0===o.baseAttributes.length)return void(window.toastr&&window.toastr.error('åŸºæœ¬å±æ€§ä¸èƒ½ä¸ºç©º'));const r={format:'acu_attr_preset_v1',version:1,id:e||`custom_${Date.now()}`,name:t,description:n,baseAttributes:o.baseAttributes,specialAttributes:o.specialAttributes||[]};a?he.updatePreset(e,r):he.createPreset(r),c.remove(),wn()}catch(e){console.error('[DICE]ACU ä¿å­˜é¢„è®¾å¤±è´¥:',e),window.toastr&&window.toastr.error('ä¿å­˜å¤±è´¥ï¼š'+(e.message||'JSONæ ¼å¼é”™è¯¯'))}}),c.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&(c.remove(),wn())})},$n=()=>{const{$}=ut();$('.acu-edit-overlay').not(':has(.acu-debug-console-dialog)').remove();const e=`acu-theme-${an().theme}`,t=(Me(),bt.get('acu_debug_filters',{log:!0,info:!0,warn:!0,error:!0}));D.setFilters(t);const n=()=>{const e=D.getFilteredLogs(),t=a.find('.acu-debug-log-container');t.empty(),0!==e.length?e.forEach(e=>{const n={error:'#e74c3c',warn:'#f39c12',info:'#3498db',log:'#95a5a6'},a={error:'fa-exclamation-circle',warn:'fa-exclamation-triangle',info:'fa-info-circle',log:'fa-circle'},i=n[e.type]||n.log,r=a[e.type]||a.log,c=$(`\n          <div class="acu-debug-log-item" data-type="${e.type}" style="padding:8px 12px;border-bottom:1px solid var(--acu-border);font-family:monospace;font-size:12px;line-height:1.5;">\n            <div style="display:flex;align-items:flex-start;gap:8px;">\n              <span style="color:${i};min-width:60px;font-size:11px;">\n                <i class="fa-solid ${r}"></i> [${e.timeStr}]\n              </span>\n              <span style="color:${i};min-width:50px;font-size:11px;text-transform:uppercase;">[${e.type}]</span>\n              <span style="flex:1;color:var(--acu-text-main);word-break:break-word;white-space:pre-wrap;">${o(e.content)}</span>\n            </div>\n            ${e.stack?`<div style="margin-top:4px;margin-left:128px;color:var(--acu-text-sub);font-size:11px;white-space:pre-wrap;font-family:monospace;">${o(e.stack)}</div>`:''}\n          </div>\n        `);t.append(c)}):t.html('<div style="text-align:center;padding:40px;color:var(--acu-text-sub);"><i class="fa-solid fa-inbox"></i><br/>æš‚æ— æ—¥å¿—</div>')},a=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-debug-console-dialog ${e}" style="max-width:90vw;max-height:90vh;width:800px;height:600px;display:flex;flex-direction:column;">\n          <div class="acu-settings-header" style="flex-shrink:0;">\n            <div class="acu-settings-title"><i class="fa-solid fa-bug"></i> Debugæ§åˆ¶å°</div>\n            <button class="acu-close-btn" id="debug-console-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">\n            \x3c!-- å·¥å…·æ  --\x3e\n            <div style="padding:12px;border-bottom:1px solid var(--acu-border);flex-shrink:0;display:flex;flex-direction:column;gap:8px;">\n              \x3c!-- ConsoleæŠ“å–å¼€å…³ --\x3e\n              <div style="display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid var(--acu-border);">\n                <span style="font-size:12px;color:var(--acu-text-sub);flex:1;">ConsoleæŠ“å–:</span>\n                <label class="acu-toggle">\n                  <input type="checkbox" id="debug-console-capture-toggle" ${D.enabled?'checked':''}>\n                  <span class="acu-toggle-slider"></span>\n                </label>\n                <span id="debug-console-capture-status" style="font-size:11px;color:var(--acu-text-sub);">${D.enabled?'å·²å¯ç”¨':'å·²å…³é—­'}</span>\n              </div>\n              \x3c!-- è¿‡æ»¤å’Œæ“ä½œæŒ‰é’® --\x3e\n              <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">\n                <div style="display:flex;gap:8px;align-items:center;flex:1;">\n                  <span style="font-size:12px;color:var(--acu-text-sub);">è¿‡æ»¤:</span>\n                  <button class="acu-btn ${t.log?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="log" style="padding:4px 10px;font-size:12px;${t.log?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Log</span>\n                  </button>\n                  <button class="acu-btn ${t.info?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="info" style="padding:4px 10px;font-size:12px;${t.info?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Info</span>\n                  </button>\n                  <button class="acu-btn ${t.warn?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="warn" style="padding:4px 10px;font-size:12px;${t.warn?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Warn</span>\n                  </button>\n                  <button class="acu-btn ${t.error?'acu-btn-primary':'acu-btn-secondary'}" data-filter-type="error" style="padding:4px 10px;font-size:12px;${t.error?'':'opacity:0.5;'}">\n                    <span style="color:var(--acu-text-main);">Error</span>\n                  </button>\n                </div>\n                <div style="display:flex;gap:6px;">\n                  <button class="acu-btn acu-btn-secondary" id="debug-console-clear" style="padding:6px 12px;font-size:12px;">\n                    <i class="fa-solid fa-trash"></i> æ¸…ç©º\n                  </button>\n                  <button class="acu-btn acu-btn-secondary" id="debug-console-copy" style="padding:6px 12px;font-size:12px;">\n                    <i class="fa-solid fa-copy"></i> å¤åˆ¶\n                  </button>\n                  <button class="acu-btn acu-btn-primary" id="debug-console-export" style="padding:6px 12px;font-size:12px;">\n                    <i class="fa-solid fa-download"></i> å¯¼å‡º\n                  </button>\n                </div>\n              </div>\n            </div>\n\n            \x3c!-- æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ --\x3e\n            <div class="acu-debug-log-scroll" style="flex:1;overflow-y:auto;overflow-x:hidden;background:var(--acu-card-bg);">\n              <div class="acu-debug-log-container"></div>\n            </div>\n\n            \x3c!-- åº•éƒ¨çŠ¶æ€æ  --\x3e\n            <div style="padding:8px 12px;border-top:1px solid var(--acu-border);flex-shrink:0;font-size:11px;color:var(--acu-text-sub);display:flex;justify-content:space-between;">\n              <span>æ€»è®¡: <span id="debug-total-count">0</span> | æ˜¾ç¤º: <span id="debug-filtered-count">0</span></span>\n            </div>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(a);const i=()=>{const e=D.logs.length,t=D.getFilteredLogs().length;a.find('#debug-total-count').text(e),a.find('#debug-filtered-count').text(t)};n(),i(),a.find('#debug-console-capture-toggle').on('change',function(){const e=$(this).is(':checked'),t=a.find('#debug-console-capture-status');e?(D.enable(),t.text('å·²å¯ç”¨'),console.log('[DICE]Debugæ§åˆ¶å°æŠ“å–æ¨¡å¼å·²å¼€å¯')):(D.disable(),t.text('å·²å…³é—­'))}),a.find('[data-filter-type]').on('click',function(){const e=$(this).data('filter-type'),t=!$(this).hasClass('acu-btn-primary');t?($(this).removeClass('acu-btn-secondary').addClass('acu-btn-primary'),$(this).css('opacity','1')):($(this).removeClass('acu-btn-primary').addClass('acu-btn-secondary'),$(this).css('opacity','0.5')),D.setFilters({[e]:t}),bt.set('acu_debug_filters',D.filters),n(),i()}),a.find('#debug-console-clear').on('click',()=>{D.clear(),n(),i()}),a.find('#debug-console-copy').on('click',async()=>{const e=D.getFilteredLogs();if(0===e.length)return void(window.toastr&&window.toastr.warning('æ²¡æœ‰å¯å¤åˆ¶çš„æ—¥å¿—'));const t=e.map(e=>{let t=`[${e.timeStr}] [${e.type.toUpperCase()}] ${e.content}`;return e.stack&&(t+='\n'+e.stack),t}).join('\n');try{if(window.TavernHelper&&window.TavernHelper.triggerSlash){const e=t.replace(/\"/g,'\\"').replace(/\}/g,'\\}');return void await window.TavernHelper.triggerSlash(`/clipboard-set "${e}"`)}if(navigator.clipboard&&window.isSecureContext)await navigator.clipboard.writeText(t);else{const e=document.createElement('textarea');e.value=t,e.style.position='fixed',e.style.left='-9999px',e.style.top='0',e.setAttribute('readonly',''),document.body.appendChild(e),e.select(),e.setSelectionRange(0,99999);const n=document.execCommand('copy');if(document.body.removeChild(e),!n)throw new Error('execCommand failed')}}catch(e){console.error('[DICE]DebugConsole å¤åˆ¶å¤±è´¥:',e),window.toastr&&window.toastr.error('å¤åˆ¶å¤±è´¥')}}),a.find('#debug-console-export').on('click',()=>{const e=D.getFilteredLogs();if(0===e.length)return void(window.toastr&&window.toastr.warning('æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—'));const t=e.map(e=>{let t=`[${e.timeStr}] [${e.type.toUpperCase()}] ${e.content}`;return e.stack&&(t+='\n'+e.stack),t}).join('\n\n'),n=new Blob([t],{type:'text/plain;charset=utf-8'}),a=URL.createObjectURL(n),i=document.createElement('a');i.href=a,i.download=`debug-console-${(new Date).toISOString().slice(0,19).replace(/:/g,'-')}.txt`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a)}),a.find('#debug-console-close, .acu-edit-overlay').on('click',function(e){(e.target===this||$(e.target).closest('.acu-close-btn').length)&&a.remove()});const r=setInterval(()=>{a.length&&a.is(':visible')&&(n(),i())},500);a.on('remove',()=>{clearInterval(r)})},Cn=e=>{const{$}=ut(),t=`acu-theme-${an().theme}`,n=e?Q.getRule(e):null,a=Je||ln(),i=(Object.keys(a||{}).filter(e=>e.startsWith('sheet_')).map(e=>a[e]?.name||e).sort(),$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${t}">\n          <div class="acu-dice-cfg-header">\n            <span><i class="fa-solid fa-magic"></i> ${n?'ç¼–è¾‘':'æ·»åŠ '}æ­£åˆ™è½¬æ¢è§„åˆ™</span>\n            <button class="acu-config-close" id="acu-close-regex-rule"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-validation-modal-body">\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™åç§° *</span></div>\n              <input type="text" id="rule-name" class="acu-panel-input" value="${n?o(n.name):''}" placeholder="ä¾‹å¦‚: æ¸…ç†å¤šä½™ç©ºæ ¼" style="flex:1;" required>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">è§„åˆ™æè¿°</span></div>\n              <textarea id="rule-description" class="acu-panel-input" placeholder="è¾“å…¥è§„åˆ™ä»‹ç»" style="flex:1; resize: none; overflow-wrap: break-word; overflow-y: hidden; min-height: 34px; height: 34px; line-height: 1.4;">${n?o(n.description||''):''}</textarea>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">åŒ¹é…æ¨¡å¼ *</span></div>\n              <input type="text" id="rule-pattern" class="acu-panel-input" value="${n?o(n.pattern):''}" placeholder="ä¾‹å¦‚: \\s+ æˆ– /test/g" style="flex:1; font-family: monospace;" required>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">æ›¿æ¢å†…å®¹</span></div>\n              <input type="text" id="rule-replacement" class="acu-panel-input" value="${n?o(n.replacement||''):''}" placeholder="ç•™ç©ºè¡¨ç¤ºåˆ é™¤,æˆ–ä½¿ç”¨ $1, $2 ç­‰æ•è·ç»„" style="flex:1; font-family: monospace;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">ä½œç”¨èŒƒå›´ *</span></div>\n              <select id="rule-scope-type" class="acu-setting-select" style="width:120px;">\n                <option value="global" ${'global'===n?.scope?.type?'selected':''}>å…¨å±€</option>\n                <option value="table" ${'table'===n?.scope?.type?'selected':''}>è¡¨çº§</option>\n                <option value="column" ${'column'===n?.scope?.type?'selected':''}>åˆ—çº§</option>\n              </select>\n            </div>\n            <div class="acu-setting-row" id="field-table-names" style="display: ${'global'===n?.scope?.type?'none':'flex'};">\n              <div class="acu-setting-info"><span class="acu-setting-label">è¡¨æ ¼å (å¤šä¸ªç”¨é€—å·åˆ†éš”)</span></div>\n              <input type="text" id="rule-table-names" class="acu-panel-input" value="${n?.scope?.tableNames?.join(',')||''}" placeholder="ä¾‹å¦‚: ç‰©å“è¡¨,è£…å¤‡è¡¨" style="flex:1;">\n            </div>\n            <div class="acu-setting-row" id="field-column-names" style="display: ${'column'===n?.scope?.type?'flex':'none'};">\n              <div class="acu-setting-info"><span class="acu-setting-label">åˆ—å (å¤šä¸ªç”¨é€—å·åˆ†éš”)</span></div>\n              <input type="text" id="rule-column-names" class="acu-panel-input" value="${n?.scope?.columnNames?.join(',')||''}" placeholder="ä¾‹å¦‚: å“è´¨,æè¿°" style="flex:1;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">ä¼˜å…ˆçº§</span></div>\n              <input type="number" id="rule-priority" class="acu-panel-input" value="${n?.priority||50}" min="1" max="100" style="width:80px;">\n            </div>\n\n          </div>\n          <div class="acu-dice-cfg-actions">\n            <button id="acu-regex-rule-cancel">å–æ¶ˆ</button>\n            <button id="acu-regex-rule-confirm">ä¿å­˜</button>\n          </div>\n        </div>\n      </div>\n    `));i.find('#rule-scope-type').on('change',()=>{const e=i.find('#rule-scope-type').val();'global'===e?i.find('#field-table-names, #field-column-names').hide():'table'===e?(i.find('#field-table-names').css('display','flex').show(),i.find('#field-column-names').hide()):'column'===e&&i.find('#field-table-names, #field-column-names').css('display','flex').show()});const r=i.find('#rule-description');r.on('input',()=>{r.css('height','34px');const e=r[0].scrollHeight;r.css('height',Math.max(34,e)+'px')}),i.find('#acu-regex-rule-confirm').on('click',async function(){const t=i.find('#rule-name').val(),n=i.find('#rule-pattern').val(),a=i.find('#rule-scope-type').val();if(!t||!n)return void toastr.error('è¯·å¡«å†™è§„åˆ™åç§°å’ŒåŒ¹é…æ¨¡å¼');const o={type:a};if('global'!==a){const e=i.find('#rule-table-names').val();e&&(o.tableNames=String(e).split(',').map(e=>e.trim()).filter(e=>e))}if('column'===a){const e=i.find('#rule-column-names').val();e&&(o.columnNames=String(e).split(',').map(e=>e.trim()).filter(e=>e))}const r=String(n),{flags:c,patternWithoutFlags:s}=te._extractFlags(r),l=i.find('#flag-global'),d=i.find('#flag-ignorecase'),u=i.find('#flag-multiline'),p={global:l.length>0&&l.is(':checked'),caseInsensitive:d.length>0&&d.is(':checked'),multiline:u.length>0&&u.is(':checked')},g=s!==r?s:r,f=s!==r?{...p,...c}:p,b={name:String(t),description:i.find('#rule-description').val(),operation:'replace',pattern:g,flags:f,replacement:i.find('#rule-replacement').val(),scope:o,enabled:!0,priority:parseInt(i.find('#rule-priority').val(),10),executeMode:'auto'};if(e)Q.updateRule(e,b),toastr.success('è§„åˆ™å·²æ›´æ–°');else{const t=Q.addCustomRule(b);t&&(e=t.id,toastr.success('è§„åˆ™å·²æ·»åŠ '))}i.remove(),$('.acu-settings-dialog').length>0&&gn()});const c=()=>{qe=!1,i.remove(),Sn()};i.find('#acu-regex-rule-cancel, #acu-close-regex-rule').on('click',c),i.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&c()}),$(document).on('keydown.regex-rule-modal',function(e){'Escape'===e.key&&i.length&&i.is(':visible')&&(e.preventDefault(),c(),$(document).off('keydown.regex-rule-modal'))}),$('body').append(i),requestAnimationFrame(()=>{const e=i.find('#rule-description');e.length&&e[0].scrollHeight>34&&e.css('height',e[0].scrollHeight+'px')})};window.showAddRegexRuleModal=Cn,window.showDebugConsoleModal=$n;const _n=()=>{const{$}=ut();$('.acu-edit-overlay').not(':has(.acu-settings-dialog)').remove(),qe=!0;const e=an(),t=`acu-theme-${e.theme}`,n=(Me(),bt.get('acu_settings_expanded',['appearance'])),a=e=>n.includes(e),i=[{key:'__dice__',name:'æŠ•éª°',icon:'fa-dice-d20'},{key:'__changes__',name:'å˜æ›´å®¡æ ¸',icon:'fa-code-compare'},{key:'__mvu__',name:'MVUå˜é‡',icon:'fa-code-branch'}],r=(()=>{const e=Je||ln(),t=pn(e||{}),n=yt()||[],a=It();let r=[];if(i.forEach(e=>{r.push({key:e.key,name:e.name,icon:e.icon,isSpecial:!0})}),Object.keys(t).forEach(e=>{r.push({key:e,name:e,icon:gt(e),isSpecial:!1})}),n.length>0){const e=new Map(n.map((e,t)=>[e,t]));r.sort((t,n)=>(e.has(t.key)?e.get(t.key):9999)-(e.has(n.key)?e.get(n.key):9999))}return r.map(e=>{const t=a.includes(e.key),n=e.isSpecial?' acu-special-item':'',i=e.name;return'<div class="acu-table-manager-item'+n+(t?' hidden-table':'')+'" data-table-name="'+o(e.key)+'" draggable="false"><div class="acu-table-item-check" title="ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤º/éšè—"><i class="fa-solid '+(t?'fa-eye-slash':'fa-eye')+'"></i></div><div class="acu-table-item-icon"><i class="fa-solid '+e.icon+'"></i></div><div class="acu-table-item-name">'+o(i)+'</div><div class="acu-table-item-handle" title="æ‹–æ‹½æ’åº"><i class="fa-solid fa-grip-vertical"></i></div></div>'}).join('')})(),c=e=>a(e)?'fa-chevron-down':'fa-chevron-right',s=$(`\n        <div class="acu-edit-overlay">\n            <div class="acu-edit-dialog acu-settings-dialog ${t}">\n                <div class="acu-settings-header">\n                    <div class="acu-settings-title">\n                        <span class="acu-settings-text">\n                            <i class="fa-solid fa-cog"></i> è®¾ç½®\n                            <span class="acu-version-badge">v3.3</span>\n                        </span>\n                    </div>\n                    <div class="acu-header-actions">\n                        <button class="acu-help-btn" id="acu-help-btn" title="æŸ¥çœ‹ä½¿ç”¨æ–‡æ¡£"><i class="fa-solid fa-question-circle"></i></button>\n                        <button class="acu-close-btn" id="dlg-close-x"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                </div>\n\n                <div class="acu-settings-body">\n                \x3c!-- å¤–è§‚æ ·å¼ --\x3e\n                <div class="acu-settings-group ${a('appearance')?'':'collapsed'}" data-group="appearance">                    <div class="acu-settings-group-title">\n                        <i class="fa-solid ${c('appearance')} acu-group-chevron"></i>\n                        <i class="fa-solid fa-palette"></i> å¤–è§‚æ ·å¼\n                    </div>\n                    <div class="acu-settings-group-body">\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">èƒŒæ™¯ä¸»é¢˜</span>\n                            </div>\n                            <select id="cfg-theme" class="acu-setting-select">\n                                ${lt.map(t=>`<option value="${t.id}" ${t.id===e.theme?'selected':''}>${t.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">å­—ä½“é£æ ¼</span>\n                            </div>\n                            <select id="cfg-font-family" class="acu-setting-select">\n                                ${st.map(t=>`<option value="${t.id}" ${t.id===e.fontFamily?'selected':''}>${t.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">å­—ä½“å¤§å° (ç•Œé¢)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-main" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${e.fontSize}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">å­—ä½“å¤§å° (é€‰é¡¹)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-opt" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${e.optionFontSize||12}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row acu-setting-row-toggle">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">é«˜äº®å˜åŒ–å†…å®¹</span>\n                            </div>\n                            <label class="acu-toggle">\n                                <input type="checkbox" id="cfg-new" ${e.highlightNew?'checked':''}>\n                                <span class="acu-toggle-slider"></span>\n                            </label>\n                        </div>\n                    </div>\n                </div>\n\n                    \x3c!-- å¸ƒå±€è®¾ç½® --\x3e\n                    <div class="acu-settings-group ${a('layout')?'':'collapsed'}" data-group="layout">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${c('layout')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-th-large"></i> å¸ƒå±€è®¾ç½®\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">å¡ç‰‡å®½åº¦</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-width" data-min="200" data-max="500" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${e.cardWidth}px</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">å¸ƒå±€æ¨¡å¼</span>\n                                </div>\n                                <select id="cfg-layout" class="acu-setting-select">\n                                    <option value="horizontal" ${'vertical'!==e.layout?'selected':''}>æ¨ªå‘æ»šåŠ¨</option>\n                                    <option value="vertical" ${'vertical'===e.layout?'selected':''}>ç«–å‘æ»šåŠ¨</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">åº•éƒ¨æŒ‰é’®åˆ—æ•°</span>\n                                    <span class="acu-setting-hint">ä»…ç§»åŠ¨ç«¯</span>\n                                </div>\n                                <select id="cfg-grid-cols" class="acu-setting-select acu-select-short">\n                                    <option value="2" ${2==e.gridColumns?'selected':''}>2åˆ—</option>\n                                    <option value="3" ${3==e.gridColumns?'selected':''}>3åˆ—</option>\n                                    <option value="4" ${4==e.gridColumns?'selected':''}>4åˆ—</option>\n                                    <option value="auto" ${'auto'===e.gridColumns?'selected':''}>è‡ªåŠ¨</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ¯é¡µæ˜¾ç¤ºæ¡æ•°</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-per-page" data-min="10" data-max="200" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${e.itemsPerPage}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n\n                    \x3c!-- ä½ç½®ä¸äº¤äº’ --\x3e\n                    <div class="acu-settings-group ${a('position')?'':'collapsed'}" data-group="position">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${c('position')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-arrows-alt"></i> ä½ç½®ä¸äº¤äº’\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">é¢æ¿ä½ç½®</span>\n                                </div>\n                                <select id="cfg-position" class="acu-setting-select">\n                                    <option value="fixed" ${'embedded'!==e.positionMode?'selected':''}>æ‚¬æµ®åº•éƒ¨</option>\n                                    <option value="embedded" ${'embedded'===e.positionMode?'selected':''}>è·Ÿéšæ¶ˆæ¯</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">åŠŸèƒ½æŒ‰é’®ä½ç½®</span>\n                                </div>\n                                <select id="cfg-action-pos" class="acu-setting-select acu-select-short">\n                                    <option value="bottom" ${'top'!==e.actionsPosition?'selected':''}>åº•éƒ¨</option>\n                                    <option value="top" ${'top'===e.actionsPosition?'selected':''}>é¡¶éƒ¨</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ”¶èµ·æ ·å¼</span>\n                                </div>\n                                <select id="cfg-col-style" class="acu-setting-select acu-select-short">\n                                    <option value="bar" ${'bar'===e.collapseStyle?'selected':''}>é•¿æ¡</option>\n                                    <option value="pill" ${'pill'===e.collapseStyle?'selected':''}>èƒ¶å›Š</option>\n                                    <option value="mini" ${'mini'===e.collapseStyle?'selected':''}>åœ†é’®</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ”¶èµ·ä½ç½®</span>\n                                </div>\n                                <select id="cfg-col-align" class="acu-setting-select acu-select-short">\n                                    <option value="right" ${'left'!==e.collapseAlign?'selected':''}>é å³</option>\n                                    <option value="left" ${'left'===e.collapseAlign?'selected':''}>é å·¦</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- è¡ŒåŠ¨é€‰é¡¹ --\x3e\n                    <div class="acu-settings-group ${a('options')?'':'collapsed'}" data-group="options">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${c('options')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-gamepad"></i> è¡ŒåŠ¨é€‰é¡¹\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row acu-setting-row-toggle">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">æ˜¾ç¤ºè¡ŒåŠ¨é€‰é¡¹é¢æ¿</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-show-opt" ${!1!==e.showOptionPanel?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                            <div class="acu-setting-row acu-setting-row-toggle" id="row-auto-send" style="${!1!==e.showOptionPanel?'':'display:none;'}">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">ç‚¹å‡»é€‰é¡¹ç›´æ¥å‘é€</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-auto-send" ${!1!==e.clickOptionToAutoSend?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                    </div>\n\n                \x3c!-- è¡¨æ ¼ç®¡ç† --\x3e\n                    <div class="acu-settings-group ${a('tables')?'':'collapsed'}" data-group="tables">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${c('tables')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-table"></i> è¡¨æ ¼ç®¡ç†\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-table-manager-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> ç‚¹å‡»åˆ‡æ¢æ˜¾ç¤ºï¼Œé•¿æŒ‰æ‹–æ‹½æ’åº\n                            </div>\n                            <div class="acu-table-manager-list" id="table-manager-list">\n                                ${r}\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- æ•°æ®éªŒè¯è§„åˆ™ --\x3e\n                    <div class="acu-settings-group ${a('validation')?'':'collapsed'}" data-group="validation">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${c('validation')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-clipboard-check"></i> æ•°æ®éªŒè¯è§„åˆ™\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- é¢„è®¾é€‰æ‹©å™¨ --\x3e\n                            <div class="acu-setting-row" style="margin-bottom:8px;">\n                                <span>å½“å‰é¢„è®¾</span>\n                                <select class="acu-setting-select" id="preset-select" style="flex:1;max-width:160px;">\n                                    ${G.getAllPresets().map(e=>`<option value="${o(e.id)}" ${e.id===G.getActivePreset()?.id?'selected':''}>${o(e.name)}${e.builtin?' (å†…ç½®)':''}</option>`).join('')}\n                                </select>\n                            </div>\n                            \x3c!-- é¢„è®¾æ“ä½œæŒ‰é’® --\x3e\n                            <div style="display:flex;gap:6px;margin-bottom:10px;">\n                                <button class="acu-action-btn" id="btn-preset-dup" title="å¤åˆ¶é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-copy"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-new" title="æ–°å»ºé¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-plus"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-del" title="åˆ é™¤é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-trash"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-export" title="å¯¼å‡º" style="flex:1;height:28px;"><i class="fa-solid fa-file-export"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-import" title="å¯¼å…¥" style="flex:1;height:28px;"><i class="fa-solid fa-file-import"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-reset" title="æ¢å¤é»˜è®¤é¢„è®¾è§„åˆ™" style="flex:1;height:28px;"><i class="fa-solid fa-rotate-left"></i></button>\n                            </div>\n                            <div class="acu-validation-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> éªŒè¯è§„åˆ™ç”¨äºæ£€æµ‹æ•°æ®åˆæ³•æ€§ï¼Œ<i class="fa-solid fa-shield-halved"></i> è¡¨ç¤ºå¯ç”¨æ‹¦æˆª\n                            </div>\n                            <div class="acu-validation-rules-list" id="validation-rules-list">\n                                ${Z.getAllRules().map(e=>{const t=V[e.ruleType]||{name:e.ruleType,icon:'fa-question'},n='table'===t.scope,a=e.intercept;return`\n                                    <div class="acu-validation-rule-item ${e.enabled?'':'disabled'}" data-rule-id="${o(e.id)}">\n                                        <div class="acu-rule-type-icon" title="${o(t.name)}${n?' (è¡¨çº§)':''}">\n                                            <i class="fa-solid ${t.icon}"></i>\n                                        </div>\n                                        <div class="acu-rule-info">\n                                            <div class="acu-rule-name">${o(e.name)}</div>\n                                            <div class="acu-rule-target">${o(e.targetTable)}${e.targetColumn?'.'+o(e.targetColumn):n?' (æ•´è¡¨)':''}</div>\n                                        </div>\n                                        <div class="acu-rule-intercept ${a?'active':''}" data-rule-id="${o(e.id)}" title="${a?'ç‚¹å‡»å…³é—­æ‹¦æˆª':'ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰'}"><i class="fa-solid fa-shield-halved"></i></div>\n                                        <button class="acu-rule-edit" data-rule-id="${o(e.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n                                        <div class="acu-rule-toggle ${e.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n                                            <i class="fa-solid ${e.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n                                        </div>\n                                        <button class="acu-rule-delete" data-rule-id="${o(e.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n                                    </div>\n                                `}).join('')}\n                            </div>\n                            <button class="acu-add-rule-btn" id="btn-add-validation-rule">\n                                <i class="fa-solid fa-plus"></i> æ·»åŠ è‡ªå®šä¹‰éªŒè¯è§„åˆ™\n                            </button>\n                        </div>\n                    </div>\n\n                    \x3c!-- æ­£åˆ™è½¬æ¢è§„åˆ™ - Phase 4.1 --\x3e\n                    <div class="acu-settings-group ${a('regex')?'':'collapsed'}" data-group="regex">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${c('regex')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-wand-magic-sparkles"></i> æ­£åˆ™è½¬æ¢è§„åˆ™\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- é¢„è®¾é€‰æ‹©å™¨ --\x3e\n                            <div class="acu-setting-row" style="margin-bottom:8px;">\n                                <span>å½“å‰é¢„è®¾</span>\n                                <select class="acu-setting-select" id="regex-preset-select" style="flex:1;max-width:160px;">\n                                    ${ee.getAllPresets().map(e=>`<option value="${o(e.id)}" ${e.id===ee.getActivePreset()?.id?'selected':''}>${o(e.name)}</option>`).join('')}\n                                </select>\n                            </div>\n                            \x3c!-- é¢„è®¾æ“ä½œæŒ‰é’® --\x3e\n                            <div style="display:flex;gap:6px;margin-bottom:10px;">\n                                <button class="acu-action-btn" id="btn-regex-preset-dup" title="å¤åˆ¶é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-copy"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-new" title="æ–°å»ºé¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-plus"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-del" title="åˆ é™¤é¢„è®¾" style="flex:1;height:28px;"><i class="fa-solid fa-trash"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-export" title="å¯¼å‡º" style="flex:1;height:28px;"><i class="fa-solid fa-file-export"></i></button>\n                                <button class="acu-action-btn" id="btn-regex-preset-import" title="å¯¼å…¥" style="flex:1;height:28px;"><i class="fa-solid fa-file-import"></i></button>\n                                <button class="acu-action-btn" id="btn-execute-regex-now" title="ç«‹å³å¯¹æ‰€æœ‰è¡¨æ ¼åº”ç”¨å·²å¯ç”¨çš„è§„åˆ™" style="flex:1;height:28px;background:var(--acu-btn-accent, #4a9eff);color:white;"><i class="fa-solid fa-play"></i></button>\n                            </div>\n                            <div class="acu-validation-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> æ­£åˆ™è½¬æ¢è§„åˆ™ç”¨äºè‡ªåŠ¨ä¿®æ”¹æ•°æ®æ ¼å¼\n                            </div>\n                            \x3c!-- è§„åˆ™åˆ—è¡¨ --\x3e\n                            <div class="acu-validation-rules-list" id="regex-rules-list">\n                                ${Q.getAllRules().map(e=>{const t='global'===e.scope.type?'fa-globe':'table'===e.scope.type?'fa-table':'fa-columns',n='global'===e.scope.type?'å…¨å±€':'table'===e.scope.type?e.scope.tableNames?.join(','):`${e.scope.tableNames?.join(',')}.${e.scope.columnNames?.join(',')}`;return`\n                                    <div class="acu-validation-rule-item ${e.enabled?'':'disabled'}" data-rule-id="${o(e.id)}">\n                                        <div class="acu-rule-type-icon" title="ä½œç”¨åŸŸ: ${o(e.scope.type)}">\n                                            <i class="fa-solid ${t}"></i>\n                                        </div>\n                                        <div class="acu-rule-info">\n                                            <div class="acu-rule-name">${o(e.name)}</div>\n                                            <div class="acu-rule-target" style="font-size:10px;">${o(n)} | ${o(e.operation)}</div>\n                                        </div>\n                                        <button class="acu-rule-edit" data-rule-id="${o(e.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n                                        <div class="acu-rule-toggle ${e.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n                                            <i class="fa-solid ${e.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n                                        </div>\n                                        <button class="acu-rule-delete" data-rule-id="${o(e.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n                                    </div>\n                                `}).join('')}\n                            </div>\n                            <div style="display:flex;gap:8px;margin-top:8px;">\n                                <button class="acu-add-rule-btn" id="btn-add-regex-rule" style="flex:1;">\n                                    <i class="fa-solid fa-plus"></i> æ·»åŠ è½¬æ¢è§„åˆ™\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- é«˜çº§è®¾ç½® --\x3e\n                    <div class="acu-settings-group ${a('advanced')?'':'collapsed'}" data-group="advanced">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${c('advanced')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-sliders-h"></i> é«˜çº§è®¾ç½®\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- ç–¯ç‹‚æ¨¡å¼è®¾ç½® --\x3e\n                            <div class="acu-setting-row" style="flex-direction: column; align-items: stretch;">\n                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-fire" style="color: #e74c3c;"></i> ç–¯ç‹‚æ¨¡å¼</span>\n                                    <label class="acu-toggle" style="margin-left: auto;">\n                                        <input type="checkbox" id="cfg-crazy-mode-enabled">\n                                        <span class="acu-toggle-slider"></span>\n                                    </label>\n                                </div>\n                                <div id="crazy-level-container" style="display: flex; align-items: center; gap: 10px; padding: 8px 0;">\n                                    <span style="font-size: 12px; color: var(--acu-text-sub, #666);">ç–¯ç‹‚ç¨‹åº¦:</span>\n                                    <input type="range" id="cfg-crazy-level" min="0" max="100" value="50" style="flex: 1; height: 6px;">\n                                    <span id="cfg-crazy-level-value" style="min-width: 40px; text-align: right; font-weight: bold; color: #e74c3c;">50%</span>\n                                </div>\n                                <div style="font-size: 11px; color: var(--acu-text-sub, #888); line-height: 1.4; margin-top: 4px;">\n                                    å¼€å¯åï¼Œå‘é€æ¶ˆæ¯æ—¶ä¼šæ ¹æ®ç–¯ç‹‚ç¨‹åº¦è‡ªåŠ¨é™„åŠ éª°å­æ£€å®šç»“æœã€‚ç¨‹åº¦è¶Šé«˜ï¼Œè§¦å‘æ¦‚ç‡è¶Šå¤§ï¼Œä¸”æ›´å¯èƒ½å‡ºç°å¯¹æŠ—æ£€å®šã€‚\n                                </div>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-dice-d20"></i> ç®¡ç†å±æ€§è§„åˆ™</span>\n                                </div>\n                                <button id="cfg-attr-preset-manage" class="acu-setting-action-btn" style="width: auto; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> ç®¡ç†\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-filter"></i> è¿‡æ»¤é»‘åå•</span>\n                                </div>\n                                <button id="cfg-blacklist-manage" class="acu-setting-action-btn" style="width: auto; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-cog"></i> ç®¡ç†\n                                </button>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label"><i class="fa-solid fa-bug"></i> Debugæ§åˆ¶å°</span>\n                                </div>\n                                <button id="btn-open-debug-console" class="acu-setting-action-btn" style="width: auto; padding: 6px 12px; font-size: 12px; margin-bottom: 0;">\n                                    <i class="fa-solid fa-terminal"></i> æ‰“å¼€\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                </div>\x3c!-- å…³é—­ .acu-settings-body --\x3e\n            </div>\n        </div>\n    `);$('body').append(s),s.find('.acu-settings-group-title').on('click',function(){const e=$(this).closest('.acu-settings-group'),t=e.find('.acu-settings-group-body');if(t.hasClass('acu-animating'))return;const n=e.data('group'),a=$(this).find('.acu-group-chevron');let i=bt.get('acu_settings_expanded',['appearance']);if(e.hasClass('collapsed')){e.removeClass('collapsed'),a.removeClass('fa-chevron-right').addClass('fa-chevron-down'),i.includes(n)||i.push(n),t.addClass('acu-animating').show();const o=t.prop('scrollHeight');t.css('height',0).animate({height:o},180,function(){$(this).css('height','').removeClass('acu-animating')})}else{e.addClass('collapsed'),a.removeClass('fa-chevron-down').addClass('fa-chevron-right'),i=i.filter(e=>e!==n);const o=t.outerHeight();t.addClass('acu-animating').css('height',o).animate({height:0},180,function(){$(this).hide().css('height','').removeClass('acu-animating')})}bt.set('acu_settings_expanded',i)}),s.find('#cfg-theme').on('change',function(){const e=$(this).val();on({theme:e}),s.find('.acu-edit-dialog').removeClass(lt.map(e=>`acu-theme-${e.id}`).join(' ')).addClass(`acu-theme-${e}`);const t=Me();s.find('#cfg-attr-preset-manage').css({background:t.btnBg,borderColor:t.border,color:t.textMain})}),s.find('#cfg-font-family').on('change',function(){on({fontFamily:$(this).val()})}),s.find('#cfg-attr-preset-manage').on('click',function(e){e.preventDefault(),e.stopPropagation(),s.remove(),qe=!1,wn()});(()=>{const e=ve();s.find('#cfg-crazy-mode-enabled').prop('checked',e.enabled),s.find('#cfg-crazy-level').val(e.crazyLevel),s.find('#cfg-crazy-level-value').text(e.crazyLevel+'%'),s.find('#crazy-level-container').css('opacity',e.enabled?'1':'0.5'),s.find('#cfg-crazy-mode-enabled').on('change',function(){const e=$(this).prop('checked'),t=ve();xe({...t,enabled:e}),s.find('#crazy-level-container').css('opacity',e?'1':'0.5'),e?toastr.success('ç–¯ç‹‚æ¨¡å¼å·²å¯ç”¨'):toastr.info('ç–¯ç‹‚æ¨¡å¼å·²å…³é—­')}),s.find('#cfg-crazy-level').on('input',function(){const e=parseInt($(this).val(),10);s.find('#cfg-crazy-level-value').text(e+'%')}),s.find('#cfg-crazy-level').on('change',function(){const e=parseInt($(this).val(),10),t=ve();xe({...t,crazyLevel:e})})})(),s.find('#cfg-blacklist-manage').on('click',function(e){e.preventDefault(),e.stopPropagation(),yn()}),s.find('#cfg-layout').on('change',function(){on({layout:$(this).val()}),Sn()}),s.find('#cfg-grid-cols').on('change',function(){on({gridColumns:$(this).val()})}),s.find('#cfg-position').on('change',function(){on({positionMode:$(this).val()}),Sn()}),s.find('#cfg-action-pos').on('change',function(){on({actionsPosition:$(this).val()}),Sn()}),s.find('#cfg-col-style').on('change',function(){on({collapseStyle:$(this).val()}),Sn()}),s.find('#cfg-col-align').on('change',function(){on({collapseAlign:$(this).val()}),Sn()}),s.find('#cfg-show-opt').on('change',function(){const e=$(this).is(':checked');on({showOptionPanel:e}),e?s.find('#row-auto-send').slideDown(200):s.find('#row-auto-send').slideUp(200),Sn()}),s.find('#cfg-auto-send').on('change',function(){on({clickOptionToAutoSend:$(this).is(':checked')})}),s.find('#cfg-new').on('change',function(){on({highlightNew:$(this).is(':checked')}),Sn()}),s.find('.acu-table-item-check').on('click',function(e){e.stopPropagation();const t=$(this).closest('.acu-table-manager-item'),n=t.data('table-name');let a=It();const i=$(this).find('i');var o;a.includes(n)?(a=a.filter(e=>e!==n),t.removeClass('hidden-table'),i.removeClass('fa-eye-slash').addClass('fa-eye')):(a.push(n),t.addClass('hidden-table'),i.removeClass('fa-eye').addClass('fa-eye-slash')),o=a,bt.set(x,o),Sn()});const l=s.find('#table-manager-list');let d={isDragging:!1,element:null,timer:null,startY:0};const u=()=>{d.timer&&(clearTimeout(d.timer),d.timer=null),d.element&&$(d.element).removeClass('acu-dragging'),l.find('.acu-drag-above, .acu-drag-below').removeClass('acu-drag-above acu-drag-below'),d.isDragging=!1,d.element=null},p=e=>{d.isDragging=!0,d.element=e[0],e.addClass('acu-dragging')};l[0].addEventListener('pointerdown',function(e){const t=e.target.closest('.acu-table-item-handle');if(!t)return;e.preventDefault();const n=$(t).closest('.acu-table-manager-item');d.startY=e.clientY,p(n),t.setPointerCapture(e.pointerId)},{passive:!1}),l[0].addEventListener('pointerdown',function(e){const t=e.target.closest('.acu-table-manager-item');if(!t)return;if(e.target.closest('.acu-table-item-check, .acu-table-item-handle'))return;d.startY=e.clientY;const n=$(t);d.timer=setTimeout(()=>{p(n)},350)}),l[0].addEventListener('pointermove',function(e){if(d.timer&&Math.abs(e.clientY-d.startY)>8&&(clearTimeout(d.timer),d.timer=null),!d.isDragging||!d.element)return;e.preventDefault();const t=l.find('.acu-table-manager-item').not('.acu-dragging');let n=null,a=!0;t.each(function(){const t=this.getBoundingClientRect(),i=t.top+t.height/2;e.clientY<i&&!n?(n=this,a=!0):e.clientY>=t.top&&e.clientY<=t.bottom&&(n=this,a=e.clientY<i)}),l.find('.acu-drag-above, .acu-drag-below').removeClass('acu-drag-above acu-drag-below'),n&&n!==d.element&&$(n).addClass(a?'acu-drag-above':'acu-drag-below')},{passive:!1}),l[0].addEventListener('pointerup',()=>{if(!d.isDragging||!d.element)return void u();const e=$(d.element),t=l.find('.acu-drag-above, .acu-drag-below').first();if(t.length&&t[0]!==d.element){t.hasClass('acu-drag-above')?e.insertBefore(t):e.insertAfter(t);const n=[];l.find('.acu-table-manager-item').each(function(){n.push($(this).data('table-name'))}),wt(n)}u()}),l[0].addEventListener('pointercancel',u),l[0].addEventListener('touchmove',function(e){d.isDragging&&e.preventDefault()},{passive:!1}),s.find('.acu-stepper').each(function(){const e=$(this),t=e.data('id'),n=parseInt(e.data('min')),a=parseInt(e.data('max')),i=parseInt(e.data('step')),o=e.find('.acu-stepper-value'),r=e=>{e=Math.max(n,Math.min(a,e));const i='cfg-per-page'===t?'':'px';o.text(e+i),'cfg-width'===t?($('.acu-wrapper').css('--acu-card-width',e+'px'),on({cardWidth:e})):'cfg-font-main'===t?($('.acu-wrapper').css('--acu-font-size',e+'px'),on({fontSize:e})):'cfg-font-opt'===t?($('.acu-wrapper, .acu-embedded-options-container').css('--acu-opt-font-size',e+'px'),on({optionFontSize:e})):'cfg-per-page'===t&&on({itemsPerPage:e})},c=()=>{const e=o.text().replace(/[^\d]/g,'');return parseInt(e)||n};e.find('.acu-stepper-dec').on('click',function(){r(c()-i)}),e.find('.acu-stepper-inc').on('click',function(){r(c()+i)})}),s.on('click','.acu-rule-toggle',function(e){e.stopPropagation();const t=$(this),n=t.closest('.acu-validation-rule-item'),a=n.data('rule-id'),i=t.find('i'),o=t.hasClass('active');Z.toggleRuleEnabled(a,!o),o?(t.removeClass('active'),i.removeClass('fa-toggle-on').addClass('fa-toggle-off'),n.addClass('disabled')):(t.addClass('active'),i.removeClass('fa-toggle-off').addClass('fa-toggle-on'),n.removeClass('disabled'))}),s.on('click','#validation-rules-list .acu-rule-edit',function(e){e.stopPropagation();const t=$(this).data('rule-id');Z.getRule(t)&&(s.remove(),fn(t))}),s.on('click','#validation-rules-list .acu-rule-delete',function(e){e.stopPropagation();const t=$(this).data('rule-id'),n=$(this).closest('.acu-validation-rule-item');confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è‡ªå®šä¹‰è§„åˆ™å—ï¼Ÿ')&&Z.removeCustomRule(t)&&n.fadeOut(200,function(){$(this).remove()})}),s.on('click','.acu-rule-intercept',function(e){e.stopPropagation();const t=$(this),n=t.data('rule-id'),a=t.hasClass('active');Z.toggleRuleIntercept(n,!a)&&(a?t.removeClass('active').attr('title','ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰'):t.addClass('active').attr('title','ç‚¹å‡»å…³é—­æ‹¦æˆª'))});const g=()=>{Z.clearCache();const e=Z.getAllRules();let t='';e.forEach(e=>{const n=V[e.ruleType]||{name:e.ruleType,icon:'fa-question'},a='table'===n.scope,i=e.intercept;t+=`\n          <div class="acu-validation-rule-item ${e.enabled?'':'disabled'}" data-rule-id="${o(e.id)}">\n            <div class="acu-rule-type-icon" title="${o(n.name)}${a?' (è¡¨çº§)':''}">\n              <i class="fa-solid ${n.icon}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${o(e.name)}</div>\n              <div class="acu-rule-target">${o(e.targetTable)}${e.targetColumn?'.'+o(e.targetColumn):a?' (æ•´è¡¨)':''}</div>\n            </div>\n            <div class="acu-rule-intercept ${i?'active':''}" data-rule-id="${o(e.id)}" title="${i?'ç‚¹å‡»å…³é—­æ‹¦æˆª':'ç‚¹å‡»å¯ç”¨æ‹¦æˆªï¼ˆè¿åæ—¶å›æ»šï¼‰'}"><i class="fa-solid fa-shield-halved"></i></div>\n            <button class="acu-rule-edit" data-rule-id="${o(e.id)}" title="ç¼–è¾‘æ­¤è§„åˆ™" style="background:none;border:none;color:var(--text-sub);cursor:pointer;padding:4px;opacity:0.6;transition:all 0.2s;flex-shrink:0;"><i class="fa-solid fa-pen"></i></button>\n            <div class="acu-rule-toggle ${e.enabled?'active':''}" title="ç‚¹å‡»åˆ‡æ¢å¯ç”¨/ç¦ç”¨">\n              <i class="fa-solid ${e.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${o(e.id)}" title="åˆ é™¤æ­¤è§„åˆ™"><i class="fa-solid fa-trash"></i></button>\n          </div>`}),s.find('#validation-rules-list').html(t)};s.find('#preset-select').on('change',function(){G.setActivePreset($(this).val())&&g()}),s.find('#btn-preset-dup').on('click',function(){const e=G.getActivePreset();if(!e)return;const t=G.duplicatePreset(e.id);t&&(s.find('#preset-select').append(`<option value="${o(t.id)}">${o(t.name)}</option>`),s.find('#preset-select').val(t.id).trigger('change'))}),s.find('#btn-preset-new').on('click',function(){const e=prompt('è¯·è¾“å…¥æ–°é¢„è®¾åç§°:','æˆ‘çš„é¢„è®¾');if(!e?.trim())return;const t=G.createPreset(e.trim());t&&(s.find('#preset-select').append(`<option value="${o(t.id)}">${o(t.name)}</option>`),s.find('#preset-select').val(t.id).trigger('change'))}),s.find('#btn-preset-del').on('click',function(){const e=G.getActivePreset();e&&('default'!==e.id?confirm(`ç¡®å®šåˆ é™¤é¢„è®¾"${e.name}"å—ï¼Ÿ`)&&G.deletePreset(e.id)&&(s.find(`#preset-select option[value="${e.id}"]`).remove(),s.find('#preset-select').val('default').trigger('change')):window.toastr&&window.toastr.warning('é»˜è®¤é¢„è®¾ä¸èƒ½åˆ é™¤'))}),s.find('#btn-preset-export').on('click',function(){const e=G.getActivePreset();if(!e)return;const t=G.exportPreset(e.id);if(t)try{const n=`acu_validation_preset_${e.name||e.id}_${Date.now()}.json`,a=new Blob([t],{type:'application/json'}),i=URL.createObjectURL(a),o=document.createElement('a');o.href=i,o.download=n,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i)}catch(e){navigator.clipboard.writeText(t).then(()=>{}).catch(()=>{prompt('å¤åˆ¶ä»¥ä¸‹å†…å®¹:',t)})}}),s.find('#btn-preset-import').on('click',function(){const e=prompt('ç²˜è´´é¢„è®¾ JSON:');if(!e?.trim())return;const t=G.importPreset(e.trim(),!1);if(t&&t.preset){const e=t.preset;s.find('#preset-select').append(`<option value="${o(e.id)}">${o(e.name)}</option>`),s.find('#preset-select').val(e.id).trigger('change'),t.needsMerge&&confirm('æ£€æµ‹åˆ°é¢„è®¾ç‰ˆæœ¬è¾ƒæ—§ï¼Œæ˜¯å¦è¦åˆå¹¶æ–°ç‰ˆæœ¬çš„é»˜è®¤å€¼ï¼Ÿ\n\nè¿™å°†ä¿ç•™æ‚¨çš„è‡ªå®šä¹‰è§„åˆ™ï¼Œå¹¶æ·»åŠ æ–°ç‰ˆæœ¬ä¸­çš„æ–°è§„åˆ™ã€‚')&&(G.mergePresetWithDefaults(e.id)?(window.toastr&&window.toastr.success('é¢„è®¾å·²åˆå¹¶æ–°ç‰ˆæœ¬çš„é»˜è®¤å€¼'),g()):window.toastr&&window.toastr.error('åˆå¹¶å¤±è´¥'))}else window.toastr&&window.toastr.error('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼')}),s.find('#btn-preset-reset').on('click',function(){confirm('ç¡®å®šè¦å°†é»˜è®¤é¢„è®¾æ¢å¤ä¸ºåˆå§‹çŠ¶æ€å—ï¼Ÿ\nè¿™å°†åˆ é™¤æ‰€æœ‰å¯¹é»˜è®¤é¢„è®¾çš„ä¿®æ”¹ã€‚')&&(G.resetDefaultPreset()?'default'===G.getActivePreset()?.id&&g():window.toastr&&window.toastr.error('æ¢å¤å¤±è´¥'))}),s.on('click','#regex-rules-list .acu-rule-toggle',function(){const e=$(this).closest('.acu-validation-rule-item').data('rule-id'),t=Q.getAllRules().find(t=>t.id===e)?.enabled,n=!t;Q.getRule(e);Q.toggleRuleEnabled(e,n),n?toastr.success('è§„åˆ™å·²å¯ç”¨'):toastr.info('è§„åˆ™å·²ç¦ç”¨'),gn()}),s.on('click','#regex-rules-list .acu-rule-edit',function(){const e=$(this).closest('.acu-validation-rule-item').data('rule-id');Q.getRule(e)&&(s.remove(),Cn(e))}),s.on('click','#regex-rules-list .acu-rule-delete',function(){const e=$(this).closest('.acu-validation-rule-item').data('rule-id'),t=Q.getRule(e);t&&confirm(`ç¡®å®šè¦åˆ é™¤è§„åˆ™"${t.name}"å—ï¼Ÿ`)&&(Q.removeRule(e),gn(),toastr.success('è§„åˆ™å·²åˆ é™¤'))}),s.find('#regex-preset-select').on('change',function(){const e=$(this).val();ee.setActivePreset(String(e)),toastr.success('é¢„è®¾å·²åˆ‡æ¢'),gn()}),s.find('#btn-regex-preset-dup').on('click',function(){const e=ee.getActivePreset();if(!e)return;const t=prompt('è¯·è¾“å…¥æ–°é¢„è®¾åç§°:',`${e.name} (å‰¯æœ¬)`);if(!t)return;const n=ee.createPreset(t,e.id);if(n){const e=s.find('#regex-preset-select');e.append(`<option value="${o(n.id)}">${o(n.name)}</option>`),e.val(n.id),gn(),toastr.success('é¢„è®¾å·²å¤åˆ¶')}else toastr.error('é¢„è®¾åç§°å·²å­˜åœ¨')}),s.find('#btn-regex-preset-new').on('click',function(){const e=prompt('è¯·è¾“å…¥é¢„è®¾åç§°:');if(!e)return;const t=ee.createPreset(e,null);if(t){ee.setActivePreset(t.id);const e=s.find('#regex-preset-select');e.append(`<option value="${o(t.id)}">${o(t.name)}</option>`),e.val(t.id),gn(),toastr.success('é¢„è®¾å·²åˆ›å»º')}else toastr.error('é¢„è®¾åç§°å·²å­˜åœ¨')}),s.find('#btn-regex-preset-del').on('click',function(){const e=ee.getActivePreset();if(e&&confirm(`ç¡®å®šè¦åˆ é™¤é¢„è®¾"${e.name}"å—ï¼Ÿ`)){if(ee.deletePreset(e.id)){const t=s.find('#regex-preset-select');t.find(`option[value="${e.id}"]`).remove();const n=ee.getActivePreset()?.id;n&&t.val(n),gn(),toastr.success('é¢„è®¾å·²åˆ é™¤')}else toastr.error('ä¸èƒ½åˆ é™¤æœ€åä¸€ä¸ªé¢„è®¾')}}),s.find('#btn-regex-preset-export').on('click',function(){const e=ee.getActivePreset();if(!e)return;const t=ee.exportPreset(e.id);if(t){const n=new Blob([t],{type:'application/json'}),a=URL.createObjectURL(n),i=document.createElement('a');i.href=a,i.download=`regex-preset-${e.name}-${Date.now()}.json`,i.click(),URL.revokeObjectURL(a),toastr.success('é¢„è®¾å·²å¯¼å‡º')}}),s.find('#btn-regex-preset-import').on('click',function(){const e=document.createElement('input');e.type='file',e.accept='application/json',e.onchange=async e=>{const t=e.target.files?.[0];if(t)try{const e=await t.text(),n=ee.importPreset(e);if(n){const e=s.find('#regex-preset-select');e.append(`<option value="${o(n.id)}">${o(n.name)}</option>`),e.val(n.id),gn(),toastr.success('é¢„è®¾å·²å¯¼å…¥')}else toastr.error('é¢„è®¾æ ¼å¼æ— æ•ˆ')}catch(e){toastr.error('å¯¼å…¥å¤±è´¥: '+e.message)}},e.click()}),s.find('#btn-add-regex-rule').on('click',function(){s.remove(),qe=!1,Cn()}),s.find('#btn-execute-regex-now').on('click',async function(){const e=$(this),t=e.html();try{e.prop('disabled',!0).html('<i class="fa-solid fa-spinner fa-spin"></i> æ‰§è¡Œä¸­...');let t=Je||ln();if(!t)return void toastr.error('æ— æ³•è·å–è¡¨æ ¼æ•°æ®');if('object'!=typeof t||Array.isArray(t))return toastr.error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®'),void console.error('[DICE]æ•°æ®æ ¼å¼é”™è¯¯:',typeof t,Array.isArray(t));const n=Q.getEnabledRules();if(0===n.length)return void toastr.warning('æ²¡æœ‰å¯ç”¨çš„è§„åˆ™');console.info(`[DICE]æ‰‹åŠ¨æ‰§è¡Œ ${n.length} æ¡è§„åˆ™...`);const{totalApplied:a,errors:i}=te.applyToTable(t,n);Je=t,await dn(t,!1,!1),i.length>0?(toastr.warning(`å·²åº”ç”¨ ${a} å¤„è½¬æ¢ï¼Œ${i.length} ä¸ªé”™è¯¯`),console.warn('[DICE]æ­£åˆ™è½¬æ¢é”™è¯¯:',i)):toastr.success(`å·²åº”ç”¨ ${a} å¤„è½¬æ¢`),console.info('[DICE]æ­£åˆ™è½¬æ¢æ‰§è¡Œå®Œæˆ')}catch(e){const t=e instanceof Error?e.message:String(e);console.error('[DICE]æ‰§è¡Œæ­£åˆ™è½¬æ¢å¤±è´¥:',e),toastr.error(`æ‰§è¡Œå¤±è´¥: ${t}`)}finally{e.prop('disabled',!1).html(t)}}),s.find('#btn-add-validation-rule').on('click',function(){fn(s)}),s.find('#btn-open-debug-console').on('click',function(e){e.preventDefault(),e.stopPropagation(),s.remove(),qe=!1,$n()});const f=()=>{qe=!1,s.remove(),Sn()};s.on('click','#dlg-close-x, .acu-settings-header .acu-close-btn',f),s.on('click','#acu-help-btn',function(e){e.stopPropagation(),window.open('https://jerryzmtz.github.io/DiceSystemManual//','_blank')}),s.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&f()})};let En=null,An=!1;const Sn=()=>{qe?An||(console.info('[DICE]è®¾ç½®é¢æ¿æ‰“å¼€ä¸­ï¼Œè·³è¿‡ç•Œé¢æ¸²æŸ“'),An=!0):(En&&clearTimeout(En),En=setTimeout(()=>{En=null,An=!1,In()},50))},In=()=>{console.info('[DICE]å¼€å§‹æ¸²æŸ“ç•Œé¢...');const{$}=ut();if(!We&&$('#chat').length){const e=$('#chat');let t=!1;We=new MutationObserver(()=>{t||(t=!0,requestAnimationFrame(()=>{if('embedded'===an().positionMode)return void(t=!1);const n=e.children().last()[0],a=$('.acu-wrapper')[0];a&&n&&n!==a&&($(n).hasClass('mes')||$(n).hasClass('message-body'))&&e.append(a);const i=ge();if(i&&i.hideDiceResultInChat){const t=e.children().last();(t.hasClass('mes')||t.hasClass('message-body'))&&t.addClass('acu-dice-result-revealing'),requestAnimationFrame(()=>{be(),requestAnimationFrame(()=>{t.removeClass('acu-dice-result-revealing').addClass('acu-dice-result-revealed'),setTimeout(()=>{t.removeClass('acu-dice-result-revealed')},200)})})}t=!1}))}),We.observe(e[0],{childList:!0})}let e,t=!1;if(Ke&&Je)e=Je;else{if(e=ln(),t=!0,e){let t=!1;for(const n in e){if(!n.startsWith('sheet_'))continue;const i=e[n];if(!i||!i.name||!i.content)continue;const o=a.applyLocks(i.name,i.content);o.modified&&(t=!0),o.restored.length}}if(e&&!Ge&&t)try{const t=Q.getEnabledRules();if(t.length>0){console.info(`[DICE]æ£€æµ‹åˆ°æ•°æ®æ›´æ–°ï¼Œåº”ç”¨ ${t.length} æ¡è§„åˆ™...`),Ge=!0;const n=te.applyToTable(e,t);n.totalApplied>0&&(console.info(`[DICE]è‡ªåŠ¨æ›¿æ¢å®Œæˆï¼Œå…±å½±å“ ${n.totalApplied} å¤„æ•°æ®`),un(e).catch(e=>{console.warn('[DICE]è‡ªåŠ¨è½¬æ¢åä¿å­˜æ•°æ®å¤±è´¥:',e)})),n.errors.length>0?console.warn(`[DICE]è‡ªåŠ¨è½¬æ¢é‡åˆ° ${n.errors.length} ä¸ªé”™è¯¯:`,n.errors):0===n.totalApplied&&console.info('[DICE]è‡ªåŠ¨è½¬æ¢æ‰§è¡Œå®Œæˆï¼Œä½†æ²¡æœ‰åŒ¹é…åˆ°éœ€è¦è½¬æ¢çš„æ•°æ®'),Ge=!1}else Ge=!1}catch(e){Ge=!1;e instanceof Error?e.message:String(e);console.error('[DICE]è‡ªåŠ¨è½¬æ¢å¤±è´¥:',e)}if(e){Je='function'==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e));const t=Ct(),n=rt(),a=t&&Object.keys(t).some(e=>e.startsWith('sheet_'));t&&a?t._contextId?t._contextId!==n&&(Je._contextId=n,_t(Je)):_t({...t,_contextId:n}):_t({...Je,_contextId:n})}}const n=$('.acu-search-input');if($('.acu-wrapper').length&&n.is(':focus')&&e){Ve||(He=rn(e));const t=pn(e),n=mt(),a=n&&t[n]?n:null;if(a&&t[a]){const e=Ln(t[a],a),n=$('<div>').html(e);return $('.acu-card-grid').replaceWith(n.find('.acu-card-grid')),$('.acu-panel-title').html(n.find('.acu-panel-title').html()),qn(t),void Fn()}}let i=0,r=0;const c=$('.acu-panel-content');c.length&&(i=c.scrollLeft(),r=c.scrollTop()),$('.acu-wrapper').remove();const s=pn(e||{});He=Ve?new Set:rn(e);const l=yt();let d=Object.keys(s);l&&(d=l.filter(e=>s[e]).concat(d.filter(e=>!l.includes(e))));const u=It();d=d.filter(e=>!u.includes(e));const p=mt();let g=p&&s[p]&&!u.includes(p)?p:null;const f=an(),b=kt(),h='vertical'===f.layout?'acu-layout-vertical':'',v=`acu-mode-${f.positionMode||'fixed'}`;let x=f.gridColumns;if('auto'===x){const e=d.length;if(e<=4)x=e<2?2:e;else{const t=3*Math.ceil(e/3)-e;x=4*Math.ceil(e/4)-e<=t?4:3}}let y='',w=null;if(!1!==f.showOptionPanel){const e=[];if(Object.keys(s).forEach(t=>{t.includes('é€‰é¡¹')&&e.push(s[t])}),e.length>0){const t=kt();let n=`\n                    <div class="acu-opt-header" style="position:relative;">\n                        è¡ŒåŠ¨é€‰é¡¹\n                        <i class="fa-solid ${t?'fa-eye-slash':'fa-eye'} acu-nav-toggle-btn"\n                           style="position:absolute; right:6px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:0.6;"\n                           title="${t?'å±•å¼€é¢æ¿':'æ”¶èµ·é¢æ¿'}"></i>\n                    </div>`,a=!1,i=[];e.forEach(e=>{e.rows&&e.rows.forEach(e=>{e.forEach((e,t)=>{if(t>0&&e&&String(e).trim()){const t=String(e).trim();n+=`<button class="acu-opt-btn" data-val="${encodeURIComponent(t)}">${o(t)}</button>`,i.push(t),a=!0}})})}),a&&(y=`<div class="acu-option-panel">${n}</div>`,w=i.join('|||')+(t?'_collapsed':'_expanded'))}}const k=w!==et;k&&null!==w&&(tt=!0),et=w;let C=`<div class="acu-wrapper ${v} acu-theme-${f.theme} ${h}" style="--acu-card-width:${f.cardWidth}px; --acu-font-size:${f.fontSize}px; --acu-opt-font-size:${f.optionFontSize||12}px; --acu-grid-cols:${x}">`;if('embedded'===f.positionMode&&y&&tt&&(C+=y),b){const e=`acu-col-${f.collapseStyle||'bar'}`,t=`acu-align-${f.collapseAlign||'right'}`;C+=`\n                <div class="acu-expand-trigger ${e} ${t}" id="acu-btn-expand">\n                    <i class="fa-solid fa-table"></i> <span>æ•°æ®åº“åŠ©æ‰‹ (${Object.keys(s).length})</span>\n                </div>\n            `}else{const t=g?Et()[g]:null,n=bt.get(m,!1),a=bt.get('acu_changes_panel_active',!1),i=mt()===ue.MODULE_ID,r=(i?Et()[ue.MODULE_ID]:null)||t;C+=`\n                <div class="acu-data-display ${n||a||i||g?'visible':''} ${r?'acu-manual-mode':''}" id="acu-data-area" style="${r?'height:'+r+'px;':''}">\n                    ${a?zn(e):n?Rn(s):i?'<div class="acu-mvu-panel">'+ue.renderPanel()+'</div>':g?Ln(s[g],g):''}\n                </div>\n                `;const c=`grid-template-columns: repeat(${x}, 1fr);`;C+=`\n                <div class="acu-nav-container ${'top'===f.actionsPosition?'acu-pos-top':''}" id="acu-nav-bar" style="${c}">\n                    <div class="acu-order-controls" id="acu-order-hint"><i class="fa-solid fa-arrows-alt"></i> æ‹–åŠ¨è°ƒæ•´é¡ºåºï¼Œå®Œæˆåç‚¹å‡»ä¿å­˜é€€å‡º</div>\n            `;const l=bt.get('acu_changes_panel_active',!1),u=bt.get(U,!1);let p=0,b=0;if(e){const t=Ct();if(t){for(const n in e){if(!n.startsWith('sheet_'))continue;const a=e[n],i=t[n];if(!a?.content)continue;const o=a.content.slice(1),r=i?.content?.slice(1)||[];o.forEach((e,t)=>{const n=r[t];n?e.forEach((e,t)=>{0!==t&&String(e??'')!==String(n[t]??'')&&p++}):p++}),r.length>o.length&&(p+=r.length-o.length)}for(const n in t)n.startsWith('sheet_')&&!e[n]&&p++}b=ne.getErrorCount(e)}const h=u?b:p,v=u&&b>0,y=It(),w=yt()||[],k=[{key:'__dice__',icon:'fa-dice-d20',label:'æ·éª°',id:'acu-btn-dice-nav',extraClass:'acu-dice-nav-btn'},{key:'__changes__',icon:'fa-code-compare',label:'å®¡æ ¸'+(h>0?'('+h+')':''),id:'acu-btn-changes',extraClass:'acu-changes-btn'+(v?' has-validation-errors':''),isActive:l,warningIcon:v},{key:'__mvu__',icon:'fa-code-branch',label:'å˜é‡',id:'acu-btn-mvu',extraClass:'acu-mvu-btn',isActive:mt()===ue.MODULE_ID}];let E=[];if(k.forEach(e=>{y.includes(e.key)||'__mvu__'!==e.key&&e.checkAvailable&&!e.checkAvailable()||E.push({...e,isSpecial:!0})}),d.forEach(e=>{E.push({key:e,icon:gt(e),label:e,isSpecial:!1,isActive:!n&&!l&&g===e})}),w.length>0){const e=new Map(w.map((e,t)=>[e,t]));E.sort((t,n)=>(e.has(t.key)?e.get(t.key):9999)-(e.has(n.key)?e.get(n.key):9999))}C+=`<button class="acu-nav-btn acu-dashboard-btn ${n?'active':''}" id="acu-btn-dashboard" style="order: 1;">\n                <i class="fa-solid fa-chart-line"></i><span>ä»ªè¡¨ç›˜</span>\n            </button>`,E.forEach((e,t)=>{const n=e.isActive?'active':'',a=e.extraClass||'',i=t+2;if(e.isSpecial){const t=e.warningIcon?'<i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>':'';C+=`<button class="acu-nav-btn ${a} ${n}" id="${e.id}" style="order: ${i};">\n                        <i class="fa-solid ${e.icon}"></i><span>${o(e.label)}</span>${t}\n                    </button>`}else C+=`<button class="acu-nav-btn ${n}" data-table="${o(e.key)}" style="order: ${i};">\n                        <i class="fa-solid ${e.icon}"></i><span>${o(e.label)}</span>\n                    </button>`}),C+='<div class="acu-actions-group" id="acu-active-actions" style="order: 9999;">',Le.forEach(e=>{C+=`<button class="acu-action-btn" id="${e.id}" title="${e.title}"><i class="fa-solid ${e.icon}"></i></button>`}),C+='</div>',C+='</div>'}C+='</div>';const E=$('.acu-wrapper');if(E.length?E.replaceWith(C):Mn(C),'embedded'!==f.positionMode&&y&&tt)if(k)Tn(y);else{0===$('.acu-embedded-options-container').length&&Tn(y)}else f.positionMode,$('.acu-embedded-options-container').remove();if(qn(s),Fn(),pt(),bt.get('acu_changes_panel_active',!1)&&Bn(),mt()===ue.MODULE_ID){const e=$('#acu-data-area');e.length&&(e.html('<div class="acu-mvu-panel">'+ue.renderPanel()+'</div>'),ue.bindEvents(e),ue.getDataWithRetry(5,800).then(t=>{t&&(e.html('<div class="acu-mvu-panel">'+ue.renderPanel()+'</div>'),ue.bindEvents(e))}).catch(t=>{console.error('[DICE]MvuModule Error getting data:',t),e.html('<div class="acu-mvu-panel">'+ue.renderPanel()+'</div>'),ue.bindEvents(e)}))}setTimeout(()=>{const e=$('.acu-panel-content'),t=mt(),n=at[t];e.length&&(n?(e.scrollTop(n.top),e.scrollLeft(n.left)):(r>0&&e.scrollTop(r),i>0&&e.scrollLeft(i)),n&&n.inner&&Object.keys(n.inner).forEach(t=>{const a=n.inner[t],i=e.find(`.acu-editable-title[data-row="${t}"]`);if(i.length){const e=i.closest('.acu-data-card');e.scrollTop(a),e.find('.acu-card-body').scrollTop(a)}}))},0),console.info('[DICE]ç•Œé¢æ¸²æŸ“å®Œæˆ')},Tn=e=>{const{$}=ut();$('.acu-embedded-options-container').remove();const t=(()=>{const e=$('#chat .mes').filter(function(){const e=$(this);return'true'!==e.attr('is_user')&&'true'!==e.attr('is_system')&&!e.hasClass('sys_mes')&&('System'!==e.find('.name_text').text().trim()&&'true'!==e.attr('data-is-system')&&(0!==e.find('.mes_text').length&&'none'!==e.css('display')))});if(0===e.length)return null;const t=e.last(),n=t.find('.mes_block');return n.length?n:t})();if(t&&t.length){const n=an(),a=$(`<div class="acu-embedded-options-container acu-theme-${n.theme}" style="--acu-opt-font-size:${n.optionFontSize||12}px;"></div>`);a.html(e),t.append(a)}},Fn=()=>{const{$}=ut();$('body').off('click.acu_opt').on('click.acu_opt','.acu-opt-btn',async function(e){e.preventDefault(),e.stopPropagation();const t=an(),n=decodeURIComponent($(this).data('val'));if(!t.clickOptionToAutoSend)return r(n,'action'),void $('#send_textarea').focus();if(window.TavernHelper)try{if(window.TavernHelper.createChatMessages)return await window.TavernHelper.createChatMessages([{role:'user',message:n}],{refresh:'affected'}),void(window.TavernHelper.triggerSlash&&await window.TavernHelper.triggerSlash('/trigger'))}catch(e){console.warn('[DICE]ACU TavernHelper å‘é€å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ',e)}const a=window.SillyTavern||window.parent?.SillyTavern;if(a&&a.executeSlashCommandsWithOptions)try{const e=`/send raw=true "${n.replace(/\\/g,'\\\\').replace(/"/g,'\\"')}"`,t=await a.executeSlashCommandsWithOptions(e);if(!t.isError&&!t.isAborted)return void await a.executeSlashCommandsWithOptions('/trigger');console.warn('[DICE]ACU STæ¥å£ send å¤±è´¥:',t)}catch(e){console.warn('[DICE]ACU STæ¥å£å¤±è´¥ï¼Œå°è¯•æŒ‰é’®æ¨¡æ‹Ÿ',e)}const i=$('#send_textarea');if(i.length){i.val(n),i.trigger('input').trigger('change'),await new Promise(e=>setTimeout(e,50));const e=$('#send_but').filter(':visible');if(e.length)e[0].click();else{const e=$.Event('keydown',{keyCode:13,which:13,bubbles:!0});i.trigger(e)}}})},Mn=e=>{const{$}=ut();if('embedded'===an().positionMode){$('.acu-wrapper').remove();const t=(()=>{const e=$('#chat .mes').filter(function(){const e=$(this);if('true'===e.attr('is_user'))return!1;if('true'===e.attr('is_system'))return!1;if(e.hasClass('sys_mes'))return!1;if('System'===e.find('.name_text').text().trim())return!1;if('none'===e.css('display'))return!1;const t=e.find('.mes_text');if(0===t.length)return!1;const n=t.text().trim(),a=t.find('img').length>0;return!(0===n.length&&!a)});if(0===e.length)return $('#chat');let t=e.length-1;const n=e.eq(t),a=n.find('.mes_block');return a.length?a:n})();return void(t.length?t.hasClass('mes_block')||t.hasClass('mes')?0===t.find('.acu-wrapper').length?t.append(e):t.find('.acu-wrapper').replaceWith(e):0===$('#chat').find('.acu-wrapper').length&&t.append(e):$('body').append(e))}const t=$('#chat'),n=$('.acu-wrapper');n.length?n.replaceWith(e):t.length?t.append(e):$('body').append(e)},zn=e=>{const t=Ct(),n=an(),a=Me(),i=e?ne.validateAllData(e):[];if(!(t&&e||0!==i.length))return'\n                <div class="acu-panel-header">\n                    <div class="acu-panel-title">\n                        <div class="acu-title-main"><i class="fa-solid fa-code-compare"></i> <span class="acu-title-text">æ›´æ–°å®¡æ ¸</span></div>\n                        <div class="acu-title-sub">å¯¹æ¯”ä¸Šæ¬¡ä¿å­˜çš„å¿«ç…§</div>\n                    </div>\n                    <div class="acu-header-actions">\n                        <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                </div>\n                <div class="acu-panel-content" style="display:flex;align-items:center;justify-content:center;">\n                    <div class="acu-empty-hint">æš‚æ— å¿«ç…§æ•°æ®</div>\n                </div>';const r=[];for(const n in e){if(!n.startsWith('sheet_'))continue;const a=e[n],i=t[n];if(!a?.name||!a?.content)continue;const o=a.name,c=a.content[0]||[],s=a.content.slice(1),l=i?.content?.slice(1)||[];if(s.forEach((e,t)=>{const a=l[t];if(a){const i=[];if(e.forEach((e,t)=>{if(0===t)return;const n=String(a[t]??''),o=String(e??'');n!==o&&i.push({colIndex:t,header:c[t]||`åˆ—${t}`,oldValue:n,newValue:o})}),1===i.length){const a=i[0];r.push({type:'cell_modified',tableName:o,tableKey:n,rowIndex:t,colIndex:a.colIndex,header:a.header,oldValue:a.oldValue,newValue:a.newValue,rowTitle:e[1]||`è¡Œ ${t+1}`})}else i.length>1&&r.push({type:'row_modified',tableName:o,tableKey:n,rowIndex:t,headers:c,row:e,oldRow:a,changedFields:i,rowTitle:e[1]||`è¡Œ ${t+1}`})}else r.push({type:'row_added',tableName:o,tableKey:n,rowIndex:t,headers:c,row:e,title:e[1]||`è¡Œ ${t+1}`})}),l.length>s.length)for(let e=s.length;e<l.length;e++){const t=l[e];r.push({type:'row_deleted',tableName:o,tableKey:n,rowIndex:e,headers:c,row:t,title:t[1]||`è¡Œ ${e+1}`})}}for(const n in t)if(n.startsWith('sheet_')&&!e[n]){const e=t[n];r.push({type:'table_deleted',tableName:e?.name||n,tableKey:n})}const c=bt.get(U,!1);let s=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n                    <div class="acu-title-main"><i class="fa-solid ${c?'fa-shield-halved':'fa-code-compare'}"></i> <span class="acu-title-text">${c?'æ•°æ®éªŒè¯':'å®Œæ•´å®¡æ ¸'}</span></div>\n                </div>\n                <div class="acu-header-actions">\n                    ${c?'':'<button class="acu-changes-batch-btn acu-batch-accept" title="æ¥å—å…¨éƒ¨å˜æ›´"><i class="fa-solid fa-check-double"></i></button>'}\n                    <button class="acu-changes-batch-btn acu-batch-reject" title="${c?'å…¨éƒ¨å›æ»š':'æ‹’ç»å…¨éƒ¨å˜æ›´'}"><i class="fa-solid fa-rotate-left"></i></button>\n                    <button class="acu-changes-batch-btn acu-simple-mode-toggle ${c?'active':''}" title="${c?'åˆ‡æ¢åˆ°å®Œæ•´å®¡æ ¸æ¨¡å¼':'åˆ‡æ¢åˆ°æ•°æ®éªŒè¯æ¨¡å¼'}">\n                        <i class="fa-solid ${c?'fa-filter-circle-xmark':'fa-filter'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="å®¡æ ¸é¢æ¿" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                    </div>\n                    <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>`;if(c&&(s+='<div class="acu-validation-mode-hint">\n        <i class="fa-solid fa-info-circle"></i>å³ä½¿å›æ»šï¼Œä¸åˆæ³•çš„æ•°æ®ä»ä¼šæ˜¾ç¤ºè­¦å‘Š\n      </div>'),s+=`<div class="acu-panel-content acu-changes-content ${'horizontal'===n.layout?'acu-changes-horizontal':''}">`,c)if(0===i.length)s+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                æ•°æ®éªŒè¯é€šè¿‡ï¼Œæ— è¿è§„é¡¹\n            </div>';else{const e=ne.groupErrorsByTable(i),t=bt.get('acu_validation_collapsed_groups',[]);s+='<div class="acu-changes-list">';for(const n in e){const i=e[n],r=t.includes(n);s+=`<div class="acu-changes-group ${r?'collapsed':''}">\n                    <div class="acu-changes-group-header acu-validation-group-header" data-table="${o(n)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${r?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${gt(n)}"></i> ${o(n)}\n                        <span class="acu-changes-count" style="background:${a.errorText};">${i.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${r?'display:none;':''}">`,i.forEach(e=>{const t=e.rule?o(JSON.stringify({ruleId:e.ruleId,ruleType:e.ruleType,tableName:e.tableName,rowIndex:e.rowIndex,columnName:e.columnName||'',currentValue:e.currentValue||'',rowTitle:e.rowTitle||'',rule:e.rule})):'';s+=`<div class="acu-change-item acu-validation-error-item"\n                         data-table="${o(e.tableName)}"\n                         data-row="${e.rowIndex}"\n                         data-column="${o(e.columnName||'')}"\n                         data-rule-id="${o(e.ruleId||'')}"\n                         data-rule-type="${o(e.ruleType||'')}"\n                         data-rule-data="${t}">\n                        <span class="acu-change-badge" style="background:var(--acu-hl-manual-bg);color:var(--acu-hl-manual);">!</span>\n                        ${e.rowTitle&&e.rowIndex>=0?`<div class="acu-validation-row-title" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:2px;">${o(e.rowTitle)}</div>`:''}\n                        <span class="acu-change-title">${o(e.columnName||'æ•´è¡Œ')}${e.currentValue?`: ${o(e.currentValue.length>15?e.currentValue.substring(0,15)+'...':e.currentValue)}`:''}</span>\n                        <span class="acu-validation-error-msg">${o(e.errorMessage.length>25?e.errorMessage.substring(0,25)+'...':e.errorMessage)}</span>\n                        <div class="acu-change-actions">\n                            <button class="acu-change-action-btn acu-action-reject" title="å›æ»š"><i class="fa-solid fa-rotate-left"></i></button>\n                            <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                        </div>\n                    </div>`}),s+='</div></div>'}s+='</div>'}else if(0===r.length)s+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                å½“å‰æ•°æ®ä¸å¿«ç…§ä¸€è‡´ï¼Œæ— å˜æ›´\n            </div>';else{const e={};r.forEach(t=>{const n=t.tableName;e[n]||(e[n]=[]),e[n].push(t)}),s+='<div class="acu-changes-list">';const t=bt.get('acu_changes_collapsed_groups',[]);for(const n in e){const a=e[n],i=t.includes(n);s+=`<div class="acu-changes-group ${i?'collapsed':''}">\n                    <div class="acu-changes-group-header" data-table="${o(n)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${i?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${gt(n)}"></i> ${o(n)}\n                        <span class="acu-changes-count">${a.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${i?'display:none;':''}">`,a.forEach(e=>{if('row_added'===e.type)s+=`<div class="acu-change-item acu-change-added"\n                            data-change-type="row_added"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}">\n                            <span class="acu-change-badge acu-badge-added">æ–°</span>\n                            <span class="acu-change-title">${o(e.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="æ‹’ç»"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`;else if('row_deleted'===e.type)s+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="row_deleted"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}">\n                            <span class="acu-change-badge acu-badge-deleted">åˆ </span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">${o(e.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—åˆ é™¤"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="æ¢å¤æ­¤è¡Œ"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`;else if('cell_modified'===e.type){const t=e.oldValue.length>15?e.oldValue.substring(0,15)+'...':e.oldValue,n=e.newValue.length>15?e.newValue.substring(0,15)+'...':e.newValue;let a;a=e.tableName&&e.tableName.includes('é€‰é¡¹')?`${o(e.tableName)}.${o(e.header)}`:`${o(e.rowTitle)}.${o(e.header)}`,s+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="cell_modified"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}"\n                            data-col-index="${e.colIndex}"\n                            data-old-value="${encodeURIComponent(e.oldValue)}">\n                            <span class="acu-change-badge acu-badge-modified">æ›´</span>\n                            <span class="acu-change-field">${a}</span>\n                            <span class="acu-change-diff">\n                                <span class="acu-diff-old">${o(t||'(ç©º)')}</span>\n                                <span class="acu-diff-arrow">â†’</span>\n                                <span class="acu-diff-new">${o(n||'(ç©º)')}</span>\n                            </span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="æ‹’ç»"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else if('row_modified'===e.type){const t=e.changedFields.length,n=e.changedFields.slice(0,2).map(e=>e.header).join('ã€'),a=t>2?` ç­‰${t}é¡¹`:'';s+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="row_modified"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}">\n                            <span class="acu-change-badge acu-badge-modified">æ›´</span>\n                            <span class="acu-change-title">${o(e.rowTitle)}</span>\n                            <span class="acu-change-field-count">${o(n)}${a}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="æ‹’ç»"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="ç¼–è¾‘"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else'table_deleted'===e.type&&(s+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="table_deleted"\n                            data-table-key="${e.tableKey}">\n                            <span class="acu-change-badge acu-badge-deleted">åˆ </span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">æ•´è¡¨å·²åˆ é™¤</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="æ¥å—"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="æ¢å¤æ•´è¡¨"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`)}),s+='</div></div>'}s+='</div>'}return s+='</div>',s},Bn=()=>{const{$}=ut();$('.acu-changes-content').closest('.acu-data-display').find('.acu-close-btn').off('click').on('click',function(){bt.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')});$('.acu-validation-error-item .acu-action-reject').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-validation-error-item'),n=t.data('table'),a=parseInt(t.data('row'),10),i=t.data('column'),o=Ct();if(o)try{const e=Je||ln();for(const t in e)if(e[t]?.name===n&&o[t]){const n=(e[t].content?.[0]||[]).indexOf(i);if(n>=0&&o[t].content?.[a+1]){const i=o[t].content[a+1][n];return e[t].content[a+1][n]=i,await dn(e,!1,!1),void Sn()}break}window.toastr&&window.toastr.warning('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„å¿«ç…§æ•°æ®')}catch(e){console.error('[DICE]ACU æ¢å¤å¿«ç…§å€¼å¤±è´¥:',e),window.toastr&&window.toastr.error('æ¢å¤å¤±è´¥')}else window.toastr&&window.toastr.warning('æ— å¿«ç…§æ•°æ®å¯æ¢å¤')}),$('.acu-validation-error-item .acu-action-edit').off('click').on('click',function(e){e.stopPropagation();const t=$(this).closest('.acu-validation-error-item'),n=t.data('rule-data');if(n)try{const e='string'==typeof n?JSON.parse(n):n,a={ruleId:e.ruleId,ruleType:e.ruleType,rule:e.rule,tableName:t.data('table')||e.tableName||'',rowIndex:parseInt(t.data('row'),10)||e.rowIndex||0,columnName:t.data('column')||e.columnName||'',currentValue:e.currentValue||'',rowTitle:e.rowTitle||'',ruleName:e.ruleName||e.rule?.name||'',errorMessage:e.errorMessage||e.rule?.errorMessage||''};bn(a)}catch(e){console.error('[DICE]ACU è§£æè§„åˆ™æ•°æ®å¤±è´¥:',e),window.toastr&&window.toastr.error('è§£æè§„åˆ™æ•°æ®å¤±è´¥')}else window.toastr&&window.toastr.warning('æ— æ³•è·å–è§„åˆ™ä¿¡æ¯')});let e=null;$('.acu-validation-error-item').off('click touchstart touchend touchmove').on('touchstart',function(t){const n=t.originalEvent.touches[0];e={x:n.clientX,y:n.clientY}}).on('touchmove',function(t){if(!e)return;const n=t.originalEvent.touches[0],a=Math.abs(n.clientX-e.x),i=Math.abs(n.clientY-e.y);(a>10||i>10)&&(e=null)}).on('touchend',function(t){if(!e)return;if(e=null,$(t.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if(bt.get(U,!1))return;const n=$(this).data('table'),a=$(this).data('row');bt.set('acu_changes_panel_active',!1),ht(n),Sn(),setTimeout(()=>{const e=$(`.acu-data-card[data-row-index="${a}"]`);e.length&&(e[0].scrollIntoView({behavior:'smooth',block:'center'}),e.addClass('acu-highlight-flash'),setTimeout(()=>e.removeClass('acu-highlight-flash'),2e3))},300)}).on('click',function(e){if($(e.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if('ontouchstart'in window)return;if(bt.get(U,!1))return;const t=$(this).data('table'),n=$(this).data('row');bt.set('acu_changes_panel_active',!1),ht(t),Sn(),setTimeout(()=>{const e=$(`.acu-data-card[data-row-index="${n}"]`);e.length&&(e[0].scrollIntoView({behavior:'smooth',block:'center'}),e.addClass('acu-highlight-flash'),setTimeout(()=>e.removeClass('acu-highlight-flash'),2e3))},300)}),$('.acu-changes-group-header').off('click').on('click',function(e){if($(e.target).closest('.acu-change-item').length)return;const t=$(this).data('table'),n=$(this).closest('.acu-changes-group'),a=n.find('.acu-changes-group-body'),i=$(this).find('.acu-collapse-icon'),o=$(this).hasClass('acu-validation-group-header')?'acu_validation_collapsed_groups':'acu_changes_collapsed_groups';let r=bt.get(o,[]);n.hasClass('collapsed')?(n.removeClass('collapsed'),a.slideDown(200),i.removeClass('fa-chevron-right').addClass('fa-chevron-down'),r=r.filter(e=>e!==t)):(n.addClass('collapsed'),a.slideUp(200),i.removeClass('fa-chevron-down').addClass('fa-chevron-right'),r.includes(t)||r.push(t)),bt.set(o,r)}),$('.acu-change-item .acu-action-accept').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),n=t.data('change-type'),a=t.data('table-key'),i=t.data('row-index'),o=t.data('col-index'),r=Ct(),c=Je||ln();r&&c&&('cell_modified'===n?r[a]?.content?.[i+1]&&c[a]?.content?.[i+1]&&(r[a].content[i+1][o]=c[a].content[i+1][o]):'row_modified'===n?r[a]?.content&&c[a]?.content?.[i+1]&&(r[a].content[i+1]=[...c[a].content[i+1]]):'row_added'===n?c[a]?.content?.[i+1]&&(r[a]?r[a].content[i+1]=[...c[a].content[i+1]]:r[a]=JSON.parse(JSON.stringify(c[a]))):'row_deleted'===n?r[a]?.content?.[i+1]&&r[a].content.splice(i+1,1):'table_deleted'===n&&delete r[a],_t(r),t.fadeOut(200,function(){$(this).remove(),Dn()}))}),$('.acu-change-item .acu-action-reject').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),n=t.data('change-type'),a=t.data('table-key'),i=t.data('row-index'),o=t.data('col-index'),r=decodeURIComponent(t.data('old-value')||''),c=Ct();let s=Je||ln();c&&s&&('cell_modified'===n?s[a]?.content?.[i+1]&&(s[a].content[i+1][o]=r):'row_modified'===n?c[a]?.content?.[i+1]&&s[a]?.content&&(s[a].content[i+1]=[...c[a].content[i+1]]):'row_added'===n&&s[a]?.content?.[i+1]&&s[a].content.splice(i+1,1),await un(s),t.fadeOut(200,function(){$(this).remove(),Dn()}))}),$('.acu-action-restore').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),n=t.data('change-type'),a=t.data('table-key'),i=t.data('row-index'),o=Ct();let r=Je||ln();if(o&&r){if('row_deleted'===n){if(o[a]?.content?.[i+1]){const e=[...o[a].content[i+1]];r[a]||(r[a]=JSON.parse(JSON.stringify(o[a])),r[a].content=[o[a].content[0]]),r[a].content.splice(i+1,0,e)}}else'table_deleted'===n&&o[a]&&(r[a]=JSON.parse(JSON.stringify(o[a])));await un(r),t.fadeOut(200,function(){$(this).remove(),Dn()})}}),$('.acu-change-item:not(.acu-validation-error-item) .acu-action-edit').off('click').on('click',function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),n=t.data('table-key'),a=t.data('row-index'),i=t.data('change-type');if(!n||void 0===a)return;const o=Je||ln();if(!o||!o[n])return;const r=o[n],c=r.content?r.content[0]:[],s=r.content?r.content[a+1]:null;if(s)if('row_modified'===i)On(s,c,r.name||'ç¼–è¾‘',a,n);else if('cell_modified'===i){const e=t.data('col-index'),i=c[e]||`åˆ—${e}`,o=s[e]||'';jn(o,i,r.name,a,e,n)}else Nn(s,c,r.name||'ç¼–è¾‘',a,n);else window.toastr&&window.toastr.warning('è¯¥è¡Œå¯èƒ½å·²è¢«åˆ é™¤')}),$('.acu-batch-accept').off('click').on('click',async function(){const e=Je||ln();e&&(_t(JSON.parse(JSON.stringify(e))),He=new Set,Dn())}),$('.acu-batch-reject').off('click').on('click',async function(){const e=Ct();if(!e)return void(window.toastr&&window.toastr.warning('æ— å¿«ç…§æ•°æ®'));const t=JSON.parse(JSON.stringify(e));Je=t,await dn(t,!1,!1)}),$('.acu-simple-mode-toggle').off('click').on('click',function(){const e=!bt.get(U,!1);bt.set(U,e);const t=Je||ln();$('#acu-data-area').html(zn(t)),Bn(),Pn(t)}),$('.acu-changes-content').closest('.acu-data-display').find('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(e){if(0!==e.button)return;e.preventDefault(),e.stopPropagation();const t=this;t.setPointerCapture(e.pointerId),$(t).addClass('active');const n=$('#acu-data-area'),a=n.height(),i=e.clientY,o=$(t).data('table');t.onpointermove=function(e){const t=e.clientY-i;let o=a-t;o<w&&(o=w),o>k&&(o=k),n.css('height',o+'px')},t.onpointerup=function(e){$(t).removeClass('active'),t.releasePointerCapture(e.pointerId),t.onpointermove=null,t.onpointerup=null;const a=n.height(),i=Et();i[o]=a,At(i)}}).off('dblclick').on('dblclick',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table');$('#acu-data-area').css('height','');const n=Et();delete n[t],At(n)});const t=$('.acu-changes-content.acu-changes-horizontal');t.length&&(t[0].addEventListener('touchstart',function(e){this._touchStartX=e.touches[0].clientX,this._touchStartY=e.touches[0].clientY,this._scrollDirection=null},{passive:!0}),t[0].addEventListener('touchmove',function(e){if(!this._touchStartX)return;const t=Math.abs(e.touches[0].clientX-this._touchStartX),n=Math.abs(e.touches[0].clientY-this._touchStartY);!this._scrollDirection&&(t>5||n>5)&&(this._scrollDirection=t>n?'horizontal':'vertical'),'horizontal'===this._scrollDirection&&t>10&&e.stopPropagation()},{passive:!1}),t[0].addEventListener('touchend',function(){this._touchStartX=null,this._touchStartY=null,this._scrollDirection=null},{passive:!0}))},Dn=()=>{const{$}=ut(),e=Je||ln();He=rn(e);const t=$('#acu-data-area');t.length&&bt.get('acu_changes_panel_active',!1)&&(t.html(zn(e)),Bn(),Pn(e))},Pn=e=>{const{$}=ut(),t=Ct();let n=0;if(t&&e){for(const a in e){if(!a.startsWith('sheet_'))continue;const i=e[a],o=t[a];if(!i?.content)continue;const r=i.content.slice(1),c=o?.content?.slice(1)||[];r.forEach((e,t)=>{const a=c[t];a?e.forEach((e,t)=>{0!==t&&String(e??'')!==String(a[t]??'')&&n++}):n++}),c.length>r.length&&(n+=c.length-r.length)}for(const a in t)a.startsWith('sheet_')&&!e[a]&&n++}const a=e?ne.getErrorCount(e):0,i=bt.get(U,!1),o=i?a:n,r=i&&a>0,c=$('#acu-btn-changes'),s=c.find('span');s.html(o>0?`å®¡æ ¸(${o})`:'å®¡æ ¸'),r?(c.find('.acu-nav-warning-icon').length||s.append(' <i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>'),c.addClass('has-validation-errors')):(c.find('.acu-nav-warning-icon').remove(),c.removeClass('has-validation-errors'))},Nn=(e,t,n,a,i)=>{const{$}=ut(),r=an(),c=e.map((e,n)=>{if(0===n)return'';const a=t[n]||`åˆ— ${n}`,i=e||'';return`\n                <div class="acu-card-edit-field" style="margin-bottom: 10px;">\n                    <label style="display:block;font-size:12px;color:var(--acu-accent);font-weight:bold;margin-bottom:4px;">${o(a)}</label>\n                    <textarea class="acu-card-edit-input acu-edit-textarea" data-col="${n}" spellcheck="false" rows="1"\n                                                        style="width:100%;min-height:40px;max-height:500px;padding:10px;resize:none;overflow-y:hidden;">${o(i)}</textarea>                            </div>`}).join(''),s=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${r.theme}">\n                    <div class="acu-edit-title">ç¼–è¾‘å˜æ›´ (#${a+1} - ${o(n)})</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${c}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-change-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-change-save"><i class="fa-solid fa-check"></i> ä¿å­˜å¹¶ç¡®è®¤</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(s);const l=e=>{e.style.height='auto';const t=e.scrollHeight+2;e.style.height=Math.min(t,500)+'px',e.style.overflowY=t>500?'auto':'hidden'};requestAnimationFrame(()=>{s.find('textarea').each(function(){l(this)})}),s.find('textarea').on('input',function(){l(this)}),s.find('textarea').on('input',function(){l(this)});const d=()=>{qe=!1,s.remove()};s.find('#dlg-change-cancel').click(d),s.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&d()}),s.find('#dlg-change-save').click(async()=>{let e=Je||ln();if(e&&e[i]){const t=e[i]?.content?.[a+1];if(!t)return void d();let n=!1;if(s.find('textarea').each(function(){const e=parseInt($(this).data('col')),a=$(this).val();String(t[e])!==String(a)&&(n=!0,t[e]=a)}),n){try{const t=ut().getDB();if(!t||!t.importTableAsJson)throw new Error('æ•°æ®åº“ API ä¸å¯ç”¨');const n={mate:e.mate||{type:'chatSheets',version:1}};let a;Object.keys(e).forEach(t=>{t.startsWith('sheet_')&&(n[t]=e[t])});try{a=JSON.stringify(n);const e=new Blob([a]).size/1048576;if(e>10)throw new Error(`æ•°æ®å¤ªå¤§ (${e.toFixed(2)}MB)ï¼Œè¶…è¿‡ 10MB é™åˆ¶`)}catch(e){throw console.error('[DICE]ACU JSON åºåˆ—åŒ–å¤±è´¥:',e),new Error(`æ•°æ®åºåˆ—åŒ–å¤±è´¥: ${e.message||e}`)}if(!1===await t.importTableAsJson(a))throw new Error('æ•°æ®å¯¼å…¥å¤±è´¥ï¼ˆè¿”å› falseï¼‰');Je=e}catch(e){console.error('[DICE]ACU ä¿å­˜å¤±è´¥:',e);let t=e.message||'ä¿å­˜å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼å’Œå¤§å°';const n=String(e);return(n.includes('Settings could not be saved')||n.includes('server connection')||n.includes('data loss'))&&(t='ä¿å­˜å¤±è´¥ï¼šæœåŠ¡å™¨è¿æ¥é—®é¢˜æˆ–æ•°æ®è¿‡å¤§ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å‡å°‘æ•°æ®é‡'),void(window.toastr?window.toastr.error(t,'ä¿å­˜å¤±è´¥',{timeOut:7e3}):alert(`ä¿å­˜å¤±è´¥: ${t}`))}const n=Ct();n&&n[i]&&n[i].content&&(n[i].content[a+1]=[...t],_t(n)),He=rn(e);$('#acu-data-area').html(zn(e)),Bn()}}d()})},jn=(e,t,n,a,i,r)=>{const{$}=ut(),c=an(),s=Ct(),l=s?.[r]?.content?.[a+1]?.[i]??'',d=''!==l&&String(l)!==String(e),u=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${c.theme}" style="max-width:450px;">\n                    <div class="acu-edit-title">ç¼–è¾‘: ${o(n)} - ${o(t)}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${d?`\n                        <div class="acu-diff-section acu-diff-old-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-clock-rotate-left"></i> åŸå§‹å€¼ï¼ˆå¿«ç…§ï¼‰\n                            </div>\n                            <div class="acu-diff-readonly">${o(l)}</div>\n                        </div>\n                        <div class="acu-diff-arrow-down">\n                            <i class="fa-solid fa-arrow-down"></i>\n                        </div>\n                        `:''}\n                        <div class="acu-diff-section acu-diff-new-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-pen"></i> ${d?'å½“å‰å€¼ï¼ˆå¯ç¼–è¾‘ï¼‰':'å†…å®¹'}\n                            </div>\n                            <textarea class="acu-change-single-input acu-edit-textarea" spellcheck="false"\n                                style="width:100%;min-height:60px;max-height:300px;padding:12px;resize:none;">${o(e)}</textarea>\n                        </div>\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-single-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        ${d?'<button class="acu-dialog-btn acu-btn-revert" id="dlg-single-revert"><i class="fa-solid fa-rotate-left"></i> æ¢å¤åŸå€¼</button>':''}\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-single-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(u);const p=u.find('.acu-change-single-input'),g=()=>{p[0].style.height='auto';const e=Math.max(60,Math.min(p[0].scrollHeight+2,300));p[0].style.height=e+'px'};setTimeout(g,0),p.on('input',g),p.focus();const f=()=>u.remove();u.find('#dlg-single-cancel').click(f),u.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&f()}),u.find('#dlg-single-revert').click(function(){p.val(l).trigger('input')}),u.find('#dlg-single-save').click(async()=>{const e=p.val();let t=Je||ln();if(t&&t[r]&&t[r].content){const n=t[r].content[a+1];if(n&&String(n[i])!==String(e)){n[i]=e,await un(t);const o=Ct();o&&o[r]&&o[r].content&&o[r].content[a+1]&&(o[r].content[a+1][i]=e,_t(o)),He=rn(t),Dn()}}f()})},On=(e,t,n,a,i)=>{const{$}=ut(),r=an(),c=Ct(),s=c?.[i]?.content?.[a+1]||[];let l='';for(let n=1;n<t.length;n++){const a=t[n]||`åˆ— ${n}`,i=s[n]??'',r=e[n]??'',c=String(i)!==String(r);l+=`\n                <div class="acu-row-edit-field ${c?'acu-field-changed':''}">\n                    <div class="acu-row-edit-label">${o(a)} ${c?'<span class="acu-changed-badge">å·²æ”¹</span>':''}</div>\n                    ${c?`<div class="acu-row-edit-old">${o(i)||'<span class="acu-empty-val">(ç©º)</span>'}</div>`:''}\n                    <textarea class="acu-row-edit-input acu-edit-textarea" data-col="${n}" spellcheck="false" rows="1">${o(r)}</textarea>\n                </div>\n            `}const d=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${r.theme}" style="max-width:550px;">\n                    <div class="acu-edit-title">æ•´ä½“ç¼–è¾‘: ${o(n)} - ${o(e[1]||'è¡Œ '+(a+1))}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px; max-height:60vh;">\n                        ${l}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-row-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn" id="dlg-row-revert"><i class="fa-solid fa-rotate-left"></i> å…¨éƒ¨æ¢å¤</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-row-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(d);const u=e=>{e.style.height='auto',e.style.height=Math.min(e.scrollHeight+2,200)+'px'};d.find('textarea').each(function(){u(this)}),d.find('textarea').on('input',function(){u(this)});const p=()=>d.remove();d.find('#dlg-row-cancel').click(p),d.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&p()}),d.find('#dlg-row-revert').click(function(){d.find('textarea').each(function(){const e=parseInt($(this).data('col'));$(this).val(s[e]??'').trigger('input')})}),d.find('#dlg-row-save').click(async()=>{let e=Je||ln();if(!e?.[i]?.content?.[a+1])return void p();const t=e[i].content[a+1];let n=!1;if(d.find('textarea').each(function(){const e=parseInt($(this).data('col')),a=$(this).val();String(t[e])!==String(a)&&(n=!0,t[e]=a)}),n){await un(e);const n=Ct();n?.[i]?.content&&(n[i].content[a+1]=[...t],_t(n)),He=rn(e),Dn()}p()})},Rn=e=>{console.info('[DICE]å¼€å§‹æŠ“å–ä»ªè¡¨ç›˜æ•°æ®...');const t=an(),n=Ie.findTable(e,'global'),a=Ie.findTable(e,'player'),i=Ie.findTable(e,'location'),r=Ie.findTable(e,'npc'),c=Ie.findTable(e,'quest'),s=Ie.findTable(e,'bag'),l=Ie.findTable(e,'skill'),d=Ie.findTable(e,'equip');let u={name:'ä¸»è§’',status:'æ­£å¸¸',position:'',attrs:'',money:'0'};const p=Ie.parseRows(a,'player');if(p.length>0){const e=p[0];if(u.name=e.name||'ä¸»è§’',u.status=e.status||'æ­£å¸¸',u.position=e.position||'',u.money=e.money||'',u.resources='',a?.data?.headers&&a?.data?.rows?.[0]){const e=a.data.headers,t=a.data.rows[0];let n='';e.forEach((e,a)=>{if(e&&e.includes('å±æ€§')){const e=t[a];e&&(n+=(n?'; ':'')+e)}}),u.attrs=n,e.forEach((e,n)=>{if(e&&(e.includes('èµ„æº')||e.includes('é‡‘é’±'))){const e=t[n];e&&(u.resources=e)}})}}const g=a?.data?.rows||[],f=a?.data?.headers||[];let b='',m='';if(n?.data?.rows?.length>0){const e=n.data.headers||[],t=n.data.rows[0],a=Ie.findColumnIndex(e,'detailLocation',n.config);a>=0&&t[a]&&(b=t[a]);const i=Ie.findColumnIndex(e,'currentLocation',n.config);m=i>=0&&t[i]?t[i]:t[2]||''}let h=b||m||(u.position.includes('-')?u.position.split('-')[0].trim():u.position);const v=r?.name||'é‡è¦äººç‰©è¡¨',x=r?.key||'',y=Ie.parseRows(r,'npc');let w=[],k=[];y.forEach(e=>{const t=String(e.inScene||'').toLowerCase(),n={name:e.name||'æœªçŸ¥',status:e.status||'',position:e.position||'',index:e._rowIndex};'true'===t||'åœ¨åœº'===t?w.push(n):k.push(n)});let C=[...w,...k];const E=c?.name||'å¤‡å¿˜äº‹é¡¹',A=Ie.parseRows(c,'quest'),S=Ie.applyFilter(A,'active','quest'),I=e=>{const t=String(e||'').toLowerCase();return t.includes('ä¸»çº¿')?0:t.includes('æ”¯çº¿')?1:t.includes('æ—¥å¸¸')?2:3};let T=S.map(e=>({name:e.name||'ä»»åŠ¡',type:e.type||'',progress:e.progress||'',_rowIndex:e._rowIndex})).sort((e,t)=>I(e.type)-I(t.type)).slice(0,5);const F=s?.name||'èƒŒåŒ…ç‰©å“è¡¨',M=Ie.parseRows(s,'bag');let B=M.slice(0,6).map(e=>({name:e.name||'æœªçŸ¥ç‰©å“',count:e.count||'1',type:e.type||''}));const D=l?.name||'ä¸»è§’æŠ€èƒ½è¡¨',P=Ie.parseRows(l,'skill');let N=P.slice(0,6).map(e=>({name:e.name||'æœªçŸ¥æŠ€èƒ½',level:e.level||'',type:e.type||''}));const j=d?.name||'è£…å¤‡è¡¨',O=Ie.parseRows(d,'equip');let R=Ie.applyFilter(O,'equipped','equip').slice(0,4).map(e=>({name:e.name||'æœªçŸ¥è£…å¤‡',type:e.type||'',part:e.part||''}));const L=i?.name||'ä¸–ç•Œåœ°å›¾ç‚¹',U=i?.key||'',V=Ie.parseRows(i,'location');let Y=`\n        <div class="acu-panel-header">\n            <div class="acu-panel-title">\n                <div class="acu-title-main"><i class="fa-solid fa-chart-line"></i> <span class="acu-title-text">ä»ªè¡¨ç›˜</span></div>\n                <div class="acu-title-sub">ç»¼åˆçŠ¶æ€æ€»è§ˆ</div>\n            </div>\n            <div class="acu-header-actions">\n                <div class="acu-height-control">\n                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="ä»ªè¡¨ç›˜" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                </div>\n                <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n            </div>\n        </div>\n        <div class="acu-panel-content acu-dashboard-content">\n            <div class="acu-dash-body ${'horizontal'===t.layout?'acu-dash-horizontal':''}">\n            \x3c!-- å·¦åˆ—ï¼šä¸»è§’çŠ¶æ€ + æŠ€èƒ½ --\x3e\n                <div class="acu-dash-player">\n                    <h3 class="acu-dash-clickable acu-dash-preview-trigger"\n                        data-table-key="${a?.key||''}"\n                        data-row-index="0"\n                        data-preview-type="player"\n                        style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-user-circle"></i> ${o(ce(u.name))}</span>\n                        <span style="font-size:11px;font-weight:normal;color:var(--acu-text-main);background:var(--acu-badge-bg);padding:2px 8px;border-radius:10px;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${o(u.status)}">${o(u.status.length>6?u.status.substring(0,6)+'..':u.status)}</span>\n                    </h3>\n                    <div class="acu-player-status" style="margin-bottom:8px;">\n                        ${(()=>{const e=u.resources||u.money||'',t=Ne(e);return t.length>0?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:52px;overflow-y:auto;margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--acu-border);">\n                                    ${t.slice(0,4).map(e=>`\n                                        <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;">\n                                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${o(e.name)}">${o(e.name.substring(0,3))}</span>\n                                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                                <span style="color:var(--acu-accent);font-size:11px;font-weight:bold;">${e.value}</span>\n                                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${e.value}" data-name="${o(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä»¥${e.name}(${e.value})è¿›è¡Œæ£€å®š"></i>\n                                            </div>\n                                        </div>\n                                    `).join('')}\n                                </div>`:''})()}\n        ${(()=>{let e=[];if(g.length>0&&f.length>0){const t=g[0];f.forEach((n,a)=>{if(n&&n.includes('å±æ€§')){Ne(t[a]||'').forEach(t=>{e.some(e=>e.name===t.name)||e.push(t)})}})}return e.length>0?`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px 6px;max-height:78px;overflow-y:auto;overflow-x:hidden;">\n                    ${e.map(e=>`\n                        <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;border-bottom:1px dashed var(--acu-border);min-width:0;">\n                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${o(e.name)}">${o(e.name.substring(0,2))}</span>\n                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                <span style="color:var(--acu-text-main);font-size:11px;font-weight:bold;">${e.value}</span>\n                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${e.value}" data-name="${o(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä»¥${e.name}(${e.value})è¿›è¡Œæ£€å®š"></i>\n                            </div>\n                        </div>\n                    `).join('')}\n                </div>`:''})()}\n                    </div>\n\n                    <h4 class="acu-dash-table-link" data-table="${o(D)}" style="font-size:12px;color:var(--acu-accent);margin:10px 0 6px 0;"><i class="fa-solid fa-bolt"></i> æŠ€èƒ½ (${P.length})</h4>\n                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:2px 6px;max-height:78px;overflow-y:auto;overflow-x:hidden;">\n                    ${N.length>0?N.map((e,t)=>{const n=Pe(e.level),a=n>0,i=P.findIndex(t=>t.name===e.name);return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${l?.key||''}"\n                            data-row-index="${i>=0?i:t}"\n                            data-preview-type="skill"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;border-bottom:1px dashed var(--acu-border);min-width:0;cursor:pointer;">\n                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${o(e.name)}">${o(e.name.length>5?e.name.substring(0,5)+'..':e.name)}</span>\n                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                ${a?`<span style="color:var(--acu-text-main);font-size:11px;font-weight:bold;">${n}</span>\n                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${n}" data-name="${o(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä»¥${e.name}(${n})è¿›è¡Œæ£€å®š"></i>`:`<span style="color:var(--acu-text-sub);font-size:10px;">${o(e.level||'-')}</span>`}\n                            </div>\n                        </div>`}).join(''):'<div style="grid-column:1/-1;text-align:center;color:var(--acu-text-sub);padding:8px;font-size:11px;">æš‚æ— æŠ€èƒ½</div>'}\n                    </div>\n                </div>\n\n                \x3c!-- ä¸­åˆ—ï¼šåœ°ç‚¹ + NPC --\x3e\n                <div class="acu-dash-locations">\n                    <h3 class="acu-dash-table-link" data-table="${o(L)}" style="display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-map"></i> åœ°ç‚¹ (${V.length})</span>\n                        <i class="fa-solid fa-map acu-dash-map-btn" title="åœ°å›¾å¯è§†åŒ–" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                    </h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:100px;overflow-y:auto;overflow-x:hidden;margin-bottom:10px;">\n                    ${V.length>0?V.map((e,t)=>{const n=e.name||'æœªçŸ¥',a=h&&(n.includes(h)||h.includes(n));return`<div class="acu-location-item acu-dash-clickable acu-dash-preview-trigger ${a?'acu-current-location':''}"\n                            data-table-key="${o(U)}"\n                            data-row-index="${e._rowIndex}"\n                            data-preview-type="location">\n                            <span>\n                                ${a?'<i class="fa-solid fa-location-dot"></i>':'<i class="fa-solid fa-map-pin" style="font-size:9px;opacity:0.4;"></i>'}\n                                <span title="${o(n)}">${o(n)}</span>\n                            </span>\n                            ${a?'<i class="fa-solid fa-street-view" style="flex-shrink:0;" title="æ‚¨åœ¨è¿™é‡Œ"></i>':`<i class="fa-solid fa-walking acu-dash-goto-btn" data-location="${o(n)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;flex-shrink:0;" title="å‰å¾€${n}"></i>`}\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— åœ°ç‚¹æ•°æ®</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${o(v)}" style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-users"></i> è§’è‰² (${C.length})</span>\n                        <span style="display:flex;gap:8px;">\n                            <i class="fa-solid fa-project-diagram acu-dash-relation-graph-btn" title="äººç‰©å…³ç³»å›¾" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                            <i class="fa-solid fa-user-circle acu-dash-avatar-manager-btn" title="å¤´åƒç®¡ç†" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                        </span>\n                    </h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:150px;overflow-y:auto;overflow-x:hidden;">\n                    ${C.length>0?C.slice(0,12).map((e,t)=>{const n=w.some(t=>t.name===e.name),a=t===Math.min(C.length,12)-1,i=se.get(e.name),r=se.getOffsetX(e.name),c=se.getOffsetY(e.name),s=se.getScale(e.name),l=i?`background-image:url('${i}');background-size:${s}%;background-position:${r}% ${c}%;`:'',d=n?'':'filter:grayscale(80%) brightness(0.7);opacity:0.5;';return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${o(x)}"\n                            data-row-index="${e.index}"\n                            data-preview-type="npc"\n                            style="padding:6px 4px;${a?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <span class="acu-task-name" style="font-size:12px;display:flex;align-items:center;gap:6px;">\n                                    <span class="acu-dash-npc-avatar" style="width:22px;height:22px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:var(--acu-btn-bg);border:1.5px solid ${n?'var(--acu-accent)':'var(--acu-border)'};${l}${d}" title="${n?'åœ¨åœº':'ä¸åœ¨åœº'}">\n                                        ${i?'':`<span style="font-size:10px;font-weight:bold;color:var(--acu-text-sub);${d}">${o(e.name.charAt(0))}</span>`}\n                                    </span>\n                                    <span title="${o(e.name)}" style="${n?'':'opacity:0.6;'}">${o(e.name.length>4?e.name.substring(0,4)+'..':e.name)}</span>\n                                </span>\n                                <div style="display:flex;align-items:center;">\n                                    <i class="fa-solid fa-people-arrows acu-dash-contest-btn" data-npc="${o(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä¸${e.name}è¿›è¡Œå¯¹æŠ—æ£€å®š"></i>\n                                </div>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æš‚æ— é‡è¦äººç‰©</div>'}\n                    </div>\n                </div>\n\n                \x3c!-- å³åˆ—ï¼šèƒŒåŒ… + æŠ€èƒ½ + ä»»åŠ¡ --\x3e\n                <div class="acu-dash-intel">\n                    <h3 class="acu-dash-table-link" data-table="${o(F)}"><i class="fa-solid fa-bag-shopping"></i> ç‰©å“ (${M.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:80px;overflow-y:auto;margin-bottom:10px;">\n                    ${B.length>0?B.map((e,t)=>{const n=t===B.length-1;return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${s?.key||''}"\n                            data-row-index="${t}"\n                            data-preview-type="bag"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:5px 4px;font-size:11px;cursor:pointer;${n?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <span style="color:var(--acu-text-main);flex:1;white-space:nowrap;" title="${o(e.name)}">${o(e.name.length>4?e.name.substring(0,4)+'..':e.name)}</span>\n                            <div style="display:flex;align-items:center;gap:6px;">\n                                <i class="fa-solid fa-hand-pointer acu-dash-use-item-btn" data-item="${o(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="ä½¿ç”¨${e.name}"></i>\n                                <span style="color:var(--acu-accent);font-weight:bold;">${o(e.count)}</span>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">èƒŒåŒ…ä¸ºç©º</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${o(j)}" style="margin-top:10px;"><i class="fa-solid fa-shield-halved"></i> è£…å¤‡ (${R.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:80px;overflow-y:auto;margin-bottom:10px;">\n                    ${R.length>0?R.map((e,t)=>{const n=t===R.length-1;return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${d?.key||''}"\n                            data-row-index="${O.findIndex(t=>t.name===e.name)}"\n                            data-preview-type="equipment"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:5px 4px;font-size:11px;cursor:pointer;${n?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <span style="color:var(--acu-text-main);" title="${o(e.name)}">${o(e.name.length>5?e.name.substring(0,5)+'..':e.name)}</span>\n                            <span style="color:var(--acu-text-sub);font-size:10px;">${o(e.part||e.type)}</span>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æ— è£…å¤‡</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${o(E)}" style="margin-top:10px;"><i class="fa-solid fa-clipboard-list"></i> ä»»åŠ¡ (${T.length})</h3>\n                    ${T.length>0?T.map((e,t)=>{const n=String(e.type||'').includes('ä¸»çº¿');let a=null;const i=String(e.progress||'').match(/(\d+)\s*%/);i&&(a=Math.min(100,Math.max(0,parseInt(i[1],10))));const r=null!==a?`<div style="width:40px;height:4px;background:var(--acu-border);border-radius:2px;overflow:hidden;"><div style="width:${a}%;height:100%;background:var(--acu-accent);"></div></div>`:'';return`<div class="acu-task-item acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${c?.key||''}"\n                            data-row-index="${void 0!==e._rowIndex?e._rowIndex:A.findIndex(t=>t.name===e.name)}"\n                            data-preview-type="quest"\n                            style="padding:4px 8px;margin-bottom:3px;cursor:pointer;">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <div class="acu-task-name" style="font-size:11px;${n?'font-weight:600;':''}">${o(e.name)}</div>\n                                ${r}\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">æ— è¿›è¡Œä¸­ä»»åŠ¡</div>'}\n                </div>\n            </div>\n    `;const q=[n?'å…¨å±€æ•°æ®':null,a?'ä¸»è§’ä¿¡æ¯':null,i?'åœ°ç‚¹':null,r?'NPC':null,c?'ä»»åŠ¡':null,s?'èƒŒåŒ…':null,l?'æŠ€èƒ½':null,d?'è£…å¤‡':null].filter(Boolean);return console.info(`[DICE]ä»ªè¡¨ç›˜æ•°æ®æŠ“å–å®Œæˆï¼Œå…±${q.length}ä¸ªæ¨¡å—: ${q.join(', ')}`),Y},Ln=(e,t)=>{if(!e||!e.rows.length)return`\n            <div class="acu-panel-header"><div class="acu-panel-title"><i class="fa-solid ${gt(t)}"></i> ${t}</div><button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button></div>\n            <div class="acu-panel-content"><div style="text-align:center;color:var(--acu-text-sub);padding:20px;">æš‚æ— æ•°æ®</div></div>`;const n=an(),r=vt()[e.key]||[],c=(e.headers||[]).slice(1),s='grid'===((St()||{})[t]||'list');let l=1;if(1===e.headers.length)l=0;else if(t.includes('æ€»ç»“')||t.includes('å¤§çº²')){const t=e.headers.findIndex(e=>e&&(e.includes('ç´¢å¼•')||e.includes('ç¼–å·')||e.includes('ä»£ç ')));t>0&&(l=t)}let d=e.rows.map((n,o)=>{const r=a.getRowKey(t,n,e.headers);return{data:n,originalIndex:o,rowKey:r,isBookmarked:r&&i.isBookmarked(t,r)}});const u=(Qe[t]||'').toLowerCase().trim(),p=(e=>Tt().includes(e))(t);u?(d=d.filter(e=>e.data.some(e=>String(e).toLowerCase().includes(u))),d.sort((e,t)=>{if(e.isBookmarked&&!t.isBookmarked)return-1;if(!e.isBookmarked&&t.isBookmarked)return 1;const n=String(e.data[l]||'').toLowerCase(),a=String(t.data[l]||'').toLowerCase(),i=n.includes(u),o=a.includes(u);return n===u&&a!==u?-1:n!==u&&a===u?1:i&&!o?-1:!i&&o?1:e.originalIndex-t.originalIndex})):d.sort((e,t)=>e.isBookmarked&&!t.isBookmarked?-1:!e.isBookmarked&&t.isBookmarked?1:p?t.originalIndex-e.originalIndex:e.originalIndex-t.originalIndex);const g=n.itemsPerPage||50,f=d.length,b=Math.ceil(f/g)||1;let m=Ze[t]||1;m>b&&(m=b),m<1&&(m=1),Ze[t]=m;const h=(m-1)*g,v=h+g,x=d.slice(h,v),y=(e=>!!e&&['æ€»ç»“','å¤§çº²','æ—¥å¿—','è®°å½•','å†å²'].some(t=>e.includes(t)))(t),w=y?`\n            <button class="acu-view-btn acu-reverse-btn" data-table="${o(t)}" title="${p?'å½“å‰ï¼šå€’åºï¼ˆæ–°â†’æ—§ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢ä¸ºæ­£åº':'å½“å‰ï¼šæ­£åºï¼ˆæ—§â†’æ–°ï¼‰ï¼Œç‚¹å‡»åˆ‡æ¢ä¸ºå€’åº'}">\n                <i class="fa-solid ${p?'fa-sort-amount-up':'fa-sort-amount-down'}"></i>\n            </button>\n        `:'';let k=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n    <div class="acu-title-main"><i class="fa-solid ${gt(t)}"></i> <span class="acu-title-text">${o(t)}</span></div>\n    <div class="acu-title-sub">(${h+1}-${Math.min(v,f)} / å…±${f}é¡¹)${p?' <span style="color:var(--acu-accent);">â†“å€’åº</span>':''}</div>\n</div>\n                <div class="acu-header-actions">\n                    ${t.includes('äººç‰©')?`<button class="acu-view-btn" id="acu-btn-relation-graph" data-table="${o(t)}" title="æŸ¥çœ‹äººç‰©å…³ç³»å›¾"><i class="fa-solid fa-project-diagram"></i></button>`:''}\n                    ${t.includes('åœ°å›¾')?'<button class="acu-view-btn acu-table-map-btn" title="åœ°å›¾å¯è§†åŒ–"><i class="fa-solid fa-map"></i></button>':''}\n                    ${w}\n                    <button class="acu-view-btn" id="acu-btn-switch-style" data-table="${o(t)}" title="ğŸ”„ ç‚¹å‡»åˆ‡æ¢è§†å›¾æ¨¡å¼ (å½“å‰: ${s?'åŒåˆ—ç½‘æ ¼':'å•åˆ—åˆ—è¡¨'})">\n                        <i class="fa-solid ${s?'fa-th-large':'fa-list'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${o(t)}" title="â†•ï¸ æ‹–åŠ¨è°ƒæ•´é¢æ¿é«˜åº¦ | åŒå‡»æ¢å¤é»˜è®¤"></i>\n                    </div>\n\n                    <div class="acu-search-wrapper"><i class="fa-solid fa-search acu-search-icon"></i><input type="text" class="acu-search-input" placeholder="æœç´¢å…¨éƒ¨..." value="${(Qe[t]||'').replace(/"/g,'&quot;')}" /></div>\n                    <button class="acu-close-btn" title="å…³é—­"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>\n            <div class="acu-panel-content"><div class="acu-card-grid">`;if(k+=x.map(d=>{const u=d.originalIndex,p=d.data,g=r.includes(u),f=p[l]||'æœªå‘½å',b=1===l,m=`${e.key}-${u}-${l}`,h=window.acuModifiedSet&&window.acuModifiedSet.has(m),v=He.has(`${t}-row-${u}`);let x='';n.highlightNew&&(h?x='acu-highlight-manual':v&&(x='acu-highlight-diff'));const y=p.map((_,e)=>e).filter(e=>e>0&&e!==l),w=y.length%2==1,k=p.map((i,r)=>{if(r<=0||r===l)return'';if((c[r-1]||'').includes('äº¤äº’'))return'';const s=r===y[y.length-1]&&w,d=c[r-1]||'å±æ€§'+r,g=a.getRowKey(t,p,e.headers),f=g&&a.isFieldLocked(t,g,c[r-1])?'<i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:10px;opacity:0.7;margin-left:4px;" title="å·²é”å®š"></i>':'',b=d.replace(/[\(ï¼ˆ\[ã€][^)ï¼‰\]ã€‘]*[\)ï¼‰\]ã€‘]/g,'').trim(),m=e=>String(e).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),h=String(i).trim(),v=ce(h),x=['-','--','â€”','null','none','æ— ','ç©º','n/a','undefined','/','nil'];if(x.includes(v.toLowerCase()))return'';let k='',C=!1;const E=/[;ï¼›]/,A=e=>{if(!e)return!1;return String(e).toLowerCase().includes('èº«ä»½')},S=A(d)?[]:Ne(v);if(A(d)){const e=ft(v),t=''===m(v)&&'0'!==String(i)?'&nbsp;':m(v);k=e?'<span class="acu-badge '+e+'">'+t+'</span>':t}else if(Oe(v,b)){const e=je(v).filter(e=>!e.relation||!x.includes(e.relation.toLowerCase()));if(e.length>1){C=!0;let t='';for(let n=0;n<e.length;n++){const a=e[n];t+='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;'+(n<e.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'')+'">',t+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+m(a.name)+f+'</span>',a.relation&&(t+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+m(a.relation)+'</span>'),t+='</div>'}k='<div class="acu-relation-container">'+t+'</div>'}else if(1===e.length){C=!0;const t=e[0];k='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">',k+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+m(t.name)+f+'</span>',t.relation&&(k+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+m(t.relation)+'</span>'),k+='</div>'}}else if(S.length>1){C=!0;let e='';for(let t=0;t<S.length;t++){const n=S[t],a=!X.isBlacklisted(n.name);e+='<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;">',e+='<span style="color:var(--acu-text-sub);font-size:0.9em;white-space:nowrap;" title="'+m(n.name)+'">'+m(n.name.length>3?n.name.substring(0,5):n.name)+f+'</span>',e+='<div style="display:flex;align-items:center;gap:4px;">',e+='<span style="color:var(--acu-text-main);font-weight:bold;font-size:0.95em;">'+n.value+'</span>',a&&(e+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+m(n.name)+'" data-attr-value="'+n.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:10px;" title="æ£€å®š"></i>'),e+='</div></div>'}k='<div class="acu-multi-attr-container">'+e+'</div>'}else if(1===S.length){C=!0;const e=S[0],t=!X.isBlacklisted(e.name);k='<div style="display:flex;justify-content:space-between;align-items:center;">',k+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+m(e.name)+f+'</span>',k+='<div style="display:flex;align-items:center;gap:6px;">',k+='<span style="color:var(--acu-text-main);font-weight:bold;">'+e.value+'</span>',t&&(k+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+m(e.name)+'" data-attr-value="'+e.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>'),k+='</div></div>'}else if(v.length>0&&E.test(v)&&!v.includes('http')){const e=['-','--','â€”','null','none','æ— ','ç©º','n/a','undefined','/','nil'],t=v.split(E).map(e=>e.trim()).filter(t=>t&&!e.includes(t.toLowerCase()));if(t.length>1&&t.every(e=>e.length<=6)){k='<div class="acu-tag-container">'+t.map(e=>'<span class="acu-badge '+(ft(e)||'acu-badge-neutral')+'">'+m(e)+'</span>').join('')+'</div>'}else k=t.length>0?m(t.join('; ')):''}else if(!De(v)||v.includes(':')||v.includes('ï¼š')){const e=ft(v),t=''===m(v)&&'0'!==String(i)?'&nbsp;':m(v);k=e?'<span class="acu-badge '+e+'">'+t+'</span>':t}else{const e=Pe(v),t=!X.isBlacklisted(b);k='<div style="display:flex;justify-content:space-between;align-items:center;">',k+='<span>'+m(v)+'</span>',t&&(k+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+m(b)+'" data-attr-value="'+e+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>'),k+='</div>'}const I=He.has(t+'-'+u+'-'+r),T=e.key+'-'+u+'-'+r,F=window.acuModifiedSet&&window.acuModifiedSet.has(T);let M='';n.highlightNew&&(F?M='acu-highlight-manual':I&&(M='acu-highlight-diff'));return'<div class="'+('acu-card-row acu-cell'+(s?' acu-grid-span-full':'')+(C?' acu-hide-label':''))+'" data-key="'+o(e.key)+'" data-tname="'+o(t)+'" data-row="'+u+'" data-col="'+r+'" data-val="'+encodeURIComponent(i??'')+'"><div class="acu-card-label">'+b+f+'</div><div class="acu-card-value '+M+'">'+k+'</div></div>'}).join('');let C=Be(t),E='';const A=c.findIndex(e=>e&&e.includes('äº¤äº’'));if(A>=0&&p[A+1]){const e=['-','null','none','æ— ','ç©º','n/a','undefined','/'],t=String(p[A+1]).split(/[,ï¼Œã€;ï¼›]/).map(e=>e.trim()).filter(t=>t&&!e.includes(t.toLowerCase()));if(t.length>0){const e=C.map(e=>e.label.toLowerCase()),n={æˆ˜æ–—:'fa-hand-fist',æ”»å‡»:'fa-hand-fist',äº¤è°ˆ:'fa-comments',å¯¹è¯:'fa-comments',è§‚å¯Ÿ:'fa-eye',æŸ¥çœ‹:'fa-eye',ä½¿ç”¨:'fa-hand-pointer',èµ é€:'fa-gift',é€ç¤¼:'fa-gift',ä¸¢å¼ƒ:'fa-trash',è£…å¤‡:'fa-shield-halved',é‚€çº¦:'fa-calendar-check',å‘Šåˆ«:'fa-hand',æ±‚çˆ±:'fa-heart',è¡¨æ¼”:'fa-music'},a=t.filter(t=>!e.includes(t.toLowerCase())).map(e=>({label:e,icon:n[e]||'fa-hand-pointer',type:'prompt',template:`<user>${e}{Name}ã€‚`,auto_send:!0}));C=[...C,...a]}}if(C.length>0){p[l];E=`<div class="acu-card-actions">${C.map((e,t)=>`<button class="acu-action-item ${'check'===e.type?'check-type':''}" data-action-idx="${t}" data-row="${u}"><i class="fa-solid ${e.icon||'fa-play'}"></i> ${o(e.label)}</button>`).join('')}</div>`}const S=a.getRowKey(t,p,e.headers),I=S&&a.isRowLocked(t,S)?' <i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:11px;opacity:0.8;" title="æ•´è¡Œå·²é”å®š"></i>':'',T=a.getRowKey(t,p,e.headers),F=T&&i.isBookmarked(t,T),M=T?`<i class="${F?'fa-solid':'fa-regular'} fa-bookmark acu-bookmark-icon ${F?'bookmarked':''}" data-table="${o(t)}" data-row-key="${o(T)}" title="${F?'å–æ¶ˆä¹¦ç­¾':'æ·»åŠ ä¹¦ç­¾'}"></i>`:'';return`<div class="acu-data-card ${g?'pending-deletion':''}"><div class="acu-card-header"><span class="acu-card-index">${b?'#'+(u+1):''}</span><span class="acu-cell acu-editable-title ${x}" data-key="${o(e.key)}" data-tname="${o(t)}" data-row="${u}" data-col="${l}" data-val="${encodeURIComponent(f??'')}" title="ç‚¹å‡»ç¼–è¾‘æ ‡é¢˜">${o(f)}${I}</span>${M}</div><div class="acu-card-body ${s?'view-grid':'view-list'}">${k}</div>${E}</div>`}).join(''),k+='</div></div>',b>1){k+=`<div class="acu-panel-footer"><button class="acu-page-btn ${1===m?'disabled':''}" data-page="${m-1}" ${1===m?'disabled':''}><i class="fa-solid fa-chevron-left"></i></button>`;const e=[];if(b<=7)for(let t=1;t<=b;t++)e.push(t);else m<=4?e.push(1,2,3,4,5,'...',b):m>=b-3?e.push(1,'...',b-4,b-3,b-2,b-1,b):e.push(1,'...',m-1,m,m+1,'...',b);e.forEach(e=>{k+='...'===e?'<span class="acu-page-info">...</span>':`<button class="acu-page-btn ${e===m?'active':''}" data-page="${e}">${e}</button>`}),k+=`<button class="acu-page-btn ${m===b?'disabled':''}" data-page="${m+1}" ${m===b?'disabled':''}><i class="fa-solid fa-chevron-right"></i></button></div>`}return k},Un=()=>{const{$}=ut(),e=mt(),t=$('.acu-panel-content');if(e&&t.length){const n={};t.find('.acu-data-card, .acu-card-body, .acu-edit-textarea').each(function(){if(this.scrollTop>0){const e=$(this).closest('.acu-data-card').find('.acu-editable-title').data('row'),t=$(this).hasClass('acu-edit-textarea');if(void 0!==e){n[t?`edit-${e}`:e]=this.scrollTop}}}),at[e]={left:t.scrollLeft(),top:t.scrollTop(),inner:n,timestamp:Date.now()}}},Vn=()=>{const{$}=ut();Un(),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active'),ht(null)},Yn=e=>{const{$}=ut(),t=$('#acu-data-area');t.hasClass('visible')?e(t):(e(t),t.addClass('visible'))},qn=e=>{const{$}=ut(),t=$('.acu-wrapper');t.on('click','.acu-dash-relation-graph-btn',function(e){e.stopPropagation();const t=pn(Je||ln()),n=Ie.findTable(t,'npc');n&&n.data?Gt(n.data):window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°äººç‰©æ•°æ®')}),t.on('click','.acu-dash-map-btn',function(e){e.stopPropagation(),Kt()}),t.on('click','.acu-dash-avatar-manager-btn',function(e){e.stopPropagation();try{let e;try{const t=Je||ln();e=pn(t)}catch(e){throw console.error('è·å–è¡¨æ ¼æ•°æ®å¤±è´¥:',e),new Error('æ— æ³•è¯»å–è¡¨æ ¼æ•°æ®')}if(!e||0===e.length)return void(window.toastr&&window.toastr.warning('ä»ªè¡¨ç›˜æ•°æ®ä¸ºç©ºï¼Œè¯·å…ˆæ·»åŠ è¡¨æ ¼æ•°æ®'));const t=Ie.findTable(e,'npc'),n=Ie.findTable(e,'player'),a=[];if(n?.data?.rows?.[0]){const e=n.data.rows[0][1];e&&'string'==typeof e&&e.trim()&&a.push({name:e.trim(),isPlayer:!0})}if(t?.data?.rows&&Array.isArray(t.data.rows)&&t.data.rows.forEach((e,t)=>{if(Array.isArray(e)&&e[1]){const n=e[1];'string'==typeof n&&n.trim()&&a.push({name:n.trim(),isPlayer:!1,rowIndex:t})}}),0===a.length)return void(window.toastr&&window.toastr.warning('æœªæ‰¾åˆ°è§’è‰²æ•°æ®ï¼Œè¯·å…ˆåœ¨ä»ªè¡¨ç›˜ä¸­æ·»åŠ ä¸»è§’æˆ–NPC'));try{Qt(a,()=>Sn())}catch(e){throw console.error('showAvatarManager æ‰§è¡Œå¤±è´¥:',e),new Error('å¤´åƒç®¡ç†å™¨åˆå§‹åŒ–å¤±è´¥')}}catch(e){console.error('å¤´åƒç®¡ç†æŒ‰é’®é”™è¯¯:',e);const t=e instanceof Error?e.message:'æœªçŸ¥é”™è¯¯';window.toastr&&window.toastr.error(`æ‰“å¼€å¤´åƒç®¡ç†å¤±è´¥: ${t}`)}}),t.on('click','.acu-dash-table-link',function(e){e.stopPropagation();const t=$(this).data('table');t&&(bt.set(m,!1),ht(t),Sn())}),$('.acu-panel-content').off('touchstart.acu_swipe touchmove.acu_swipe').on('touchstart.acu_swipe',function(e){this._touchStartX=e.originalEvent.touches[0].clientX,this._touchStartY=e.originalEvent.touches[0].clientY}).on('touchmove.acu_swipe',function(e){if(!this._touchStartX)return;const t=Math.abs(e.originalEvent.touches[0].clientX-this._touchStartX);t>Math.abs(e.originalEvent.touches[0].clientY-this._touchStartY)&&t>10&&e.stopPropagation()}),$('body').off('click.acu_nav_toggle').on('click.acu_nav_toggle','.acu-nav-toggle-btn',function(e){if(e.stopPropagation(),e.preventDefault(),Ye)return;const t=kt();$t(!t),Sn()});const n=$('.acu-panel-content');if(n.length){let e=null;n.off('scroll.acu_save').on('scroll.acu_save',function(){const t=$(this);e&&clearTimeout(e),e=setTimeout(()=>{const e=mt();e&&(at[e]||(at[e]={top:0,left:0,inner:{}}),at[e].top=t.scrollTop(),at[e].left=t.scrollLeft())},200)})}$('body').off('click.acu_delegate').on('click.acu_delegate','.acu-wrapper',function(e){if(Ye)return;const t=$(e.target);if(t.closest('#acu-btn-settings').length)return e.stopPropagation(),e.preventDefault(),void _n();const n=t.closest('.acu-nav-btn');if(n.length){if('acu-btn-dashboard'===n.attr('id')){e.preventDefault(),e.stopImmediatePropagation();const t=bt.get(m,!1),a=$('#acu-data-area').hasClass('visible');return t&&a?(bt.set(m,!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(bt.set(m,!0),ht(null),$('.acu-nav-btn').removeClass('active'),n.addClass('active'),Yn(e=>{const t=Je||ln(),n=pn(t||{});e.html(Rn(n)),qn(n)})),!1}if('acu-btn-changes'===n.attr('id')){e.preventDefault(),e.stopImmediatePropagation();const t=bt.get('acu_changes_panel_active',!1),a=$('#acu-data-area').hasClass('visible');return t&&a?(bt.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(bt.set('acu_changes_panel_active',!0),bt.set(m,!1),ht(null),$('.acu-nav-btn').removeClass('active'),n.addClass('active'),Yn(e=>{const t=Je||ln();e.html(zn(t)),Bn()})),!1}if('acu-btn-mvu'===n.attr('id')){e.preventDefault(),e.stopImmediatePropagation();const t=mt()===ue.MODULE_ID,a=$('#acu-data-area').hasClass('visible');return t&&a?(ht(null),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')):(bt.set(m,!1),bt.set('acu_changes_panel_active',!1),ht(ue.MODULE_ID),$('.acu-nav-btn').removeClass('active'),n.addClass('active'),Yn(e=>{try{const t=ue.renderPanel(),n=Et()[ue.MODULE_ID];n?e.css('height',n+'px').addClass('acu-manual-mode'):e.css('height','').removeClass('acu-manual-mode'),e.html('<div class="acu-mvu-panel">'+t+'</div>'),ue.bindEvents(e)}catch(e){console.error('[MVU] Error rendering panel:',e)}ue.getDataWithRetry(5,800).then(t=>{t&&(e.html('<div class="acu-mvu-panel">'+ue.renderPanel()+'</div>'),ue.bindEvents(e))}).catch(t=>{console.error('[DICE]MvuModule Error getting data:',t),e.html('<div class="acu-mvu-panel">'+ue.renderPanel()+'</div>'),ue.bindEvents(e)})})),!1}e.stopPropagation(),bt.set(m,!1),bt.set('acu_changes_panel_active',!1);const t=n.data('table'),a=mt();return a===t&&$('#acu-data-area').hasClass('visible')?void Vn():($('.acu-nav-btn').removeClass('active'),n.addClass('active'),$('.acu-panel-content').length&&a&&Un(),ht(t),void setTimeout(()=>Sn(),0))}const a=t.closest('.acu-cell');if(a.length)return e.stopPropagation(),void Hn(e,a[0]);const i=t.closest('.acu-page-btn');if(i.length){if(e.stopPropagation(),i.hasClass('disabled')||i.hasClass('active'))return;const t=parseInt(i.data('page')),n=mt();return void(n&&(Ze[n]=t,Sn(),requestAnimationFrame(()=>{$('.acu-panel-content').scrollTop(0)})))}}),$('#acu-btn-expand').off('click').on('click',e=>{e.stopPropagation(),Ye||($t(!1),Sn())}),$('#acu-btn-collapse').off('click').on('click',e=>{e.stopPropagation(),Ye||($t(!0),Sn())}),$('#acu-btn-refresh').off('click').on('click',async e=>{if(e.stopPropagation(),Ye)return;if(Ve)return void(window.toastr&&window.toastr.warning('â³ æ­£åœ¨åå°åŒæ­¥æ•°æ®ï¼Œæ— æ³•æ’¤é”€ï¼Œè¯·ç¨å...'));$(e.currentTarget).find('i');xt({}),Je=null,Ke=!1,He.clear(),window.acuModifiedSet&&window.acuModifiedSet.clear();const t=$('#acu-btn-save-global');t.find('i').removeClass('acu-icon-breathe'),t.attr('title','ä¿å­˜æ‰€æœ‰ä¿®æ”¹').css('color','');const n=Ct();n&&(Je=n),$('.acu-edit-overlay, .acu-cell-menu, .acu-menu-backdrop').remove(),Sn()}),$('#acu-btn-force-update').off('click').on('click',async e=>{if(e.stopPropagation(),Ye)return;const t=ut().getDB();if(t&&'function'==typeof t.manualUpdate)try{await t.manualUpdate()}catch(e){console.error('[DICE]ACU æ‰‹åŠ¨æ›´æ–°å¤±è´¥:',e);const t=e.message||'æ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯';window.toastr?window.toastr.error(`æ›´æ–°å¤±è´¥: ${t}`,'é”™è¯¯',{timeOut:5e3}):alert(`æ›´æ–°å¤±è´¥: ${t}`)}else window.toastr&&window.toastr.warning('âš  åç«¯è„šæœ¬æœªæä¾› manualUpdate æ¥å£ï¼Œè¯·ç¡®ä¿åŒæ—¶ä¹Ÿæ›´æ–°äº†æœ€æ–°çš„åç«¯è„šæœ¬','',{timeOut:5e3})}),$('body').off('click.acu_settings').on('click.acu_settings','#acu-btn-settings',function(e){e.stopPropagation(),e.preventDefault(),Ye||_n()}),$('#acu-btn-dice-nav').off('click').on('click',e=>{e.stopPropagation(),Ye||qt({targetValue:null,targetName:'è‡ªç”±æ£€å®š'})}),$('#acu-btn-refill').off('click').on('click',async e=>{if(e.stopPropagation(),Ye)return;const t=ut().getDB();if(t&&'function'==typeof t.manualUpdate)try{console.log('[DICE]ACU æ‰‹åŠ¨å¡«è¡¨è§¦å‘'),await t.manualUpdate()}catch(e){console.error('[DICE]ACU æ‰‹åŠ¨å¡«è¡¨å¤±è´¥:',e);const t=e.message||'å¡«è¡¨è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯';window.toastr?window.toastr.error(`å¡«è¡¨å¤±è´¥: ${t}`,'é”™è¯¯',{timeOut:5e3}):alert(`å¡«è¡¨å¤±è´¥: ${t}`)}else console.warn('[DICE]ACU manualUpdate API ä¸å¯ç”¨'),window.toastr&&window.toastr.warning('åç«¯è„šæœ¬æœªæä¾› manualUpdate æ¥å£','',{timeOut:3e3})}),$('#acu-btn-save-global').off('click').on('click',async function(e){if(e.stopPropagation(),Ye)return;let t=null;if(t=Ke&&Je?Je:ln(),t){await dn(t,!0,!0),$('.acu-highlight-manual').removeClass('acu-highlight-manual'),window.acuModifiedSet&&window.acuModifiedSet.clear(),Ke=!1;const e=$(this);e.find('i').removeClass('acu-icon-breathe fa-spinner fa-spin').addClass('fa-save'),e.attr('title','ä¿å­˜æ‰€æœ‰ä¿®æ”¹').css('color',''),e.prop('disabled',!1)}else window.toastr&&window.toastr.error('æ— æ³•è·å–æœ‰æ•ˆæ•°æ®ï¼Œä¿å­˜å¤±è´¥')});const c=$('.acu-search-input');if(c.length){let e,t=!1;c.off('compositionstart compositionend input').on('compositionstart',()=>{t=!0}).on('compositionend',function(){t=!1;const e=$(this).val(),n=mt();n&&(Qe[n]=e,Ze[n]=1,Sn(),setTimeout(()=>{$('.acu-search-input').focus()},0))}).on('input',function(){if(t)return;const n=$(this).val(),a=this.selectionStart,i=this.selectionEnd;clearTimeout(e),e=setTimeout(()=>{const e=mt();if(e){Qe[e]=n,Ze[e]=1;const t=document.activeElement&&document.activeElement.classList.contains('acu-search-input');if(Sn(),t){const e=$('.acu-search-input');if(e.focus(),e.length&&e[0].setSelectionRange)try{e[0].setSelectionRange(a,i)}catch(e){}}}},300)})}$('#acu-btn-relation-graph').off('click').on('click',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table'),n=Je||ln();if(n)for(const e in n){const a=n[e];if(a?.name===t){const t={headers:a.content?.[0]||[],rows:a.content?.slice(1)||[],key:e};return void Gt(t)}}window.toastr&&window.toastr.warning('æ— æ³•è·å–è¡¨æ ¼æ•°æ®')}),$('.acu-table-map-btn').off('click').on('click',function(e){e.preventDefault(),e.stopPropagation(),Kt()}),$('#acu-btn-switch-style').off('click').on('click',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table'),n=St(),a=n[t]||'list';var i;n[t]='grid'===a?'list':'grid',i=n,bt.set(v,i),Sn()}),$('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(e){if(0!==e.button)return;e.preventDefault(),e.stopPropagation();const t=this;t.setPointerCapture(e.pointerId),$(t).addClass('active');const n=$('#acu-data-area'),a=n.height(),i=e.clientY,o=$(t).data('table');t.onpointermove=function(e){const t=e.clientY-i;let o=a-t;o<w&&(o=w),o>k&&(o=k),n.css('height',o+'px')},t.onpointerup=function(e){if($(t).removeClass('active'),t.releasePointerCapture(e.pointerId),t.onpointermove=null,t.onpointerup=null,o){const e=Et();e[o]=parseInt(n.css('height')),At(e),n.addClass('acu-manual-mode')}}}),$('.acu-height-drag-handle').off('dblclick').on('dblclick',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table');if(t){const e=Et();delete e[t],At(e),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),t.on('click','.acu-reverse-btn',function(e){e.stopPropagation();const t=$(this).data('table');t&&(Ft(t),Sn())}),$('.acu-panel-header').off('dblclick.acu').on('dblclick.acu',function(e){if($(e.target).closest('.acu-search-input, .acu-close-btn, .acu-view-btn').length)return;e.preventDefault(),e.stopPropagation();const t=mt();if(t){const e=Et();delete e[t],At(e),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),$('.acu-close-btn').off('click').on('click',function(e){e.stopPropagation();const t=$('.acu-search-input');if(t.length&&t.val())return void t.val('').trigger('input').focus();if(bt.get(m,!1))return bt.set(m,!1),ht(null),void Sn();if(mt()===ue.MODULE_ID)return ht(null),void Sn();Vn()}),$('body').off('click.acu_bookmark').on('click.acu_bookmark','.acu-bookmark-icon',function(e){e.stopPropagation(),e.preventDefault();const t=$(this),n=t.data('table'),a=t.data('row-key');n&&a&&(i.toggleBookmark(n,a),'function'==typeof Sn&&Sn())}),$('body').off('click.acu_action').on('click.acu_action','.acu-action-item',function(e){e.stopPropagation(),e.preventDefault();const t=$(this),n=parseInt(t.data('row'),10),a=parseInt(t.data('action-idx'),10),i=t.closest('.acu-data-card').find('.acu-editable-title'),c=i.data('key'),s=i.data('tname')||'',l=Je||ln();if(!l||!l[c])return;const d=l[c].content[0]||[],u=l[c].content[n+1]||[],p=['-','null','none','æ— ','ç©º','n/a','undefined','/'];let g=Be(s);const f=d.findIndex(e=>e&&String(e).includes('äº¤äº’'));if(f>=0&&u[f]){const e=String(u[f]).trim();if(e&&!p.includes(e.toLowerCase())){const t=e.split(/[,ï¼Œã€;ï¼›]/).map(e=>e.trim()).filter(e=>e&&!p.includes(e.toLowerCase()));if(t.length>0){const e=g.map(e=>e.label.toLowerCase()),n=t.filter(t=>!e.includes(t.toLowerCase())).map(e=>({label:e,icon:'fa-hand-pointer',type:'prompt',template:`<user>å¯¹{Name}è¿›è¡Œäº¤äº’ï¼š${e}ã€‚`,auto_send:!0}));g=[...g,...n]}}}const b=g[a];if(b&&'skill_check'===b.type){const e=u[1]||'æŠ€èƒ½';let t=null;const n=d.findIndex(e=>e&&e.includes('å±æ€§å€¼')),a=d.findIndex(e=>e&&(e.includes('ç†Ÿç»ƒ')||e.includes('ç­‰çº§')));if(n>0&&u[n]){const e=Pe(u[n]);e>0&&(t=e)}if(null===t&&a>0&&u[a]){const e=Pe(u[a]);e>0&&(t=e)}const i=Re(b.template,u,d);return r(i,'action'),void(null!==t&&t>0?qt({targetValue:t,targetName:e,initiatorName:'<user>'}):$('#send_textarea').focus())}if(b&&b.template){const e=Je||ln();if(e&&e[c]){const t=e[c].content[0]||[],a=e[c].content[n+1]||[],i=a[1]||'å¯¹æ–¹';if('äº¤è°ˆ'===b.label){an();$('.acu-msg-overlay').remove();const e=Me(),t=$(`\n                        <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2147483647;display:flex;justify-content:center;align-items:center;">\n                            <div style="background:${e.bgPanel};border:1px solid ${e.border};border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                                <div style="font-size:14px;font-weight:bold;color:${e.accent};margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                                    <i class="fa-solid fa-comment"></i> å‘é€æ¶ˆæ¯ç»™ ${o(i)}\n                                </div>\n                                <input type="text" id="acu-msg-input" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..." style="width:100%;padding:10px 12px;background:${e.inputBg} !important;border:1px solid ${e.border};border-radius:6px;color:${e.textMain} !important;font-size:14px;box-sizing:border-box;" autofocus>\n                                <div style="display:flex;gap:8px;margin-top:12px;">\n                                    <button id="acu-msg-cancel" style="flex:1;padding:8px;background:${e.inputBg};border:1px solid ${e.border};border-radius:6px;color:${e.textMain};cursor:pointer;">å–æ¶ˆ</button>\n                                    <button id="acu-msg-send" style="flex:1;padding:8px;background:${e.btnActiveBg};border:none;border-radius:6px;color:${e.btnActiveText};cursor:pointer;font-weight:bold;">å‘é€</button>\n                                </div>\n                            </div>\n                        </div>\n                    `);$('body').append(t);const n=t[0];n.style.setProperty('position','fixed','important'),n.style.setProperty('top','0','important'),n.style.setProperty('left','0','important'),n.style.setProperty('right','0','important'),n.style.setProperty('bottom','0','important'),n.style.setProperty('width','100vw','important'),n.style.setProperty('height','100vh','important'),n.style.setProperty('display','flex','important'),n.style.setProperty('justify-content','center','important'),n.style.setProperty('align-items','center','important'),n.style.setProperty('z-index','2147483650','important'),setTimeout(()=>t.find('#acu-msg-input').focus(),50);const a=()=>{const e=t.find('#acu-msg-input').val().trim();if(e){r(`<user>å¯¹${i}è¯´ï¼š"${e}"`,'action'),$('#send_textarea').focus()}t.remove()};return t.find('#acu-msg-send').click(a),t.find('#acu-msg-input').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),a())}),t.find('#acu-msg-cancel').click(()=>t.remove()),void t.on('click',function(e){$(e.target).hasClass('acu-msg-overlay')&&t.remove()})}const s=Re(b.template,a,t);r(s,'action'),$('#send_textarea').focus()}}}),$('body').off('click.acu_global_dice').on('click.acu_global_dice','#acu-btn-dice',function(e){e.stopPropagation(),qt({targetValue:50,targetName:'è‡ªå®šä¹‰æ£€å®š',diceType:'1d100'})}),$('body').off('click.acu_location_toggle').on('click.acu_location_toggle','.acu-location-header',function(e){e.stopPropagation();$(this).closest('.acu-location-group').toggleClass('expanded')}),$('body').off('click.acu_dash_jump').on('click.acu_dash_jump','.acu-dash-jump-link, .acu-dash-loc-item',function(e){e.stopPropagation();const t=$(this).data('table'),n=$(this).data('search')||'';t&&(bt.set(m,!1),ht(t),n&&(Qe[t]=n,Ze[t]=1),Sn(),n&&setTimeout(()=>{const e=$('.acu-search-input');e.length&&e.focus()},100))}),$('body').off('click.acu_inline_dice').on('click.acu_inline_dice','.acu-inline-dice-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).attr('data-attr-name')||'å±æ€§',n=parseInt($(this).attr('data-attr-value'),10)||50,a=$(this).closest('.acu-data-card'),i=a.find('.acu-editable-title').text().trim(),o=(a.find('.acu-editable-title').data('tname')||'').includes('ä¸»è§’');qt({attrValue:n,targetValue:null,targetName:t,initiatorName:o?'<user>':i})}),$('body').off('click.acu_dash_dice').on('click.acu_dash_dice','.acu-dash-dice-btn',function(e){e.stopPropagation(),e.preventDefault();const t=parseInt($(this).data('target'),10)||50,n=$(this).data('name')||'å±æ€§',a=$(this).data('npc')||'';if(a){const e=zt('<user>',n)||50;Ht({initiatorName:'<user>',initiatorValue:e,opponentName:a,opponentValue:t})}else qt({targetValue:t,targetName:n,initiatorName:'<user>'})}),$('body').off('click.acu_dash_goto').on('click.acu_dash_goto','.acu-dash-goto-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('location')||'æœªçŸ¥åœ°ç‚¹';r(`<user>å‰å¾€${t}ã€‚`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_item').on('click.acu_dash_use_item','.acu-dash-use-item-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('item')||'ç‰©å“';r(`<user>ä½¿ç”¨${t}ã€‚`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_skill').on('click.acu_dash_use_skill','.acu-dash-use-skill-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('skill')||'æŠ€èƒ½',n=Je||ln();let a=null;if(n)for(const e in n){const i=n[e];if(i&&i.name&&i.content&&(i.name.includes('æŠ€èƒ½')||i.name.includes('èƒ½åŠ›'))){const e=i.content[0]||[],n=e.findIndex(e=>e&&(e.includes('åç§°')||e.includes('æŠ€èƒ½å')))||1,o=e.findIndex(e=>e&&e.includes('å±æ€§å€¼')),r=e.findIndex(e=>e&&(e.includes('ç†Ÿç»ƒ')||e.includes('ç­‰çº§')));for(let e=1;e<i.content.length;e++){const c=i.content[e];if(c&&c[-1===n?1:n]===t){if(o>0&&c[o]){const e=Pe(c[o]);if(e>0){a=e;break}}if(r>0&&c[r]){const e=Pe(c[r]);if(e>0){a=e;break}}break}}if(null!==a)break}}r(`<user>ä½¿ç”¨${t}ã€‚`,'action'),null!==a&&a>0?qt({targetValue:a,targetName:t,initiatorName:'<user>'}):$('#send_textarea').focus()}),$('body').off('click.acu_dash_track_task').on('click.acu_dash_track_task','.acu-dash-track-task-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('task')||'ä»»åŠ¡';r(`<user>å°†${t}è®¾ä¸ºå½“å‰è¿½è¸ªç›®æ ‡ã€‚`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_msg').on('click.acu_dash_msg','.acu-dash-msg-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('npc')||'å¯¹æ–¹';an();$('.acu-msg-overlay').remove();const n=Me(),a=$(`\n            <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2147483647;display:flex;justify-content:center;align-items:center;">\n                <div class="acu-msg-dialog" style="background:${n.bgPanel};border:1px solid ${n.border};border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                    <div style="font-size:14px;font-weight:bold;color:${n.accent};margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                        <i class="fa-solid fa-comment"></i> å‘é€æ¶ˆæ¯ç»™ ${o(t)}\n                    </div>\n                    <input type="text" id="acu-msg-input" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..." style="width:100%;padding:10px 12px;background:${n.inputBg} !important;border:1px solid ${n.border};border-radius:6px;color:${n.textMain} !important;font-size:14px;box-sizing:border-box;" autofocus>\n                    <div style="display:flex;gap:8px;margin-top:12px;">\n                        <button id="acu-msg-cancel" style="flex:1;padding:8px;background:${n.inputBg};border:1px solid ${n.border};border-radius:6px;color:${n.textMain};cursor:pointer;">å–æ¶ˆ</button>\n                        <button id="acu-msg-send" style="flex:1;padding:8px;background:${n.btnActiveBg};border:none;border-radius:6px;color:${n.btnActiveText};cursor:pointer;font-weight:bold;">å‘é€</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(a);const i=a[0];i.style.setProperty('position','fixed','important'),i.style.setProperty('top','0','important'),i.style.setProperty('left','0','important'),i.style.setProperty('right','0','important'),i.style.setProperty('bottom','0','important'),i.style.setProperty('width','100vw','important'),i.style.setProperty('height','100vh','important'),i.style.setProperty('display','flex','important'),i.style.setProperty('justify-content','center','important'),i.style.setProperty('align-items','center','important'),i.style.setProperty('z-index','2147483650','important'),setTimeout(()=>a.find('#acu-msg-input').focus(),50);const c=()=>{const e=a.find('#acu-msg-input').val().trim();if(e){r(`<user>å¯¹${t}è¯´ï¼š"${e}"`,'action'),$('#send_textarea').focus()}a.remove()};a.find('#acu-msg-send').click(c),a.find('#acu-msg-input').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),c())}),a.find('#acu-msg-cancel').click(()=>a.remove()),a.on('click',function(e){$(e.target).hasClass('acu-msg-overlay')&&a.remove()})}),$('body').off('click.acu_dash_contest').on('click.acu_dash_contest','.acu-dash-contest-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('npc')||'',n=Je||ln();var a=50,i=50;if(n)for(var o in n){var r=n[o];if(r&&r.name&&r.content){if('ä¸»è§’ä¿¡æ¯'===r.name&&r.content[1])for(var c=(r.content[1][7]||'').split(/[,ï¼Œ;ï¼›\s]+/),s=0;s<c.length;s++){var l=c[s].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\sï¼š]\s*(\d+)/);if(l){a=parseInt(l[2],10);break}}if('é‡è¦äººç‰©è¡¨'===r.name&&t)for(var d=1;d<r.content.length;d++){var u=r.content[d];if(u&&u[1]===t){for(var p=(u[9]||'').split(/[,ï¼Œ;ï¼›\s]+/),g=0;g<p.length;g++){var f=p[g].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\sï¼š]\s*(\d+)/);if(f){i=parseInt(f[2],10);break}}break}}}}Ht({initiatorName:'<user>',initiatorValue:a,opponentName:t,opponentValue:i,diceType:'1d100'})}),$('body').off('click.acu_dash_preview').on('click.acu_dash_preview','.acu-dash-preview-trigger',function(e){e.stopPropagation();const t=$(this).data('table-key'),n=parseInt($(this).data('row-index'),10);if(!t||isNaN(n))return;const i=Je||ln();if(!i||!i[t])return;const r=i[t],c=r.name||'è¯¦æƒ…',s=r.content[0]||[],l=r.content[n+1];if(!l)return;const d=an(),u=l[1]||'æœªå‘½å',p=n;let g='';l.forEach((e,n)=>{if(n<=0||1===n)return;if((s[n]||'').includes('äº¤äº’'))return;const i=s[n]||'å±æ€§'+n,r=String(e||'').trim();if(!r)return;const d=a.getRowKey(c,l,s),u=d&&a.isFieldLocked(c,d,i)?'<i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:10px;opacity:0.7;margin-left:4px;" title="å·²é”å®š"></i>':'';let f='',b=!1;const m=Ne(r);if(Oe(r,i)){const e=je(r);if(e.length>1){b=!0;let t='';e.forEach((n,a)=>{const i=a<e.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';t+=`<div style="display:flex;justify-content:flex-start;align-items:center;gap:8px;padding:3px 0;${i}">\n                              <span style="color:var(--acu-text-main);font-size:0.95em;">${o(n.name)}${u}</span>\n                              ${n.relation?`<span style="color:var(--acu-text-sub);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${o(n.relation)}</span>`:''}\n                          </div>`}),f=`<div class="acu-relation-container">${t}</div>`}else if(1===e.length&&e[0].relation){const t=e[0];f=`<div style="display:flex;justify-content:flex-start;align-items:center;gap:8px;">\n                          <span style="color:var(--acu-text-main);">${o(t.name)}${u}</span>\n                          <span style="color:var(--acu-text-sub);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${o(t.relation)}</span>\n                      </div>`}}else if(m.length>1){b=!0;let e='';m.forEach((t,n)=>{const a=!X.isBlacklisted(t.name),i=n<m.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';e+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;${i}">\n                          <span style="color:var(--acu-text-sub);font-size:0.95em;">${o(t.name)}${u}</span>\n                          <div style="display:flex;align-items:center;gap:6px;">\n                              <span style="color:var(--acu-text-main);font-weight:bold;">${t.value}</span>\n                              ${a?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${o(t.name)}" data-attr-value="${t.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>`:''}\n                          </div></div>`}),f=`<div class="acu-multi-attr-container">${e}</div>`}else if(1===m.length){b=!0;const e=m[0],t=!X.isBlacklisted(e.name);f=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                      <span style="color:var(--acu-text-sub);font-size:0.95em;">${o(e.name)}${u}</span>\n                      <div style="display:flex;align-items:center;gap:6px;">\n                          <span style="color:var(--acu-text-main);font-weight:bold;">${e.value}</span>\n                          ${t?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${o(e.name)}" data-attr-value="${e.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="æ£€å®š"></i>`:''}\n                      </div></div>`}else if(!De(r)||r.includes(':')||r.includes('ï¼š')){const e=ft(r);f=e?`<span class="acu-badge ${e}">${o(r)}</span>`:o(r)}else{const e=Pe(r),t=!X.isBlacklisted(i);f=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                      <span>${o(r)}</span>\n                      ${t?`<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${o(i)}" data-attr-value="${e}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;margin-left:6px;" title="æ£€å®š"></i>`:''}\n                  </div>`}g+=`<div class="${'acu-card-row acu-cell'+(b?' acu-hide-label':'')}" data-key="${o(t)}" data-tname="${o(c)}" data-row="${p}" data-col="${n}" data-val="${encodeURIComponent(e??'')}">\n                <div class="acu-card-label">${o(i)}</div>\n                <div class="acu-card-value">${f}</div>\n            </div>`});let f='',b=Be(c);const m=s.findIndex(e=>e&&String(e).includes('äº¤äº’'));if(m>0&&l[m]){const e=String(l[m]).split(/[,ï¼Œã€;ï¼›]/).map(e=>e.trim()).filter(e=>e);e.length>0&&(b=e.map(e=>({label:e,icon:'fa-hand-pointer',type:'prompt',template:`<user>å¯¹{Name}è¿›è¡Œäº¤äº’ï¼š${e}ã€‚`,auto_send:!0})))}if(b.length>0){f=`<div class="acu-card-actions">${b.map((e,t)=>`<button class="acu-action-item ${'check'===e.type?'check-type':''}" data-action-idx="${t}" data-row="${p}"><i class="fa-solid ${e.icon||'fa-play'}"></i> ${o(e.label)}</button>`).join('')}</div>`}const h=`\n            <div class="acu-preview-overlay acu-theme-${d.theme}" style="--acu-card-width:${d.cardWidth}px;--acu-font-size:${d.fontSize}px;">\n                <div class="acu-data-card" style="width:90vw;max-width:420px;max-height:85vh;overflow-y:auto;">\n                    <div class="acu-card-header">\n                        <span class="acu-card-index">#${p+1}</span>\n                        <span class="acu-cell acu-editable-title" data-key="${o(t)}" data-tname="${o(c)}" data-row="${p}" data-col="1" data-val="${encodeURIComponent(u)}">${o(u)}</span>\n                        <button class="acu-preview-close" style="margin-left:auto;background:none;border:none;color:var(--acu-text-sub);cursor:pointer;font-size:16px;padding:4px;"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-card-body view-list">${g}</div>\n                    ${f}\n                </div>\n            </div>\n        `;$('.acu-preview-overlay').remove(),$('body').append(h);const v=$('.acu-preview-overlay')[0];v&&(v.style.setProperty('position','fixed','important'),v.style.setProperty('top','0','important'),v.style.setProperty('left','0','important'),v.style.setProperty('right','0','important'),v.style.setProperty('bottom','0','important'),v.style.setProperty('width','100vw','important'),v.style.setProperty('height','100vh','important'),v.style.setProperty('display','flex','important'),v.style.setProperty('justify-content','center','important'),v.style.setProperty('align-items','center','important'),v.style.setProperty('z-index','2147483650','important')),$('.acu-preview-overlay').on('click',function(e){($(e.target).hasClass('acu-preview-overlay')||$(e.target).closest('.acu-preview-close').length)&&$(this).remove()})}),function(){const e=$(document);let t=0,n=0;e.on('touchstart.acuSwipeFix','#acu-data-area',function(e){1===e.originalEvent.touches.length&&(t=e.originalEvent.touches[0].clientX,n=e.originalEvent.touches[0].clientY)}),e.on('touchmove.acuSwipeFix','#acu-data-area',function(e){if(1!==e.originalEvent.touches.length)return;const a=e.originalEvent.touches[0],i=Math.abs(a.clientX-t);i>1.5*Math.abs(a.clientY-n)&&i>10&&(e.stopPropagation(),console.log('[DICE]ACU é˜»æ­¢æ°´å¹³æ»‘åŠ¨å†’æ³¡ï¼Œé˜²æ­¢ ST swipe'))})}()};const Hn=(e,t)=>{const{$}=ut();$('.acu-cell-menu, .acu-menu-backdrop').remove();const n=$('<div class="acu-menu-backdrop"></div>');$('body').append(n);const i=parseInt($(t).data('row'),10),r=parseInt($(t).data('col'),10);if(isNaN(i)||isNaN(r))return console.warn('[DICE]ACU æ— æ•ˆçš„è¡Œ/åˆ—ç´¢å¼•'),void n.remove();const c=$(t).data('key'),s=$(t).data('tname')||$(t).closest('.acu-data-card').find('.acu-editable-title').text(),l=decodeURIComponent($(t).data('val')),u=an(),p=`${c}-${i}-${r}`;window.acuModifiedSet||(window.acuModifiedSet=new Set);const g=window.acuModifiedSet.has(p),f=(vt()[c]||[]).includes(i),b=Je?.[c]?.content?.[0]||[],m=Je?.[c]?.content?.[i+1]||[],h=a.getRowKey(s,m,b),v=b[r]||'',x=h&&a.isFieldLocked(s,h,v),y=h&&a.hasAnyLock(s,h);let w='';h&&(w='<div style="border-top:1px dashed var(--acu-border); margin:4px 0;"></div>',w+=x?'<div class="acu-cell-menu-item" id="act-unlock-field" style="color:#27ae60;"><i class="fa-solid fa-unlock"></i> è§£é”æ­¤å•å…ƒæ ¼</div>':'<div class="acu-cell-menu-item" id="act-lock-field" style="color:#f39c12;"><i class="fa-solid fa-lock"></i> é”å®šæ­¤å•å…ƒæ ¼</div>',w+=y?'<div class="acu-cell-menu-item" id="act-unlock-row" style="color:#27ae60;"><i class="fa-solid fa-unlock"></i> è§£é”æ•´è¡Œ</div>':'<div class="acu-cell-menu-item" id="act-lock-row" style="color:#f39c12;"><i class="fa-solid fa-lock"></i> é”å®šæ•´è¡Œ</div>');const k=$(`\n            <div class="acu-cell-menu acu-theme-${u.theme}">\n                <div class="acu-cell-menu-item" id="act-edit"><i class="fa-solid fa-pen"></i> ç¼–è¾‘å†…å®¹</div>\n                <div class="acu-cell-menu-item" id="act-edit-card" style="color:#9b59b6"><i class="fa-solid fa-edit"></i> æ•´ä½“ç¼–è¾‘</div>\n                <div class="acu-cell-menu-item" id="act-insert" style="color:#2980b9"><i class="fa-solid fa-plus"></i> åœ¨ä¸‹æ–¹æ’å…¥æ–°è¡Œ</div>\n                <div class="acu-cell-menu-item" id="act-copy"><i class="fa-solid fa-copy"></i> å¤åˆ¶å†…å®¹</div>\n                ${w}\n                ${g?'<div class="acu-cell-menu-item" id="act-undo" style="color:#e67e22; border-top:1px solid #eee;"><i class="fa-solid fa-undo"></i> æ’¤é”€æœ¬æ¬¡ä¿®æ”¹</div>':''}\n                ${f?'<div class="acu-cell-menu-item" id="act-restore" style="color:#27ae60"><i class="fa-solid fa-undo"></i> æ¢å¤æ•´è¡Œ</div>':'<div class="acu-cell-menu-item" id="act-delete" style="color:#e74c3c"><i class="fa-solid fa-trash"></i> åˆ é™¤æ•´è¡Œ</div>'}\n                <div class="acu-cell-menu-item" id="act-close"><i class="fa-solid fa-times"></i> å…³é—­èœå•</div>\n            </div>\n        `);$('body').append(k);const C=$(window).width(),E=$(window).height(),A=k.outerWidth()||150,S=k.outerHeight()||150;let I=e.clientX,T=e.clientY;!I&&e.originalEvent&&e.originalEvent.touches&&e.originalEvent.touches.length?(I=e.originalEvent.touches[0].clientX,T=e.originalEvent.touches[0].clientY):!I&&e.changedTouches&&e.changedTouches.length&&(I=e.changedTouches[0].clientX,T=e.changedTouches[0].clientY),void 0===I&&(I=C/2),void 0===T&&(T=E/2);let F=I+5,M=T+5;F+A>C&&(F=I-A-5),M+S>E&&(M=T-S-5),F<5&&(F=5),M<5&&(M=5),k.css({top:M+'px',left:F+'px'});const B=()=>{k.remove(),n.remove()};n.on('click',B),k.find('#act-close').click(B),k.find('#act-lock-field').click(()=>{h&&v&&(a.lockField(s,h,v,l),Sn()),B()}),k.find('#act-unlock-field').click(()=>{h&&v&&(a.unlockField(s,h,v),Sn()),B()}),k.find('#act-lock-row').click(()=>{h&&(a.lockRow(s,h,m,b),Sn()),B()}),k.find('#act-unlock-row').click(()=>{h&&(a.unlockRow(s,h),Sn()),B()}),k.find('#act-copy').click(async e=>{if(e.stopPropagation(),window.TavernHelper&&window.TavernHelper.triggerSlash)try{const e=l.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\{/g,'\\{').replace(/\}/g,'\\}');return await window.TavernHelper.triggerSlash(`/clipboard-set "${e}"`),void B()}catch(e){console.warn('[DICE]ACU é…’é¦†æ¥å£å¤åˆ¶å¤±è´¥ï¼Œå°è¯•æµè§ˆå™¨åŸç”Ÿæ–¹æ³•',e)}const t=e=>{try{const t=document.createElement('textarea');t.value=e,t.style.position='fixed',t.style.left='-9999px',t.style.top='0',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999);const n=document.execCommand('copy');if(document.body.removeChild(t),!n)throw new Error('execCommand failed')}catch(t){console.error('[DICE]ACU å¤åˆ¶å¤±è´¥:',t),prompt('å¤åˆ¶å¤±è´¥ï¼Œè¯·é•¿æŒ‰ä¸‹æ–¹æ–‡æœ¬æ‰‹åŠ¨å¤åˆ¶:',e)}};var n;n=l,navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).then(()=>{}).catch(()=>{t(n)}):t(n),B()}),k.find('#act-undo').click(()=>{const e=Ct();let n=null;if(e&&e[c]?.content[i+1]&&(n=e[c].content[i+1][r]),null!==n){Je||(Je=ln()),Je&&Je[c]?.content[i+1]&&(Je[c].content[i+1][r]=n);const e=$(t);e.attr('data-val',encodeURIComponent(n)),e.data('val',encodeURIComponent(n));let a=e;e.find('.acu-card-value').length>0?a=e.find('.acu-card-value'):e.hasClass('acu-grid-item')?a=e.find('.acu-grid-value'):e.hasClass('acu-full-item')&&(a=e.find('.acu-full-value'));const o=ft(n);o&&!e.hasClass('acu-editable-title')?a.html(`<span class="acu-badge ${o}">${n}</span>`):a.text(n),a.removeClass('acu-highlight-manual acu-highlight-diff'),e.hasClass('acu-editable-title')&&e.removeClass('acu-highlight-manual acu-highlight-diff'),window.acuModifiedSet.delete(p),0===window.acuModifiedSet.size&&(Ke=!1,pt())}else window.toastr&&window.toastr.warning('æ— æ³•æ‰¾åˆ°åŸå§‹æ•°æ®ï¼Œæ’¤é”€å¤±è´¥');B()}),k.find('#act-delete').click(async()=>{B();let e=bt.get(d);e&&Array.isArray(e)||(e=['acu-btn-save-global','acu-btn-collapse','acu-btn-refresh','acu-btn-settings']);if(!e.includes('acu-btn-save-global')){const e=$(t).closest('.acu-data-card');e.css('transition','all 0.2s ease').css('opacity','0').css('transform','scale(0.9)'),setTimeout(()=>e.slideUp(200,()=>e.remove()),200),Je||(Je=ln()||Ct()),Je&&Je[c]?.content&&(Je[c].content.splice(i+1,1),_t(Je),await dn(Je,!0,!0))}else{const e=vt();e[c]||(e[c]=[]),e[c].includes(i)||(e[c].push(i),xt(e)),$(t).closest('.acu-data-card').addClass('pending-deletion'),pt()}}),k.find('#act-restore').click(()=>{const e=vt();e[c]&&(e[c]=e[c].filter(e=>e!==i),0===e[c].length&&delete e[c],xt(e)),$(t).closest('.acu-data-card').removeClass('pending-deletion'),pt(),B()}),k.find('#act-insert').click(async()=>{if(B(),Je||(Je=ln()),Je||(Je=Ct()),Je&&Je[c]?.content){const e=Je[c],t=e.content[0]?e.content[0].length:2,n=new Array(t).fill('');t>0&&(n[0]=String(e.content.length)),e.content.splice(i+2,0,n),await dn(Je,!1,!0),Sn(),setTimeout(()=>{const e=$('.acu-panel-content');e.length&&e[0].scrollHeight>e.height()&&e.scrollTop(e.scrollTop()+10)},100)}}),k.find('#act-edit-card').click(()=>{B();const e=Je||ln();if(e&&e[c]){const t=e[c].content[0],n=e[c].content[i+1];n&&tn(n,t,s,i,c)}}),k.find('#act-edit').click(()=>{B(),Wn(l,async e=>{if(Je||(Je=ln()||Ct()),!Je||!Je[c]?.content[i+1])return void alert('æ•°æ®ç»“æ„å¼‚å¸¸ï¼Œæ— æ³•å†™å…¥ç¼“å­˜ï¼Œè¯·åˆ·æ–°é¡µé¢');Je[c].content[i+1][r]=e;const n=$(t);n.attr('data-val',encodeURIComponent(e)).data('val',encodeURIComponent(e));let a=n;n.find('.acu-card-value').length?a=n.find('.acu-card-value'):n.hasClass('acu-grid-item')?a=n.find('.acu-grid-value'):n.hasClass('acu-editable-title')&&(a=n);const s=ft(e);s&&!n.hasClass('acu-editable-title')?a.html(`<span class="acu-badge ${s}">${o(e)}</span>`):a.text(e);let l=bt.get(d);l&&Array.isArray(l)||(l=['acu-btn-save-global','acu-btn-collapse','acu-btn-refresh','acu-btn-settings']);!l.includes('acu-btn-save-global')?(a.removeClass('acu-highlight-manual acu-highlight-diff'),n.hasClass('acu-editable-title')&&n.removeClass('acu-highlight-manual acu-highlight-diff'),_t(Je),await dn(Je,!0,!0)):(a.removeClass('acu-highlight-diff').addClass('acu-highlight-manual'),n.hasClass('acu-editable-title')&&n.removeClass('acu-highlight-diff').addClass('acu-highlight-manual'),window.acuModifiedSet||(window.acuModifiedSet=new Set),window.acuModifiedSet.add(p),Ke=!0,pt())})})},Wn=(e,t)=>{const{$}=ut(),n=an(),a=$(`\n            <div class="acu-edit-overlay">\n                \x3c!-- 2. [ä¿®æ”¹] åœ¨è¿™é‡ŒåŠ ä¸Š acu-theme-${n.theme} --\x3e\n                <div class="acu-edit-dialog acu-theme-${n.theme}">\n                    <div class="acu-edit-title">ç¼–è¾‘å•å…ƒæ ¼å†…å®¹</div>\n                    <textarea class="acu-edit-textarea" spellcheck="false">${o(e)}</textarea>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-cancel"><i class="fa-solid fa-times"></i> å–æ¶ˆ</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-save"><i class="fa-solid fa-check"></i> ä¿å­˜</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(a);a.find('textarea').on('input',function(){var e;(e=this).style.height='auto',e.style.height=e.scrollHeight+2+'px'}),a.find('#dlg-cancel').click(()=>a.remove()),a.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&a.remove()}),a.find('#dlg-save').click(()=>{t(a.find('textarea').val()),a.remove()})},Xn=()=>{const{$}=ut();if(!$)return;$('.dice-conflict-dialog-overlay').remove();$('body').append('\n      <div class="dice-conflict-dialog-overlay" style="\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0, 0, 0, 0.75);\n        backdrop-filter: blur(4px);\n        z-index: 2147483647;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 20px;\n        box-sizing: border-box;\n      ">\n        <div class="dice-conflict-dialog" style="\n          background: #fff;\n          border-radius: 16px;\n          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n          max-width: 500px;\n          width: 100%;\n          padding: 30px;\n          box-sizing: border-box;\n          animation: diceDialogPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);\n        ">\n          <div style="\n            text-align: center;\n            margin-bottom: 20px;\n          ">\n            <div style="\n              font-size: 48px;\n              color: #e74c3c;\n              margin-bottom: 15px;\n            ">âš ï¸</div>\n            <h2 style="\n              font-size: 24px;\n              font-weight: bold;\n              color: #333;\n              margin: 0 0 10px 0;\n            ">è„šæœ¬å†²çªæ£€æµ‹</h2>\n            <p style="\n              font-size: 16px;\n              color: #666;\n              line-height: 1.6;\n              margin: 0;\n            ">æ£€æµ‹åˆ°"å¯è§†åŒ–è¡¨æ ¼"è„šæœ¬æ­£åœ¨è¿è¡Œ</p>\n          </div>\n          <div style="\n            background: #fff3cd;\n            border: 1px solid #ffc107;\n            border-radius: 8px;\n            padding: 15px;\n            margin-bottom: 20px;\n          ">\n            <p style="\n              font-size: 14px;\n              color: #856404;\n              line-height: 1.6;\n              margin: 0;\n            ">\n              <strong>æç¤ºï¼š</strong>éª°å­ç³»ç»Ÿä¸å¯è§†åŒ–è¡¨æ ¼è„šæœ¬åŠŸèƒ½å†²çªï¼Œä¸èƒ½åŒæ—¶å¯ç”¨ã€‚<br>\n              è¯·åœ¨é…’é¦†åŠ©æ‰‹çš„è„šæœ¬ç®¡ç†ä¸­ï¼Œ<strong>å…³é—­å…¶ä¸­ä¸€ä¸ªè„šæœ¬ååˆ·æ–°é…’é¦†é¡µé¢</strong>ã€‚\n            </p>\n          </div>\n          <div style="\n            display: flex;\n            gap: 10px;\n            justify-content: center;\n            flex-wrap: wrap;\n          ">\n            <button id="dice-conflict-close" style="\n              background: #6c757d;\n              color: #fff;\n              border: none;\n              border-radius: 8px;\n              padding: 12px 24px;\n              font-size: 16px;\n              font-weight: bold;\n              cursor: pointer;\n              transition: all 0.2s;\n              min-width: 120px;\n            ">æˆ‘çŸ¥é“äº†</button>\n          </div>\n        </div>\n      </div>\n      <style>\n        @keyframes diceDialogPop {\n          from {\n            opacity: 0;\n            transform: translateY(20px) scale(0.95);\n          }\n          to {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n          }\n        }\n        .dice-conflict-dialog button:hover {\n          transform: translateY(-2px);\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n        }\n        .dice-conflict-dialog button:active {\n          transform: translateY(0);\n        }\n        @media (max-width: 768px) {\n          .dice-conflict-dialog {\n            padding: 20px !important;\n            margin: 10px !important;\n            max-width: calc(100% - 20px) !important;\n          }\n          .dice-conflict-dialog h2 {\n            font-size: 20px !important;\n          }\n          .dice-conflict-dialog p {\n            font-size: 14px !important;\n          }\n        }\n      </style>\n    '),$('#dice-conflict-close').on('click',function(){$('.dice-conflict-dialog-overlay').fadeOut(200,function(){$(this).remove()})}),$('.dice-conflict-dialog-overlay').on('click',function(e){$(e.target).hasClass('dice-conflict-dialog-overlay')&&$(this).fadeOut(200,function(){$(this).remove()})}),window.toastr&&window.toastr.error('è„šæœ¬å†²çªï¼šéª°å­ç³»ç»Ÿä¸å¯è§†åŒ–è¡¨æ ¼ä¸èƒ½åŒæ—¶å¯ç”¨','å†²çªæ£€æµ‹',{timeOut:0,extendedTimeOut:0,closeButton:!0,preventDuplicates:!0})},Jn=()=>{if(Ue)return;console.log('[DICE]å¼€å§‹åˆå§‹åŒ–éª°å­ç³»ç»Ÿ...');try{D.restore(),console.info('[DICE]ConsoleCaptureManager çŠ¶æ€å·²æ¢å¤')}catch(e){console.error('[DICE]æ¢å¤ ConsoleCaptureManager çŠ¶æ€å¤±è´¥:',e)}try{P.checkAndRestore(),console.info('[DICE]é”™è¯¯çŠ¶æ€æ£€æŸ¥å®Œæˆ')}catch(e){console.error('[DICE]åˆå§‹åŒ–æ—¶æ£€æŸ¥é”™è¯¯çŠ¶æ€å¤±è´¥:',e)}if((()=>{const{$}=ut();if(!$)return!1;const e=$('.acu-wrapper');if(e.length>0){const t=e.find('.acu-nav-container').length>0,n=e.find('.acu-data-display').length>0;if(e.attr('id'),e.attr('class'),t&&n&&!(e.find('[id*="dice"], [class*="dice"]').length>0))return!0}try{const e=document.querySelectorAll('script');for(const t of e){const e=t.textContent||t.innerHTML||'';if(e.includes('acu_visualizer_ui_v20_pagination')&&e.includes('acu_ui_config_v18'))return!0}}catch(e){}try{const e=localStorage.getItem('acu_ui_config_v18'),t=localStorage.getItem('acu_ui_config_v19');if(e&&!t&&!($('[id*="dice"], [class*="dice"]').length>0))return!0}catch(e){}return!1})())return Xn(),void console.error('[DICE]éª°å­ç³»ç»Ÿ æ£€æµ‹åˆ°å¯è§†åŒ–è¡¨æ ¼è„šæœ¬å†²çªï¼Œå·²é˜»æ­¢åˆå§‹åŒ–');if(console.info('[DICE]æ³¨å…¥ MVU æ ·å¼å’Œè‡ªå®šä¹‰æ ·å¼...'),ue.injectStyles(),We&&(We.disconnect(),We=null,console.info('[DICE]æ¸…ç†æ—§çš„ MutationObserver')),sn(),window.SillyTavern&&window.SillyTavern.eventSource){console.info('[DICE]æ³¨å†Œ SillyTavern äº‹ä»¶ç›‘å¬å™¨...');const e=window.SillyTavern.eventTypes,t=window.SillyTavern.eventSource,n=[e.CHAT_CHANGED,e.MESSAGE_SWIPED,e.MESSAGE_DELETED,e.MESSAGE_UPDATED];Xe||(Xe=()=>{Ye?console.info('[DICE]æ­£åœ¨ç¼–è¾‘é¡ºåºï¼Œè·³è¿‡ç•Œé¢æ¸²æŸ“'):(console.info('[DICE]æ¶ˆæ¯æ›´æ–°äº‹ä»¶è§¦å‘ï¼Œå»¶è¿Ÿæ¸²æŸ“ç•Œé¢'),setTimeout(Sn,500))}),window._acuBoundChatChangeHandler||(window._acuBoundChatChangeHandler=()=>{console.info('[DICE]èŠå¤©åˆ‡æ¢äº‹ä»¶è§¦å‘ï¼Œæ¸…ç†ç¼“å­˜å¹¶é‡æ–°æ¸²æŸ“'),Je=null,Ze={},Qe={},at={},Ke=!1,He.clear(),window.acuModifiedSet&&window.acuModifiedSet.clear(),setTimeout(Sn,500)});const a=window._acuBoundChatChangeHandler;n.forEach(n=>{n&&(t.removeListener(n,Xe),t.removeListener(n,a),n===e.CHAT_CHANGED?t.on(n,a):t.on(n,Xe))}),console.info(`[DICE]å·²æ³¨å†Œ ${n.length} ä¸ªäº‹ä»¶ç›‘å¬å™¨`)}else console.warn('[DICE]SillyTavern äº‹ä»¶æºä¸å¯ç”¨ï¼Œè·³è¿‡äº‹ä»¶ç›‘å¬å™¨æ³¨å†Œ');const e=()=>{const t=ut().getDB();if(t?.exportTableAsJson){Ue=!0,console.log('[DICE]éª°å­ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ'),console.info('[DICE]æ•°æ®åº“ API å·²å°±ç»ª');const e=$('#chat');if(e.length&&!We){console.info('[DICE]å¯åŠ¨èŠå¤©åŒºåŸŸ MutationObserver');let t=!1;We=new MutationObserver(()=>{t||(t=!0,requestAnimationFrame(()=>{if('embedded'===an().positionMode)return void(t=!1);const n=e.children().last()[0],a=$('.acu-wrapper')[0];a&&n&&n!==a&&($(n).hasClass('mes')||$(n).hasClass('message-body'))&&e.append(a);const i=ge();if(i&&i.hideDiceResultInChat){const t=e.children().last();(t.hasClass('mes')||t.hasClass('message-body'))&&t.addClass('acu-dice-result-revealing'),requestAnimationFrame(()=>{be(),requestAnimationFrame(()=>{t.removeClass('acu-dice-result-revealing').addClass('acu-dice-result-revealed'),setTimeout(()=>{t.removeClass('acu-dice-result-revealed')},200)})})}t=!1}))}),We.observe(e[0],{childList:!0})}else e.length||console.warn('[DICE]èŠå¤©åŒºåŸŸ (#chat) æœªæ‰¾åˆ°ï¼Œè·³è¿‡ MutationObserver è®¾ç½®');console.info('[DICE]æ‰§è¡Œé¦–æ¬¡ç•Œé¢æ¸²æŸ“...'),Sn(),setTimeout(()=>{be()},500),t.registerTableUpdateCallback?(t.registerTableUpdateCallback(it.handleUpdate),console.info('[DICE]å·²æ³¨å†Œè¡¨æ ¼æ›´æ–°å›è°ƒ'),t.registerTableFillStartCallback&&(t.registerTableFillStartCallback(()=>{const e=t.exportTableAsJson();e&&_t(e)}),console.info('[DICE]å·²æ³¨å†Œè¡¨æ ¼å¡«å……å¼€å§‹å›è°ƒ'))):console.warn('[DICE]æ•°æ®åº“ API ä¸æ”¯æŒå›è°ƒæ³¨å†Œ')}else Ue||(window._acuInitRetries=(window._acuInitRetries||0)+1,window._acuInitRetries<60?(window._acuInitRetries%10==0&&console.info(`[DICE]ç­‰å¾…æ•°æ®åº“ API å°±ç»ª... (${window._acuInitRetries}/60)`),setTimeout(e,1e3)):console.error('[DICE]æœªæ£€æµ‹åˆ°æ•°æ®åº“åç«¯ APIï¼Œåœæ­¢è½®è¯¢ã€‚è¯·ç¡®ä¿å·²å®‰è£…ç¥Â·æ•°æ®åº“è„šæœ¬ã€‚'))};e();setTimeout(()=>{const{$}=ut(),e=()=>{tt=!1,$('.acu-option-panel, .acu-embedded-options-container').fadeOut(200,function(){$(this).remove()})},t=new Map;let n=0;const a=e=>{const t='string'==typeof e?Number(e):e;return Number.isFinite(t)?t:null},i=e=>{if(!e)return!1;return/ï¼ˆå…ƒå™äº‹ï¼šè¿›è¡Œäº†ä¸€æ¬¡ã€[^ã€‘]+ vs [^ã€‘]+ã€‘çš„å¯¹æŠ—æ£€å®šã€‚.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ï¼›.*?\(ç›®æ ‡\d+\) æ·å‡º \d+ï¼Œåˆ¤å®šä¸ºã€[^ã€‘]+ã€‘ã€‚æœ€ç»ˆç»“æœï¼šã€[^ã€‘]+ã€‘ï¼‰/g.test(e)||/ï¼ˆå…ƒå™äº‹ï¼š[\u4e00-\u9fa5a-zA-Z<>]+å‘èµ·äº†ã€[^ã€‘]+ã€‘æ£€å®šï¼Œæ·å‡º\d+ï¼Œ[^ã€]*ã€[^ã€‘]+ã€‘ï¼‰/g.test(e)},o=(e,t)=>{if(!e||!t)return'';const n=/(<æœ¬è½®ç”¨æˆ·è¾“å…¥>)([\s\S]*?)(<\/æœ¬è½®ç”¨æˆ·è¾“å…¥>)/,a=e.match(n);if(!a)return'';const i=a[2];if(i.includes(t))return'';const o=i.startsWith('\n')?'\n':'',r=i.endsWith('\n')?'\n':'',c=i.trim(),s=c?`${c} ${t}`:t;return(e.includes(t)?e.replace(t,'').trim():e).replace(n,`${a[1]}${o}${s}${r}${a[3]}`)},l=(e,t,a)=>{if(a)return;const r=t&&'object'==typeof t?t:{},c='string'==typeof r.quiet_prompt?r.quiet_prompt:'',s=!0===r.automatic_trigger;if(!0===r._acu_crazy_applied||s)return;if('quiet'===e||c.trim().length>0)return;const l=Date.now();if(l-n<300)return;const d='string'==typeof r.prompt?r.prompt:'';if(!d||!d.trim())return;if(i(d))return;if(!ye())return;const u=_e();if(!u)return;let p='';if(d.includes('<æœ¬è½®ç”¨æˆ·è¾“å…¥>')){const e=o(d,u);p=e&&e!==d?e:`${d.trim()} ${u}`.trim()}else p=`${d.trim()} ${u}`.trim();r.prompt=p,r._acu_crazy_applied=!0,n=l},d=()=>{const e=Date.now();if(e-n<300)return;const{$}=ut(),t=$('#send_textarea'),a=(t.val()||'').toString().trim();if(!a)return;if(i(a))return;if(!ye())return;const o=_e();if(!o)return;r(o,'dice');const c=(t.val()||'').toString();if(c){const e=t[0];e.value=c,e.dispatchEvent(new Event('input',{bubbles:!0})),e.dispatchEvent(new Event('change',{bubbles:!0}))}n=e},u=e=>{const n=a(e);if(null===n)return;if(!ye())return;const i=_e();i&&(t.set(n,{result:i,createdAt:Date.now()}),p(n))},p=async e=>{const n=a(e);if(null===n)return;const r=t.get(n);if(!r)return;if(Date.now()-r.createdAt>12e3)return void t.delete(n);const c=b?.chat||window.parent?.SillyTavern?.chat,s=c&&'number'==typeof n?c[n]:null,l=getChatMessages(n)[0];if(!(l&&'user'===l.role||s&&s.is_user))return void t.delete(n);const d=String(s?.mes??l?.message??'');if(i(d))return void t.delete(n);const u=l?.extra||s?.extra||{};if(u.acuCrazyModeApplied)return void t.delete(n);let p='';if(d.includes('<æœ¬è½®ç”¨æˆ·è¾“å…¥>')){const e=o(d,r.result);p=e&&e!==d?e:`${d} ${r.result}`.trim()}else p=d?`${d} ${r.result}`:r.result;t.delete(n),s&&s.is_user&&(s.mes=p);try{await setChatMessages([{message_id:n,message:p,extra:{...u,acuCrazyModeApplied:!0}}],{refresh:'affected'})}catch(e){console.warn('[DICE]ç–¯ç‹‚æ¨¡å¼: é™„åŠ éª°å­ç»“æœå¤±è´¥',e)}const{$}=ut(),g=$('#send_textarea');if(g.length){(g.val()||'').toString()===p&&g.val('').trigger('input').trigger('change')}},g=()=>{s();const e=document.getElementById('send_but');if(e){const t=()=>{d(),c()};e.addEventListener('click',t,!0),e.addEventListener('pointerup',t,!0),e.addEventListener('touchend',t,!0)}$(document).off('click.acu_restore_dice','#send_but').on('click.acu_restore_dice','#send_but',function(e){d(),c()});const t=document.getElementById('send_textarea');t&&(t.addEventListener('keydown',function(e){'Enter'!==e.key&&'NumpadEnter'!==e.key||(d(),c())},!0),t.addEventListener('keyup',function(e){'Enter'!==e.key&&'NumpadEnter'!==e.key||(d(),c())},!0)),$('#send_textarea').off('keydown.acu_restore_dice').on('keydown.acu_restore_dice',function(e){'Enter'!==e.key&&'NumpadEnter'!==e.key||(d(),c())}).off('keyup.acu_restore_dice').on('keyup.acu_restore_dice',function(e){'Enter'!==e.key&&'NumpadEnter'!==e.key||(d(),c())});new MutationObserver(()=>{const e=$('#send_textarea');e.length&&!e[0]._acuValueIntercepted&&s()}).observe(document.body,{childList:!0,subtree:!0})},f=()=>{const e=window;e.__acuCrazyGenerateHookInstalled||e.TavernHelper&&'function'==typeof e.TavernHelper.generate&&(e.__acuCrazyGenerateOriginal=e.TavernHelper.generate,e.TavernHelper.generate=async function(...t){const a=t.length>0&&t[0]&&'object'==typeof t[0]?t[0]:null;if(a){const e='string'==typeof a.quiet_prompt?a.quiet_prompt:'',t=!0===a.automatic_trigger;if(!(!0===a._acu_crazy_applied)&&!t&&0===e.trim().length){let e='';const t=a.injects;if(Array.isArray(t)&&t.length>0){const n=t[0];if(n&&'object'==typeof n){const t=n.content;'string'==typeof t&&(e=t)}}if(e||'string'!=typeof a.prompt||(e=a.prompt),e||'string'!=typeof a.user_input||(e=a.user_input),e&&!i(e)&&ye()){const i=_e();if(i){const o=`${e.trim()} ${i}`.trim();if(Array.isArray(t)&&t.length>0){const e=t[0];e&&'object'==typeof e&&(e.content=o)}else'string'==typeof a.prompt?a.prompt=o:a.user_input=o;a._acu_crazy_applied=!0,n=Date.now(),console.info('[DICE]ç–¯ç‹‚æ¨¡å¼: å·²æ³¨å…¥åˆ°ç”Ÿæˆè¯·æ±‚')}}}}return e.__acuCrazyGenerateOriginal.apply(this,t)},e.__acuCrazyGenerateHookInstalled=!0)},b=window.SillyTavern||window.parent?.SillyTavern,m=b?.eventTypes?.MESSAGE_SENT||(window.tavern_events?window.tavern_events.MESSAGE_SENT:'message_sent');if(b?.eventSource){b.eventSource.on(m,e),b.eventSource.on(m,e=>{u(e);const t=ge();t&&t.hideDiceResultInChat&&setTimeout(()=>{be()},300)});const t=b?.eventTypes?.GENERATION_AFTER_COMMANDS||(window.tavern_events?window.tavern_events.GENERATION_AFTER_COMMANDS:'GENERATION_AFTER_COMMANDS');return t&&b.eventSource.on(t,(e,t,n)=>{l(e,t,n)}),f(),void g()}if('function'==typeof window.eventOn){window.eventOn(m,e),window.eventOn(m,e=>{u(e);const t=ge();t&&t.hideDiceResultInChat&&setTimeout(()=>{be()},300)});const t=window.tavern_events?window.tavern_events.GENERATION_AFTER_COMMANDS:'GENERATION_AFTER_COMMANDS';return window.eventOn(t,(e,t,n)=>{l(e,t,n)}),f(),void g()}},2e3),setTimeout(()=>{s()},500);const t=window.eventOn||window.parent?.eventOn;'function'==typeof t?t('era:writeDone',e=>{'object'==typeof ue&&'function'==typeof ue.clearCache&&ue.clearCache();'era'===ue.detectMode()&&mt()===ue.MODULE_ID&&(console.log('[DICE]ERAå˜é‡å·²æ›´æ–°ï¼Œè‡ªåŠ¨åˆ·æ–°é¢æ¿'),Sn())}):console.warn('[DICE]æ— æ³•ç›‘å¬ ERA äº‹ä»¶ï¼ŒeventOn ä¸å¯ç”¨'),$(window).off('beforeunload.acu pagehide.acu').on('beforeunload.acu pagehide.acu',()=>{try{localStorage.setItem(nt,JSON.stringify(at)),We&&(We.disconnect(),We=null)}catch(e){}})};window.testPairedTableFix=function(){const e='AM',t='ç¼–ç ç´¢å¼•',n={name:'æ€»ç»“è¡¨',content:[['ç¼–ç ç´¢å¼•','æ—¶é—´è·¨åº¦','çºªè¦'],['AM0001','æ—¶é—´1','çºªè¦1'],['AM0002','æ—¶é—´2','çºªè¦2'],[null,'æ—¶é—´3-é”™è¯¯è¡Œ','çºªè¦3-é”™è¯¯è¡Œ'],['AM0030','æ—¶é—´4','çºªè¦4'],[null,'æ—¶é—´5-é”™è¯¯è¡Œ','çºªè¦5-é”™è¯¯è¡Œ']]},a={name:'æ€»ä½“å¤§çº²',content:[['ç¼–ç ç´¢å¼•','æ—¶é—´è·¨åº¦','å¤§çº²'],[null,'æ—¶é—´A-é”™è¯¯è¡Œ','å¤§çº²A-é”™è¯¯è¡Œ'],['AM0002','æ—¶é—´B','å¤§çº²B'],['AM0030','æ—¶é—´C','å¤§çº²C'],['AM0040','æ—¶é—´D','å¤§çº²D'],['AM0050','æ—¶é—´E','å¤§çº²E']]},i=mn(n,t,e),o=mn(a,t,e),r=vn(n,0,a,0,t,hn(i.allCodes,o.allCodes,e,1),e),c=t=>t.content.slice(1).map(e=>e[0]).filter(t=>t&&String(t).match(new RegExp(`^${e}\\d+$`))),s=c(n),l=c(a),d=n.content.slice(1).filter(t=>!t[0]||!String(t[0]).match(new RegExp(`^${e}\\d+$`))),u=a.content.slice(1).filter(t=>!t[0]||!String(t[0]).match(new RegExp(`^${e}\\d+$`))),p=(e,t,n)=>{const a=e.map(e=>{if(!e)return null;const n=e.match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));return n?parseInt(n[1],10):null}).filter(e=>null!==e);for(let e=0;e<a.length;e++)if(a[e]!==n+e)return!1;return!0},g=p(s,e,1),f=p(l,e,1),b=new Set(s),m=new Set(l),h=b.size===m.size&&[...b].every(e=>m.has(e)),v=d.some(e=>e[1]&&e[1].includes('é”™è¯¯è¡Œ')),x=u.some(e=>e[1]&&e[1].includes('é”™è¯¯è¡Œ'));return{table1Sheet:n,table2Sheet:a,result:r,codes1:s,codes2:l,emptyRows1:d,emptyRows2:u,isValid1:g,isValid2:f,setsEqual:h,emptyRowsPreserved1:v,emptyRowsPreserved2:x,isValid:g&&f&&h&&v&&x}},window.diagnoseDiceVariables=async function(){return void 0!==ue&&'function'==typeof ue.diagnoseVariableFramework?await ue.diagnoseVariableFramework():(console.error('[DICE]MvuModule æœªåˆå§‹åŒ–æˆ–è¯Šæ–­å·¥å…·ä¸å¯ç”¨'),null)};const{$}=ut();$?$(document).ready(Jn):window.addEventListener('load',Jn)}();
//# sourceMappingURL=stable.js.map