!function(){const e='acu_visualizer_ui_v19_6_ai_overlay',t={STORAGE_KEY_PREFIX:'acu_locked_fields_v2_',MAX_CONTEXTS:20,PRIMARY_KEYS:{全局数据表:null,世界地图点:'详细地点',地图元素表:'元素名称',主角信息:'姓名',重要人物表:'姓名',技能表:'技能名称',物品表:'物品名称',装备表:'装备名称',任务表:'名称',总结表:'编码索引',总体大纲:'编码索引',重要情报:'情报名称',势力:'名称'},_cache:null,_currentContextId:null,_getStorageKey(e){return this.STORAGE_KEY_PREFIX+(e||Ae())},_cleanupOldContexts(){try{const e=this.STORAGE_KEY_PREFIX,t=[];for(let a=0;a<localStorage.length;a++){const n=localStorage.key(a);n&&n.startsWith(e)&&t.push(n)}if(t.length<=this.MAX_CONTEXTS)return;const a=t.map(e=>{try{const t=JSON.parse(localStorage.getItem(e));return{key:e,time:t?._lastAccess||0}}catch{return{key:e,time:0}}});a.sort((e,t)=>t.time-e.time);const n=a.slice(this.MAX_CONTEXTS);n.forEach(e=>{localStorage.removeItem(e.key)}),n.length>0&&console.log(`[LockManager] 清理了 ${n.length} 个过期的锁定数据`)}catch(e){console.warn('[LockManager] 清理失败',e)}},_load(){const e=Ae();if(this._currentContextId!==e&&(this._cache=null,this._currentContextId=e),!this._cache)try{const e=localStorage.getItem(this._getStorageKey());this._cache=e?JSON.parse(e):{},delete this._cache._lastAccess}catch(e){this._cache={}}return this._cache},_save(){try{const e={...this._cache,_lastAccess:Date.now()};localStorage.setItem(this._getStorageKey(),JSON.stringify(e)),this._cleanupOldContexts()}catch(e){console.warn('[LockManager] 保存失败',e)}},getRowKey(e,t,a){const n=this.PRIMARY_KEYS[e];if(null===n)return'_row_0';let i=1;if(n){const e=a.indexOf(n);-1!==e&&(i=e)}return t[i]?`${n||a[i]}=${t[i]}`:null},lockField(e,t,a,n){const i=this._load();i[e]||(i[e]={}),i[e][t]||(i[e][t]={_fullRow:!1,_fields:{},_snapshot:null}),i[e][t]._fields[a]=n,this._save()},lockRow(e,t,a,n){const i=this._load();i[e]||(i[e]={});const o={};n.forEach((e,t)=>{e&&null!=a[t]&&''!==a[t]&&(o[e]=a[t])}),i[e][t]={_fullRow:!0,_fields:{},_snapshot:o},this._save()},unlockField(e,t,a){const n=this._load(),i=n[e]?.[t];i&&(delete i._fields[a],i._fullRow||0!==Object.keys(i._fields).length||(delete n[e][t],0===Object.keys(n[e]).length&&delete n[e]),this._save())},unlockRow(e,t){const a=this._load();a[e]&&(delete a[e][t],0===Object.keys(a[e]).length&&delete a[e],this._save())},isFieldLocked(e,t,a){const n=this._load()[e]?.[t];return!!n&&(n._fullRow?n._snapshot?.hasOwnProperty(a):n._fields?.hasOwnProperty(a))},isRowLocked(e,t){return!0===this._load()[e]?.[t]?._fullRow},applyLocks(e,t){const a=this._load()[e];if(!a||!t||t.length<2)return{modified:!1,restored:[]};const n=t[0],i=[];let o=!1;const r={};for(let a=1;a<t.length;a++){const i=this.getRowKey(e,t[a],n);i&&(r[i]=a)}for(const[e,c]of Object.entries(a)){const a=r[e];if(void 0===a){const a=this._rebuildRow(n,c);a&&(t.push(a),i.push(e),o=!0);continue}const s=t[a],l=c._fullRow?c._snapshot:c._fields;if(l)for(const[e,t]of Object.entries(l)){const a=n.indexOf(e);-1!==a&&s[a]!==t&&(s[a]=t,o=!0)}}return{modified:o,restored:i}},_rebuildRow(e,t){const a=t._fullRow?t._snapshot:t._fields;if(!a||0===Object.keys(a).length)return null;const n=new Array(e.length).fill(null);for(const[t,i]of Object.entries(a)){const a=e.indexOf(t);-1!==a&&(n[a]=i)}return n},getLockedFields(e,t){const a=this._load()[e]?.[t];return a?a._fullRow?Object.keys(a._snapshot||{}):Object.keys(a._fields||{}):[]},clearCurrentContext(){localStorage.removeItem(this._getStorageKey()),this._cache=null}},a={STORAGE_KEY_PREFIX:'acu_bookmarks_v1_',MAX_CONTEXTS:20,_cache:null,_currentContextId:null,_getStorageKey(e){return this.STORAGE_KEY_PREFIX+(e||Ae())},_cleanupOldContexts(){try{const e=this.STORAGE_KEY_PREFIX,t=[];for(let a=0;a<localStorage.length;a++){const n=localStorage.key(a);n&&n.startsWith(e)&&t.push(n)}if(t.length<=this.MAX_CONTEXTS)return;const a=t.map(e=>{try{const t=JSON.parse(localStorage.getItem(e));return{key:e,time:t?._lastAccess||0}}catch{return{key:e,time:0}}});a.sort((e,t)=>t.time-e.time);const n=a.slice(this.MAX_CONTEXTS);n.forEach(e=>{localStorage.removeItem(e.key)}),n.length>0&&console.log(`[BookmarkManager] 清理了 ${n.length} 个过期的bookmark数据（当前保留 ${this.MAX_CONTEXTS} 个聊天的数据，清理前共有 ${t.length} 个）`)}catch(e){console.warn('[BookmarkManager] 清理失败',e)}},_load(){const e=Ae();if(this._currentContextId!==e&&(this._cache=null,this._currentContextId=e),!this._cache)try{const e=localStorage.getItem(this._getStorageKey());this._cache=e?JSON.parse(e):{},delete this._cache._lastAccess}catch(e){this._cache={}}return this._cache},_save(){try{const e={...this._cache,_lastAccess:Date.now()};localStorage.setItem(this._getStorageKey(),JSON.stringify(e)),this._cleanupOldContexts()}catch(e){console.warn('[BookmarkManager] 保存失败',e)}},isBookmarked(e,t){const a=this._load();return!(!a[e]||!a[e][t])},toggleBookmark(e,t){const a=this._load();a[e]||(a[e]={}),a[e][t]?(delete a[e][t],0===Object.keys(a[e]).length&&delete a[e]):a[e][t]=!0,this._save()},getBookmarks(e){const t=this._load();return t[e]?Object.keys(t[e]):[]},clearCurrentContext(){localStorage.removeItem(this._getStorageKey()),this._cache=null}},n=e=>String(e??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),i=(e,t)=>{const{$}=Pe(),a=$('#send_textarea');if(!a.length)return;const n=(a.val()||'').trim(),i=/[\u4e00-\u9fa5a-zA-Z<>]+发起了【[^】]+】检定，掷出\d+，[^【]*【[^】]+】/g,o=/进行了一次【[^】]+ vs [^】]+】的对抗检定。.*?\(目标\d+\) 掷出 \d+，判定为【[^】]+】；.*?\(目标\d+\) 掷出 \d+，判定为【[^】]+】。最终结果：【[^】]+】/g,r=/<user>(?:(?!<user>).)*?[。！？]/g,c=/\[投骰结果已隐藏\]/g,s=q();let l=e,d=!1;if('dice'===t&&s.hideDiceResultFromUser&&(l='[投骰结果已隐藏]',d=!0),!n)return a.val(l).trigger('input').trigger('change'),void('dice'===t&&a.data('acu-original-dice-text',e));let u=n,p='',g='',f='';if(c.test(u)){const e=a.data('acu-original-dice-text')||'';e?(u=u.replace(c,e),g=e,f=e):u=u.replace(c,'').trim()}const b=u.match(o);b&&b.length>0&&(g=b[b.length-1],f=g,u=u.replace(o,'\0').trim(),console.log('[ACU SmartInsert] Found and extracted contest roll:',g));const m=u.match(i);m&&m.length>0&&(g=m[m.length-1],f=g,u=u.replace(i,'\0').trim(),console.log('[ACU SmartInsert] Found and extracted normal roll:',g));const h=u.match(r);h&&h.length>0&&(p=h[h.length-1],u=u.replace(r,'').trim(),console.log('[ACU SmartInsert] Found and extracted action:',p));let v=u.replace(/[\u0000\u0001]/g,' ').replace(/\s+/g,' ').trim();'dice'===t?(g=l,f=e,a.data('acu-original-dice-text',e)):'action'===t&&(p=e);const x=[];v&&x.push(v),p&&x.push(p),g&&x.push(g);const y=x.join(' ');a.val(y).trigger('input').trigger('change')},o=()=>{const{$}=Pe(),e=$('#send_textarea');if(!e.length)return;const t=e.val()||'',a=e.data('acu-original-dice-text');if(t.includes('[投骰结果已隐藏]')&&a){const n=t.replace(/\[投骰结果已隐藏\]/g,a);e.val(n),e.removeData('acu-original-dice-text')}},r=()=>{const{$}=Pe(),e=$('#send_textarea');if(!e.length)return;const t=e[0];if(!t||t._acuValueIntercepted)return;t._acuValueIntercepted=!0;const a=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,'value'),n=t.value;Object.defineProperty(t,'value',{get:function(){let e;e=a&&a.get?a.get.call(this):this._value||n||'';const t=$(this).data('acu-original-dice-text');return e&&'string'==typeof e&&e.includes('[投骰结果已隐藏]')&&t?e.replace(/\[投骰结果已隐藏\]/g,t):e},set:function(e){a&&a.set?a.set.call(this,e):this._value=e},configurable:!0})},c='acu_table_order',s='acu_action_order',l='acu_pending_deletions',d='acu_active_tab',u='acu_ui_config_v19',p='acu_data_snapshot_v19',g='acu_ui_collapsed_state',f='acu_dashboard_active',b='acu_table_heights_v19',m='acu_table_styles_v19',h='acu_hidden_tables_v19',v='acu_reverse_tables_v1',x=200,y=1200,w='acu_dice_config_v1',k='acu_attribute_presets_v1',C='acu_active_attr_preset_v1',S='acu_avatar_map_v1',T='acu_validation_enabled_v1',A='acu_validation_mode',I={tableReadonly:{name:'表级只读',scope:'table',icon:'fa-lock',desc:'禁止修改整个表'},rowLimit:{name:'行数限制',scope:'table',icon:'fa-arrows-up-down',desc:'限制表的行数范围'},sequence:{name:'序列递增',scope:'table',icon:'fa-sort-numeric-up',desc:'检查字段值是否严格递增'},required:{name:'必填',scope:'field',icon:'fa-asterisk',desc:'字段不能为空'},format:{name:'格式验证',scope:'field',icon:'fa-font',desc:'正则表达式匹配'},enum:{name:'枚举验证',scope:'field',icon:'fa-list',desc:'值必须在列表中'},numeric:{name:'数值范围',scope:'field',icon:'fa-hashtag',desc:'数值必须在范围内'},relation:{name:'关联验证',scope:'field',icon:'fa-link',desc:'引用其他表的值'},keyValue:{name:'键值对验证',scope:'field',icon:'fa-key',desc:'验证键值对格式和数值范围'}},M=[{id:'summary_code_sequence',name:'总结表编码递增',description:'编码索引必须从AM001开始严格递增，不可跳号或重复',enabled:!0,builtin:!0,intercept:!1,targetTable:'总结表',targetColumn:'编码索引',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'编码索引必须从AM001开始严格递增，发现跳号或重复'},{id:'outline_code_sequence',name:'总体大纲编码递增',description:'编码索引必须从AM001开始严格递增，不可跳号或重复',enabled:!0,builtin:!0,intercept:!1,targetTable:'总体大纲',targetColumn:'编码索引',ruleType:'sequence',config:{prefix:'AM',startFrom:1},errorMessage:'编码索引必须从AM001开始严格递增，发现跳号或重复'},{id:'summary_code_required',name:'总结表编码索引必填',description:'编码索引不能为空',enabled:!0,builtin:!0,intercept:!1,targetTable:'总结表',targetColumn:'编码索引',ruleType:'required',config:{},errorMessage:'编码索引不能为空'},{id:'outline_code_required',name:'总体大纲编码索引必填',description:'编码索引不能为空',enabled:!0,builtin:!0,intercept:!1,targetTable:'总体大纲',targetColumn:'编码索引',ruleType:'required',config:{},errorMessage:'编码索引不能为空'},{id:'quest_status_enum',name:'任务表状态',description:'任务状态必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'状态',ruleType:'enum',config:{values:['进行中','已完成','已失败','已放弃']},errorMessage:'状态必须为：进行中、已完成、已失败、已放弃'},{id:'quest_type_enum',name:'任务表类型',description:'任务类型必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'类型',ruleType:'enum',config:{values:['主线','支线','日常']},errorMessage:'类型必须为：主线、支线、日常'},{id:'quest_priority_enum',name:'任务表优先级',description:'任务优先级必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'优先级',ruleType:'enum',config:{values:['紧急','重要','普通']},errorMessage:'优先级必须为：紧急、重要、普通'},{id:'equip_status_enum',name:'装备表状态',description:'装备状态必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'装备表',targetColumn:'状态',ruleType:'enum',config:{values:['已装备','闲置']},errorMessage:'状态必须为：已装备、闲置'},{id:'equip_quality_enum',name:'装备表品质',description:'装备品质必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'装备表',targetColumn:'品质',ruleType:'enum',config:{values:['普通','优秀','稀有','史诗','传说','神话']},errorMessage:'品质必须为：普通、优秀、稀有、史诗、传说、神话'},{id:'item_quality_enum',name:'物品表品质',description:'物品品质必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'物品表',targetColumn:'品质',ruleType:'enum',config:{values:['普通','优秀','稀有','史诗','传说','神话']},errorMessage:'品质必须为：普通、优秀、稀有、史诗、传说、神话'},{id:'skill_type_enum',name:'技能表类型',description:'技能类型必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'技能表',targetColumn:'类型',ruleType:'enum',config:{values:['主动','被动','特质']},errorMessage:'类型必须为：主动、被动、特质'},{id:'skill_quality_enum',name:'技能表品质',description:'技能品质必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'技能表',targetColumn:'品质',ruleType:'enum',config:{values:['普通','优秀','稀有','史诗','传说','神话']},errorMessage:'品质必须为：普通、优秀、稀有、史诗、传说、神话'},{id:'skill_proficiency_range',name:'技能熟练度范围',description:'技能熟练度必须在 0-100 之间',enabled:!0,builtin:!0,intercept:!1,targetTable:'技能表',targetColumn:'熟练度',ruleType:'numeric',config:{min:0,max:100},errorMessage:'熟练度必须在 0-100 之间'},{id:'npc_presence_enum',name:'重要人物在场状态',description:'在场状态必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'在场状态',ruleType:'enum',config:{values:['在场','离场']},errorMessage:'在场状态必须为：在场、离场'},{id:'map_explore_enum',name:'地图点探索状态',description:'探索状态必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'世界地图点',targetColumn:'探索状态',ruleType:'enum',config:{values:['未探索','部分探索','已探索']},errorMessage:'探索状态必须为：未探索、部分探索、已探索'},{id:'map_importance_enum',name:'地图点重要度',description:'重要度必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'世界地图点',targetColumn:'重要度',ruleType:'enum',config:{values:['核心','重要','普通']},errorMessage:'重要度必须为：核心、重要、普通'},{id:'intel_importance_enum',name:'情报重要度',description:'重要度必须为指定值之一',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要情报',targetColumn:'重要度',ruleType:'enum',config:{values:['核心','重要','普通']},errorMessage:'重要度必须为：核心、重要、普通'},{id:'player_location_relation',name:'主角地点关联',description:'主角所在地点必须存在于世界地图点表',enabled:!0,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'所在地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'所在地点必须是世界地图点表中已存在的详细地点'},{id:'npc_location_relation',name:'NPC地点关联',description:'NPC所在地点必须存在于世界地图点表',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'所在地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'所在地点必须是世界地图点表中已存在的详细地点'},{id:'element_location_relation',name:'元素地点关联',description:'元素所在地点必须存在于世界地图点表的详细地点',enabled:!0,builtin:!0,intercept:!1,targetTable:'地图元素表',targetColumn:'所在地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'所在地点必须是世界地图点表中已存在的详细地点'},{id:'global_detail_location_relation',name:'全局详细地点关联',description:'当前详细地点必须存在于世界地图点表',enabled:!0,builtin:!0,intercept:!1,targetTable:'全局数据表',targetColumn:'当前详细地点',ruleType:'relation',config:{refTable:'世界地图点',refColumn:'详细地点'},errorMessage:'当前详细地点必须是世界地图点表中已存在的详细地点'},{id:'player_base_attributes_keyvalue',name:'主角基本属性',description:'基本属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'基础属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'基础属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'player_special_attributes_keyvalue',name:'主角特有属性',description:'特有属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'特有属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'特有属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'player_relationships_keyvalue',name:'主角人际关系',description:'人际关系必须为键值对格式',enabled:!0,builtin:!0,intercept:!1,targetTable:'主角信息',targetColumn:'人际关系',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'人际关系格式必须为"角色名:关系词;角色名:关系词"'},{id:'npc_base_attributes_keyvalue',name:'NPC基本属性',description:'基本属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'基础属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'基础属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'npc_special_attributes_keyvalue',name:'NPC特有属性',description:'特有属性必须为键值对格式，数值范围[0,100]',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'特有属性',ruleType:'keyValue',config:{valueType:'numeric',valueMin:0,valueMax:100},errorMessage:'特有属性格式必须为"属性名:数值;属性名:数值"，数值范围[0,100]'},{id:'npc_relationships_keyvalue',name:'NPC人际关系',description:'人际关系必须为键值对格式',enabled:!0,builtin:!0,intercept:!1,targetTable:'重要人物表',targetColumn:'人际关系',ruleType:'keyValue',config:{valueType:'text'},errorMessage:'人际关系格式必须为"角色名:关系词;角色名:关系词"'},{id:'quest_progress_format',name:'任务进度格式',description:'进度必须为数字+%格式，如50%',enabled:!0,builtin:!0,intercept:!1,targetTable:'任务表',targetColumn:'进度',ruleType:'format',config:{pattern:'^\\d+%$'},errorMessage:'进度必须为数字+%格式（如50%、100%）'}],B='acu_validation_presets_v1',E='acu_active_preset_id',P={_cache:null,getAllPresets(){if(this._cache)return this._cache;const e=Fe.get(B,null);return e?(this._cache=e,e):(this._initDefaultPreset(),this._cache)},getActivePreset(){const e=this.getAllPresets(),t=Fe.get(E,'default');return e.find(e=>e.id===t)||e[0]},setActivePreset(e){return!!this.getAllPresets().find(t=>t.id===e)&&(Fe.set(E,e),N.clearCache(),console.log('[PresetManager] 切换预设:',e),!0)},createPreset(e){const t=this.getAllPresets(),a={id:'preset_'+Date.now(),name:e||'新预设',builtin:!1,rules:[],createdAt:(new Date).toISOString()};return t.push(a),this._save(t),a},duplicatePreset(e){const t=this.getAllPresets().find(t=>t.id===e);if(!t)return null;const a=this.getAllPresets(),n={id:'preset_'+Date.now(),name:t.name+' (副本)',builtin:!1,rules:JSON.parse(JSON.stringify(t.rules)),createdAt:(new Date).toISOString()};return a.push(n),this._save(a),console.log('[PresetManager] 复制预设:',t.name,'->',n.name),n},deletePreset(e){const t=this.getAllPresets(),a=t.find(t=>t.id===e);if(!a||'default'===a.id)return!1;const n=t.filter(t=>t.id!==e);return this._save(n),Fe.get(E)===e&&(Fe.set(E,'default'),N.clearCache()),console.log('[PresetManager] 删除预设:',e),!0},updatePresetRules(e,t){const a=this.getAllPresets(),n=a.find(t=>t.id===e);return!!n&&(n.rules=t,this._save(a),N.clearCache(),!0)},exportPreset(e){const t=this.getAllPresets().find(t=>t.id===e);return t?JSON.stringify({format:'acu_preset_v1',preset:{name:t.name,rules:t.rules}},null,2):null},importPreset(e){try{const t=JSON.parse(e);if('acu_preset_v1'!==t.format||!t.preset)return null;const a=this.getAllPresets(),n={id:'imported_'+Date.now(),name:t.preset.name||'导入的预设',builtin:!1,rules:t.preset.rules||[],createdAt:(new Date).toISOString()};return a.push(n),this._save(a),console.log('[PresetManager] 导入预设:',n.name),n}catch(e){return console.error('[PresetManager] 导入失败:',e),null}},_getBuiltinRulesVersion(){try{const e=JSON.stringify(M);let t=0;for(let a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return t.toString(36)}catch(e){return console.error('[PresetManager] 计算版本失败:',e),'0'}},_initDefaultPreset(){const e=this._getBuiltinRulesVersion(),t=Fe.get(B,null);if(t&&Array.isArray(t)){const a=t.find(e=>'default'===e.id);if(a&&a._builtinVersion!==e){console.log('[PresetManager] 检测到内置规则更新，自动更新默认预设');const n=a.rules.filter(e=>!e.builtin);return a.rules=[...M.map(e=>({...e})),...n],a._builtinVersion=e,this._cache=t,this._save(t),void Fe.set(E,'default')}}const a={id:'default',name:'默认预设',builtin:!0,rules:M.map(e=>({...e})),_builtinVersion:e,createdAt:(new Date).toISOString()},n=Fe.get('acu_validation_rules_v1',[]);n.length>0&&(a.rules.push(...n.map(e=>({...e,builtin:!1}))),console.log('[PresetManager] 迁移旧规则:',n.length,'条')),this._cache=[a],this._save(this._cache),Fe.set(E,'default')},resetDefaultPreset(){const e=this.getAllPresets(),t=e.find(e=>'default'===e.id);if(t){const a=t.rules.filter(e=>!e.builtin);return t.rules=[...M.map(e=>({...e})),...a],t._builtinVersion=this._getBuiltinRulesVersion(),this._save(e),N.clearCache(),console.log('[PresetManager] 默认预设已恢复'),!0}return!1},_save(e){Fe.set(B,e),this._cache=e},clearCache(){this._cache=null}},N={_cache:null,_enabledCache:null,getAllRules(){if(this._cache)return this._cache;const e=P.getActivePreset(),t=this.getEnabledStates(),a=(e?.rules||[]).map(e=>({...e,enabled:void 0!==t[e.id]?t[e.id]:e.enabled}));return this._cache=a,a},getEnabledStates(){return this._enabledCache||(this._enabledCache=Fe.get(T,{})),this._enabledCache},toggleRuleEnabled(e,t){const a=this.getEnabledStates();a[e]=t,Fe.set(T,a),this._enabledCache=a,this._cache=null,console.log(`[ValidationRuleManager] 规则 ${e} 已${t?'启用':'禁用'}`)},toggleRuleIntercept(e,t){const a=P.getActivePreset();if(!a)return!1;const n=a.rules.find(t=>t.id===e);return!!n&&(n.intercept=t,P.updatePresetRules(a.id,a.rules),console.log(`[ValidationRuleManager] 规则 ${e} 拦截已${t?'启用':'关闭'}`),!0)},getEnabledRules(){return this.getAllRules().filter(e=>e.enabled)},addCustomRule(e){if(!e.id||!e.name||!e.targetTable)return console.error('[ValidationRuleManager] 规则缺少必要字段'),!1;const t=P.getActivePreset();if(!t)return!1;if(t.rules.some(t=>t.id===e.id))return console.error('[ValidationRuleManager] 规则 ID 已存在:',e.id),!1;const a={...e,builtin:!1,enabled:!0};return t.rules.push(a),P.updatePresetRules(t.id,t.rules),console.log('[ValidationRuleManager] 添加规则:',a.name),!0},removeCustomRule(e){const t=P.getActivePreset();if(!t)return!1;const a=t.rules.findIndex(t=>t.id===e);if(-1===a)return!1;t.rules.splice(a,1),P.updatePresetRules(t.id,t.rules);const n=this.getEnabledStates();return delete n[e],Fe.set(T,n),this._enabledCache=n,console.log('[ValidationRuleManager] 删除规则:',e),!0},updateCustomRule(e,t){const a=P.getActivePreset();if(!a)return!1;const n=a.rules.findIndex(t=>t.id===e);return-1!==n&&(a.rules[n]={...a.rules[n],...t,id:e},P.updatePresetRules(a.id,a.rules),!0)},clearCache(){this._cache=null,this._enabledCache=null},getRulesByTable(e){return this.getEnabledRules().filter(t=>t.targetTable===e)}},D={validateFormat(e,t){if(null==e||''===e)return!0;try{return new RegExp(t).test(String(e))}catch(e){return console.error('[ValidationEngine] 正则表达式错误:',t,e),!0}},validateEnum:(e,t)=>null==e||''===e||(!Array.isArray(t)||0===t.length||t.includes(String(e))),validateNumeric(e,t,a){if(null==e||''===e)return!0;const n=String(e);let i;if(n.endsWith('%'))i=parseFloat(n);else if(n.includes('/')){const e=n.split('/');i=parseFloat(e[0])}else if(n.includes(':')){const e=n.split(':');i=parseFloat(e[e.length-1])}else i=parseFloat(n);return!!isNaN(i)||!(null!=t&&i<t)&&!(null!=a&&i>a)},validateRelation(e,t,a,n){if(null==e||''===e)return!0;if(!t||!a||!n)return!0;let i=null;for(const e in t)if(t[e]?.name===a){i=t[e];break}if(!i||!i.content||i.content.length<2)return!0;const o=i.content[0],r=String(e),c=Array.isArray(n)?n:[n];for(const e of c){const t=o.indexOf(e);if(-1!==t)for(let e=1;e<i.content.length;e++)if(String(i.content[e][t]||'')===r)return!0}return 0===c.length},validateRequired:e=>null!=e&&''!==String(e).trim(),validateKeyValue(e,t){if(null==e||''===e)return!0;const a=t?.valueType||'text',n=t?.valueMin,i=t?.valueMax;let o=String(e);o=o.replace(/：/g,':').replace(/；/g,';').replace(/，/g,';'),o=o.replace(/\s+/g,'');const r=o.split(';').filter(e=>e.trim());if(0===r.length)return!1;for(const e of r){const t=e.indexOf(':');if(-1===t||0===t||t===e.length-1)return!1;const o=e.substring(0,t),r=e.substring(t+1);if(!o||!r)return!1;if('numeric'===a){if(!/^-?\d+(\.\d+)?$/.test(r.trim()))return!1;const e=parseFloat(r);if(isNaN(e))return!1;if(null!=n&&e<n)return!1;if(null!=i&&e>i)return!1}}return!0},validateTableReadonly:(e,t)=>!e||!t||JSON.stringify(e)===JSON.stringify(t),validateRowLimit:(e,t,a)=>!(null!=t&&e<t)&&!(null!=a&&e>a),validateSequence(e,t,a){if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1500',message:'validateSequence entry',data:{tableName:e?.name,columnName:t,config:a,hasContent:!!e?.content,contentLength:e?.content?.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{}),!e||!e.content||e.content.length<2)return!0;if(!t||!a)return!0;const n=e.content[0]||[],i=e.content.slice(1)||[],o=n.indexOf(t);if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1507',message:'column check',data:{columnName:t,colIndex:o,headers:n.slice(0,5)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'E'})}).catch(()=>{}),o<0)return!0;const r=a.prefix||'',c=void 0!==a.startFrom?a.startFrom:1;fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1510',message:'config values',data:{prefix:r,startFrom:c},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});const s=[],l=[];for(let e=0;e<i.length;e++){const t=i[e]?.[o];if(l.push({rowIndex:e,rawValue:t,type:typeof t}),null==t||''===t)continue;const a=String(t).trim();if(a)if(r){const t=new RegExp(`^${r}(\\d+)$`),n=a.match(t);if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1574',message:'regex match attempt',data:{rowIndex:e,strValue:a,prefix:r,regexPattern:t.toString(),match:n?.[1]||null,matched:!!n},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{}),n){const t=parseInt(n[1],10);isNaN(t)||s.push({rowIndex:e,value:a,num:t})}}else{const t=parseInt(a,10);isNaN(t)||s.push({rowIndex:e,value:a,num:t})}}if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1602',message:'extracted numbers complete',data:{totalRows:i.length,numbersCount:s.length,allRowValues:l.slice(0,30),extractedNumbers:s.map(e=>({rowIndex:e.rowIndex,value:e.value,num:e.num}))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{}),0===s.length)return!0;s.sort((e,t)=>e.rowIndex-t.rowIndex),fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1623',message:'numbers after sort',data:{numbersCount:s.length,sortedNumbers:s.map(e=>({rowIndex:e.rowIndex,value:e.value,num:e.num})),startFrom:c},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});const d=new Set(s.map(e=>e.num));if(d.size!==s.length)return fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1643',message:'duplicate detected',data:{numSetSize:d.size,numbersLength:s.length,numbers:s.map(e=>e.num)},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{}),!1;for(let e=0;e<s.length;e++){const t=c+e,a=s[e].num;if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1650',message:'sequence check iteration',data:{i:e,expectedNum:t,actualNum:a,rowIndex:s[e].rowIndex,value:s[e].value,match:a===t},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{}),a!==t)return fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1672',message:'sequence mismatch detected',data:{i:e,expectedNum:t,actualNum:a,rowIndex:s[e].rowIndex,value:s[e].value,allNumbers:s.map(e=>e.num),startFrom:c},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{}),!1}return fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1555',message:'validateSequence passed',data:{numbersCount:s.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{}),!0},checkTableRules(e,t,a){const n=[];if(!e||!t||!a)return n;for(const i of a){if(!i.enabled||!i.intercept)continue;const a=I[i.ruleType];if(!a)continue;let o=null,r=null;for(const t in e)if(e[t]?.name===i.targetTable){o=e[t];break}for(const e in t)if(t[e]?.name===i.targetTable){r=t[e];break}if(r)if('table'===a.scope)if('tableReadonly'===i.ruleType)this.validateTableReadonly(o?.content,r?.content)||n.push({rule:i,tableName:i.targetTable,message:i.errorMessage||`表 "${i.targetTable}" 为只读，不允许修改`});else if('rowLimit'===i.ruleType){const e=(r.content?.length||1)-1;this.validateRowLimit(e,i.config?.min,i.config?.max)||n.push({rule:i,tableName:i.targetTable,message:i.errorMessage||`表 "${i.targetTable}" 行数 ${e} 超出限制 (${i.config?.min||0}-${i.config?.max||'∞'})`})}else'sequence'===i.ruleType&&i.targetColumn&&(this.validateSequence(r,i.targetColumn,i.config||{})||n.push({rule:i,tableName:i.targetTable,message:i.errorMessage||`字段 "${i.targetColumn}" 的编码索引必须从${i.config?.prefix||''}${String(i.config?.startFrom||1).padStart(3,'0')}开始严格递增，不可跳号或重复`}));else if('field'===a.scope&&i.targetColumn){const e=(r.content?.[0]||[]).indexOf(i.targetColumn);if(-1===e)continue;for(let a=1;a<(r.content?.length||0);a++){const o=r.content[a],c=o?.[e];if(!this.validateValue(c,i,t)){n.push({rule:i,tableName:i.targetTable,rowIndex:a,columnName:i.targetColumn,currentValue:String(c??''),message:i.errorMessage||`字段 "${i.targetColumn}" 验证失败`});break}}}}return n},validateValue(e,t,a){switch(t.ruleType){case'format':return this.validateFormat(e,t.config?.pattern);case'enum':return this.validateEnum(e,t.config?.values);case'numeric':return this.validateNumeric(e,t.config?.min,t.config?.max);case'relation':return this.validateRelation(e,a,t.config?.refTable,t.config?.refColumn);case'required':return this.validateRequired(e);case'keyValue':return this.validateKeyValue(e,t.config);default:return!0}},validateRow(e,t,a,n,i,o){const r=[];for(const c of i){if(c.targetTable!==a)continue;if(!c.enabled)continue;const i=t.indexOf(c.targetColumn);if(-1===i)continue;const s=e[i];this.validateValue(s,c,o)||r.push({ruleId:c.id,ruleName:c.name,ruleType:c.ruleType,rule:c,tableName:a,rowIndex:n,columnName:c.targetColumn,currentValue:String(s??''),errorMessage:c.errorMessage,severity:'error'})}return r},validateAllData(e){if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1706',message:'validateAllData entry',data:{hasRawData:!!e,sheetCount:e?Object.keys(e).filter(e=>e.startsWith('sheet_')).length:0},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{}),!e)return[];const t=N.getEnabledRules(),a=N.getAllRules();if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1863',message:'all rules check',data:{enabledRulesCount:t.length,allRulesCount:a.length,enabledSequenceRules:t.filter(e=>'sequence'===e.ruleType).map(e=>({id:e.id,name:e.name,targetTable:e.targetTable,enabled:e.enabled})),allSequenceRules:a.filter(e=>'sequence'===e.ruleType).map(e=>({id:e.id,name:e.name,targetTable:e.targetTable,enabled:e.enabled,builtin:e.builtin})),codeRules:a.filter(e=>'编码索引'===e.targetColumn).map(e=>({id:e.id,ruleType:e.ruleType,targetTable:e.targetTable,enabled:e.enabled,builtin:e.builtin}))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{}),0===t.length)return[];const n=[];for(const a in e){if(!a.startsWith('sheet_'))continue;const i=e[a];if(!i?.name||!i?.content||i.content.length<2)continue;const o=i.name,r=i.content[0],c=t.filter(e=>e.targetTable===o);if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1944',message:'table rules filter',data:{tableName:o,tableRulesCount:c.length,allRules:c.map(e=>({id:e.id,ruleType:e.ruleType,enabled:e.enabled,targetColumn:e.targetColumn,config:e.config})),sequenceRules:c.filter(e=>'sequence'===e.ruleType).map(e=>({id:e.id,enabled:e.enabled,targetColumn:e.targetColumn,config:e.config}))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{}),0===c.length)continue;for(const e of c){const t=I[e.ruleType];if('table'===t?.scope)if('rowLimit'===e.ruleType){const t=i.content.length-1;this.validateRowLimit(t,e.config?.min,e.config?.max)||n.push({ruleId:e.id,ruleName:e.name,ruleType:e.ruleType,rule:e,tableName:o,rowIndex:-1,columnName:'',currentValue:`${t} 行`,errorMessage:e.errorMessage||`行数 ${t} 超出限制 (${e.config?.min||0}-${e.config?.max||'∞'})`,severity:'warning'})}else if('sequence'===e.ruleType&&e.targetColumn){fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1747',message:'sequence rule check',data:{tableName:o,ruleId:e.id,ruleName:e.name,targetColumn:e.targetColumn,config:e.config},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});const t=this.validateSequence(i,e.targetColumn,e.config||{});if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1749',message:'sequence validation result',data:{tableName:o,ruleId:e.id,isValid:t},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{}),!t){const t={ruleId:e.id,ruleName:e.name,ruleType:e.ruleType,rule:e,tableName:o,rowIndex:-1,columnName:e.targetColumn,currentValue:'',errorMessage:e.errorMessage||`字段 "${e.targetColumn}" 的编码索引必须从${e.config?.prefix||''}${String(e.config?.startFrom||1).padStart(3,'0')}开始严格递增，不可跳号或重复`,severity:'error'};fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:1750',message:'adding sequence error',data:{tableName:o,ruleId:e.id,errorMessage:t.errorMessage},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'F'})}).catch(()=>{}),n.push(t)}}}const s=c.filter(e=>'table'!==I[e.ruleType]?.scope);for(let t=1;t<i.content.length;t++){const a=i.content[t],c=this.validateRow(a,r,o,t-1,s,e);n.push(...c)}}return n},validateTable(e,t){if(!e)return[];const a=N.getRulesByTable(t);if(0===a.length)return[];let n=null;for(const a in e)if(e[a]?.name===t){n=e[a];break}if(!n||!n.content||n.content.length<2)return[];const i=n.content[0],o=[];for(let r=1;r<n.content.length;r++){const c=n.content[r],s=this.validateRow(c,i,t,r-1,a,e);o.push(...s)}return o},groupErrorsByTable(e){const t={};for(const a of e)t[a.tableName]||(t[a.tableName]=[]),t[a.tableName].push(a);return t},getErrorCount(e){return this.validateAllData(e).length}},j={DB_NAME:'acu_local_avatars',STORE_NAME:'avatars',DB_VERSION:1,_db:null,_urlCache:new Map,async init(){return this._db?this._db:new Promise((e,t)=>{const a=indexedDB.open(this.DB_NAME,this.DB_VERSION);a.onerror=()=>{console.error('[LocalAvatarDB] 打开数据库失败:',a.error),t(a.error)},a.onsuccess=()=>{this._db=a.result,e(this._db)},a.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains(this.STORE_NAME)||t.createObjectStore(this.STORE_NAME,{keyPath:'name'})}})},async save(e,t){if(!e||!t)return!1;try{const a=await this.init();return new Promise((n,i)=>{const o=a.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME);this._urlCache.has(e)&&(URL.revokeObjectURL(this._urlCache.get(e)),this._urlCache.delete(e));const r={name:e,blob:t,size:t.size,type:t.type,updatedAt:Date.now()},c=o.put(r);c.onsuccess=()=>n(!0),c.onerror=()=>{console.error('[LocalAvatarDB] 保存失败:',c.error),i(c.error)}})}catch(e){return console.error('[LocalAvatarDB] save error:',e),!1}},async get(e){if(!e)return null;if(this._urlCache.has(e))return this._urlCache.get(e);try{const t=await this.init();return new Promise(a=>{const n=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).get(e);n.onsuccess=()=>{const t=n.result;if(t&&t.blob){const n=URL.createObjectURL(t.blob);this._urlCache.set(e,n),a(n)}else a(null)},n.onerror=()=>a(null)})}catch(e){return console.error('[LocalAvatarDB] get error:',e),null}},async has(e){if(!e)return!1;try{const t=await this.init();return new Promise(a=>{const n=t.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getKey(e);n.onsuccess=()=>a(void 0!==n.result),n.onerror=()=>a(!1)})}catch(e){return!1}},async delete(e){if(!e)return!1;try{this._urlCache.has(e)&&(URL.revokeObjectURL(this._urlCache.get(e)),this._urlCache.delete(e));const t=await this.init();return new Promise(a=>{const n=t.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).delete(e);n.onsuccess=()=>a(!0),n.onerror=()=>a(!1)})}catch(e){return console.error('[LocalAvatarDB] delete error:',e),!1}},async getAllNames(){try{const e=await this.init();return new Promise(t=>{const a=e.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAllKeys();a.onsuccess=()=>t(a.result||[]),a.onerror=()=>t([])})}catch(e){return[]}},async getStats(){try{const e=await this.init();return new Promise(t=>{const a=e.transaction(this.STORE_NAME,'readonly').objectStore(this.STORE_NAME).getAll();a.onsuccess=()=>{const e=a.result||[],n=e.reduce((e,t)=>e+(t.size||0),0);t({count:e.length,totalSize:n,totalSizeMB:(n/1024/1024).toFixed(2)})},a.onerror=()=>t({count:0,totalSize:0,totalSizeMB:'0'})})}catch(e){return{count:0,totalSize:0,totalSizeMB:'0'}}},async clearAll(){try{this._urlCache.forEach(e=>URL.revokeObjectURL(e)),this._urlCache.clear();const e=await this.init();return new Promise(t=>{const a=e.transaction(this.STORE_NAME,'readwrite').objectStore(this.STORE_NAME).clear();a.onsuccess=()=>t(!0),a.onerror=()=>t(!1)})}catch(e){return console.error('[LocalAvatarDB] clearAll error:',e),!1}}},F=()=>{const e=xe||('function'==typeof zt?zt():null);if(e)for(const t in e){const a=e[t];if(a?.name?.includes('主角')&&a.content?.[1]?.[1])return a.content[1][1]}return null},O=()=>{try{const e=window.parent||window;if(e.SillyTavern?.getContext){const t=e.SillyTavern.getContext();if(t?.name1)return t.name1}if('undefined'!=typeof name1&&name1)return name1;if(e.name1)return e.name1;const $=e.jQuery||window.jQuery;if($){const e=$('#user_avatar_block .avatar-name, #persona_name_input').first();if(e.length){const t=e.val?.()||e.text?.();if(t&&t.trim())return t.trim()}}}catch(e){console.warn('[ACU] getPersonaName error:',e)}return null},R=()=>O()||F()||'主角',L=e=>{if(!e||'string'!=typeof e)return e;const t=R();let a=e.replace(/<user>/gi,t);return a=a.replace(/\{\{user\}\}/gi,t),a},U={_cache:null,load(){if(!this._cache){const e=Fe.get(S,{});this._cache={};for(const t in e)'string'==typeof e[t]?this._cache[t]={url:e[t],offsetX:50,offsetY:50,scale:150,aliases:[]}:this._cache[t]={url:e[t].url||'',offsetX:e[t].offsetX??50,offsetY:e[t].offsetY??50,scale:e[t].scale??150,aliases:e[t].aliases||[]}}return this._cache},save(){Fe.set(S,this._cache||{}),this._cache=null},get(e){const t=this.load()[e];if(t&&t.url)return t.url;for(const t in this._cache)if(this._cache[t].aliases&&this._cache[t].aliases.includes(e)&&this._cache[t].url)return this._cache[t].url;return null},async getAsync(e){if(!e)return null;const t=F(),a='<user>'===e||'主角'===e||t&&e===t,n=await j.get(e);if(n)return n;if(a&&'<user>'!==e){const e=await j.get('<user>');if(e)return e}const i=this.getPrimaryName(e);if(i!==e){const e=await j.get(i);if(e)return e}return this.get(e)},async hasLocalAvatar(e){if(!e)return!1;if(await j.has(e))return!0;const t=this.getPrimaryName(e);return t!==e&&await j.has(t)},saveLocalAvatar:async(e,t)=>await j.save(e,t),deleteLocalAvatar:async e=>await j.delete(e),getOffsetX(e){const t=this._resolveByAlias(e);return t?t.offsetX??50:50},getOffsetY(e){const t=this._resolveByAlias(e);return t?t.offsetY??50:50},getScale(e){const t=this._resolveByAlias(e);return t?t.scale??150:150},_resolveByAlias(e){const t=this.load()[e];if(t)return t;for(const t in this._cache)if(this._cache[t].aliases&&this._cache[t].aliases.includes(e))return this._cache[t];return null},getPrimaryName(e){if(this.load()[e])return e;for(const t in this._cache)if(this._cache[t].aliases&&this._cache[t].aliases.includes(e))return t;return e},set(e,t,a=50,n=50,i=150,o=[]){this.load()[e]={url:t,offsetX:a,offsetY:n,scale:i,aliases:o},this.save()},setPosition(e,t,a){const n=this.load()[e];n&&(n.offsetX=t,n.offsetY=a,this.save())},setScale(e,t){const a=this.load()[e];a&&(a.scale=t,this.save())},setAliases(e,t){const a=this.load()[e];a&&(a.aliases=t,this.save())},remove(e){delete this.load()[e],this.save()},getAll(){return this.load()},exportData(){return{version:1,exportTime:(new Date).toISOString(),avatars:this.load()}},importData(e,t=!0){if(!e||!e.avatars)throw new Error('无效的配置文件格式');const a=this.load(),n={added:0,updated:0,skipped:0};for(const i in e.avatars){const o=e.avatars[i];o.url&&(a[i]?t?(a[i]={url:o.url,offsetX:o.offsetX??50,offsetY:o.offsetY??50,scale:o.scale??150,aliases:o.aliases||[]},n.updated++):n.skipped++:(a[i]={url:o.url,offsetX:o.offsetX??50,offsetY:o.offsetY??50,scale:o.scale??150,aliases:o.aliases||[]},n.added++))}return this.save(),n},analyzeImport(e){if(!e||!e.avatars)return{valid:!1,error:'无效的配置文件格式'};const t=this.load(),a={valid:!0,total:0,newItems:[],conflicts:[]};for(const n in e.avatars)e.avatars[n].url&&(a.total++,t[n]?a.conflicts.push(n):a.newItems.push(n));return a}},V=function(){const e='__mvu__';function t(e){return String(e??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}function a(){return void 0!==window.Mvu&&'function'==typeof window.Mvu.getMvuData}function n(){try{if(void 0===window.Mvu||'function'!=typeof window.Mvu.getMvuData)return null;const e=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(!e)return null;return{stat_data:e.stat_data||null,display_data:e.display_data||{},delta_data:e.delta_data||{},schema:e.schema||null}}catch(e){return console.warn('[MvuModule] getData error:',e),console.error('[MvuModule] getData error stack:',e.stack),null}}function i(e){return Array.isArray(e)&&2===e.length&&'string'==typeof e[1]&&('number'==typeof e[0]||'string'==typeof e[0]||'boolean'==typeof e[0])}function o(e){return!!Array.isArray(e)&&e.every(e=>'string'==typeof e||'number'==typeof e||'boolean'==typeof e||null===e)}function r(e){return Array.isArray(e)?i(e)?0:e.length:e&&'object'==typeof e?Object.keys(e).filter(e=>!e.startsWith('$')).length:0}function c(e,a,n,r){const c=function(e,t){if(!t||!e)return'';const a=e.split('.');let n=t;for(const e of a){if(null==n)return'';n=n[e]}if(!n)return'';if('string'==typeof n&&n.includes('->')){const e=n.match(/^(-?[\d.]+)->(-?[\d.]+)/);if(e){const t=parseFloat(e[1]),a=parseFloat(e[2]);if(!isNaN(t)&&!isNaN(a))return a>t?'↑':a<t?'↓':''}return'•'}return''}(n,r),s=c?'mvu-changed':'';let l,d='mvu-value';return i(a)?l=String(a[0]):o(a)?(l=a.map(e=>String(e??'')).join(', '),d+=' mvu-array-value'):l=String(a??''),`\n                <div class="mvu-row ${s}">\n                    <div class="mvu-key">${t(e)}</div>\n                    <div class="mvu-value-wrap">\n                        <span class="${d}" data-path="${t(n)}">${t(l)}</span>\n                        ${c?`<span class="mvu-change-indicator">${c}</span>`:''}\n                    </div>\n                </div>\n            `}function s(e,a,n,l,d,u,p){const g=r(a),f=u?'':'collapsed';let b='',m=!1,h=0,v=0;if(!Array.isArray(a)||i(a)||o(a)){if(a&&'object'==typeof a&&!i(a)){const e=Object.entries(a).filter(([e])=>!e.startsWith('$'));for(const[t,a]of e){const e=n?`${n}.${t}`:t;!a||'object'!=typeof a||i(a)||o(a)?(v++,b+=c(t,a,e,l)):(m=!0,h++,b+=s(t,a,e,l,d+1,!1,p))}}}else a.forEach((e,t)=>{const a=`${n}[${t}]`;!e||'object'!=typeof e||i(e)||o(e)?(v++,b+=c(`[${t}]`,e,a,l)):(m=!0,h++,b+=s(`[${t}]`,e,a,l,d+1,!1,p))});const x=Array.isArray(a)?`[${g}]`:`(${g})`,y=p&&m?'mvu-card-body horizontal-nested':'mvu-card-body';let w=!1;if(p&&m&&0===d)if(!Array.isArray(a)||i(a)||o(a)){if(a&&'object'==typeof a&&!i(a)){const e=Object.entries(a).filter(([e])=>!e.startsWith('$'));for(const[t,a]of e)if(a&&'object'==typeof a&&!i(a)&&!o(a)){r(a)>=2&&(w=!0)}}}else a.forEach(e=>{if(e&&'object'==typeof e&&!i(e)&&!o(e)){r(e)>=2&&(w=!0)}});return`\n                <div class="mvu-card${p&&m&&(0===d&&(h>=2&&v<=1||w)||d>0&&0===v&&h>=2)?' has-nested-cards':''} ${f}" data-path="${t(n)}" data-depth="${d}">\n                    <div class="mvu-card-header">\n                        <div class="mvu-card-title">\n                            <span>${t(e)}</span>\n                            <span class="mvu-card-count">${x}</span>\n                        </div>\n                        <span class="mvu-card-toggle">▼</span>\n                    </div>\n                    <div class="${y}">\n                        ${b}\n                    </div>\n                </div>\n            `}return{MODULE_ID:e,isAvailable:a,getData:n,getDataWithRetry:async function(e=3,t=500){try{await waitGlobalInitialized('Mvu');let a=0;for(;a<e;){a++;try{const e=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(e){return{stat_data:e.stat_data||null,display_data:e.display_data||{},delta_data:e.delta_data||{},schema:e.schema||null}}}catch(e){console.warn('[MvuModule] Error getting data on attempt',a,':',e),console.error('[MvuModule] Error stack:',e.stack)}a<e&&await new Promise(e=>setTimeout(e,t))}return console.warn('[MvuModule] Failed to get data after',a,'attempts'),null}catch(e){return console.error('[MvuModule] Error waiting for MVU framework or getting data:',e),console.error('[MvuModule] Error stack:',e.stack),null}},injectStyles:function(){const e=window.parent?.document||document;if(e.getElementById('mvu-module-styles'))return;const t=e.createElement('style');t.id='mvu-module-styles',t.textContent='\n            /* MVU 面板容器 */\n            .acu-mvu-panel {\n                height: 100%;\n                display: flex;\n                flex-direction: column;\n                min-height: 300px; /* 确保面板有足够的最小高度，避免显示为白条 */\n                overflow: hidden; /* 不在这里滚动，让父容器处理 */\n            }\n            .acu-mvu-panel .acu-panel-header {\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                padding: 10px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                flex-shrink: 0;\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n            }\n            .acu-mvu-panel .acu-panel-header .acu-panel-title i {\n                color: var(--acu-accent);\n            }\n            .acu-mvu-panel .acu-header-actions {\n                display: flex;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn {\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                padding: 5px 10px;\n                font-size: 13px;\n                border-radius: 4px;\n                transition: all 0.2s;\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-mvu-panel .mvu-header-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n\n            /* MVU 内容区 - 始终使用竖向滚动模式 */\n            .mvu-content {\n                display: flex;\n                flex-direction: column;\n                overflow-x: hidden;\n                overflow-y: auto; /* 直接在内容区启用滚动 */\n                flex: 1 1 auto;\n                min-height: 0; /* 关键：允许 flex 子项缩小以启用滚动 */\n                max-height: 100%; /* 限制最大高度为父容器 */\n                padding: 12px;\n                scrollbar-width: thin;\n            }\n            .mvu-content::-webkit-scrollbar {\n                display: none;\n            }\n            .mvu-content .mvu-card {\n                flex: 0 0 auto; /* 不拉伸，保持自然高度 */\n                min-width: 100%;\n                max-width: 100%;\n                width: 100%;\n            }\n            /* MVU面板始终支持滚动 */\n            .acu-mvu-panel {\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                flex: 1 1 0; /* 关键：使用 flex-basis: 0 让容器可以正确计算滚动 */\n                min-height: 300px; /* 确保面板有足够的最小高度，避免显示为白条 */\n            }\n\n            /* MVU 卡片 */\n            .mvu-card {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 10px;\n                overflow: hidden;\n            }\n            .mvu-card:last-child {\n                margin-bottom: 0;\n            }\n            .mvu-card-header {\n                background: var(--acu-table-head);\n                padding: 8px 12px;\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.2s;\n            }\n            .mvu-card-header:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-card-title {\n                font-weight: 600;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .mvu-card-count {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: normal;\n            }\n            .mvu-card-toggle {\n                color: var(--acu-text-sub);\n                font-size: 10px;\n                transition: transform 0.2s;\n            }\n            .mvu-card.collapsed .mvu-card-toggle {\n                transform: rotate(-90deg);\n            }\n            .mvu-card-body {\n                padding: 8px 12px;\n                display: block;\n                overflow: hidden; /* 为 slideUp/slideDown 动画提供支持 */\n            }\n            .mvu-card.collapsed .mvu-card-body {\n                display: none;\n            }\n\n            /* 嵌套卡片 */\n            .mvu-card .mvu-card {\n                background: var(--acu-table-head);\n                margin: 6px 0;\n            }\n            .mvu-card .mvu-card .mvu-card-header {\n                background: rgba(128,128,128,0.1);\n                padding: 6px 10px;\n            }\n            .mvu-card .mvu-card .mvu-card-body {\n                padding: 6px 10px;\n            }\n\n            /* 嵌套卡片横向布局 - 只对嵌套卡片生效，键值对保持正常块级显示 */\n            .mvu-card-body.horizontal-nested {\n                display: flex;\n                flex-direction: row;\n                flex-wrap: nowrap;\n                gap: 12px;\n                overflow-x: auto;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: touch;\n                padding-bottom: 8px;\n                align-items: flex-start;\n            }\n            /* 如果父卡片有 has-nested-cards 类，使用 wrap 布局，让键值对和嵌套卡片可以换行 */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested {\n                flex-wrap: wrap;\n            }\n            /* 键值对行保持正常块级显示，占满一行 */\n            .mvu-card-body.horizontal-nested > .mvu-row {\n                display: flex;\n                flex: 0 0 100%;\n                width: 100%;\n                max-width: 100%; /* 确保不超过容器宽度 */\n                box-sizing: border-box;\n            }\n            /* 如果父卡片有 has-nested-cards 类，键值对应该根据内容自适应宽度，但仍然占满一行 */\n            .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                flex: 0 0 auto; /* 根据内容自适应宽度 */\n                min-width: 100%; /* 确保占满一行 */\n                width: auto; /* 根据内容自适应宽度 */\n                max-width: 450px; /* 限制键值对的最大宽度，避免占用过多横向空间 */\n                box-sizing: border-box;\n            }\n            @media (min-width: 769px) {\n                .mvu-card.has-nested-cards .mvu-card-body.horizontal-nested > .mvu-row {\n                    max-width: 550px; /* 大屏幕下也限制键值对的最大宽度 */\n                }\n            }\n            /* 只有嵌套卡片才横向排列 - 智能宽度 */\n            .mvu-card-body.horizontal-nested > .mvu-card {\n                flex: 0 0 auto; /* 根据内容自动调整宽度 */\n                min-width: 200px;\n                max-width: 350px;\n                width: auto;\n            }\n            /* 如果嵌套卡片内部也有横向排列的子卡片，移除最大宽度限制，允许根据内容自适应 */\n            .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                min-width: 400px; /* 为包含嵌套卡片的嵌套卡片设置更大的最小宽度 */\n                max-width: none; /* 移除最大宽度限制，允许根据内容自适应 */\n            }\n            @media (min-width: 769px) {\n                .mvu-card-body.horizontal-nested > .mvu-card {\n                    min-width: 240px;\n                    max-width: 400px;\n                }\n                .mvu-card-body.horizontal-nested > .mvu-card.has-nested-cards {\n                    min-width: 500px; /* 为包含嵌套卡片的嵌套卡片设置更大的最小宽度 */\n                    max-width: none; /* 移除最大宽度限制，允许根据内容自适应 */\n                }\n            }\n\n            /* 键值对行 */\n            .mvu-row {\n                display: flex;\n                align-items: flex-start;\n                padding: 5px 0;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .mvu-row:last-child {\n                border-bottom: none;\n            }\n            .mvu-key {\n                color: var(--acu-text-sub);\n                min-width: 80px;\n                max-width: 120px;\n                flex-shrink: 0;\n                font-size: 12px;\n                padding-right: 8px;\n                word-break: break-all;\n            }\n            .mvu-value-wrap {\n                flex: 1;\n                display: flex;\n                align-items: flex-start;\n                gap: 6px;\n                min-width: 0;\n            }\n            .mvu-value {\n                color: var(--acu-text-main);\n                font-size: 13px;\n                cursor: pointer;\n                padding: 1px 6px;\n                border-radius: 4px;\n                transition: background 0.2s;\n                word-break: break-word;\n                flex: 1;\n            }\n            .mvu-value:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-value.mvu-array-value {\n                font-size: 12px;\n                color: var(--acu-text-sub);\n            }\n            .mvu-change-indicator {\n                color: var(--acu-success-text);\n                font-weight: bold;\n                font-size: 12px;\n                flex-shrink: 0;\n            }\n            .mvu-row.mvu-changed {\n                background: var(--acu-success-bg);\n                margin: 0 -12px;\n                padding: 5px 12px;\n                border-radius: 4px;\n            }\n            .mvu-card .mvu-card .mvu-row.mvu-changed {\n                margin: 0 -10px;\n                padding: 5px 10px;\n            }\n\n            /* 空状态 */\n            .mvu-empty {\n                text-align: center;\n                padding: 40px 20px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 100%;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: center;\n            }\n            .mvu-empty i {\n                font-size: 32px;\n                margin-bottom: 12px;\n                display: block;\n                opacity: 0.5;\n            }\n            .mvu-empty p {\n                margin: 0 0 6px 0;\n            }\n            .mvu-empty .mvu-empty-hint {\n                font-size: 12px;\n                opacity: 0.7;\n            }\n\n            /* 编辑弹窗 */\n            .mvu-edit-overlay {\n                position: fixed;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(0,0,0,0.6);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 99999;\n                animation: mvuFadeIn 0.15s ease-out;\n            }\n            .mvu-edit-dialog {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                padding: 16px;\n                width: 90%;\n                max-width: 400px;\n                animation: mvuSlideIn 0.2s ease-out;\n            }\n            .mvu-edit-title {\n                font-weight: 600;\n                color: var(--acu-text-main);\n                margin-bottom: 12px;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .mvu-edit-path {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                padding: 6px 10px;\n                border-radius: 4px;\n                margin-bottom: 12px;\n                word-break: break-all;\n                font-family: monospace;\n            }\n            .mvu-edit-textarea {\n                width: 100%;\n                min-height: 80px;\n                padding: 10px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-input-bg, var(--acu-bg-panel));\n                color: var(--acu-text-main);\n                font-size: 13px;\n                resize: vertical;\n                box-sizing: border-box;\n            }\n            .mvu-edit-textarea:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .mvu-edit-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-top: 8px;\n                opacity: 0.7;\n            }\n            .mvu-edit-btns {\n                display: flex;\n                justify-content: flex-end;\n                gap: 8px;\n                margin-top: 16px;\n            }\n            .mvu-edit-btn {\n                padding: 8px 16px;\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 13px;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                transition: all 0.2s;\n            }\n            .mvu-edit-btn.mvu-btn-cancel {\n                background: transparent;\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-sub);\n            }\n            .mvu-edit-btn.mvu-btn-cancel:hover {\n                background: var(--acu-table-hover);\n            }\n            .mvu-edit-btn.mvu-btn-save {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: #fff;\n            }\n            .mvu-edit-btn.mvu-btn-save:hover {\n                opacity: 0.9;\n            }\n\n            @keyframes mvuFadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n            @keyframes mvuSlideIn {\n                from { transform: translateY(-20px); opacity: 0; }\n                to { transform: translateY(0); opacity: 1; }\n            }\n\n            /* 导航按钮 */\n            .acu-nav-btn.acu-mvu-btn.active {\n                background: var(--acu-btn-active-bg);\n                color: var(--acu-btn-active-text);\n            }\n        ',e.head.appendChild(t)},renderNavButton:function(t){return`<button class="acu-nav-btn acu-mvu-btn $${t?'active':''}" id="acu-btn-mvu" data-table="$${e}" style="order:-1;">\n                    <i class="fa-solid fa-code-branch"></i><span>变量</span>\n                </button>`},renderPanel:function(){const e=n(),a='vertical-layout';if(!e)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">MVU 变量</span></div>\n                                <div class="acu-title-sub">(0项)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${V.MODULE_ID}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="刷新（自动重试获取变量）">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="关闭">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${a}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-exclamation-circle"></i>\n                                <p>无法获取 MVU 数据</p>\n                                <p class="mvu-empty-hint">请确保角色卡已配置 MVU 框架，或点击刷新按钮自动重试获取变量</p>\n                            </div>\n                        </div>\n                    `;if(!e.stat_data||'object'==typeof e.stat_data&&0===Object.keys(e.stat_data).length)return`\n                        <div class="acu-panel-header">\n                            <div class="acu-panel-title">\n                                <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">MVU 变量</span></div>\n                                <div class="acu-title-sub">(0项)</div>\n                            </div>\n                            <div class="acu-header-actions">\n                                <div class="acu-height-control">\n                                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${V.MODULE_ID}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                                </div>\n                                <button class="mvu-header-btn mvu-btn-refresh" title="刷新（自动重试获取变量）">\n                                    <i class="fa-solid fa-sync-alt"></i>\n                                </button>\n                                <button class="acu-close-btn" title="关闭">\n                                    <i class="fa-solid fa-times"></i>\n                                </button>\n                            </div>\n                        </div>\n                        <div class="mvu-content ${a}">\n                            <div class="mvu-empty">\n                                <i class="fa-solid fa-inbox"></i>\n                                <p>当前没有变量数据</p>\n                                <p class="mvu-empty-hint">变量数据将在 AI 回复后自动初始化，或点击刷新按钮自动重试获取变量</p>\n                            </div>\n                        </div>\n                    `;const l=Object.keys(e.stat_data).filter(e=>!e.startsWith('$'));let d='';for(const a of l){const n=e.stat_data[a];r(n);!n||'object'!=typeof n||i(n)||o(n)?d+=`\n                            <div class="mvu-card" data-path="${t(a)}" data-depth="0">\n                                <div class="mvu-card-body">\n                                    ${c(a,n,a,e.delta_data)}\n                                </div>\n                            </div>\n                        `:d+=s(a,n,a,e.delta_data,0,!0,!1)}return`\n                    <div class="acu-panel-header">\n                        <div class="acu-panel-title">\n                            <div class="acu-title-main"><i class="fa-solid fa-code-branch"></i> <span class="acu-title-text">MVU 变量</span></div>\n                            <div class="acu-title-sub">(${l.length}项)</div>\n                        </div>\n                        <div class="acu-header-actions">\n                            <div class="acu-height-control">\n                                <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${V.MODULE_ID}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                            </div>\n                            <button class="mvu-header-btn mvu-btn-refresh" title="刷新（自动重试获取变量）">\n                                <i class="fa-solid fa-sync-alt"></i>\n                            </button>\n                            <button class="acu-close-btn" title="关闭">\n                                <i class="fa-solid fa-times"></i>\n                            </button>\n                        </div>\n                    </div>\n                    <div class="mvu-content ${a}">\n                        ${d}\n                    </div>\n                `},bindEvents:function(e){const $=window.parent?.jQuery||window.jQuery;if(!$||!e||!e.length)return void console.warn('[MvuModule] bindEvents: jQuery or container not available');const t=$('#acu-data-area');t.length?(t.off('.mvu'),t.on('click.mvu','.mvu-card-header',function(e){e.stopPropagation();const t=$(this).closest('.mvu-card'),a=t.find('> .mvu-card-body').first();a.is(':animated')||a.hasClass('animating')||(t.hasClass('collapsed')?(a.hide(),t.removeClass('collapsed'),a.addClass('animating').slideDown(180,function(){$(this).removeClass('animating')})):a.addClass('animating').slideUp(180,function(){t.addClass('collapsed'),$(this).removeClass('animating')}))}),t.on('click.mvu','.mvu-btn-refresh',function(e){e.stopPropagation(),V.refresh(t)}),t.on('click.mvu','.mvu-value',function(e){e.stopPropagation();const t=$(this),a=t.data('path');if(!a)return void console.warn('[MvuModule] No path on value element');const n=t.text().replace(/\s*\$\s*$/,'').trim();V.showEditDialog(a,n,async function(e){if(null!==e&&e!==n){const n=await V.setValue(a,e),toastr=window.parent?.toastr||window.toastr;n?(t.text(e),t.css('background','var(--acu-success-bg)'),setTimeout(()=>t.css('background',''),1500)):toastr&&toastr.error('保存失败')}})}),function(){const e=window.parent?.document||document,t=$(e);t.off('touchstart.mvuSwipeFix touchmove.mvuSwipeFix touchend.mvuSwipeFix','#acu-data-area');let a=0,n=0,i=!1;t.on('touchstart.mvuSwipeFix','#acu-data-area',function(e){$(e.target).closest('.acu-mvu-panel').length>0&&1===e.originalEvent.touches.length&&(a=e.originalEvent.touches[0].clientX,n=e.originalEvent.touches[0].clientY,i=!1)}),t.on('touchmove.mvuSwipeFix','#acu-data-area',function(e){if(!($(e.target).closest('.acu-mvu-panel').length>0))return;if(1!==e.originalEvent.touches.length)return;const t=e.originalEvent.touches[0],o=Math.abs(t.clientX-a),r=Math.abs(t.clientY-n);(r<5?o>5&&o>2*r:o>1.5*r&&o>10)&&(i=!0,e.stopImmediatePropagation(),e.stopPropagation())}),t.on('touchend.mvuSwipeFix','#acu-data-area',function(e){if(!($(e.target).closest('.acu-mvu-panel').length>0))return i=!1,a=0,void(n=0);i&&(e.stopImmediatePropagation(),e.stopPropagation(),i=!1),a=0,n=0});e.addEventListener('touchstart',function(e){$(e.target).closest('.acu-mvu-panel').length>0&&e.touches&&1===e.touches.length&&(a=e.touches[0].clientX,n=e.touches[0].clientY)},!0),e.addEventListener('touchmove',function(e){if($(e.target).closest('.acu-mvu-panel').length>0&&e.touches&&1===e.touches.length&&a&&n){const t=e.touches[0],i=Math.abs(t.clientX-a),o=Math.abs(t.clientY-n);(o<5?i>5&&i>2*o:i>1.5*o&&i>10)&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault())}},!0),e.addEventListener('touchend',function(e){$(e.target).closest('.acu-mvu-panel').length>0&&i&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault())},!0)}(),t.on('click.mvu','.acu-close-btn',function(e){e.stopPropagation();const a=t.find('.acu-search-input');a.length&&a.val()?a.val('').trigger('input').focus():('function'==typeof Re&&Re(null),'function'==typeof Lt&&Lt())}),t.on('pointerdown.mvu','.acu-height-drag-handle',function(e){if(0!==e.button)return;e.preventDefault(),e.stopPropagation();const a=this;a.setPointerCapture(e.pointerId),$(a).addClass('active');const n=t.height(),i=e.clientY,o=$(a).data('table'),r=void 0!==window.MIN_PANEL_HEIGHT?window.MIN_PANEL_HEIGHT:200,c=void 0!==window.MAX_PANEL_HEIGHT?window.MAX_PANEL_HEIGHT:800;a.onpointermove=function(e){const a=e.clientY-i;let o=n-a;o<r&&(o=r),o>c&&(o=c),t.css('height',o+'px')},a.onpointerup=function(e){if($(a).removeClass('active'),a.releasePointerCapture(e.pointerId),a.onpointermove=null,a.onpointerup=null,o&&'function'==typeof We&&'function'==typeof Ke){const e=We();e[o]=parseInt(t.css('height')),Ke(e),t.addClass('acu-manual-mode')}}}),t.on('dblclick.mvu','.acu-height-drag-handle',function(e){e.preventDefault(),e.stopPropagation();const a=$(this).data('table');if(a&&'function'==typeof We&&'function'==typeof Ke){const e=We();delete e[a],Ke(e),t.css('height','').removeClass('acu-manual-mode')}}),t.on('dblclick.mvu','.acu-panel-header',function(e){if($(e.target).closest('.acu-search-input, .acu-close-btn, .mvu-header-btn').length)return;e.preventDefault(),e.stopPropagation();const a=V.MODULE_ID;if(a&&'function'==typeof We&&'function'==typeof Ke){const e=We();delete e[a],Ke(e),t.css('height','').removeClass('acu-manual-mode')}})):console.warn('[MvuModule] bindEvents: #acu-data-area not found')},showEditDialog:function(e,a,n){const $=window.parent?.jQuery||window.jQuery,i=window.parent?.document||document;if(!$)return;$(i).find('.mvu-edit-overlay').remove();const o=`\n                    <div class="mvu-edit-overlay acu-edit-overlay acu-theme-${('function'==typeof $t?$t().theme:null)||'retro'}">\n                        <div class="mvu-edit-dialog acu-edit-dialog">\n                            <div class="acu-edit-title">\n                                <i class="fa-solid fa-edit" style="opacity:0.7;"></i>\n                                <span>编辑变量</span>\n                            </div>\n                            <div class="mvu-edit-path">${t(e)}</div>\n                            <textarea class="mvu-edit-textarea acu-edit-textarea">${t(a)}</textarea>\n                            <div class="mvu-edit-hint">Ctrl+Enter 保存 | Esc 取消</div>\n                            <div class="acu-dialog-btns">\n                                <button class="acu-dialog-btn mvu-btn-cancel">\n                                    <i class="fa-solid fa-times"></i> 取消\n                                </button>\n                                <button class="acu-dialog-btn acu-btn-confirm mvu-btn-save">\n                                    <i class="fa-solid fa-check"></i> 保存\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                `;$(i.body).append(o);const r=$(i).find('.mvu-edit-overlay'),c=r.find('.mvu-edit-textarea');setTimeout(()=>c.focus().select(),50),r.on('click','.mvu-btn-cancel',function(e){e.preventDefault(),e.stopPropagation(),r.remove(),n(null)}),r.on('click','.mvu-btn-save',function(e){e.preventDefault(),e.stopPropagation();const t=c.val();r.remove(),n(t)}),r.on('click',function(e){$(e.target).hasClass('mvu-edit-overlay')&&(r.remove(),n(null))}),c.on('keydown',function(e){if('Escape'===e.key)e.preventDefault(),r.remove(),n(null);else if('Enter'===e.key&&e.ctrlKey){e.preventDefault();const t=c.val();r.remove(),n(t)}})},setValue:async function(e,t){if(!a())return!1;try{let a=t;'true'===t?a=!0:'false'===t?a=!1:isNaN(Number(t))||''===String(t).trim()||(a=Number(t));const n=window.Mvu.getMvuData({type:'message',message_id:'latest'});if(!n)return console.error('[MvuModule] 无法获取 MVU 数据'),!1;const i=await window.Mvu.setMvuVariable(n,e,a,{reason:'手动编辑',is_recursive:!1});return i?await window.Mvu.replaceMvuData(n,{type:'message',message_id:'latest'}):console.warn('[MvuModule] setMvuVariable 返回 false'),i}catch(e){return console.error('[MvuModule] setValue error:',e),!1}},isModuleTab:function(t){return t===e},refresh:function(e){if(!e||!e.length){const t=$('#acu-data-area');if(!t.length)return;e=t}const t=e.find('.mvu-btn-refresh');t.length&&t.find('i').addClass('fa-spin'),this.getDataWithRetry(10,1e3).then(a=>{t.length&&t.find('i').removeClass('fa-spin'),e.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(e);const toastr=window.parent?.toastr||window.toastr;toastr&&!a&&toastr.warning('无法获取变量数据，请稍后重试或确保角色卡已配置 MVU 框架')}).catch(a=>{console.error('[MvuModule] Error refreshing data:',a),t.length&&t.find('i').removeClass('fa-spin'),e.html('<div class="acu-mvu-panel">'+this.renderPanel()+'</div>'),this.bindEvents(e);const toastr=window.parent?.toastr||window.toastr;toastr&&toastr.error('获取变量数据时出错')})}}}(),Y={critSuccessMax:5,hardSuccessDiv:5,difficultSuccessDiv:2,critFailMin:96,ruleType:'high_good',lastDiceType:'1d100',dndCritSuccess:20,dndCritFail:1,contestTieRule:'initiator_lose',hideDiceResultFromUser:!1},q=()=>Fe.get(w,Y),X=e=>Fe.set(w,{...q(),...e}),J=()=>{const e=q().hideDiceResultFromUser;try{const t=$('#send_textarea');if(t.length){let a=t.val()||'',n=a;if(e){const e=/进行了一次【[^】]+ vs [^】]+】的对抗检定。.*?\(目标\d+\) 掷出 \d+，判定为【[^】]+】；.*?\(目标\d+\) 掷出 \d+，判定为【[^】]+】。最终结果：【[^】]+】/g,t=/[\u4e00-\u9fa5a-zA-Z<>]+发起了【[^】]+】检定，掷出\d+，[^【]*【[^】]+】/g;e.test(n)&&(n=n.replace(e,'[投骰结果已隐藏]')),t.test(n)&&(n=n.replace(t,'[投骰结果已隐藏]'))}else{const e=t.data('acu-original-dice-text');e&&a.includes('[投骰结果已隐藏]')&&(n=a.replace(/\[投骰结果已隐藏\]/g,e),t.removeData('acu-original-dice-text'))}n!==a&&t.val(n).trigger('input').trigger('change')}}catch(e){console.warn('[ACU] 处理输入栏投骰结果失败:',e)}if(e)try{const e=getLastMessageId();if(e<0)return;getChatMessages(`0-${e}`,{role:'user'}).forEach(e=>{try{const t=retrieveDisplayedMessage(e.message_id);if(!t||!t.length)return;const a=t.find('.mes_text');if(!a||!a.length)return;let n=a.text();if(n.includes('[投骰结果已隐藏]'))return;let i=n;const o=/进行了一次【[^】]+ vs [^】]+】的对抗检定。.*?\(目标\d+\) 掷出 \d+，判定为【[^】]+】；.*?\(目标\d+\) 掷出 \d+，判定为【[^】]+】。最终结果：【[^】]+】/g;o.test(i)&&(i=i.replace(o,'[投骰结果已隐藏]'));const r=/[\u4e00-\u9fa5a-zA-Z<>]+发起了【[^】]+】检定，掷出\d+，[^【]*【[^】]+】/g;r.test(i)&&(i=i.replace(r,'[投骰结果已隐藏]')),i!==n&&a.text(i)}catch(t){console.warn(`[ACU] 隐藏第 ${e.message_id} 楼投骰结果失败:`,t)}})}catch(e){console.warn('[ACU] 隐藏投骰结果失败:',e)}else try{const e=getLastMessageId();if(e>=0){getChatMessages(`0-${e}`,{role:'user'}).forEach(e=>{try{const t=retrieveDisplayedMessage(e.message_id);if(!t||!t.length)return;const a=t.find('.mes_text');if(!a||!a.length)return;if(a.text().includes('[投骰结果已隐藏]')){const t=e.message||'';t&&a.text(t)}}catch(t){console.warn(`[ACU] 恢复第 ${e.message_id} 楼投骰结果失败:`,t)}})}}catch(e){console.warn('[ACU] 恢复投骰结果失败:',e)}},H=[{format:'acu_attr_preset_v1',version:1,id:'coc7',name:'简化COC规则',builtin:!0,description:'基于克苏鲁的呼唤第7版规则的属性预设。包含8条基本属性和16条特殊属性。',baseAttributes:[{name:'力量',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'体质',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'敏捷',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'外貌',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'意志',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'幸运',formula:'3d6*5',range:[15,90],modifier:'1d10-5'},{name:'智力',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'},{name:'教育',formula:'2d6*5+30',range:[40,90],modifier:'1d10-5'}],specialAttributes:[{name:'侦查',formula:'10+5d20',range:[15,95]},{name:'聆听',formula:'10+5d20',range:[15,95]},{name:'心理学',formula:'10+5d20',range:[15,95]},{name:'说服',formula:'5+4d20',range:[9,85]},{name:'话术',formula:'5+4d20',range:[9,85]},{name:'潜行',formula:'5+4d20',range:[9,85]},{name:'格斗',formula:'5+4d20',range:[9,85]},{name:'射击',formula:'5+4d20',range:[9,85]},{name:'魅惑',formula:'5+3d20',range:[8,65]},{name:'恐吓',formula:'5+3d20',range:[8,65]},{name:'图书馆使用',formula:'5+3d20',range:[8,65]},{name:'急救',formula:'5+3d20',range:[8,65]},{name:'神秘学',formula:'1+2d20',range:[3,41]},{name:'闪避',formula:'敏捷/2',range:[1,99]},{name:'SAN值',formula:'意志',range:[1,99]},{name:'克苏鲁神话',formula:'1d5',range:[1,5]}]},{format:'acu_attr_preset_v1',version:1,id:'dnd5e',name:'简化DND规则',builtin:!0,description:'基于龙与地下城第5版规则的属性预设。包含6条基本属性和8条特殊属性。',baseAttributes:[{name:'力量',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'敏捷',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'体质',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'智力',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'感知',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'},{name:'魅力',formula:'4d6dl1',range:[3,18],modifier:'1d4-2'}],specialAttributes:[{name:'察觉',formula:'8+2d6',range:[10,20]},{name:'隐匿',formula:'8+2d6',range:[10,20]},{name:'运动',formula:'5+2d6',range:[7,17]},{name:'巧手',formula:'5+2d6',range:[7,17]},{name:'洞悉',formula:'5+2d6',range:[7,17]},{name:'游说',formula:'5+2d6',range:[7,17]},{name:'奥秘',formula:'2+2d6',range:[4,14]},{name:'欺瞒',formula:'2+2d6',range:[4,14]}]}],W=(()=>{let e=null;return{getAllPresets(){if(e)return e;const t=Fe.get(k,[]);return e=[...H,...t],e},getActivePreset(){const e=Fe.get(C,null);return e&&this.getAllPresets().find(t=>t.id===e)||null},setActivePreset(t){try{const a=''===t||void 0===t?null:t;return Fe.set(C,a),e=null,console.log('[AttributePresetManager] 切换预设:',a),!0}catch(e){return console.error('[AttributePresetManager] 设置预设失败:',e),!1}},createPreset(t){const a=Fe.get(k,[]),n={...t,id:t.id||'custom_'+Date.now(),builtin:!1,createdAt:(new Date).toISOString()};return a.push(n),Fe.set(k,a),e=null,console.log('[AttributePresetManager] 创建预设:',n.name),n},updatePreset(t,a){const n=Fe.get(k,[]),i=n.findIndex(e=>e.id===t);return!(i<0)&&(n[i]={...n[i],...a},Fe.set(k,n),e=null,console.log('[AttributePresetManager] 更新预设:',t),!0)},deletePreset(t){const a=Fe.get(k,[]),n=a.filter(e=>e.id!==t);return n.length!==a.length&&(Fe.set(k,n),e=null,Fe.get(C)===t&&Fe.set(C,null),console.log('[AttributePresetManager] 删除预设:',t),!0)},exportPreset(e){const t=this.getAllPresets().find(t=>t.id===e);if(!t)return null;const a={format:'acu_attr_preset_v1',version:1,...t};return delete a.builtin,JSON.stringify(a,null,2)},importPreset(e){try{const t=JSON.parse(e);if('acu_attr_preset_v1'!==t.format)throw new Error('不支持的预设格式');if(!t.name||!t.baseAttributes||!Array.isArray(t.baseAttributes))throw new Error('预设数据不完整');const a={...t,id:'imported_'+Date.now(),builtin:!1,createdAt:(new Date).toISOString()};return this.createPreset(a)}catch(e){return console.error('[AttributePresetManager] 导入失败:',e),null}},clearCache(){e=null}}})(),K=e=>{const t=e.match(/^(\d+)d(\d+)(kh\d+|kl\d+|dh\d+|dl\d+)?$/i);if(!t)return NaN;const[,a,n,i]=t,o=parseInt(a,10),r=parseInt(n,10);let c=Array.from({length:o},()=>(e=>Math.floor(Math.random()*e)+1)(r));if(i){const e=i.toLowerCase(),t=parseInt(e.slice(2),10);c.sort((e,t)=>t-e),e.startsWith('kh')?c=c.slice(0,t):e.startsWith('kl')?c=c.slice(-t):e.startsWith('dh')?c=c.slice(t):e.startsWith('dl')&&(c=c.slice(0,-t))}return c.reduce((e,t)=>e+t,0)},G=(e,t,a)=>{let n=((e,t={})=>{if(!e)return 0;let a=String(e).trim();const n=Object.keys(t).sort((e,t)=>t.length-e.length);for(const e of n){const n=t[e];'number'!=typeof n||isNaN(n)||(a=a.split(e).join(`(${n})`))}if(a=a.replace(/\d+d\d+(kh\d+|kl\d+|dh\d+|dl\d+)?/gi,e=>{const t=K(e);return isNaN(t)?'0':String(t)}),!/^[\d\s+\-*/().]+$/.test(a))return console.warn('[evaluateFormula] 公式包含非法字符:',e,'→',a),0;try{const e=new Function(`return (${a})`)();return Math.round(e)}catch(t){return console.error('[evaluateFormula] 公式计算失败:',e,'→',a,t),0}})(e,a);return t&&Array.isArray(t)&&2===t.length&&(n=Math.max(t[0],Math.min(t[1],n))),n},Q={global:{tableKeywords:['全局数据表','全局数据','全局'],columns:{detailLocation:{keywords:['当前详细地点','详细地点','具体位置','当前位置'],fallbackIndex:null},currentLocation:{keywords:['当前次要地区','当前所在地点','当前地点','所在地点'],fallbackIndex:2}}},player:{tableKeywords:['主角信息','主角','玩家','角色信息','player','用户','user','<user>'],columns:{name:{keywords:['姓名','名称','人物名称','name'],fallbackIndex:1},status:{keywords:['状态关键词','状态关键字','状态标签','状态'],fallbackIndex:null},position:{keywords:['具体位置','位置','所在地'],fallbackIndex:null},attrs:{keywords:['基础属性','属性'],fallbackIndex:null,isMultiple:!0},money:{keywords:['金钱','资金','金币','货币','余额','灵石','积分','代币','信用点'],fallbackIndex:null},resources:{keywords:['资源数据','资源','resources'],fallbackIndex:null}}},location:{tableKeywords:['世界地图点','地图点','地图','地点','地点表','地图表','场景','区域','秘境','副本','洞府','空间','位面','界域'],columns:{name:{keywords:['详细地点','具体位置','当前地点','次要地区','主要地区','地区','地点名','名称'],fallbackIndex:1},description:{keywords:['环境描述','描述','说明','介绍','氛围描述'],fallbackIndex:null}}},npc:{tableKeywords:['重要人物表','重要人物','NPC','人物表','人物','角色表','角色','character','弟子','成员','队友','伙伴','宠物','灵宠'],columns:{name:{keywords:['姓名','名称'],fallbackIndex:1},status:{keywords:['自身状态','状态'],fallbackIndex:null},position:{keywords:['具体位置','位置'],fallbackIndex:null},inScene:{keywords:['在场状态','在场','是否离场','离场'],fallbackIndex:null}}},quest:{tableKeywords:['任务表','备忘事项','任务','事项','目标','待办','主线','支线','委托','悬赏'],columns:{name:{keywords:['事项名称','任务名','名称'],fallbackIndex:1},type:{keywords:['类型','分类','事项类型'],fallbackIndex:2},progress:{keywords:['进度','完成度','进度/结果'],fallbackIndex:5},status:{keywords:['状态'],fallbackIndex:6}},filters:{active:{column:'status',includes:['活跃','进行中','进行'],excludeColumn:'type',excludes:['规则']}}},bag:{tableKeywords:['背包物品','背包','物品','道具','库存','储物袋','空间戒指','持有物品表'],columns:{name:{keywords:['物品名称','名称','物品名'],fallbackIndex:1},type:{keywords:['类型','分类','物品类型'],fallbackIndex:2},count:{keywords:['数量','个数','持有数'],fallbackIndex:3}}},skill:{tableKeywords:['主角技能','技能表','技能','能力','魔法','超能力','异能','神通','道法','功法','血脉','天赋','义体改造','超凡能力','词条'],columns:{name:{keywords:['技能名称','名称','技能名'],fallbackIndex:1},type:{keywords:['类型','分类'],fallbackIndex:2},level:{keywords:['等级','级别','熟练度','lv'],fallbackIndex:3}}},equip:{tableKeywords:['装备表','装备','武器','防具','法宝','灵器','仙器','神器','义体','神装'],columns:{name:{keywords:['装备名称','名称','装备名'],fallbackIndex:1},type:{keywords:['类型','分类'],fallbackIndex:2},part:{keywords:['部位','装备部位','位置'],fallbackIndex:3},isEquipped:{keywords:['状态','是否装备','装备状态','装备中'],fallbackIndex:4}},filters:{equipped:{column:'isEquipped',includes:['已装备','装备中','true','是','yes','equipped']}}}},Z={findTable(e,t){const a=Q[t];if(!a)return null;for(const t of a.tableKeywords)for(const n in e)if(n.includes(t))return{data:e[n],name:n,key:e[n].key,config:a};return null},findColumnIndex(e,t,a){const n=a.columns[t];if(!n)return-1;for(let t=0;t<e.length;t++){const a=String(e[t]||'').toLowerCase();if(n.keywords.some(e=>a.includes(e.toLowerCase())))return t}return n.fallbackIndex??-1},getValue(e,t,a,n){const i=this.findColumnIndex(t,a,n);return i<0||i>=e.length?null:e[i]},getColumnMap(e,t){const a=Q[t];if(!a)return{};const n={};for(const t in a.columns)n[t]=this.findColumnIndex(e,t,a);return n},parseRows(e,t){if(!e||!e.data)return[];const{data:a,config:n}=e,i=a.headers||[],o=a.rows||[],r=this.getColumnMap(i,t);return o.map((e,t)=>{const a={_rowIndex:t,_raw:e};for(const t in r){const n=r[t];a[t]=n>=0&&n<e.length?e[n]:null}return a})},applyFilter(e,t,a){const n=Q[a];if(!n||!n.filters||!n.filters[t])return e;const i=n.filters[t];return e.some(e=>null!==e[i.column]&&void 0!==e[i.column])?e.filter(e=>{const t=String(e[i.column]||'').toLowerCase(),a=i.includes.some(e=>t.includes(e.toLowerCase()));if(i.excludeColumn&&i.excludes){const t=String(e[i.excludeColumn]||'').toLowerCase(),n=i.excludes.some(e=>t.includes(e.toLowerCase()));return a&&!n}return a}):e}},ee={enabled:!0,diceSystem:'1d100',showDiceIcon:!0,autoSendPrompt:!0,action_groups:[{table_keywords:['地点','地图','Location','Map','世界','场所'],actions:[{label:'前往',icon:'fa-walking',type:'prompt',template:'<user>前往{Name}。',auto_send:!0},{label:'探索',icon:'fa-search',type:'prompt',template:'<user>探索{Name}。',auto_send:!0},{label:'停留',icon:'fa-clock',type:'prompt',template:'<user>在{Name}停留。',auto_send:!0}]},{table_keywords:['人物','NPC','重要人物','角色','女主'],actions:[{label:'交谈',icon:'fa-comments',type:'prompt',template:'<user>与{Name}交谈。',auto_send:!0},{label:'观察',icon:'fa-eye',type:'prompt',template:'<user>观察{Name}。',auto_send:!0},{label:'战斗',icon:'fa-hand-fist',type:'prompt',template:'<user>与{Name}战斗。',auto_send:!0}]},{table_keywords:['物品','背包','道具'],actions:[{label:'使用',icon:'fa-hand-pointer',type:'prompt',template:'<user>使用了{Name}。',auto_send:!0},{label:'查看',icon:'fa-eye',type:'prompt',template:'<user>查看了{Name}。',auto_send:!0},{label:'丢弃',icon:'fa-trash',type:'prompt',template:'<user>丢弃了{Name}。',auto_send:!0}]},{table_keywords:['装备','武器','防具'],actions:[{label:'装备',icon:'fa-shield-halved',type:'prompt',template:'<user>装备了{Name}。',auto_send:!0},{label:'卸下',icon:'fa-circle-xmark',type:'prompt',template:'<user>卸下了{Name}。',auto_send:!0},{label:'卖出',icon:'fa-coins',type:'prompt',template:'<user>卖出了{Name}。',auto_send:!0}]},{table_keywords:['技能','能力'],actions:[{label:'使用',icon:'fa-wand-magic-sparkles',type:'skill_check',template:'<user>使用{Name}。',auto_send:!0},{label:'练习',icon:'fa-dumbbell',type:'prompt',template:'<user>练习{Name}。',auto_send:!0}]},{table_keywords:['备忘','任务','事项'],actions:[{label:'追踪',icon:'fa-crosshairs',type:'prompt',template:'<user>将{Name}设为当前追踪目标。',auto_send:!0},{label:'整理',icon:'fa-list-check',type:'prompt',template:'<user>整理关于{Name}的信息。',auto_send:!0},{label:'放弃',icon:'fa-circle-xmark',type:'prompt',template:'<user>放弃了{Name}。',auto_send:!0}]},{table_keywords:['势力','组织','阵营'],actions:[{label:'打探',icon:'fa-ear-listen',type:'prompt',template:'<user>打探{Name}的情报。',auto_send:!0},{label:'加入',icon:'fa-user-plus',type:'prompt',template:'<user>申请加入{Name}。',auto_send:!0},{label:'合作',icon:'fa-handshake',type:'prompt',template:'<user>向{Name}请求合作。',auto_send:!0}]}]},te={retro:{bgPanel:'#e6e2d3',border:'#dcd0c0',textMain:'#5e4b35',textSub:'#8a7a6a',btnBg:'#dcd0c0',btnHover:'#cbbba8',accent:'#7a695f',tableHead:'#efebe4',successText:'#27ae60',successBg:'rgba(39, 174, 96, 0.15)',inputBg:'#f5f2eb',inputText:'#5e4b35',placeholderText:'#a09080',btnActiveBg:'#8d7b6f',btnActiveText:'#fdfaf5',failureText:'#e74c3c',failureBg:'rgba(231, 76, 60, 0.15)',warningText:'#f39c12',warningBg:'rgba(243, 156, 18, 0.15)',critSuccessText:'#9b59b6',critSuccessBg:'rgba(155, 89, 182, 0.15)',critFailureText:'#c0392b',critFailureBg:'rgba(192, 57, 43, 0.15)',extremeSuccessText:'#2980b9',extremeSuccessBg:'rgba(41, 128, 185, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#e74c3c',errorBg:'rgba(231, 76, 60, 0.15)',errorBorder:'rgba(231, 76, 60, 0.5)',warningIcon:'#e67e22'},dark:{bgPanel:'rgba(30, 30, 30, 0.98)',border:'#444',textMain:'#eee',textSub:'#999',btnBg:'rgba(60, 60, 60, 0.9)',btnHover:'#505050',accent:'#9b8cd9',tableHead:'rgba(45, 45, 45, 0.95)',successText:'#4cd964',successBg:'rgba(76, 217, 100, 0.2)',inputBg:'rgba(50, 50, 50, 0.95)',inputText:'#eee',placeholderText:'#777',btnActiveBg:'#6a5acd',btnActiveText:'#fff',failureText:'#ff6b6b',failureBg:'rgba(255, 107, 107, 0.2)',warningText:'#ffa726',warningBg:'rgba(255, 167, 38, 0.2)',critSuccessText:'#ba68c8',critSuccessBg:'rgba(186, 104, 200, 0.2)',critFailureText:'#d32f2f',critFailureBg:'rgba(211, 47, 47, 0.2)',extremeSuccessText:'#42a5f5',extremeSuccessBg:'rgba(66, 165, 245, 0.2)',overlayBg:'rgba(0,0,0,0.75)',overlayBgLight:'rgba(0,0,0,0.65)',shadowBg:'rgba(0,0,0,0.6)',lightBg:'rgba(255,255,255,0.05)',veryLightBg:'rgba(255,255,255,0.02)',buttonText:'#fff',grayBg:'rgba(255,255,255,0.1)',errorText:'#ff6b6b',errorBg:'rgba(255, 107, 107, 0.2)',errorBorder:'rgba(255, 107, 107, 0.5)',warningIcon:'#ffa726'},modern:{bgPanel:'#f8f9fa',border:'#e0e0e0',textMain:'#333',textSub:'#666',btnBg:'#e9ecef',btnHover:'#dee2e6',accent:'#007bff',tableHead:'#f1f3f5',successText:'#28a745',successBg:'rgba(40, 167, 69, 0.15)',inputBg:'#fff',inputText:'#333',placeholderText:'#999',btnActiveBg:'#007bff',btnActiveText:'#fff',failureText:'#dc3545',failureBg:'rgba(220, 53, 69, 0.15)',warningText:'#ffc107',warningBg:'rgba(255, 193, 7, 0.15)',critSuccessText:'#6f42c1',critSuccessBg:'rgba(111, 66, 193, 0.15)',critFailureText:'#c82333',critFailureBg:'rgba(200, 35, 51, 0.15)',extremeSuccessText:'#17a2b8',extremeSuccessBg:'rgba(23, 162, 184, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#dc3545',errorBg:'rgba(220, 53, 69, 0.15)',errorBorder:'rgba(220, 53, 69, 0.5)',warningIcon:'#fd7e14'},forest:{bgPanel:'#e8f5e9',border:'#a5d6a7',textMain:'#2e7d32',textSub:'#66bb6a',btnBg:'#c8e6c9',btnHover:'#a5d6a7',accent:'#43a047',tableHead:'#dcedc8',successText:'#2e7d32',successBg:'rgba(46, 125, 50, 0.2)',inputBg:'#f1f8e9',inputText:'#2e7d32',placeholderText:'#81c784',btnActiveBg:'#43a047',btnActiveText:'#fff',failureText:'#c62828',failureBg:'rgba(198, 40, 40, 0.15)',warningText:'#f57c00',warningBg:'rgba(245, 124, 0, 0.15)',critSuccessText:'#7b1fa2',critSuccessBg:'rgba(123, 31, 162, 0.15)',critFailureText:'#b71c1c',critFailureBg:'rgba(183, 28, 28, 0.15)',extremeSuccessText:'#0277bd',extremeSuccessBg:'rgba(2, 119, 189, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#c62828',errorBg:'rgba(198, 40, 40, 0.15)',errorBorder:'rgba(198, 40, 40, 0.5)',warningIcon:'#e67e22'},ocean:{bgPanel:'#e3f2fd',border:'#90caf9',textMain:'#1565c0',textSub:'#42a5f5',btnBg:'#bbdefb',btnHover:'#90caf9',accent:'#1976d2',tableHead:'#bbdefb',successText:'#0288d1',successBg:'rgba(2, 136, 209, 0.15)',inputBg:'#e1f5fe',inputText:'#1565c0',placeholderText:'#64b5f6',btnActiveBg:'#1976d2',btnActiveText:'#fff',failureText:'#d32f2f',failureBg:'rgba(211, 47, 47, 0.15)',warningText:'#f57c00',warningBg:'rgba(245, 124, 0, 0.15)',critSuccessText:'#7b1fa2',critSuccessBg:'rgba(123, 31, 162, 0.15)',critFailureText:'#b71c1c',critFailureBg:'rgba(183, 28, 28, 0.15)',extremeSuccessText:'#0277bd',extremeSuccessBg:'rgba(2, 119, 189, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(0,0,0,0.1)',veryLightBg:'rgba(0,0,0,0.02)',buttonText:'#fff',grayBg:'rgba(128,128,128,0.1)',errorText:'#d32f2f',errorBg:'rgba(211, 47, 47, 0.15)',errorBorder:'rgba(211, 47, 47, 0.5)',warningIcon:'#f57c00'},cyber:{bgPanel:'#0a0a0a',border:'#00ffcc33',textMain:'#00ffcc',textSub:'#00cc99',btnBg:'rgba(0, 255, 204, 0.1)',btnHover:'rgba(0, 255, 204, 0.2)',accent:'#00ffcc',tableHead:'rgba(0, 255, 204, 0.05)',successText:'#0f0',successBg:'rgba(0, 255, 0, 0.15)',inputBg:'rgba(0, 0, 0, 0.6)',inputText:'#00ffcc',placeholderText:'#006655',btnActiveBg:'#ff00ff',btnActiveText:'#fff',failureText:'#ff0066',failureBg:'rgba(255, 0, 102, 0.2)',warningText:'#ffaa00',warningBg:'rgba(255, 170, 0, 0.2)',critSuccessText:'#ff00ff',critSuccessBg:'rgba(255, 0, 255, 0.2)',critFailureText:'#ff0000',critFailureBg:'rgba(255, 0, 0, 0.2)',extremeSuccessText:'#00ffff',extremeSuccessBg:'rgba(0, 255, 255, 0.2)',overlayBg:'rgba(0,0,0,0.8)',overlayBgLight:'rgba(0,0,0,0.7)',shadowBg:'rgba(0,255,204,0.3)',lightBg:'rgba(0,255,204,0.05)',veryLightBg:'rgba(0,255,204,0.02)',buttonText:'#fff',grayBg:'rgba(0,255,204,0.1)',buttonBg:'rgba(0, 200, 150, 0.6)',buttonBgActive:'rgba(0, 180, 130, 0.7)',presetButtonBg:'rgba(0, 200, 150, 0.3)',presetButtonBgActive:'rgba(0, 200, 150, 0.6)',errorText:'#ff0066',errorBg:'rgba(255, 0, 102, 0.2)',errorBorder:'rgba(255, 0, 102, 0.5)',warningIcon:'#ffaa00'},nightowl:{bgPanel:'#011627',border:'#132e45',textMain:'#e0e6f2',textSub:'#a6b8cc',btnBg:'#1f3a52',btnHover:'#2a4a68',accent:'#7fdbca',tableHead:'#0a2133',successText:'#addb67',successBg:'rgba(173, 219, 103, 0.15)',inputBg:'#00101c',inputText:'#e0e6f2',placeholderText:'#6a8090',btnActiveBg:'#7fdbca',btnActiveText:'#011627',failureText:'#ff6b6b',failureBg:'rgba(255, 107, 107, 0.2)',warningText:'#ffa726',warningBg:'rgba(255, 167, 38, 0.2)',critSuccessText:'#c792ea',critSuccessBg:'rgba(199, 146, 234, 0.2)',critFailureText:'#ef5350',critFailureBg:'rgba(239, 83, 80, 0.2)',extremeSuccessText:'#82aaff',extremeSuccessBg:'rgba(130, 170, 255, 0.2)',overlayBg:'rgba(0,0,0,0.75)',overlayBgLight:'rgba(0,0,0,0.65)',shadowBg:'rgba(0,0,0,0.6)',lightBg:'rgba(255,255,255,0.05)',veryLightBg:'rgba(255,255,255,0.02)',buttonText:'#fff',grayBg:'rgba(255,255,255,0.1)',buttonBg:'rgba(127, 219, 202, 0.4)',buttonBgActive:'rgba(127, 219, 202, 0.5)',presetButtonBg:'rgba(127, 219, 202, 0.2)',presetButtonBgActive:'rgba(127, 219, 202, 0.4)',errorText:'#ff6b6b',errorBg:'rgba(255, 107, 107, 0.2)',errorBorder:'rgba(255, 107, 107, 0.5)',warningIcon:'#ffa726'},sakura:{bgPanel:'#F9F0EF',border:'#EBDCD9',textMain:'#6B5552',textSub:'#C08D8D',btnBg:'#EBDCD9',btnHover:'#D8C7C4',accent:'#C08D8D',tableHead:'#F9F0EF',successText:'#6B5552',successBg:'rgba(192, 141, 141, 0.12)',inputBg:'#F9F0EF',inputText:'#6B5552',placeholderText:'#C08D8D',btnActiveBg:'#C08D8D',btnActiveText:'#F9F0EF',failureText:'#9B7A7A',failureBg:'rgba(155, 122, 122, 0.12)',warningText:'#A68A7A',warningBg:'rgba(166, 138, 122, 0.12)',critSuccessText:'#8B7A7A',critSuccessBg:'rgba(139, 122, 122, 0.12)',critFailureText:'#8B6F6F',critFailureBg:'rgba(139, 111, 111, 0.12)',extremeSuccessText:'#9B8A8A',extremeSuccessBg:'rgba(155, 138, 138, 0.12)',overlayBg:'rgba(107, 85, 82, 0.6)',overlayBgLight:'rgba(107, 85, 82, 0.5)',shadowBg:'rgba(107, 85, 82, 0.3)',lightBg:'rgba(192, 141, 141, 0.08)',veryLightBg:'rgba(192, 141, 141, 0.02)',buttonText:'#F9F0EF',grayBg:'rgba(192, 141, 141, 0.08)',buttonBg:'rgba(192, 141, 141, 0.4)',buttonBgActive:'rgba(192, 141, 141, 0.5)',presetButtonBg:'rgba(192, 141, 141, 0.2)',presetButtonBgActive:'rgba(192, 141, 141, 0.4)',errorText:'#9B7A7A',errorBg:'rgba(155, 122, 122, 0.12)',errorBorder:'rgba(155, 122, 122, 0.4)',warningIcon:'#A68A7A'},minepink:{bgPanel:'#1a1a1a',border:'#333333',textMain:'#ffb3d9',textSub:'#ff80c1',btnBg:'#2a2a2a',btnHover:'#3a3a3a',accent:'#ff80c1',tableHead:'#252525',successText:'#ff80c1',successBg:'rgba(255, 128, 193, 0.2)',inputBg:'#222222',inputText:'#ffb3d9',placeholderText:'#666666',btnActiveBg:'#ff80c1',btnActiveText:'#1a1a1a',failureText:'#ff6b6b',failureBg:'rgba(255, 107, 107, 0.2)',warningText:'#ffa726',warningBg:'rgba(255, 167, 38, 0.2)',critSuccessText:'#ff80c1',critSuccessBg:'rgba(255, 128, 193, 0.2)',critFailureText:'#ff4444',critFailureBg:'rgba(255, 68, 68, 0.2)',extremeSuccessText:'#ffb3d9',extremeSuccessBg:'rgba(255, 179, 217, 0.2)',overlayBg:'rgba(0,0,0,0.8)',overlayBgLight:'rgba(0,0,0,0.7)',shadowBg:'rgba(0,0,0,0.6)',lightBg:'rgba(255, 128, 193, 0.1)',veryLightBg:'rgba(255, 128, 193, 0.02)',buttonText:'#1a1a1a',grayBg:'rgba(255, 128, 193, 0.1)',buttonBg:'rgba(255, 128, 193, 0.7)',buttonBgActive:'rgba(255, 128, 193, 0.8)',presetButtonBg:'rgba(255, 128, 193, 0.2)',presetButtonBgActive:'rgba(255, 128, 193, 0.4)',errorText:'#ff6b6b',errorBg:'rgba(255, 107, 107, 0.2)',errorBorder:'rgba(255, 107, 107, 0.5)',warningIcon:'#ffa726'},purple:{bgPanel:'#f3e5f5',border:'#ce93d8',textMain:'#6a1b9a',textSub:'#9c27b0',btnBg:'#e1bee7',btnHover:'#ce93d8',accent:'#9c27b0',tableHead:'#f8e1f5',successText:'#6a1b9a',successBg:'rgba(106, 27, 154, 0.15)',inputBg:'#fce4ec',inputText:'#6a1b9a',placeholderText:'#ba68c8',btnActiveBg:'#9c27b0',btnActiveText:'#fff',failureText:'#d32f2f',failureBg:'rgba(211, 47, 47, 0.15)',warningText:'#f57c00',warningBg:'rgba(245, 124, 0, 0.15)',critSuccessText:'#7b1fa2',critSuccessBg:'rgba(123, 31, 162, 0.15)',critFailureText:'#b71c1c',critFailureBg:'rgba(183, 28, 28, 0.15)',extremeSuccessText:'#6a1b9a',extremeSuccessBg:'rgba(106, 27, 154, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.4)',lightBg:'rgba(156, 39, 176, 0.1)',veryLightBg:'rgba(156, 39, 176, 0.02)',buttonText:'#fff',grayBg:'rgba(156, 39, 176, 0.1)',buttonBg:'rgba(156, 39, 176, 0.6)',buttonBgActive:'rgba(156, 39, 176, 0.7)',presetButtonBg:'rgba(156, 39, 176, 0.3)',presetButtonBgActive:'rgba(156, 39, 176, 0.6)',errorText:'#d32f2f',errorBg:'rgba(211, 47, 47, 0.15)',errorBorder:'rgba(211, 47, 47, 0.5)',warningIcon:'#f57c00'},wechat:{bgPanel:'#F7F7F7',border:'#E5E5E5',textMain:'#333333',textSub:'#666666',btnBg:'#E5E5E5',btnHover:'#D5D5D5',accent:'#09B83E',tableHead:'#F0F0F0',successText:'#09B83E',successBg:'rgba(9, 184, 62, 0.12)',inputBg:'#FFFFFF',inputText:'#333333',placeholderText:'#999999',btnActiveBg:'#09B83E',btnActiveText:'#FFFFFF',failureText:'#E53E3E',failureBg:'rgba(229, 62, 62, 0.12)',warningText:'#FF9500',warningBg:'rgba(255, 149, 0, 0.12)',critSuccessText:'#07A832',critSuccessBg:'rgba(7, 168, 50, 0.15)',critFailureText:'#C53030',critFailureBg:'rgba(197, 48, 48, 0.15)',extremeSuccessText:'#09B83E',extremeSuccessBg:'rgba(9, 184, 62, 0.15)',overlayBg:'rgba(0,0,0,0.6)',overlayBgLight:'rgba(0,0,0,0.5)',shadowBg:'rgba(0,0,0,0.2)',lightBg:'rgba(9, 184, 62, 0.08)',veryLightBg:'rgba(9, 184, 62, 0.02)',buttonText:'#FFFFFF',grayBg:'rgba(9, 184, 62, 0.08)',buttonBg:'rgba(9, 184, 62, 0.7)',buttonBgActive:'rgba(9, 184, 62, 0.85)',presetButtonBg:'rgba(9, 184, 62, 0.3)',presetButtonBgActive:'rgba(9, 184, 62, 0.6)',errorText:'#E53E3E',errorBg:'rgba(229, 62, 62, 0.12)',errorBorder:'rgba(229, 62, 62, 0.5)',warningIcon:'#FF9500'}},ae=()=>{const e=te[$t().theme]||te.retro;return e.buttonBg||(e.buttonBg=e.accent,e.buttonBgActive=e.accent,e.presetButtonBg=e.btnBg,e.presetButtonBgActive=e.accent),e},ne=(e,t)=>{const a={critSuccess:{bg:t.critSuccessText,text:'#fff'},extremeSuccess:{bg:t.extremeSuccessText,text:'#fff'},success:{bg:t.successText,text:'#fff'},warning:{bg:t.warningText,text:'#fff'},failure:{bg:t.failureText,text:'#fff'},critFailure:{bg:t.critFailureText,text:'#fff'}},n=a[e]||a.failure;return{'background-color':n.bg,color:n.text,padding:'3px 8px','border-radius':'6px','font-size':'11px','font-weight':'bold','white-space':'nowrap',display:'inline-flex','align-items':'center'}},ie=e=>{const t=Fe.get('acu_gm_engine_config_v1',ee);if(!t.enabled||!t.action_groups)return[];const a=e.toLowerCase();for(const e of t.action_groups){if(e.table_keywords.some(e=>a.includes(e.toLowerCase())))return e.actions||[]}return[]},oe=e=>{if(null==e||''===e)return!1;const t=String(e).trim();return/^-?\d+(\.\d+)?%?$/.test(t)||/^\d+\/\d+$/.test(t)||/^[\u4e00-\u9fa5a-zA-Z]+[:\s：]\s*\d+/i.test(t)||/\d+/.test(t)},re=e=>{if(!e)return 0;const t=String(e).trim();if(/^\d+\/\d+$/.test(t))return parseInt(t.split('/')[0],10);if(t.endsWith('%'))return parseInt(t.replace('%',''),10);const a=t.match(/\d+/g);return a&&a.length>0?parseInt(a[a.length-1],10):0},ce=e=>{if(!e)return[];const t=[],a=String(e).trim();if(a.startsWith('{')&&a.endsWith('}'))try{const e=JSON.parse(a);for(const a in e){const n=e[a];'number'==typeof n?t.push({name:a,value:n}):'string'==typeof n&&/^\d+$/.test(n)&&t.push({name:a,value:parseInt(n,10)})}if(t.length>0)return t}catch(e){}const n=a.split(/[,;，；\s]+/);for(const e of n){const a=e.match(/^"?([\u4e00-\u9fa5a-zA-Z_]+)"?[:\s：]\s*"?(-?\d+)"?/);a&&t.push({name:a[1],value:parseInt(a[2],10)})}return t},se=e=>{if(!e)return[];const t=[],a=String(e).trim().split(/[;；]/);for(const e of a){const a=e.trim();if(!a)continue;const n=a.match(/^与?(.+?)[:：](.+)$/);if(n){const e=n[1].trim(),a=n[2].trim();if(e&&a){t.push({name:e,relation:a});continue}}const i=a.match(/^([^(（]+)[(（]([^)）]+)[)）]$/);i?t.push({name:i[1].trim(),relation:i[2].trim()}):a.length>0&&t.push({name:a,relation:''})}return t},le=(e,t)=>{if(!e)return!1;const a=String(e).trim(),n=(t||'').toLowerCase();return!(!n.includes('关系')&&!n.includes('人际'))||/^[^(（;；]+[(（][^)）]+[)）]([;；][^(（;；]+[(（][^)）]+[)）])*$/.test(a)},de=(e,t,a)=>{if(!e||!t)return e;let n=e;const i=t[1]||'未知';return n=n.replace(/\{Name\}/gi,i),n=n.replace(/\{RowIndex\}/gi,t[0]||'0'),a&&a.length>0&&a.forEach((e,a)=>{if(e&&a<t.length){const i=t[a]||'未知',o=new RegExp(`\\{${e}\\}`,'gi');n=n.replace(o,i)}}),n=n.replace(/\{[^}]+\}/g,'未知'),n},ue=[{id:'acu-btn-save-global',icon:'fa-save',title:'保存所有修改'},{id:'acu-btn-refresh',icon:'fa-sync-alt',title:'重新加载'},{id:'acu-btn-collapse',icon:'fa-chevron-down',title:'收起面板'},{id:'acu-btn-refill',icon:'fa-bolt',title:'重新填表'},{id:'acu-btn-settings',icon:'fa-cog',title:'全能设置'}];let pe=!1,ge=!1,fe=!1,be=!1,me=new Set,he=null,ve=null,xe=null,ye=!1,we={},ke={},$e=null,_e=!1;const Ce='acu_scroll_v19_fixed';let Se={};try{const e=localStorage.getItem(Ce);e&&(Se=JSON.parse(e))}catch(e){console.warn('[ACU] Error:',e)}const Te={_lastValidationCount:0,_isRollingBack:!1,handleUpdate:()=>{if(!Te._isRollingBack){try{const e=Je(),t=zt();if(e&&t){const a=N.getEnabledRules(),n=D.checkTableRules(e,t,a);if(n.length>0){console.warn('[ACU] 规则拦截触发，执行回滚:',n),Te._isRollingBack=!0;const t=Pe().getDB();return t?.fillTable&&(t.fillTable(e),window.toastr&&window.toastr.error(n[0].message,'已回滚',{timeOut:5e3,positionClass:'toast-bottom-right'})),void setTimeout(()=>{Te._isRollingBack=!1},500)}}}catch(e){console.error('[ACU] 拦截检查失败:',e)}Lt(),setTimeout(()=>{try{const e=xe||zt();if(e){const t=D.validateAllData(e).length;Te._lastValidationCount,Te._lastValidationCount=t,ze(t)}}catch(e){console.error('[ACU] 验证执行失败:',e)}},100)}}},ze=e=>{const{$}=Pe(),t=$('.acu-validation-indicator');e>0?t.length&&(t.find('.acu-validation-count').text(e),t.show()):t.hide()},Ae=()=>{try{if('undefined'!=typeof SillyTavern&&SillyTavern.getCurrentChatId)return SillyTavern.getCurrentChatId();if('undefined'!=typeof SillyTavern&&SillyTavern.chatId)return SillyTavern.chatId;if(window.parent?.SillyTavern?.getCurrentChatId)return window.parent.SillyTavern.getCurrentChatId()}catch(e){console.warn('[ACU] getCurrentContextFingerprint error:',e)}return'unknown_context'},Ie={layout:'horizontal',collapseStyle:'bar',collapseAlign:'right',fontFamily:'default',theme:'retro',cardWidth:260,fontSize:13,highlightNew:!0,itemsPerPage:50,actionsPosition:'bottom',gridColumns:'auto',positionMode:'fixed',showOptionPanel:!0,clickOptionToAutoSend:!0,optionFontSize:12},Me=[{id:'default',name:'系统默认 (Modern)',val:'\'Segoe UI\', \'Microsoft YaHei\', sans-serif'},{id:'hanchan',name:'寒蝉全圆体',val:'"寒蝉全圆体", sans-serif'},{id:'maple',name:'Maple Mono (代码风)',val:'"Maple Mono NF CN", monospace'},{id:'huiwen',name:'汇文明朝体 (Huiwen)',val:'"Huiwen-mincho", serif'},{id:'cooper',name:'Cooper正楷',val:'"CooperZhengKai", serif'},{id:'yffyt',name:'YFFYT (艺术体)',val:'"YFFYT", sans-serif'},{id:'fusion',name:'Fusion Pixel (像素风)',val:'"Fusion Pixel 12px M latin", monospace'},{id:'wenkai',name:'霞鹜文楷 (WenKai)',val:'"LXGW WenKai", serif'},{id:'notosans',name:'思源黑体 (Noto Sans)',val:'"Noto Sans CJK", sans-serif'},{id:'zhuque',name:'朱雀仿宋 (Zhuque)',val:'"Zhuque Fangsong (technical preview)", serif'}],Be=[{id:'retro',name:'复古羊皮 (Retro)',icon:'fa-scroll'},{id:'dark',name:'极夜深空 (Dark)',icon:'fa-moon'},{id:'modern',name:'现代清爽 (Modern)',icon:'fa-sun'},{id:'forest',name:'森之物语 (Forest)',icon:'fa-tree'},{id:'ocean',name:'深海幽蓝 (Ocean)',icon:'fa-water'},{id:'cyber',name:'赛博霓虹 (Cyber)',icon:'fa-bolt'},{id:'nightowl',name:'深蓝磨砂 (Night Owl)',icon:'fa-feather'},{id:'sakura',name:'暖粉手账 (Warm Pink)',icon:'fa-heart'},{id:'minepink',name:'地雷量产 (Mine Pink)',icon:'fa-skull'},{id:'purple',name:'紫罗兰梦 (Purple)',icon:'fa-gem'},{id:'wechat',name:'绿色泡泡 (Green Bubble)',icon:'fa-weixin'}];let Ee=null;const Pe=()=>{const e=window.parent||window,$=window.jQuery||e.jQuery;if(Ee&&Ee.$)return Ee;const t={$,getDB:()=>e.AutoCardUpdaterAPI||window.AutoCardUpdaterAPI,clipboard:e.navigator.clipboard,ST:window.SillyTavern||e.SillyTavern||(()=>{try{return window.top?window.top.SillyTavern:null}catch(e){return null}})()};return $&&(Ee=t),t},Ne=()=>{const{$}=Pe(),e=$('#acu-btn-save-global'),t=e.find('i'),a=Le();let n=!1;if(a)for(const e in a)if(a[e]&&a[e].length>0){n=!0;break}ye||n?(t.addClass('acu-icon-breathe'),e.attr('title','你有未保存的手动修改或删除操作')):(t.removeClass('acu-icon-breathe'),e.attr('title','保存'),e.css('color',''))},De=e=>{if(!e)return'fa-table';const t=e.toLowerCase();return t.includes('主角')||t.includes('角色')?'fa-user-circle':t.includes('通用')||t.includes('全局')?'fa-globe-asia':t.includes('装备')||t.includes('背包')?'fa-briefcase':t.includes('技能')||t.includes('武魂')?'fa-dragon':t.includes('关系')||t.includes('周边')?'fa-user-friends':t.includes('任务')||t.includes('日志')?'fa-scroll':t.includes('人物')||t.includes('关键人物')?'fa-address-book':t.includes('总结')||t.includes('大纲')?'fa-book-reader':t.includes('地图点')||t.includes('世界地图')?'fa-map-location-dot':t.includes('地图元素')||t.includes('机关')||t.includes('线索')?'fa-bullseye':t.includes('势力')||t.includes('阵营')?'fa-shield-halved':t.includes('物品')?'fa-gem':t.includes('情报')||t.includes('信息')?'fa-file-lines':t.includes('选项')?'fa-list-check':'fa-table'},je=e=>{if(!e)return'';const t=String(e).trim();return/^[0-9]+%?$/.test(t)||/^Lv\.\d+$/.test(t)?'acu-badge-green':t.length<=6&&!t.includes('http')||['是','否','有','无','死亡','存活'].includes(t)?'acu-badge-neutral':''},Fe={get:(e,t=null)=>{try{return JSON.parse(localStorage.getItem(e))??t}catch{return t}},set:(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(a){if('QuotaExceededError'===a.name||a.message.includes('quota')){console.warn('[ACU] 存储空间已满，触发静默清理策略...');try{localStorage.removeItem(p),localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error('[ACU Store] 清理后依然失败',e),window.toastr&&!window._acuQuotaAlerted&&(window.toastr.warning('⚠️ 浏览器存储空间严重不足，配置保存失败'),window._acuQuotaAlerted=!0,setTimeout(()=>window._acuQuotaAlerted=!1,1e4))}}else console.error('[ACU Store]',a)}}},Oe=()=>Fe.get(d),Re=e=>Fe.set(d,e),Le=()=>Fe.get(l,{}),Ue=e=>Fe.set(l,e),Ve=()=>Fe.get(c),Ye=e=>Fe.set(c,e),qe=()=>Fe.get(g,!1),Xe=e=>Fe.set(g,e),Je=()=>{const e=Fe.get(p);if(!e)return null;const t=Ae();return e._contextId&&e._contextId!==t?null:e},He=e=>{e&&('object'==typeof e&&(e._contextId=Ae()),Fe.set(p,e))},We=()=>Fe.get(b,{}),Ke=e=>Fe.set(b,e),Ge=()=>Fe.get(m,{}),Qe=()=>Fe.get(h,[]),Ze=()=>Fe.get(v,[]),et=e=>{const t=Ze(),a=t.indexOf(e);var n;a>=0?t.splice(a,1):t.push(e),n=t,Fe.set(v,n),console.log('[ACU] toggleTableReverse:',e,'reversed:',a<0)},tt=e=>{const t=xe||zt();if(!t)return[];const a=!e||'<user>'===e||''===e.trim();for(const n in t){const i=t[n];if(!i||!i.name||!i.content)continue;const o=i.name;if(a&&(o.includes('主角')||o.includes('玩家')||o.toLowerCase().includes('player'))&&i.content[1]){const e=i.content[0]||[],t=i.content[1];let a=[];if(e.forEach((e,n)=>{if(e&&e.includes('属性')){ce(t[n]||'').forEach(e=>{a.includes(e.name)||a.push(e.name)})}}),a.length>0)return a}if(!a&&(o.includes('人物')||o.includes('NPC')||o.includes('角色')||o.toLowerCase().includes('character'))){const t=i.content[0]||[];let a=1;for(let e=0;e<t.length;e++)if(t[e]&&(t[e].includes('姓名')||t[e].includes('名称')||t[e].toLowerCase().includes('name'))){a=e;break}for(let n=1;n<i.content.length;n++){const o=i.content[n];if(o&&o[a]===e){let e=[];return t.forEach((t,a)=>{if(t&&t.includes('属性')){ce(o[a]||'').forEach(t=>{e.includes(t.name)||e.push(t.name)})}}),e}}}}return[]},at=(e,t)=>{const a=xe||zt();if(!a||!t)return null;const n=!e||'<user>'===e||''===e.trim();for(const i in a){const o=a[i];if(!o||!o.name||!o.content)continue;const r=o.name;if(n&&(r.includes('主角')||r.includes('玩家')||r.toLowerCase().includes('player'))&&o.content[1]){const e=o.content[0]||[],a=o.content[1];for(let n=0;n<e.length;n++){const i=e[n];if(i&&i.includes('属性')){const e=ce(a[n]||'').find(e=>e.name===t);if(e)return e.value}}}if(!n&&(r.includes('人物')||r.includes('NPC')||r.includes('角色')||r.toLowerCase().includes('character'))){const a=o.content[0]||[];let n=1;for(let e=0;e<a.length;e++)if(a[e]&&(a[e].includes('姓名')||a[e].includes('名称')||a[e].toLowerCase().includes('name'))){n=e;break}for(let i=1;i<o.content.length;i++){const r=o.content[i];if(r&&r[n]===e)for(let e=0;e<a.length;e++){const n=a[e];if(n&&n.includes('属性')){const a=ce(r[e]||'').find(e=>e.name===t);if(a)return a.value}}}}}return null},nt=['力量','敏捷','体质','智力','感知','魅力'],it=()=>{const e=W.getActivePreset();return e&&e.baseAttributes?e.baseAttributes.map(e=>e.name):nt},ot=()=>{try{const e=W.getActivePreset();if(e){const t=new Set;return e.baseAttributes&&Array.isArray(e.baseAttributes)&&e.baseAttributes.forEach(e=>{const a='string'==typeof e?e:e&&e.name;a&&t.add(a)}),e.specialAttributes&&Array.isArray(e.specialAttributes)&&e.specialAttributes.forEach(e=>{const a='string'==typeof e?e:e&&e.name;a&&t.add(a)}),Array.from(t)}const t=W.getAllPresets()||[],a=new Set(rt||[]);return Array.isArray(t)&&t.forEach(e=>{e&&(e.baseAttributes&&Array.isArray(e.baseAttributes)&&e.baseAttributes.forEach(e=>{const t='string'==typeof e?e:e&&e.name;t&&a.add(t)}),e.specialAttributes&&Array.isArray(e.specialAttributes)&&e.specialAttributes.forEach(e=>{const t='string'==typeof e?e:e&&e.name;t&&a.add(t)}))}),Array.from(a)}catch(e){return console.error('[ACU] getRandomSkillPool 错误:',e),rt||[]}},rt=['杂技','特技','运动','格斗','斗殴','攀爬','健康','闪避','身法','驾驶','耐力','灵巧','巧手','戏法','跑酷','飞行','潜行','渗透','骑术','游泳','投掷','跳跃','体操','功夫','武术','行政','官僚','权威','命令','交易','掮客','欺诈','诱骗','谎言侦测','狂欢','交际','摆布','镇定','黑话','行话','礼节','礼仪','信誉','财力','戏剧','表演','共情','洞察','情感','团队精神','话术','博弈','赌博','阅人','小透明','审讯','恐吓','挑衅','领导','谈判','演说','精神分析','街头智慧','边缘知识','残酷真相','意志','决心','说服','魅惑','威吓','游说','交涉','察言观色','欺骗','洞悉','欺瞒','标新立异','脑内剧场','神游太虚','踩地雷','顾左右而言他','主角光环','厚颜无耻','甩锅','造假','废话文学','上头','破防','种草','社死','点子','惊世智慧','奶龙之力','狗屎运','天意','桃花运','建筑学','军械','枪械制造','工匠','技艺','生物科技','露营','化学','药理','创作','电脑','黑客','赛博技术','爆破','电子学','工程学','急救','伪造','信息安全','修补','捣鼓','开锁','机械','修理','医学','摄影','编程','锻造','编译','科技使用','机械维修','电气维修','锁匠','操作重型机械','药学','艺术','会计','人类学','智慧生物学','考古学','灵视','导航','方向','天文学','生物学','犯罪学','神话','禁忌知识','文化','习俗','法医','搜证','历史','人力情报','调查','搜索','语言','语言学','法律','图书馆使用','研究','学识','侦察','神秘学','物理','有备无患','信号情报','生存','战术','神学','通识','侦查','聆听','心理学','追踪','博物学','克苏鲁神话','地质学','气象学','奥秘','自然','宗教','察觉','求生','情报收集','估价','密语','读唇','手语','弓术','炮术','引导','召唤','信仰','奇迹','击剑','枪械','射击','重武器','先攻','神射','狙击','武艺','近战','兵器','预兆','运气','格挡','灵能','巫术','施法','茶道','破坏','剑术','斧术','鞭术','躲藏','乔装','隐匿','驯兽','医疗','催眠','伪装','时髦值'],ct=(e=void 0)=>{if('boolean'==typeof e){const t=e,a=e=>Math.floor(Math.random()*e)+1,n=()=>a(6)+a(6)+a(6),i=()=>{if(t){const e=n(),t=a(4)-2;return Math.max(3,Math.min(18,e+t))}{const e=5*n(),t=a(10)-5;return Math.max(5,Math.min(95,e+t))}},o={};return nt.forEach(e=>{o[e]=i()}),o}const t=e||W.getActivePreset();if(!t){const e=e=>Math.floor(Math.random()*e)+1,t=()=>e(6)+e(6)+e(6),a={};return nt.forEach(n=>{const i=5*t(),o=e(10)-5;a[n]=Math.max(5,Math.min(95,i+o))}),{base:a,special:{}}}const a={};t.baseAttributes.forEach(e=>{const t=e.modifier?`${e.formula}+${e.modifier}`:e.formula;a[e.name]=G(t,e.range,{})});const n={};return t.specialAttributes&&Array.isArray(t.specialAttributes)&&t.specialAttributes.forEach(e=>{n[e.name]=G(e.formula,e.range,a)}),{base:a,special:n}},st=async e=>{const t=xe||zt();if(!t)return console.error('[ACU] clearPresetAttributesForCharacter: 无法获取表格数据'),window.toastr&&window.toastr.error('无法获取表格数据'),{success:!1};const a=!e||'<user>'===e||''===e.trim();let n=null,i=-1,o=-1,r=null;for(const c in t){const s=t[c];if(!s||!s.name||!s.content)continue;const l=s.name,d=s.content[0]||[];if(a&&(l.includes('主角')||l.includes('玩家')||l.toLowerCase().includes('player'))&&s.content[1]){n=s,i=1,r=c;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('基础属性')){o=e;break}if(o<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('属性')){o=e;break}break}if(!a&&(l.includes('人物')||l.includes('NPC')||l.includes('角色')||l.toLowerCase().includes('character'))){let t=1;for(let e=0;e<d.length;e++)if(d[e]&&(d[e].includes('姓名')||d[e].includes('名称')||d[e].toLowerCase().includes('name'))){t=e;break}for(let a=1;a<s.content.length;a++){const l=s.content[a];if(l&&l[t]===e){n=s,i=a,r=c;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('基础属性')){o=e;break}if(o<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('属性')){o=e;break}break}}if(i>0)break}}if(!n||i<0)return console.error('[ACU] clearPresetAttributesForCharacter: 找不到角色',e),window.toastr&&window.toastr.error(`找不到角色「${e||'<user>'}」`),{success:!1};if(o<0)return console.error('[ACU] clearPresetAttributesForCharacter: 找不到属性列'),window.toastr&&window.toastr.error('找不到属性列'),{success:!1};const c=n.content[i][o]||'',s=ce(c),l=it(),d=W.getActivePreset(),u=new Set(l);d&&d.specialAttributes&&d.specialAttributes.forEach(e=>u.add(e.name));const p=s.filter(e=>!u.has(e.name)).map(e=>`${e.name}:${e.value}`).join(';');return n.content[i][o]=p,xe=t,await It(t),{success:!0,attrString:p}},lt=async(e,t,a=!1)=>{const n=xe||zt();if(!n)return console.error('[ACU] writeAttributesToCharacter: 无法获取表格数据'),window.toastr&&window.toastr.error('无法获取表格数据'),{success:!1};const i=!e||'<user>'===e||''===e.trim();let o=null,r=-1,c=-1,s=null;for(const t in n){const a=n[t];if(!a||!a.name||!a.content)continue;const l=a.name,d=a.content[0]||[];if(i&&(l.includes('主角')||l.includes('玩家')||l.toLowerCase().includes('player'))&&a.content[1]){o=a,r=1,s=t;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('基础属性')){c=e;break}if(c<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('属性')){c=e;break}break}if(!i&&(l.includes('人物')||l.includes('NPC')||l.includes('角色')||l.toLowerCase().includes('character'))){let n=1;for(let e=0;e<d.length;e++)if(d[e]&&(d[e].includes('姓名')||d[e].includes('名称')||d[e].toLowerCase().includes('name'))){n=e;break}for(let i=1;i<a.content.length;i++){const l=a.content[i];if(l&&l[n]===e){o=a,r=i,s=t;for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('基础属性')){c=e;break}if(c<0)for(let e=0;e<d.length;e++)if(d[e]&&d[e].includes('属性')){c=e;break}break}}if(r>0)break}}if(!o||r<0)return console.error('[ACU] writeAttributesToCharacter: 找不到角色',e),window.toastr&&window.toastr.error(`找不到角色「${e||'<user>'}」`),{success:!1};if(c<0)return console.error('[ACU] writeAttributesToCharacter: 找不到属性列'),window.toastr&&window.toastr.error('找不到属性列（需要包含"属性"关键词的列）'),{success:!1};const l=o.content[r][c]||'',d=ce(l),u={};d.forEach(e=>{u[e.name]=e.value});const p=it(),g=W.getActivePreset(),f=new Set(p);g&&g.specialAttributes&&g.specialAttributes.forEach(e=>f.add(e.name));let b=0;p.forEach(e=>{void 0!==u[e]&&b++});const m=b===p.length,h=[];d.forEach(e=>{f.has(e.name)||h.push({name:e.name,value:e.value})});const v=[];p.forEach(e=>{if(m){const a=void 0!==t[e]?t[e]:u[e];void 0!==a&&v.push(`${e}:${a}`)}else void 0!==u[e]?v.push(`${e}:${u[e]}`):void 0!==t[e]&&v.push(`${e}:${t[e]}`)}),Object.keys(t).forEach(e=>{p.includes(e)||(m||!u[e]?v.push(`${e}:${t[e]}`):v.push(`${e}:${u[e]}`))}),h.forEach(e=>{v.push(`${e.name}:${e.value}`)});const x=v.join(';');o.content[r][c]=x,xe=n,await It(n);const y=[];return p.forEach(e=>{y.push({name:e,value:t[e]})}),{success:!0,attrs:y,attrString:x,wasComplete:m}},dt=e=>{const t=xe||zt();if(!t)return[];const a=!e||'<user>'===e||''===e.trim();let n=[];for(const i in t){const o=t[i];if(!o||!o.name||!o.content)continue;const r=o.name;if(a&&(r.includes('主角')||r.includes('玩家')||r.toLowerCase().includes('player'))&&o.content[1]){const e=o.content[0]||[],t=o.content[1];if(e.forEach((e,a)=>{if(e&&e.includes('属性')){ce(t[a]||'').forEach(e=>{n.some(t=>t.name===e.name)||n.push(e)})}}),n.length>0)break}if(!a&&(r.includes('人物')||r.includes('NPC')||r.includes('角色')||r.toLowerCase().includes('character'))){const t=o.content[0]||[];let a=1;for(let e=0;e<t.length;e++)if(t[e]&&(t[e].includes('姓名')||t[e].includes('名称')||t[e].toLowerCase().includes('name'))){a=e;break}for(let i=1;i<o.content.length;i++){const r=o.content[i];if(r&&r[a]===e){t.forEach((e,t)=>{if(e&&e.includes('属性')){ce(r[t]||'').forEach(e=>{n.some(t=>t.name===e.name)||n.push(e)})}});break}}if(n.length>0)break}}return n},ut=(e,t,a)=>{const{$}=Pe(),i=a||{},o=e.attr('id')||'dd_'+Math.random().toString(36).substr(2,9);e.attr('id',o),e.parent().find('.acu-dropdown-list').remove(),e.parent().hasClass('acu-dropdown-wrapper')||e.wrap('<div class="acu-dropdown-wrapper"></div>');const r=$(`<div class="acu-dropdown-list" data-for="${o}"></div>`);r.css({background:i.bgPanel||'#fff','border-color':i.border||'#ccc'}),e.after(r);const c=(e='')=>{const a=e.toLowerCase(),o=t.filter(e=>e.toLowerCase().includes(a));0===o.length?r.html(`<div class="acu-dropdown-empty" style="color:${i.textSub||'#999'};">无匹配项</div>`):r.html(o.map(e=>`<div class="acu-dropdown-item" data-value="${n(e)}" style="color:${i.textMain||'#333'};">${n(e)}</div>`).join(''))},s=()=>{r.removeClass('visible')};e.off('.acudd').on('focus.acudd click.acudd',function(t){t.stopPropagation(),$('.acu-dropdown-list').removeClass('visible'),c(e.val()),r.addClass('visible')}),e.on('input.acudd',function(){c($(this).val())}),r.on('mouseenter','.acu-dropdown-item',function(){$(this).css('background',i.tableHead||'rgba(128,128,128,0.15)')}).on('mouseleave','.acu-dropdown-item',function(){$(this).css('background','transparent')}),r.on('click','.acu-dropdown-item',function(t){t.stopPropagation(),t.preventDefault();const a=$(this).data('value');e.val(a).trigger('change'),s()}),r.on('click',function(e){e.stopPropagation()}),e.closest('.acu-dice-panel, .acu-contest-panel').off('click.acudd_'+o).on('click.acudd_'+o,function(e){$(e.target).closest('.acu-dropdown-wrapper').length||s()})},pt=(e,t,a)=>{const{$}=Pe(),n=a||{};e.find(t).each(function(){const e=$(this);if(e.parent().hasClass('acu-input-wrapper'))return;e.wrap('<div class="acu-input-wrapper"></div>');const t=$(`<button type="button" class="acu-clear-btn" title="清除" style="color:${n.textSub||'#999'};"><i class="fa-solid fa-times"></i></button>`);e.after(t),t.on('click',function(t){t.preventDefault(),t.stopPropagation(),e.val('').trigger('input').trigger('change').focus()}),t.on('mouseenter',function(){$(this).css({color:n.accent||'#7a695f',opacity:'1'})}).on('mouseleave',function(){$(this).css({color:n.textSub||'#999',opacity:'0.5'})})})},gt=(e=!1)=>{const{$}=Pe();$('.acu-dice-config-overlay').remove();const t=$t(),a=q(),n=e?'DND 规则设置':'COC 规则设置',i=e?'恢复 DND 默认':'恢复 COC 默认',o=e?{critSuccess:20,critFail:1}:{critSuccess:5,critFail:96,hardDiv:2,extremeDiv:5},r=e?void 0!==a.dndCritSuccess&&a.dndCritSuccess!==o.critSuccess?a.dndCritSuccess:'':void 0!==a.critSuccessMax&&a.critSuccessMax!==o.critSuccess?a.critSuccessMax:'',c=e?void 0!==a.dndCritFail&&a.dndCritFail!==o.critFail?a.dndCritFail:'':void 0!==a.critFailMin&&a.critFailMin!==o.critFail?a.critFailMin:'',s=e||void 0===a.difficultSuccessDiv||a.difficultSuccessDiv===o.hardDiv?'':a.difficultSuccessDiv,l=e||void 0===a.hardSuccessDiv||a.hardSuccessDiv===o.extremeDiv?'':a.hardSuccessDiv,d=a.contestTieRule||'initiator_lose',u=void 0!==a.hideDiceResultFromUser&&a.hideDiceResultFromUser,p=e?'':`\n            <div class="acu-dice-cfg-row">\n                <div class="acu-dice-cfg-item">\n                    <label>困难 (÷)</label>\n                    <div class="acu-stepper" data-id="cfg-hard-div" data-min="2" data-max="5" data-step="1">\n                        <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                        <span class="acu-stepper-value">${s||o.hardDiv}</span>\n                        <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                    </div>\n                </div>\n                <div class="acu-dice-cfg-item">\n                    <label>极难 (÷)</label>\n                    <div class="acu-stepper" data-id="cfg-extreme-div" data-min="3" data-max="10" data-step="1">\n                        <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                        <span class="acu-stepper-value">${l||o.extremeDiv}</span>\n                        <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                    </div>\n                </div>\n            </div>\n        `,g=`\n            <div class="acu-dice-config-overlay">\n                <div class="acu-dice-config-dialog acu-theme-${t.theme}">\n                    <div class="acu-dice-cfg-header">\n                        <span><i class="fa-solid fa-cog"></i> ${n}</span>\n                        <button class="acu-config-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-dice-cfg-body">\n                        <div class="acu-dice-cfg-row">\n                            <div class="acu-dice-cfg-item">\n                                <label>大成功阈值</label>\n                                <div class="acu-stepper" data-id="cfg-crit-success" data-min="1" data-max="100" data-step="1">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${r||o.critSuccess}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                            <div class="acu-dice-cfg-item">\n                                <label>大失败阈值</label>\n                                <div class="acu-stepper" data-id="cfg-crit-fail" data-min="1" data-max="100" data-step="1">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${c||o.critFail}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                        </div>\n                        ${p}\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item">\n                                <label>对抗平手规则</label>\n                                <select id="cfg-tie-rule">\n                                    <option value="initiator_lose" ${'initiator_lose'===d?'selected':''}>甲方判负 (默认)</option>\n                                    <option value="tie" ${'tie'===d?'selected':''}>双方平手</option>\n                                    <option value="initiator_win" ${'initiator_win'===d?'selected':''}>甲方判胜</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-row acu-cfg-full-row">\n                            <div class="acu-dice-cfg-item acu-cfg-toggle-item">\n                                <label>仅对user隐藏投骰结果</label>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-hide-dice-result" ${u?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                        <div class="acu-dice-cfg-actions">\n                            <button id="cfg-reset-dice">${i}</button>\n                            <button id="cfg-save-dice" class="primary">保存</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,f=$(g);$('body').append(f),f.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',background:'rgba(0,0,0,0.6)','z-index':'2147483655',display:'flex','align-items':'center','justify-content':'center',padding:'20px','box-sizing':'border-box'});const b=()=>f.remove();f.find('.acu-config-close').click(b),f.on('click',e=>{$(e.target).hasClass('acu-dice-config-overlay')&&b()}),f.find('.acu-stepper').each(function(){const e=$(this),t=(e.data('id'),parseInt(e.data('min'))),a=parseInt(e.data('max')),n=parseInt(e.data('step')),i=e.find('.acu-stepper-value'),o=e=>{e=Math.max(t,Math.min(a,e)),i.text(e)},r=()=>{const e=i.text().replace(/[^\d]/g,'');return parseInt(e)||t};e.find('.acu-stepper-dec').on('click',function(){o(r()-n)}),e.find('.acu-stepper-inc').on('click',function(){o(r()+n)})}),f.find('#cfg-save-dice').click(function(){const t={contestTieRule:$('#cfg-tie-rule').val()},a=e=>{const t=f.find(`.acu-stepper[data-id="${e}"]`);if(t.length){const e=t.find('.acu-stepper-value').text().replace(/[^\d]/g,'');return''!==e?parseInt(e,10):null}return null},n=a('cfg-crit-success'),i=a('cfg-crit-fail');if(e)t.dndCritSuccess=null!==n?n:o.critSuccess,t.dndCritFail=null!==i?i:o.critFail;else{t.critSuccessMax=null!==n?n:o.critSuccess,t.critFailMin=null!==i?i:o.critFail;const e=a('cfg-hard-div'),r=a('cfg-extreme-div');t.difficultSuccessDiv=null!==e?e:o.hardDiv,t.hardSuccessDiv=null!==r?r:o.extremeDiv}t.hideDiceResultFromUser=$('#cfg-hide-dice-result').is(':checked'),X(t),J(),b()}),f.find('#cfg-reset-dice').click(function(){const t=(e,t)=>{const a=f.find(`.acu-stepper[data-id="${e}"]`);a.length&&a.find('.acu-stepper-value').text(t)};t('cfg-crit-success',o.critSuccess),t('cfg-crit-fail',o.critFail),e||(t('cfg-hard-div',o.hardDiv),t('cfg-extreme-div',o.extremeDiv))})},ft=(e={})=>{const{$}=Pe();$('.acu-dice-panel, .acu-dice-overlay').remove();const t=$t();let a=q().lastDiceType||'1d100';/^\d+d\d+$/i.test(a)||(a='1d100');const o=xe||zt();let r=['<user>'],c=[];if(o)for(const e in o){const t=o[e];if(t&&t.name&&t.content){if('重要人物表'===t.name)for(let e=1;e<t.content.length;e++){const a=t.content[e];a&&a[1]&&r.push(a[1])}if('主角信息'===t.name&&t.content[1]){const e=t.content[1];(t.content[0]||[]).forEach((t,a)=>{if(t&&t.includes('属性')){ce(e[a]||'').forEach(e=>{c.includes(e.name)||c.push(e.name)})}})}}}const{targetValue:s=null,targetName:l='目标',diceType:d=a,successCriteria:u='lte',onResult:p=null,initiatorName:g=''}=e,f=ae(),b='cyber'===$t().theme?'#ff00ff':f.inputText,m=`width:100%;padding:5px;background:${f.inputBg} !important;border:1px solid ${f.border};border-radius:4px;color:${b} !important;font-size:12px;text-align:center;box-sizing:border-box;`,h=$(`<div class="acu-dice-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:${f.overlayBgLight};z-index:2147483647;"></div>`);let v=u;'1d100'===d?v='lte':'1d20'===d&&(v='gte');const x=$(`\n            <div class="acu-dice-panel acu-theme-${t.theme}" style="\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                width: 340px;\n                max-width: 90vw;\n                background: ${f.bgPanel};\n                border: 1px solid ${f.border};\n                border-radius: 12px;\n                box-shadow: 0 20px 60px ${f.shadowBg};\n                z-index: 2147483648;\n                overflow: hidden;\n                font-family: 'Microsoft YaHei', sans-serif;\n            ">\n                <div style="padding: 12px 15px; background: ${f.tableHead}; border-bottom: 1px solid ${f.border}; display: flex; justify-content: space-between; align-items: center;">\n                    <div style="font-size: 15px; font-weight: bold; color: ${f.accent}; display: flex; align-items: center; gap: 8px;">\n                        <i class="fa-solid fa-dice-d20"></i> 普通检定\n                    </div>\n                    <div style="display: flex; align-items: center; gap: 8px;">\n                        <button id="dice-switch-contest-top" style="background: none; border: none; color: ${f.textSub}; cursor: pointer; font-size: 14px; padding: 4px; transition: all 0.2s;" title="切换到对抗检定"><i class="fa-solid fa-people-arrows"></i></button>\n                        <button class="acu-dice-config-btn" style="background: none; border: none; color: ${f.textSub}; cursor: pointer; font-size: 14px; padding: 4px; transition: all 0.2s;" title="掷骰规则设置">\n                            <i class="fa-solid fa-cog"></i>\n                        </button>\n                        <button class="acu-dice-close" style="background: none; border: none; color: ${f.textSub}; cursor: pointer; font-size: 16px; padding: 4px;">\n                            <i class="fa-solid fa-times"></i>\n                        </button>\n                    </div>\n                </div>\n                <div style="padding: 15px; max-height: 70vh; overflow-y: auto;">\n                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; align-items: center;" class="acu-dice-presets">\n                        <button class="acu-dice-preset ${'1d20'===d?'active':''}" data-dice="1d20" data-criteria="gte" style="padding: 4px 10px; background: ${'1d20'===d?f.presetButtonBgActive||f.accent:f.presetButtonBg||f.btnBg}; border: 1px solid ${f.border}; border-radius: 4px; color: ${'1d20'===d?'#fff':f.textMain}; font-size: 11px; cursor: pointer;">1d20</button>\n                        <button class="acu-dice-preset ${'1d100'===d?'active':''}" data-dice="1d100" data-criteria="lte" style="padding: 4px 10px; background: ${'1d100'===d?f.presetButtonBgActive||f.accent:f.presetButtonBg||f.btnBg}; border: 1px solid ${f.border}; border-radius: 4px; color: ${'1d100'===d?'#fff':f.textMain}; font-size: 11px; cursor: pointer;">1d100</button>\n                        <button class="acu-dice-preset acu-dice-custom-btn" data-dice="custom" style="padding: 4px 10px; background: ${['1d20','1d100'].includes(d)?f.presetButtonBg||f.btnBg:f.presetButtonBgActive||f.accent}; border: 1px solid ${f.border}; border-radius: 4px; color: ${['1d20','1d100'].includes(d)?f.textMain:'#fff'}; font-size: 11px; cursor: pointer;">自定义</button>\n                        <input type="text" id="dice-custom-input" placeholder="如2d6" value="${['1d20','1d100'].includes(d)?'':d}" style="width:60px;">\n                    </div>\n\n                    \x3c!-- 快捷选择角色 --\x3e\n                    <div style="margin-bottom: 10px;">\n                        <div style="font-size: 11px; color: ${f.accent}; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 6px;"><i class="fa-solid fa-user"></i> 快捷选择</div>\n                        <div id="dice-char-buttons" style="display: flex; flex-wrap: wrap; gap: 4px; max-height: 60px; overflow-y: auto;"></div>\n                    </div>\n\n                    \x3c!-- 第1行：名字 + 属性名 --\x3e\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">\n                        <div>\n                            <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">名字</div>\n                            <input type="text" id="dice-initiator-name" value="${n(g)}" placeholder="<user>" style="${m}">\n                        </div>\n                        <div>\n                            <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center; gap: 6px;">\n                                属性名\n                                <button type="button" class="acu-random-skill-btn" id="dice-random-skill" title="随机技能" style="width: 18px; height: 18px; padding: 0; background: transparent; border: 1px dashed ${f.accent}; border-radius: 4px; color: ${f.accent}; font-size: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center;">\n                                    <i class="fa-solid fa-dice"></i>\n                                </button>\n                            </div>\n                            <input type="text" id="dice-attr-name" value="${n(l||'')}" placeholder="自由检定" style="${m}">\n                        </div>\n                    </div>\n\n                    \x3c!-- 第2行：属性值 + 目标值 --\x3e\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 6px;">\n                        <div>\n                            <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">属性值</div>\n                            <input type="text" id="dice-attr-value" value="" placeholder="留空=50%最大值" style="${m}">\n                        </div>\n                        <div>\n                            <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;" id="dice-target-label">目标值</div>\n                            <input type="text" id="dice-target" value="${null!==s?s:''}" placeholder="留空=属性值" style="${m}">\n                        </div>\n                    </div>\n\n                    \x3c!-- 第3行：成功标准 + 难度等级 + 修正值 --\x3e\n                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 6px;" id="dice-row-3">\n                        <div>\n                            <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">成功标准</div>\n                            <select id="dice-success-criteria" class="acu-dice-select">\n                                ${[{id:'lte',name:'≤ (COC)'},{id:'gte',name:'≥ (DND)'}].map(e=>`<option value="${e.id}" ${e.id===v?'selected':''}>${e.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div id="dice-difficulty-wrapper">\n                            <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">难度等级</div>\n                            <select id="dice-difficulty" class="acu-dice-select">\n                                <option value="normal" selected>普通</option>\n                                <option value="hard">困难</option>\n                                <option value="extreme">极难</option>\n                                <option value="critical">大成功</option>\n                            </select>\n                        </div>\n                        <div>\n                            <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 2px; min-height: 18px; display: flex; align-items: center;">修正值</div>\n                            <input type="text" id="dice-modifier" value="0" style="${m}">\n                        </div>\n                    </div>\n\n                    \x3c!-- 快捷选择属性 --\x3e\n                    <div style="margin-bottom: 10px;">\n                        <div style="font-size: 10px; color: ${f.textSub}; margin-bottom: 4px;"><i class="fa-solid fa-sliders"></i> 快捷选择属性</div>\n                        <div id="dice-attr-buttons" style="display: flex; flex-wrap: wrap; gap: 4px; max-height: 80px; overflow-y: auto;"></div>\n                    </div>\n                    \x3c!-- 隐藏的骰子公式 --\x3e\n                    <input type="hidden" id="dice-formula" value="${d}">\n\n                    <button id="dice-roll-btn" style="width: 100%; padding: 12px; background: ${f.buttonBg||f.accent}; border: none; border-radius: 8px; color: ${f.buttonText}; font-size: 15px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative;">\n                        <i class="fa-solid fa-dice"></i> 掷骰！\n                    </button>\n                </div>\n            </div>\n        `);$('body').append(h).append(x);const y=e=>{const t=x.find('#dice-attr-buttons'),a=t.parent(),i=dt(e);if(0===i.length)return void a.hide();a.show();let o='';i.forEach(e=>{o+=`<button class="acu-dice-attr-btn" data-name="${n(e.name)}" data-value="${e.value}" style="padding:3px 8px;background:${f.inputBg};border:1px solid ${f.border};border-radius:4px;color:${f.inputText};font-size:11px;cursor:pointer;">${n(e.name)}:${e.value}</button>`}),o+=`<button class="acu-dice-gen-attr-btn" style="padding:3px 8px;background:transparent;border:1px dashed ${f.accent};border-radius:4px;color:${f.accent};font-size:11px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;" title="为当前角色生成属性"><i class="fa-solid fa-dice"></i></button>`,o+=`<button class="acu-dice-clear-attr-btn" style="padding:3px 8px;background:transparent;border:1px dashed ${f.errorText};border-radius:4px;color:${f.errorText};font-size:11px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;margin-left:4px;" title="清空当前规则的属性（保留自定义属性）"><i class="fa-solid fa-trash-alt"></i></button>`,t.html(o),t.find('.acu-dice-attr-btn').click(function(){const e=$(this).data('name'),t=$(this).data('value');x.find('#dice-attr-name').val(e),x.find('#dice-attr-value').val(t);const a='gte'===(x.find('#dice-success-criteria').val()||'lte'),n=parseInt(t,10)||0;if(a){const e=Math.max(1,20-n);x.find('#dice-target').val(e)}else x.find('#dice-target').val(t);x.find('#dice-attr-value').trigger('change')}),t.find('.acu-dice-gen-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;t.prop('disabled',!0).css('opacity','0.5');const a=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const n=Te.handleUpdate;Te.handleUpdate=()=>{console.log('[ACU] 属性生成中，跳过自动刷新')};try{const e=x.find('#dice-initiator-name').val().trim()||'<user>';console.log('[ACU] 生成属性 for:',e);const t=ct(),a=t.base||t,n=t.special||{},i={...a,...n};(await lt(e,i)).success&&y(e)}catch(e){console.error('[ACU] 生成属性失败:',e),window.toastr&&window.toastr.error('生成属性失败')}finally{Te.handleUpdate=n,t.prop('disabled',!1).css('opacity','1').html(a)}}),t.find('.acu-dice-clear-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;const a=x.find('#dice-initiator-name').val().trim()||'<user>';if(!confirm(`确定要清空「${a}」的规则预设属性吗？\n\n（用户自定义的属性会保留）`))return;t.prop('disabled',!0).css('opacity','0.5');const n=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const i=Te.handleUpdate;Te.handleUpdate=()=>{console.log('[ACU] 清空属性中，跳过自动刷新')};try{console.log('[ACU] 清空属性 for:',a);(await st(a)).success&&y(a)}catch(e){console.error('[ACU] 清空属性失败:',e),window.toastr&&window.toastr.error('清空属性失败')}finally{Te.handleUpdate=i,t.prop('disabled',!1).css('opacity','1').html(n)}})};(()=>{const e=x.find('#dice-char-buttons');let t='';r.forEach(e=>{const a='<user>'===e?R():L(e),i=a.length>4?a.substring(0,4)+'..':a;t+=`<button class="acu-dice-char-btn" data-char="${n(e)}" style="padding:3px 8px;background:${f.btnBg};border:1px solid ${f.border};border-radius:4px;color:${f.textMain};font-size:11px;cursor:pointer;white-space:nowrap;" title="${n(a)}">${n(i)}</button>`}),e.html(t||`<div style="font-size:11px;color:${f.textSub};">无角色数据</div>`),e.find('.acu-dice-char-btn').click(function(){const e=$(this).data('char');x.find('#dice-initiator-name').val(e).trigger('change')})})(),y('<user>'),x.find('#dice-random-skill').click(function(e){e.preventDefault(),e.stopPropagation();const t=ot(),a=t[Math.floor(Math.random()*t.length)];x.find('#dice-attr-name').val(a).trigger('change')}),ut(x.find('#dice-initiator-name'),r,f),ut(x.find('#dice-attr-name'),c,f),pt(x,'#dice-initiator-name, #dice-attr-name, #dice-attr-value, #dice-target',f),x.find('#dice-initiator-name').on('change.acuattr input.acuattr',function(){const e=$(this).val().trim()||'<user>',t=tt(e);ut(x.find('#dice-attr-name'),t.length>0?t:c,f),y(e)}),x.find('#dice-attr-name').on('change.acuval',function(){const e=x.find('#dice-initiator-name').val().trim()||'<user>',t=$(this).val().trim(),a=at(e,t);null!==a&&(x.find('#dice-attr-value').val(a),x.find('#dice-target').val(a))});const w=(e,t,a)=>{if(!e||''===e)return'';const n=parseInt(e,10);if(isNaN(n))return e;const i=e=>{const t=e.match(/(\d+)d(\d+)/i);return t?parseInt(t[1],10)*parseInt(t[2],10):100},o=i(t),r=i(a),c=n/o,s=Math.round(c*r);return Math.max(1,Math.min(s,r))},k=()=>{const e='gte'===x.find('#dice-success-criteria').val(),t=x.find('#dice-target'),a=x.find('#dice-difficulty-wrapper'),n=x.find('#dice-row-3');e?(t.attr('placeholder','留空=20-属性值'),x.find('#dice-target-label').text('DC'),a.hide(),n.css('grid-template-columns','1fr 1fr')):(t.attr('placeholder','留空=属性值'),x.find('#dice-target-label').text('目标值'),a.show(),n.css('grid-template-columns','1fr 1fr 1fr'))};x.find('#dice-success-criteria').on('change',k),k();let C=d;x.find('.acu-dice-preset').click(function(){const e=$(this).data('dice');if('custom'===e)return;x.find('.acu-dice-preset').css({background:f.presetButtonBg||f.btnBg,color:f.textMain}),$(this).css({background:f.presetButtonBgActive||f.accent,color:f.buttonText}),X({lastDiceType:e});const t=$(this).data('criteria')||'lte',a=x.find('#dice-target'),n=a.val().trim();if(''!==n){const t=w(n,C,e);a.val(t)}const i=(e=>{const t=e.match(/(\d+)d(\d+)/i);return t?parseInt(t[1],10)*parseInt(t[2],10):100})(e);x.find('#dice-target-auto').text(`(自动: 1~${i})`),C=e,x.find('#dice-formula').val(e),x.find('#dice-success-criteria').val(t).trigger('change')}),x.find('.acu-dice-custom-btn').click(function(){x.find('.acu-dice-preset').css({background:f.presetButtonBg||f.btnBg,color:f.textMain}),$(this).css({background:f.presetButtonBgActive||f.accent,color:f.buttonText});const e=x.find('#dice-custom-input').val().trim();if(!e)return void x.find('#dice-custom-input').focus();if(!/^\d+d\d+$/i.test(e))return void(window.toastr&&window.toastr.warning('格式错误，请输入如 4d6'));const t=x.find('#dice-target'),a=t.val().trim();if(''!==a){const n=w(a,C,e);t.val(n)}x.find('#dice-formula').val(e),C=e,X({lastDiceType:e}),x.find('#dice-success-criteria').val('gte').trigger('change')}),x.find('#dice-custom-input').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),x.find('.acu-dice-custom-btn').click())});const S=function(){const e=x.find('#dice-formula').val().trim()||'1d100',t=function(e){if(!e||''===e.trim())return 0;const t=e.trim(),a=parseFloat(t);if(!isNaN(a)&&isFinite(a)&&t.match(/^-?\d+(\.\d+)?$/))return a;let n=0,i=t;const o=/(\d+)d(\d+)(kh\d+|kl\d+|dh\d+|dl\d+)?/gi;let r;for(;null!==(r=o.exec(i));){const e=K(r[0]);isNaN(e)||(n+=e),i=i.replace(r[0],'')}const c=/([+-]?\d+(\.\d+)?)/g;let s;for(;null!==(s=c.exec(i));){const e=parseFloat(s[0]);!isNaN(e)&&isFinite(e)&&(n+=e)}return n}(x.find('#dice-modifier').val().trim()||'0'),a=x.find('#dice-attr-name').val().trim()||'自由检定',n=x.find('#dice-success-criteria').val()||'lte',o=x.find('#dice-difficulty').val()||'normal',r='gte'===n,c=q(),s=c.difficultSuccessDiv||2,l=c.hardSuccessDiv||5,d=r?c.dndCritFail||1:c.critSuccessMax||5,u=r?c.dndCritSuccess||20:c.critFailMin||96;let g,b=x.find('#dice-target').val().trim(),m=x.find('#dice-attr-value').val().trim(),h=''!==m?parseInt(m,10):0,v=!1;const y=e=>{const t=e.match(/(\d+)d(\d+)/i);if(t){const e=parseInt(t[1],10)*parseInt(t[2],10);return Math.round(e/2)}return 50};''!==b?g=parseInt(b,10)||y(e):r?h>0?(g=Math.max(1,20-h),v=!0):(g=10,v=!0):h>0?(g=h,v=!0):(g=y(e),v=!0);const w=(e=>{const t=e.match(/(\d+)d(\d+)([+-]\d+)?/i);if(!t)return{total:0,rolls:[],formula:e};const a=parseInt(t[1],10),n=parseInt(t[2],10),i=t[3]?parseInt(t[3],10):0,o=[];for(let e=0;e<a;e++)o.push(Math.floor(Math.random()*n)+1);return{total:o.reduce((e,t)=>e+t,0)+i,rolls:o,sides:n,count:a,modifier:i,formula:e}})(e),k=w.total+t;let C=g,T='',A=1;if(!r)switch(o){case'hard':C=Math.floor(g/s),T='困难',A=s;break;case'extreme':C=Math.floor(g/l),T='极难',A=l;break;case'critical':C=d,T='大成功';break;default:T=''}let I=!1,M=!1,B=!1,E='',P='';if(r?(I=k>=u,M=k<=d):(I=k<=d,M=k>=u),B=r?k>=C:k<=C,I)E='大成功！',P='success',B=!0;else if(M)E='大失败！',P='failure',B=!1;else if(B){if(r)E='成功';else if('hard'===o)E='困难成功';else if('extreme'===o)E='极难成功';else{const e=Math.floor(g/l),t=Math.floor(g/s);E=k<=e?'极难成功':k<=t?'困难成功':'成功'}P='success'}else E='失败',P='failure';const N=r?'≥':'≤',D=void 0!==c.hideDiceResultFromUser&&c.hideDiceResultFromUser,j=D?'？？':k,F=D?'':E;let O;O=I?'critSuccess':M?'critFailure':B?'extreme'===o||'normal'===o&&k<=Math.floor(g/l)?'extremeSuccess':'hard'===o||'normal'===o&&k<=Math.floor(g/s)?'success':'warning':'failure';const R=ne(O,f),L=Object.entries(R).map(([e,t])=>`${e}:${t}`).join(';'),U=x.find('#dice-roll-btn');U.html(`\n        <div style="display:flex; align-items:center; justify-content:center; width:100%; gap:8px;">\n          <span style="font-size:22px; font-weight:bold; color:${f.buttonText};">${j}</span>\n          <span style="font-size:11px; color:${f.buttonText}; opacity:0.9;">${N}${C}${T?'('+T+')':''}</span>\n          ${F?`<span style="${L}">${F}</span>`:''}\n          <button class="dice-retry-btn" style="background:transparent; border:none; color:${f.buttonText}; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center; opacity:0.8; transition:opacity 0.2s;" title="重新投骰">\n            <i class="fa-solid fa-rotate-right"></i>\n          </button>\n        </div>\n      `),U.off('click','.dice-retry-btn').on('click','.dice-retry-btn',function(e){e.stopPropagation(),e.preventDefault(),S()});const V=x.find('#dice-initiator-name').val().trim()||'<user>';let Y='';if(I)Y=r?`${k}≥${u}`:`${k}≤${d}`;else if(M)Y=r?`${k}≤${d}`:`${k}≥${u}`;else if(r)Y=B?`需${N}${C}，${k}≥${C}`:`需${N}${C}，${k}<${C}`;else if('critical'===o)Y=`需≤${d}，${k}>${d}`;else if('normal'!==o)Y=B?`需≤${g}/${A}，${k}≤${C}`:`需≤${g}/${A}，${k}>${C}`;else if(B){const e=Math.floor(g/l),t=Math.floor(g/s);Y=k<=e?`需≤${g}，${k}≤${g}/${l}`:k<=t?`需≤${g}，${k}≤${g}/${s}`:`需≤${g}，${k}≤${g}`}else Y=`需≤${g}，${k}>${g}`;i(`${V}发起了【${a}】检定，掷出${k}，${Y}，【${E}】`,'dice'),p&&p({success:B,total:k,target:g,outcomeText:E,attrName:a,criteria:n,isAutoTarget:v,formula:formulaText})};x.find('#dice-roll-btn').click(function(){S()}),x.find('#dice-switch-contest-top').click(function(){x.find('#dice-target').val().trim();const e=x.find('#dice-attr-value').val().trim(),t=x.find('#dice-formula').val()||'1d100',a=x.find('#dice-initiator-name').val().trim();T(),bt({initiatorName:a&&'<user>'!==a?a:'',initiatorValue:''!==e?parseInt(e,10):void 0,diceType:t})});const T=()=>{h.remove(),x.remove()};h.click(T),x.find('.acu-dice-close').click(T),x.find('.acu-dice-config-btn').click(function(e){e.stopPropagation();const t=x.find('#dice-success-criteria').val();gt('gte'===t)})},bt=(e={})=>{const{$}=Pe();$('.acu-dice-panel, .acu-dice-overlay, .acu-contest-panel, .acu-contest-overlay').remove();const t=$t();let a=q().lastDiceType||'1d100';/^\d+d\d+$/i.test(a)||(a='1d100');const o=e.opponentName||'',r=e.diceType||a,c=e.initiatorName||'',s=e.initiatorValue,l=e.opponentValue,d=xe||zt();let u=[],p=[],g=['<user>'];if(d)for(const e in d){const t=d[e];if(t&&'重要人物表'===t.name&&t.content){for(let e=1;e<t.content.length;e++){const a=t.content[e];a&&a[1]&&g.push(a[1])}break}}let f=[];if(d)for(const e in d){const t=d[e];if(t&&'主角信息'===t.name&&t.content&&t.content[1]){const e=t.content[0]||[],a=t.content[1];e.forEach((e,t)=>{if(e&&e.includes('属性')){ce(a[t]||'').forEach(e=>{f.includes(e.name)||f.push(e.name)})}});break}}if(d)for(const e in d){const t=d[e];if(t&&t.name&&t.content){if('主角信息'===t.name&&t.content[1]){const e=t.content[1][7]||'';u=ce(e)}if('重要人物表'===t.name&&o)for(let e=1;e<t.content.length;e++){const a=t.content[e];if(a&&a[1]===o){const e=a[9]||'';p=ce(e);break}}}}const b=ae(),m='cyber'===$t().theme?'#ff00ff':b.inputText,h=`width:100%;padding:5px;background:${b.inputBg} !important;border:1px solid ${b.border};border-radius:4px;color:${m} !important;font-size:12px;text-align:center;box-sizing:border-box;`,v=(e,t)=>{if(0===e.length)return'';let a='';for(let i=0;i<e.length;i++){const o=e[i];a+='<button class="acu-contest-attr-btn" data-val="'+o.value+'" data-aname="'+n(o.name)+'" data-type="'+t+'" style="padding:3px 8px;background:'+b.inputBg+';border:1px solid '+b.border+';border-radius:4px;color:'+b.inputText+';font-size:11px;cursor:pointer;margin:2px;">'+n(o.name)+': '+o.value+'</button>'}return a},x=$('<div class="acu-contest-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:'+b.overlayBg+';z-index:2147483647;"></div>'),y='<div class="acu-contest-panel acu-theme-'+t.theme+'" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:360px;max-width:92vw;background:'+b.bgPanel+';border:1px solid '+b.border+';border-radius:12px;box-shadow:0 20px 60px '+b.shadowBg+';z-index:2147483648;font-family:Microsoft YaHei,sans-serif;overflow:hidden;"><div style="padding:12px 15px;background:'+b.tableHead+';border-bottom:1px solid '+b.border+';display:flex;justify-content:space-between;align-items:center;"><div style="font-size:15px;font-weight:bold;color:'+b.accent+';display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-people-arrows"></i> 对抗检定</div><div style="display:flex;align-items:center;gap:8px;"><button id="contest-switch-normal" style="background:none;border:none;color:'+b.textSub+';cursor:pointer;font-size:14px;padding:4px;transition:all 0.2s;" title="切换到普通检定"><i class="fa-solid fa-dice-d20"></i></button><button class="acu-contest-config-btn" style="background:none;border:none;color:'+b.textSub+';cursor:pointer;font-size:14px;padding:4px;transition:all 0.2s;" title="掷骰规则设置"><i class="fa-solid fa-cog"></i></button><button class="acu-contest-close" style="background:none;border:none;color:'+b.textSub+';cursor:pointer;font-size:16px;padding:4px;"><i class="fa-solid fa-times"></i></button></div></div><div style="padding:15px;max-height:70vh;overflow-y:auto;"><div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;align-items:center;"><button class="acu-contest-preset'+('1d20'===r?' active':'')+'" data-dice="1d20" style="padding:4px 10px;background:'+('1d20'===r?b.presetButtonBgActive||b.accent:b.presetButtonBg||b.btnBg)+';border:1px solid '+b.border+';border-radius:4px;color:'+('1d20'===r?'#fff':b.textMain)+';font-size:11px;cursor:pointer;">1d20</button><button class="acu-contest-preset'+('1d100'===r?' active':'')+'" data-dice="1d100" style="padding:4px 10px;background:'+('1d100'===r?b.presetButtonBgActive||b.accent:b.presetButtonBg||b.btnBg)+';border:1px solid '+b.border+';border-radius:4px;color:'+('1d100'===r?'#fff':b.textMain)+';font-size:11px;cursor:pointer;">1d100</button><button class="acu-contest-preset acu-contest-custom-btn" data-dice="custom" style="padding:4px 10px;background:'+(['1d20','1d100'].includes(r)?b.presetButtonBg||b.btnBg:b.presetButtonBgActive||b.accent)+';border:1px solid '+b.border+';border-radius:4px;color:'+(['1d20','1d100'].includes(r)?b.textMain:'#fff')+';font-size:11px;cursor:pointer;">自定义</button><input type="text" id="contest-custom-dice" placeholder="如2d6" value="'+(['1d20','1d100'].includes(r)?'':r)+'" style="width:60px;padding:4px 6px;background:'+b.inputBg+' !important;border:1px solid '+b.border+';border-radius:4px;color:'+m+' !important;font-size:11px;text-align:center;box-sizing:border-box;" /></div><input type="hidden" id="contest-dice-type" value="'+r+'"><div style="font-size:11px;color:'+b.accent+';font-weight:bold;margin-bottom:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><span><i class="fa-solid fa-user"></i> 甲方</span><div id="contest-init-char-buttons" style="display:flex;flex-wrap:wrap;gap:3px;"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">名字</div><input type="text" id="contest-init-display" value="" placeholder="<user>" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;gap:6px;">属性名<button type="button" class="acu-random-skill-btn" id="contest-init-random-skill" title="随机技能" style="width:18px;height:18px;padding:0;background:transparent;border:1px dashed '+b.accent+';border-radius:4px;color:'+b.accent+';font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-dice"></i></button></div><input type="text" id="contest-init-name" value="" placeholder="自由检定" style="'+h+'"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">属性值</div><input type="text" id="contest-init-value" value="'+(void 0!==s?s:'')+'" placeholder="留空=50%最大值" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">目标值</div><input type="text" id="contest-init-target" value="" placeholder="自动" style="'+h+'"></div></div><div id="init-attr-buttons" style="display:flex;flex-wrap:wrap;gap:2px;margin-bottom:8px;max-height:50px;overflow-y:auto;">'+v(u,'init')+'</div><div style="font-size:11px;color:'+b.accent+';font-weight:bold;margin-bottom:4px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><span><i class="fa-solid fa-user"></i> 乙方</span><div id="contest-opp-char-buttons" style="display:flex;flex-wrap:wrap;gap:3px;"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">名字</div><input type="text" id="contest-opponent-display" value="'+n(o)+'" placeholder="对手" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;gap:6px;">属性名<button type="button" class="acu-random-skill-btn" id="contest-opp-random-skill" title="随机技能" style="width:18px;height:18px;padding:0;background:transparent;border:1px dashed '+b.accent+';border-radius:4px;color:'+b.accent+';font-size:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-dice"></i></button></div><input type="text" id="contest-opp-name" value="" placeholder="同甲方" style="'+h+'"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px;"><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">属性值</div><input type="text" id="contest-opp-value" value="'+(void 0!==l?l:'')+'" placeholder="留空=50%最大值" style="'+h+'"></div><div><div style="font-size:10px;color:'+b.textSub+';margin-bottom:2px;min-height:18px;display:flex;align-items:center;">目标值</div><input type="text" id="contest-opp-target" value="" placeholder="自动" style="'+h+'"></div></div><div id="opp-attr-buttons" style="display:flex;flex-wrap:wrap;gap:2px;margin-bottom:10px;max-height:50px;overflow-y:auto;">'+v(p,'opp')+'</div><div id="contest-result-display" style="display:none;margin-bottom:10px;padding:8px;background:'+b.inputBg+';border:1px solid '+b.border+';border-radius:6px;"><div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;width:100%;"><div id="contest-result-init" style="display:flex;align-items:center;gap:4px;min-width:0;flex:1;"></div><span style="color:'+b.textSub+';opacity:0.9;font-size:11px;font-weight:bold;white-space:nowrap;">VS</span><div id="contest-result-opp" style="display:flex;align-items:center;gap:4px;min-width:0;flex:1;justify-content:flex-end;"></div></div></div><button id="contest-roll-btn" style="width:100%;padding:12px;background:'+(b.buttonBg||b.accent)+';border:none;border-radius:8px;color:'+b.buttonText+';font-size:15px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;position:relative;"><i class="fa-solid fa-dice"></i> 开始对抗！</button></div></div>',w=$(y);$('body').append(x).append(w);const k=w.find('#init-attr-buttons'),C=w.find('#opp-attr-buttons');''===k.html().trim()&&k.hide(),''===C.html().trim()&&C.hide();const S=e=>{const t='init'===e?'#contest-init-char-buttons':'#contest-opp-char-buttons',a=w.find(t);let i='';g.forEach(t=>{const a='<user>'===t?R():L(t),o=a.length>4?a.substring(0,4)+'..':a;i+='<button class="acu-contest-char-btn" data-char="'+n(t)+'" data-type="'+e+'" style="padding:3px 8px;background:'+b.btnBg+';border:1px solid '+b.border+';border-radius:4px;color:'+b.textMain+';font-size:11px;cursor:pointer;white-space:nowrap;" title="'+n(a)+'">'+n(o)+'</button>'}),a.html(i),a.find('.acu-contest-char-btn').click(function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('char');'init'===$(this).data('type')?w.find('#contest-init-display').val(t).trigger('change'):w.find('#contest-opponent-display').val(t).trigger('change')})},T=(e,t)=>{const a='init'===t?'#init-attr-buttons':'#opp-attr-buttons',i=w.find(a);if(0===e.length)return void i.hide().html('');i.show();let o='';e.length>0&&e.forEach(e=>{o+='<button class="acu-contest-attr-btn" data-val="'+e.value+'" data-aname="'+n(e.name)+'" data-type="'+t+'" style="padding:2px 6px;background:'+b.inputBg+';border:1px solid '+b.border+';border-radius:3px;color:'+b.inputText+';font-size:10px;cursor:pointer;">'+n(e.name)+':'+e.value+'</button>'}),o+='<button class="acu-contest-gen-attr-btn" data-type="'+t+'" style="padding:2px 6px;background:transparent;border:1px dashed '+b.accent+';border-radius:3px;color:'+b.accent+';font-size:10px;cursor:pointer;display:inline-flex;align-items:center;gap:3px;" title="生成属性"><i class="fa-solid fa-dice"></i></button>',o+='<button class="acu-contest-clear-attr-btn" data-type="'+t+'" style="padding:2px 6px;background:transparent;border:1px dashed '+b.errorText+';border-radius:3px;color:'+b.errorText+';font-size:10px;cursor:pointer;display:inline-flex;align-items:center;gap:3px;margin-left:4px;" title="清空规则属性"><i class="fa-solid fa-trash-alt" style="font-size:9px;"></i></button>',i.html(o),i.find('.acu-contest-attr-btn').click(function(){const e=$(this).attr('data-val'),t=$(this).attr('data-aname');'init'===$(this).attr('data-type')?(w.find('#contest-init-value').val(e),w.find('#contest-init-name').val(t)):(w.find('#contest-opp-value').val(e),w.find('#contest-opp-name').val(t))}),i.find('.acu-contest-gen-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;const a=t.attr('data-type');t.prop('disabled',!0).css('opacity','0.5');const n=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const i=Te.handleUpdate;Te.handleUpdate=()=>{console.log('[ACU] 对抗属性生成中，跳过自动刷新')};try{let e;if(e='init'===a?w.find('#contest-init-display').val().trim()||'<user>':w.find('#contest-opponent-display').val().trim(),!e)return void(window.toastr&&window.toastr.warning('请先选择角色'));console.log('[ACU] 对抗面板生成属性 for:',e,'type:',a);const t=ct(),n=t.base||t,i=t.special||{},o={...n,...i};if((await lt(e,o)).success){const t=dt(e);T(t,a)}}catch(e){console.error('[ACU] 对抗面板生成属性失败:',e),window.toastr&&window.toastr.error('生成属性失败')}finally{Te.handleUpdate=i,t.prop('disabled',!1).css('opacity','1').html(n)}}),i.find('.acu-contest-clear-attr-btn').click(async function(e){e.preventDefault(),e.stopPropagation();const t=$(this);if(t.prop('disabled'))return;const a=t.attr('data-type');let n;if(n='init'===a?w.find('#contest-init-display').val().trim()||'<user>':w.find('#contest-opponent-display').val().trim(),!n)return void(window.toastr&&window.toastr.warning('请先选择角色'));if(!confirm(`确定要清空「${n}」的规则预设属性吗？\n\n（用户自定义的属性会保留）`))return;t.prop('disabled',!0).css('opacity','0.5');const i=t.html();t.html('<i class="fa-solid fa-spinner fa-spin"></i>');const o=Te.handleUpdate;Te.handleUpdate=()=>{console.log('[ACU] 清空属性中，跳过自动刷新')};try{console.log('[ACU] 对抗面板清空属性 for:',n,'type:',a);if((await st(n)).success){const e=dt(n);T(e,a)}}catch(e){console.error('[ACU] 对抗面板清空属性失败:',e),window.toastr&&window.toastr.error('清空属性失败')}finally{Te.handleUpdate=o,t.prop('disabled',!1).css('opacity','1').html(i)}})};if(S('init'),S('opp'),w.find('#contest-init-random-skill').click(function(e){e.preventDefault(),e.stopPropagation();const t=ot();var a=t[Math.floor(Math.random()*t.length)];w.find('#contest-init-name').val(a).trigger('change')}),w.find('#contest-opp-random-skill').click(function(e){e.preventDefault(),e.stopPropagation();const t=ot();var a=t[Math.floor(Math.random()*t.length)];w.find('#contest-opp-name').val(a).trigger('change')}),c){const e=dt(c);T(e,'init')}if(o){const e=dt(o);T(e,'opp')}ut(w.find('#contest-init-display'),g,b),ut(w.find('#contest-opponent-display'),g,b),ut(w.find('#contest-init-name'),f,b),ut(w.find('#contest-opp-name'),f,b),pt(w,'#contest-init-display, #contest-init-name, #contest-init-value, #contest-init-target, #contest-opponent-display, #contest-opp-name, #contest-opp-value, #contest-opp-target',b),w.find('#contest-init-display').on('change.acuattr input.acuattr',function(){const e=$(this).val().trim()||'<user>',t=tt(e);ut(w.find('#contest-init-name'),t.length>0?t:f,b);const a=dt(e);T(a,'init')}),w.find('#contest-opponent-display').on('change.acuattr input.acuattr',function(){const e=$(this).val().trim(),t=tt(e);ut(w.find('#contest-opp-name'),t.length>0?t:f,b);const a=dt(e);T(a,'opp')}),w.find('#contest-init-name').on('change.acuval',function(){const e=w.find('#contest-init-display').val().trim()||'<user>',t=$(this).val().trim(),a=at(e,t);null!==a&&w.find('#contest-init-value').val(a)}),w.find('#contest-opp-name').on('change.acuval',function(){const e=w.find('#contest-opponent-display').val().trim(),t=$(this).val().trim(),a=at(e,t);null!==a&&w.find('#contest-opp-value').val(a)}),w.find('.acu-contest-preset').click(function(){const e=$(this).data('dice');'custom'!==e&&(w.find('.acu-contest-preset').css({background:b.presetButtonBg||b.btnBg,color:b.textMain}),$(this).css({background:b.presetButtonBgActive||b.accent,color:b.buttonText}),w.find('#contest-dice-type').val(e),X({lastDiceType:e}))}),w.find('.acu-contest-custom-btn').click(function(){w.find('.acu-contest-preset').css({background:b.presetButtonBg||b.btnBg,color:b.textMain}),$(this).css({background:b.presetButtonBgActive||b.accent,color:b.buttonText});var e=w.find('#contest-custom-dice').val().trim();e?/^\d+d\d+$/i.test(e)?(w.find('#contest-dice-type').val(e),X({lastDiceType:e})):window.toastr&&window.toastr.warning('格式错误，请输入如 4d6'):w.find('#contest-custom-dice').focus()}),w.find('#contest-custom-dice').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),w.find('.acu-contest-custom-btn').click())});const A=function(e){const t=e.match(/(\d+)d(\d+)([+-]\d+)?/i);if(!t)return{total:0,rolls:[],sides:100};const a=parseInt(t[1],10),n=parseInt(t[2],10),i=t[3]?parseInt(t[3],10):0,o=[];for(let e=0;e<a;e++)o.push(Math.floor(Math.random()*n)+1);return{total:o.reduce(function(e,t){return e+t},0)+i,rolls:o,sides:n}},I=function(e,t,a){const n=ae();return 100===a?e<=5?{level:3,name:'大成功',color:n.critSuccessText}:e>=96?{level:-1,name:'大失败',color:n.critFailureText}:e<=Math.floor(t/5)?{level:2,name:'极难成功',color:n.extremeSuccessText}:e<=Math.floor(t/2)?{level:1,name:'困难成功',color:n.successText}:e<=t?{level:0,name:'普通成功',color:n.warningText}:{level:-1,name:'失败',color:n.failureText}:20===e?{level:3,name:'大成功',color:n.critSuccessText}:1===e?{level:-1,name:'大失败',color:n.critFailureText}:e>=t?{level:0,name:'成功',color:n.successText}:{level:-1,name:'失败',color:n.failureText}},M=function(){var e,t=w.find('#contest-dice-type').val()||'1d100',a=w.find('#contest-init-display').val().trim()||'<user>',o=w.find('#contest-init-name').val().trim()||'自由检定',r=function(e){var t=e.match(/(\d+)d(\d+)/i);return t?Math.round(parseInt(t[1],10)*parseInt(t[2],10)/2):50},c=w.find('#contest-init-value').val().trim();e=''===c?r(t):parseInt(c,10)||r(t);var s,l=w.find('#contest-init-target').val().trim();s=''!==l?parseInt(l,10):e;var d,u=w.find('#contest-opponent-display').val().trim()||'对手',p=w.find('#contest-opp-name').val().trim()||o,g=w.find('#contest-opp-value').val().trim();d=''===g?r(t):parseInt(g,10)||r(t);var f,m=w.find('#contest-opp-target').val().trim();f=''!==m?parseInt(m,10):d;var h,v,x=A(t),y=A(t),k=I(x.total,s,x.sides),C=I(y.total,f,y.sides),S=q(),T=S.contestTieRule||'initiator_lose',B=void 0!==S.hideDiceResultFromUser&&S.hideDiceResultFromUser,E=B?'？？':x.total,P=B?'？？':y.total,N=B?'':k.name,D=B?'':C.name;k.level>C.level?(h=a+' 胜利',v=b.successText,k.name,C.name):k.level<C.level?(h=u+' 胜利',v=b.failureText,C.name,k.name):('双方均为 '+k.name,'initiator_win'===T?(h='平手，'+a+' 判胜',v=b.successText):'tie'===T?(h='双方平手',v=b.warningText):(h='平手，'+a+' 判负',v=b.failureText));var j=B?'':h;const F=e=>3===e.level?'critSuccess':2===e.level?'extremeSuccess':1===e.level?'success':0===e.level?'warning':-1===e.level&&'大失败'===e.name?'critFailure':'failure',O=F(k),R=F(C),L=ne(O,b),U=ne(R,b),V=ne(v===b.successText?'success':v===b.warningText?'warning':'failure',b),Y=Object.entries(L).map(([e,t])=>`${e}:${t}`).join(';'),X=Object.entries(U).map(([e,t])=>`${e}:${t}`).join(';'),J=Object.entries(V).map(([e,t])=>`${e}:${t}`).join(';'),H=w.find('#contest-result-display'),W=w.find('#contest-result-init'),K=w.find('#contest-result-opp');W.html('<span style="font-size:11px;color:'+b.textMain+';opacity:0.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px;">'+n(a)+'</span><span style="font-size:16px;font-weight:bold;color:'+b.textMain+';">'+E+'</span>'+(N?'<span style="'+Y+'">'+N+'</span>':'')),K.html((D?'<span style="'+X+'">'+D+'</span>':'')+'<span style="font-size:16px;font-weight:bold;color:'+b.textMain+';">'+P+'</span><span style="font-size:11px;color:'+b.textMain+';opacity:0.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60px;">'+n(u)+'</span>'),H.show();const G=w.find('#contest-roll-btn');G.html('<div style="display:flex; align-items:center; justify-content:center; width:100%; gap:8px;">'+(j?'<span style="'+J+'">'+j+'</span>':'')+'<button class="contest-retry-btn" style="background:transparent; border:none; color:'+b.buttonText+'; cursor:pointer; padding:4px; display:flex; align-items:center; justify-content:center; opacity:0.8; transition:opacity 0.2s;" title="重新投骰"><i class="fa-solid fa-rotate-right"></i></button></div>'),G.off('click','.contest-retry-btn').on('click','.contest-retry-btn',function(e){e.stopPropagation(),e.preventDefault(),M()});const Q=`进行了一次【${o} vs ${p}】的对抗检定。${a} (目标${s}) 掷出 ${x.total}，判定为【${k.name}】；${u} (目标${f}) 掷出 ${y.total}，判定为【${C.name}】。最终结果：【${h}】`;i(Q,'dice')};w.find('#contest-roll-btn').click(function(){M()}),w.find('#contest-switch-normal').click(function(){var e=w.find('#contest-init-value').val().trim(),t=w.find('#contest-init-name').val()||'',a=w.find('#contest-dice-type').val()||'1d100',n=w.find('#contest-init-display').val().trim();B(),ft({targetValue:''!==e?parseInt(e,10):null,targetName:t,diceType:a,initiatorName:n})}),w.find('.acu-contest-config-btn').click(function(e){e.stopPropagation();const t=w.find('#contest-dice-type').val()||'1d100';gt('1d20'===t)});var B=function(){x.remove(),w.remove()};x.click(B),w.find('.acu-contest-close').click(B)},mt=(e,t,a,i,o)=>{const{$}=Pe();$('.acu-preview-overlay').remove();const r=$t(),c=(ae(),a[1]||'详情');let s='';for(let e=1;e<t.length;e++){const i=t[e],o=a[e];i&&null!=o&&''!==o&&(s+=`\n                <div class="acu-preview-row">\n                    <div class="acu-preview-label">${n(i)}</div>\n                    <div class="acu-preview-value">${n(String(o))}</div>\n                </div>\n            `)}const l=$(`\n            <div class="acu-preview-overlay acu-theme-${r.theme}">\n                <div class="acu-preview-card">\n                    <div class="acu-panel-header">\n                        <div class="acu-preview-title">\n                            <i class="fa-solid fa-id-card"></i>\n                            <span>${n(c)}</span>\n                        </div>\n                        <button class="acu-close-btn acu-preview-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-preview-body">\n                        ${s||'<div style="text-align:center;color:var(--acu-text-sub);padding:20px;">无数据</div>'}\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(l),l.find('.acu-preview-close').click(()=>l.remove()),l.on('click',function(e){$(e.target).hasClass('acu-preview-overlay')&&l.remove()})},ht=e=>{const{$}=Pe();$('.acu-relation-graph-overlay').remove();const t=$t(),a=ae(),i=e.headers||[],o=e.rows||[],r=i.findIndex(e=>e&&(e.includes('姓名')||e.includes('名称')))||1,c=i.findIndex(e=>e&&e.includes('人际关系')),s=e.key||'';if(c<0)return void(window.toastr&&window.toastr.warning('未找到"人际关系"列'));const l=new Map,d=[],u=e=>(e=>{if(!e)return e;const t=F(),a=O(),n=['<user>','{{user}}'].some(t=>e===t||e.toLowerCase()===t.toLowerCase()),i=a&&e===a,o=!!t&&(e===t||U.getPrimaryName(e)===t);return n||i||o?'{{user}}':U.getPrimaryName(e)})(e),p=xe||zt();let g='主角';if(p)for(const e in p){const t=p[e];if(t?.name?.includes('主角')&&t.content?.[1]){g=t.content[1][1]||'主角';break}}const f=u(g),b=(()=>{for(const e in p)if(p[e]?.name?.includes('主角'))return e;return''})();l.set(f,{name:f,isPlayer:!0,x:0,y:0,tableKey:b,rowIndex:0});const m=i.findIndex(e=>e&&e.includes('在场'));o.forEach((e,t)=>{const a=e[r];if(!a)return;const n=u(a);let p=!1;if(m>0){const t=String(e[m]||'').trim().toLowerCase();p=String(i[m]||'').toLowerCase().includes('离场')?'否'===t||'false'===t||'no'===t:t.startsWith('在场')||'true'===t||'是'===t||'yes'===t}l.has(n)||l.set(n,{name:n,isPlayer:!1,x:0,y:0,tableKey:s,rowIndex:t,isInScene:p});const g=e[c]||'';se(g).forEach(e=>{if(!e.name)return;const t=u(e.name);if(t===n)return;if(!l.has(t)){let e=-1;for(let a=0;a<o.length;a++)if(u(o[a][r])===t){e=a;break}l.set(t,{name:t,isPlayer:t===f,x:0,y:0,tableKey:e>=0?s:'',rowIndex:e>=0?e:void 0})}const a=(e=>{if(!e)return[];const t=String(e).split(/[,，、;；\/\|]+|\s*[和与&]\s*|\s{2,}|\n/).map(e=>e.trim()).filter(e=>e&&e.length<30),a=['恋人','情侣','夫妻','伴侣','爱人','男友','女友','前男友','前女友','朋友','好友','挚友','密友','闺蜜','死党','知己','损友','同学','校友','同窗','学长','学姐','学弟','学妹','前辈','后辈','同事','上司','下属','老板','员工','搭档','队友','战友','伙伴','师父','师傅','徒弟','弟子','老师','学生','导师','门生','父亲','母亲','儿子','女儿','兄弟','姐妹','哥哥','姐姐','弟弟','妹妹','爷爷','奶奶','外公','外婆','叔叔','阿姨','舅舅','姑姑','表哥','表姐','表弟','表妹','堂兄','堂弟','堂姐','堂妹','家人','亲人','亲戚','血亲','义父','义母','义兄','义妹','敌人','仇人','对手','劲敌','宿敌','情敌','死敌','冤家','邻居','室友','房东','租客','客户','商人','雇主','雇员','信徒','教徒','追随者','崇拜者','粉丝','陌生人','熟人','路人','过客'];return t.map(e=>{const t=(e=e.replace(/[（(][^）)]*[）)]/g,'').trim()).match(/^(.+)的(目标|对象)$/);if((e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=t?t[1]:e.replace(/^[\u4e00-\u9fa5]{2,4}的(?=[\u4e00-\u9fa5]{1,4}$)/,'')).replace(/^(?:属于|作为|身为|是其?|为其?|乃)/,'')).replace(/^(?:曾经是?|以前是?|原本是?|前)/,'前')).replace(/^(?:互为|彼此是?|相互是?)/,'')).replace(/关系$/,'')).replace(/对象$/,'')).replace(/目标$/,'')).replace(/^关系复杂$/,'复杂')).replace(/^关系不明$/,'不明')).replace(/^关系微妙$/,'微妙')).replace(/^关系紧张$/,'紧张')).replace(/^关系亲密$/,'亲密')).replace(/^关系疏远$/,'疏远')).replace(/^(?:不认识|不熟悉|陌生人?)$/,'陌生')).replace(/^(?:认识|熟人)$/,'熟人')).replace(/^(?:好朋友|挚友|密友|至交)$/,'挚友')).replace(/^(?:男朋友|男友)$/,'男友')).replace(/^(?:女朋友|女友)$/,'女友')).replace(/^(?:前男友|前男朋友)$/,'前男友')).replace(/^(?:前女友|前女朋友)$/,'前女友')).replace(/^(?:暗恋对象|暗恋)$/,'暗恋')).replace(/^(?:单相思|单恋)$/,'单恋')).replace(/^(?:青梅竹马|儿时玩伴|发小)$/,'青梅竹马')).replace(/^(?:同班同学|同级同学)$/,'同学')).replace(/^(?:工作伙伴|合作伙伴|搭档)$/,'搭档')).trim()).length>8){for(const t of a)if(e.endsWith(t))return t;const t=e.slice(-4);for(const e of a)if(t.includes(e))return e;return e.slice(-3)}return e}).filter(e=>e&&e.length>0&&e.length<=8)})(e.relation);0===a.length&&a.push('');let i=d.find(e=>e.source===n&&e.target===t||e.source===t&&e.target===n);if(i)if(i.source===n){const e=[...i.labelsFromSource||[],...a];i.labelsFromSource=[...new Set(e)].slice(0,2)}else{const e=[...i.labelsFromTarget||[],...a];i.labelsFromTarget=[...new Set(e)].slice(0,2)}else d.push({source:n,target:t,labelsFromSource:a.slice(0,2),labelsFromTarget:[]})})});const h=Array.from(l.values()),v=new Map;h.forEach(e=>v.set(e.name,0)),d.forEach(e=>{v.set(e.source,(v.get(e.source)||0)+1),v.set(e.target,(v.get(e.target)||0)+1)});const x=window.innerWidth<=768,y=x?22:28,w=x?38:50,k=x?28:35,C=x?2.5:3.5;let S=1,T=!1,A=!1;const I=(e,t)=>{const a=t?k:y,n=v.get(e)||0;return Math.min(w,a+Math.sqrt(n)*C)*S};h.forEach(e=>{e.radius=I(e.name,e.isPlayer)});const M=()=>`acu-relation-graph-layout-cache-${h.map(e=>e.name).sort().join('|')}`,B=()=>{try{const e=M(),t=localStorage.getItem(e);if(!t)return!1;const a=JSON.parse(t);let n=!0;for(const e of h)if(!a[e.name]){n=!1;break}return!!n&&(h.forEach(e=>{const t=a[e.name];t&&(e.x=t.x,e.y=t.y,e.vx=0,e.vy=0)}),console.log('[关系图] 已从缓存加载布局'),!0)}catch(e){return console.warn('[关系图] 加载布局缓存失败:',e),!1}},E=()=>{h.forEach(e=>{if(e.isPlayer)e.x=400,e.y=300,e.vx=0,e.vy=0;else{const t=2*Math.random()*Math.PI,a=50+100*Math.random();e.x=400+Math.cos(t)*a,e.y=300+Math.sin(t)*a,e.vx=0,e.vy=0}});const e=new Map;h.forEach(t=>e.set(t.name,t));for(let t=0;t<300;t++){for(let e=0;e<h.length;e++){const t=h[e];for(let a=e+1;a<h.length;a++){const e=h[a],n=e.x-t.x,i=e.y-t.y;let o=n*n+i*i;o<1&&(o=1);const r=Math.sqrt(o),c=2e4/o,s=n/r*c,l=i/r*c;t.isPlayer||(t.vx-=s,t.vy-=l),e.isPlayer||(e.vx+=s,e.vy+=l)}}d.forEach(t=>{const a=e.get(t.source),n=e.get(t.target);if(!a||!n)return;const i=n.x-a.x,o=n.y-a.y,r=Math.sqrt(i*i+o*o)||1,c=.02*(r-250),s=i/r*c,l=o/r*c;a.isPlayer||(a.vx+=s,a.vy+=l),n.isPlayer||(n.vx-=s,n.vy-=l)}),h.forEach(e=>{if(e.isPlayer)return;const t=400-e.x,a=300-e.y;e.vx+=.01*t,e.vy+=.01*a});const a=50*(1-t/300);h.forEach(e=>{if(e.isPlayer)return;e.vx*=.8,e.vy*=.8;const t=Math.sqrt(e.vx*e.vx+e.vy*e.vy);t>a&&(e.vx=e.vx/t*a,e.vy=e.vy/t*a),e.x+=.5*e.vx,e.y+=.5*e.vy})}(()=>{try{const e=M(),t={};h.forEach(e=>{t[e.name]={x:e.x,y:e.y}}),localStorage.setItem(e,JSON.stringify(t)),console.log('[关系图] 布局已保存到缓存')}catch(e){console.warn('[关系图] 保存布局缓存失败:',e)}})()};B()||E();let P=1,N=0,D=0;const j=$(`\n            <div class="acu-relation-graph-overlay acu-theme-${t.theme}">\n                <div class="acu-relation-graph-container">\n                    <div class="acu-panel-header">\n                        <div class="acu-graph-title">\n                            <i class="fa-solid fa-project-diagram"></i>\n                            <button class="acu-graph-btn acu-filter-toggle" id="filter-in-scene" title="只显示主角和在场角色" style="margin-left:8px;padding:4px 6px;font-size:12px;"><i class="fa-solid fa-map-marker-alt"></i></button>\n                            <button class="acu-graph-btn acu-filter-toggle" id="filter-direct-only" title="只显示与主角直接相关" style="padding:4px 6px;font-size:12px;"><i class="fa-solid fa-link"></i></button>\n                        </div>\n                        <div class="acu-graph-actions">\n                            <button class="acu-graph-btn" id="graph-relayout" title="重新布局（清除缓存并重新计算节点位置）"><i class="fa-solid fa-sync"></i></button>\n                            <button class="acu-graph-btn" id="graph-manage-avatar" title="管理头像"><i class="fa-solid fa-user-circle"></i></button>\n                            <button class="acu-graph-btn acu-graph-close" title="关闭"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-graph-canvas-wrapper">\n                        <svg class="acu-graph-svg" viewBox="0 0 800 600">\n                            <defs>\n                                <marker id="arrowhead-end" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 6 2.5, 0 5" fill="${a.textSub}" />\n                                </marker>\n                                <marker id="arrowhead-start" markerWidth="6" markerHeight="5" refX="1" refY="2.5" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="6 0, 0 2.5, 6 5" fill="${a.textSub}" />\n                                </marker>\n                                <marker id="arrowhead-end-hl" markerWidth="7" markerHeight="6" refX="6" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="0 0, 7 3, 0 6" fill="${a.accent}" />\n                                </marker>\n                                <marker id="arrowhead-start-hl" markerWidth="7" markerHeight="6" refX="1" refY="3" orient="auto" markerUnits="strokeWidth">\n                                    <polygon points="7 0, 0 3, 7 6" fill="${a.accent}" />\n                                </marker>\n                            </defs>\n                            <g class="acu-graph-transform">\n                                <g class="acu-graph-edges"></g>\n                                <g class="acu-graph-nodes"></g>\n                            </g>\n                        </svg>\n                        <div class="acu-node-size-slider-container" style="\n                            position: absolute;\n                            display: none;\n                            width: 200px;\n                            padding: 10px;\n                            background: ${a.bgPanel};\n                            border: 1px solid ${a.border};\n                            border-radius: 8px;\n                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n                            z-index: 10;\n                        ">\n                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">\n                                <span style="font-size:11px;color:${a.textSub};white-space:nowrap;">节点大小</span>\n                                <span id="slider-size-display" style="font-size:11px;color:${a.accent};font-weight:bold;min-width:35px;text-align:right;">${Math.round(100*S)}%</span>\n                            </div>\n                            <input type="range" id="node-size-slider" min="0.5" max="2.0" step="0.1" value="${S}" style="\n                                width: 100%;\n                                height: 8px;\n                                border-radius: 4px;\n                                background: ${a.btnBg};\n                                outline: none;\n                                cursor: pointer;\n                                -webkit-appearance: none;\n                            " />\n                        </div>\n                    </div>\n                    <div class="acu-graph-legend">\n                        <button class="acu-graph-btn" id="graph-zoom-reset" title="重置视图和节点大小" style="width:auto;height:auto;padding:4px 10px;font-size:11px;display:flex;align-items:center;gap:4px;"><i class="fa-solid fa-compress-arrows-alt"></i><span>重置</span></button>\n                        <div class="acu-node-size-stepper-wrapper" style="display:flex;align-items:center;justify-content:center;gap:6px;">\n                            <span style="font-size:11px;color:var(--acu-text-sub);white-space:nowrap;">节点:</span>\n                            <div class="acu-stepper" data-id="graph-node-size" data-min="50" data-max="200" data-step="10" style="display:flex;align-items:center;">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value" id="node-size-display" style="display:flex;align-items:center;justify-content:center;">${Math.round(100*S)}%</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <span class="acu-zoom-display" style="display:flex;align-items:center;gap:4px;color:var(--acu-text-sub);font-size:11px;">\n                            <span>视图:</span>\n                            <span>${Math.round(100*P)}%</span>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(j);const R=j.find('.acu-graph-svg'),V=j.find('.acu-graph-transform'),Y=j.find('.acu-graph-edges'),q=j.find('.acu-graph-nodes'),X=j.find('.acu-zoom-display span:last-child'),J=j.find('#node-size-display'),H=j.find('.acu-graph-canvas-wrapper'),W=()=>{V.attr('transform',`translate(${N}, ${D}) scale(${P})`),X.text(`${Math.round(100*P)}%`)},K=()=>{J.length&&J.text(`${Math.round(100*S)}%`)},G=(e,t=400,a=300)=>{const n=P;P=Math.max(.3,Math.min(4,e));const i=P/n;N=t-(t-N)*i,D=a-(a-D)*i,W()},Q=async()=>{const e=(()=>{if(!T&&!A)return h;let e=null;return A&&(e=new Set([f]),d.forEach(t=>{t.source===f&&e.add(t.target),t.target===f&&e.add(t.source)})),h.filter(t=>{const a=!T||t.isInScene||t.isPlayer,n=!A||e.has(t.name);return a&&n})})(),t=new Set(e.map(e=>e.name)),a=d.filter(e=>t.has(e.source)&&t.has(e.target));let i='';a.forEach((e,t)=>{const a=l.get(e.source),o=l.get(e.target);if(!a||!o)return;const r=o.x-a.x,c=o.y-a.y,s=Math.sqrt(r*r+c*c)||1,d=r/s,u=c/s,p=-u,g=d,f=e.labelsFromSource&&e.labelsFromSource.length>0&&e.labelsFromSource.some(e=>e),b=e.labelsFromTarget&&e.labelsFromTarget.length>0&&e.labelsFromTarget.some(e=>e),m=a.radius||28,h=o.radius||28,v=a.x+d*(m+10),x=a.y+u*(m+10),y=o.x-d*(h+10),w=o.y-u*(h+10);let k=(e.labelsFromSource||[]).filter(e=>e),C=(e.labelsFromTarget||[]).filter(e=>e);const S=new Set(k),T=new Set(C),A=[...S].filter(e=>T.has(e)),I=k.filter(e=>!A.includes(e)),M=C.filter(e=>!A.includes(e));let B='',E='';f&&(E='url(#arrowhead-end)'),b&&(B='url(#arrowhead-start)'),i+=`<line class="acu-graph-edge" x1="${v}" y1="${x}" x2="${y}" y2="${w}"\n                    ${E?`marker-end="${E}"`:''}\n                    ${B?`marker-start="${B}"`:''}\n                    data-edge-idx="${t}" />`;const P=(a.x+o.x)/2,N=(a.y+o.y)/2,D=Math.sqrt(r*r+c*c);if(f&&b&&A.length>0&&0===I.length&&0===M.length)A.slice(0,2).forEach((e,a)=>{if(!e)return;const o=0===a?1:-1,r=6+10*a;i+=`<text class="acu-graph-edge-label" x="${P+p*o*r}" y="${N+g*o*r}" data-edge-idx="${t}">${n(e)}</text>`});else{const e=Math.max(30,Math.min(.25*D,60)),a=[{emoji:'💕',keywords:['恋人','恋爱','爱情','恋情','情侣','男友','女友','暗恋','单恋','心动','喜欢','爱慕','倾心','钟情','情人','爱人']},{emoji:'👨‍👩‍👧',keywords:['家人','亲人','父母','父亲','母亲','兄弟','姐妹','兄妹','姐弟','儿子','女儿','爷爷','奶奶','外公','外婆','叔叔','阿姨','表亲','堂亲','血亲']},{emoji:'😊',keywords:['朋友','友人','好友','友情','伙伴','搭档','队友','战友','同伴','盟友','挚友','密友','至交','闺蜜','死党','知己','莫逆']},{emoji:'🎓',keywords:['师父','师傅','徒弟','师徒','老师','学生','导师','弟子','门生','同学','同窗','同级','同班','前辈','后辈','学长','学姐','学弟','学妹']},{emoji:'💰',keywords:['交易','合作','生意','客户','商业','利益','雇佣','契约','合同']},{emoji:'⚔️',keywords:['对手','竞争','劲敌','宿敌','情敌','死对头','冤家']},{emoji:'💢',keywords:['敌人','仇人','仇恨','敌对','仇敌','死敌','憎恨','怨恨','仇怨']},{emoji:'🙏',keywords:['信仰','崇拜','敬仰','仰慕','追随','信徒','教徒','狂信']},{emoji:'🌀',keywords:['复杂','微妙','纠葛','羁绊','纠缠']}],o=e=>{if(!e)return'';for(const t of a)for(const a of t.keywords)if(e.includes(a))return e+t.emoji;return e},r=(e,t=4)=>{if(!e)return'';const a=e.length>t?e.substring(0,t)+'..':e;return o(a)};if(A.length>0&&A.slice(0,1).forEach((e,a)=>{if(!e)return;i+=`<text class="acu-graph-edge-label" x="${P+8*p}" y="${N+8*g-3}" data-edge-idx="${t}">${n(r(e,5))}</text>`}),I.length>0||f&&!b&&0===A.length){const a=I.length>0?I:k,o=P-d*e,c=N-u*e;a.slice(0,2).forEach((e,a)=>{if(!e)return;const s=10*(0===a?1:-1);i+=`<text class="acu-graph-edge-label" x="${o+p*s}" y="${c+g*s}" data-edge-idx="${t}">${n(r(e,5))}</text>`})}if(M.length>0||b&&!f&&0===A.length){const a=M.length>0?M:C,o=P+d*e,c=N+u*e;a.slice(0,2).forEach((e,a)=>{if(!e)return;const s=10*(0===a?-1:1);i+=`<text class="acu-graph-edge-label" x="${o+p*s}" y="${c+g*s}" data-edge-idx="${t}">${n(r(e,5))}</text>`})}}}),Y.html(i);let o='';for(const t of e){const e=await U.getAsync(t.name),a=(t.isPlayer,.28*t.radius),i=.65*t.radius,r=t.isInScene?`<circle class="acu-node-inscene-indicator" cx="${-i}" cy="${-i}" r="${a}" style="fill:var(--acu-accent);stroke:var(--acu-bg-panel);stroke-width:2;" />`:'',c=L(t.name);o+=`\n                <g class="acu-graph-node acu-dash-preview-trigger" data-name="${n(t.name)}" data-table-key="${t.tableKey||''}" data-row-index="${void 0!==t.rowIndex?t.rowIndex:''}" transform="translate(${t.x}, ${t.y})">\n                    <circle class="acu-node-bg" r="${t.radius}" />\n                    ${e?(()=>{const a=U.getOffsetX(t.name),n=U.getOffsetY(t.name),i=U.getScale(t.name),o=2*(t.radius-2);return`<foreignObject x="${-o/2}" y="${-o/2}" width="${o}" height="${o}">\n                            <div xmlns="http://www.w3.org/1999/xhtml" style="\n                                width: ${o}px;\n                                height: ${o}px;\n                                border-radius: 50%;\n                                background-image: url('${e}');\n                                background-size: ${i}%;\n                                background-position: ${a}% ${n}%;\n                                background-repeat: no-repeat;\n                            "></div>\n                        </foreignObject>`})():`<text class="acu-node-char" dy="0.35em">${n(c.charAt(0))}</text>`}\n                    ${r}\n                    <text class="acu-node-label" dy="${t.radius+14}">${n(c)}</text>\n                </g>\n            `}q.html(o)},Z=e=>{R.addClass('highlighting'),q.find('.acu-graph-node').each(function(){$(this).data('name')===e&&$(this).addClass('highlighted')});const t=new Set([e]);d.forEach(a=>{if(a.source===e||a.target===e){const n=a.source===e?a.target:a.source;t.add(n)}}),q.find('.acu-graph-node').each(function(){t.has($(this).data('name'))&&$(this).addClass('highlighted')});const a=new Set;d.forEach((t,n)=>{t.source!==e&&t.target!==e||a.add(n)}),Y.find('.acu-graph-edge').each(function(){const e=parseInt($(this).attr('data-edge-idx'),10);a.has(e)&&($(this).addClass('highlighted'),$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end-hl)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start-hl)'))}),Y.find('.acu-graph-edge-label').each(function(){const e=parseInt($(this).attr('data-edge-idx'),10);a.has(e)&&$(this).addClass('highlighted')})},ee=()=>{R.removeClass('highlighting'),q.find('.highlighted').removeClass('highlighted'),Y.find('.highlighted').removeClass('highlighted'),Y.find('.acu-graph-edge').each(function(){$(this).attr('marker-end')&&$(this).attr('marker-end','url(#arrowhead-end)'),$(this).attr('marker-start')&&$(this).attr('marker-start','url(#arrowhead-start)')})};if('ontouchstart'in window||navigator.maxTouchPoints>0){let e=null;q.on('pointerdown','.acu-graph-node',function(t){const a=$(this),n=a.data('name'),i=t.clientX,o=t.clientY,r=Date.now();let c=!1,s=!1;if(e)return ee(),e=null,t.preventDefault(),void t.stopPropagation();const l=setTimeout(()=>{!c&&n&&(s=!0,e=n,Z(n),navigator.vibrate&&navigator.vibrate(30))},300);$(document).on('pointermove.mobilenode',e=>{const t=Math.abs(e.clientX-i),a=Math.abs(e.clientY-o);(t>8||a>8)&&(c=!0,clearTimeout(l))}),$(document).on('pointerup.mobilenode pointercancel.mobilenode',()=>{$(document).off('pointermove.mobilenode pointerup.mobilenode pointercancel.mobilenode'),clearTimeout(l);const e=Date.now()-r;if(!s&&!c&&e<300){const e=a.data('table-key'),t=a.data('row-index');if(e&&''!==t&&void 0!==t){const a=xe||zt();if(a&&a[e]){const n=a[e],i=n.content?n.content[0]:[],o=n.content?n.content[parseInt(t,10)+1]:null;o&&mt(n.name,i,o,parseInt(t,10))}}}})}),H.on('pointerup.mobileclear',function(t){e&&!$(t.target).closest('.acu-graph-node').length&&(ee(),e=null)})}else q.on('pointerenter.pchover','.acu-graph-node',function(){const e=$(this).data('name');e&&Z(e)}),q.on('pointerleave.pchover','.acu-graph-node',function(){ee()}),q.on('click.pcclick','.acu-graph-node',function(e){e.stopPropagation();const t=$(this),a=t.data('table-key'),n=t.data('row-index');if(a&&''!==n&&void 0!==n){const e=xe||zt();if(e&&e[a]){const t=e[a],i=t.content?t.content[0]:[],o=t.content?t.content[parseInt(n,10)+1]:null;o&&mt(t.name,i,o,parseInt(n,10))}}});Q().then(()=>{W()});let te=!1,ne=0,ie=0,oe=0,re=0,ce=0,le=null;const de=H[0],ue=R[0];de.onpointerdown=function(e){0===e.button&&($(e.target).closest('.acu-graph-node').length||$(e.target).closest('.acu-node-size-slider-container').length||(e.preventDefault(),de.setPointerCapture(e.pointerId),le=e.pointerId,te=!0,ne=e.clientX,ie=e.clientY,oe=N,re=D,ue.style.cursor='grabbing'))},de.onpointermove=function(e){if(!te||e.pointerId!==le)return;const t=e.clientX-ne,a=e.clientY-ie,n=ue.getBoundingClientRect();N=oe+t/n.width*800,D=re+a/n.height*600,W()},de.onpointerup=function(e){e.pointerId===le&&(de.releasePointerCapture(e.pointerId),te=!1,le=null,ue.style.cursor='grab')},de.onpointercancel=function(e){e.pointerId===le&&(te=!1,le=null,ue.style.cursor='grab')},de.onwheel=function(e){e.preventDefault();const t=e.deltaY>0?-.15:.15;G(P+t)},de.addEventListener('touchstart',function(e){2===e.touches.length&&(e.preventDefault(),te=!1,ce=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY))},{passive:!1}),de.addEventListener('touchmove',function(e){if(2===e.touches.length){e.preventDefault();const t=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);ce>0&&G(P*(t/ce)),ce=t}},{passive:!1}),de.addEventListener('touchend',function(e){e.touches.length<2&&(ce=0)});const pe=j.find('#node-size-slider'),ge=j.find('#slider-size-display'),fe=j.find('.acu-node-size-slider-container'),be=j.find('#node-size-display-trigger'),me=j.find('.acu-graph-legend');fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:9508',message:'元素选择器检查',data:{nodeSizeSliderLen:pe.length,sliderContainerLen:fe.length,nodeSizeDisplayTriggerLen:be.length,legendLen:me.length},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'B'})}).catch(()=>{}),me.on('click',function(e){fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:legend-click',message:'legend区域点击',data:{targetId:e.target.id,targetClass:e.target.className,targetTagName:e.target.tagName},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'C'})}).catch(()=>{})});let he=!1,ve=null;const ye=()=>{he&&(ve&&(clearTimeout(ve),ve=null),he=!1,fe.hide())},we=()=>{ve&&clearTimeout(ve),ve=setTimeout(()=>{ye()},4e3)};fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:9571',message:'事件委托绑定执行',data:{overlayExists:j.length>0,triggerExists:j.find('#node-size-display-trigger').length>0},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'A'})}).catch(()=>{}),j.on('click','#node-size-display-trigger, #node-size-display-trigger *',function(e){fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:9572',message:'节点点击事件触发',data:{sliderVisible:he,targetId:e.target.id,targetClass:e.target.className},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'B'})}).catch(()=>{}),e.stopPropagation(),he?ye():(()=>{if(he)return;ve&&(clearTimeout(ve),ve=null),he=!0;const e=be[0].getBoundingClientRect(),t=H[0].getBoundingClientRect();fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:showSlider',message:'位置计算',data:{triggerTop:e.top,triggerBottom:e.bottom,wrapperTop:t.top,wrapperBottom:t.bottom,wrapperHeight:t.height},timestamp:Date.now(),sessionId:'debug-session',hypothesisId:'D'})}).catch(()=>{});const a=t.height-60-10,n=e.left-t.left;fe.css({display:'block',top:`${a}px`,left:`${n}px`}),we()})()}),pe.on('input mousedown touchstart',function(e){e.stopPropagation(),he&&we()}),fe.on('pointerdown mousedown touchstart',function(e){e.stopPropagation()}),$(document).on('click.slider-hide',function(e){!he||fe.is(e.target)||0!==fe.has(e.target).length||be.is(e.target)||0!==be.has(e.target).length||ye()}),pe.on('input',function(){S=parseFloat($(this).val()),ge.text(Math.round(100*S)+'%'),K(),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),Q(),we()});const ke=j.find('#filter-in-scene'),$e=j.find('#filter-direct-only'),_e=()=>{ke.css({background:T?a.accent:a.btnBg,color:T?a.btnActiveText:a.textMain,borderColor:T?a.accent:a.border}),$e.css({background:A?a.accent:a.btnBg,color:A?a.btnActiveText:a.textMain,borderColor:A?a.accent:a.border})};_e(),ke.click(function(e){e.stopPropagation(),T=!T,_e(),Q()}),$e.click(function(e){e.stopPropagation(),A=!A,_e(),Q()}),j.find('#graph-zoom-reset').click(()=>{P=1,N=0,D=0,W(),S=1,pe.val(1),ge.text('100%'),K();const e=j.find('.acu-stepper[data-id="graph-node-size"]');e.length&&e.find('.acu-stepper-value').text('100%'),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),B()||E(),Q()});const Ce=j.find('.acu-stepper[data-id="graph-node-size"]');if(Ce.length){const e=parseInt(Ce.data('min')),t=parseInt(Ce.data('max')),a=parseInt(Ce.data('step')),n=Ce.find('.acu-stepper-value'),i=a=>{a=Math.max(e,Math.min(t,a)),S=a/100,n.text(`${a}%`),K(),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),Q()},o=()=>{const e=n.text().replace(/[^\d]/g,'');return parseInt(e)||100};Ce.find('.acu-stepper-dec').on('click',function(){i(o()-a)}),Ce.find('.acu-stepper-inc').on('click',function(){i(o()+a)})}j.find('#graph-relayout').click(()=>{(()=>{try{const e=M();localStorage.removeItem(e),console.log('[关系图] 布局缓存已清除')}catch(e){console.warn('[关系图] 清除布局缓存失败:',e)}})(),h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),E(),Q(),window.toastr&&window.toastr.success('布局已重新计算')}),j.find('#graph-manage-avatar').click(()=>{xt(h,()=>{h.forEach(e=>{e.radius=I(e.name,e.isPlayer)}),Q()})});const Se=()=>{de.onpointerdown=null,de.onpointermove=null,de.onpointerup=null,de.onpointercancel=null,de.onwheel=null,ve&&(clearTimeout(ve),ve=null),$(document).off('click.slider-hide'),j.remove()};j.find('.acu-graph-close').click(Se),j.on('click',function(e){$(e.target).hasClass('acu-relation-graph-overlay')&&Se()})},vt=(e,t,a)=>{const{$}=Pe();$('.acu-crop-modal-overlay').remove();const i=$t();ae();let o=150,r=50,c=50;const s=U.getAll()[t];s&&(o=s.scale??150,r=s.offsetX??50,c=s.offsetY??50);const l=`\n            <div class="acu-crop-modal-overlay acu-theme-${i.theme}">\n                <div class="acu-crop-modal">\n                    <div class="acu-crop-header">\n                        <span><i class="fa-solid fa-crop-simple"></i> 调整头像 - ${n(t)}</span>\n                        <button class="acu-crop-close"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-crop-body">\n                        <div class="acu-crop-container">\n                            <div class="acu-crop-image" style="\n                                background-image: url('${e}');\n                                background-size: ${o}%;\n                                background-position: ${r}% ${c}%;\n                            "></div>\n                            <div class="acu-crop-mask"></div>\n                        </div>\n                        <div class="acu-crop-hint">拖拽移动 · 滚轮/双指缩放</div>\n                    </div>\n                    <div class="acu-crop-footer">\n                        <label class="acu-crop-btn acu-crop-reupload" title="重新上传">\n                            <i class="fa-solid fa-camera"></i>\n                            <input type="file" accept="image/*" class="acu-crop-file-input" style="display:none;" />\n                        </label>\n                        <button class="acu-crop-btn acu-crop-cancel">取消</button>\n                        <button class="acu-crop-btn acu-crop-confirm"><i class="fa-solid fa-check"></i> 确定</button>\n                    </div>\n                </div>\n            </div>\n        `,d=$(l);$('body').append(d),d.css({position:'fixed',top:'0',left:'0',right:'0',bottom:'0',width:'100vw',height:'100vh',display:'flex','align-items':'center','justify-content':'center','z-index':'2147483658'});const u=d.find('.acu-crop-image'),p=d.find('.acu-crop-container')[0],g=u[0],f=()=>{g.style.backgroundSize=`${o}%`,g.style.backgroundPosition=`${r}% ${c}%`};let b=!1,m=0,h=0,v=0,x=0,y=null;g.addEventListener('pointerdown',e=>{null===y&&(e.preventDefault(),e.stopPropagation(),b=!0,y=e.pointerId,m=e.clientX,h=e.clientY,v=r,x=c,g.setPointerCapture(e.pointerId),g.style.cursor='grabbing')}),g.addEventListener('pointermove',e=>{if(!b||e.pointerId!==y)return;e.preventDefault(),e.stopPropagation();const t=e.clientX-m,a=e.clientY-h,n=100/o;r=Math.max(0,Math.min(100,v-t*n)),c=Math.max(0,Math.min(100,x-a*n)),f()}),g.addEventListener('pointerup',e=>{e.pointerId===y&&(b=!1,y=null,g.releasePointerCapture(e.pointerId),g.style.cursor='grab')}),g.addEventListener('pointercancel',e=>{e.pointerId===y&&(b=!1,y=null,g.style.cursor='grab')}),p.addEventListener('wheel',e=>{e.preventDefault(),e.stopPropagation();const t=e.deltaY>0?-10:10;o=Math.max(100,Math.min(300,o+t)),f()},{passive:!1});let w=0,k=o;p.addEventListener('touchstart',e=>{2===e.touches.length&&(e.preventDefault(),w=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY),k=o)},{passive:!1}),p.addEventListener('touchmove',e=>{if(2===e.touches.length){e.preventDefault();const t=Math.hypot(e.touches[1].clientX-e.touches[0].clientX,e.touches[1].clientY-e.touches[0].clientY);if(w>0){const e=t/w;o=Math.max(100,Math.min(300,k*e)),f()}}},{passive:!1}),p.addEventListener('touchend',e=>{e.touches.length<2&&(w=0,k=o)}),d.find('.acu-crop-file-input').on('change',async function(a){const n=a.target.files[0];if(n)if(n.type.startsWith('image/'))if(n.size>5242880)window.toastr&&window.toastr.warning('图片大小不能超过 5MB');else{try{if(await U.saveLocalAvatar(t,n)){const a=await j.get(t);e=a,o=150,r=50,c=50,u.css('background-image',`url('${a}')`),f()}}catch(e){console.error('[ACU] 重新上传失败:',e),window.toastr&&window.toastr.error('上传失败')}$(this).val('')}else window.toastr&&window.toastr.warning('请选择图片文件')}),d.find('.acu-crop-close, .acu-crop-cancel').on('click',()=>{d.remove()}),d.find('.acu-crop-confirm').on('click',()=>{a({scale:o,offsetX:r,offsetY:c}),d.remove()}),d.on('click',e=>{$(e.target).hasClass('acu-crop-modal-overlay')&&d.remove()})},xt=(e,t)=>{const{$}=Pe();$('.acu-avatar-manager-overlay').remove();const a=$t(),i=ae(),o=U.getAll(),r=e=>{if(!e)return e;const t=F(),a=O(),n=['<user>','{{user}}'].some(t=>e===t||e.toLowerCase()===t.toLowerCase()),i=a&&e===a,o=(()=>{if(!t)return!1;if(e===t)return!0;return U.getPrimaryName(e)===t})();return n||i||o?'{{user}}':U.getPrimaryName(e)},c=`\n            <div class="acu-avatar-manager-overlay acu-theme-${a.theme}">\n                <div class="acu-avatar-manager">\n                    <div class="acu-panel-header">\n                        <div class="acu-avatar-title"><i class="fa-solid fa-user-circle"></i> 头像管理</div>\n                        <div style="display:flex;gap:4px;align-items:center;">\n                            <button class="acu-avatar-import-btn" title="导入"><i class="fa-solid fa-file-import"></i></button>\n                            <button class="acu-avatar-export-btn" title="导出"><i class="fa-solid fa-file-export"></i></button>\n                            <button class="acu-avatar-close"><i class="fa-solid fa-times"></i></button>\n                        </div>\n                    </div>\n                    <div class="acu-avatar-list" id="acu-avatar-list-container">\n                        <div style="text-align:center;padding:20px;color:${i.textSub};">\n                            <i class="fa-solid fa-spinner fa-spin"></i> 加载中...\n                        </div>\n                    </div>\n                </div>\n                <input type="file" id="acu-avatar-file-input" accept=".json" style="display:none;" />\n            </div>\n        `,s=$(c);$('body').append(s),(async()=>{let t='';const a=e.find(e=>'{{user}}'===r(e.name)),i=e.filter(e=>'{{user}}'!==r(e.name));if(a){const e={...a,name:'{{user}}'},i=o[e.name]||{};let r=i.url||'';const c=await U.hasLocalAvatar(e.name);let s='',l='';c?(s=await j.get(e.name),l='<span class="acu-avatar-source acu-source-local">本地</span>'):r&&(s=r,l='<span class="acu-avatar-source acu-source-url">URL</span>');const d=(i.aliases||[]).join(', '),u=!!s;t+=`\n                    <div class="acu-avatar-item" data-name="${n(e.name)}" data-has-local="${c}" data-display-url="${n(s)}">\n                        <div class="acu-avatar-preview-wrap">\n                            <div class="acu-avatar-preview ${u?'has-image':''}" style="${u?`background-image: url('${s}'); background-position: ${i.offsetX??50}% ${i.offsetY??50}%; background-size: ${i.scale??150}%;`:''}">\n                                ${u?'':`<span>${n(e.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                            </div>\n                            ${l}\n                        </div>\n                        <div class="acu-avatar-info">\n                            <div class="acu-avatar-name-row">\n                                <div class="acu-avatar-name">${n(e.name)}</div>\n                                <div class="acu-avatar-actions">\n                                    <button class="acu-avatar-save-btn" title="保存"><i class="fa-solid fa-check"></i></button>\n                                    <button class="acu-avatar-clear-btn" title="清除"><i class="fa-solid fa-trash"></i></button>\n                                </div>\n                            </div>\n                            <input type="text" class="acu-avatar-url" placeholder="粘贴URL..." value="${n(r)}" />\n                            <input type="text" class="acu-avatar-aliases" placeholder="别名（逗号分隔）..." value="${n(d)}" title="例如: 睦, 睦头" />\n                            <input type="file" accept="image/*" class="acu-avatar-file-input" style="display:none;" />\n                        </div>\n                    </div>\n                `}for(const e of i){const a=o[e.name]||{};let i=a.url||'';const r=await U.hasLocalAvatar(e.name);let c='',s='';r?(c=await j.get(e.name),s='<span class="acu-avatar-source acu-source-local">本地</span>'):i&&(c=i,s='<span class="acu-avatar-source acu-source-url">URL</span>');const l=(a.aliases||[]).join(', '),d=!!c;t+=`\n                    <div class="acu-avatar-item" data-name="${n(e.name)}" data-has-local="${r}" data-display-url="${n(c)}">\n                        <div class="acu-avatar-preview-wrap">\n                            <div class="acu-avatar-preview ${d?'has-image':''}" style="${d?`background-image: url('${c}'); background-position: ${a.offsetX??50}% ${a.offsetY??50}%; background-size: ${a.scale??150}%;`:''}">\n                                ${d?'':`<span>${n(e.name.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`}\n                            </div>\n                            ${s}\n                        </div>\n                        <div class="acu-avatar-info">\n                            <div class="acu-avatar-name-row">\n                                <div class="acu-avatar-name">${n(e.name)}</div>\n                                <div class="acu-avatar-actions">\n                                    <button class="acu-avatar-save-btn" title="保存"><i class="fa-solid fa-check"></i></button>\n                                    <button class="acu-avatar-clear-btn" title="清除"><i class="fa-solid fa-trash"></i></button>\n                                </div>\n                            </div>\n                            <input type="text" class="acu-avatar-url" placeholder="粘贴URL..." value="${n(i)}" />\n                            <input type="text" class="acu-avatar-aliases" placeholder="别名（逗号分隔）..." value="${n(l)}" title="例如: 睦, 睦头" />\n                            <input type="file" accept="image/*" class="acu-avatar-file-input" style="display:none;" />\n                        </div>\n                    </div>\n                `}return t})().then(e=>{s.find('#acu-avatar-list-container').html(e),d()});const l=async e=>{const t=s.find(`.acu-avatar-item[data-name="${e}"]`);if(!t.length)return;const a=U.getAll()[e]||{},i=await U.hasLocalAvatar(e);let o='',r='';i?(o=await j.get(e),r='<span class="acu-avatar-source acu-source-local">本地</span>'):a.url&&(o=a.url,r='<span class="acu-avatar-source acu-source-url">URL</span>');const c=t.find('.acu-avatar-preview');t.find('.acu-avatar-source').remove(),o?(c.addClass('has-image').css({'background-image':`url('${o}')`,'background-position':`${a.offsetX??50}% ${a.offsetY??50}%`,'background-size':`${a.scale??150}%`}).find('span').remove(),t.find('.acu-avatar-preview-wrap').append(r)):c.removeClass('has-image').css({'background-image':'','background-position':'','background-size':''}).html(`<span>${n(e.charAt(0))}</span><i class="fa-solid fa-camera acu-avatar-camera-hint"></i>`),t.attr('data-has-local',i),t.attr('data-display-url',o)},d=()=>{s.on('click','.acu-avatar-preview',async function(e){e.stopPropagation();const a=$(this).closest('.acu-avatar-item'),n=a.data('name'),i=a.attr('data-display-url');i?vt(i,n,async e=>{const a=U.getAll()[n]||{};U.set(n,a.url||'',e.offsetX,e.offsetY,e.scale,a.aliases||[]),await l(n),t&&t()}):a.find('.acu-avatar-file-input').click()}),s.on('change','.acu-avatar-file-input',async function(e){const a=e.target.files[0];if(!a)return;if(!a.type.startsWith('image/'))return void(window.toastr&&window.toastr.warning('请选择图片文件'));if(a.size>5242880)return void(window.toastr&&window.toastr.warning('图片大小不能超过 5MB'));const n=$(this).closest('.acu-avatar-item').data('name');try{if(await U.saveLocalAvatar(n,a)){const e=await j.get(n);await l(n),vt(e,n,async e=>{const a=U.getAll()[n]||{};U.set(n,a.url||'',e.offsetX,e.offsetY,e.scale,a.aliases||[]),await l(n),t&&t()})}}catch(e){console.error('[ACU] 上传头像失败:',e),window.toastr&&window.toastr.error('上传失败')}$(this).val('')}),s.on('click','.acu-avatar-save-btn',async function(){const e=$(this).closest('.acu-avatar-item'),a=e.data('name'),n=e.find('.acu-avatar-url').val().trim(),i=e.find('.acu-avatar-aliases').val().trim(),o=i?i.split(/[,，]/).map(e=>e.trim()).filter(e=>e&&e!==a):[],r=U.getAll()[a]||{};U.set(a,n,r.offsetX??50,r.offsetY??50,r.scale??150,o);const c='true'===e.attr('data-has-local');n&&!c?(await l(a),vt(n,a,async e=>{U.set(a,n,e.offsetX,e.offsetY,e.scale,o),await l(a),t&&t()})):(await l(a),t&&t())}),s.on('click','.acu-avatar-clear-btn',async function(){const e=$(this).closest('.acu-avatar-item'),a=e.data('name');await U.deleteLocalAvatar(a),U.remove(a),e.find('.acu-avatar-url').val(''),e.find('.acu-avatar-aliases').val(''),await l(a),t&&t()}),s.on('click','.acu-avatar-export-btn',function(){const e=U.exportData(),t=JSON.stringify(e,null,2),a=new Blob([t],{type:'application/json'}),n=URL.createObjectURL(a),i=document.createElement('a');i.href=n,i.download=`avatar-config-${(new Date).toISOString().slice(0,10)}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}),s.on('click','.acu-avatar-import-btn',function(){s.find('#acu-avatar-file-input').click()}),s.on('change','#acu-avatar-file-input',function(a){const n=a.target.files[0];if(!n)return;const i=new FileReader;i.onload=function(a){try{const n=JSON.parse(a.target.result),i=U.analyzeImport(n);if(!i.valid)return void(window.toastr&&window.toastr.error(i.error));yt(n,i,()=>{s.remove(),xt(e,t),t&&t()})}catch(e){console.error('[ACU] 导入解析失败:',e),window.toastr&&window.toastr.error('文件解析失败')}},i.readAsText(n),$(this).val('')})},u=()=>s.remove();s.on('click','.acu-avatar-close',u),s.on('click',function(e){$(e.target).hasClass('acu-avatar-manager-overlay')&&u()})},yt=(e,t,a)=>{const{$}=Pe();$('.acu-import-confirm-overlay').remove();const i=ae(),o=$t(),r=t.conflicts.length>0,c=t.conflicts.length>0?`<div style="max-height:80px;overflow-y:auto;background:rgba(0,0,0,0.1);border-radius:4px;padding:6px 8px;margin-top:6px;font-size:11px;color:${i.textSub};">${t.conflicts.map(e=>n(e)).join(', ')}</div>`:'',s=`\n            <div class="acu-import-confirm-overlay acu-theme-${o.theme}">\n                <div class="acu-import-confirm-dialog">\n                    <div class="acu-import-confirm-header">\n                        <i class="fa-solid fa-file-import"></i> 导入头像配置\n                    </div>\n                    <div class="acu-import-confirm-body">\n                        <div class="acu-import-stats">\n                            <div class="acu-import-stat">\n                                <span class="acu-stat-num">${t.total}</span>\n                                <span class="acu-stat-label">总计</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-new">\n                                <span class="acu-stat-num">${t.newItems.length}</span>\n                                <span class="acu-stat-label">新增</span>\n                            </div>\n                            <div class="acu-import-stat acu-stat-conflict">\n                                <span class="acu-stat-num">${t.conflicts.length}</span>\n                                <span class="acu-stat-label">冲突</span>\n                            </div>\n                        </div>\n\n                        ${r?`\n                            <div class="acu-import-conflict-section">\n                                <div style="font-size:12px;font-weight:bold;color:${i.textMain};margin-bottom:4px;">\n                                    <i class="fa-solid fa-exclamation-triangle" style="color:${i.warningIcon};"></i> 以下角色已存在：\n                                </div>\n                                ${c}\n                                <div class="acu-import-conflict-options">\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="overwrite" checked />\n                                        <span>用导入的覆盖本地</span>\n                                    </label>\n                                    <label class="acu-import-radio">\n                                        <input type="radio" name="conflict-mode" value="skip" />\n                                        <span>保留本地的不变</span>\n                                    </label>\n                                </div>\n                            </div>\n                        `:`\n                            <div style="text-align:center;padding:10px;color:${i.successText};">\n                                <i class="fa-solid fa-check-circle"></i> 无冲突，可直接导入\n                            </div>\n                        `}\n                    </div>\n                    <div class="acu-import-confirm-footer">\n                        <button class="acu-import-cancel-btn">取消</button>\n                        <button class="acu-import-confirm-btn">确认导入</button>\n                    </div>\n                </div>\n            </div>\n        `,l=$(s);$('body').append(l);l[0].style.cssText='\n            position: fixed !important;\n            top: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            bottom: 0 !important;\n            width: 100vw !important;\n            height: 100vh !important;\n            background: rgba(0,0,0,0.6) !important;\n            z-index: 2147483655 !important;\n            display: flex;\n            justify-content: center !important;\n            align-items: center !important;\n            padding: 16px;\n            box-sizing: border-box !important;\n        ';const d=()=>l.remove();l.find('.acu-import-cancel-btn').click(d),l.on('click',function(e){$(e.target).hasClass('acu-import-confirm-overlay')&&d()}),l.find('.acu-import-confirm-btn').click(function(){const t='skip'!==l.find('input[name="conflict-mode"]:checked').val();try{U.importData(e,t);d(),a&&a()}catch(e){console.error('[ACU] 导入失败:',e),window.toastr&&window.toastr.error('导入失败：'+e.message)}})},wt=(e,t,a,i,o)=>{const{$}=Pe(),r=$t();let c=xe||zt()||Je(),s=e;c&&c[o]&&c[o]?.content?.[i+1]&&(s=c[o]?.content?.[i+1]);const l=s.map((e,a)=>{if(0===a)return'';const i=t[a]||`列 ${a}`,o=e||'';return`\n                <div class="acu-card-edit-field" style="margin-bottom: 10px;">\n                    <label style="display:block;font-size:12px;color:var(--acu-accent);font-weight:bold;margin-bottom:4px;">${n(i)}</label>\n                    <textarea class="acu-card-edit-input acu-edit-textarea" data-col="${a}" spellcheck="false" rows="1"\n                    style="width:100%;min-height:40px;max-height:500px;padding:10px;resize:none;overflow-y:hidden;">${n(o)}</textarea>\n                </div>`}).join(''),d=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${r.theme}">\n                    <div class="acu-edit-title">整体编辑 (#${i+1} - ${n(a)})</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${l}\n                    </div>\n                     <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-card-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-card-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(d);const u=e=>{e.style.height='auto';const t=e.scrollHeight+2;e.style.height=Math.min(t,500)+'px',e.style.overflowY=t>500?'auto':'hidden'};requestAnimationFrame(()=>{d.find('textarea').each(function(){u(this)})}),d.find('textarea').on('input',function(){u(this)});const p=()=>d.remove();d.find('#dlg-card-cancel').click(p),d.find('#dlg-card-save').click(async()=>{let e=xe||zt()||Je();if(e&&e[o]){const t=e[o]?.content?.[i+1];if(!t)return void p();let a=!1;d.find('textarea').each(function(){const e=parseInt($(this).data('col')),n=$(this).val();String(t[e])!==String(n)&&(a=!0,t[e]=n)}),a&&(await At(e,!1,!0),Lt())}p()}),d.on('click',function(e){($(e.target).hasClass('acu-edit-overlay')||$(e.target).closest('#dlg-close-x, #dlg-close, .acu-close-btn').length)&&p()})};let kt=null;const $t=()=>(kt||(kt={...Ie,...Fe.get(u,{})}),kt),_t=e=>{kt={...$t(),...e},Fe.set(u,kt),St(kt)},Ct=e=>{const t=Je(),a=new Set;if(!t)return a;for(const n in e){const i=e[n],o=t[n];if(!i||!i.name)continue;const r=i.name;if(!o){i.content&&i.content.forEach((e,t)=>{t>0&&a.add(`${r}-row-${t-1}`)});continue}const c=i.content||[],s=o.content||[];c.forEach((e,t)=>{if(0===t)return;const n=s[t];n?e.forEach((e,i)=>{if(0===i)return;const o=n[i];String(e)!==String(o)&&a.add(`${r}-${t-1}-${i}`)}):a.add(`${r}-row-${t-1}`)})}return a},St=e=>{const{$}=Pe(),t=$('.acu-wrapper'),a=Me.find(t=>t.id===e.fontFamily)?.val||Me[0].val,n=$('#acu-dynamic-font');if(n.data('font-id')!==e.fontFamily){n.remove();const t='\n                @import url("https://fontsapi.zeoseven.com/3/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/442/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/256/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/482/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/446/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/570/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/292/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/69/main/result.css");\n                @import url("https://fontsapi.zeoseven.com/7/main/result.css");\n            ';$('head').append(`\n                <style id="acu-dynamic-font" data-font-id="${e.fontFamily}">\n                    ${t}\n                    .acu-wrapper, .acu-edit-dialog, .acu-cell-menu, .acu-nav-container, .acu-data-card, .acu-panel-title, .acu-settings-label, .acu-btn-block, .acu-nav-btn, .acu-edit-textarea {\n                        font-family: ${a} !important;\n                    }\n                </style>\n            `)}const i={'--acu-card-width':`${e.cardWidth}px`,'--acu-font-size':`${e.fontSize}px`,'--acu-opt-font-size':`${e.optionFontSize||12}px`,'--acu-grid-cols':e.gridColumns};t.length&&(t.removeClass((e,t)=>(t.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),t.addClass(`acu-theme-${e.theme}`),t.css(i));const o=$('.acu-embedded-options-container');o.length&&(o.removeClass((e,t)=>(t.match(/(^|\s)acu-theme-\S+/g)||[]).join(' ')),o.addClass(`acu-theme-${e.theme}`),o.css(i))},Tt=()=>{if(window._acuStylesInjected&&$(`#${e}-styles`).length)return;window._acuStylesInjected=!0;const{$}=Pe();$('style').each(function(){this.id&&this.id.startsWith('acu_')&&this.id.endsWith('-styles')&&this.id!==`${e}-styles`&&$(this).remove()}),$(`#${e}-styles`).remove();const t=`\n        <style id="${e}-styles">\n    /* ========== 核心隔离层 ========== */\n    .acu-wrapper,\n    .acu-wrapper *:not(i[class*="fa-"]),\n    .acu-edit-overlay,\n    .acu-edit-overlay *:not(i[class*="fa-"]),\n    .acu-cell-menu,\n    .acu-cell-menu *:not(i[class*="fa-"]),\n    .acu-dice-panel,\n    .acu-dice-panel *:not(i[class*="fa-"]),\n    .acu-contest-panel,\n    .acu-contest-panel *:not(i[class*="fa-"]),\n    .acu-relation-graph-overlay,\n    .acu-relation-graph-overlay *:not(i[class*="fa-"]),\n    .acu-avatar-manager-overlay,\n    .acu-avatar-manager-overlay *:not(i[class*="fa-"]),\n    .acu-preview-overlay,\n    .acu-preview-overlay *:not(i[class*="fa-"]),\n    .acu-import-confirm-overlay,\n    .acu-import-confirm-overlay *:not(i[class*="fa-"]),\n    .acu-embedded-options-container,\n    .acu-embedded-options-container *:not(i[class*="fa-"]) {\n        box-sizing: border-box;\n        -webkit-tap-highlight-color: transparent;\n        -webkit-font-smoothing: antialiased;\n    }\n    /* ========== 基础样式 ========== */\n    .acu-wrapper,\n    .acu-edit-overlay,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-embedded-options-container,\n    .acu-cell-menu {\n        font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;\n        font-size: 13px;\n        line-height: 1.5;\n        color: var(--acu-text-main);\n    }\n    /* 投骰面板统一样式 (需要 !important 覆盖 SillyTavern 全局样式和内联样式) */\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    .acu-dice-panel input[type="text"],\n    .acu-dice-panel input[type="number"],\n    .acu-dice-panel input:not([type]),\n    .acu-dice-panel select,\n    .acu-contest-panel input[type="text"],\n    .acu-contest-panel input[type="number"],\n    .acu-contest-panel input:not([type]),\n    .acu-contest-panel select,\n    .acu-dice-config-dialog input[type="text"],\n    .acu-dice-config-dialog input[type="number"],\n    .acu-dice-config-dialog input:not([type]),\n    .acu-dice-config-dialog select {\n        width: 100%;\n        padding: 6px;\n        background: var(--acu-input-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 4px;\n        color: var(--acu-text-main) !important;\n        font-size: 12px;\n    }\n    /* 隐藏number类型输入框的步数器 */\n    .acu-dice-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-inner-spin-button,\n    .acu-contest-panel input[type="number"]::-webkit-outer-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-inner-spin-button,\n    .acu-dice-config-dialog input[type="number"]::-webkit-outer-spin-button {\n        -webkit-appearance: none;\n        margin: 0;\n    }\n    .acu-dice-panel input[type="number"],\n    .acu-contest-panel input[type="number"],\n    .acu-dice-config-dialog input[type="number"] {\n        -moz-appearance: textfield;\n        text-align: center;\n        box-sizing: border-box;\n    }\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-dice-config-dialog input::placeholder {\n        color: var(--acu-text-sub) !important;\n        opacity: 0.7;\n    }\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-dice-config-dialog input:focus,\n    .acu-dice-config-dialog select:focus {\n        outline: none;\n        border-color: var(--acu-accent) !important;\n    }\n    .acu-dice-panel select option,\n    .acu-contest-panel select option,\n    .acu-dice-config-dialog select option {\n        background: var(--acu-bg-panel);\n        color: var(--acu-text-main);\n    }\n    /* 投骰面板下拉框统一样式 */\n    .acu-dice-select {\n        width: 100%;\n        padding: 6px 4px;\n        background: var(--acu-input-bg) !important;\n        border: 1px solid var(--acu-border) !important;\n        border-radius: 4px;\n        color: var(--acu-text-main) !important;\n        font-size: 11px;\n        box-sizing: border-box;\n        cursor: pointer;\n        -webkit-appearance: none;\n        appearance: none;\n    }\n    .acu-dice-select:focus {\n        outline: none;\n        border-color: var(--acu-accent) !important;\n    }\n    .acu-dice-select option {\n        background: var(--acu-bg-panel) !important;\n        color: var(--acu-text-main) !important;\n    }\n    /* 搜索框样式 */\n    .acu-wrapper .acu-search-input {\n        background-color: var(--acu-input-bg) !important;\n        color: var(--acu-text-main) !important;\n        border: 1px solid var(--acu-border);\n    }\n    .acu-wrapper .acu-search-input:focus {\n        outline: none;\n        border-color: var(--acu-accent);\n        box-shadow: none !important;\n    }\n    .acu-wrapper .acu-search-input::placeholder {\n        color: var(--acu-text-sub) !important;\n        opacity: 0.7;\n    }\n    /* ========== 通用组件基类 ========== */\n    /* 按钮基类 */\n    .acu-wrapper button,\n    .acu-edit-overlay button,\n    .acu-dice-panel button,\n    .acu-contest-panel button,\n    .acu-relation-graph-overlay button,\n    .acu-avatar-manager-overlay button,\n    .acu-preview-overlay button,\n    .acu-embedded-options-container button {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        cursor: pointer;\n        border: 1px solid var(--acu-border);\n        border-radius: 6px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        transition: all 0.2s ease;\n        outline: none;\n    }\n    .acu-wrapper button:hover,\n    .acu-edit-overlay button:hover,\n    .acu-dice-panel button:hover,\n    .acu-contest-panel button:hover,\n    .acu-relation-graph-overlay button:hover,\n    .acu-avatar-manager-overlay button:hover,\n    .acu-preview-overlay button:hover,\n    .acu-embedded-options-container button:hover {\n        background: var(--acu-btn-hover);\n    }\n    .acu-wrapper button:focus,\n    .acu-edit-overlay button:focus,\n    .acu-dice-panel button:focus,\n    .acu-contest-panel button:focus,\n    .acu-relation-graph-overlay button:focus,\n    .acu-avatar-manager-overlay button:focus,\n    .acu-preview-overlay button:focus,\n    .acu-embedded-options-container button:focus {\n        outline: none;\n        box-shadow: none;\n    }\n\n    /* 输入框基类 */\n    .acu-wrapper input,\n    .acu-wrapper textarea,\n    .acu-wrapper select,\n    .acu-edit-overlay input,\n    .acu-edit-overlay textarea,\n    .acu-edit-overlay select,\n    .acu-dice-panel input,\n    .acu-dice-panel select,\n    .acu-contest-panel input,\n    .acu-contest-panel select,\n    .acu-avatar-manager-overlay input {\n        font-family: inherit;\n        font-size: inherit;\n        line-height: 1.4;\n        border: 1px solid var(--acu-border);\n        border-radius: 4px;\n        background: var(--acu-btn-bg);\n        color: var(--acu-text-main);\n        outline: none;\n        transition: border-color 0.2s;\n    }\n    .acu-wrapper input:focus,\n    .acu-wrapper textarea:focus,\n    .acu-wrapper select:focus,\n    .acu-edit-overlay input:focus,\n    .acu-edit-overlay textarea:focus,\n    .acu-edit-overlay select:focus,\n    .acu-dice-panel input:focus,\n    .acu-dice-panel select:focus,\n    .acu-contest-panel input:focus,\n    .acu-contest-panel select:focus,\n    .acu-avatar-manager-overlay input:focus {\n        border-color: var(--acu-accent);\n        box-shadow: none;\n        outline: none;\n    }\n    .acu-wrapper input::placeholder,\n    .acu-wrapper textarea::placeholder,\n    .acu-dice-panel input::placeholder,\n    .acu-contest-panel input::placeholder,\n    .acu-avatar-manager-overlay input::placeholder {\n        color: var(--acu-text-sub);\n        opacity: 0.7;\n    }\n\n    /* 弹窗遮罩层基类 */\n    .acu-edit-overlay,\n    .acu-dice-overlay,\n    .acu-contest-overlay,\n    .acu-relation-graph-overlay,\n    .acu-avatar-manager-overlay,\n    .acu-preview-overlay,\n    .acu-import-confirm-overlay,\n    .acu-dice-config-overlay,\n    .acu-crop-modal-overlay {\n        position: fixed;\n        top: 0;\n        left: 0;\n        right: 0;\n        bottom: 0;\n        width: 100vw;\n        height: 100vh;\n        background: rgba(0,0,0,0.6);\n        z-index: 2147483646;\n        display: flex;\n        justify-content: center;\n        align-items: center;\n        padding: 16px;\n        backdrop-filter: blur(2px);\n    }\n\n    /* 弹窗容器基类 */\n    .acu-edit-dialog,\n    .acu-dice-panel,\n    .acu-contest-panel,\n    .acu-relation-graph-container,\n    .acu-avatar-manager,\n    .acu-preview-card,\n    .acu-import-confirm-dialog,\n    .acu-dice-config-dialog {\n        background: var(--acu-bg-panel);\n        border: 1px solid var(--acu-border);\n        border-radius: 12px;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.4);\n        overflow: hidden;\n        display: flex;\n        flex-direction: column;\n    }\n\n    /* 弹窗头部基类 - 统一使用 .acu-panel-header */\n    .acu-panel-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 12px 15px;\n        background: var(--acu-table-head);\n        border-bottom: 1px solid var(--acu-border);\n        flex-shrink: 0;\n    }\n\n    /* 关闭按钮基类 - 所有关闭按钮统一使用 .acu-close-btn */\n    .acu-close-btn {\n        background: none;\n        border: none;\n        color: var(--acu-text-sub);\n        cursor: pointer;\n        font-size: 16px;\n        padding: 4px 8px;\n        border-radius: 4px;\n        transition: all 0.2s;\n    }\n    .acu-close-btn:hover {\n        background: var(--acu-error-bg, rgba(231, 76, 60, 0.15));\n        color: var(--acu-error-text, #e74c3c);\n    }\n\n    /* 滚动条全局隐藏 */\n    [class^="acu-"], [class^="acu-"] * { scrollbar-width: none; -ms-overflow-style: none; }\n    [class^="acu-"] *::-webkit-scrollbar { display: none !important; }\n\n    /* ========== 主题变量定义 ========== */\n    .acu-theme-retro { --acu-bg-nav: #e6e2d3; --acu-bg-panel: #e6e2d3; --acu-border: #dcd0c0; --acu-text-main: #5e4b35; --acu-text-sub: #999; --acu-btn-bg: #dcd0c0; --acu-btn-hover: #cbbba8; --acu-btn-active-bg: #8d7b6f; --acu-btn-active-text: #fdfaf5; --acu-accent: #7a695f; --acu-table-head: #efebe4; --acu-table-hover: #f0ebe0; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #fffef9; --acu-badge-bg: #efebe4; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #27ae60; --acu-success-bg: rgba(39, 174, 96, 0.15); --acu-scrollbar-track: #e6e2d3; --acu-scrollbar-thumb: #cbbba8; --acu-input-bg: #f5f2eb;--acu-hl-manual: #d35400; --acu-hl-manual-bg: rgba(211, 84, 0, 0.15); --acu-hl-diff: #2980b9; --acu-hl-diff-bg: rgba(41, 128, 185, 0.15); --acu-error-text: #e74c3c; --acu-error-bg: rgba(231, 76, 60, 0.15); --acu-error-border: rgba(231, 76, 60, 0.5); --acu-warning-icon: #e67e22; --acu-failure-text: #e74c3c; --acu-failure-bg: rgba(231, 76, 60, 0.15); --acu-warning-text: #f39c12; --acu-warning-bg: rgba(243, 156, 18, 0.15); --acu-crit-success-text: #9b59b6; --acu-crit-success-bg: rgba(155, 89, 182, 0.15); --acu-crit-failure-text: #c0392b; --acu-crit-failure-bg: rgba(192, 57, 43, 0.15); --acu-extreme-success-text: #2980b9; --acu-extreme-success-bg: rgba(41, 128, 185, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #5e4b35; --acu-gray-bg: rgba(128,128,128,0.1); }\n    .acu-theme-dark { --acu-bg-nav: #2b2b2b; --acu-bg-panel: #252525; --acu-border: #444; --acu-text-main: #eee; --acu-text-sub: #aaa; --acu-btn-bg: #3a3a3a; --acu-btn-hover: #4a4a4a; --acu-btn-active-bg: #6a5acd; --acu-btn-active-text: #fff; --acu-accent: #9b8cd9; --acu-table-head: #333333; --acu-table-hover: #3a3a3a; --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #2d3035; --acu-badge-bg: #3a3f4b; --acu-menu-bg: #333; --acu-menu-text: #eee; --acu-success-text: #4cd964; --acu-success-bg: rgba(76, 217, 100, 0.2); --acu-scrollbar-track: #2b2b2b; --acu-scrollbar-thumb: #555; --acu-hl-manual: #ff6b81; --acu-hl-manual-bg: rgba(255, 107, 129, 0.2); --acu-hl-diff: #00d2d3; --acu-hl-diff-bg: rgba(0, 210, 211, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-failure-text: #ff6b6b; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-crit-success-text: #ba68c8; --acu-crit-success-bg: rgba(186, 104, 200, 0.2); --acu-crit-failure-text: #d32f2f; --acu-crit-failure-bg: rgba(211, 47, 47, 0.2); --acu-extreme-success-text: #42a5f5; --acu-extreme-success-bg: rgba(66, 165, 245, 0.2); --acu-overlay-bg: rgba(0,0,0,0.75); --acu-overlay-bg-light: rgba(0,0,0,0.65); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255,255,255,0.05); --acu-very-light-bg: rgba(255,255,255,0.02); --acu-button-text: #fff; --acu-gray-bg: rgba(255,255,255,0.1); }\n    .acu-theme-modern { --acu-bg-nav: #ffffff; --acu-bg-panel: #f8f9fa; --acu-border: #e0e0e0; --acu-text-main: #333; --acu-text-sub: #666; --acu-btn-bg: #f1f3f5; --acu-btn-hover: #e9ecef; --acu-btn-active-bg: #007bff; --acu-btn-active-text: #fff; --acu-accent: #007bff; --acu-table-head: #f8f9fa; --acu-table-hover: #f1f3f5; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #f1f3f5; --acu-menu-bg: #fff; --acu-menu-text: #333; --acu-success-text: #28a745; --acu-success-bg: rgba(40, 167, 69, 0.15); --acu-scrollbar-track: #fff; --acu-scrollbar-thumb: #ccc; --acu-hl-manual: #fd7e14; --acu-hl-manual-bg: rgba(253, 126, 20, 0.15); --acu-hl-diff: #0d6efd; --acu-hl-diff-bg: rgba(13, 110, 253, 0.15); --acu-error-text: #dc3545; --acu-error-bg: rgba(220, 53, 69, 0.15); --acu-error-border: rgba(220, 53, 69, 0.5); --acu-warning-icon: #fd7e14; --acu-failure-text: #dc3545; --acu-failure-bg: rgba(220, 53, 69, 0.15); --acu-warning-text: #ffc107; --acu-warning-bg: rgba(255, 193, 7, 0.15); --acu-crit-success-text: #6f42c1; --acu-crit-success-bg: rgba(111, 66, 193, 0.15); --acu-crit-failure-text: #c82333; --acu-crit-failure-bg: rgba(200, 35, 51, 0.15); --acu-extreme-success-text: #17a2b8; --acu-extreme-success-bg: rgba(23, 162, 184, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #333; --acu-gray-bg: rgba(128,128,128,0.1); }\n    .acu-theme-forest { --acu-bg-nav: #e8f5e9; --acu-bg-panel: #e8f5e9; --acu-border: #c8e6c9; --acu-text-main: #2e7d32; --acu-text-sub: #81c784; --acu-btn-bg: #c8e6c9; --acu-btn-hover: #a5d6a7; --acu-btn-active-bg: #43a047; --acu-btn-active-text: #fff; --acu-accent: #4caf50; --acu-table-head: #dcedc8; --acu-table-hover: #f1f8e9; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #dcedc8; --acu-menu-bg: #fff; --acu-menu-text: #2e7d32; --acu-success-text: #2e7d32; --acu-success-bg: rgba(46, 125, 50, 0.2); --acu-scrollbar-track: #e8f5e9; --acu-scrollbar-thumb: #a5d6a7; --acu-hl-manual: #e67e22; --acu-hl-manual-bg: rgba(230, 126, 34, 0.15); --acu-hl-diff: #1e8449; --acu-hl-diff-bg: rgba(30, 132, 73, 0.2); --acu-button-text: #2e7d32; }\n    .acu-theme-ocean { --acu-bg-nav: #e3f2fd; --acu-bg-panel: #e3f2fd; --acu-border: #90caf9; --acu-text-main: #1565c0; --acu-text-sub: #64b5f6; --acu-btn-bg: #bbdefb; --acu-btn-hover: #90caf9; --acu-btn-active-bg: #1976d2; --acu-btn-active-text: #fff; --acu-accent: #2196f3; --acu-table-head: #bbdefb; --acu-table-hover: #e1f5fe; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #e3f2fd; --acu-menu-bg: #fff; --acu-menu-text: #1565c0; --acu-success-text: #0288d1; --acu-success-bg: rgba(2, 136, 209, 0.15); --acu-scrollbar-track: #e3f2fd; --acu-scrollbar-thumb: #90caf9; --acu-hl-manual: #ff4757; --acu-hl-manual-bg: rgba(255, 71, 87, 0.15); --acu-hl-diff: #0277bd; --acu-hl-diff-bg: rgba(2, 119, 189, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-failure-text: #d32f2f; --acu-failure-bg: rgba(211, 47, 47, 0.15); --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-crit-success-text: #7b1fa2; --acu-crit-success-bg: rgba(123, 31, 162, 0.15); --acu-crit-failure-text: #b71c1c; --acu-crit-failure-bg: rgba(183, 28, 28, 0.15); --acu-extreme-success-text: #0277bd; --acu-extreme-success-bg: rgba(2, 119, 189, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(0,0,0,0.1); --acu-very-light-bg: rgba(0,0,0,0.02); --acu-button-text: #1565c0; --acu-gray-bg: rgba(128,128,128,0.1); }\n    .acu-theme-cyber { --acu-bg-nav: #000000; --acu-bg-panel: #0a0a0a; --acu-border: #333; --acu-text-main: #00ffcc; --acu-text-sub: #ff00ff; --acu-btn-bg: #111; --acu-btn-hover: #222; --acu-btn-active-bg: #ff00ff; --acu-btn-active-text: #fff; --acu-accent: #00ffcc; --acu-table-head: #050505; --acu-table-hover: #111; --acu-shadow: 0 0 15px rgba(0,255,204,0.15); --acu-card-bg: #050505; --acu-badge-bg: #1a1a1a; --acu-menu-bg: #111; --acu-menu-text: #00ffcc; --acu-success-text: #0f0; --acu-success-bg: rgba(0, 255, 0, 0.15); --acu-scrollbar-track: #000; --acu-scrollbar-thumb: #333; --acu-hl-manual: #ff9f43; --acu-hl-manual-bg: rgba(255, 159, 67, 0.2); --acu-hl-diff: #0abde3; --acu-hl-diff-bg: rgba(10, 189, 227, 0.2); }\n    .acu-theme-cyber .acu-nav-btn { border-color: #222; }\n    .acu-theme-cyber .acu-data-card { border-color: #222; }\n    .acu-theme-cyber .acu-dice-panel input::placeholder,\n    .acu-theme-cyber .acu-contest-panel input::placeholder {\n        color: #ff00ff !important;\n        opacity: 0.7;\n    }\n    .acu-theme-cyber .acu-dice-panel input[type="text"],\n    .acu-theme-cyber .acu-dice-panel input[type="number"],\n    .acu-theme-cyber .acu-dice-panel input:not([type]),\n    .acu-theme-cyber .acu-contest-panel input[type="text"],\n    .acu-theme-cyber .acu-contest-panel input[type="number"],\n    .acu-theme-cyber .acu-contest-panel input:not([type]) {\n        color: #ff00ff !important;\n    }\n    .acu-theme-nightowl { --acu-bg-nav: #0a2133; --acu-bg-panel: #011627; --acu-border: #132e45; --acu-text-main: #e0e6f2; --acu-text-sub: #a6b8cc; --acu-btn-bg: #1f3a52; --acu-btn-hover: #2a4a68; --acu-btn-active-bg: #7fdbca; --acu-btn-active-text: #011627; --acu-accent: #7fdbca; --acu-table-head: #0a2133; --acu-table-hover: #01294a; --acu-shadow: rgba(0,0,0,0.5); --acu-card-bg: #0a2133; --acu-badge-bg: #1f3a52; --acu-menu-bg: #011627; --acu-menu-text: #e0e6f2; --acu-success-text: #addb67; --acu-success-bg: rgba(173, 219, 103, 0.15); --acu-scrollbar-track: #011627; --acu-scrollbar-thumb: #1f3a52; --acu-hl-manual: #ff8f66; --acu-hl-manual-bg: rgba(255, 143, 102, 0.2); --acu-hl-diff: #82aaff; --acu-hl-diff-bg: rgba(130, 170, 255, 0.2); }\n    .acu-theme-sakura { --acu-bg-nav: #F9F0EF; --acu-bg-panel: #F9F0EF; --acu-border: #EBDCD9; --acu-text-main: #6B5552; --acu-text-sub: #C08D8D; --acu-btn-bg: #EBDCD9; --acu-btn-hover: #D8C7C4; --acu-btn-active-bg: #C08D8D; --acu-btn-active-text: #F9F0EF; --acu-accent: #C08D8D; --acu-table-head: #F9F0EF; --acu-table-hover: #F5EAE8; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #F9F0EF; --acu-menu-bg: #fff; --acu-menu-text: #6B5552; --acu-success-text: #6B5552; --acu-success-bg: rgba(192, 141, 141, 0.12); --acu-scrollbar-track: #F9F0EF; --acu-scrollbar-thumb: #EBDCD9; --acu-hl-manual: #A68A7A; --acu-hl-manual-bg: rgba(166, 138, 122, 0.12); --acu-hl-diff: #9B7A7A; --acu-hl-diff-bg: rgba(155, 122, 122, 0.2); --acu-error-text: #9B7A7A; --acu-error-bg: rgba(155, 122, 122, 0.12); --acu-error-border: rgba(155, 122, 122, 0.4); --acu-warning-icon: #A68A7A; --acu-failure-text: #9B7A7A; --acu-failure-bg: rgba(155, 122, 122, 0.12); --acu-warning-text: #A68A7A; --acu-warning-bg: rgba(166, 138, 122, 0.12); --acu-crit-success-text: #8B7A7A; --acu-crit-success-bg: rgba(139, 122, 122, 0.12); --acu-crit-failure-text: #8B6F6F; --acu-crit-failure-bg: rgba(139, 111, 111, 0.12); --acu-extreme-success-text: #9B8A8A; --acu-extreme-success-bg: rgba(155, 138, 138, 0.12); --acu-overlay-bg: rgba(107, 85, 82, 0.6); --acu-overlay-bg-light: rgba(107, 85, 82, 0.5); --acu-shadow-bg: rgba(107, 85, 82, 0.3); --acu-light-bg: rgba(192, 141, 141, 0.08); --acu-very-light-bg: rgba(192, 141, 141, 0.02); --acu-button-text: #6B5552; --acu-gray-bg: rgba(192, 141, 141, 0.08); }\n    .acu-theme-minepink { --acu-bg-nav: #1a1a1a; --acu-bg-panel: #1a1a1a; --acu-border: #333333; --acu-text-main: #ffb3d9; --acu-text-sub: #ff80c1; --acu-btn-bg: #2a2a2a; --acu-btn-hover: #3a3a3a; --acu-btn-active-bg: #ff80c1; --acu-btn-active-text: #1a1a1a; --acu-accent: #ff80c1; --acu-table-head: #252525; --acu-table-hover: #2a2a2a; --acu-shadow: rgba(0,0,0,0.6); --acu-card-bg: #222222; --acu-badge-bg: #2a2a2a; --acu-menu-bg: #1a1a1a; --acu-menu-text: #ffb3d9; --acu-success-text: #ff80c1; --acu-success-bg: rgba(255, 128, 193, 0.2); --acu-scrollbar-track: #1a1a1a; --acu-scrollbar-thumb: #333333; --acu-hl-manual: #ffa726; --acu-hl-manual-bg: rgba(255, 167, 38, 0.2); --acu-hl-diff: #ff80c1; --acu-hl-diff-bg: rgba(255, 128, 193, 0.2); --acu-error-text: #ff6b6b; --acu-error-bg: rgba(255, 107, 107, 0.2); --acu-error-border: rgba(255, 107, 107, 0.5); --acu-warning-icon: #ffa726; --acu-failure-text: #ff6b6b; --acu-failure-bg: rgba(255, 107, 107, 0.2); --acu-warning-text: #ffa726; --acu-warning-bg: rgba(255, 167, 38, 0.2); --acu-crit-success-text: #ff80c1; --acu-crit-success-bg: rgba(255, 128, 193, 0.2); --acu-crit-failure-text: #ff4444; --acu-crit-failure-bg: rgba(255, 68, 68, 0.2); --acu-extreme-success-text: #ffb3d9; --acu-extreme-success-bg: rgba(255, 179, 217, 0.2); --acu-overlay-bg: rgba(0,0,0,0.8); --acu-overlay-bg-light: rgba(0,0,0,0.7); --acu-shadow-bg: rgba(0,0,0,0.6); --acu-light-bg: rgba(255, 128, 193, 0.1); --acu-very-light-bg: rgba(255, 128, 193, 0.02); --acu-button-text: #1a1a1a; --acu-gray-bg: rgba(255, 128, 193, 0.1); }\n    .acu-theme-purple { --acu-bg-nav: #f3e5f5; --acu-bg-panel: #f3e5f5; --acu-border: #ce93d8; --acu-text-main: #6a1b9a; --acu-text-sub: #9c27b0; --acu-btn-bg: #e1bee7; --acu-btn-hover: #ce93d8; --acu-btn-active-bg: #9c27b0; --acu-btn-active-text: #fff; --acu-accent: #9c27b0; --acu-table-head: #f8e1f5; --acu-table-hover: #fce4ec; --acu-shadow: rgba(0,0,0,0.15); --acu-card-bg: #ffffff; --acu-badge-bg: #f8e1f5; --acu-menu-bg: #fff; --acu-menu-text: #6a1b9a; --acu-success-text: #6a1b9a; --acu-success-bg: rgba(106, 27, 154, 0.15); --acu-scrollbar-track: #f3e5f5; --acu-scrollbar-thumb: #ce93d8; --acu-hl-manual: #f57c00; --acu-hl-manual-bg: rgba(245, 124, 0, 0.15); --acu-hl-diff: #6a1b9a; --acu-hl-diff-bg: rgba(106, 27, 154, 0.2); --acu-error-text: #d32f2f; --acu-error-bg: rgba(211, 47, 47, 0.15); --acu-error-border: rgba(211, 47, 47, 0.5); --acu-warning-icon: #f57c00; --acu-failure-text: #d32f2f; --acu-failure-bg: rgba(211, 47, 47, 0.15); --acu-warning-text: #f57c00; --acu-warning-bg: rgba(245, 124, 0, 0.15); --acu-crit-success-text: #7b1fa2; --acu-crit-success-bg: rgba(123, 31, 162, 0.15); --acu-crit-failure-text: #b71c1c; --acu-crit-failure-bg: rgba(183, 28, 28, 0.15); --acu-extreme-success-text: #6a1b9a; --acu-extreme-success-bg: rgba(106, 27, 154, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.4); --acu-light-bg: rgba(156, 39, 176, 0.1); --acu-very-light-bg: rgba(156, 39, 176, 0.02); --acu-button-text: #6a1b9a; --acu-gray-bg: rgba(156, 39, 176, 0.1); }\n    .acu-theme-wechat { --acu-bg-nav: #F7F7F7; --acu-bg-panel: #F7F7F7; --acu-border: #E5E5E5; --acu-text-main: #333333; --acu-text-sub: #666666; --acu-btn-bg: #E5E5E5; --acu-btn-hover: #D5D5D5; --acu-btn-active-bg: #09B83E; --acu-btn-active-text: #FFFFFF; --acu-accent: #09B83E; --acu-table-head: #F0F0F0; --acu-table-hover: #EBEBEB; --acu-shadow: rgba(0,0,0,0.1); --acu-card-bg: #ffffff; --acu-badge-bg: #F0F0F0; --acu-menu-bg: #fff; --acu-menu-text: #333333; --acu-success-text: #09B83E; --acu-success-bg: rgba(9, 184, 62, 0.12); --acu-scrollbar-track: #F7F7F7; --acu-scrollbar-thumb: #E5E5E5; --acu-hl-manual: #FF9500; --acu-hl-manual-bg: rgba(255, 149, 0, 0.12); --acu-hl-diff: #09B83E; --acu-hl-diff-bg: rgba(9, 184, 62, 0.2); --acu-error-text: #E53E3E; --acu-error-bg: rgba(229, 62, 62, 0.12); --acu-error-border: rgba(229, 62, 62, 0.5); --acu-warning-icon: #FF9500; --acu-failure-text: #E53E3E; --acu-failure-bg: rgba(229, 62, 62, 0.12); --acu-warning-text: #FF9500; --acu-warning-bg: rgba(255, 149, 0, 0.12); --acu-crit-success-text: #07A832; --acu-crit-success-bg: rgba(7, 168, 50, 0.15); --acu-crit-failure-text: #C53030; --acu-crit-failure-bg: rgba(197, 48, 48, 0.15); --acu-extreme-success-text: #09B83E; --acu-extreme-success-bg: rgba(9, 184, 62, 0.15); --acu-overlay-bg: rgba(0,0,0,0.6); --acu-overlay-bg-light: rgba(0,0,0,0.5); --acu-shadow-bg: rgba(0,0,0,0.2); --acu-light-bg: rgba(9, 184, 62, 0.08); --acu-very-light-bg: rgba(9, 184, 62, 0.02); --acu-button-text: #333333; --acu-gray-bg: rgba(9, 184, 62, 0.08); }\n    /* 浅色强调色主题的按钮文字修正 */\n    .acu-theme-cyber .acu-btn-confirm,\n    .acu-theme-cyber .acu-changes-count,\n    .acu-theme-nightowl .acu-btn-confirm,\n    .acu-theme-nightowl .acu-changes-count {\n        color: #111 !important;\n    }\n    /* Night Owl主题：数据验证和表格管理框框使用更暗的边框 */\n    .acu-theme-nightowl .acu-table-manager-item,\n    .acu-theme-nightowl .acu-validation-rule-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-table-manager-item:hover,\n    .acu-theme-nightowl .acu-validation-rule-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    /* Night Owl主题：预设卡片框框使用更暗的边框 */\n    .acu-theme-nightowl .acu-preset-item {\n        border-color: var(--acu-border) !important;\n    }\n    .acu-theme-nightowl .acu-preset-item:hover {\n        border-color: rgba(127, 219, 202, 0.4) !important;\n    }\n    .acu-wrapper { position: relative; width: 100%; margin: 15px 0; z-index: 2147483640 !important; font-family: 'Microsoft YaHei', sans-serif; display: flex; flex-direction: column-reverse; }\n    .acu-wrapper.acu-mode-embedded { position: relative !important; width: 100% !important; margin-top: 8px !important; z-index: 2147483641 !important; clear: both; display: flex; flex-direction: column-reverse !important; padding: 0; }\n    .acu-wrapper.acu-mode-embedded .acu-nav-container { position: relative !important; z-index: 2147483642 !important; }\n    .acu-wrapper.acu-mode-embedded .acu-data-display { position: absolute !important; bottom: 100% !important; left: 0 !important; right: 0 !important; width: 100% !important; box-shadow: 0 -10px 30px rgba(0,0,0,0.25) !important; border: 1px solid var(--acu-border); margin-bottom: 5px; z-index: 2147483647 !important; max-height: 70vh !important; overflow-y: auto !important; }\n    .acu-nav-container { display: grid; grid-template-columns: repeat(var(--acu-grid-cols, 3), 1fr); gap: 4px; padding: 6px; background: var(--acu-bg-nav); border: 1px solid var(--acu-border); border-radius: 10px; align-items: center; box-shadow: 0 2px 6px var(--acu-shadow); position: relative; z-index: 2147483641 !important; }\n    .acu-nav-btn { touch-action: manipulation; -webkit-tap-highlight-color: transparent; width: 100%; display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 3px; padding: 4px 2px; border: 1px solid transparent; border-radius: 6px; background: var(--acu-btn-bg); color: var(--acu-text-main); font-weight: 600; font-size: 11px; cursor: pointer; transition: all 0.2s ease; user-select: none; overflow: hidden; height: 28px; }\n    .acu-nav-btn span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; margin-top: 1px; }\n    .acu-nav-btn:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n    .acu-nav-btn:focus, .acu-nav-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n    /* [新增] 移植功能样式 */\n/* --- 1. 外层容器：防止误触边缘 --- */\n.acu-height-control {\n    display: flex;\n    align-items: center;\n    margin-right: 8px;\n    cursor: ns-resize;\n    padding: 4px;\n    border-radius: 4px;\n    color: var(--acu-text-sub);\n    transition: all 0.2s;\n    /* 关键属性：禁止在此区域触发浏览器默认手势 */\n    touch-action: none;\n}\n\n/* 交互反馈 */\n.acu-height-control:hover, .acu-height-control.active {\n    color: var(--acu-accent);\n    background: var(--acu-table-hover);\n}\n\n/* --- 2. [加保险] 内部图标：这是事件绑定的主体，必须禁止触摸 --- */\n.acu-height-drag-handle {\n    cursor: ns-resize;\n    /* 双重保险：确保直接按在图标上也不会触发滚动 */\n    touch-action: none;\n}\n\n            /* 视图切换样式 */\n            .acu-view-btn { background: transparent !important; border: none; color: var(--acu-text-main) !important; cursor: pointer; padding: 4px; margin-right: 5px; font-size: 14px; opacity: 0.7; }\n            .acu-view-btn:hover { opacity: 1; color: var(--acu-accent) !important; background: var(--acu-table-hover) !important; border-radius: 4px; }\n            .acu-view-btn.acu-reverse-btn.active, .acu-reverse-btn[data-reversed="true"] { color: var(--acu-accent) !important; opacity: 1; }\n            /* Grid 视图 (双列) */\n            .acu-card-body.view-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }\n            /* 修复版：强制 Grid 模式使用 Flex 布局并允许高度自适应 */\n.acu-card-body.view-grid .acu-card-row { display: flex; height: auto !important; min-height: fit-content; border: 1px solid var(--acu-border); border-radius: 6px; padding: 4px 6px; flex-direction: column !important; align-items: flex-start !important; background: rgba(0,0,0,0.02); box-sizing: border-box; }\n            .acu-card-body.view-grid .acu-card-row.acu-grid-span-full { grid-column: 1 / -1; }\n            .acu-card-body.view-grid .acu-card-label { width: 100% !important; font-size: 0.85em; opacity: 0.8; margin-bottom: 2px; }\n            .acu-card-body.view-grid .acu-card-value { width: 100% !important; }\n\n            /* List 视图 (单列 - 原版增强) */\n            .acu-nav-btn.active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); outline: none; border-color: transparent; }\n            .acu-nav-btn.active:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); transform: none; }\n            .acu-nav-btn.active:focus, .acu-nav-btn.active:focus-visible { outline: none; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2) !important; }\n            .acu-nav-btn.has-validation-errors { border-color: rgba(231, 76, 60, 0.5); }\n            .acu-nav-btn .acu-nav-warning-icon { color: var(--acu-error-text, #e74c3c); font-size: 10px; margin-left: 2px; animation: pulse 1.5s infinite; }\n            @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }\n            .acu-action-btn { flex: 1; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--acu-btn-bg); border-radius: 8px; color: var(--acu-text-sub); cursor: pointer; border: 1px solid transparent; transition: all 0.2s; margin: 0; }\n            .acu-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }\n            .acu-action-btn:focus, .acu-action-btn:focus-visible { outline: none; box-shadow: 0 0 0 2px var(--acu-accent) !important; }\n            #acu-btn-save-global { color: var(--acu-btn-active-bg); } #acu-btn-save-global:hover { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); }\n\n            .acu-data-display { position: absolute; bottom: calc(100% + 10px); left: 0; right: 0; max-height: 80vh; height: auto; background: var(--acu-bg-panel); border: 1px solid var(--acu-border); border-radius: 8px; box-shadow: 0 8px 30px var(--acu-shadow); display: none; flex-direction: column; z-index: 2147483642 !important; animation: popUp 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); }\n            .acu-data-display.visible { display: flex; }\n            @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }\n            @keyframes highlightFlash { 0%, 100% { box-shadow: none; } 50% { box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.6); } }\n            .acu-highlight-flash { animation: highlightFlash 0.5s ease-in-out 3; }\n\n            .acu-panel-header { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); border-radius: 8px 8px 0 0; }\n            /* 核心修改：增加了 flex: 1 和 min-width: 0，强制标题在空间不足时自动变短显示省略号 */\n/* --- 新的标题布局：纵向排列 --- */\n.acu-panel-title {\n    display: flex;\n    flex-direction: column; /* 垂直堆叠 */\n    justify-content: center;\n    align-items: flex-start;\n    flex: 1; /* 占据剩余空间 */\n    min-width: 0; /* 允许压缩 */\n    margin-right: 8px;\n    overflow: hidden;\n}\n\n/* 第一行：标题主体 (加粗，稍大) */\n.acu-title-main {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    width: 100%;\n    font-size: 13px; /* 你要求的：字体变小一点，但保持加粗 */\n    font-weight: bold;\n    color: var(--acu-text-main);\n    line-height: 1.2;\n}\n\n/* 标题文字本身 (溢出省略) */\n.acu-title-text {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n}\n\n/* 第二行：页码信息 (灰色，更小) */\n.acu-title-sub {\n    font-size: 10px;\n    color: var(--acu-text-sub);\n    font-weight: normal;\n    opacity: 0.8;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    width: 100%;\n    line-height: 1.2;\n    margin-top: 1px;\n}\n            /* 增加了 flex-shrink: 0; 防止被标题挤压 */\n/* 核心修改：flex-shrink: 0 确保这一块区域永远不会被压缩 */\n.acu-header-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }\n            .acu-search-wrapper { position: relative; display: flex; align-items: center; }\n            .acu-wrapper input.acu-search-input { background: var(--acu-btn-bg) !important; border: 1px solid var(--acu-border) !important; color: var(--acu-text-main) !important; padding: 4px 8px 4px 24px; border-radius: 12px; font-size: 12px; width: 120px; transition: width 0.2s, border-color 0.2s; }\n            .acu-wrapper input.acu-search-input::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            .acu-wrapper input.acu-search-input:focus { width: 160px; outline: none !important; border-color: var(--acu-accent) !important; box-shadow: none !important; }\n            .acu-search-input::placeholder { color: var(--acu-text-sub) ; opacity: 0.7; }\n            .acu-search-icon { position: absolute; left: 8px; font-size: 10px; color: var(--acu-text-sub); pointer-events: none; }\n            /* 增加了 min-width 和 flex-shrink: 0 */\n            .acu-panel-content { flex: 1; overflow-x: auto; overflow-y: hidden; padding: 15px; background: transparent; scrollbar-width: thin; scrollbar-color: var(--acu-scrollbar-thumb) var(--acu-scrollbar-track); overscroll-behavior-x: contain; overscroll-behavior-y: auto; touch-action: pan-x pan-y; -webkit-overflow-scrolling: touch; }\n            /* 增加了 height: 100%; 让网格容器填满面板的高度 */\n.acu-card-grid { display: flex; flex-wrap: nowrap; gap: 12px; align-items: flex-start; }\n            .acu-layout-vertical .acu-panel-content { overflow-x: hidden !important; overflow-y: auto !important; overscroll-behavior: auto; touch-action: manipulation; min-height: 0; }\n            /* 竖向布局时恢复 auto 高度 */\n.acu-layout-vertical .acu-card-grid { flex-wrap: wrap !important; justify-content: center; padding-bottom: 20px; height: auto; }\n.acu-wrapper:not(.acu-layout-vertical) .acu-manual-mode .acu-card-grid { height: 100%; } .acu-manual-mode .acu-data-card { max-height: 100% !important; overscroll-behavior-y: auto; } .acu-data-card { flex: 0 0 var(--acu-card-width, 260px); width: var(--acu-card-width, 260px); background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; height: auto; max-height: 60vh; overflow-y: auto; overscroll-behavior-y: auto; touch-action: manipulation; transition: all 0.2s ease; display: flex; flex-direction: column; position: relative; }\n            .acu-data-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px var(--acu-shadow); border-color: var(--acu-accent); }\n            .acu-data-card.pending-deletion { opacity: 0.6; border: 1px dashed var(--acu-error-text, #e74c3c); }\n            .acu-data-card.pending-deletion::after { content: "待删除"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--acu-error-text, #e74c3c); font-size: 24px; font-weight: bold; border: 2px solid var(--acu-error-text, #e74c3c); padding: 5px 10px; border-radius: 8px; opacity: 0.8; pointer-events: none; }\n            @keyframes pulse-highlight { 0% { opacity: 0.7; } 50% { opacity: 1; } 100% { opacity: 0.7; } }\n            .acu-highlight-manual { color: var(--acu-hl-manual) !important; background-color: var(--acu-hl-manual-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-highlight-diff { color: var(--acu-hl-diff) !important; background-color: var(--acu-hl-diff-bg) !important; border-radius: 4px; padding: 0 4px; font-weight: bold; animation: pulse-highlight 2s infinite; display: inline-block; }\n            .acu-editable-title.acu-highlight-manual, .acu-editable-title.acu-highlight-diff { width: auto; display: inline-block; }\n            .acu-card-header { flex: 0 0 auto; padding: 8px 10px; background: var(--acu-table-head); border-bottom: 1px dashed var(--acu-border); font-weight: bold; color: var(--acu-text-main); font-size: 14px; display: flex; flex-direction: row !important; align-items: center !important; justify-content: flex-start !important; gap: 8px; min-height: 40px; height: auto !important; position: relative; }\n            .acu-editable-title { flex: 1; width: auto !important; cursor: pointer; border-bottom: 1px dashed transparent; transition: all 0.2s; white-space: pre-wrap !important; overflow: visible !important; word-break: break-word !important; text-align: center; line-height: 1.3; margin: 0; }\n            .acu-editable-title:hover { border-bottom-color: var(--acu-accent); color: var(--acu-accent); }\n            .acu-card-index { position: static !important; transform: none !important; margin: 0; flex-shrink: 0; font-size: 11px; color: var(--acu-text-sub); font-weight: normal; background: var(--acu-badge-bg); padding: 2px 6px; border-radius: 4px; }\n            .acu-bookmark-icon { position: absolute; top: 8px; right: 8px; color: var(--acu-accent); cursor: pointer; font-size: 16px; opacity: 0.3; transition: opacity 0.2s, color 0.2s, transform 0.2s; z-index: 10; }\n            .acu-bookmark-icon:hover { opacity: 0.6; transform: scale(1.1); }\n            .acu-bookmark-icon.bookmarked { color: var(--acu-accent); opacity: 1; }\n            .acu-card-body { padding: 6px 12px; display: flex; flex-direction: column; gap: 0; font-size: var(--acu-font-size, 13px); flex: 1; }\n            .acu-card-row { display: block; padding: 6px 0; border-bottom: 1px dashed var(--acu-border); cursor: pointer; overflow: hidden; }\n            .acu-card-row:last-child { border-bottom: none; }\n            .acu-card-actions { display: flex; flex-wrap: wrap; gap: 6px; padding: 8px 10px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); }\n            .acu-action-item { padding: 4px 10px; font-size: 11px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.15s; white-space: nowrap; }\n            .acu-action-item:hover { background: var(--acu-btn-hover); border-color: var(--acu-accent); color: var(--acu-accent); transform: translateY(-1px); }\n            .acu-action-item:active { transform: translateY(0); }\n            .acu-action-item.check-type { border-style: dashed; }\n            .acu-action-item i { font-size: 10px; opacity: 0.7; }\n            .acu-card-row:hover { background: var(--acu-table-hover); }\n            .acu-card-label { float: left !important; clear: left; width: auto !important; margin-right: 8px !important; color: var(--acu-text-sub); font-size: 0.9em; line-height: 1.5; padding-top: 0; }\n            .acu-hide-label .acu-card-label { display: none; }\n            .acu-hide-label .acu-card-value { width: 100% !important; }\n            .acu-inline-dice-btn:hover { opacity: 1 !important; transform: scale(1.2); }\n            .acu-card-value { display: block; width: auto !important; margin: 0; text-align: left !important; word-break: break-all !important; white-space: pre-wrap !important; line-height: 1.5 !important; color: var(--acu-text-main); font-size: 1em; }\n            .acu-tag-container { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; margin-top: 2px; }\n            .acu-multi-attr-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2px 8px; }\n            .acu-badge { display: inline-block; padding: 1px 8px; border-radius: 12px; font-size: 0.9em; font-weight: 500; line-height: 1.2; }\n            .acu-badge-green { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-neutral { background: var(--acu-badge-bg); color: var(--acu-text-main); border: 1px solid var(--acu-border); }\n            .acu-panel-footer { flex: 0 0 auto; padding: 8px; border-top: 1px dashed var(--acu-border); background: var(--acu-table-head); display: flex; justify-content: center; align-items: center; gap: 5px; flex-wrap: wrap; }\n            .acu-page-btn { padding: 4px 10px; min-width: 32px; height: 28px; border-radius: 4px; border: 1px solid var(--acu-border); background: var(--acu-btn-bg); color: var(--acu-text-main); cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }\n            .acu-page-btn:hover:not(.disabled):not(.active) { background: var(--acu-btn-hover); transform: translateY(-1px); }\n            .acu-page-btn.active { background: var(--acu-accent); color: #fff; border-color: var(--acu-accent); font-weight: bold; }\n            .acu-page-btn.disabled { opacity: 0.5; cursor: not-allowed; }\n            .acu-page-info { font-size: 12px; color: var(--acu-text-sub); margin: 0 10px; }\n            /* --- [新增] 行动选项面板样式 --- */\n            /* 改为 Flex Column 垂直布局 */\n            /* --- [修改] 袖珍型·垂直紧凑布局 --- */\n            .acu-option-panel {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;                 /* 间距极小，排列更紧密 */\n                padding: 4px;             /* 容器内边距缩小 */\n                background: var(--acu-bg-nav);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;       /* 圆角缩小 */\n                margin-top: 0;\n                margin-bottom: 4px;\n                backdrop-filter: blur(5px);\n                width: 100%;\n                box-sizing: border-box;\n                z-index: 2147483641;\n                animation: acuFadeIn 0.3s ease;\n            }\n\n            .acu-embedded-options-container {\n                width: 100%;\n                max-width: 100%;\n                margin-top: 6px;\n                clear: both;\n                animation: acuFadeIn 0.3s ease;\n            }\n\n            .acu-opt-header {\n                text-align: center;\n                font-size: 10px;          /* 标题字体更小 */\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                padding-bottom: 2px;\n                border-bottom: 1px dashed var(--acu-border);\n                margin-bottom: 2px;\n            }\n\n            /* --- [修改] 袖珍按钮样式 --- */\n            .acu-opt-btn {\n                background: var(--acu-btn-bg);\n                border: 1px solid transparent; /* 默认无边框，更干净 */\n                padding: 3px 6px;              /* 极窄内边距 */\n                border-radius: 4px;\n                cursor: pointer;\n                color: var(--acu-text-main);\n                font-size: var(--acu-opt-font-size, 12px) !important; /* [修改] 使用独立变量 */\n                transition: all 0.15s;\n                font-weight: normal;           /* 去除加粗 */\n                text-align: left;              /* 左对齐 */\n                white-space: pre-wrap;\n                word-break: break-word;\n                min-height: 22px;              /* 压低高度，超薄 */\n                line-height: 1.3;\n                display: flex;\n                align-items: center;\n                justify-content: flex-start;\n                opacity: 0.9;\n            }\n\n            .acu-opt-btn:hover {\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent); /* 悬停时显示边框 */\n                transform: translateX(3px);      /* 悬停时轻微右移反馈 */\n                opacity: 1;\n            }\n            .acu-opt-btn:active { background: var(--acu-btn-active-bg); color: var(--acu-btn-active-text); }\n            @keyframes acuFadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }\n\n            .acu-menu-backdrop { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: transparent; z-index: 2147483645 !important; }\n            /* 1. 菜单容器：背景色、边框、阴影全部跟随主题变量 */\n.acu-cell-menu {\n    position: fixed !important;\n    background: var(--acu-menu-bg) !important;\n    border: 1px solid var(--acu-border);\n    box-shadow: 0 6px 20px var(--acu-shadow) !important;\n    z-index: 2147483647 !important;\n    border-radius: 8px;\n    overflow: hidden;\n    min-width: 150px;\n    color: var(--acu-menu-text);\n}\n\n/* 2. 菜单项：文字颜色跟随主题 */\n.acu-cell-menu-item {\n    padding: 12px 16px;\n    cursor: pointer;\n    font-size: 14px;\n    display: flex;\n    gap: 12px;\n    align-items: center;\n    color: var(--acu-menu-text);\n    font-weight: 500;\n    background: transparent;\n    transition: background 0.2s;\n}\n\n/* 3. 悬停效果：使用主题定义的通用悬停色 */\n.acu-cell-menu-item:hover {\n    background: var(--acu-table-hover);\n}\n\n/* 4. 特殊按钮优化 */\n            .acu-cell-menu-item#act-delete { color: var(--acu-error-text, #e74c3c); }\n            .acu-cell-menu-item#act-delete:hover { background: var(--acu-error-bg, rgba(231, 76, 60, 0.1)); } /* 红色半透明背景，任何主题都适配 */\n            .acu-cell-menu-item#act-close { border-top: 1px dashed var(--acu-border); color: var(--acu-text-sub); }\n            .acu-edit-overlay { position: fixed !important; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.75) !important; z-index: 2147483646 !important; display: flex; justify-content: center !important; align-items: center !important; backdrop-filter: blur(2px); }\n            .acu-edit-dialog { background: var(--acu-bg-panel); width: 95%; max-width: 500px; max-height: 95vh; padding: 16px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; box-shadow: 0 15px 50px rgba(0,0,0,0.6); color: var(--acu-text-main); border: 1px solid var(--acu-border); overflow: hidden; flex-shrink: 0; }\n            @media (min-width: 768px) { .acu-edit-dialog { max-width: 900px; width: 90%; } .acu-edit-dialog.acu-settings-dialog { max-width: 400px; width: 400px; } }\n            .acu-edit-title { margin: 0; font-size: 16px; font-weight: bold; color: var(--acu-text-main); padding-bottom: 8px; border-bottom: 1px solid var(--acu-border); }\n            .acu-edit-textarea { width: 100%; height: auto; padding: 12px; border: 1px solid var(--acu-border) !important; background: var(--acu-input-bg) !important; color: var(--acu-text-main) !important; border-radius: 6px; resize: vertical; box-sizing: border-box; font-size: 14px; line-height: 1.6; overflow-y: auto !important; }\n            .acu-edit-textarea:focus { outline: none; border-color: var(--acu-accent) !important; }\n            .acu-edit-textarea::placeholder { color: var(--acu-text-sub) !important; opacity: 0.7; }\n            @media (min-width: 768px) { .acu-edit-textarea { height: auto !important; font-size: 15px !important; } }\n            .acu-edit-textarea:focus { outline: 1px solid #aaa; }\n            .acu-dialog-btns { display: flex; justify-content: flex-end; gap: 20px; margin-top: 10px; }\n            .acu-dialog-btn { background: none; border: none; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 6px; color: var(--acu-text-sub); transition: color 0.2s; }\n            .acu-dialog-btn:hover { color: var(--acu-text-main); } .acu-btn-confirm { color: var(--acu-success-text); } .acu-btn-confirm:hover { opacity: 0.8; }\n            /* --- [UI Optimization] PC-First Edit Mode Styles --- */\n            .acu-order-controls { grid-column: 1 / -1; order: -2; display: none; width: 100%; text-align: left; background: var(--acu-accent); color: #fff; padding: 6px 12px; margin: 0 0 8px 0; border-radius: 4px; font-weight: bold; font-size: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }\n            .acu-order-controls.visible { display: flex; align-items: center; justify-content: space-between; }\n\n            .acu-nav-container.editing-order { border: 2px solid var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-nav-container.editing-order .acu-nav-btn, .acu-nav-container.editing-order .acu-action-btn { opacity: 1 !important; cursor: grab !important; border: 1px solid var(--acu-border); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }\n            .acu-nav-container.editing-order .acu-nav-btn:hover, .acu-nav-container.editing-order .acu-action-btn:hover { border-color: var(--acu-accent); transform: translateY(-1px); }\n\n            .acu-swap-selected { background-color: var(--acu-accent) !important; color: #fff !important; border-color: var(--acu-accent); box-shadow: 0 0 0 2px rgba(255,255,255,0.5), 0 4px 12px rgba(0,0,0,0.2); transform: scale(1.05); z-index: 10; }\n            .acu-drag-over { border: 2px dashed var(--acu-accent); opacity: 0.5; transform: scale(0.95); background: rgba(var(--acu-accent-rgb), 0.1); }\n\n            /* --- [PC Style] Unused Pool Optimization (工具架样式) --- */\n            .acu-unused-pool {\n                grid-column: 1 / -1;\n                display: none;\n                flex-wrap: wrap;\n                gap: 8px;\n                background: var(--acu-table-head); /* 使用表头背景色，更融合 */\n                border: 1px dashed var(--acu-border); /* 虚线框表示这是编辑区域 */\n                padding: 10px 15px;\n                margin: 0 0 10px 0;\n                border-radius: 8px;\n                justify-content: flex-start;\n                align-items: center;\n                min-height: 50px;\n                box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);\n            }\n            .acu-unused-pool.visible { display: flex; animation: acuFadeIn 0.2s ease-out; }\n\n            /* PC端清晰的文字引导 */\n            .acu-unused-pool::before {\n                content: "备选功能池 (拖拽图标到下方启用 ↘)";\n                display: flex;\n                align-items: center;\n                height: 32px;\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n                margin-right: 15px;\n                padding-right: 15px;\n                border-right: 1px solid var(--acu-border);\n                white-space: nowrap;\n                opacity: 0.8;\n            }\n\n            .acu-actions-group { grid-column: 1 / -1; display: flex; justify-content: flex-end; gap: 4px; border-top: 1px dashed var(--acu-border); padding-top: 8px; margin-top: 4px; min-height: 36px; transition: all 0.2s; }\n\n            /* [修复] 移动端顶部布局适配：强制提升顺序 */\n            .acu-pos-top .acu-actions-group { order: -1; border-top: none; border-bottom: 1px dashed var(--acu-border); margin-top: 0; margin-bottom: 6px; padding-top: 0; padding-bottom: 8px; }\n\n            /* [修复] 编辑模式下，备选池也跟随置顶 */\n            .acu-pos-top .acu-unused-pool { order: -1; margin-bottom: 10px; border-bottom: 1px dashed var(--acu-border); }\n            .acu-actions-group.dragging-over { background: rgba(127, 127, 127, 0.05); box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }\n\n            /* 仪表盘横向滚动模式 */\n                .acu-dash-body.acu-dash-horizontal {\n                    display: flex;\n                    flex-wrap: nowrap;\n                    gap: 15px;\n                    overflow-x: auto;\n                    overflow-y: hidden;\n                    padding-bottom: 10px;\n                }\n                .acu-dash-body.acu-dash-horizontal > div {\n                    flex: 0 0 280px;\n                    min-width: 280px;\n                    max-height: 60vh;\n                    overflow-y: auto;\n                }\n                @media (min-width: 769px) {\n                    .acu-dash-body.acu-dash-horizontal > div {\n                        flex: 0 0 320px;\n                        min-width: 320px;\n                    }\n                }\n            /* Mobile adjustments to keep it usable there */\n            @media (max-width: 768px) {\n                .acu-unused-pool { justify-content: center; background: rgba(0,0,0,0.05); border: 1px dashed var(--acu-border); border-bottom: none; margin: 0 0 8px 0; border-radius: 6px; }\n                .acu-unused-pool::before { display: block; width: 100%; text-align: center; margin-bottom: 4px; content: "可选功能池 (拖拽或点击)"; }\n                .acu-order-controls { flex-direction: column; gap: 6px; text-align: center; }\n            }\n            .acu-actions-group.dragging-over { background: rgba(var(--acu-accent-rgb), 0.1); border-color: var(--acu-accent); }\n            .acu-settings-item { margin-bottom: 15px; }\n            .acu-settings-label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #ccc; }\n            .acu-settings-val { float: right; color: #4cd964; font-size: 12px; }\n            .acu-slider { width: 100%; height: 4px; background: #555; border-radius: 2px; outline: none; -webkit-appearance: none; }\n            .acu-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #fff; border-radius: 50%; cursor: pointer; }\n            .acu-select { width: 100%; padding: 8px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; border-radius: 4px; outline: none; }\n            .acu-edit-overlay input[type="checkbox"].acu-checkbox { margin-right: 10px; accent-color: var(--acu-accent) !important; background: transparent !important; background-color: transparent !important; }\n            .acu-btn-block { width: 100%; padding: 10px; background: #444; color: #eee; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 10px; }\n            .acu-btn-block:hover { background: #555; color: #fff; }\n            .acu-expand-trigger { background: var(--acu-bg-nav); border: 1px solid var(--acu-border); box-shadow: 0 2px 6px var(--acu-shadow); cursor: pointer; color: var(--acu-text-main); font-size: 13px; font-weight: bold; display: flex; align-items: center; gap: 6px; transition: all 0.2s; z-index: 2147483645 !important; }\n            .acu-expand-trigger:hover { background: var(--acu-btn-hover); transform: translateY(-2px); }\n            .acu-col-bar { width: 100%; justify-content: center; padding: 8px 10px; border-radius: 6px; }\n            .acu-col-pill { width: auto !important; padding: 6px 16px; border-radius: 50px; }\n            .acu-col-mini { width: 40px !important; height: 40px !important; padding: 0; justify-content: center; border-radius: 50%; }\n            .acu-col-mini span { display: none; }\n            /* [优化] 小眼睛图标悬停效果 */\n            .acu-nav-toggle-btn:hover { opacity: 1 !important; transform: translateY(-50%) scale(1.2); color: var(--acu-accent); }\n            .acu-align-right { margin-left: auto; align-self: flex-end; }\n            .acu-align-left { margin-right: auto; margin-left: 0; align-self: flex-start; }\n            .acu-nav-container.acu-left-mode .acu-actions-group { order: -1; margin-left: 0; margin-right: 10px; }\n            #acu-btn-collapse { color: var(--acu-text-sub); }\n            #acu-btn-collapse:hover { color: var(--acu-text-main); background: rgba(0,0,0,0.05); }\n            @keyframes acu-breathe { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.6; transform: scale(0.85); color: #ff7e67; } 100% { opacity: 1; transform: scale(1); } } .acu-icon-breathe { animation: acu-breathe 3s infinite ease-in-out !important; display: inline-block; }\n\n            @media (min-width: 768px) {\n                .acu-wrapper.acu-mode-embedded .acu-nav-container { width: fit-content !important; min-width: 300px; max-width: 100%; margin: 0 auto; border-radius: 50px; box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important; border: 1px solid var(--acu-border); padding: 6px 20px; background: var(--acu-bg-nav) !important; }\n                .acu-wrapper.acu-mode-embedded .acu-data-display { bottom: calc(100% + 12px) !important; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important; }\n                .acu-nav-container { display: flex; flex-wrap: wrap !important; gap: 6px !important; padding: 6px 10px; grid-template-columns: none !important; flex-direction: row !important; justify-content: flex-start !important; align-items: center !important; height: auto !important; }\n                .acu-nav-container .acu-nav-btn { width: fit-content !important; flex: 0 0 auto !important; height: 32px !important; padding: 0 12px; font-size: 13px !important; min-width: auto !important; }\n                .acu-nav-btn span { max-width: 200px; }\n                .acu-action-btn { flex: 0 0 32px !important; width: 32px !important; height: 32px !important; background: transparent !important; color: var(--acu-text-sub) !important; border-radius: 6px; border: 1px solid transparent; }\n                .acu-action-btn:hover { background: var(--acu-btn-hover) !important; color: var(--acu-text-main) !important; transform: scale(1.1); box-shadow: none; }\n                #acu-btn-save-global { color: var(--acu-accent) !important; }\n                #acu-btn-save-global:hover { background: var(--acu-accent) !important; color: #fff !important; }\n                .acu-order-controls { margin: 0 0 8px 0; padding: 4px; }\n                .acu-actions-group { width: auto !important; margin-left: auto !important; border-top: none !important; border-bottom: none !important; padding: 0; margin-top: 0 !important; margin-bottom: 0 !important; gap: 4px !important; background: transparent; justify-content: flex-end; order: 9999 !important; display: flex; }\n                .acu-pos-top .acu-actions-group { order: -1 !important; margin-left: 0 !important; margin-right: 10px !important; justify-content: flex-start !important; }\n            }\n            @media (max-width: 768px) {\n                .acu-panel-content { -webkit-overflow-scrolling: touch !important; overscroll-behavior-y: auto; }\n                .acu-data-card { box-shadow: none !important; border: 1px solid var(--acu-border); transform: translateZ(0); }\n                .acu-data-card:hover { transform: none !important; box-shadow: none !important; }\n                .acu-nav-btn:hover { transform: none !important; }\n            }\n            /* === 移动端投骰面板适配 === */\n            @media (max-width: 768px) {\n                .acu-dice-panel, .acu-contest-panel {\n                    position: fixed !important;\n                    top: 5% !important;\n                    left: 50% !important;\n                    transform: translateX(-50%) !important;\n                    width: 92vw !important;\n                    max-width: 400px !important;\n                    max-height: 88vh !important;\n                    overflow-y: auto !important;\n                }\n                .acu-dice-panel > div:last-child, .acu-contest-panel > div:last-child {\n                    max-height: none !important;\n                    overflow-y: visible !important;\n                }\n                .acu-dice-overlay, .acu-contest-overlay {\n                    align-items: flex-start !important;\n                    padding-top: 5vh !important;\n                }\n            }\n                /* === 仪表盘新增样式：可展开地点列表 === */\n                .acu-dash-body {\n                    display: grid;\n                    grid-template-columns: 1fr 1.2fr 1fr;\n                    gap: 15px;\n                    margin: 15px 0;\n                }\n\n                .acu-dash-locations {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-locations h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-location-group {\n                    margin-bottom: 8px;\n                    border-radius: 6px;\n                    overflow: hidden;\n                    background: var(--acu-card-bg);\n                    border: 1px solid transparent;\n                    transition: all 0.2s;\n                }\n\n                .acu-location-group.expanded {\n                    border-color: var(--acu-accent);\n                }\n\n                .acu-location-header {\n                    padding: 8px 10px;\n                    cursor: pointer;\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                    background: var(--acu-table-head);\n                    transition: all 0.2s;\n                    user-select: none;\n                }\n\n                .acu-location-header:hover {\n                    background: var(--acu-table-hover);\n                }\n\n                .acu-expand-icon {\n                    font-size: 10px;\n                    transition: transform 0.2s;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-group.expanded .acu-expand-icon {\n                    transform: rotate(90deg);\n                    color: var(--acu-accent);\n                }\n\n                .acu-region-name {\n                    flex: 1;\n                    font-weight: bold;\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-location-count {\n                    font-size: 11px;\n                    color: var(--acu-text-sub);\n                }\n\n                .acu-location-list {\n                    max-height: 0;\n                    overflow: hidden;\n                    transition: max-height 0.3s ease;\n                }\n\n                .acu-location-group.expanded .acu-location-list {\n                    max-height: 500px;\n                }\n\n                .acu-location-item {\n                    padding: 6px 10px 6px 26px;\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                    font-size: 12px;\n                    border-bottom: 1px dashed rgba(0,0,0,0.05);\n                    transition: all 0.15s;\n                }\n\n                /* 仪表盘地点名称单行省略样式 */\n                .acu-dash-locations .acu-location-item {\n                    padding: 4px 8px !important;\n                    min-width: 0; /* 允许flex子元素收缩 */\n                    overflow: hidden; /* 防止内容溢出 */\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child {\n                    display: flex !important;\n                    align-items: center;\n                    gap: 6px;\n                    flex: 1;\n                    min-width: 0; /* 允许flex子元素收缩 */\n                    overflow: hidden;\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child i {\n                    flex-shrink: 0; /* 图标不收缩 */\n                }\n\n                .acu-dash-locations .acu-location-item > span:first-child > span {\n                    white-space: nowrap;\n                    overflow: hidden;\n                    text-overflow: ellipsis;\n                    flex: 1;\n                    min-width: 0; /* 允许flex子元素收缩 */\n                }\n\n                .acu-location-item:last-child {\n                    border-bottom: none;\n                }\n\n                .acu-location-item:hover {\n                    background: var(--acu-table-hover);\n                    transform: translateX(4px);\n                }\n\n                .acu-location-item.current {\n                    background: var(--acu-hl-diff-bg);\n                    font-weight: bold;\n                    color: var(--acu-hl-diff);\n                }\n\n                .acu-location-item i {\n                    font-size: 10px;\n                    opacity: 0.6;\n                }\n\n                .acu-current-badge {\n                    margin-left: auto;\n                    font-size: 10px;\n                    padding: 2px 6px;\n                    background: var(--acu-btn-active-bg);\n                    color: var(--acu-btn-active-text);\n                    border-radius: 3px;\n                    font-weight: bold;\n                }\n                /* === 仪表盘核心样式（补充） === */\n                .acu-dash-context {\n                    background: linear-gradient(135deg, var(--acu-table-head), var(--acu-bg-panel));\n                    padding: 15px;\n                    border-radius: 8px;\n                    margin-bottom: 15px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-location {\n                    font-size: 18px;\n                    font-weight: bold;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 8px;\n                }\n\n                .acu-dash-location-desc {\n                    font-size: 13px;\n                    color: var(--acu-text-sub);\n                    margin-top: 6px;\n                    line-height: 1.5;\n                }\n\n                .acu-dash-player, .acu-dash-intel {\n                    background: var(--acu-card-bg);\n                    padding: 12px;\n                    border-radius: 8px;\n                    border: 1px solid var(--acu-border);\n                }\n\n                .acu-dash-player h3, .acu-dash-intel h3 {\n                    margin: 0 0 10px 0;\n                    font-size: 14px;\n                    color: var(--acu-accent);\n                    display: flex;\n                    align-items: center;\n                    gap: 6px;\n                }\n\n                .acu-player-status {\n                    font-size: 13px;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-task-item {\n                    padding: 8px;\n                    margin-bottom: 6px;\n                    background: rgba(0,0,0,0.03);\n                    border-radius: 6px;\n                    border-left: 3px solid var(--acu-border);\n                }\n\n                .acu-task-name {\n                    font-size: 13px;\n                    font-weight: 500;\n                    color: var(--acu-text-main);\n                }\n\n                .acu-empty-hint {\n                    font-size: 12px;\n                    color: var(--acu-text-sub);\n                    text-align: center;\n                    padding: 15px;\n                    opacity: 0.7;\n                }\n                /* 审核面板空状态居中 */\n                .acu-changes-content .acu-empty-hint {\n                    flex: 1;\n                    display: flex;\n                    flex-direction: column;\n                    align-items: center;\n                    justify-content: center;\n                    min-height: 200px;\n                }\n\n                .acu-dashboard-content {\n                    padding: 15px;\n                    overflow-y: auto !important;\n                    overflow-x: hidden !important;\n                    -webkit-overflow-scrolling: touch !important;\n                    touch-action: pan-y !important;\n                    overscroll-behavior-y: contain;\n                    max-height: calc(80vh - 60px);\n                }\n\n                /* === 仪表盘交互按钮优化 === */\n                h3.acu-dash-table-link,\n                h4.acu-dash-table-link {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    padding: 2px 4px;\n                    margin: -2px -4px;\n                    border-radius: 4px;\n                }\n                h3.acu-dash-table-link:hover,\n                h4.acu-dash-table-link:hover {\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                }\n\n                /* 仪表盘操作图标 - 统一放大+增加点击热区 */\n                .acu-dash-dice-btn,\n                .acu-dash-goto-btn,\n                .acu-dash-use-item-btn,\n                .acu-dash-use-skill-btn,\n                .acu-dash-track-task-btn,\n                .acu-dash-msg-btn,\n                .acu-dash-contest-btn,\n                .acu-dash-dice-free,\n                .acu-dash-relation-graph-btn,\n                .acu-dash-avatar-manager-btn {\n                    cursor: pointer;\n                    color: var(--acu-text-sub);\n                    opacity: 0.5;\n                    font-size: 14px !important;\n                    padding: 6px;\n                    margin: -4px;\n                    border-radius: 4px;\n                    transition: all 0.15s;\n                    display: inline-flex;\n                    align-items: center;\n                    justify-content: center;\n                    min-width: 28px;\n                    min-height: 28px;\n                }\n                .acu-dash-dice-btn:hover,\n                .acu-dash-goto-btn:hover,\n                .acu-dash-use-item-btn:hover,\n                .acu-dash-use-skill-btn:hover,\n                .acu-dash-track-task-btn:hover,\n                .acu-dash-msg-btn:hover,\n                .acu-dash-contest-btn:hover,\n                .acu-dash-dice-free:hover {\n                    opacity: 1;\n                    color: var(--acu-accent);\n                    background: var(--acu-table-hover);\n                    transform: scale(1.1);\n                }\n\n                /* 仪表盘可点击项 - 增强反馈 */\n                .acu-dash-clickable {\n                    cursor: pointer;\n                    transition: all 0.15s;\n                    border-radius: 4px;\n                }\n                .acu-dash-clickable:hover {\n                    background: var(--acu-table-hover);\n                }\n                .acu-dash-clickable:active {\n                    transform: scale(0.98);\n                }\n\n                @media (max-width: 768px) {\n                    .acu-dash-body {\n                        grid-template-columns: 1fr;\n                        max-height: none;\n                        overflow: visible;\n                    }\n\n                    .acu-dashboard-content {\n                        max-height: calc(75vh - 50px) !important;\n                        padding-bottom: 20px !important;\n                    }\n\n                    /* 移动端进一步放大操作按钮 */\n                    .acu-dash-dice-btn,\n                    .acu-dash-goto-btn,\n                    .acu-dash-use-item-btn,\n                    .acu-dash-use-skill-btn,\n                    .acu-dash-track-task-btn,\n                    .acu-dash-msg-btn,\n                    .acu-dash-contest-btn,\n                    .acu-dash-dice-free {\n                        font-size: 16px !important;\n                        padding: 8px;\n                        min-width: 36px;\n                        min-height: 36px;\n                    }\n                }\n            /* === 仪表盘预览卡片样式 === */\n            .acu-preview-overlay {\n                z-index: 2147483650;\n                backdrop-filter: blur(3px);\n                animation: acuFadeIn 0.2s ease;\n            }\n\n            .acu-preview-card {\n                background: var(--acu-card-bg);\n                width: 90%;\n                max-width: 400px;\n                max-height: 80vh;\n                overflow-y: auto;\n                animation: acuFadeIn 0.25s ease;\n            }\n                .acu-preview-overlay .acu-data-card {\n                    width: 90vw;\n                    max-width: 400px;\n                    flex: none;\n                }\n                @media (min-width: 768px) {\n                    .acu-preview-card,\n                    .acu-preview-overlay .acu-data-card {\n                        max-width: 550px;\n                    }\n                }\n            .acu-preview-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .acu-preview-close:hover {\n                background: var(--acu-error-bg, rgba(231, 76, 60, 0.1));\n                color: var(--acu-error-text, #e74c3c);\n            }\n\n            .acu-preview-body {\n                padding: 15px;\n            }\n\n            .acu-preview-row {\n                display: flex;\n                padding: 8px 0;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n\n            .acu-preview-row:last-child {\n                border-bottom: none;\n            }\n\n            .acu-preview-label {\n                flex: 0 0 80px;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n            }\n\n            .acu-preview-value {\n                flex: 1;\n                color: var(--acu-text-main);\n                font-size: 13px;\n                word-break: break-word;\n            }\n\n            .acu-dash-clickable {\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n\n            .acu-dash-clickable:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-current-location span {\n                color: var(--acu-accent);\n                font-weight: 600;\n            }\n            .acu-current-location i {\n                color: var(--acu-accent);\n            }\n            /* === 自定义下拉菜单样式 === */\n            .acu-dropdown-wrapper { position: relative; width: 100%; }\n            .acu-dropdown-list {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                max-height: 150px;\n                overflow-y: auto;\n                border: 1px solid;\n                border-radius: 4px;\n                box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                z-index: 2147483649;\n                display: none;\n            }\n            .acu-dropdown-list.visible { display: block; }\n            .acu-dropdown-item {\n                padding: 6px 10px;\n                font-size: 12px;\n                cursor: pointer;\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                background: transparent;\n                transition: background 0.1s;\n            }\n            .acu-dropdown-empty {\n                padding: 8px 10px;\n                font-size: 12px;\n                text-align: center;\n                opacity: 0.7;\n            }\n            /* === 输入框清除按钮样式 === */\n            .acu-input-wrapper { position: relative; display: flex; align-items: center; width: 100%; }\n            .acu-input-wrapper input { padding-right: 24px !important; }\n            .acu-clear-btn { position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background: transparent !important; border: none !important; font-size: 12px; cursor: pointer; padding: 4px; line-height: 1; opacity: 0.5; transition: opacity 0.2s; z-index: 5; }\n            .acu-clear-btn:hover { background: transparent !important; border: none !important; opacity: 1 !important; }\n\n            /* ========== 人物关系图样式 ========== */\n            .acu-relation-graph-overlay {\n                background: rgba(0,0,0,0.8);\n                z-index: 2147483650;\n                backdrop-filter: blur(4px);\n            }\n            .acu-relation-graph-container {\n                width: 95%;\n                max-width: 900px;\n                height: 85vh;\n                max-height: 700px;\n            }\n            .acu-graph-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-graph-actions {\n                display: flex;\n                gap: 8px;\n            }\n            .acu-graph-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-graph-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-graph-canvas-wrapper {\n                flex: 1;\n                overflow: hidden;\n                position: relative;\n                min-height: 0;\n            }\n            .acu-graph-svg {\n                width: 100%;\n                height: 100%;\n                cursor: grab;\n            }\n            .acu-graph-svg:active { cursor: grabbing; }\n            .acu-graph-edge {\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                opacity: 0.6;\n            }\n            .acu-graph-edge-label {\n                font-size: 11px;\n                fill: var(--acu-text-sub);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-graph-node { cursor: grab; }\n            .acu-graph-node:active { cursor: grabbing; }\n            .acu-node-bg {\n                fill: var(--acu-btn-bg);\n                stroke: var(--acu-border);\n                stroke-width: 2;\n                transition: all 0.2s;\n            }\n            .acu-node-bg.player {\n                fill: var(--acu-accent);\n                stroke: var(--acu-btn-active-text);\n            }\n            .acu-graph-node:hover .acu-node-bg {\n                stroke-width: 3;\n                filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));\n            }\n            .acu-graph-svg.highlighting .acu-graph-node {\n                opacity: 0.2;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label {\n                opacity: 0.1;\n                transition: opacity 0.2s ease;\n            }\n            .acu-graph-svg.highlighting .acu-graph-node.highlighted {\n                opacity: 1;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge.highlighted {\n                opacity: 1;\n                stroke: var(--acu-accent);\n                stroke-width: 3;\n            }\n            .acu-graph-svg.highlighting .acu-graph-edge-label.highlighted {\n                opacity: 1;\n                fill: var(--acu-accent);\n                font-weight: bold;\n            }\n            .acu-node-char {\n                font-size: 16px;\n                font-weight: bold;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-bg.player + text.acu-node-char,\n            .acu-node-bg.player ~ text.acu-node-char {\n                fill: var(--acu-btn-active-text);\n            }\n            .acu-node-label {\n                font-size: 12px;\n                fill: var(--acu-text-main);\n                text-anchor: middle;\n                pointer-events: none;\n            }\n            .acu-node-inscene-indicator {\n                fill: var(--acu-accent);\n                stroke: var(--acu-bg-panel);\n                stroke-width: 2;\n                filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));\n            }\n            .acu-graph-legend {\n                display: flex;\n                gap: 16px;\n                justify-content: center;\n                padding: 10px;\n                border-top: 1px solid var(--acu-border);\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n            }\n            .acu-graph-legend span {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n            }\n            .acu-zoom-display {\n                background: var(--acu-btn-bg);\n                padding: 2px 8px;\n                border-radius: 4px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                min-width: 45px;\n                text-align: center;\n            }\n            .acu-node-size-slider-container input[type="range"] {\n                -webkit-appearance: none;\n                appearance: none;\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n                outline: none;\n                cursor: pointer;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-webkit-slider-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb {\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                background: var(--acu-accent);\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 2px 4px rgba(0,0,0,0.3);\n                transition: all 0.2s;\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-thumb:hover {\n                transform: scale(1.1);\n                box-shadow: 0 3px 6px rgba(0,0,0,0.4);\n            }\n            .acu-node-size-slider-container input[type="range"]::-moz-range-track {\n                height: 10px;\n                border-radius: 5px;\n                background: var(--acu-btn-bg);\n            }\n            @media (max-width: 768px) {\n                .acu-relation-graph-container {\n                    width: 100%;\n                    height: 80vh;\n                    max-height: none;\n                    border-radius: 12px;\n                }\n            }\n\n            /* ========== 头像管理弹窗样式 ========== */\n            .acu-avatar-manager-overlay {\n                background: rgba(0,0,0,0.7);\n                z-index: 2147483655;\n            }\n            .acu-avatar-manager {\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n            }\n            .acu-avatar-title {\n                font-size: 15px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            .acu-avatar-list {\n                flex: 1;\n                overflow-y: auto;\n                padding: 12px;\n                min-height: 0;\n            }\n            .acu-avatar-item {\n                display: flex;\n                align-items: flex-start;\n                gap: 12px;\n                padding: 10px;\n                border-bottom: 1px dashed var(--acu-border);\n            }\n            .acu-avatar-item:last-child { border-bottom: none; }\n            .acu-avatar-preview {\n                width: 48px;\n                height: 48px;\n                border-radius: 50%;\n                background: var(--acu-btn-bg);\n                background-size: cover;\n                background-position: center;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                border: 2px solid var(--acu-border);\n                flex-shrink: 0;\n                position: relative;\n                cursor: pointer;\n            }\n            .acu-avatar-preview span {\n                font-size: 18px;\n                font-weight: bold;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-camera-hint {\n                position: absolute;\n                bottom: 2px;\n                right: 2px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                opacity: 0.5;\n                pointer-events: none;\n            }\n            .acu-avatar-preview:hover .acu-avatar-camera-hint {\n                opacity: 0.8;\n                color: var(--acu-accent);\n            }\n            .acu-avatar-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-avatar-name {\n                font-size: 13px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-avatar-name-row {\n                display: flex;\n                align-items: center;\n                justify-content: space-between;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-url,\n            .acu-avatar-manager-overlay input.acu-avatar-aliases {\n                width: 100%;\n                padding: 6px 8px;\n                font-size: 12px;\n                border: 1px solid var(--acu-border);\n                border-radius: 4px;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-main) !important;\n                box-sizing: border-box;\n                -webkit-appearance: none;\n                appearance: none;\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-url:focus,\n            .acu-avatar-manager-overlay input.acu-avatar-aliases:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n                box-shadow: none !important;\n            }\n            /* 头像输入行（URL + 上传按钮） */\n            .acu-avatar-input-row {\n                display: flex;\n                gap: 6px;\n                align-items: center;\n            }\n            .acu-avatar-input-row .acu-avatar-url {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-avatar-upload-btn {\n                width: 32px;\n                height: 32px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                flex-shrink: 0;\n                transition: all 0.15s;\n            }\n            .acu-avatar-upload-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n                border-color: var(--acu-accent);\n            }\n            .acu-avatar-upload-btn:active {\n                transform: scale(0.95);\n            }\n            /* 头像来源标签 */\n            .acu-avatar-source {\n                position: absolute;\n                bottom: -10px;\n                left: 50%;\n                transform: translateX(-50%);\n                font-size: 9px;\n                padding: 1px 6px;\n                border-radius: 8px;\n                font-weight: bold;\n                white-space: nowrap;\n            }\n            .acu-avatar-preview-wrap {\n                position: relative;\n                flex-shrink: 0;\n            }\n            .acu-source-local,\n            .acu-source-url,\n            .acu-source-auto {\n                background: var(--acu-badge-bg);\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-manager-overlay input.acu-avatar-aliases {\n                padding: 4px 8px;\n                font-size: 11px;\n                margin-top: 4px;\n            }\n            .acu-avatar-manager-overlay input::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7;\n            }\n            .acu-avatar-actions {\n                display: flex;\n                flex-direction: row;\n                gap: 4px;\n                flex-shrink: 0;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-actions button {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg) !important;\n                color: var(--acu-text-sub) !important;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-actions button:hover {\n                background: var(--acu-btn-hover) !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-avatar-save-btn:hover { color: var(--acu-success-text, #27ae60) !important; }\n            .acu-avatar-clear-btn:hover { color: var(--acu-error-text, #e74c3c) !important; }\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 12px;\n                transition: all 0.2s;\n            }\n            .acu-avatar-import-btn:hover,\n            .acu-avatar-export-btn:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n            .acu-avatar-crop-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-top: 6px;\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-avatar-crop-row.hidden { display: none; }\n            .acu-avatar-manager-overlay .acu-avatar-scale {\n                flex: 1;\n                height: 6px !important;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n                margin: 0 8px;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-runnable-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-webkit-slider-thumb {\n                -webkit-appearance: none !important;\n                appearance: none !important;\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer !important;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 3px rgba(0,0,0,0.3) !important;\n                margin-top: -5px !important;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-track {\n                height: 6px !important;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-avatar-manager-overlay .acu-avatar-scale::-moz-range-thumb {\n                width: 16px !important;\n                height: 16px !important;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                border: 2px solid var(--acu-bg-panel);\n                cursor: pointer !important;\n            }\n            @media (max-width: 768px) {\n                .acu-avatar-manager {\n                    width: 95%;\n                    max-height: 85vh;\n                }\n            }\n\n            /* ========== 导入确认弹窗样式 ========== */\n            .acu-import-confirm-overlay {\n                z-index: 2147483660;\n            }\n            .acu-import-confirm-dialog {\n                width: 90%;\n                max-width: 320px;\n            }\n            .acu-import-confirm-body {\n                padding: 16px;\n            }\n            .acu-import-stats {\n                display: flex;\n                justify-content: space-around;\n                margin-bottom: 16px;\n            }\n            .acu-import-stat {\n                text-align: center;\n            }\n            .acu-stat-num {\n                display: block;\n                font-size: 24px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n            }\n            .acu-stat-label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n            }\n            .acu-stat-new .acu-stat-num { color: var(--acu-success-text); }\n            .acu-stat-conflict .acu-stat-num { color: #e67e22; }\n            .acu-import-conflict-section {\n                margin-top: 12px;\n                padding-top: 12px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-import-conflict-options {\n                margin-top: 10px;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n            .acu-import-radio {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-import-radio input {\n                accent-color: var(--acu-accent);\n            }\n            .acu-import-confirm-footer {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-import-cancel-btn,\n            .acu-import-confirm-btn {\n                flex: 1;\n                padding: 10px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: bold;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-import-cancel-btn {\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-import-cancel-btn:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-import-confirm-btn {\n                background: var(--acu-accent);\n                border: none;\n                color: #fff;\n            }\n            .acu-import-confirm-btn:hover {\n                opacity: 0.9;\n            }\n            /* ========== 头像导入/导出相关样式 ========== */\n            .acu-avatar-import-btn,\n            .acu-avatar-export-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n            }\n\n            /* ========== 统一骰子设置面板样式 ========== */\n            .acu-dice-config-dialog {\n                width: 320px;\n                max-width: 92vw;\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                box-shadow: 0 15px 40px rgba(0,0,0,0.4);\n                overflow: hidden;\n            }\n            .acu-dice-cfg-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 14px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-dice-cfg-header .acu-config-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                font-size: 14px;\n                padding: 4px;\n            }\n            .acu-dice-cfg-header .acu-config-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-body {\n                padding: 12px;\n            }\n            .acu-dice-cfg-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n            .acu-dice-cfg-row.acu-cfg-full-row {\n                grid-template-columns: 1fr;\n            }\n            .acu-dice-cfg-item {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n            .acu-dice-cfg-item label {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                font-weight: 500;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item {\n                flex-direction: row;\n                align-items: center;\n                justify-content: space-between;\n                padding: 8px 0;\n            }\n            .acu-dice-cfg-item.acu-cfg-toggle-item > label {\n                margin: 0;\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input,\n            .acu-dice-cfg-item select {\n                width: 100%;\n                padding: 7px 8px;\n                background: var(--acu-input-bg) !important;\n                border: 1px solid var(--acu-border);\n                border-radius: 5px;\n                color: var(--acu-text-main) !important;\n                font-size: 13px;\n                text-align: center;\n                box-sizing: border-box;\n            }\n            .acu-dice-cfg-item input::placeholder {\n                color: var(--acu-text-sub);\n                opacity: 0.6;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item select {\n                text-align: left;\n                cursor: pointer;\n            }\n            .acu-dice-cfg-item select option {\n                background: var(--acu-bg-panel);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-item input:focus,\n            .acu-dice-cfg-item select:focus {\n                outline: none;\n                border-color: var(--acu-accent);\n            }\n            .acu-cfg-hint {\n                font-size: 9px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n                text-align: center;\n            }\n            .acu-dice-cfg-actions {\n                display: flex;\n                gap: 8px;\n                margin-top: 12px;\n                padding-top: 10px;\n                border-top: 1px dashed var(--acu-border);\n            }\n            .acu-dice-cfg-actions button {\n                flex: 1;\n                padding: 9px 12px;\n                border-radius: 6px;\n                font-size: 12px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid var(--acu-border);\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n            }\n            .acu-dice-cfg-actions button:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-dice-cfg-actions button.primary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-btn-bg);\n                color: var(--acu-button-text);\n            }\n            .acu-dice-cfg-actions button.primary:hover {\n                background: var(--acu-btn-hover);\n                border-color: var(--acu-btn-hover);\n            }\n            /* ========== 新版设置面板样式 ========== */\n            .acu-settings-dialog {\n                width: 380px;\n                max-width: 380px;\n                max-height: 85vh;\n                padding: 0;\n                gap: 0;\n            }\n            @media (max-width: 768px) {\n                .acu-settings-dialog {\n                    width: 92vw;\n                    max-width: 92vw;\n                    max-height: 85vh;\n                }\n                .acu-settings-body {\n                    max-height: calc(85vh - 110px);\n                    -webkit-overflow-scrolling: touch;\n                }\n                .acu-table-manager-list {\n                    max-height: 40vh;\n                    -webkit-overflow-scrolling: touch;\n                }\n            }\n            .acu-settings-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 14px 16px;\n                border-bottom: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-settings-title {\n                font-size: 16px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n            .acu-settings-body {\n                flex: 1;\n                min-height: 0;\n                overflow-y: auto;\n                overflow-x: hidden;\n                padding: 8px;\n                -webkit-overflow-scrolling: touch;\n            }\n            .acu-settings-group {\n                background: var(--acu-card-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 8px;\n            }\n            .acu-settings-group-title {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 12px 14px;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: var(--acu-table-head);\n                cursor: pointer;\n                user-select: none;\n                transition: background 0.15s;\n            }\n            .acu-settings-group-title:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-group-chevron {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                width: 12px;\n                transition: transform 0.2s;\n            }\n            .acu-settings-group-body {\n                padding: 4px 12px 8px;\n            }\n            .acu-settings-group.collapsed .acu-settings-group-body {\n                display: none;\n            }\n            .acu-settings-group-body.acu-animating {\n                display: block !important;\n                overflow: hidden;\n            }\n            .acu-settings-group:last-child {\n                margin-bottom: 0;\n            }\n            .acu-setting-row {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 10px 0;\n                border-bottom: 1px dashed var(--acu-border);\n                gap: 12px;\n                min-height: 44px;\n            }\n            .acu-setting-row:last-child {\n                border-bottom: none;\n            }\n            .acu-setting-row-slider {\n                flex-direction: column;\n                align-items: stretch;\n            }\n            .acu-setting-info {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-setting-label {\n                font-size: 13px;\n                color: var(--acu-text-main);\n            }\n            .acu-setting-hint {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-setting-value {\n                font-size: 12px;\n                font-weight: bold;\n                color: var(--acu-accent);\n                margin-left: auto;\n            }\n            .acu-setting-select {\n                padding: 6px 10px;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px;\n                min-width: 120px;\n                cursor: pointer;\n                -webkit-appearance: none;\n                appearance: none;\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23888' d='M6 8L2 4h8z'/%3E%3C/svg%3E");\n                background-repeat: no-repeat;\n                background-position: right 8px center;\n                padding-right: 28px;\n            }\n            .acu-setting-select:focus {\n                outline: none;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-setting-select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-select-short {\n                min-width: 80px;\n            }\n            .acu-setting-slider {\n                width: 100%;\n                height: 6px;\n                margin-top: 8px;\n                -webkit-appearance: none;\n                appearance: none;\n                background: var(--acu-border) !important;\n                border-radius: 3px;\n                outline: none;\n                border: none;\n            }\n            .acu-setting-slider::-webkit-slider-runnable-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n            }\n            .acu-setting-slider::-webkit-slider-thumb {\n                -webkit-appearance: none;\n                appearance: none;\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n                margin-top: -6px;\n            }\n            .acu-setting-slider::-moz-range-track {\n                height: 6px;\n                background: var(--acu-border);\n                border-radius: 3px;\n                border: none;\n            }\n            .acu-setting-slider::-moz-range-thumb {\n                width: 18px;\n                height: 18px;\n                background: var(--acu-accent) !important;\n                border-radius: 50%;\n                cursor: pointer;\n                border: 2px solid var(--acu-bg-panel);\n                box-shadow: 0 1px 4px rgba(0,0,0,0.2);\n            }\n            .acu-setting-slider:focus {\n                outline: none;\n            }\n            .acu-setting-mini-btn {\n                width: 28px;\n                height: 28px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 11px;\n                flex-shrink: 0;\n                transition: all 0.15s;\n            }\n            .acu-setting-mini-btn:hover, .acu-setting-mini-btn.active {\n                background: var(--acu-accent);\n                color: #fff;\n                border-color: var(--acu-accent);\n            }\n\n            /* ========== 属性预设管理面板样式 ========== */\n            .acu-preset-item {\n                padding: 12px;\n                background: var(--acu-card-bg);\n                border: 1px solid var(--acu-border);\n                border-radius: 8px;\n                margin-bottom: 10px;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                gap: 12px;\n                transition: all 0.2s;\n            }\n            .acu-preset-item:hover {\n                background: var(--acu-table-hover);\n                border-color: var(--acu-accent);\n            }\n            .acu-preset-info {\n                flex: 1;\n            }\n            .acu-preset-name {\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-text-main);\n                margin-bottom: 4px;\n            }\n            .acu-preset-desc {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                margin-bottom: 4px;\n            }\n            .acu-preset-stats {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n            }\n            .acu-preset-actions {\n                display: flex;\n                gap: 8px;\n                flex-shrink: 0;\n                align-items: center;\n            }\n            .acu-preset-btn {\n                width: 32px;\n                height: 32px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 13px;\n                transition: all 0.15s;\n            }\n            .acu-preset-btn:hover {\n                background: var(--acu-accent);\n                color: #fff;\n                border-color: var(--acu-accent);\n            }\n            .acu-preset-btn.acu-preset-delete:hover {\n                background: rgba(231, 76, 60, 0.2);\n                color: #e74c3c;\n                border-color: #e74c3c;\n            }\n            /* 预设编辑器输入框样式（防止被主题覆盖） */\n            .acu-preset-editor-input,\n            .acu-preset-editor-textarea {\n                background: var(--acu-input-bg) !important;\n                color: var(--acu-text-main) !important;\n                border: 1px solid var(--acu-border) !important;\n            }\n            .acu-preset-editor-input:focus,\n            .acu-preset-editor-textarea:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n                box-shadow: 0 0 0 2px rgba(var(--acu-accent-rgb, 100, 150, 200), 0.2) !important;\n            }\n            .acu-preset-editor-textarea {\n                font-family: 'Consolas', 'Monaco', 'Courier New', monospace !important;\n            }\n            /* Toggle 开关 */\n            .acu-toggle {\n                position: relative;\n                width: 44px;\n                height: 24px;\n                flex-shrink: 0;\n            }\n            .acu-toggle input {\n                opacity: 0;\n                width: 0;\n                height: 0;\n            }\n            .acu-toggle-slider {\n                position: absolute;\n                cursor: pointer;\n                top: 0; left: 0; right: 0; bottom: 0;\n                background: var(--acu-border);\n                border-radius: 24px;\n                transition: all 0.2s;\n            }\n            .acu-toggle-slider:before {\n                position: absolute;\n                content: "";\n                height: 18px;\n                width: 18px;\n                left: 3px;\n                bottom: 3px;\n                background: var(--acu-bg-panel);\n                border-radius: 50%;\n                transition: all 0.2s;\n                box-shadow: 0 1px 3px rgba(0,0,0,0.2);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider {\n                background: var(--acu-accent);\n            }\n            .acu-toggle input:checked + .acu-toggle-slider:before {\n                transform: translateX(20px);\n            }\n            .acu-setting-action-btn {\n                width: 100%;\n                padding: 10px 14px;\n                margin-bottom: 6px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: all 0.15s;\n            }\n            /* Stepper 步进器 */\n            .acu-stepper {\n                display: flex;\n                align-items: center;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                overflow: hidden;\n                background: transparent !important;\n                flex-shrink: 0;\n            }\n            .acu-stepper-btn {\n                width: 36px;\n                height: 34px;\n                border: none !important;\n                background: transparent !important;\n                background-color: transparent !important;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n                -webkit-appearance: none !important;\n                appearance: none !important;\n            }\n            .acu-stepper-btn:hover {\n                background: var(--acu-table-hover) !important;\n                color: var(--acu-accent);\n            }\n            .acu-stepper-btn:active {\n                transform: scale(0.95);\n                background: var(--acu-accent) !important;\n                color: var(--acu-button-text);\n            }\n            .acu-stepper-value {\n                min-width: 60px;\n                height: 34px;\n                line-height: 34px;\n                text-align: center;\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--acu-text-main);\n                background: transparent !important;\n                border-left: 1px solid var(--acu-border);\n                border-right: 1px solid var(--acu-border);\n            }\n            /* ========== 变更审核面板样式 ========== */\n            .acu-changes-content {\n                padding: 10px;\n                overflow-y: auto !important;\n                overflow-x: hidden !important;\n                -webkit-overflow-scrolling: touch !important;\n                touch-action: pan-y !important;\n                overscroll-behavior-y: contain;\n            }\n            /* ========== 验证错误消息样式 ========== */\n            .acu-validation-error-msg {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                flex: 1;\n                min-width: 0;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n            }\n            /* 数据验证模式提示 - 固定在面板顶部，不参与横向滚动 */\n            .acu-validation-mode-hint {\n                padding: 8px 12px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                background: var(--acu-table-head);\n                border-radius: 6px;\n                margin: 0 0 10px 0;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n            /* 审核面板横向滚动模式 */\n            .acu-changes-content.acu-changes-horizontal {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                align-items: flex-start !important;\n                gap: 12px;\n                overflow-x: auto !important;\n                overflow-y: visible !important;\n                touch-action: pan-x pan-y !important;\n                padding-bottom: 5px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-x: contain;\n                overscroll-behavior-y: auto;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-list {\n                display: flex !important;\n                flex-direction: row !important;\n                flex-wrap: nowrap !important;\n                gap: 12px;\n                align-items: flex-start;\n                min-width: max-content;\n            }\n            .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                flex: 0 0 280px;\n                min-width: 280px;\n                max-width: 280px;\n                max-height: none;\n                overflow-y: visible;\n                -webkit-overflow-scrolling: auto;\n                overscroll-behavior-y: auto;\n            }\n            @media (min-width: 769px) {\n                .acu-changes-content.acu-changes-horizontal .acu-changes-group {\n                    flex: 0 0 320px;\n                    min-width: 320px;\n                    max-width: 320px;\n                }\n            }\n            .acu-changes-list { display: flex; flex-direction: column; gap: 10px; }\n            .acu-changes-group { background: var(--acu-card-bg); border: 1px solid var(--acu-border); border-radius: 8px; overflow: hidden; }\n            .acu-changes-group-header { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--acu-table-head); font-weight: bold; font-size: 13px; color: var(--acu-text-main); }\n            .acu-changes-count { margin-left: auto; background: var(--acu-accent); color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: normal; }\n            .acu-changes-group-body { padding: 6px; display: flex; flex-direction: column; gap: 4px; }\n            .acu-change-item { display: flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 6px; font-size: 12px; background: rgba(0,0,0,0.02); flex-wrap: wrap; transition: all 0.15s; }\n            .acu-change-item:hover { background: var(--acu-table-hover); }\n            .acu-change-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }\n            .acu-badge-added { background: var(--acu-success-bg); color: var(--acu-success-text); }\n            .acu-badge-deleted { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); }\n            .acu-badge-modified { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); }\n            .acu-change-title { color: var(--acu-text-main); font-weight: 500; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-field { color: var(--acu-text-sub); font-size: 11px; flex-shrink: 0; max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            .acu-change-diff { display: flex; align-items: center; gap: 4px; flex: 1; min-width: 0; overflow: hidden; }\n            .acu-diff-old { color: var(--acu-hl-manual); text-decoration: line-through; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            .acu-diff-arrow { color: var(--acu-text-sub); flex-shrink: 0; }\n            .acu-diff-new { color: var(--acu-success-text); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 80px; }\n            /* 变更操作按钮 */\n            .acu-change-actions { display: flex; gap: 4px; margin-left: auto; flex-shrink: 0; }\n            .acu-change-action-btn { width: 24px; height: 24px; border: 1px solid var(--acu-border); border-radius: 4px; background: var(--acu-btn-bg); color: var(--acu-text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 11px; transition: all 0.15s; padding: 0; }\n            .acu-change-action-btn:hover { background: var(--acu-btn-hover); color: var(--acu-text-main); transform: scale(1.1); }\n            .acu-action-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-action-reject:hover, .acu-action-restore:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-action-edit:hover { background: var(--acu-hl-diff-bg); color: var(--acu-hl-diff); border-color: var(--acu-hl-diff); }\n            /* 批量操作按钮 - 增强深色主题下的对比度 */\n            .acu-changes-batch-btn { width: 32px; height: 32px; border: 1.5px solid rgba(255,255,255,0.4); border-radius: 6px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.85); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: all 0.15s; }\n            .acu-changes-batch-btn:hover { background: rgba(255,255,255,0.2); color: #fff; border-color: rgba(255,255,255,0.6); }\n            .acu-batch-accept:hover { background: var(--acu-success-bg); color: var(--acu-success-text); border-color: var(--acu-success-text); }\n            .acu-batch-reject:hover { background: var(--acu-hl-manual-bg); color: var(--acu-hl-manual); border-color: var(--acu-hl-manual); }\n            .acu-simple-mode-toggle.active { background: var(--acu-accent); color: #fff; border-color: var(--acu-accent); }\n            .acu-simple-mode-toggle:hover { background: var(--acu-accent); color: #fff; border-color: var(--acu-accent); }\n            .acu-changes-group.collapsed .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group:not(.collapsed) .acu-collapse-icon { transform: rotate(0deg); }\n            .acu-changes-group-header:hover { background: var(--acu-table-hover); }\n            /* 变更对比编辑弹窗样式 */\n            .acu-diff-section { margin-bottom: 12px; }\n            .acu-diff-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }\n            .acu-diff-readonly { padding: 10px 12px; background: var(--acu-table-head); border: 1px dashed var(--acu-border); border-radius: 6px; color: var(--acu-text-main); font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; max-height: 150px; overflow-y: auto; opacity: 0.8; }\n            .acu-diff-arrow-down { text-align: center; color: var(--acu-text-sub); font-size: 14px; margin: 8px 0; opacity: 0.5; }\n            /* 可编辑区域高亮样式 */\n            .acu-diff-new-section { padding: 12px; background: var(--acu-input-bg); border: 2px solid var(--acu-accent); border-radius: 6px; box-shadow: 0 0 0 3px rgba(127, 127, 255, 0.1); }\n            .acu-diff-new-section .acu-diff-label { color: var(--acu-accent); font-weight: 600; }\n            .acu-diff-new-section textarea,\n            .acu-diff-new-section input { background: var(--acu-input-bg) !important; border-color: var(--acu-border) !important; }\n            .acu-diff-new-section textarea:focus,\n            .acu-diff-new-section input:focus { border-color: var(--acu-accent) !important; box-shadow: 0 0 0 2px rgba(127, 127, 255, 0.15); }\n            /* 单字段编辑弹窗按钮优化 */\n            .acu-edit-dialog .acu-dialog-btns {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n                margin: 0 -16px -16px -16px;\n                border-radius: 0 0 12px 12px;\n            }\n            .acu-edit-dialog .acu-dialog-btn {\n                flex: 1;\n                padding: 10px 12px;\n                border: 1px solid var(--acu-border);\n                border-radius: 6px;\n                background: var(--acu-btn-bg);\n                color: var(--acu-text-main);\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                white-space: nowrap;\n                transition: all 0.15s;\n            }\n            .acu-edit-dialog .acu-dialog-btn:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-edit-dialog .acu-btn-confirm {\n                background: var(--acu-accent);\n                border-color: var(--acu-accent);\n                color: #fff;\n            }\n            .acu-edit-dialog .acu-btn-confirm:hover {\n                opacity: 0.9;\n            }\n            @media (max-width: 768px) {\n                .acu-edit-dialog .acu-dialog-btns {\n                    flex-wrap: nowrap;\n                }\n                .acu-edit-dialog .acu-dialog-btn {\n                    padding: 10px 8px;\n                    font-size: 12px;\n                    min-width: 0;\n                }\n                .acu-edit-dialog .acu-dialog-btn i {\n                    font-size: 11px;\n                }\n            }\n            @media (max-width: 768px) {\n                .acu-change-item { padding: 8px 6px; }\n                .acu-change-diff { flex-basis: 100%; margin-top: 4px; order: 10; }\n                .acu-change-actions { order: 5; }\n                .acu-diff-old, .acu-diff-new { max-width: 100px; }\n                .acu-change-action-btn { width: 28px; height: 28px; }\n            }\n            .acu-change-field-count { font-size: 11px; color: var(--acu-text-sub); margin-left: 4px; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n            /* 多字段整体编辑弹窗样式 */\n            .acu-row-edit-field { margin-bottom: 12px; padding: 10px; background: var(--acu-table-head); border-radius: 6px; border: 1px solid transparent; }\n            .acu-row-edit-field.acu-field-changed { border-color: var(--acu-accent); background: var(--acu-bg-panel); }\n            .acu-row-edit-label { font-size: 12px; font-weight: bold; color: var(--acu-text-sub); margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }\n            .acu-changed-badge { font-size: 10px; padding: 1px 6px; background: var(--acu-accent); color: #fff; border-radius: 3px; font-weight: normal; }\n            .acu-row-edit-old { font-size: 12px; color: var(--acu-text-sub); padding: 6px 8px; background: var(--acu-table-head); border-radius: 4px; margin-bottom: 6px; text-decoration: line-through; opacity: 0.7; white-space: pre-wrap; word-break: break-word; }\n            .acu-row-edit-input { width: 100%; min-height: 36px; max-height: 200px; padding: 8px; resize: none; }\n            .acu-empty-val { opacity: 0.5; font-style: italic; }\n            /* ========== 表格管理列表样式 ========== */\n            .acu-table-manager-list {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                max-height: 300px;\n                overflow-y: auto;\n                padding: 4px;\n                -webkit-overflow-scrolling: touch;\n                overscroll-behavior-y: contain;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                cursor: default;\n                transition: all 0.15s;\n                user-select: none;\n                touch-action: pan-y;\n            }\n            .acu-table-manager-item:hover {\n                background: var(--acu-table-hover);\n            }\n            .acu-table-manager-item.hidden-table {\n                opacity: 0.5;\n                border-color: var(--acu-border);\n                border-style: dashed;\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-name {\n                text-decoration: line-through;\n            }\n            .acu-table-item-check {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                cursor: pointer;\n                color: var(--acu-accent);\n                border-radius: 4px;\n                transition: all 0.15s;\n            }\n            .acu-table-item-check:hover {\n                background: var(--acu-table-hover);\n                transform: scale(1.1);\n            }\n            .acu-table-manager-item.hidden-table .acu-table-item-check {\n                color: var(--acu-text-sub);\n            }\n            .acu-table-item-icon {\n                width: 20px;\n                text-align: center;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n            }\n            .acu-table-item-name {\n                flex: 1;\n                font-size: 13px;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-table-item-handle {\n                width: 28px;\n                height: 28px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--acu-text-sub);\n                cursor: grab;\n                opacity: 0.4;\n                transition: all 0.15s;\n                border-radius: 4px;\n            }\n            .acu-table-item-handle:hover {\n                opacity: 1;\n                background: var(--acu-table-hover);\n                color: var(--acu-accent);\n            }\n            .acu-table-manager-item.acu-dragging {\n                opacity: 0.9;\n                background: var(--acu-accent);\n                border-color: var(--acu-accent);\n                box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n                z-index: 100;\n            }\n            .acu-table-manager-item.acu-dragging .acu-table-item-name,\n            .acu-table-manager-item.acu-dragging .acu-table-item-check,\n            .acu-table-manager-item.acu-dragging .acu-table-item-icon,\n            .acu-table-manager-item.acu-dragging .acu-table-item-handle {\n                color: #fff;\n            }\n            .acu-table-manager-item.acu-drag-above {\n                border-top: 2px solid var(--acu-accent);\n                margin-top: -1px;\n            }\n            .acu-table-manager-item.acu-drag-below {\n                border-bottom: 2px solid var(--acu-accent);\n                margin-bottom: -1px;\n            }\n            @media (max-width: 768px) {\n                .acu-table-item-handle {\n                    opacity: 0.6;\n                }\n            }\n            /* 特殊按钮样式（投骰/审核/变量） */\n            .acu-table-manager-item.acu-special-item {\n                background: linear-gradient(135deg, rgba(var(--acu-accent-rgb, 128, 128, 128), 0.08), transparent);\n                border-style: dashed;\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-icon {\n                color: var(--acu-accent);\n            }\n            .acu-table-manager-item.acu-special-item .acu-table-item-name {\n                font-weight: 500;\n            }\n            /* ========== 数据验证规则样式 ========== */\n            .acu-validation-rules-list {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                max-height: 280px;\n                overflow-y: auto;\n                padding: 2px;\n            }\n            .acu-validation-rule-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 8px 10px;\n                background: transparent;\n                border: 1.5px solid var(--acu-accent);\n                border-radius: 6px;\n                transition: all 0.2s ease;\n            }\n            .acu-validation-rule-item.disabled {\n                opacity: 0.5;\n            }\n            .acu-validation-rule-item:hover {\n                border-color: var(--acu-accent);\n            }\n            .acu-rule-toggle {\n                cursor: pointer;\n                font-size: 18px;\n                color: var(--acu-text-sub);\n                transition: color 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-toggle.active {\n                color: var(--acu-accent);\n            }\n            .acu-rule-toggle:hover {\n                opacity: 0.8;\n            }\n            .acu-rule-info {\n                flex: 1;\n                min-width: 0;\n            }\n            .acu-rule-name {\n                font-size: 12px;\n                font-weight: 500;\n                color: var(--acu-text-main);\n                white-space: nowrap;\n                overflow: hidden;\n                text-overflow: ellipsis;\n            }\n            .acu-rule-target {\n                font-size: 10px;\n                color: var(--acu-text-sub);\n                margin-top: 2px;\n            }\n            .acu-rule-type-icon {\n                width: 20px;\n                font-size: 12px;\n                color: var(--acu-text-sub);\n                flex-shrink: 0;\n                text-align: center;\n            }\n            .acu-rule-delete {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                cursor: pointer;\n                padding: 4px;\n                opacity: 0.6;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-delete:hover {\n                color: #e74c3c;\n                opacity: 1;\n            }\n            .acu-rule-intercept {\n                cursor: pointer;\n                font-size: 14px;\n                color: var(--acu-text-sub);\n                padding: 4px 6px;\n                border-radius: 4px;\n                opacity: 0.5;\n                transition: all 0.2s;\n                flex-shrink: 0;\n            }\n            .acu-rule-intercept:hover {\n                opacity: 0.8;\n                background: var(--acu-hover-bg);\n            }\n            .acu-rule-intercept.active {\n                color: var(--acu-accent);\n                opacity: 1;\n            }\n            .acu-add-rule-btn {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                width: 100%;\n                padding: 10px;\n                margin-top: 8px;\n                background: var(--acu-btn-bg);\n                border: 1px dashed var(--acu-border);\n                border-radius: 6px;\n                color: var(--acu-text-sub);\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n            }\n            .acu-add-rule-btn:hover {\n                border-color: var(--acu-accent);\n                color: var(--acu-accent);\n                background: rgba(var(--acu-accent-rgb, 128, 128, 128), 0.1);\n            }\n            /* 验证规则弹窗 */\n            .acu-validation-modal-overlay {\n                z-index: 2147483659;\n            }\n            .acu-validation-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 420px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-validation-modal-body {\n                padding: 16px;\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                max-height: 60vh;\n                overflow-y: auto;\n            }\n            .acu-validation-modal-body .acu-setting-row {\n                flex-wrap: wrap;\n            }\n            .acu-validation-modal-body .acu-panel-input,\n            .acu-validation-modal input[type="text"],\n            .acu-validation-modal input[type="number"],\n            .acu-validation-modal select {\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                padding: 8px 10px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 12px !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n            }\n            .acu-validation-modal-body .acu-panel-input:focus,\n            .acu-validation-modal input[type="text"]:focus,\n            .acu-validation-modal input[type="number"]:focus,\n            .acu-validation-modal select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-validation-modal-body .acu-panel-input::placeholder,\n            .acu-validation-modal input[type="text"]::placeholder,\n            .acu-validation-modal input[type="number"]::placeholder {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-validation-modal select option {\n                background: var(--acu-bg-panel) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-validation-modal select option[value=""] {\n                color: var(--acu-text-sub) !important;\n                opacity: 0.7 !important;\n            }\n            .acu-rule-config-section {\n                padding: 8px 0;\n            }\n            .acu-validation-modal-footer {\n                display: flex;\n                justify-content: center;\n                gap: 12px;\n                padding: 16px;\n                border-top: 1px solid var(--acu-border);\n                background: var(--acu-table-head);\n            }\n            .acu-validation-modal-footer .acu-btn {\n                flex: 1;\n                padding: 10px 12px !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n            }\n            /* 智能修改弹窗样式 */\n            .acu-smart-fix-meta {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 0 !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-separator {\n                color: var(--acu-border) !important;\n                opacity: 0.5 !important;\n            }\n            .acu-smart-fix-diff {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                padding: 6px 0 !important;\n                margin: 4px 0 !important;\n                flex-wrap: wrap !important;\n            }\n            .acu-smart-fix-diff-old-text {\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n                font-size: 13px !important;\n                white-space: nowrap !important;\n                overflow: hidden !important;\n                text-overflow: ellipsis !important;\n                max-width: 150px !important;\n            }\n            .acu-smart-fix-diff-arrow {\n                color: var(--acu-text-sub) !important;\n                flex-shrink: 0 !important;\n            }\n            .acu-smart-fix-empty {\n                opacity: 0.5 !important;\n                font-style: italic !important;\n            }\n            .acu-smart-fix-diff-input-wrapper {\n                flex: 1 !important;\n                min-width: 120px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input,\n            .acu-smart-fix-diff-input-wrapper select {\n                width: 100% !important;\n                background: var(--acu-input-bg, var(--acu-btn-bg)) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                padding: 4px 8px !important;\n                color: var(--acu-text-main) !important;\n                font-size: 13px !important;\n                font-weight: 500 !important;\n                box-shadow: none !important;\n                -webkit-appearance: none !important;\n                -moz-appearance: none !important;\n                appearance: none !important;\n                min-height: 26px !important;\n                line-height: 1.3 !important;\n            }\n            .acu-smart-fix-diff-input-wrapper input:focus,\n            .acu-smart-fix-diff-input-wrapper select:focus {\n                outline: none !important;\n                border-color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select {\n                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%23666' d='M5 7L1 3h8z'/%3E%3C/svg%3E") !important;\n                background-repeat: no-repeat !important;\n                background-position: right 6px center !important;\n                padding-right: 24px !important;\n            }\n            .acu-smart-fix-diff-input-wrapper select option {\n                background: var(--acu-card-bg) !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-suggest {\n                padding: 10px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-suggest-label {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                margin-bottom: 6px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 4px !important;\n            }\n            .acu-smart-fix-suggest-label i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-suggest-value {\n                font-size: 13px !important;\n                color: var(--acu-success-text) !important;\n                font-weight: 500 !important;\n                padding: 6px 8px !important;\n                background: var(--acu-success-bg) !important;\n                border-radius: 4px !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-suggest-value:hover {\n                background: var(--acu-success-text) !important;\n                color: white !important;\n            }\n            .acu-smart-fix-suggest-options {\n                display: flex !important;\n                flex-wrap: wrap !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-suggest-options-scroll {\n                max-height: 120px !important;\n                overflow-y: auto !important;\n                padding-right: 4px !important;\n            }\n            .acu-smart-fix-option {\n                display: inline-block !important;\n                font-size: 12px !important;\n                padding: 4px 10px !important;\n                background: var(--acu-btn-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 4px !important;\n                color: var(--acu-text-main) !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-option:hover {\n                background: var(--acu-btn-hover) !important;\n                border-color: var(--acu-accent) !important;\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-option-current {\n                background: var(--acu-hl-manual-bg) !important;\n                border-color: var(--acu-hl-manual) !important;\n                color: var(--acu-hl-manual) !important;\n                text-decoration: line-through !important;\n                opacity: 0.7 !important;\n            }\n            .acu-smart-fix-error-hint {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-card-bg) !important;\n                border-radius: 4px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-error-hint i {\n                color: var(--acu-accent) !important;\n                flex-shrink: 0 !important;\n            }\n            @media (max-width: 600px) {\n                .acu-smart-fix-diff {\n                    flex-direction: column !important;\n                    align-items: stretch !important;\n                }\n                .acu-smart-fix-diff-arrow {\n                    transform: rotate(90deg) !important;\n                }\n            }\n            .acu-btn {\n                padding: 8px 16px;\n                border-radius: 6px;\n                font-size: 12px;\n                cursor: pointer;\n                transition: all 0.2s;\n                border: 1px solid transparent;\n            }\n            .acu-btn-secondary {\n                background: var(--acu-btn-bg);\n                border-color: var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-btn-secondary:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-btn-primary {\n                background: var(--acu-accent);\n                color: white;\n            }\n            .acu-btn-primary:hover {\n                opacity: 0.9;\n            }\n            /* 智能修改弹窗新增样式 */\n            .acu-smart-fix-rule-info {\n                padding: 10px 12px !important;\n                background: var(--acu-table-head) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-left: 3px solid var(--acu-accent) !important;\n                border-radius: 4px !important;\n                margin-bottom: 12px !important;\n            }\n            .acu-smart-fix-rule-header {\n                display: flex !important;\n                align-items: center !important;\n                gap: 8px !important;\n                font-size: 13px !important;\n                font-weight: 600 !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-rule-header i {\n                color: var(--acu-accent) !important;\n            }\n            .acu-smart-fix-rule-desc {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                line-height: 1.4 !important;\n            }\n            .acu-smart-fix-suggest-section {\n                margin-top: 12px !important;\n            }\n            .acu-smart-fix-suggest code {\n                background: var(--acu-table-head) !important;\n                padding: 2px 6px !important;\n                border-radius: 3px !important;\n                font-size: 11px !important;\n                color: var(--acu-text-main) !important;\n            }\n            .acu-smart-fix-quick-btn {\n                display: inline-flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n                padding: 6px 12px !important;\n                background: var(--acu-success-bg) !important;\n                color: var(--acu-success-text) !important;\n                border: 1px solid var(--acu-success-text) !important;\n                border-radius: 4px !important;\n                font-size: 12px !important;\n                font-weight: 500 !important;\n                cursor: pointer !important;\n                transition: all 0.2s !important;\n            }\n            .acu-smart-fix-quick-btn:hover {\n                background: var(--acu-success-text) !important;\n                color: white !important;\n            }\n            .acu-smart-fix-table-summary {\n                padding: 12px !important;\n                background: var(--acu-card-bg) !important;\n                border: 1px solid var(--acu-border) !important;\n                border-radius: 6px !important;\n            }\n            .acu-smart-fix-stat {\n                font-size: 13px !important;\n                color: var(--acu-text-main) !important;\n                margin-bottom: 8px !important;\n            }\n            .acu-smart-fix-stat strong {\n                color: var(--acu-hl-manual) !important;\n            }\n            .acu-smart-fix-change-list {\n                max-height: 150px !important;\n                overflow-y: auto !important;\n                margin-top: 8px !important;\n            }\n            .acu-smart-fix-change-item {\n                font-size: 11px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 4px 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 3px !important;\n                margin-bottom: 4px !important;\n            }\n            .acu-smart-fix-hint {\n                font-size: 12px !important;\n                color: var(--acu-text-sub) !important;\n                padding: 8px !important;\n                background: var(--acu-table-head) !important;\n                border-radius: 4px !important;\n                margin-top: 8px !important;\n                display: flex !important;\n                align-items: center !important;\n                gap: 6px !important;\n            }\n            .acu-smart-fix-hint i {\n                color: var(--acu-accent) !important;\n            }\n            /* ========== 头像裁剪弹窗样式 ========== */\n            .acu-crop-modal-overlay {\n                z-index: 2147483658;\n            }\n            .acu-crop-modal {\n                background: var(--acu-bg-panel);\n                border: 1px solid var(--acu-border);\n                border-radius: 12px;\n                width: 90%;\n                max-width: 360px;\n                overflow: hidden;\n                box-shadow: 0 20px 60px rgba(0,0,0,0.5);\n            }\n            .acu-crop-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-bottom: 1px solid var(--acu-border);\n                font-size: 14px;\n                font-weight: bold;\n                color: var(--acu-accent);\n            }\n            .acu-crop-close {\n                background: none;\n                border: none;\n                color: var(--acu-text-sub);\n                font-size: 16px;\n                cursor: pointer;\n                padding: 4px;\n            }\n            .acu-crop-close:hover {\n                color: var(--acu-text-main);\n            }\n            .acu-crop-body {\n                padding: 20px;\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 12px;\n            }\n            .acu-crop-container {\n                position: relative;\n                width: 200px;\n                height: 200px;\n                border-radius: 50%;\n                overflow: hidden;\n                touch-action: none;\n                user-select: none;\n            }\n            .acu-crop-image {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background-repeat: no-repeat;\n                cursor: grab;\n            }\n            .acu-crop-mask {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                border: 3px solid var(--acu-accent);\n                border-radius: 50%;\n                pointer-events: none;\n                box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);\n            }\n            .acu-crop-hint {\n                font-size: 11px;\n                color: var(--acu-text-sub);\n                opacity: 0.7;\n            }\n            .acu-crop-footer {\n                display: flex;\n                gap: 10px;\n                padding: 12px 16px;\n                background: var(--acu-table-head);\n                border-top: 1px solid var(--acu-border);\n            }\n            .acu-crop-btn {\n                flex: 1;\n                padding: 10px 16px;\n                border-radius: 6px;\n                font-size: 13px;\n                font-weight: 500;\n                cursor: pointer;\n                transition: all 0.15s;\n            }\n            .acu-crop-cancel {\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n            }\n            .acu-crop-cancel:hover {\n                background: var(--acu-btn-hover);\n            }\n            .acu-crop-confirm {\n                background: var(--acu-accent);\n                border: 1px solid var(--acu-accent);\n                color: #fff;\n            }\n            .acu-crop-confirm:hover {\n                opacity: 0.9;\n            }\n            .acu-crop-reupload {\n                flex: 0 0 auto;\n                padding: 10px 14px;\n                background: var(--acu-btn-bg);\n                border: 1px solid var(--acu-border);\n                color: var(--acu-text-main);\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n            .acu-crop-reupload:hover {\n                background: var(--acu-btn-hover);\n                color: var(--acu-accent);\n            }\n    </style>\n    `;$('head').append(t)},zt=()=>{const e=Pe().getDB();return e&&e.exportTableAsJson?e.exportTableAsJson():null},At=async(e,t=!1,a=!1)=>{if(ge)return;ge=!0;const{$}=Pe(),n=$('#acu-btn-save-global');!t&&n.length&&(n.find('i').removeClass('fa-save').addClass('fa-spinner fa-spin'),n.prop('disabled',!0));try{const n={};if(e.mate?n.mate=e.mate:n.mate={type:'chatSheets',version:1},Object.keys(e).forEach(t=>{t.startsWith('sheet_')&&(n[t]=e[t])}),a){const e=Le();Object.keys(e).forEach(t=>{n[t]&&n[t].content&&e[t].sort((e,t)=>t-e).forEach(e=>{n[t].content[e+1]&&n[t].content.splice(e+1,1)})}),Ue({})}const i=Pe().getDB();i&&i.importTableAsJson&&await i.importTableAsJson(JSON.stringify(n)),xe=n,He(n),ye=!1,me=new Set,window.acuModifiedSet&&window.acuModifiedSet.clear(),t||Lt()}catch(e){console.error('Save error:',e),window.toastr&&window.toastr.error('保存出错')}finally{ge=!1,!t&&n.length&&(n.find('i').removeClass('fa-spinner fa-spin').addClass('fa-save'),n.prop('disabled',!1))}},It=async e=>{try{const t={};e.mate?t.mate=e.mate:t.mate={type:'chatSheets',version:1},Object.keys(e).forEach(a=>{a.startsWith('sheet_')&&(t[a]=e[a])});const a=Pe().getDB();a&&a.importTableAsJson&&await a.importTableAsJson(JSON.stringify(t)),xe=t}catch(e){console.error('[ACU] saveDataOnly error:',e)}},Mt=e=>{const t={};if(!e||'object'!=typeof e)return t;for(const a in e)if(e[a]?.name){const n=e[a];t[n.name]={key:a,headers:n.content&&n.content[0]||[],rows:n.content?n.content.slice(1):[],rawContent:n.content||[],exportConfig:n.exportConfig||{},updateConfig:n.updateConfig||{},...n}}return t};const Bt=e=>{const{$}=Pe(),t=`acu-theme-${$t().theme}`,a=xe||zt(),i=Mt(a||{}),o=Object.keys(i),r=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${t}">\n          <div class="acu-settings-header">\n            <div class="acu-settings-title"><i class="fa-solid fa-plus"></i> 添加自定义验证规则</div>\n            <button class="acu-close-btn" id="dlg-rule-close"><i class="fa-solid fa-times"></i></button>\n          </div>\n          <div class="acu-validation-modal-body">\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">规则名称</span></div>\n              <input type="text" id="rule-name" class="acu-panel-input" placeholder="如：物品数量限制" style="flex:1;">\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">目标表格</span></div>\n              <select id="rule-table" class="acu-setting-select">\n                <option value="">请选择...</option>\n                ${o.map(e=>`<option value="${n(e)}">${n(e)}</option>`).join('')}\n              </select>\n            </div>\n            <div class="acu-setting-row" id="row-column">\n              <div class="acu-setting-info"><span class="acu-setting-label">目标列</span></div>\n              <select id="rule-column" class="acu-setting-select" disabled>\n                <option value="">请先选择表格...</option>\n              </select>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">规则类型</span></div>\n              <select id="rule-type" class="acu-setting-select">\n                <optgroup label="── 表级规则 ──">\n                  <option value="tableReadonly">表级只读（禁止修改）</option>\n                  <option value="rowLimit">行数限制</option>\n                  <option value="sequence">序列递增</option>\n                </optgroup>\n                <optgroup label="── 字段级规则 ──">\n                  <option value="required">必填</option>\n                  <option value="format">格式验证（正则）</option>\n                  <option value="enum">枚举验证（可选值）</option>\n                  <option value="numeric">数值范围</option>\n                  <option value="relation">关联验证（引用其他表）</option>\n                  <option value="keyValue">键值对验证</option>\n                </optgroup>\n              </select>\n            </div>\n            \x3c!-- 表级只读无需配置 --\x3e\n            <div class="acu-rule-config-section" id="config-tableReadonly">\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:8px;background:var(--acu-card-bg);border-radius:4px;">\n                <i class="fa-solid fa-info-circle"></i> 启用后，该表将不允许任何修改\n              </div>\n            </div>\n            \x3c!-- 行数限制配置 --\x3e\n            <div class="acu-rule-config-section" id="config-rowLimit" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">最少行数</span></div>\n                <input type="number" id="cfg-row-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">最多行数</span></div>\n                <input type="number" id="cfg-row-max" class="acu-panel-input" placeholder="不限" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- 序列递增配置 --\x3e\n            <div class="acu-rule-config-section" id="config-sequence" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">编码前缀</span></div>\n                <input type="text" id="cfg-sequence-prefix" class="acu-panel-input" placeholder="如：AM" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">起始数字</span></div>\n                <input type="number" id="cfg-sequence-start" class="acu-panel-input" placeholder="1" value="1" style="width:120px;">\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">配对表（可选）</span></div>\n                <select id="cfg-sequence-paired-table" class="acu-setting-select" style="flex:1;">\n                  <option value="">无（单表修复）</option>\n                  ${o.map(e=>`<option value="${n(e)}">${n(e)}</option>`).join('')}\n                </select>\n              </div>\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:8px;background:var(--acu-card-bg);border-radius:4px;margin-top:8px;">\n                <i class="fa-solid fa-info-circle"></i> 检查指定列的值是否从"前缀+起始数字"开始严格递增（如AM001, AM002, AM003...），不可跳号或重复。需要指定目标列。<br>\n                <i class="fa-solid fa-link" style="margin-top:4px;display:block;"></i> 如果设置了配对表，修复时会同时修复两个表的编码，确保相同编码值修复后仍然相同。\n              </div>\n            </div>\n            \x3c!-- 必填无需配置 --\x3e\n            <div class="acu-rule-config-section" id="config-required" style="display:none;">\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:8px;background:var(--acu-card-bg);border-radius:4px;">\n                <i class="fa-solid fa-info-circle"></i> 该字段不能为空\n              </div>\n            </div>\n            \x3c!-- 格式验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-format" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">正则表达式</span></div>\n                <input type="text" id="cfg-pattern" class="acu-panel-input" placeholder="如：^AM\\d{3}$" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- 枚举验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-enum" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">允许的值</span></div>\n                <input type="text" id="cfg-values" class="acu-panel-input" placeholder="用逗号分隔，如：进行中,已完成,已失败" style="flex:1;">\n              </div>\n            </div>\n            \x3c!-- 数值范围配置 --\x3e\n            <div class="acu-rule-config-section" id="config-numeric" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">最小值</span></div>\n                <input type="number" id="cfg-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">最大值</span></div>\n                <input type="number" id="cfg-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n            </div>\n            \x3c!-- 关联验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-relation" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">关联表格</span></div>\n                <select id="cfg-ref-table" class="acu-setting-select">\n                  <option value="">请选择...</option>\n                  ${o.map(e=>`<option value="${n(e)}">${n(e)}</option>`).join('')}\n                </select>\n              </div>\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">关联列</span></div>\n                <select id="cfg-ref-column" class="acu-setting-select" multiple style="flex:1;min-height:80px;">\n                  <option value="">请先选择关联表格...</option>\n                </select>\n              </div>\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:8px;background:var(--acu-card-bg);border-radius:4px;margin-top:8px;">\n                <i class="fa-solid fa-info-circle"></i> 可选择多列，任一列匹配即通过验证（OR 逻辑）。使用 Ctrl/Cmd 键可选择多个列。\n              </div>\n            </div>\n            \x3c!-- 键值对验证配置 --\x3e\n            <div class="acu-rule-config-section" id="config-keyValue" style="display:none;">\n              <div class="acu-setting-row">\n                <div class="acu-setting-info"><span class="acu-setting-label">值类型</span></div>\n                <select id="cfg-keyvalue-type" class="acu-setting-select">\n                  <option value="text">文本型（只验证格式）</option>\n                  <option value="numeric">数值型（验证格式和数值范围）</option>\n                </select>\n              </div>\n              <div class="acu-setting-row" id="row-keyvalue-range" style="display:none;">\n                <div class="acu-setting-info"><span class="acu-setting-label">最小值</span></div>\n                <input type="number" id="cfg-keyvalue-min" class="acu-panel-input" placeholder="0" style="width:80px;">\n                <div class="acu-setting-info" style="margin-left:16px;"><span class="acu-setting-label">最大值</span></div>\n                <input type="number" id="cfg-keyvalue-max" class="acu-panel-input" placeholder="100" style="width:80px;">\n              </div>\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:8px;background:var(--acu-card-bg);border-radius:4px;margin-top:8px;">\n                <i class="fa-solid fa-info-circle"></i> 格式：键:值;键:值（使用英文标点，自动去除空格）。数值型会验证每个值的范围。\n              </div>\n            </div>\n            <div class="acu-setting-row">\n              <div class="acu-setting-info"><span class="acu-setting-label">错误提示</span></div>\n              <input type="text" id="rule-error-msg" class="acu-panel-input" placeholder="验证失败时显示的提示信息" style="flex:1;">\n            </div>\n          </div>\n          <div class="acu-validation-modal-footer">\n            <button class="acu-btn acu-btn-secondary" id="dlg-rule-cancel">取消</button>\n            <button class="acu-btn acu-btn-primary" id="dlg-rule-save">添加</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(r);const c=e=>{const t=e.val();t&&''!==t?(e.css('color','var(--acu-text-main)'),e.css('opacity','1')):(e.css('color','var(--acu-text-sub)'),e.css('opacity','0.7'))};r.find('select').each(function(){c($(this)),$(this).on('change',function(){c($(this))})}),r.find('#rule-table').on('change',function(){const e=$(this).val(),t=r.find('#rule-column'),a=r.find('#cfg-sequence-paired-table');if(c($(this)),a.length>0){const t=a.val();a.empty(),a.append('<option value="">无（单表修复）</option>'),o.filter(t=>t!==e).forEach(e=>{a.append(`<option value="${n(e)}">${n(e)}</option>`)}),t&&t!==e&&a.val(t),c(a)}if(!e||!i[e])return t.html('<option value="">请先选择表格...</option>').prop('disabled',!0),void c(t);const s=(i[e].headers||[]).filter((e,t)=>t>0&&e).map(e=>`<option value="${n(e)}">${n(e)}</option>`).join('');t.html('<option value="">请选择...</option>'+s).prop('disabled',!1),c(t)}),r.find('#cfg-ref-table').on('change',function(){const e=$(this).val(),t=r.find('#cfg-ref-column');if(c($(this)),!e||!i[e])return t.html('<option value="">请先选择关联表格...</option>').prop('disabled',!0),void c(t);const a=(i[e].headers||[]).filter((e,t)=>t>0&&e).map(e=>`<option value="${n(e)}">${n(e)}</option>`).join('');t.html(a).prop('disabled',!1),c(t)}),r.find('#rule-type').on('change',function(){const e=$(this).val(),t=I[e],a='table'===t?.scope;c($(this)),r.find('.acu-rule-config-section').hide(),r.find('#config-'+e).show(),a&&'sequence'!==e?(r.find('#row-column').hide(),r.find('#rule-column').val('').prop('disabled',!0)):(r.find('#row-column').show(),r.find('#rule-table').val()&&r.find('#rule-column').prop('disabled',!1))}),r.find('#cfg-keyvalue-type').on('change',function(){'numeric'===$(this).val()?r.find('#row-keyvalue-range').show():r.find('#row-keyvalue-range').hide()});const s=()=>r.remove();r.on('click','#dlg-rule-close, #dlg-rule-cancel',s),r.on('click',function(e){$(e.target).hasClass('acu-validation-modal-overlay')&&s()}),r.find('#dlg-rule-save').on('click',function(){const t=r.find('#rule-name').val()?.trim(),a=r.find('#rule-table').val(),i=r.find('#rule-column').val(),o=r.find('#rule-type').val(),c=r.find('#rule-error-msg').val()?.trim(),l=I[o],d='table'===l?.scope;if(!t)return void(window.toastr&&window.toastr.warning('请输入规则名称'));if(!a)return void(window.toastr&&window.toastr.warning('请选择目标表格'));if(!(d&&'sequence'!==o||i))return void(window.toastr&&window.toastr.warning('请选择目标列'));const u={};if('tableReadonly'===o);else if('rowLimit'===o){const e=r.find('#cfg-row-min').val(),t=r.find('#cfg-row-max').val();''!==e&&(u.min=parseInt(e,10)),''!==t&&(u.max=parseInt(t,10))}else if('required'===o);else if('format'===o){const e=r.find('#cfg-pattern').val()?.trim();if(!e)return void(window.toastr&&window.toastr.warning('请输入正则表达式'));try{new RegExp(e)}catch(e){return void(window.toastr&&window.toastr.error('正则表达式无效'))}u.pattern=e}else if('enum'===o){const e=r.find('#cfg-values').val()?.trim();if(!e)return void(window.toastr&&window.toastr.warning('请输入允许的值'));u.values=e.split(',').map(e=>e.trim()).filter(e=>e)}else if('numeric'===o){const e=r.find('#cfg-min').val(),t=r.find('#cfg-max').val();''!==e&&(u.min=parseFloat(e)),''!==t&&(u.max=parseFloat(t))}else if('relation'===o){const e=r.find('#cfg-ref-table').val(),t=r.find('#cfg-ref-column').val();if(!e)return void(window.toastr&&window.toastr.warning('请选择关联表格'));const a=Array.isArray(t)?t:t?[t]:[];if(0===a.length||1===a.length&&!a[0])return void(window.toastr&&window.toastr.warning('请至少选择一列作为关联列'));u.refTable=e,u.refColumn=1===a.length?a[0]:a}else if('keyValue'===o){const e=r.find('#cfg-keyvalue-type').val();if(u.valueType=e||'text','numeric'===e){const e=r.find('#cfg-keyvalue-min').val(),t=r.find('#cfg-keyvalue-max').val();''!==e&&(u.valueMin=parseFloat(e)),''!==t&&(u.valueMax=parseFloat(t))}}else if('sequence'===o){const e=r.find('#cfg-sequence-prefix').val()?.trim()||'',t=r.find('#cfg-sequence-start').val(),a=r.find('#cfg-sequence-paired-table').val()?.trim()||null;if(u.prefix=e,u.startFrom=''!==t?parseInt(t,10):1,isNaN(u.startFrom))return void(window.toastr&&window.toastr.warning('起始数字必须是有效数字'));a&&(u.pairedTable=a)}const p='custom_'+Date.now()+'_'+Math.random().toString(36).substr(2,6),g={id:p,name:t,description:'',targetTable:a,targetColumn:d&&'sequence'!==o?'':i,ruleType:o,config:u,errorMessage:c||l?.desc||'数据验证失败',intercept:!1};if(N.addCustomRule(g)){s();const r=e.find('#validation-rules-list'),c=`\n          <div class="acu-validation-rule-item" data-rule-id="${n(p)}">\n            <div class="acu-rule-type-icon" title="${n(l?.name||o)}${d?' (表级)':''}">\n              <i class="fa-solid ${l?.icon||'fa-question'}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${n(t)}</div>\n              <div class="acu-rule-target">${n(a)}${d&&'sequence'!==o?' (整表)':'.'+n(i)}</div>\n            </div>\n            <div class="acu-rule-intercept" data-rule-id="${n(p)}" title="点击启用拦截（违反时回滚）"><i class="fa-solid fa-shield-halved"></i></div>\n            <div class="acu-rule-toggle active" title="点击切换启用/禁用">\n              <i class="fa-solid fa-toggle-on"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${n(p)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n          </div>\n        `;r.append(c)}else window.toastr&&window.toastr.error('规则添加失败')})},Et=e=>{if(!e||!e.rule)return void(window.toastr&&window.toastr.warning('无法获取规则信息'));const{$}=Pe(),t=`acu-theme-${$t().theme}`,a=e.rule,i=e.ruleType||a.ruleType,o=I[i]||{name:i,icon:'fa-question'},r='table'===o?.scope,c=xe||zt(),s=Je();let l='';if(!r&&s&&e.tableName&&void 0!==e.columnName)for(const t in s)if(s[t]?.name===e.tableName){const a=(s[t].content?.[0]||[]).indexOf(e.columnName),n=e.rowIndex+1;a>=0&&s[t].content?.[n]&&(l=s[t].content[n][a]??'');break}const d=''!==l&&String(l)!==String(e.currentValue||'');if(r)return void jt(e,a,i,c,s,t);let u='';u=('enum'===i&&a.config?.values||'relation'===i&&a.config?.refTable&&a.config?.refColumn||'numeric'===i||'format'===i&&a.config,`<textarea id="smart-fix-value" class="acu-edit-textarea" spellcheck="false"\n        style="width:100%;min-height:60px;max-height:200px;resize:none;">${n(e.currentValue||'')}</textarea>`);let p='';if('required'===i){const t=function(e,t,a,n,i=5){const o=new Set;if(!e||!t||!n)return[];for(const i in n)if(n[i]?.name===e){const e=n[i].content?.[0]||[],r=n[i].content?.slice(1)||[],c=e.indexOf(t);c>=0&&r.forEach((e,t)=>{if(t!==a){const t=e?.[c];null!=t&&''!==String(t).trim()&&o.add(String(t).trim())}});break}return Array.from(o).slice(0,i)}(e.tableName,e.columnName,e.rowIndex,c,5);t.length>0&&(p=`\n          <div class="acu-smart-fix-suggest">\n            <div class="acu-smart-fix-suggest-label">\n              <i class="fa-solid fa-lightbulb"></i> 同列示例值:\n            </div>\n            <div class="acu-smart-fix-suggest-options">\n              ${t.map(e=>`\n                <span class="acu-smart-fix-option" data-value="${n(e)}" title="点击填充">\n                  ${n(e.length>20?e.substring(0,20)+'...':e)}\n                </span>\n              `).join('')}\n            </div>\n          </div>\n        `)}else if('enum'===i&&a.config?.values){p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-list"></i> 允许的值 (点击选择):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll">\n            ${a.config.values.map(t=>`\n              <span class="acu-smart-fix-option ${e.currentValue===t?'acu-smart-fix-option-current':''}"\n                    data-value="${n(t)}" title="${e.currentValue===t?'当前值（无效）':'点击选择'}">\n                ${n(t)}\n              </span>\n            `).join('')}\n          </div>\n        </div>\n      `}else if('format'===i&&a.config?.pattern){let t=null;if(c&&e.tableName)for(const a in c)if(c[a]?.name===e.tableName){t=c[a];break}const i=function(e,t,a=[],n=null){if(!e||void 0===t||t<0)return null;try{const a=e.match(/^\^?([A-Za-z]+)\\d\{(\d+)\}\$?$/);if(a){const e=a[1],i=parseInt(a[2],10);if(n&&('总结表'===n.name||'总体大纲'===n.name)){const t=n.content?.[0]||[],a=n.content?.slice(1)||[],o=t.indexOf('编码索引');if(o>=0){const t=[];a.forEach(a=>{const n=a?.[o];if(n&&'string'==typeof n){const a=n.match(new RegExp(`^${e}(\\d+)$`));if(a){const e=parseInt(a[1],10);isNaN(e)||t.push(e)}}});const n=t.length>0?Math.max(...t):0,r=String(n+1).padStart(i,'0');return e+r}}const o=String(t+1).padStart(i,'0');return e+o}const i=e.match(/^\^?\\d\{(\d+)\}\$?$/);if(i){const e=parseInt(i[1],10);return String(t+1).padStart(e,'0')}}catch(e){console.error('[ACU] 格式推算失败:',e)}return null}(a.config.pattern,e.rowIndex,[],t);p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-font"></i> 格式要求: <code>${n(a.config.pattern)}</code>\n          </div>\n          ${i?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-suggest-label" style="margin-bottom:4px;display:block;">\n                <i class="fa-solid fa-lightbulb"></i> 推荐值:\n              </span>\n              <span class="acu-smart-fix-quick-btn" data-value="${n(i)}">\n                <i class="fa-solid fa-magic"></i> ${n(i)}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('numeric'===i){const t=a.config?.min,n=a.config?.max,i=parseFloat(e.currentValue),o=!isNaN(i)&&(void 0!==t&&i<t||void 0!==n&&i>n),r=o?function(e,t,a){const n=parseFloat(e);return isNaN(n)?void 0!==t?t:0:void 0!==t&&n<t?t:void 0!==a&&n>a?a:n}(e.currentValue,t,n):null;p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-hashtag"></i> 允许范围: ${void 0!==t?t:'-∞'} ~ ${void 0!==n?n:'+∞'}\n          </div>\n          ${o&&null!==r?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${r}">\n                <i class="fa-solid fa-arrow-right"></i> 修正为 ${r}\n              </span>\n            </div>\n          `:''}\n        </div>\n      `}else if('relation'===i&&a.config?.refTable&&a.config?.refColumn){const t=function(e,t,a){const n=new Set;if(!e||!t||!a)return Array.from(n);const i=Array.isArray(t)?t:[t];for(const t in a)if(a[t]?.name===e){const e=a[t].content?.[0]||[],o=a[t].content?.slice(1)||[];i.forEach(t=>{const a=e.indexOf(t);a>=0&&o.forEach(e=>{const t=e?.[a];null!=t&&''!==String(t).trim()&&n.add(String(t).trim())})});break}return Array.from(n).sort()}(a.config.refTable,a.config.refColumn,c),i=Array.isArray(a.config.refColumn)?a.config.refColumn:[a.config.refColumn],o=i.length>1,r=String(e.currentValue||'').trim(),s=function(e,t,a,n){if(!(e&&t&&a&&n))return!1;if(''===String(e).trim())return!1;const i=Array.isArray(a)?a:[a],o=String(e).trim();for(const e in n)if(n[e]?.name===t){const t=n[e].content?.[0]||[],a=n[e].content?.slice(1)||[];for(const e of i){const n=t.indexOf(e);if(-1!==n)for(let e=0;e<a.length;e++){const t=a[e]?.[n];if(null!=t&&String(t).trim()===o)return!0}}break}return!1}(r,a.config.refTable,a.config.refColumn,c);let l='';t.length>0&&(l=`\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-link"></i> 关联表 "${n(a.config.refTable)}" 可用值 (${t.length}项):\n          </div>\n          <div class="acu-smart-fix-suggest-options acu-smart-fix-suggest-options-scroll" id="smart-fix-options-container">\n            ${t.map(t=>`\n              <span class="acu-smart-fix-option ${e.currentValue===t?'acu-smart-fix-option-current':''}"\n                    data-value="${n(t)}" title="${e.currentValue===t?'当前值（无效）':'点击选择'}">\n                ${n(t)}\n              </span>\n            `).join('')}\n          </div>\n        `);let d='';r&&!s&&(d=o?`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> 反向写入到关联表:\n              </div>\n              <div style="margin-top:8px;">\n                <select id="smart-fix-reverse-column" class="acu-edit-select" style="width:100%;margin-bottom:8px;">\n                  ${i.map(e=>`<option value="${n(e)}">${n(e)}</option>`).join('')}\n                </select>\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> 将 "${n(r.length>30?r.substring(0,30)+'...':r)}" 写入到 "${n(a.config.refTable)}"\n                </button>\n              </div>\n            </div>\n          `:`\n            <div class="acu-smart-fix-reverse-write" style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-arrow-left"></i> 反向写入到关联表:\n              </div>\n              <div style="margin-top:8px;">\n                <button class="acu-smart-fix-quick-btn" id="smart-fix-reverse-write-btn" data-column="${n(i[0])}" style="width:100%;">\n                  <i class="fa-solid fa-plus"></i> 将 "${n(r.length>30?r.substring(0,30)+'...':r)}" 写入到 "${n(a.config.refTable)}.${n(i[0])}"\n                </button>\n              </div>\n            </div>\n          `),(l||d)&&(p=`\n          <div class="acu-smart-fix-suggest">\n            ${l}\n            ${d}\n          </div>\n        `)}else if('keyValue'===i){const t=a.config?.valueType||'text',i=a.config?.valueMin,o=a.config?.valueMax;let r=String(e.currentValue||'');r=r.replace(/：/g,':').replace(/；/g,';').replace(/，/g,';').replace(/\s+/g,'');const c=r.split(';').filter(e=>e.trim()),s=[],l=[];for(const e of c){const a=e.indexOf(':');if(-1===a||0===a||a===e.length-1){s.push({pair:e,error:'格式错误：缺少冒号或键/值为空'});continue}const n=e.substring(0,a),r=e.substring(a+1);if(!n||!r){s.push({pair:e,error:'键或值不能为空'});continue}let c=r,d=!1;if('numeric'===t){const t=parseFloat(r);isNaN(t)?(s.push({pair:e,error:`"${r}" 不是有效数字`}),d=!0):null!=i&&t<i?(c=String(i),s.push({pair:e,error:`数值 ${t} 小于最小值 ${i}`}),d=!0):null!=o&&t>o&&(c=String(o),s.push({pair:e,error:`数值 ${t} 大于最大值 ${o}`}),d=!0)}l.push({key:n,val:c,originalVal:r,hasIssue:d})}const d=l.map(e=>`${e.key}:${e.val}`).join(';'),u=s.length>0||l.some(e=>e.hasIssue);let g='';u&&(g=`\n          <div class="acu-smart-fix-suggest-label" style="margin-bottom:8px;">\n            <i class="fa-solid fa-exclamation-triangle"></i> 问题列表:\n          </div>\n          <div style="margin-bottom:8px;">\n            ${s.map(e=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">❌</span> ${n(e.pair)} - ${n(e.error)}\n              </div>\n            `).join('')}\n            ${l.filter(e=>e.hasIssue).map(e=>`\n              <div style="font-size:11px;color:var(--acu-text-sub);padding:4px 8px;background:var(--acu-card-bg);border-radius:4px;margin-bottom:4px;">\n                <span style="color:var(--acu-hl-manual);">⚠️</span> ${n(e.key)}:${n(e.originalVal)} → ${n(e.val)}\n              </div>\n            `).join('')}\n          </div>\n        `),p=`\n        <div class="acu-smart-fix-suggest">\n          <div class="acu-smart-fix-suggest-label">\n            <i class="fa-solid fa-key"></i> 格式要求: 键:值;键:值（使用英文标点，自动去除空格）\n          </div>\n          ${'numeric'===t?`\n            <div class="acu-smart-fix-suggest-label" style="margin-top:8px;">\n              <i class="fa-solid fa-hashtag"></i> 数值范围: ${void 0!==i?i:'-∞'} ~ ${void 0!==o?o:'+∞'}\n            </div>\n          `:''}\n          ${g}\n          ${u?`\n            <div style="margin-top:8px;">\n              <span class="acu-smart-fix-quick-btn" data-value="${n(d)}">\n                <i class="fa-solid fa-magic"></i> 一键修正所有问题\n              </span>\n            </div>\n            <div style="margin-top:8px;padding:8px;background:var(--acu-card-bg);border-radius:4px;font-size:11px;color:var(--acu-text-sub);">\n              <div style="margin-bottom:4px;"><strong>修正后预览:</strong></div>\n              <code style="color:var(--acu-success-text);">${n(d)}</code>\n            </div>\n          `:'\n            <div style="margin-top:8px;padding:8px;background:var(--acu-success-bg);border-radius:4px;font-size:11px;color:var(--acu-success-text);">\n              <i class="fa-solid fa-check-circle"></i> 格式正确\n            </div>\n          '}\n        </div>\n      `}const g=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${t}" style="max-width:450px;">\n          <div class="acu-edit-title">智能修改: ${n(e.tableName||'')} - ${n(e.columnName||'')}</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            \x3c!-- 规则说明 --\x3e\n            <div class="acu-smart-fix-rule-info">\n              <div class="acu-smart-fix-rule-header">\n                <i class="fa-solid ${o.icon}"></i>\n                <span>${n(e.ruleName||a.name||'')}</span>\n              </div>\n              <div class="acu-smart-fix-rule-desc">${n(e.errorMessage||a.errorMessage||o.desc||'')}</div>\n            </div>\n\n            \x3c!-- 快照值（只读） --\x3e\n            ${d?`\n              <div class="acu-diff-section acu-diff-old-section">\n                <div class="acu-diff-label">\n                  <i class="fa-solid fa-clock-rotate-left"></i> 快照值（原始）\n                </div>\n                <div class="acu-diff-readonly">${n(l)}</div>\n              </div>\n              <div class="acu-diff-arrow-down"><i class="fa-solid fa-arrow-down"></i></div>\n            `:''}\n\n            \x3c!-- 当前值（可编辑） --\x3e\n            <div class="acu-diff-section acu-diff-new-section">\n              <div class="acu-diff-label">\n                <i class="fa-solid fa-pen"></i> 当前值（可编辑）\n              </div>\n              ${u}\n            </div>\n\n            \x3c!-- 智能建议 --\x3e\n            ${p?`\n              <div class="acu-smart-fix-suggest-section">\n                ${p}\n              </div>\n            `:''}\n          </div>\n          <div class="acu-dialog-btns">\n            <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n            ${d?'<button class="acu-dialog-btn acu-btn-revert" id="smart-fix-revert"><i class="fa-solid fa-rotate-left"></i> 恢复快照值</button>':''}\n            <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-confirm"><i class="fa-solid fa-check"></i> 保存</button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(g),g.on('click','.acu-smart-fix-option, .acu-smart-fix-quick-btn',function(){if('smart-fix-reverse-write-btn'===$(this).attr('id'))return;if($(this).hasClass('acu-smart-fix-option-current'))return;const e=$(this).data('value')||$(this).text().trim();g.find('#smart-fix-value').val(e).trigger('input')}),g.on('click','#smart-fix-reverse-write-btn',async function(){const t=String(e.currentValue||'').trim();if(!t)return void(window.toastr&&window.toastr.warning('无法写入空值'));let n;if('relation'===i&&a.config?.refColumn){{const e=Array.isArray(a.config.refColumn)?a.config.refColumn:[a.config.refColumn];n=e.length>1?g.find('#smart-fix-reverse-column').val():$(this).data('column')||e[0]}if(n&&a.config?.refTable)try{const e=xe||zt();let i=null,o=null;for(const t in e)if(e[t]?.name===a.config.refTable){i=e[t],o=t;break}if(!i||!i.content)return void(window.toastr&&window.toastr.error(`找不到关联表 "${a.config.refTable}"`));const r=i.content[0]||[],c=r.indexOf(n);if(-1===c)return void(window.toastr&&window.toastr.error(`关联表中不存在列 "${n}"`));const s=new Array(r.length).fill('');s[c]=t,i.content.push(s),await At(e,!1,!1),window.toastr&&window.toastr.success(`已将 "${t}" 写入到 "${a.config.refTable}.${n}"`),f(),Lt()}catch(e){console.error('[ACU] 反向写入失败:',e),window.toastr&&window.toastr.error('反向写入失败: '+(e.message||'未知错误'))}else window.toastr&&window.toastr.error('无法确定目标表或列')}else window.toastr&&window.toastr.error('无法确定目标列')}),g.on('click','#smart-fix-revert',function(){g.find('#smart-fix-value').val(l)});const f=()=>g.remove();g.on('click','#smart-fix-close, #smart-fix-cancel',f),g.on('click',function(e){$(e.target).hasClass('acu-validation-modal-overlay')&&f()}),g.find('#smart-fix-confirm').on('click',async function(){const t=g.find('#smart-fix-value').val()?.trim()||'';if(''!==t||'required'!==i)try{const a=xe||zt();let n=!1;for(const i in a)if(a[i]?.name===e.tableName){const o=a[i],r=o.content?.[0]||[];if(e.rowIndex>=0&&e.columnName){const a=r.indexOf(e.columnName),i=e.rowIndex+1;if(a>=0&&o.content&&o.content[i]){o.content[i][a]=t,n=!0;break}}}n?(await At(a,!1,!1),f(),Lt()):window.toastr&&window.toastr.error('无法找到目标单元格')}catch(e){console.error('[ACU] 更新单元格失败:',e),window.toastr&&window.toastr.error('更新失败: '+(e.message||'未知错误'))}else window.toastr&&window.toastr.warning('必填字段不能为空')})};function Pt(e,t,a){if(!e||!e.content||e.content.length<2)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const n=e.content[0]||[],i=e.content.slice(1)||[],o=n.indexOf(t);if(o<0)return{codes:new Map,allCodes:new Set,codeToRows:new Map};const r=new Map,c=new Set,s=new Map;for(let e=0;e<i.length;e++){const t=i[e]?.[o];if(null==t||''===t)continue;const n=String(t).trim();if(!n)continue;let r=!1;if(a){n.match(new RegExp(`^${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(r=!0)}else{const e=parseInt(n,10);isNaN(e)||(r=!0)}r&&(c.add(n),s.has(n)||s.set(n,[]),s.get(n).push(e))}return{codes:r,allCodes:c,codeToRows:s}}function Nt(e,t,a,n){const i=new Set([...e,...t]),o=[];for(const e of i){let t=null;if(a){const n=e.match(new RegExp(`^${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));n&&(t=parseInt(n[1],10))}else t=parseInt(e,10);isNaN(t)||o.push({code:e,num:t})}o.sort((e,t)=>e.num-t.num);const r=new Map;for(let e=0;e<o.length;e++){const t=o[e].code,i=a+String(n+e).padStart(3,'0');r.set(t,i)}return r}function Dt(e,t,a,n,i,o,r,c,s){if(!e||!a)return{fixedCount1:0,fixedCount2:0};const l=e.content[0]||[],d=e.content.slice(1)||[],u=l.indexOf(i),p=a.content[0]||[],g=a.content.slice(1)||[],f=p.indexOf(i);if(u<0||f<0)return{fixedCount1:0,fixedCount2:0};let b=0,m=0;const h=new Map;for(const[e,t]of o.entries())h.set(t,e);const v=Array.from(o.values()).sort((e,t)=>parseInt(e.replace(r,''),10)-parseInt(t.replace(r,''),10)),x=(e,t)=>{const a=[],n=[];for(let i=0;i<e.length;i++){const o=e[i]?.[t],c=null==o?'':String(o).trim();let s=!1;if(c&&r){c.match(new RegExp(`^${r.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`))&&(s=!0)}else if(c){const e=parseInt(c,10);isNaN(e)||(s=!0)}s?a.push({rowIndex:i,oldCode:c,row:e[i]}):n.push({rowIndex:i,row:e[i],prevOldCode:null,nextOldCode:null})}for(const e of n){let t=null,n=null;for(const i of a)if(i.rowIndex<e.rowIndex&&(t=i.oldCode),i.rowIndex>e.rowIndex&&null===n){n=i.oldCode;break}e.prevOldCode=t,e.nextOldCode=n}return{codeRows:a,emptyRows:n}},y=x(d,u),w=x(g,f),k=(e,t,a,n)=>{const i=[],r=new Map;for(const t of e.codeRows)r.set(t.oldCode,t.row);for(const e of v){const n=h.get(e);if(r.has(n)){const t=r.get(n).map(e=>e);t[a]=e,i.push({newCode:e,row:t,isCodeRow:!0})}else{const n=new Array(t.length).fill(null);n[a]=e,i.push({newCode:e,row:n,isCodeRow:!0,isInserted:!0})}}const c=[];let s=0;for(const t of e.emptyRows)if(null===t.prevOldCode&&null!==t.nextOldCode){const e=o.get(t.nextOldCode);for(;s<i.length&&i[s].newCode!==e;)c.push(i[s].row),s++;c.push(t.row)}else null===t.prevOldCode&&null===t.nextOldCode&&c.push(t.row);for(;s<i.length;s++){c.push(i[s].row);const t=i[s].newCode,a=h.get(t);for(const t of e.emptyRows)t.prevOldCode===a&&c.push(t.row)}for(const t of e.emptyRows)null!==t.prevOldCode&&t.nextOldCode;return c},C=k(y,l,u,new Set(y.codeRows.map(e=>e.oldCode))),S=k(w,p,f,new Set(w.codeRows.map(e=>e.oldCode))),T=(e,t,a)=>{let n=0;const i=new Set(e.codeRows.map(e=>e.oldCode)),r=new Set;for(const e of t){const t=e[a];t&&r.add(t)}for(const[e,t]of o.entries())i.has(e)&&e!==t&&n++;for(const e of v){const t=h.get(e);i.has(t)||n++}return n};return b=T(y,C,u),m=T(w,S,f),e.content=[l,...C],a.content=[p,...S],{fixedCount1:b,fixedCount2:m}}const jt=(e,t,a,i,o,r)=>{const{$}=Pe();let c='',s='';if('tableReadonly'===a){let t=0,a=[];if(o&&i)for(const n in i)if(i[n]?.name===e.tableName&&o[n]){const e=i[n].content?.slice(1)||[],r=o[n].content?.slice(1)||[];if(e.forEach((e,n)=>{const i=r[n];if(i){for(let o=0;o<e.length;o++)if(String(e[o]||'')!==String(i[o]||'')){a.push(`第${n+1}行: 有修改`),t++;break}}else a.push(`第${n+1}行: 新增`),t++}),r.length>e.length)for(let n=e.length;n<r.length;n++)a.push(`第${n+1}行: 已删除`),t++;break}c=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-lock"></i>\n            <span>表只读保护</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">此表被设置为只读，但检测到有修改。</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            检测到 <strong>${t}</strong> 处修改\n          </div>\n          ${a.length>0?`\n            <div class="acu-smart-fix-change-list">\n              ${a.slice(0,10).map(e=>`<div class="acu-smart-fix-change-item">${n(e)}</div>`).join('')}\n              ${a.length>10?`<div class="acu-smart-fix-change-item">... 还有 ${a.length-10} 处</div>`:''}\n            </div>\n          `:''}\n        </div>\n      `,s='\n        <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n        <button class="acu-dialog-btn acu-btn-revert" id="smart-fix-restore-table"><i class="fa-solid fa-rotate-left"></i> 恢复整表</button>\n      '}else if('rowLimit'===a){const a=t.config?.min,o=t.config?.max;let r=0,l=[];for(const t in i)if(i[t]?.name===e.tableName){r=(i[t].content?.length||1)-1;break}const d=void 0!==o&&r>o,u=void 0!==a&&r<a;if(d)for(let e=o+1;e<=r;e++)l.push(e);c=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-arrows-up-down"></i>\n            <span>行数限制</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${n(e.errorMessage||t.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            当前行数: <strong>${r}</strong> 行\n            ${void 0!==a||void 0!==o?` | 限制: ${void 0!==a?a:0} ~ ${void 0!==o?o:'∞'} 行`:''}\n          </div>\n          ${d&&l.length>0?`\n            <div class="acu-smart-fix-excess-rows">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-trash"></i> 需删除的行 (第 ${l[0]} 行及之后):\n              </div>\n              <div class="acu-smart-fix-change-list">\n                ${l.slice(0,10).map(e=>`<div class="acu-smart-fix-change-item">第 ${e} 行</div>`).join('')}\n                ${l.length>10?`<div class="acu-smart-fix-change-item">... 共 ${l.length} 行</div>`:''}\n              </div>\n            </div>\n          `:''}\n          ${u?`\n            <div class="acu-smart-fix-hint">\n              <i class="fa-solid fa-info-circle"></i> 需要添加 ${a-r} 行才能满足最小行数要求\n            </div>\n          `:''}\n        </div>\n      `,s=d&&l.length>0?`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-delete-rows" data-start="${o}" data-table="${n(e.tableName)}">\n            <i class="fa-solid fa-trash"></i> 删除多余的 ${l.length} 行\n          </button>\n        `:'<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 关闭</button>'}else if('sequence'===a&&t.targetColumn){const a=t.config?.prefix||'',o=void 0!==t.config?.startFrom?t.config?.startFrom:1;let r=null,l=[],d=[];for(const t in i)if(i[t]?.name===e.tableName){r=i[t];break}if(r&&r.content&&r.content.length>1){const e=r.content[0]||[],n=r.content.slice(1)||[],i=e.indexOf(t.targetColumn);if(i>=0){const e=[];for(let t=0;t<n.length;t++){const o=n[t]?.[i];if(null==o||''===o)continue;const r=String(o).trim();if(!r)continue;let c=null;if(a){const e=r.match(new RegExp(`^${a.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));e&&(c=parseInt(e[1],10))}else c=parseInt(r,10);isNaN(c)||e.push({rowIndex:t,value:r,num:c,originalRowIndex:t+2})}e.sort((e,t)=>e.rowIndex-t.rowIndex);const t=new Map,r=[],c=[],s=[];for(let a=0;a<e.length;a++){const n=e[a].num;t.has(n)||t.set(n,[]),t.get(n).push(a)}for(let a=0;a<e.length;a++){const n=o+a,i=e[a].num,l=e[a].originalRowIndex,d=t.get(i)||[];d.length>1&&d[0]===a&&r.push({rowNum:l,value:e[a].value,num:i,expectedNum:n,count:d.length}),i!==n&&(i<n?s.push({rowNum:l,value:e[a].value,num:i,expectedNum:n}):c.push({rowNum:l,value:e[a].value,num:i,expectedNum:n}))}for(let t=0;t<e.length;t++){const n=o+t,i=e[t].num,c=e[t].originalRowIndex,s=e[t].value,l=a+String(n).padStart(3,'0');(i!==n||r.some(e=>e.num===i&&e.rowNum===c))&&d.push({rowNum:c,currentValue:s,fixedValue:l,reason:i<n?'重复或顺序错误':i>n?'跳号':'重复'})}const u=new Set;r.forEach(e=>{u.add(`第${e.rowNum}行: "${e.value}" 重复 (出现${e.count}次)`)}),c.forEach(e=>{u.add(`第${e.rowNum}行: "${e.value}" 应为 "${a}${String(e.expectedNum).padStart(3,'0')}" (跳号)`)}),s.forEach(e=>{u.add(`第${e.rowNum}行: "${e.value}" 应为 "${a}${String(e.expectedNum).padStart(3,'0')}" (顺序错误)`)}),l=Array.from(u)}}if(c=`\n        <div class="acu-smart-fix-rule-info">\n          <div class="acu-smart-fix-rule-header">\n            <i class="fa-solid fa-sort-numeric-up"></i>\n            <span>序列递增验证</span>\n          </div>\n          <div class="acu-smart-fix-rule-desc">${n(e.errorMessage||t.errorMessage||'')}</div>\n        </div>\n        <div class="acu-smart-fix-table-summary">\n          <div class="acu-smart-fix-stat">\n            <i class="fa-solid fa-exclamation-triangle"></i>\n            检测到 <strong>${l.length}</strong> 个问题\n          </div>\n          ${l.length>0?`\n            <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n              ${l.slice(0,20).map(e=>`<div class="acu-smart-fix-change-item">${n(e)}</div>`).join('')}\n              ${l.length>20?`<div class="acu-smart-fix-change-item">... 还有 ${l.length-20} 个问题</div>`:''}\n            </div>\n          `:''}\n          ${d.length>0?`\n            <div class="acu-smart-fix-suggest" style="margin-top:12px;">\n              <div class="acu-smart-fix-suggest-label">\n                <i class="fa-solid fa-lightbulb"></i> 修复建议:\n              </div>\n              <div class="acu-smart-fix-change-list" style="max-height:200px;overflow-y:auto;margin-top:8px;">\n                ${d.slice(0,20).map(e=>`\n                  <div class="acu-smart-fix-change-item">\n                    <span style="color:var(--acu-text-sub);">第${e.rowNum}行:</span>\n                    <span style="color:var(--acu-hl-manual);">${n(e.currentValue)}</span>\n                    <span style="color:var(--acu-text-sub);"> → </span>\n                    <span style="color:var(--acu-hl-auto);">${n(e.fixedValue)}</span>\n                    <span style="color:var(--acu-text-sub);font-size:11px;"> (${n(e.reason)})</span>\n                  </div>\n                `).join('')}\n                ${d.length>20?`<div class="acu-smart-fix-change-item">... 还有 ${d.length-20} 处需要修复</div>`:''}\n              </div>\n            </div>\n          `:''}\n        </div>\n      `,d.length>0){const i=t.config?.pairedTable||('总结表'===e.tableName?'总体大纲':'总体大纲'===e.tableName?'总结表':null),r=i?`data-paired-table="${n(i)}"`:'';s=`\n          <button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n          <button class="acu-dialog-btn acu-btn-confirm" id="smart-fix-fix-sequence" data-table="${n(e.tableName)}" data-column="${n(t.targetColumn)}" data-prefix="${n(a)}" data-start="${o}" ${r}>\n            <i class="fa-solid fa-magic"></i> 自动修复 ${d.length} 处\n          </button>\n        `}else s='<button class="acu-dialog-btn" id="smart-fix-cancel"><i class="fa-solid fa-times"></i> 关闭</button>'}const l=$(`\n      <div class="acu-edit-overlay acu-validation-modal-overlay">\n        <div class="acu-edit-dialog acu-validation-modal ${r}" style="max-width:450px;">\n          <div class="acu-edit-title">智能修改: ${n(e.tableName||'')} (表级规则)</div>\n          <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n            ${c}\n          </div>\n          <div class="acu-dialog-btns">\n            ${s}\n          </div>\n        </div>\n      </div>\n    `);$('body').append(l);const d=()=>l.remove();l.on('click','#smart-fix-cancel',d),l.on('click',function(e){$(e.target).hasClass('acu-validation-modal-overlay')&&d()}),l.on('click','#smart-fix-restore-table',async function(){if(o)try{for(const t in i)if(i[t]?.name===e.tableName&&o[t]){i[t]=JSON.parse(JSON.stringify(o[t]));break}await At(i,!1,!1),d(),Lt()}catch(e){console.error('[ACU] 恢复表失败:',e),window.toastr&&window.toastr.error('恢复失败: '+(e.message||'未知错误'))}else window.toastr&&window.toastr.warning('无快照数据')}),l.on('click','#smart-fix-fix-sequence',async function(){const e=$(this),t=e.data('table'),a=e.data('column'),n=e.data('prefix')||'',o=parseInt(e.data('start')||'1',10),r=e.data('paired-table')||null;try{e.prop('disabled',!0).html('<i class="fa-solid fa-spinner fa-spin"></i> 修复中...');let c=null,s=null;for(const e in i)if(i[e]?.name===t){c=i[e],s=e;break}if(!c||!c.content||c.content.length<2)return window.toastr&&window.toastr.warning('未找到目标表'),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');const l=c.content[0]||[],u=c.content.slice(1)||[],p=l.indexOf(a);if(p<0)return window.toastr&&window.toastr.warning('未找到目标列'),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');if(r){let s=null,l=null;for(const e in i)if(i[e]?.name===r){s=i[e],l=e;break}if(!s||!s.content||s.content.length<1)return window.toastr&&window.toastr.warning(`未找到配对表: ${r}`),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');const u=s.content[0]||[];if(u.indexOf(a)<0)return window.toastr&&window.toastr.warning(`配对表中未找到目标列: ${a}`),void e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复');const p=Pt(c,a,n),g=Pt(s,a,n),f=Nt(p.allCodes,g.allCodes,n,o),{fixedCount1:b,fixedCount2:m}=Dt(c,0,s,0,a,f,n);await At(i,!1,!1),d(),Lt(),window.toastr&&window.toastr.success(`已修复 ${t} ${b} 处，${r} ${m} 处序列递增问题`)}else{const e=[];for(let t=0;t<u.length;t++){const a=u[t]?.[p];if(null==a||''===a)continue;const i=String(a).trim();if(!i)continue;let o=null;if(n){const e=i.match(new RegExp(`^${n.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));e&&(o=parseInt(e[1],10))}else o=parseInt(i,10);isNaN(o)||e.push({rowIndex:t,value:i,num:o})}e.sort((e,t)=>e.rowIndex-t.rowIndex);let t=0;for(let a=0;a<e.length;a++){const i=o+a,r=e[a].num,c=e[a].rowIndex;if(r!==i){const e=n+String(i).padStart(3,'0');u[c][p]=e,t++}}await At(i,!1,!1),d(),Lt(),window.toastr&&window.toastr.success(`已修复 ${t} 处序列递增问题`)}}catch(t){console.error('[ACU] 修复序列递增失败:',t),window.toastr&&window.toastr.error('修复失败: '+(t.message||'未知错误')),e.prop('disabled',!1).html('<i class="fa-solid fa-magic"></i> 自动修复')}}),l.on('click','#smart-fix-delete-rows',async function(){const e=parseInt($(this).data('start'),10),t=$(this).data('table');try{for(const a in i)if(i[a]?.name===t){i[a].content=i[a].content.slice(0,e+1);break}await At(i,!1,!1),d(),Lt()}catch(e){console.error('[ACU] 删除行失败:',e),window.toastr&&window.toastr.error('删除失败: '+(e.message||'未知错误'))}})},Ft=()=>{const{$}=Pe();$('.acu-edit-overlay').remove();const e=$t(),t=ae(),a=W.getAllPresets(),i=Fe.get(C,null),o=null===i,r=`\n      <div class="acu-preset-item" data-id="__default__">\n        <div class="acu-preset-info">\n          <div class="acu-preset-name">\n            六维属性百分制\n            <span style="font-size: 10px; color: ${t.textSub}; margin-left: 6px;">(默认)</span>\n          </div>\n          <div class="acu-preset-desc">使用百分制生成六维基础属性（力量、敏捷、体质、智力、感知、魅力），范围5-95</div>\n          <div class="acu-preset-stats">\n            基础属性: 6 | 特别属性: 0\n          </div>\n        </div>\n        <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n          <label class="acu-toggle" style="margin: 0;">\n            <input type="checkbox" class="acu-preset-toggle" data-id="__default__" ${o?'checked':''}>\n            <span class="acu-toggle-slider"></span>\n          </label>\n        </div>\n      </div>\n    `+a.map(e=>{const a=e.id===i,o=e.builtin;return`\n        <div class="acu-preset-item" data-id="${e.id}">\n          <div class="acu-preset-info">\n            <div class="acu-preset-name">\n              ${n(e.name)}\n              ${o?`<span style="font-size: 10px; color: ${t.textSub}; margin-left: 6px;">(内置)</span>`:''}\n            </div>\n            ${e.description?`<div class="acu-preset-desc">${n(e.description)}</div>`:''}\n            <div class="acu-preset-stats">\n              基础属性: ${e.baseAttributes.length} | 特别属性: ${e.specialAttributes?.length||0}\n            </div>\n          </div>\n          <div class="acu-preset-actions" style="display: flex; align-items: center; gap: 8px;">\n            <label class="acu-toggle" style="margin: 0;">\n              <input type="checkbox" class="acu-preset-toggle" data-id="${e.id}" ${a?'checked':''}>\n              <span class="acu-toggle-slider"></span>\n            </label>\n            ${o?'':`<button class="acu-preset-btn acu-preset-edit" data-id="${e.id}" title="编辑"><i class="fa-solid fa-pen"></i></button>`}\n            <button class="acu-preset-btn acu-preset-export" data-id="${e.id}" title="导出"><i class="fa-solid fa-download"></i></button>\n            ${o?'':`<button class="acu-preset-btn acu-preset-delete" data-id="${e.id}" title="删除" style="color: #e74c3c;"><i class="fa-solid fa-trash"></i></button>`}\n          </div>\n        </div>\n      `}).join(''),c=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${e.theme}" style="width: 600px; max-width: 92vw; max-height: 80vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid ${t.border};">\n            <div style="font-size: 16px; font-weight: bold; color: ${t.textMain};">\n              <i class="fa-solid fa-dice-d20"></i> 属性规则预设管理\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div id="acu-presets-list">\n              ${r||`<div style="text-align: center; padding: 40px; color: ${t.textSub};">暂无预设</div>`}\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid ${t.border};">\n            <button id="acu-preset-new" style="flex: 1; padding: 10px; background: ${t.buttonBg||t.accent}; border: none; border-radius: 6px; color: ${t.buttonText}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-plus"></i> 新建预设\n            </button>\n            <button id="acu-preset-import" style="flex: 1; padding: 10px; background: ${t.btnBg}; border: 1px solid ${t.border}; border-radius: 6px; color: ${t.textMain}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-file-import"></i> 导入\n            </button>\n            <button id="acu-preset-back" style="padding: 10px 16px; background: ${t.btnBg}; border: 1px solid ${t.border}; border-radius: 6px; color: ${t.textMain}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-arrow-left"></i> 返回\n            </button>\n          </div>\n\n          <input type="file" id="acu-preset-file-input" accept=".json" style="display: none;" />\n        </div>\n      </div>\n    `);$('body').append(c),c.find('.acu-close-btn, #acu-preset-back').on('click',()=>{c.remove(),Rt()}),c.on('change','.acu-preset-toggle',function(){const e=$(this),t=e.data('id');if(e.is(':checked')){const e='__default__'===t?null:t;W.setActivePreset(e),c.find('.acu-preset-toggle').each(function(){const e=$(this);e.data('id')!==t&&e.prop('checked',!1)})}else W.setActivePreset(null)}),c.on('click','.acu-preset-edit',function(){const e=$(this).data('id');c.remove(),Ot(e)}),c.on('click','.acu-preset-export',function(){const e=$(this).data('id'),t=W.exportPreset(e);if(!t)return void(window.toastr&&window.toastr.error('导出失败'));const n=a.find(t=>t.id===e),i=`acu_preset_${n?.name||e}_${Date.now()}.json`,o=new Blob([t],{type:'application/json'}),r=URL.createObjectURL(o),c=document.createElement('a');c.href=r,c.download=i,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r),window.toastr&&window.toastr.success('预设已导出')}),c.on('click','.acu-preset-delete',function(){const e=$(this).data('id'),t=a.find(t=>t.id===e);if(confirm(`确定要删除预设「${t?.name}」吗？`)){W.deletePreset(e)?(window.toastr&&window.toastr.success('预设已删除'),c.remove(),Ft()):window.toastr&&window.toastr.error('删除失败')}}),c.find('#acu-preset-new').on('click',()=>{c.remove(),Ot()}),c.find('#acu-preset-import').on('click',()=>{c.find('#acu-preset-file-input').click()}),c.find('#acu-preset-file-input').on('change',function(e){const t=e.target.files[0];if(!t)return;const a=new FileReader;a.onload=e=>{try{const t=W.importPreset(e.target.result);t?(window.toastr&&window.toastr.success(`预设「${t.name}」导入成功`),c.remove(),Ft()):window.toastr&&window.toastr.error('导入失败：格式不正确')}catch(e){console.error('[ACU] 导入预设失败:',e),window.toastr&&window.toastr.error('导入失败')}},a.readAsText(t),$(this).val('')}),c.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&(c.remove(),Rt())})},Ot=(e=null)=>{const{$}=Pe();$('.acu-edit-overlay').remove();const t=$t(),a=ae(),i=!!e,o=i?W.getAllPresets().find(t=>t.id===e):null,r={name:o?.name||'新规则预设',description:o?.description||'',baseAttributes:o?.baseAttributes||[{name:'力量',formula:'3d6',range:[3,18]},{name:'敏捷',formula:'3d6',range:[3,18]},{name:'体质',formula:'3d6',range:[3,18]},{name:'智力',formula:'3d6',range:[3,18]},{name:'感知',formula:'3d6',range:[3,18]},{name:'魅力',formula:'3d6',range:[3,18]}],specialAttributes:o?.specialAttributes||[]},c=$(`\n      <div class="acu-edit-overlay">\n        <div class="acu-edit-dialog acu-theme-${t.theme}" style="width: 650px; max-width: 95vw; max-height: 85vh;">\n          <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 12px; border-bottom: 1px solid ${a.border};">\n            <div style="font-size: 16px; font-weight: bold; color: ${a.textMain};">\n              <i class="fa-solid fa-pen"></i> ${i?'编辑':'新建'}规则预设\n            </div>\n            <button class="acu-close-btn"><i class="fa-solid fa-times"></i></button>\n          </div>\n\n          <div style="flex: 1; overflow-y: auto; padding: 12px 0;">\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: ${a.textSub}; margin-bottom: 4px;">预设名称</label>\n              <input id="preset-name" type="text" value="${n(r.name)}" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid ${a.border} !important; border-radius: 6px; background: ${a.inputBg} !important; color: ${a.textMain} !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: ${a.textSub}; margin-bottom: 4px;">描述</label>\n              <input id="preset-desc" type="text" value="${n(r.description)}" placeholder="可选" class="acu-preset-editor-input" style="width: 100%; padding: 8px; border: 1px solid ${a.border} !important; border-radius: 6px; background: ${a.inputBg} !important; color: ${a.textMain} !important; box-sizing: border-box;" />\n            </div>\n\n            <div style="margin-bottom: 16px;">\n              <label style="display: block; font-size: 12px; color: ${a.textSub}; margin-bottom: 8px;">\n                JSON配置 <span style="font-size: 10px; color: ${a.textSub};">(支持直接编辑或导入)</span>\n              </label>\n              <textarea id="preset-json" class="acu-preset-editor-textarea" style="width: 100%; height: 320px; padding: 10px; border: 1px solid ${a.border} !important; border-radius: 6px; background: ${a.inputBg} !important; color: ${a.textMain} !important; font-family: 'Consolas', 'Monaco', monospace !important; font-size: 12px; resize: vertical; box-sizing: border-box;"></textarea>\n            </div>\n\n            <div style="font-size: 11px; color: ${a.textSub}; padding: 8px; background: var(--acu-table-head); border-radius: 6px; line-height: 1.6;">\n              <strong>配置格式说明：</strong><br/>\n              • baseAttributes: 基本属性数组，每项包含 name、formula、range、modifier(可选)<br/>\n              • specialAttributes: 特别属性数组，每项包含 name、formula、range(可选)<br/>\n              • 公式支持: 3d6, 4d6kh3, 变量引用(力量/2), 数学运算(+、-、*、/)\n            </div>\n          </div>\n\n          <div style="display: flex; gap: 8px; padding-top: 12px; border-top: 1px solid ${a.border};">\n            <button id="preset-save" style="flex: 1; padding: 10px; background: ${a.buttonBg||a.accent}; border: none; border-radius: 6px; color: ${a.buttonText}; cursor: pointer; font-size: 13px; font-weight: bold;">\n              <i class="fa-solid fa-check"></i> 保存\n            </button>\n            <button id="preset-cancel" style="padding: 10px 16px; background: ${a.btnBg}; border: 1px solid ${a.border}; border-radius: 6px; color: ${a.textMain}; cursor: pointer; font-size: 13px;">\n              <i class="fa-solid fa-times"></i> 取消\n            </button>\n          </div>\n        </div>\n      </div>\n    `);$('body').append(c);const s=c.find('#preset-json');(()=>{const e={baseAttributes:r.baseAttributes,specialAttributes:r.specialAttributes};s.val(JSON.stringify(e,null,2))})(),c.find('.acu-close-btn, #preset-cancel').on('click',()=>{c.remove(),Ft()}),c.find('#preset-save').on('click',()=>{try{const t=c.find('#preset-name').val().trim(),a=c.find('#preset-desc').val().trim(),n=s.val().trim();if(!t)return void(window.toastr&&window.toastr.warning('请输入预设名称'));const o=JSON.parse(n);if(!o.baseAttributes||!Array.isArray(o.baseAttributes)||0===o.baseAttributes.length)return void(window.toastr&&window.toastr.error('基本属性不能为空'));const r={format:'acu_attr_preset_v1',version:1,id:e||`custom_${Date.now()}`,name:t,description:a,baseAttributes:o.baseAttributes,specialAttributes:o.specialAttributes||[]};i?(W.updatePreset(e,r),window.toastr&&window.toastr.success('预设已更新')):(W.createPreset(r),window.toastr&&window.toastr.success('预设已创建')),c.remove(),Ft()}catch(e){console.error('[ACU] 保存预设失败:',e),window.toastr&&window.toastr.error('保存失败：'+(e.message||'JSON格式错误'))}}),c.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&(c.remove(),Ft())})},Rt=()=>{const{$}=Pe();$('.acu-edit-overlay').not(':has(.acu-settings-dialog)').remove(),be=!0;const e=$t(),t=`acu-theme-${e.theme}`,a=ae(),i=Fe.get('acu_settings_expanded',['appearance']),o=e=>i.includes(e),r=[{key:'__dice__',name:'投骰',icon:'fa-dice-d20'},{key:'__changes__',name:'变更审核',icon:'fa-code-compare'},{key:'__mvu__',name:'MVU变量',icon:'fa-code-branch'}],c=(()=>{const e=xe||zt(),t=Mt(e||{}),a=Ve()||[],i=Qe();let o=[];if(r.forEach(e=>{o.push({key:e.key,name:e.name,icon:e.icon,isSpecial:!0})}),Object.keys(t).forEach(e=>{o.push({key:e,name:e,icon:De(e),isSpecial:!1})}),a.length>0){const e=new Map(a.map((e,t)=>[e,t]));o.sort((t,a)=>(e.has(t.key)?e.get(t.key):9999)-(e.has(a.key)?e.get(a.key):9999))}return o.map(e=>{const t=i.includes(e.key),a=e.isSpecial?' acu-special-item':'',o=e.name;return'<div class="acu-table-manager-item'+a+(t?' hidden-table':'')+'" data-table-name="'+n(e.key)+'" draggable="false"><div class="acu-table-item-check" title="点击切换显示/隐藏"><i class="fa-solid '+(t?'fa-eye-slash':'fa-eye')+'"></i></div><div class="acu-table-item-icon"><i class="fa-solid '+e.icon+'"></i></div><div class="acu-table-item-name">'+n(o)+'</div><div class="acu-table-item-handle" title="拖拽排序"><i class="fa-solid fa-grip-vertical"></i></div></div>'}).join('')})(),s=e=>o(e)?'fa-chevron-down':'fa-chevron-right',l=$(`\n        <div class="acu-edit-overlay">\n            <div class="acu-edit-dialog acu-settings-dialog ${t}">\n                <div class="acu-settings-header">\n                    <div class="acu-settings-title"><i class="fa-solid fa-cog"></i> 设置</div>\n                    <button class="acu-close-btn" id="dlg-close-x"><i class="fa-solid fa-times"></i></button>\n                </div>\n\n                <div class="acu-settings-body">\n                \x3c!-- 外观样式 --\x3e\n                <div class="acu-settings-group ${o('appearance')?'':'collapsed'}" data-group="appearance">                    <div class="acu-settings-group-title">\n                        <i class="fa-solid ${s('appearance')} acu-group-chevron"></i>\n                        <i class="fa-solid fa-palette"></i> 外观样式\n                    </div>\n                    <div class="acu-settings-group-body">\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">背景主题</span>\n                            </div>\n                            <select id="cfg-theme" class="acu-setting-select">\n                                ${Be.map(t=>`<option value="${t.id}" ${t.id===e.theme?'selected':''}>${t.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">字体风格</span>\n                            </div>\n                            <select id="cfg-font-family" class="acu-setting-select">\n                                ${Me.map(t=>`<option value="${t.id}" ${t.id===e.fontFamily?'selected':''}>${t.name}</option>`).join('')}\n                            </select>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">字体大小 (界面)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-main" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${e.fontSize}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">字体大小 (选项)</span>\n                            </div>\n                            <div class="acu-stepper" data-id="cfg-font-opt" data-min="10" data-max="24" data-step="1">\n                                <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                <span class="acu-stepper-value">${e.optionFontSize||12}px</span>\n                                <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                            </div>\n                        </div>\n                        <div class="acu-setting-row acu-setting-row-toggle">\n                            <div class="acu-setting-info">\n                                <span class="acu-setting-label">高亮变化内容</span>\n                            </div>\n                            <label class="acu-toggle">\n                                <input type="checkbox" id="cfg-new" ${e.highlightNew?'checked':''}>\n                                <span class="acu-toggle-slider"></span>\n                            </label>\n                        </div>\n                    </div>\n                </div>\n\n                    \x3c!-- 布局设置 --\x3e\n                    <div class="acu-settings-group ${o('layout')?'':'collapsed'}" data-group="layout">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${s('layout')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-th-large"></i> 布局设置\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">卡片宽度</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-width" data-min="200" data-max="500" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${e.cardWidth}px</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">布局模式</span>\n                                </div>\n                                <select id="cfg-layout" class="acu-setting-select">\n                                    <option value="horizontal" ${'vertical'!==e.layout?'selected':''}>横向滚动</option>\n                                    <option value="vertical" ${'vertical'===e.layout?'selected':''}>竖向滚动</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">底部按钮列数</span>\n                                    <span class="acu-setting-hint">仅移动端</span>\n                                </div>\n                                <select id="cfg-grid-cols" class="acu-setting-select acu-select-short">\n                                    <option value="2" ${2==e.gridColumns?'selected':''}>2列</option>\n                                    <option value="3" ${3==e.gridColumns?'selected':''}>3列</option>\n                                    <option value="4" ${4==e.gridColumns?'selected':''}>4列</option>\n                                    <option value="auto" ${'auto'===e.gridColumns?'selected':''}>自动</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">每页显示条数</span>\n                                </div>\n                                <div class="acu-stepper" data-id="cfg-per-page" data-min="10" data-max="200" data-step="10">\n                                    <button class="acu-stepper-btn acu-stepper-dec"><i class="fa-solid fa-minus"></i></button>\n                                    <span class="acu-stepper-value">${e.itemsPerPage}</span>\n                                    <button class="acu-stepper-btn acu-stepper-inc"><i class="fa-solid fa-plus"></i></button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 投骰高级设置 --\x3e\n                    <div class="acu-settings-group ${o('attrRules')?'':'collapsed'}" data-group="attrRules">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${s('attrRules')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-dice-d20"></i> 投骰高级设置\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">管理属性规则</span>\n                                    <span class="acu-setting-hint">创建、编辑和管理属性规则预设</span>\n                                </div>\n                                <button id="cfg-attr-preset-manage" class="acu-setting-btn" style="padding: 6px 12px; background: ${a.btnBg}; border: 1px solid ${a.border}; border-radius: 4px; color: ${a.textMain}; cursor: pointer; font-size: 12px;">\n                                    <i class="fa-solid fa-cog"></i> 管理\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 位置与交互 --\x3e\n                    <div class="acu-settings-group ${o('position')?'':'collapsed'}" data-group="position">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${s('position')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-arrows-alt"></i> 位置与交互\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">面板位置</span>\n                                </div>\n                                <select id="cfg-position" class="acu-setting-select">\n                                    <option value="fixed" ${'embedded'!==e.positionMode?'selected':''}>悬浮底部</option>\n                                    <option value="embedded" ${'embedded'===e.positionMode?'selected':''}>跟随消息</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">功能按钮位置</span>\n                                </div>\n                                <select id="cfg-action-pos" class="acu-setting-select acu-select-short">\n                                    <option value="bottom" ${'top'!==e.actionsPosition?'selected':''}>底部</option>\n                                    <option value="top" ${'top'===e.actionsPosition?'selected':''}>顶部</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">收起样式</span>\n                                </div>\n                                <select id="cfg-col-style" class="acu-setting-select acu-select-short">\n                                    <option value="bar" ${'bar'===e.collapseStyle?'selected':''}>长条</option>\n                                    <option value="pill" ${'pill'===e.collapseStyle?'selected':''}>胶囊</option>\n                                    <option value="mini" ${'mini'===e.collapseStyle?'selected':''}>圆钮</option>\n                                </select>\n                            </div>\n                            <div class="acu-setting-row">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">收起位置</span>\n                                </div>\n                                <select id="cfg-col-align" class="acu-setting-select acu-select-short">\n                                    <option value="right" ${'left'!==e.collapseAlign?'selected':''}>靠右</option>\n                                    <option value="left" ${'left'===e.collapseAlign?'selected':''}>靠左</option>\n                                </select>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 行动选项 --\x3e\n                    <div class="acu-settings-group ${o('options')?'':'collapsed'}" data-group="options">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${s('options')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-gamepad"></i> 行动选项\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-setting-row acu-setting-row-toggle">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">显示行动选项面板</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-show-opt" ${!1!==e.showOptionPanel?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                            <div class="acu-setting-row acu-setting-row-toggle" id="row-auto-send" style="${!1!==e.showOptionPanel?'':'display:none;'}">\n                                <div class="acu-setting-info">\n                                    <span class="acu-setting-label">点击选项直接发送</span>\n                                </div>\n                                <label class="acu-toggle">\n                                    <input type="checkbox" id="cfg-auto-send" ${!1!==e.clickOptionToAutoSend?'checked':''}>\n                                    <span class="acu-toggle-slider"></span>\n                                </label>\n                            </div>\n                        </div>\n                    </div>\n\n                \x3c!-- 表格管理 --\x3e\n                    <div class="acu-settings-group ${o('tables')?'':'collapsed'}" data-group="tables">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${s('tables')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-table"></i> 表格管理\n                        </div>\n                        <div class="acu-settings-group-body">\n                            <div class="acu-table-manager-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> 点击切换显示，长按拖拽排序\n                            </div>\n                            <div class="acu-table-manager-list" id="table-manager-list">\n                                ${c}\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- 数据验证规则 --\x3e\n                    <div class="acu-settings-group ${o('validation')?'':'collapsed'}" data-group="validation">\n                        <div class="acu-settings-group-title">\n                            <i class="fa-solid ${s('validation')} acu-group-chevron"></i>\n                            <i class="fa-solid fa-clipboard-check"></i> 数据验证规则\n                        </div>\n                        <div class="acu-settings-group-body">\n                            \x3c!-- 预设选择器 --\x3e\n                            <div class="acu-setting-row" style="margin-bottom:8px;">\n                                <span>当前预设</span>\n                                <select class="acu-setting-select" id="preset-select" style="flex:1;max-width:160px;">\n                                    ${P.getAllPresets().map(e=>`<option value="${n(e.id)}" ${e.id===P.getActivePreset()?.id?'selected':''}>${n(e.name)}${e.builtin?' (内置)':''}</option>`).join('')}\n                                </select>\n                            </div>\n                            \x3c!-- 预设操作按钮 --\x3e\n                            <div style="display:flex;gap:6px;margin-bottom:10px;">\n                                <button class="acu-action-btn" id="btn-preset-dup" title="复制预设" style="flex:1;height:28px;"><i class="fa-solid fa-copy"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-new" title="新建预设" style="flex:1;height:28px;"><i class="fa-solid fa-plus"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-del" title="删除预设" style="flex:1;height:28px;"><i class="fa-solid fa-trash"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-export" title="导出" style="flex:1;height:28px;"><i class="fa-solid fa-file-export"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-import" title="导入" style="flex:1;height:28px;"><i class="fa-solid fa-file-import"></i></button>\n                                <button class="acu-action-btn" id="btn-preset-reset" title="恢复默认预设规则" style="flex:1;height:28px;"><i class="fa-solid fa-rotate-left"></i></button>\n                            </div>\n                            <div class="acu-validation-hint" style="font-size:11px;color:var(--acu-text-sub);margin-bottom:8px;padding:0 4px;">\n                                <i class="fa-solid fa-info-circle"></i> 验证规则用于检测数据合法性，<i class="fa-solid fa-shield-halved"></i> 表示启用拦截\n                            </div>\n                            <div class="acu-validation-rules-list" id="validation-rules-list">\n                                ${N.getAllRules().map(e=>{const t=I[e.ruleType]||{name:e.ruleType,icon:'fa-question'},a='table'===t.scope,i=e.intercept;return`\n                                    <div class="acu-validation-rule-item ${e.enabled?'':'disabled'}" data-rule-id="${n(e.id)}">\n                                        <div class="acu-rule-type-icon" title="${n(t.name)}${a?' (表级)':''}">\n                                            <i class="fa-solid ${t.icon}"></i>\n                                        </div>\n                                        <div class="acu-rule-info">\n                                            <div class="acu-rule-name">${n(e.name)}</div>\n                                            <div class="acu-rule-target">${n(e.targetTable)}${e.targetColumn?'.'+n(e.targetColumn):a?' (整表)':''}</div>\n                                        </div>\n                                        <div class="acu-rule-intercept ${i?'active':''}" data-rule-id="${n(e.id)}" title="${i?'点击关闭拦截':'点击启用拦截（违反时回滚）'}"><i class="fa-solid fa-shield-halved"></i></div>\n                                        <div class="acu-rule-toggle ${e.enabled?'active':''}" title="点击切换启用/禁用">\n                                            <i class="fa-solid ${e.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n                                        </div>\n                                        <button class="acu-rule-delete" data-rule-id="${n(e.id)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n                                    </div>\n                                `}).join('')}\n                            </div>\n                            <button class="acu-add-rule-btn" id="btn-add-validation-rule">\n                                <i class="fa-solid fa-plus"></i> 添加自定义验证规则\n                            </button>\n                        </div>\n                    </div>\n                </div>\n\n                </div>\x3c!-- 关闭 .acu-settings-body --\x3e\n            </div>\n        </div>\n    `);$('body').append(l),l.find('.acu-settings-group-title').on('click',function(){const e=$(this).closest('.acu-settings-group'),t=e.find('.acu-settings-group-body');if(t.hasClass('acu-animating'))return;const a=e.data('group'),n=$(this).find('.acu-group-chevron');let i=Fe.get('acu_settings_expanded',['appearance']);if(e.hasClass('collapsed')){e.removeClass('collapsed'),n.removeClass('fa-chevron-right').addClass('fa-chevron-down'),i.includes(a)||i.push(a),t.addClass('acu-animating').show();const o=t.prop('scrollHeight');t.css('height',0).animate({height:o},180,function(){$(this).css('height','').removeClass('acu-animating')})}else{e.addClass('collapsed'),n.removeClass('fa-chevron-down').addClass('fa-chevron-right'),i=i.filter(e=>e!==a);const o=t.outerHeight();t.addClass('acu-animating').css('height',o).animate({height:0},180,function(){$(this).hide().css('height','').removeClass('acu-animating')})}Fe.set('acu_settings_expanded',i)}),l.find('#cfg-theme').on('change',function(){const e=$(this).val();_t({theme:e}),l.find('.acu-edit-dialog').removeClass(Be.map(e=>`acu-theme-${e.id}`).join(' ')).addClass(`acu-theme-${e}`);const t=ae();l.find('#cfg-attr-preset-manage').css({background:t.btnBg,borderColor:t.border,color:t.textMain})}),l.find('#cfg-font-family').on('change',function(){_t({fontFamily:$(this).val()})}),l.find('#cfg-attr-preset-manage').on('click',function(e){e.preventDefault(),e.stopPropagation(),l.remove(),be=!1,Ft()}),l.find('#cfg-layout').on('change',function(){_t({layout:$(this).val()}),Lt()}),l.find('#cfg-grid-cols').on('change',function(){_t({gridColumns:$(this).val()})}),l.find('#cfg-position').on('change',function(){_t({positionMode:$(this).val()}),Lt()}),l.find('#cfg-action-pos').on('change',function(){_t({actionsPosition:$(this).val()}),Lt()}),l.find('#cfg-col-style').on('change',function(){_t({collapseStyle:$(this).val()}),Lt()}),l.find('#cfg-col-align').on('change',function(){_t({collapseAlign:$(this).val()}),Lt()}),l.find('#cfg-show-opt').on('change',function(){const e=$(this).is(':checked');_t({showOptionPanel:e}),e?l.find('#row-auto-send').slideDown(200):l.find('#row-auto-send').slideUp(200),Lt()}),l.find('#cfg-auto-send').on('change',function(){_t({clickOptionToAutoSend:$(this).is(':checked')})}),l.find('#cfg-new').on('change',function(){_t({highlightNew:$(this).is(':checked')}),Lt()}),l.find('.acu-table-item-check').on('click',function(e){e.stopPropagation();const t=$(this).closest('.acu-table-manager-item'),a=t.data('table-name');let n=Qe();const i=$(this).find('i');var o;n.includes(a)?(n=n.filter(e=>e!==a),t.removeClass('hidden-table'),i.removeClass('fa-eye-slash').addClass('fa-eye')):(n.push(a),t.addClass('hidden-table'),i.removeClass('fa-eye').addClass('fa-eye-slash')),o=n,Fe.set(h,o),Lt()});const d=l.find('#table-manager-list');let u={isDragging:!1,element:null,timer:null,startY:0};const p=()=>{u.timer&&(clearTimeout(u.timer),u.timer=null),u.element&&$(u.element).removeClass('acu-dragging'),d.find('.acu-drag-above, .acu-drag-below').removeClass('acu-drag-above acu-drag-below'),u.isDragging=!1,u.element=null},g=e=>{u.isDragging=!0,u.element=e[0],e.addClass('acu-dragging')};d[0].addEventListener('pointerdown',function(e){const t=e.target.closest('.acu-table-item-handle');if(!t)return;e.preventDefault();const a=$(t).closest('.acu-table-manager-item');u.startY=e.clientY,g(a),t.setPointerCapture(e.pointerId)},{passive:!1}),d[0].addEventListener('pointerdown',function(e){const t=e.target.closest('.acu-table-manager-item');if(!t)return;if(e.target.closest('.acu-table-item-check, .acu-table-item-handle'))return;u.startY=e.clientY;const a=$(t);u.timer=setTimeout(()=>{g(a)},350)}),d[0].addEventListener('pointermove',function(e){if(u.timer&&Math.abs(e.clientY-u.startY)>8&&(clearTimeout(u.timer),u.timer=null),!u.isDragging||!u.element)return;e.preventDefault();const t=d.find('.acu-table-manager-item').not('.acu-dragging');let a=null,n=!0;t.each(function(){const t=this.getBoundingClientRect(),i=t.top+t.height/2;e.clientY<i&&!a?(a=this,n=!0):e.clientY>=t.top&&e.clientY<=t.bottom&&(a=this,n=e.clientY<i)}),d.find('.acu-drag-above, .acu-drag-below').removeClass('acu-drag-above acu-drag-below'),a&&a!==u.element&&$(a).addClass(n?'acu-drag-above':'acu-drag-below')},{passive:!1}),d[0].addEventListener('pointerup',()=>{if(!u.isDragging||!u.element)return void p();const e=$(u.element),t=d.find('.acu-drag-above, .acu-drag-below').first();if(t.length&&t[0]!==u.element){t.hasClass('acu-drag-above')?e.insertBefore(t):e.insertAfter(t);const a=[];d.find('.acu-table-manager-item').each(function(){a.push($(this).data('table-name'))}),Ye(a)}p()}),d[0].addEventListener('pointercancel',p),d[0].addEventListener('touchmove',function(e){u.isDragging&&e.preventDefault()},{passive:!1}),l.find('.acu-stepper').each(function(){const e=$(this),t=e.data('id'),a=parseInt(e.data('min')),n=parseInt(e.data('max')),i=parseInt(e.data('step')),o=e.find('.acu-stepper-value'),r=e=>{e=Math.max(a,Math.min(n,e));const i='cfg-per-page'===t?'':'px';o.text(e+i),'cfg-width'===t?($('.acu-wrapper').css('--acu-card-width',e+'px'),_t({cardWidth:e})):'cfg-font-main'===t?($('.acu-wrapper').css('--acu-font-size',e+'px'),_t({fontSize:e})):'cfg-font-opt'===t?($('.acu-wrapper, .acu-embedded-options-container').css('--acu-opt-font-size',e+'px'),_t({optionFontSize:e})):'cfg-per-page'===t&&_t({itemsPerPage:e})},c=()=>{const e=o.text().replace(/[^\d]/g,'');return parseInt(e)||a};e.find('.acu-stepper-dec').on('click',function(){r(c()-i)}),e.find('.acu-stepper-inc').on('click',function(){r(c()+i)})}),l.on('click','.acu-rule-toggle',function(e){e.stopPropagation();const t=$(this),a=t.closest('.acu-validation-rule-item'),n=a.data('rule-id'),i=t.find('i'),o=t.hasClass('active');N.toggleRuleEnabled(n,!o),o?(t.removeClass('active'),i.removeClass('fa-toggle-on').addClass('fa-toggle-off'),a.addClass('disabled')):(t.addClass('active'),i.removeClass('fa-toggle-off').addClass('fa-toggle-on'),a.removeClass('disabled'))}),l.on('click','.acu-rule-delete',function(e){e.stopPropagation();const t=$(this).data('rule-id'),a=$(this).closest('.acu-validation-rule-item');confirm('确定要删除这条自定义规则吗？')&&N.removeCustomRule(t)&&a.fadeOut(200,function(){$(this).remove()})}),l.on('click','.acu-rule-intercept',function(e){e.stopPropagation();const t=$(this),a=t.data('rule-id'),n=t.hasClass('active');N.toggleRuleIntercept(a,!n)&&(n?t.removeClass('active').attr('title','点击启用拦截（违反时回滚）'):t.addClass('active').attr('title','点击关闭拦截'))});const f=()=>{N.clearCache();const e=N.getAllRules();let t='';e.forEach(e=>{const a=I[e.ruleType]||{name:e.ruleType,icon:'fa-question'},i='table'===a.scope,o=e.intercept;t+=`\n          <div class="acu-validation-rule-item ${e.enabled?'':'disabled'}" data-rule-id="${n(e.id)}">\n            <div class="acu-rule-type-icon" title="${n(a.name)}${i?' (表级)':''}">\n              <i class="fa-solid ${a.icon}"></i>\n            </div>\n            <div class="acu-rule-info">\n              <div class="acu-rule-name">${n(e.name)}</div>\n              <div class="acu-rule-target">${n(e.targetTable)}${e.targetColumn?'.'+n(e.targetColumn):i?' (整表)':''}</div>\n            </div>\n            <div class="acu-rule-intercept ${o?'active':''}" data-rule-id="${n(e.id)}" title="${o?'点击关闭拦截':'点击启用拦截（违反时回滚）'}"><i class="fa-solid fa-shield-halved"></i></div>\n            <div class="acu-rule-toggle ${e.enabled?'active':''}" title="点击切换启用/禁用">\n              <i class="fa-solid ${e.enabled?'fa-toggle-on':'fa-toggle-off'}"></i>\n            </div>\n            <button class="acu-rule-delete" data-rule-id="${n(e.id)}" title="删除此规则"><i class="fa-solid fa-trash"></i></button>\n          </div>`}),l.find('#validation-rules-list').html(t)};l.find('#preset-select').on('change',function(){P.setActivePreset($(this).val())&&f()}),l.find('#btn-preset-dup').on('click',function(){const e=P.getActivePreset();if(!e)return;const t=P.duplicatePreset(e.id);t&&(l.find('#preset-select').append(`<option value="${n(t.id)}">${n(t.name)}</option>`),l.find('#preset-select').val(t.id).trigger('change'))}),l.find('#btn-preset-new').on('click',function(){const e=prompt('请输入新预设名称:','我的预设');if(!e?.trim())return;const t=P.createPreset(e.trim());t&&(l.find('#preset-select').append(`<option value="${n(t.id)}">${n(t.name)}</option>`),l.find('#preset-select').val(t.id).trigger('change'))}),l.find('#btn-preset-del').on('click',function(){const e=P.getActivePreset();e&&('default'!==e.id?confirm(`确定删除预设"${e.name}"吗？`)&&P.deletePreset(e.id)&&(l.find(`#preset-select option[value="${e.id}"]`).remove(),l.find('#preset-select').val('default').trigger('change')):window.toastr&&window.toastr.warning('默认预设不能删除'))}),l.find('#btn-preset-export').on('click',function(){const e=P.getActivePreset();if(!e)return;const t=P.exportPreset(e.id);t&&navigator.clipboard.writeText(t).then(()=>{}).catch(()=>{prompt('复制以下内容:',t)})}),l.find('#btn-preset-import').on('click',function(){const e=prompt('粘贴预设 JSON:');if(!e?.trim())return;const t=P.importPreset(e.trim());t?(l.find('#preset-select').append(`<option value="${n(t.id)}">${n(t.name)}</option>`),l.find('#preset-select').val(t.id).trigger('change')):window.toastr&&window.toastr.error('导入失败，请检查格式')}),l.find('#btn-preset-reset').on('click',function(){confirm('确定要将默认预设恢复为初始状态吗？\n这将删除所有对默认预设的修改。')&&(P.resetDefaultPreset()?'default'===P.getActivePreset()?.id&&f():window.toastr&&window.toastr.error('恢复失败'))}),l.find('#btn-add-validation-rule').on('click',function(){Bt(l)});const b=()=>{be=!1,l.remove(),Lt()};l.on('click','#dlg-close-x, .acu-settings-header .acu-close-btn',b),l.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&b()})},Lt=()=>{if(be)return;const{$}=Pe();if(!he&&$('#chat').length){const e=$('#chat');let t=!1;he=new MutationObserver(()=>{t||(t=!0,requestAnimationFrame(()=>{if('embedded'===$t().positionMode)return void(t=!1);const a=e.children().last()[0],n=$('.acu-wrapper')[0];n&&a&&a!==n&&($(a).hasClass('mes')||$(a).hasClass('message-body'))&&e.append(n),t=!1}))}),he.observe(e[0],{childList:!0})}let e;if(ye&&xe)e=xe;else{if(e=zt(),e){let a=!1;for(const n in e){if(!n.startsWith('sheet_'))continue;const i=e[n];if(!i||!i.name||!i.content)continue;const o=t.applyLocks(i.name,i.content);o.modified&&(a=!0),o.restored.length}}if(e){xe='function'==typeof structuredClone?structuredClone(e):JSON.parse(JSON.stringify(e));const t=Je(),a=Ae(),n=t&&Object.keys(t).some(e=>e.startsWith('sheet_'));t&&n?t._contextId?t._contextId!==a&&(xe._contextId=a,He(xe)):He({...t,_contextId:a}):He({...xe,_contextId:a})}}const a=$('.acu-search-input');if($('.acu-wrapper').length&&a.is(':focus')&&e){ge||(me=Ct(e));const t=Mt(e),a=Oe(),n=a&&t[a]?a:null;if(n&&t[n]){const e=Zt(t[n],n),a=$('<div>').html(e);return $('.acu-card-grid').replaceWith(a.find('.acu-card-grid')),$('.acu-panel-title').html(a.find('.acu-panel-title').html()),aa(t),void Vt()}}let i=0,o=0;const r=$('.acu-panel-content');r.length&&(i=r.scrollLeft(),o=r.scrollTop()),$('.acu-wrapper').remove();const c=Mt(e||{});me=ge?new Set:Ct(e);const s=Ve();let l=Object.keys(c);s&&(l=s.filter(e=>c[e]).concat(l.filter(e=>!s.includes(e))));const d=Qe();l=l.filter(e=>!d.includes(e));const u=Oe();let p=u&&c[u]&&!d.includes(u)?u:null;const g=$t(),b=qe(),m='vertical'===g.layout?'acu-layout-vertical':'',h=`acu-mode-${g.positionMode||'fixed'}`;let v=g.gridColumns;if('auto'===v){const e=l.length;if(e<=4)v=e<2?2:e;else{const t=3*Math.ceil(e/3)-e;v=4*Math.ceil(e/4)-e<=t?4:3}}let x='',y=null;if(!1!==g.showOptionPanel){const e=[];if(Object.keys(c).forEach(t=>{t.includes('选项')&&e.push(c[t])}),e.length>0){const t=qe();let a=`\n                    <div class="acu-opt-header" style="position:relative;">\n                        行动选项\n                        <i class="fa-solid ${t?'fa-eye-slash':'fa-eye'} acu-nav-toggle-btn"\n                           style="position:absolute; right:6px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:0.6;"\n                           title="${t?'展开面板':'收起面板'}"></i>\n                    </div>`,i=!1,o=[];e.forEach(e=>{e.rows&&e.rows.forEach(e=>{e.forEach((e,t)=>{if(t>0&&e&&String(e).trim()){const t=String(e).trim();a+=`<button class="acu-opt-btn" data-val="${encodeURIComponent(t)}">${n(t)}</button>`,o.push(t),i=!0}})})}),i&&(x=`<div class="acu-option-panel">${a}</div>`,y=o.join('|||')+(t?'_collapsed':'_expanded'))}}const w=y!==$e;w&&null!==y&&(_e=!0),$e=y;let k=`<div class="acu-wrapper ${h} acu-theme-${g.theme} ${m}" style="--acu-card-width:${g.cardWidth}px; --acu-font-size:${g.fontSize}px; --acu-opt-font-size:${g.optionFontSize||12}px; --acu-grid-cols:${v}">`;if('embedded'===g.positionMode&&x&&_e&&(k+=x),b){const e=`acu-col-${g.collapseStyle||'bar'}`,t=`acu-align-${g.collapseAlign||'right'}`;k+=`\n                <div class="acu-expand-trigger ${e} ${t}" id="acu-btn-expand">\n                    <i class="fa-solid fa-table"></i> <span>数据库助手 (${Object.keys(c).length})</span>\n                </div>\n            `}else{const t=p?We()[p]:null,a=Fe.get(f,!1),i=Fe.get('acu_changes_panel_active',!1),o=Oe()===V.MODULE_ID,r=(o?We()[V.MODULE_ID]:null)||t;k+=`\n                <div class="acu-data-display ${a||i||o||p?'visible':''} ${r?'acu-manual-mode':''}" id="acu-data-area" style="${r?'height:'+r+'px;':''}">\n                    ${i?qt(e):a?Qt(c):o?'<div class="acu-mvu-panel">'+V.renderPanel()+'</div>':p?Zt(c[p],p):''}\n                </div>\n                `;const s=`grid-template-columns: repeat(${v}, 1fr);`;k+=`\n                <div class="acu-nav-container ${'top'===g.actionsPosition?'acu-pos-top':''}" id="acu-nav-bar" style="${s}">\n                    <div class="acu-order-controls" id="acu-order-hint"><i class="fa-solid fa-arrows-alt"></i> 拖动调整顺序，完成后点击保存退出</div>\n            `;const d=Fe.get('acu_changes_panel_active',!1),u=Fe.get(A,!1);let b=0,m=0;if(e){const t=Je();if(t){for(const a in e){if(!a.startsWith('sheet_'))continue;const n=e[a],i=t[a];if(!n?.content)continue;const o=n.content.slice(1),r=i?.content?.slice(1)||[];o.forEach((e,t)=>{const a=r[t];a?e.forEach((e,t)=>{0!==t&&String(e??'')!==String(a[t]??'')&&b++}):b++}),r.length>o.length&&(b+=r.length-o.length)}for(const a in t)a.startsWith('sheet_')&&!e[a]&&b++}m=D.getErrorCount(e)}const h=u?m:b,x=u&&m>0,y=Qe(),w=Ve()||[],C=[{key:'__dice__',icon:'fa-dice-d20',label:'掷骰',id:'acu-btn-dice-nav',extraClass:'acu-dice-nav-btn'},{key:'__changes__',icon:'fa-code-compare',label:'审核'+(h>0?'('+h+')':''),id:'acu-btn-changes',extraClass:'acu-changes-btn'+(x?' has-validation-errors':''),isActive:d,warningIcon:x},{key:'__mvu__',icon:'fa-code-branch',label:'变量',id:'acu-btn-mvu',extraClass:'acu-mvu-btn',isActive:Oe()===V.MODULE_ID}];let S=[];if(C.forEach(e=>{y.includes(e.key)||'__mvu__'!==e.key&&e.checkAvailable&&!e.checkAvailable()||S.push({...e,isSpecial:!0})}),l.forEach(e=>{S.push({key:e,icon:De(e),label:e,isSpecial:!1,isActive:!a&&!d&&p===e})}),w.length>0){const e=new Map(w.map((e,t)=>[e,t]));S.sort((t,a)=>(e.has(t.key)?e.get(t.key):9999)-(e.has(a.key)?e.get(a.key):9999))}k+=`<button class="acu-nav-btn acu-dashboard-btn ${a?'active':''}" id="acu-btn-dashboard" style="order: 1;">\n                <i class="fa-solid fa-chart-line"></i><span>仪表盘</span>\n            </button>`,S.forEach((e,t)=>{const a=e.isActive?'active':'',i=e.extraClass||'',o=t+2;if(e.isSpecial){const t=e.warningIcon?'<i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>':'';k+=`<button class="acu-nav-btn ${i} ${a}" id="${e.id}" style="order: ${o};">\n                        <i class="fa-solid ${e.icon}"></i><span>${n(e.label)}</span>${t}\n                    </button>`}else k+=`<button class="acu-nav-btn ${a}" data-table="${n(e.key)}" style="order: ${o};">\n                        <i class="fa-solid ${e.icon}"></i><span>${n(e.label)}</span>\n                    </button>`}),k+='<div class="acu-actions-group" id="acu-active-actions" style="order: 9999;">',ue.forEach(e=>{k+=`<button class="acu-action-btn" id="${e.id}" title="${e.title}"><i class="fa-solid ${e.icon}"></i></button>`}),k+='</div>',k+='</div>'}k+='</div>';const C=$('.acu-wrapper');if(C.length?C.replaceWith(k):Yt(k),'embedded'!==g.positionMode&&x&&_e)if(w)Ut(x);else{0===$('.acu-embedded-options-container').length&&Ut(x)}else g.positionMode,$('.acu-embedded-options-container').remove();if(aa(c),Vt(),Ne(),Fe.get('acu_changes_panel_active',!1)&&Xt(),Oe()===V.MODULE_ID){const e=$('#acu-data-area');e.length&&(e.html('<div class="acu-mvu-panel">'+V.renderPanel()+'</div>'),V.bindEvents(e),V.getDataWithRetry(5,800).then(t=>{t&&(e.html('<div class="acu-mvu-panel">'+V.renderPanel()+'</div>'),V.bindEvents(e))}).catch(t=>{console.error('[MvuModule] Error getting data:',t),e.html('<div class="acu-mvu-panel">'+V.renderPanel()+'</div>'),V.bindEvents(e)}))}setTimeout(()=>{const e=$('.acu-panel-content'),t=Oe(),a=Se[t];e.length&&(a?(e.scrollTop(a.top),e.scrollLeft(a.left)):(o>0&&e.scrollTop(o),i>0&&e.scrollLeft(i)),a&&a.inner&&Object.keys(a.inner).forEach(t=>{const n=a.inner[t],i=e.find(`.acu-editable-title[data-row="${t}"]`);if(i.length){const e=i.closest('.acu-data-card');e.scrollTop(n),e.find('.acu-card-body').scrollTop(n)}}))},0)},Ut=e=>{const{$}=Pe();$('.acu-embedded-options-container').remove();const t=(()=>{const e=$('#chat .mes').filter(function(){const e=$(this);return'true'!==e.attr('is_user')&&'true'!==e.attr('is_system')&&!e.hasClass('sys_mes')&&('System'!==e.find('.name_text').text().trim()&&'true'!==e.attr('data-is-system')&&(0!==e.find('.mes_text').length&&'none'!==e.css('display')))});if(0===e.length)return null;const t=e.last(),a=t.find('.mes_block');return a.length?a:t})();if(t&&t.length){const a=$t(),n=$(`<div class="acu-embedded-options-container acu-theme-${a.theme}" style="--acu-opt-font-size:${a.optionFontSize||12}px;"></div>`);n.html(e),t.append(n)}},Vt=()=>{const{$}=Pe();$('body').off('click.acu_opt').on('click.acu_opt','.acu-opt-btn',async function(e){e.preventDefault(),e.stopPropagation();const t=$t(),a=decodeURIComponent($(this).data('val'));if(!t.clickOptionToAutoSend)return i(a,'action'),void $('#send_textarea').focus();if(window.TavernHelper)try{if(window.TavernHelper.createChatMessages)return await window.TavernHelper.createChatMessages([{role:'user',message:a}],{refresh:'affected'}),void(window.TavernHelper.triggerSlash&&await window.TavernHelper.triggerSlash('/trigger'))}catch(e){console.warn('[ACU] TavernHelper 发送失败，尝试备用方案',e)}const n=window.SillyTavern||window.parent?.SillyTavern;if(n&&n.executeSlashCommandsWithOptions)try{const e=`/send raw=true "${a.replace(/\\/g,'\\\\').replace(/"/g,'\\"')}"`,t=await n.executeSlashCommandsWithOptions(e);if(!t.isError&&!t.isAborted)return void await n.executeSlashCommandsWithOptions('/trigger');console.warn('[ACU] ST接口 send 失败:',t)}catch(e){console.warn('[ACU] ST接口失败，尝试按钮模拟',e)}const o=$('#send_textarea');if(o.length){o.val(a),o.trigger('input').trigger('change'),await new Promise(e=>setTimeout(e,50));const e=$('#send_but').filter(':visible');if(e.length)e[0].click();else{const e=$.Event('keydown',{keyCode:13,which:13,bubbles:!0});o.trigger(e)}}})},Yt=e=>{const{$}=Pe();if('embedded'===$t().positionMode){$('.acu-wrapper').remove();const t=(()=>{const e=$('#chat .mes').filter(function(){const e=$(this);if('true'===e.attr('is_user'))return!1;if('true'===e.attr('is_system'))return!1;if(e.hasClass('sys_mes'))return!1;if('System'===e.find('.name_text').text().trim())return!1;if('none'===e.css('display'))return!1;const t=e.find('.mes_text');if(0===t.length)return!1;const a=t.text().trim(),n=t.find('img').length>0;return!(0===a.length&&!n)});if(0===e.length)return $('#chat');let t=e.length-1;const a=e.eq(t),n=a.find('.mes_block');return n.length?n:a})();return void(t.length?t.hasClass('mes_block')||t.hasClass('mes')?0===t.find('.acu-wrapper').length?t.append(e):t.find('.acu-wrapper').replaceWith(e):0===$('#chat').find('.acu-wrapper').length&&t.append(e):$('body').append(e))}const t=$('#chat'),a=$('.acu-wrapper');a.length?a.replaceWith(e):t.length?t.append(e):$('body').append(e)},qt=e=>{const t=Je(),a=$t(),i=ae(),o=e?D.validateAllData(e):[];if(!(t&&e||0!==o.length))return'\n                <div class="acu-panel-header">\n                    <div class="acu-panel-title">\n                        <div class="acu-title-main"><i class="fa-solid fa-code-compare"></i> <span class="acu-title-text">更新审核</span></div>\n                        <div class="acu-title-sub">对比上次保存的快照</div>\n                    </div>\n                    <div class="acu-header-actions">\n                        <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                </div>\n                <div class="acu-panel-content" style="display:flex;align-items:center;justify-content:center;">\n                    <div class="acu-empty-hint">暂无快照数据</div>\n                </div>';const r=[];for(const a in e){if(!a.startsWith('sheet_'))continue;const n=e[a],i=t[a];if(!n?.name||!n?.content)continue;const o=n.name,c=n.content[0]||[],s=n.content.slice(1),l=i?.content?.slice(1)||[];if(s.forEach((e,t)=>{const n=l[t];if(n){const i=[];if(e.forEach((e,t)=>{if(0===t)return;const a=String(n[t]??''),o=String(e??'');a!==o&&i.push({colIndex:t,header:c[t]||`列${t}`,oldValue:a,newValue:o})}),1===i.length){const n=i[0];r.push({type:'cell_modified',tableName:o,tableKey:a,rowIndex:t,colIndex:n.colIndex,header:n.header,oldValue:n.oldValue,newValue:n.newValue,rowTitle:e[1]||`行 ${t+1}`})}else i.length>1&&r.push({type:'row_modified',tableName:o,tableKey:a,rowIndex:t,headers:c,row:e,oldRow:n,changedFields:i,rowTitle:e[1]||`行 ${t+1}`})}else r.push({type:'row_added',tableName:o,tableKey:a,rowIndex:t,headers:c,row:e,title:e[1]||`行 ${t+1}`})}),l.length>s.length)for(let e=s.length;e<l.length;e++){const t=l[e];r.push({type:'row_deleted',tableName:o,tableKey:a,rowIndex:e,headers:c,row:t,title:t[1]||`行 ${e+1}`})}}for(const a in t)if(a.startsWith('sheet_')&&!e[a]){const e=t[a];r.push({type:'table_deleted',tableName:e?.name||a,tableKey:a})}const c=Fe.get(A,!1);let s=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n                    <div class="acu-title-main"><i class="fa-solid ${c?'fa-shield-halved':'fa-code-compare'}"></i> <span class="acu-title-text">${c?'数据验证':'完整审核'}</span></div>\n                </div>\n                <div class="acu-header-actions">\n                    ${c?'':'<button class="acu-changes-batch-btn acu-batch-accept" title="接受全部变更"><i class="fa-solid fa-check-double"></i></button>'}\n                    <button class="acu-changes-batch-btn acu-batch-reject" title="${c?'全部回滚':'拒绝全部变更'}"><i class="fa-solid fa-rotate-left"></i></button>\n                    <button class="acu-changes-batch-btn acu-simple-mode-toggle ${c?'active':''}" title="${c?'切换到完整审核模式':'切换到数据验证模式'}">\n                        <i class="fa-solid ${c?'fa-filter-circle-xmark':'fa-filter'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="审核面板" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                    </div>\n                    <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>`;if(c&&(s+='<div class="acu-validation-mode-hint">\n        <i class="fa-solid fa-info-circle"></i>即使回滚，不合法的数据仍会显示警告\n      </div>'),s+=`<div class="acu-panel-content acu-changes-content ${'horizontal'===a.layout?'acu-changes-horizontal':''}">`,c)if(0===o.length)s+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                数据验证通过，无违规项\n            </div>';else{const e=D.groupErrorsByTable(o),t=Fe.get('acu_validation_collapsed_groups',[]);s+='<div class="acu-changes-list">';for(const a in e){const o=e[a],r=t.includes(a);s+=`<div class="acu-changes-group ${r?'collapsed':''}">\n                    <div class="acu-changes-group-header acu-validation-group-header" data-table="${n(a)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${r?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${De(a)}"></i> ${n(a)}\n                        <span class="acu-changes-count" style="background:${i.errorText};">${o.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${r?'display:none;':''}">`,o.forEach(e=>{const t=e.rule?n(JSON.stringify({ruleId:e.ruleId,ruleType:e.ruleType,tableName:e.tableName,rowIndex:e.rowIndex,columnName:e.columnName||'',currentValue:e.currentValue||'',rule:e.rule})):'';s+=`<div class="acu-change-item acu-validation-error-item"\n                         data-table="${n(e.tableName)}"\n                         data-row="${e.rowIndex}"\n                         data-column="${n(e.columnName||'')}"\n                         data-rule-id="${n(e.ruleId||'')}"\n                         data-rule-type="${n(e.ruleType||'')}"\n                         data-rule-data="${t}">\n                        <span class="acu-change-badge" style="background:var(--acu-hl-manual-bg);color:var(--acu-hl-manual);">!</span>\n                        <span class="acu-change-title">${n(e.columnName||'整行')}${e.currentValue?`: ${n(e.currentValue.length>15?e.currentValue.substring(0,15)+'...':e.currentValue)}`:''}</span>\n                        <span class="acu-validation-error-msg">${n(e.errorMessage.length>25?e.errorMessage.substring(0,25)+'...':e.errorMessage)}</span>\n                        <div class="acu-change-actions">\n                            <button class="acu-change-action-btn acu-action-reject" title="回滚"><i class="fa-solid fa-rotate-left"></i></button>\n                            <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                        </div>\n                    </div>`}),s+='</div></div>'}s+='</div>'}else if(0===r.length)s+='<div class="acu-empty-hint" style="padding:40px;text-align:center;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;">\n                <i class="fa-solid fa-check-circle" style="font-size:32px;color:var(--acu-success-text);margin-bottom:10px;display:block;"></i>\n                当前数据与快照一致，无变更\n            </div>';else{const e={};r.forEach(t=>{const a=t.tableName;e[a]||(e[a]=[]),e[a].push(t)}),s+='<div class="acu-changes-list">';const t=Fe.get('acu_changes_collapsed_groups',[]);for(const a in e){const i=e[a],o=t.includes(a);s+=`<div class="acu-changes-group ${o?'collapsed':''}">\n                    <div class="acu-changes-group-header" data-table="${n(a)}" style="cursor:pointer;">\n                        <i class="fa-solid fa-chevron-${o?'right':'down'} acu-collapse-icon" style="font-size:10px;width:12px;transition:transform 0.2s;"></i>\n                        <i class="fa-solid ${De(a)}"></i> ${n(a)}\n                        <span class="acu-changes-count">${i.length}</span>\n                    </div>\n                    <div class="acu-changes-group-body" style="${o?'display:none;':''}">`,i.forEach(e=>{if('row_added'===e.type)s+=`<div class="acu-change-item acu-change-added"\n                            data-change-type="row_added"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}">\n                            <span class="acu-change-badge acu-badge-added">新</span>\n                            <span class="acu-change-title">${n(e.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="拒绝"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`;else if('row_deleted'===e.type)s+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="row_deleted"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}">\n                            <span class="acu-change-badge acu-badge-deleted">删</span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">${n(e.title)}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受删除"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="恢复此行"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`;else if('cell_modified'===e.type){const t=e.oldValue.length>15?e.oldValue.substring(0,15)+'...':e.oldValue,a=e.newValue.length>15?e.newValue.substring(0,15)+'...':e.newValue;let i;i=e.tableName&&e.tableName.includes('选项')?`${n(e.tableName)}.${n(e.header)}`:`${n(e.rowTitle)}.${n(e.header)}`,s+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="cell_modified"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}"\n                            data-col-index="${e.colIndex}"\n                            data-old-value="${encodeURIComponent(e.oldValue)}">\n                            <span class="acu-change-badge acu-badge-modified">更</span>\n                            <span class="acu-change-field">${i}</span>\n                            <span class="acu-change-diff">\n                                <span class="acu-diff-old">${n(t||'(空)')}</span>\n                                <span class="acu-diff-arrow">→</span>\n                                <span class="acu-diff-new">${n(a||'(空)')}</span>\n                            </span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="拒绝"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else if('row_modified'===e.type){const t=e.changedFields.length,a=e.changedFields.slice(0,2).map(e=>e.header).join('、'),i=t>2?` 等${t}项`:'';s+=`<div class="acu-change-item acu-change-modified"\n                            data-change-type="row_modified"\n                            data-table-key="${e.tableKey}"\n                            data-row-index="${e.rowIndex}">\n                            <span class="acu-change-badge acu-badge-modified">更</span>\n                            <span class="acu-change-title">${n(e.rowTitle)}</span>\n                            <span class="acu-change-field-count">${n(a)}${i}</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-reject" title="拒绝"><i class="fa-solid fa-rotate-left"></i></button>\n                                <button class="acu-change-action-btn acu-action-edit" title="编辑"><i class="fa-solid fa-pen"></i></button>\n                            </div>\n                        </div>`}else'table_deleted'===e.type&&(s+=`<div class="acu-change-item acu-change-deleted"\n                            data-change-type="table_deleted"\n                            data-table-key="${e.tableKey}">\n                            <span class="acu-change-badge acu-badge-deleted">删</span>\n                            <span class="acu-change-title" style="text-decoration:line-through;opacity:0.6;">整表已删除</span>\n                            <div class="acu-change-actions">\n                                <button class="acu-change-action-btn acu-action-accept" title="接受"><i class="fa-solid fa-check"></i></button>\n                                <button class="acu-change-action-btn acu-action-restore" title="恢复整表"><i class="fa-solid fa-undo"></i></button>\n                            </div>\n                        </div>`)}),s+='</div></div>'}s+='</div>'}return s+='</div>',s},Xt=()=>{const{$}=Pe();$('.acu-changes-content').closest('.acu-data-display').find('.acu-close-btn').off('click').on('click',function(){Fe.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active')});$('.acu-validation-error-item .acu-action-reject').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-validation-error-item'),a=t.data('table'),n=parseInt(t.data('row'),10),i=t.data('column'),o=Je();if(o)try{const e=xe||zt();for(const t in e)if(e[t]?.name===a&&o[t]){const a=(e[t].content?.[0]||[]).indexOf(i);if(a>=0&&o[t].content?.[n+1]){const i=o[t].content[n+1][a];return e[t].content[n+1][a]=i,await At(e,!1,!1),void Lt()}break}window.toastr&&window.toastr.warning('无法找到对应的快照数据')}catch(e){console.error('[ACU] 恢复快照值失败:',e),window.toastr&&window.toastr.error('恢复失败')}else window.toastr&&window.toastr.warning('无快照数据可恢复')}),$('.acu-validation-error-item .acu-action-edit').off('click').on('click',function(e){e.stopPropagation();const t=$(this).closest('.acu-validation-error-item'),a=t.data('rule-data');if(a)try{const e='string'==typeof a?JSON.parse(a):a,n={ruleId:e.ruleId,ruleType:e.ruleType,rule:e.rule,tableName:t.data('table')||e.tableName||'',rowIndex:parseInt(t.data('row'),10)||e.rowIndex||0,columnName:t.data('column')||e.columnName||'',currentValue:e.currentValue||'',ruleName:e.ruleName||e.rule?.name||'',errorMessage:e.errorMessage||e.rule?.errorMessage||''};Et(n)}catch(e){console.error('[ACU] 解析规则数据失败:',e),window.toastr&&window.toastr.error('解析规则数据失败')}else window.toastr&&window.toastr.warning('无法获取规则信息')});let e=null;$('.acu-validation-error-item').off('click touchstart touchend touchmove').on('touchstart',function(t){const a=t.originalEvent.touches[0];e={x:a.clientX,y:a.clientY}}).on('touchmove',function(t){if(!e)return;const a=t.originalEvent.touches[0],n=Math.abs(a.clientX-e.x),i=Math.abs(a.clientY-e.y);(n>10||i>10)&&(e=null)}).on('touchend',function(t){if(!e)return;if(e=null,$(t.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if(Fe.get(A,!1))return;const a=$(this).data('table'),n=$(this).data('row');Fe.set('acu_changes_panel_active',!1),Re(a),Lt(),setTimeout(()=>{const e=$(`.acu-data-card[data-row-index="${n}"]`);e.length&&(e[0].scrollIntoView({behavior:'smooth',block:'center'}),e.addClass('acu-highlight-flash'),setTimeout(()=>e.removeClass('acu-highlight-flash'),2e3))},300)}).on('click',function(e){if($(e.target).closest('.acu-change-actions, .acu-change-action-btn').length)return;if('ontouchstart'in window)return;if(Fe.get(A,!1))return;const t=$(this).data('table'),a=$(this).data('row');Fe.set('acu_changes_panel_active',!1),Re(t),Lt(),setTimeout(()=>{const e=$(`.acu-data-card[data-row-index="${a}"]`);e.length&&(e[0].scrollIntoView({behavior:'smooth',block:'center'}),e.addClass('acu-highlight-flash'),setTimeout(()=>e.removeClass('acu-highlight-flash'),2e3))},300)}),$('.acu-changes-group-header').off('click').on('click',function(e){if($(e.target).closest('.acu-change-item').length)return;const t=$(this).data('table'),a=$(this).closest('.acu-changes-group'),n=a.find('.acu-changes-group-body'),i=$(this).find('.acu-collapse-icon'),o=$(this).hasClass('acu-validation-group-header')?'acu_validation_collapsed_groups':'acu_changes_collapsed_groups';let r=Fe.get(o,[]);a.hasClass('collapsed')?(a.removeClass('collapsed'),n.slideDown(200),i.removeClass('fa-chevron-right').addClass('fa-chevron-down'),r=r.filter(e=>e!==t)):(a.addClass('collapsed'),n.slideUp(200),i.removeClass('fa-chevron-down').addClass('fa-chevron-right'),r.includes(t)||r.push(t)),Fe.set(o,r)}),$('.acu-change-item .acu-action-accept').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),a=t.data('change-type'),n=t.data('table-key'),i=t.data('row-index'),o=t.data('col-index'),r=Je(),c=xe||zt();r&&c&&('cell_modified'===a?r[n]?.content?.[i+1]&&c[n]?.content?.[i+1]&&(r[n].content[i+1][o]=c[n].content[i+1][o]):'row_modified'===a?r[n]?.content&&c[n]?.content?.[i+1]&&(r[n].content[i+1]=[...c[n].content[i+1]]):'row_added'===a?c[n]?.content?.[i+1]&&(r[n]?r[n].content[i+1]=[...c[n].content[i+1]]:r[n]=JSON.parse(JSON.stringify(c[n]))):'row_deleted'===a?r[n]?.content?.[i+1]&&r[n].content.splice(i+1,1):'table_deleted'===a&&delete r[n],He(r),t.fadeOut(200,function(){$(this).remove(),Jt()}))}),$('.acu-change-item .acu-action-reject').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),a=t.data('change-type'),n=t.data('table-key'),i=t.data('row-index'),o=t.data('col-index'),r=decodeURIComponent(t.data('old-value')||''),c=Je();let s=xe||zt();c&&s&&('cell_modified'===a?s[n]?.content?.[i+1]&&(s[n].content[i+1][o]=r):'row_modified'===a?c[n]?.content?.[i+1]&&s[n]?.content&&(s[n].content[i+1]=[...c[n].content[i+1]]):'row_added'===a&&s[n]?.content?.[i+1]&&s[n].content.splice(i+1,1),await It(s),t.fadeOut(200,function(){$(this).remove(),Jt()}))}),$('.acu-action-restore').off('click').on('click',async function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),a=t.data('change-type'),n=t.data('table-key'),i=t.data('row-index'),o=Je();let r=xe||zt();if(o&&r){if('row_deleted'===a){if(o[n]?.content?.[i+1]){const e=[...o[n].content[i+1]];r[n]||(r[n]=JSON.parse(JSON.stringify(o[n])),r[n].content=[o[n].content[0]]),r[n].content.splice(i+1,0,e)}}else'table_deleted'===a&&o[n]&&(r[n]=JSON.parse(JSON.stringify(o[n])));await It(r),t.fadeOut(200,function(){$(this).remove(),Jt()})}}),$('.acu-change-item:not(.acu-validation-error-item) .acu-action-edit').off('click').on('click',function(e){e.stopPropagation();const t=$(this).closest('.acu-change-item'),a=t.data('table-key'),n=t.data('row-index'),i=t.data('change-type');if(!a||void 0===n)return;const o=xe||zt();if(!o||!o[a])return;const r=o[a],c=r.content?r.content[0]:[],s=r.content?r.content[n+1]:null;if(s)if('row_modified'===i)Gt(s,c,r.name||'编辑',n,a);else if('cell_modified'===i){const e=t.data('col-index'),i=c[e]||`列${e}`,o=s[e]||'';Kt(o,i,r.name,n,e,a)}else Wt(s,c,r.name||'编辑',n,a);else window.toastr&&window.toastr.warning('该行可能已被删除')}),$('.acu-batch-accept').off('click').on('click',async function(){const e=xe||zt();e&&(He(JSON.parse(JSON.stringify(e))),me=new Set,Jt())}),$('.acu-batch-reject').off('click').on('click',async function(){const e=Je();if(!e)return void(window.toastr&&window.toastr.warning('无快照数据'));const t=JSON.parse(JSON.stringify(e));xe=t,await At(t,!1,!1)}),$('.acu-simple-mode-toggle').off('click').on('click',function(){const e=!Fe.get(A,!1);Fe.set(A,e);const t=xe||zt();$('#acu-data-area').html(qt(t)),Xt(),Ht(t)}),$('.acu-changes-content').closest('.acu-data-display').find('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(e){if(0!==e.button)return;e.preventDefault(),e.stopPropagation();const t=this;t.setPointerCapture(e.pointerId),$(t).addClass('active');const a=$('#acu-data-area'),n=a.height(),i=e.clientY,o=$(t).data('table');t.onpointermove=function(e){const t=e.clientY-i;let o=n-t;o<x&&(o=x),o>y&&(o=y),a.css('height',o+'px')},t.onpointerup=function(e){$(t).removeClass('active'),t.releasePointerCapture(e.pointerId),t.onpointermove=null,t.onpointerup=null;const n=a.height(),i=We();i[o]=n,Ke(i)}}).off('dblclick').on('dblclick',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table');$('#acu-data-area').css('height','');const a=We();delete a[t],Ke(a)});const t=$('.acu-changes-content.acu-changes-horizontal');t.length&&(t[0].addEventListener('touchstart',function(e){this._touchStartX=e.touches[0].clientX,this._touchStartY=e.touches[0].clientY,this._scrollDirection=null},{passive:!0}),t[0].addEventListener('touchmove',function(e){if(!this._touchStartX)return;const t=Math.abs(e.touches[0].clientX-this._touchStartX),a=Math.abs(e.touches[0].clientY-this._touchStartY);!this._scrollDirection&&(t>5||a>5)&&(this._scrollDirection=t>a?'horizontal':'vertical'),'horizontal'===this._scrollDirection&&t>10&&e.stopPropagation()},{passive:!1}),t[0].addEventListener('touchend',function(){this._touchStartX=null,this._touchStartY=null,this._scrollDirection=null},{passive:!0}))},Jt=()=>{const{$}=Pe(),e=xe||zt();me=Ct(e);const t=$('#acu-data-area');t.length&&Fe.get('acu_changes_panel_active',!1)&&(t.html(qt(e)),Xt(),Ht(e))},Ht=e=>{const{$}=Pe(),t=Je();let a=0;if(t&&e){for(const n in e){if(!n.startsWith('sheet_'))continue;const i=e[n],o=t[n];if(!i?.content)continue;const r=i.content.slice(1),c=o?.content?.slice(1)||[];r.forEach((e,t)=>{const n=c[t];n?e.forEach((e,t)=>{0!==t&&String(e??'')!==String(n[t]??'')&&a++}):a++}),c.length>r.length&&(a+=c.length-r.length)}for(const n in t)n.startsWith('sheet_')&&!e[n]&&a++}const n=e?D.getErrorCount(e):0,i=Fe.get(A,!1),o=i?n:a,r=i&&n>0,c=$('#acu-btn-changes'),s=c.find('span');s.html(o>0?`审核(${o})`:'审核'),r?(c.find('.acu-nav-warning-icon').length||s.append(' <i class="fa-solid fa-triangle-exclamation acu-nav-warning-icon"></i>'),c.addClass('has-validation-errors')):(c.find('.acu-nav-warning-icon').remove(),c.removeClass('has-validation-errors'))},Wt=(e,t,a,i,o)=>{const{$}=Pe(),r=$t(),c=e.map((e,a)=>{if(0===a)return'';const i=t[a]||`列 ${a}`,o=e||'';return`\n                <div class="acu-card-edit-field" style="margin-bottom: 10px;">\n                    <label style="display:block;font-size:12px;color:var(--acu-accent);font-weight:bold;margin-bottom:4px;">${n(i)}</label>\n                    <textarea class="acu-card-edit-input acu-edit-textarea" data-col="${a}" spellcheck="false" rows="1"\n                                                        style="width:100%;min-height:40px;max-height:500px;padding:10px;resize:none;overflow-y:hidden;">${n(o)}</textarea>                            </div>`}).join(''),s=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${r.theme}">\n                    <div class="acu-edit-title">编辑变更 (#${i+1} - ${n(a)})</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${c}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-change-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-change-save"><i class="fa-solid fa-check"></i> 保存并确认</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(s);const l=e=>{e.style.height='auto';const t=e.scrollHeight+2;e.style.height=Math.min(t,500)+'px',e.style.overflowY=t>500?'auto':'hidden'};requestAnimationFrame(()=>{s.find('textarea').each(function(){l(this)})}),s.find('textarea').on('input',function(){l(this)}),s.find('textarea').on('input',function(){l(this)});const d=()=>{be=!1,s.remove()};s.find('#dlg-change-cancel').click(d),s.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&d()}),s.find('#dlg-change-save').click(async()=>{let e=xe||zt();if(e&&e[o]){const t=e[o]?.content?.[i+1];if(!t)return void d();let a=!1;if(s.find('textarea').each(function(){const e=parseInt($(this).data('col')),n=$(this).val();String(t[e])!==String(n)&&(a=!0,t[e]=n)}),a){const a=Pe().getDB();if(a&&a.importTableAsJson){const t={mate:e.mate||{type:'chatSheets',version:1}};Object.keys(e).forEach(a=>{a.startsWith('sheet_')&&(t[a]=e[a])}),await a.importTableAsJson(JSON.stringify(t))}xe=e;const n=Je();n&&n[o]&&n[o].content&&(n[o].content[i+1]=[...t],He(n)),me=Ct(e);$('#acu-data-area').html(qt(e)),Xt()}}d()})},Kt=(e,t,a,i,o,r)=>{const{$}=Pe(),c=$t(),s=Je(),l=s?.[r]?.content?.[i+1]?.[o]??'',d=''!==l&&String(l)!==String(e),u=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${c.theme}" style="max-width:450px;">\n                    <div class="acu-edit-title">编辑: ${n(a)} - ${n(t)}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px;">\n                        ${d?`\n                        <div class="acu-diff-section acu-diff-old-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-clock-rotate-left"></i> 原始值（快照）\n                            </div>\n                            <div class="acu-diff-readonly">${n(l)}</div>\n                        </div>\n                        <div class="acu-diff-arrow-down">\n                            <i class="fa-solid fa-arrow-down"></i>\n                        </div>\n                        `:''}\n                        <div class="acu-diff-section acu-diff-new-section">\n                            <div class="acu-diff-label">\n                                <i class="fa-solid fa-pen"></i> ${d?'当前值（可编辑）':'内容'}\n                            </div>\n                            <textarea class="acu-change-single-input acu-edit-textarea" spellcheck="false"\n                                style="width:100%;min-height:60px;max-height:300px;padding:12px;resize:none;">${n(e)}</textarea>\n                        </div>\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-single-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        ${d?'<button class="acu-dialog-btn acu-btn-revert" id="dlg-single-revert"><i class="fa-solid fa-rotate-left"></i> 恢复原值</button>':''}\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-single-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(u);const p=u.find('.acu-change-single-input'),g=()=>{p[0].style.height='auto';const e=Math.max(60,Math.min(p[0].scrollHeight+2,300));p[0].style.height=e+'px'};setTimeout(g,0),p.on('input',g),p.focus();const f=()=>u.remove();u.find('#dlg-single-cancel').click(f),u.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&f()}),u.find('#dlg-single-revert').click(function(){p.val(l).trigger('input')}),u.find('#dlg-single-save').click(async()=>{const e=p.val();let t=xe||zt();if(t&&t[r]&&t[r].content){const a=t[r].content[i+1];if(a&&String(a[o])!==String(e)){a[o]=e,await It(t);const n=Je();n&&n[r]&&n[r].content&&n[r].content[i+1]&&(n[r].content[i+1][o]=e,He(n)),me=Ct(t),Jt()}}f()})},Gt=(e,t,a,i,o)=>{const{$}=Pe(),r=$t(),c=Je(),s=c?.[o]?.content?.[i+1]||[];let l='';for(let a=1;a<t.length;a++){const i=t[a]||`列 ${a}`,o=s[a]??'',r=e[a]??'',c=String(o)!==String(r);l+=`\n                <div class="acu-row-edit-field ${c?'acu-field-changed':''}">\n                    <div class="acu-row-edit-label">${n(i)} ${c?'<span class="acu-changed-badge">已改</span>':''}</div>\n                    ${c?`<div class="acu-row-edit-old">${n(o)||'<span class="acu-empty-val">(空)</span>'}</div>`:''}\n                    <textarea class="acu-row-edit-input acu-edit-textarea" data-col="${a}" spellcheck="false" rows="1">${n(r)}</textarea>\n                </div>\n            `}const d=$(`\n            <div class="acu-edit-overlay">\n                <div class="acu-edit-dialog acu-theme-${r.theme}" style="max-width:550px;">\n                    <div class="acu-edit-title">整体编辑: ${n(a)} - ${n(e[1]||'行 '+(i+1))}</div>\n                    <div class="acu-settings-content" style="flex:1; overflow-y:auto; padding:15px; max-height:60vh;">\n                        ${l}\n                    </div>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-row-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn" id="dlg-row-revert"><i class="fa-solid fa-rotate-left"></i> 全部恢复</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-row-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(d);const u=e=>{e.style.height='auto',e.style.height=Math.min(e.scrollHeight+2,200)+'px'};d.find('textarea').each(function(){u(this)}),d.find('textarea').on('input',function(){u(this)});const p=()=>d.remove();d.find('#dlg-row-cancel').click(p),d.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&p()}),d.find('#dlg-row-revert').click(function(){d.find('textarea').each(function(){const e=parseInt($(this).data('col'));$(this).val(s[e]??'').trigger('input')})}),d.find('#dlg-row-save').click(async()=>{let e=xe||zt();if(!e?.[o]?.content?.[i+1])return void p();const t=e[o].content[i+1];let a=!1;if(d.find('textarea').each(function(){const e=parseInt($(this).data('col')),n=$(this).val();String(t[e])!==String(n)&&(a=!0,t[e]=n)}),a){await It(e);const a=Je();a?.[o]?.content&&(a[o].content[i+1]=[...t],He(a)),me=Ct(e),Jt()}p()})},Qt=e=>{const t=$t(),a=Z.findTable(e,'global'),i=Z.findTable(e,'player'),o=Z.findTable(e,'location'),r=Z.findTable(e,'npc'),c=Z.findTable(e,'quest'),s=Z.findTable(e,'bag'),l=Z.findTable(e,'skill'),d=Z.findTable(e,'equip');let u={name:'主角',status:'正常',position:'',attrs:'',money:'0'};const p=Z.parseRows(i,'player');if(p.length>0){const e=p[0];if(u.name=e.name||'主角',u.status=e.status||'正常',u.position=e.position||'',u.money=e.money||'',u.resources='',i?.data?.headers&&i?.data?.rows?.[0]){const e=i.data.headers,t=i.data.rows[0];let a='';e.forEach((e,n)=>{if(e&&e.includes('属性')){const e=t[n];e&&(a+=(a?'; ':'')+e)}}),u.attrs=a,e.forEach((e,a)=>{if(e&&(e.includes('资源')||e.includes('金钱'))){const e=t[a];e&&(u.resources=e)}})}}const g=i?.data?.rows||[],f=i?.data?.headers||[];let b='',m='';if(a?.data?.rows?.length>0){const e=a.data.headers||[],t=a.data.rows[0],n=Z.findColumnIndex(e,'detailLocation',a.config);n>=0&&t[n]&&(b=t[n]);const i=Z.findColumnIndex(e,'currentLocation',a.config);m=i>=0&&t[i]?t[i]:t[2]||''}let h=b||m||(u.position.includes('-')?u.position.split('-')[0].trim():u.position);const v=r?.name||'重要人物表',x=r?.key||'',y=Z.parseRows(r,'npc');let w=[],k=[];y.forEach(e=>{const t=String(e.inScene||'').toLowerCase(),a={name:e.name||'未知',status:e.status||'',position:e.position||'',index:e._rowIndex};'true'===t||'在场'===t?w.push(a):k.push(a)});let C=[...w,...k];const S=c?.name||'备忘事项',T=Z.parseRows(c,'quest'),A=Z.applyFilter(T,'active','quest'),I=e=>{const t=String(e||'').toLowerCase();return t.includes('主线')?0:t.includes('支线')?1:t.includes('日常')?2:3};let M=A.map(e=>({name:e.name||'任务',type:e.type||'',progress:e.progress||'',_rowIndex:e._rowIndex})).sort((e,t)=>I(e.type)-I(t.type)).slice(0,5);const B=s?.name||'背包物品表',E=Z.parseRows(s,'bag');let P=E.slice(0,6).map(e=>({name:e.name||'未知物品',count:e.count||'1',type:e.type||''}));const N=l?.name||'主角技能表',D=Z.parseRows(l,'skill');let j=D.slice(0,6).map(e=>({name:e.name||'未知技能',level:e.level||'',type:e.type||''}));const F=d?.name||'装备表',O=Z.parseRows(d,'equip');let R=Z.applyFilter(O,'equipped','equip').slice(0,4).map(e=>({name:e.name||'未知装备',type:e.type||'',part:e.part||''}));const V=o?.name||'世界地图点',Y=o?.key||'',q=Z.parseRows(o,'location');return`\n        <div class="acu-panel-header">\n            <div class="acu-panel-title">\n                <div class="acu-title-main"><i class="fa-solid fa-chart-line"></i> <span class="acu-title-text">仪表盘</span></div>\n                <div class="acu-title-sub">综合状态总览</div>\n            </div>\n            <div class="acu-header-actions">\n                <div class="acu-height-control">\n                    <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="仪表盘" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                </div>\n                <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n            </div>\n        </div>\n        <div class="acu-panel-content acu-dashboard-content">\n            <div class="acu-dash-body ${'horizontal'===t.layout?'acu-dash-horizontal':''}">\n            \x3c!-- 左列：主角状态 + 技能 --\x3e\n                <div class="acu-dash-player">\n                    <h3 class="acu-dash-clickable acu-dash-preview-trigger"\n                        data-table-key="${i?.key||''}"\n                        data-row-index="0"\n                        data-preview-type="player"\n                        style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-user-circle"></i> ${n(L(u.name))}</span>\n                        <span style="font-size:11px;font-weight:normal;color:var(--acu-text-main);background:var(--acu-badge-bg);padding:2px 8px;border-radius:10px;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${n(u.status)}">${n(u.status.length>6?u.status.substring(0,6)+'..':u.status)}</span>\n                    </h3>\n                    <div class="acu-player-status" style="margin-bottom:8px;">\n                        ${(()=>{const e=u.resources||u.money||'',t=ce(e);return t.length>0?`<div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:52px;overflow-y:auto;margin-bottom:6px;padding-bottom:6px;border-bottom:1px dashed var(--acu-border);">\n                                    ${t.slice(0,4).map(e=>`\n                                        <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;">\n                                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${n(e.name)}">${n(e.name.substring(0,3))}</span>\n                                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                                <span style="color:var(--acu-accent);font-size:11px;font-weight:bold;">${e.value}</span>\n                                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${e.value}" data-name="${n(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="以${e.name}(${e.value})进行检定"></i>\n                                            </div>\n                                        </div>\n                                    `).join('')}\n                                </div>`:''})()}\n        ${(()=>{let e=[];if(g.length>0&&f.length>0){const t=g[0];f.forEach((a,n)=>{if(a&&a.includes('属性')){ce(t[n]||'').forEach(t=>{e.some(e=>e.name===t.name)||e.push(t)})}})}return e.length>0?`<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px 6px;max-height:78px;overflow-y:auto;overflow-x:hidden;">\n                    ${e.map(e=>`\n                        <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;border-bottom:1px dashed var(--acu-border);min-width:0;">\n                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${n(e.name)}">${n(e.name.substring(0,2))}</span>\n                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                <span style="color:var(--acu-text-main);font-size:11px;font-weight:bold;">${e.value}</span>\n                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${e.value}" data-name="${n(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="以${e.name}(${e.value})进行检定"></i>\n                            </div>\n                        </div>\n                    `).join('')}\n                </div>`:''})()}\n                    </div>\n\n                    <h4 class="acu-dash-table-link" data-table="${n(N)}" style="font-size:12px;color:var(--acu-accent);margin:10px 0 6px 0;"><i class="fa-solid fa-bolt"></i> 技能 (${D.length})</h4>\n                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:2px 6px;max-height:78px;overflow-y:auto;overflow-x:hidden;">\n                    ${j.length>0?j.map((e,t)=>{const a=re(e.level),i=a>0,o=D.findIndex(t=>t.name===e.name);return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${l?.key||''}"\n                            data-row-index="${o>=0?o:t}"\n                            data-preview-type="skill"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:2px 3px;border-bottom:1px dashed var(--acu-border);min-width:0;cursor:pointer;">\n                            <span style="color:var(--acu-text-sub);font-size:10px;white-space:nowrap;" title="${n(e.name)}">${n(e.name.length>5?e.name.substring(0,5)+'..':e.name)}</span>\n                            <div style="display:flex;align-items:center;gap:2px;flex-shrink:0;">\n                                ${i?`<span style="color:var(--acu-text-main);font-size:11px;font-weight:bold;">${a}</span>\n                                <i class="fa-solid fa-dice-d20 acu-dash-dice-btn" data-target="${a}" data-name="${n(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="以${e.name}(${a})进行检定"></i>`:`<span style="color:var(--acu-text-sub);font-size:10px;">${n(e.level||'-')}</span>`}\n                            </div>\n                        </div>`}).join(''):'<div style="grid-column:1/-1;text-align:center;color:var(--acu-text-sub);padding:8px;font-size:11px;">暂无技能</div>'}\n                    </div>\n                </div>\n\n                \x3c!-- 中列：地点 + NPC --\x3e\n                <div class="acu-dash-locations">\n                    <h3 class="acu-dash-table-link" data-table="${n(V)}"><i class="fa-solid fa-map"></i> 地点 (${q.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:100px;overflow-y:auto;overflow-x:hidden;margin-bottom:10px;">\n                    ${q.length>0?q.map((e,t)=>{const a=e.name||'未知',i=h&&(a.includes(h)||h.includes(a));return`<div class="acu-location-item acu-dash-clickable acu-dash-preview-trigger ${i?'acu-current-location':''}"\n                            data-table-key="${n(Y)}"\n                            data-row-index="${e._rowIndex}"\n                            data-preview-type="location">\n                            <span>\n                                ${i?'<i class="fa-solid fa-location-dot"></i>':'<i class="fa-solid fa-map-pin" style="font-size:9px;opacity:0.4;"></i>'}\n                                <span title="${n(a)}">${n(a)}</span>\n                            </span>\n                            ${i?'<i class="fa-solid fa-street-view" style="flex-shrink:0;" title="您在这里"></i>':`<i class="fa-solid fa-walking acu-dash-goto-btn" data-location="${n(a)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;flex-shrink:0;" title="前往${a}"></i>`}\n                        </div>`}).join(''):'<div class="acu-empty-hint">暂无地点数据</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${n(v)}" style="margin-top:10px;display:flex;justify-content:space-between;align-items:center;">\n                        <span><i class="fa-solid fa-users"></i> 角色 (${C.length})</span>\n                        <span style="display:flex;gap:8px;">\n                            <i class="fa-solid fa-project-diagram acu-dash-relation-graph-btn" title="人物关系图" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                            <i class="fa-solid fa-user-circle acu-dash-avatar-manager-btn" title="头像管理" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.6;font-size:12px;padding:4px;"></i>\n                        </span>\n                    </h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:150px;overflow-y:auto;overflow-x:hidden;">\n                    ${C.length>0?C.slice(0,12).map((e,t)=>{const a=w.some(t=>t.name===e.name),i=t===Math.min(C.length,12)-1,o=U.get(e.name),r=U.getOffsetX(e.name),c=U.getOffsetY(e.name),s=U.getScale(e.name),l=o?`background-image:url('${o}');background-size:${s}%;background-position:${r}% ${c}%;`:'',d=a?'':'filter:grayscale(80%) brightness(0.7);opacity:0.5;';return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${n(x)}"\n                            data-row-index="${e.index}"\n                            data-preview-type="npc"\n                            style="padding:6px 4px;${i?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <span class="acu-task-name" style="font-size:12px;display:flex;align-items:center;gap:6px;">\n                                    <span class="acu-dash-npc-avatar" style="width:22px;height:22px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:var(--acu-btn-bg);border:1.5px solid ${a?'var(--acu-accent)':'var(--acu-border)'};${l}${d}" title="${a?'在场':'不在场'}">\n                                        ${o?'':`<span style="font-size:10px;font-weight:bold;color:var(--acu-text-sub);${d}">${n(e.name.charAt(0))}</span>`}\n                                    </span>\n                                    <span title="${n(e.name)}" style="${a?'':'opacity:0.6;'}">${n(e.name.length>4?e.name.substring(0,4)+'..':e.name)}</span>\n                                </span>\n                                <div style="display:flex;align-items:center;">\n                                    <i class="fa-solid fa-people-arrows acu-dash-contest-btn" data-npc="${n(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:11px;" title="与${e.name}进行对抗检定"></i>\n                                </div>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">暂无重要人物</div>'}\n                    </div>\n                </div>\n\n                \x3c!-- 右列：背包 + 技能 + 任务 --\x3e\n                <div class="acu-dash-intel">\n                    <h3 class="acu-dash-table-link" data-table="${n(B)}"><i class="fa-solid fa-bag-shopping"></i> 物品 (${E.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:80px;overflow-y:auto;margin-bottom:10px;">\n                    ${P.length>0?P.map((e,t)=>{const a=t===P.length-1;return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${s?.key||''}"\n                            data-row-index="${t}"\n                            data-preview-type="bag"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:5px 4px;font-size:11px;cursor:pointer;${a?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <span style="color:var(--acu-text-main);flex:1;white-space:nowrap;" title="${n(e.name)}">${n(e.name.length>4?e.name.substring(0,4)+'..':e.name)}</span>\n                            <div style="display:flex;align-items:center;gap:6px;">\n                                <i class="fa-solid fa-hand-pointer acu-dash-use-item-btn" data-item="${n(e.name)}" style="cursor:pointer;color:var(--acu-text-sub);opacity:0.4;font-size:10px;" title="使用${e.name}"></i>\n                                <span style="color:var(--acu-accent);font-weight:bold;">${n(e.count)}</span>\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">背包为空</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${n(F)}" style="margin-top:10px;"><i class="fa-solid fa-shield-halved"></i> 装备 (${R.length})</h3>\n                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px 6px;max-height:80px;overflow-y:auto;margin-bottom:10px;">\n                    ${R.length>0?R.map((e,t)=>{const a=t===R.length-1;return`<div class="acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${d?.key||''}"\n                            data-row-index="${O.findIndex(t=>t.name===e.name)}"\n                            data-preview-type="equipment"\n                            style="display:flex;justify-content:space-between;align-items:center;padding:5px 4px;font-size:11px;cursor:pointer;${a?'':'border-bottom:1px dashed var(--acu-border);'}">\n                            <span style="color:var(--acu-text-main);" title="${n(e.name)}">${n(e.name.length>5?e.name.substring(0,5)+'..':e.name)}</span>\n                            <span style="color:var(--acu-text-sub);font-size:10px;">${n(e.part||e.type)}</span>\n                        </div>`}).join(''):'<div class="acu-empty-hint">无装备</div>'}\n                    </div>\n\n                    <h3 class="acu-dash-table-link" data-table="${n(S)}" style="margin-top:10px;"><i class="fa-solid fa-clipboard-list"></i> 任务 (${M.length})</h3>\n                    ${M.length>0?M.map((e,t)=>{const a=String(e.type||'').includes('主线');let i=null;const o=String(e.progress||'').match(/(\d+)\s*%/);o&&(i=Math.min(100,Math.max(0,parseInt(o[1],10))));const r=null!==i?`<div style="width:40px;height:4px;background:var(--acu-border);border-radius:2px;overflow:hidden;"><div style="width:${i}%;height:100%;background:var(--acu-accent);"></div></div>`:'';return`<div class="acu-task-item acu-dash-clickable acu-dash-preview-trigger"\n                            data-table-key="${c?.key||''}"\n                            data-row-index="${void 0!==e._rowIndex?e._rowIndex:T.findIndex(t=>t.name===e.name)}"\n                            data-preview-type="quest"\n                            style="padding:4px 8px;margin-bottom:3px;cursor:pointer;">\n                            <div style="display:flex;justify-content:space-between;align-items:center;">\n                                <div class="acu-task-name" style="font-size:11px;${a?'font-weight:600;':''}">${n(e.name)}</div>\n                                ${r}\n                            </div>\n                        </div>`}).join(''):'<div class="acu-empty-hint">无进行中任务</div>'}\n                </div>\n            </div>\n    `},Zt=(e,i)=>{if(!e||!e.rows.length)return`\n            <div class="acu-panel-header"><div class="acu-panel-title"><i class="fa-solid ${De(i)}"></i> ${i}</div><button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button></div>\n            <div class="acu-panel-content"><div style="text-align:center;color:var(--acu-text-sub);padding:20px;">暂无数据</div></div>`;const o=$t(),r=Le()[e.key]||[],c=(e.headers||[]).slice(1),s='grid'===((Ge()||{})[i]||'list');let l=1;if(1===e.headers.length)l=0;else if(i.includes('总结')||i.includes('大纲')){const t=e.headers.findIndex(e=>e&&(e.includes('索引')||e.includes('编号')||e.includes('代码')));t>0&&(l=t)}let d=e.rows.map((n,o)=>{const r=t.getRowKey(i,n,e.headers);return{data:n,originalIndex:o,rowKey:r,isBookmarked:r&&a.isBookmarked(i,r)}});const u=(ke[i]||'').toLowerCase().trim(),p=(e=>Ze().includes(e))(i);u?(d=d.filter(e=>e.data.some(e=>String(e).toLowerCase().includes(u))),d.sort((e,t)=>{if(e.isBookmarked&&!t.isBookmarked)return-1;if(!e.isBookmarked&&t.isBookmarked)return 1;const a=String(e.data[l]||'').toLowerCase(),n=String(t.data[l]||'').toLowerCase(),i=a.includes(u),o=n.includes(u);return a===u&&n!==u?-1:a!==u&&n===u?1:i&&!o?-1:!i&&o?1:e.originalIndex-t.originalIndex})):d.sort((e,t)=>e.isBookmarked&&!t.isBookmarked?-1:!e.isBookmarked&&t.isBookmarked?1:p?t.originalIndex-e.originalIndex:e.originalIndex-t.originalIndex);const g=o.itemsPerPage||50,f=d.length,b=Math.ceil(f/g)||1;let m=we[i]||1;m>b&&(m=b),m<1&&(m=1),we[i]=m;const h=(m-1)*g,v=h+g,x=d.slice(h,v),y=(e=>!!e&&['总结','大纲','日志','记录','历史'].some(t=>e.includes(t)))(i),w=y?`\n            <button class="acu-view-btn acu-reverse-btn" data-table="${n(i)}" title="${p?'当前：倒序（新→旧），点击切换为正序':'当前：正序（旧→新），点击切换为倒序'}">\n                <i class="fa-solid ${p?'fa-sort-amount-up':'fa-sort-amount-down'}"></i>\n            </button>\n        `:'';let k=`\n            <div class="acu-panel-header">\n                <div class="acu-panel-title">\n    <div class="acu-title-main"><i class="fa-solid ${De(i)}"></i> <span class="acu-title-text">${n(i)}</span></div>\n    <div class="acu-title-sub">(${h+1}-${Math.min(v,f)} / 共${f}项)${p?' <span style="color:var(--acu-accent);">↓倒序</span>':''}</div>\n</div>\n                <div class="acu-header-actions">\n                    ${i.includes('人物')?`<button class="acu-view-btn" id="acu-btn-relation-graph" data-table="${n(i)}" title="查看人物关系图"><i class="fa-solid fa-project-diagram"></i></button>`:''}\n                    ${w}\n                    <button class="acu-view-btn" id="acu-btn-switch-style" data-table="${n(i)}" title="🔄 点击切换视图模式 (当前: ${s?'双列网格':'单列列表'})">\n                        <i class="fa-solid ${s?'fa-th-large':'fa-list'}"></i>\n                    </button>\n                    <div class="acu-height-control">\n                        <i class="fa-solid fa-arrows-up-down acu-height-drag-handle" data-table="${n(i)}" title="↕️ 拖动调整面板高度 | 双击恢复默认"></i>\n                    </div>\n\n                    <div class="acu-search-wrapper"><i class="fa-solid fa-search acu-search-icon"></i><input type="text" class="acu-search-input" placeholder="搜索全部..." value="${(ke[i]||'').replace(/"/g,'&quot;')}" /></div>\n                    <button class="acu-close-btn" title="关闭"><i class="fa-solid fa-times"></i></button>\n                </div>\n            </div>\n            <div class="acu-panel-content"><div class="acu-card-grid">`;if(k+=x.map(d=>{const u=d.originalIndex,p=d.data,g=r.includes(u),f=p[l]||'未命名',b=1===l,m=`${e.key}-${u}-${l}`,h=window.acuModifiedSet&&window.acuModifiedSet.has(m),v=me.has(`${i}-row-${u}`);let x='';o.highlightNew&&(h?x='acu-highlight-manual':v&&(x='acu-highlight-diff'));const y=p.map((_,e)=>e).filter(e=>e>0&&e!==l),w=y.length%2==1,k=p.map((a,r)=>{if(r<=0||r===l)return'';if((c[r-1]||'').includes('交互'))return'';const s=r===y[y.length-1]&&w,d=c[r-1]||'属性'+r,g=d.replace(/[\(（\[【][^)）\]】]*[\)）\]】]/g,'').trim(),f=e=>String(e).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'),b=String(a).trim(),m=L(b),h=['-','--','—','null','none','无','空','n/a','undefined','/','nil'];if(h.includes(m.toLowerCase()))return'';let v='',x=!1;const k=/[;；]/,C=e=>{if(!e)return!1;return String(e).toLowerCase().includes('身份')},S=C(d)?[]:ce(m);if(C(d)){const e=je(m),t=''===f(m)&&'0'!==String(a)?'&nbsp;':f(m);v=e?'<span class="acu-badge '+e+'">'+t+'</span>':t}else if(le(m,g)){const e=se(m).filter(e=>!e.relation||!h.includes(e.relation.toLowerCase()));if(fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:19252',message:'Relationship cell detected',data:{rawStr:m,headerName:g,validRelationsCount:e.length,relations:e.map(e=>({name:e.name,relation:e.relation}))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{}),e.length>1){x=!0;let t='';for(let a=0;a<e.length;a++){const n=e[a],i=a<e.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:19261',message:'Multiple relations branch',data:{relationIndex:a,totalCount:e.length,usingSpaceBetween:!1,usingGap:!0},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'A'})}).catch(()=>{}),t+='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;'+i+'">',t+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+f(n.name)+'</span>',n.relation&&(t+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+f(n.relation)+'</span>'),t+='</div>'}v='<div class="acu-relation-container">'+t+'</div>'}else if(1===e.length){x=!0;const t=e[0];fetch('http://127.0.0.1:7242/ingest/7c4bc8bf-cf84-42b5-922f-1ccaf176cc30',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ts:19283',message:'Single relation branch',data:{name:t.name,relation:t.relation,usingSpaceBetween:!1,usingGap:!0},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'A'})}).catch(()=>{}),v='<div style="display:flex;align-items:center;gap:8px;padding:3px 0;">',v+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+f(t.name)+'</span>',t.relation&&(v+='<span style="color:var(--acu-text-main);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">'+f(t.relation)+'</span>'),v+='</div>'}}else if(S.length>1){x=!0;let e='';for(let t=0;t<S.length;t++){const a=S[t];e+='<div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;">',e+='<span style="color:var(--acu-text-sub);font-size:0.9em;white-space:nowrap;" title="'+f(a.name)+'">'+f(a.name.length>3?a.name.substring(0,5):a.name)+'</span>',e+='<div style="display:flex;align-items:center;gap:4px;">',e+='<span style="color:var(--acu-text-main);font-weight:bold;font-size:0.95em;">'+a.value+'</span>',e+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+f(a.name)+'" data-attr-value="'+a.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:10px;" title="检定"></i>',e+='</div></div>'}v='<div class="acu-multi-attr-container">'+e+'</div>'}else if(1===S.length){x=!0;const e=S[0];v='<div style="display:flex;justify-content:space-between;align-items:center;">',v+='<span style="color:var(--acu-text-sub);font-size:0.95em;">'+f(e.name)+'</span>',v+='<div style="display:flex;align-items:center;gap:6px;">',v+='<span style="color:var(--acu-text-main);font-weight:bold;">'+e.value+'</span>',v+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+f(e.name)+'" data-attr-value="'+e.value+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>',v+='</div></div>'}else if(m.length>0&&k.test(m)&&!m.includes('http')){const e=['-','--','—','null','none','无','空','n/a','undefined','/','nil'],t=m.split(k).map(e=>e.trim()).filter(t=>t&&!e.includes(t.toLowerCase()));if(t.length>1&&t.every(e=>e.length<=6)){v='<div class="acu-tag-container">'+t.map(e=>'<span class="acu-badge '+(je(e)||'acu-badge-neutral')+'">'+f(e)+'</span>').join('')+'</div>'}else v=t.length>0?f(t.join('; ')):''}else if(!oe(m)||m.includes(':')||m.includes('：')){const e=je(m),t=''===f(m)&&'0'!==String(a)?'&nbsp;':f(m);v=e?'<span class="acu-badge '+e+'">'+t+'</span>':t}else{const e=re(m);v='<div style="display:flex;justify-content:space-between;align-items:center;">',v+='<span>'+f(m)+'</span>',v+='<i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="'+f(g)+'" data-attr-value="'+e+'" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>',v+='</div>'}const T=me.has(i+'-'+u+'-'+r),A=e.key+'-'+u+'-'+r,I=window.acuModifiedSet&&window.acuModifiedSet.has(A);let M='';o.highlightNew&&(I?M='acu-highlight-manual':T&&(M='acu-highlight-diff'));const B=t.getRowKey(i,p,e.headers),E=B&&t.isFieldLocked(i,B,c[r-1])?'<i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:10px;margin-left:4px;opacity:0.7;" title="已锁定"></i>':'';return'<div class="'+('acu-card-row acu-cell'+(s?' acu-grid-span-full':'')+(x?' acu-hide-label':''))+'" data-key="'+n(e.key)+'" data-tname="'+n(i)+'" data-row="'+u+'" data-col="'+r+'" data-val="'+encodeURIComponent(a??'')+'"><div class="acu-card-label">'+g+E+'</div><div class="acu-card-value '+M+'">'+v+'</div></div>'}).join('');let C=ie(i),S='';const T=c.findIndex(e=>e&&e.includes('交互'));if(T>=0&&p[T+1]){const e=['-','null','none','无','空','n/a','undefined','/'],t=String(p[T+1]).split(/[,，、;；]/).map(e=>e.trim()).filter(t=>t&&!e.includes(t.toLowerCase()));if(t.length>0){const e=C.map(e=>e.label.toLowerCase()),a={战斗:'fa-hand-fist',攻击:'fa-hand-fist',交谈:'fa-comments',对话:'fa-comments',观察:'fa-eye',查看:'fa-eye',使用:'fa-hand-pointer',赠送:'fa-gift',送礼:'fa-gift',丢弃:'fa-trash',装备:'fa-shield-halved',邀约:'fa-calendar-check',告别:'fa-hand',求爱:'fa-heart',表演:'fa-music'},n=t.filter(t=>!e.includes(t.toLowerCase())).map(e=>({label:e,icon:a[e]||'fa-hand-pointer',type:'prompt',template:`<user>${e}{Name}。`,auto_send:!0}));C=[...C,...n]}}if(C.length>0){p[l];S=`<div class="acu-card-actions">${C.map((e,t)=>`<button class="acu-action-item ${'check'===e.type?'check-type':''}" data-action-idx="${t}" data-row="${u}"><i class="fa-solid ${e.icon||'fa-play'}"></i> ${n(e.label)}</button>`).join('')}</div>`}const A=t.getRowKey(i,p,e.headers),I=A&&t.isRowLocked(i,A)?' <i class="fa-solid fa-lock" style="color:var(--acu-accent);font-size:11px;opacity:0.8;" title="整行已锁定"></i>':'',M=t.getRowKey(i,p,e.headers),B=M&&a.isBookmarked(i,M),E=M?`<i class="${B?'fa-solid':'fa-regular'} fa-bookmark acu-bookmark-icon ${B?'bookmarked':''}" data-table="${n(i)}" data-row-key="${n(M)}" title="${B?'取消书签':'添加书签'}"></i>`:'';return`<div class="acu-data-card ${g?'pending-deletion':''}"><div class="acu-card-header"><span class="acu-card-index">${b?'#'+(u+1):''}</span><span class="acu-cell acu-editable-title ${x}" data-key="${n(e.key)}" data-tname="${n(i)}" data-row="${u}" data-col="${l}" data-val="${encodeURIComponent(f??'')}" title="点击编辑标题">${n(f)}${I}</span>${E}</div><div class="acu-card-body ${s?'view-grid':'view-list'}">${k}</div>${S}</div>`}).join(''),k+='</div></div>',b>1){k+=`<div class="acu-panel-footer"><button class="acu-page-btn ${1===m?'disabled':''}" data-page="${m-1}" ${1===m?'disabled':''}><i class="fa-solid fa-chevron-left"></i></button>`;const e=[];if(b<=7)for(let t=1;t<=b;t++)e.push(t);else m<=4?e.push(1,2,3,4,5,'...',b):m>=b-3?e.push(1,'...',b-4,b-3,b-2,b-1,b):e.push(1,'...',m-1,m,m+1,'...',b);e.forEach(e=>{k+='...'===e?'<span class="acu-page-info">...</span>':`<button class="acu-page-btn ${e===m?'active':''}" data-page="${e}">${e}</button>`}),k+=`<button class="acu-page-btn ${m===b?'disabled':''}" data-page="${m+1}" ${m===b?'disabled':''}><i class="fa-solid fa-chevron-right"></i></button></div>`}return k},ea=()=>{const{$}=Pe(),e=Oe(),t=$('.acu-panel-content');if(e&&t.length){const a={};t.find('.acu-data-card, .acu-card-body, .acu-edit-textarea').each(function(){if(this.scrollTop>0){const e=$(this).closest('.acu-data-card').find('.acu-editable-title').data('row'),t=$(this).hasClass('acu-edit-textarea');if(void 0!==e){a[t?`edit-${e}`:e]=this.scrollTop}}}),Se[e]={left:t.scrollLeft(),top:t.scrollTop(),inner:a,timestamp:Date.now()}}},ta=()=>{const{$}=Pe();ea(),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active'),Re(null)},aa=e=>{const{$}=Pe(),t=$('.acu-wrapper');t.on('click','.acu-dash-relation-graph-btn',function(e){e.stopPropagation();const t=Mt(xe||zt()),a=Z.findTable(t,'npc');a&&a.data?ht(a.data):window.toastr&&window.toastr.warning('未找到人物数据')}),t.on('click','.acu-dash-avatar-manager-btn',function(e){e.stopPropagation();const t=Mt(xe||zt()),a=Z.findTable(t,'npc'),n=Z.findTable(t,'player'),i=[];n?.data?.rows?.[0]&&i.push({name:n.data.rows[0][1]||'主角',isPlayer:!0}),a?.data?.rows&&a.data.rows.forEach((e,t)=>{e[1]&&i.push({name:e[1],isPlayer:!1,rowIndex:t})}),i.length>0?xt(i,()=>Lt()):window.toastr&&window.toastr.warning('未找到人物数据')}),t.on('click','.acu-dash-table-link',function(e){e.stopPropagation();const t=$(this).data('table');t&&(Fe.set(f,!1),Re(t),Lt())}),$('.acu-panel-content').off('touchstart.acu_swipe touchmove.acu_swipe').on('touchstart.acu_swipe',function(e){this._touchStartX=e.originalEvent.touches[0].clientX,this._touchStartY=e.originalEvent.touches[0].clientY}).on('touchmove.acu_swipe',function(e){if(!this._touchStartX)return;const t=Math.abs(e.originalEvent.touches[0].clientX-this._touchStartX);t>Math.abs(e.originalEvent.touches[0].clientY-this._touchStartY)&&t>10&&e.stopPropagation()}),$('body').off('click.acu_nav_toggle').on('click.acu_nav_toggle','.acu-nav-toggle-btn',function(e){if(e.stopPropagation(),e.preventDefault(),fe)return;const t=qe();Xe(!t),Lt()});const o=$('.acu-panel-content');if(o.length){let e=null;o.off('scroll.acu_save').on('scroll.acu_save',function(){const t=$(this);e&&clearTimeout(e),e=setTimeout(()=>{const e=Oe();e&&(Se[e]||(Se[e]={top:0,left:0,inner:{}}),Se[e].top=t.scrollTop(),Se[e].left=t.scrollLeft())},200)})}$('body').off('click.acu_delegate').on('click.acu_delegate','.acu-wrapper',function(e){if(fe)return;const t=$(e.target);if(t.closest('#acu-btn-settings').length)return e.stopPropagation(),e.preventDefault(),void Rt();const a=t.closest('.acu-nav-btn');if(a.length){if('acu-btn-dashboard'===a.attr('id')){e.preventDefault(),e.stopImmediatePropagation();const t=Fe.get(f,!1),n=$('#acu-data-area').hasClass('visible');if(t&&n)Fe.set(f,!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active');else{Fe.set(f,!0),Re(null),$('.acu-nav-btn').removeClass('active'),a.addClass('active');const e=xe||zt(),t=Mt(e||{});$('#acu-data-area').html(Qt(t)).addClass('visible'),aa(t)}return!1}if('acu-btn-changes'===a.attr('id')){e.preventDefault(),e.stopImmediatePropagation();const t=Fe.get('acu_changes_panel_active',!1),n=$('#acu-data-area').hasClass('visible');if(t&&n)Fe.set('acu_changes_panel_active',!1),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active');else{Fe.set('acu_changes_panel_active',!0),Fe.set(f,!1),Re(null),$('.acu-nav-btn').removeClass('active'),a.addClass('active');const e=xe||zt();$('#acu-data-area').html(qt(e)).addClass('visible'),Xt()}return!1}if('acu-btn-mvu'===a.attr('id')){e.preventDefault(),e.stopImmediatePropagation();const t=Oe()===V.MODULE_ID,n=$('#acu-data-area').hasClass('visible');if(t&&n)Re(null),$('#acu-data-area').removeClass('visible'),$('.acu-nav-btn').removeClass('active');else{Fe.set(f,!1),Fe.set('acu_changes_panel_active',!1),Re(V.MODULE_ID),$('.acu-nav-btn').removeClass('active'),a.addClass('active');const e=$('#acu-data-area');try{const t=V.renderPanel(),a=We()[V.MODULE_ID];a?e.css('height',a+'px').addClass('acu-manual-mode'):e.css('height','').removeClass('acu-manual-mode'),e.html('<div class="acu-mvu-panel">'+t+'</div>').addClass('visible'),V.bindEvents(e)}catch(e){console.error('[MVU] Error rendering panel:',e)}V.getDataWithRetry(5,800).then(t=>{t&&(e.html('<div class="acu-mvu-panel">'+V.renderPanel()+'</div>'),V.bindEvents(e))}).catch(t=>{console.error('[MvuModule] Error getting data:',t),e.html('<div class="acu-mvu-panel">'+V.renderPanel()+'</div>'),V.bindEvents(e)})}return!1}e.stopPropagation(),Fe.set(f,!1),Fe.set('acu_changes_panel_active',!1);const t=a.data('table'),n=Oe();return n===t&&$('#acu-data-area').hasClass('visible')?void ta():($('.acu-nav-btn').removeClass('active'),a.addClass('active'),$('.acu-panel-content').length&&n&&ea(),Re(t),void setTimeout(()=>Lt(),0))}const n=t.closest('.acu-cell');if(n.length)return e.stopPropagation(),void na(e,n[0]);const i=t.closest('.acu-page-btn');if(i.length){if(e.stopPropagation(),i.hasClass('disabled')||i.hasClass('active'))return;const t=parseInt(i.data('page')),a=Oe();return void(a&&(we[a]=t,Lt(),requestAnimationFrame(()=>{$('.acu-panel-content').scrollTop(0)})))}}),$('#acu-btn-expand').off('click').on('click',e=>{e.stopPropagation(),fe||(Xe(!1),Lt())}),$('#acu-btn-collapse').off('click').on('click',e=>{e.stopPropagation(),fe||(Xe(!0),Lt())}),$('#acu-btn-refresh').off('click').on('click',async e=>{if(e.stopPropagation(),fe)return;if(ge)return void(window.toastr&&window.toastr.warning('⏳ 正在后台同步数据，无法撤销，请稍后...'));$(e.currentTarget).find('i');Ue({}),xe=null,ye=!1,me.clear(),window.acuModifiedSet&&window.acuModifiedSet.clear();const t=$('#acu-btn-save-global');t.find('i').removeClass('acu-icon-breathe'),t.attr('title','保存所有修改').css('color','');const a=Je();a&&(xe=a),$('.acu-edit-overlay, .acu-cell-menu, .acu-menu-backdrop').remove(),Lt()}),$('#acu-btn-force-update').off('click').on('click',async e=>{if(e.stopPropagation(),fe)return;const t=Pe().getDB();if(t&&'function'==typeof t.manualUpdate)try{await t.manualUpdate()}catch(e){console.error('[ACU] 手动更新失败:',e),window.toastr&&window.toastr.error('手动更新触发失败')}else window.toastr&&window.toastr.warning('⚠ 后端脚本未提供 manualUpdate 接口，请确保同时也更新了最新的后端脚本')}),$('body').off('click.acu_settings').on('click.acu_settings','#acu-btn-settings',function(e){e.stopPropagation(),e.preventDefault(),fe||Rt()}),$('#acu-btn-dice-nav').off('click').on('click',e=>{e.stopPropagation(),fe||ft({targetValue:null,targetName:'自由检定'})}),$('#acu-btn-refill').off('click').on('click',async e=>{if(e.stopPropagation(),fe)return;const t=Pe().getDB();if(t&&'function'==typeof t.manualUpdate)try{console.log('[ACU] 手动填表触发'),await t.manualUpdate()}catch(e){console.error('[ACU] 手动填表失败:',e)}else console.warn('[ACU] manualUpdate API 不可用')}),$('#acu-btn-save-global').off('click').on('click',async function(e){if(e.stopPropagation(),fe)return;let t=null;if(t=ye&&xe?xe:zt(),t){await At(t,!0,!0),$('.acu-highlight-manual').removeClass('acu-highlight-manual'),window.acuModifiedSet&&window.acuModifiedSet.clear(),ye=!1;const e=$(this);e.find('i').removeClass('acu-icon-breathe fa-spinner fa-spin').addClass('fa-save'),e.attr('title','保存所有修改').css('color',''),e.prop('disabled',!1)}else window.toastr&&window.toastr.error('无法获取有效数据，保存失败')});const r=$('.acu-search-input');if(r.length){let e,t=!1;r.off('compositionstart compositionend input').on('compositionstart',()=>{t=!0}).on('compositionend',function(){t=!1;const e=$(this).val(),a=Oe();a&&(ke[a]=e,we[a]=1,Lt(),setTimeout(()=>{$('.acu-search-input').focus()},0))}).on('input',function(){if(t)return;const a=$(this).val(),n=this.selectionStart,i=this.selectionEnd;clearTimeout(e),e=setTimeout(()=>{const e=Oe();if(e){ke[e]=a,we[e]=1;const t=document.activeElement&&document.activeElement.classList.contains('acu-search-input');if(Lt(),t){const e=$('.acu-search-input');if(e.focus(),e.length&&e[0].setSelectionRange)try{e[0].setSelectionRange(n,i)}catch(e){}}}},300)})}$('#acu-btn-relation-graph').off('click').on('click',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table'),a=xe||zt();if(a)for(const e in a){const n=a[e];if(n?.name===t){const t={headers:n.content?.[0]||[],rows:n.content?.slice(1)||[],key:e};return void ht(t)}}window.toastr&&window.toastr.warning('无法获取表格数据')}),$('#acu-btn-switch-style').off('click').on('click',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table'),a=Ge(),n=a[t]||'list';var i;a[t]='grid'===n?'list':'grid',i=a,Fe.set(m,i),Lt()}),$('.acu-height-drag-handle').off('pointerdown').on('pointerdown',function(e){if(0!==e.button)return;e.preventDefault(),e.stopPropagation();const t=this;t.setPointerCapture(e.pointerId),$(t).addClass('active');const a=$('#acu-data-area'),n=a.height(),i=e.clientY,o=$(t).data('table');t.onpointermove=function(e){const t=e.clientY-i;let o=n-t;o<x&&(o=x),o>y&&(o=y),a.css('height',o+'px')},t.onpointerup=function(e){if($(t).removeClass('active'),t.releasePointerCapture(e.pointerId),t.onpointermove=null,t.onpointerup=null,o){const e=We();e[o]=parseInt(a.css('height')),Ke(e),a.addClass('acu-manual-mode')}}}),$('.acu-height-drag-handle').off('dblclick').on('dblclick',function(e){e.preventDefault(),e.stopPropagation();const t=$(this).data('table');if(t){const e=We();delete e[t],Ke(e),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),t.on('click','.acu-reverse-btn',function(e){e.stopPropagation();const t=$(this).data('table');t&&(et(t),Lt())}),$('.acu-panel-header').off('dblclick.acu').on('dblclick.acu',function(e){if($(e.target).closest('.acu-search-input, .acu-close-btn, .acu-view-btn').length)return;e.preventDefault(),e.stopPropagation();const t=Oe();if(t){const e=We();delete e[t],Ke(e),$('#acu-data-area').css('height','').removeClass('acu-manual-mode')}}),$('.acu-close-btn').off('click').on('click',function(e){e.stopPropagation();const t=$('.acu-search-input');if(t.length&&t.val())return void t.val('').trigger('input').focus();if(Fe.get(f,!1))return Fe.set(f,!1),Re(null),void Lt();if(Oe()===V.MODULE_ID)return Re(null),void Lt();ta()}),$('body').off('click.acu_bookmark').on('click.acu_bookmark','.acu-bookmark-icon',function(e){e.stopPropagation(),e.preventDefault();const t=$(this),n=t.data('table'),i=t.data('row-key');n&&i&&(a.toggleBookmark(n,i),'function'==typeof Lt&&Lt())}),$('body').off('click.acu_action').on('click.acu_action','.acu-action-item',function(e){e.stopPropagation(),e.preventDefault();const t=$(this),a=parseInt(t.data('row'),10),o=parseInt(t.data('action-idx'),10),r=t.closest('.acu-data-card').find('.acu-editable-title'),c=r.data('key'),s=r.data('tname')||'',l=xe||zt();if(!l||!l[c])return;const d=l[c].content[0]||[],u=l[c].content[a+1]||[],p=['-','null','none','无','空','n/a','undefined','/'];let g=ie(s);const f=d.findIndex(e=>e&&String(e).includes('交互'));if(f>=0&&u[f]){const e=String(u[f]).trim();if(e&&!p.includes(e.toLowerCase())){const t=e.split(/[,，、;；]/).map(e=>e.trim()).filter(e=>e&&!p.includes(e.toLowerCase()));if(t.length>0){const e=g.map(e=>e.label.toLowerCase()),a=t.filter(t=>!e.includes(t.toLowerCase())).map(e=>({label:e,icon:'fa-hand-pointer',type:'prompt',template:`<user>对{Name}进行交互：${e}。`,auto_send:!0}));g=[...g,...a]}}}const b=g[o];if(b&&'skill_check'===b.type){const e=u[1]||'技能';let t=null;const a=d.findIndex(e=>e&&e.includes('属性值')),n=d.findIndex(e=>e&&(e.includes('熟练')||e.includes('等级')));if(a>0&&u[a]){const e=re(u[a]);e>0&&(t=e)}if(null===t&&n>0&&u[n]){const e=re(u[n]);e>0&&(t=e)}const o=de(b.template,u,d);return i(o,'action'),void(null!==t&&t>0?ft({targetValue:t,targetName:e,initiatorName:'<user>'}):$('#send_textarea').focus())}if(b&&b.template){const e=xe||zt();if(e&&e[c]){const t=e[c].content[0]||[],o=e[c].content[a+1]||[],r=o[1]||'对方';if('交谈'===b.label){$t();$('.acu-msg-overlay').remove();const e=ae(),t=$(`\n                        <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2147483647;display:flex;justify-content:center;align-items:center;">\n                            <div style="background:${e.bgPanel};border:1px solid ${e.border};border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                                <div style="font-size:14px;font-weight:bold;color:${e.accent};margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                                    <i class="fa-solid fa-comment"></i> 发送消息给 ${n(r)}\n                                </div>\n                                <input type="text" id="acu-msg-input" placeholder="输入消息内容..." style="width:100%;padding:10px 12px;background:${e.inputBg} !important;border:1px solid ${e.border};border-radius:6px;color:${e.textMain} !important;font-size:14px;box-sizing:border-box;" autofocus>\n                                <div style="display:flex;gap:8px;margin-top:12px;">\n                                    <button id="acu-msg-cancel" style="flex:1;padding:8px;background:${e.inputBg};border:1px solid ${e.border};border-radius:6px;color:${e.textMain};cursor:pointer;">取消</button>\n                                    <button id="acu-msg-send" style="flex:1;padding:8px;background:${e.btnActiveBg};border:none;border-radius:6px;color:${e.btnActiveText};cursor:pointer;font-weight:bold;">发送</button>\n                                </div>\n                            </div>\n                        </div>\n                    `);$('body').append(t);const a=t[0];a.style.setProperty('position','fixed','important'),a.style.setProperty('top','0','important'),a.style.setProperty('left','0','important'),a.style.setProperty('right','0','important'),a.style.setProperty('bottom','0','important'),a.style.setProperty('width','100vw','important'),a.style.setProperty('height','100vh','important'),a.style.setProperty('display','flex','important'),a.style.setProperty('justify-content','center','important'),a.style.setProperty('align-items','center','important'),a.style.setProperty('z-index','2147483650','important'),setTimeout(()=>t.find('#acu-msg-input').focus(),50);const o=()=>{const e=t.find('#acu-msg-input').val().trim();if(e){i(`<user>对${r}说："${e}"`,'action'),$('#send_textarea').focus()}t.remove()};return t.find('#acu-msg-send').click(o),t.find('#acu-msg-input').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),o())}),t.find('#acu-msg-cancel').click(()=>t.remove()),void t.on('click',function(e){$(e.target).hasClass('acu-msg-overlay')&&t.remove()})}const s=de(b.template,o,t);i(s,'action'),$('#send_textarea').focus()}}}),$('body').off('click.acu_global_dice').on('click.acu_global_dice','#acu-btn-dice',function(e){e.stopPropagation(),ft({targetValue:50,targetName:'自定义检定',diceType:'1d100'})}),$('body').off('click.acu_location_toggle').on('click.acu_location_toggle','.acu-location-header',function(e){e.stopPropagation();$(this).closest('.acu-location-group').toggleClass('expanded')}),$('body').off('click.acu_dash_jump').on('click.acu_dash_jump','.acu-dash-jump-link, .acu-dash-loc-item',function(e){e.stopPropagation();const t=$(this).data('table'),a=$(this).data('search')||'';t&&(Fe.set(f,!1),Re(t),a&&(ke[t]=a,we[t]=1),Lt(),a&&setTimeout(()=>{const e=$('.acu-search-input');e.length&&e.focus()},100))}),$('body').off('click.acu_inline_dice').on('click.acu_inline_dice','.acu-inline-dice-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).attr('data-attr-name')||'属性',a=parseInt($(this).attr('data-attr-value'),10)||50,n=$(this).closest('.acu-data-card'),i=n.find('.acu-editable-title').text().trim(),o=(n.find('.acu-editable-title').data('tname')||'').includes('主角');ft({targetValue:a,targetName:t,initiatorName:o?'<user>':i})}),$('body').off('click.acu_dash_dice').on('click.acu_dash_dice','.acu-dash-dice-btn',function(e){e.stopPropagation(),e.preventDefault();const t=parseInt($(this).data('target'),10)||50,a=$(this).data('name')||'属性',n=$(this).data('npc')||'';if(n){const e=at('<user>',a)||50;bt({initiatorName:'<user>',initiatorValue:e,opponentName:n,opponentValue:t})}else ft({targetValue:t,targetName:a,initiatorName:'<user>'})}),$('body').off('click.acu_dash_goto').on('click.acu_dash_goto','.acu-dash-goto-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('location')||'未知地点';i(`<user>前往${t}。`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_item').on('click.acu_dash_use_item','.acu-dash-use-item-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('item')||'物品';i(`<user>使用${t}。`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_use_skill').on('click.acu_dash_use_skill','.acu-dash-use-skill-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('skill')||'技能',a=xe||zt();let n=null;if(a)for(const e in a){const i=a[e];if(i&&i.name&&i.content&&(i.name.includes('技能')||i.name.includes('能力'))){const e=i.content[0]||[],a=e.findIndex(e=>e&&(e.includes('名称')||e.includes('技能名')))||1,o=e.findIndex(e=>e&&e.includes('属性值')),r=e.findIndex(e=>e&&(e.includes('熟练')||e.includes('等级')));for(let e=1;e<i.content.length;e++){const c=i.content[e];if(c&&c[-1===a?1:a]===t){if(o>0&&c[o]){const e=re(c[o]);if(e>0){n=e;break}}if(r>0&&c[r]){const e=re(c[r]);if(e>0){n=e;break}}break}}if(null!==n)break}}i(`<user>使用${t}。`,'action'),null!==n&&n>0?ft({targetValue:n,targetName:t,initiatorName:'<user>'}):$('#send_textarea').focus()}),$('body').off('click.acu_dash_track_task').on('click.acu_dash_track_task','.acu-dash-track-task-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('task')||'任务';i(`<user>将${t}设为当前追踪目标。`,'action'),$('#send_textarea').focus()}),$('body').off('click.acu_dash_msg').on('click.acu_dash_msg','.acu-dash-msg-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('npc')||'对方';$t();$('.acu-msg-overlay').remove();const a=ae(),o=$(`\n            <div class="acu-msg-overlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:2147483647;display:flex;justify-content:center;align-items:center;">\n                <div class="acu-msg-dialog" style="background:${a.bgPanel};border:1px solid ${a.border};border-radius:12px;padding:16px;width:90%;max-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.4);">\n                    <div style="font-size:14px;font-weight:bold;color:${a.accent};margin-bottom:12px;display:flex;align-items:center;gap:6px;">\n                        <i class="fa-solid fa-comment"></i> 发送消息给 ${n(t)}\n                    </div>\n                    <input type="text" id="acu-msg-input" placeholder="输入消息内容..." style="width:100%;padding:10px 12px;background:${a.inputBg} !important;border:1px solid ${a.border};border-radius:6px;color:${a.textMain} !important;font-size:14px;box-sizing:border-box;" autofocus>\n                    <div style="display:flex;gap:8px;margin-top:12px;">\n                        <button id="acu-msg-cancel" style="flex:1;padding:8px;background:${a.inputBg};border:1px solid ${a.border};border-radius:6px;color:${a.textMain};cursor:pointer;">取消</button>\n                        <button id="acu-msg-send" style="flex:1;padding:8px;background:${a.btnActiveBg};border:none;border-radius:6px;color:${a.btnActiveText};cursor:pointer;font-weight:bold;">发送</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(o);const r=o[0];r.style.setProperty('position','fixed','important'),r.style.setProperty('top','0','important'),r.style.setProperty('left','0','important'),r.style.setProperty('right','0','important'),r.style.setProperty('bottom','0','important'),r.style.setProperty('width','100vw','important'),r.style.setProperty('height','100vh','important'),r.style.setProperty('display','flex','important'),r.style.setProperty('justify-content','center','important'),r.style.setProperty('align-items','center','important'),r.style.setProperty('z-index','2147483650','important'),setTimeout(()=>o.find('#acu-msg-input').focus(),50);const c=()=>{const e=o.find('#acu-msg-input').val().trim();if(e){i(`<user>对${t}说："${e}"`,'action'),$('#send_textarea').focus()}o.remove()};o.find('#acu-msg-send').click(c),o.find('#acu-msg-input').on('keydown',function(e){'Enter'===e.key&&(e.preventDefault(),c())}),o.find('#acu-msg-cancel').click(()=>o.remove()),o.on('click',function(e){$(e.target).hasClass('acu-msg-overlay')&&o.remove()})}),$('body').off('click.acu_dash_contest').on('click.acu_dash_contest','.acu-dash-contest-btn',function(e){e.stopPropagation(),e.preventDefault();const t=$(this).data('npc')||'',a=xe||zt();var n=50,i=50;if(a)for(var o in a){var r=a[o];if(r&&r.name&&r.content){if('主角信息'===r.name&&r.content[1])for(var c=(r.content[1][7]||'').split(/[,，;；\s]+/),s=0;s<c.length;s++){var l=c[s].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\s：]\s*(\d+)/);if(l){n=parseInt(l[2],10);break}}if('重要人物表'===r.name&&t)for(var d=1;d<r.content.length;d++){var u=r.content[d];if(u&&u[1]===t){for(var p=(u[9]||'').split(/[,，;；\s]+/),g=0;g<p.length;g++){var f=p[g].match(/^([\u4e00-\u9fa5a-zA-Z]+)[:\s：]\s*(\d+)/);if(f){i=parseInt(f[2],10);break}}break}}}}bt({initiatorName:'<user>',initiatorValue:n,opponentName:t,opponentValue:i,diceType:'1d100'})}),$('body').off('click.acu_dash_preview').on('click.acu_dash_preview','.acu-dash-preview-trigger',function(e){e.stopPropagation();const t=$(this).data('table-key'),a=parseInt($(this).data('row-index'),10);if(!t||isNaN(a))return;const i=xe||zt();if(!i||!i[t])return;const o=i[t],r=o.name||'详情',c=o.content[0]||[],s=o.content[a+1];if(!s)return;const l=$t(),d=s[1]||'未命名',u=a;let p='';s.forEach((e,a)=>{if(a<=0||1===a)return;if((c[a]||'').includes('交互'))return;const i=c[a]||'属性'+a,o=String(e||'').trim();if(!o)return;let s='',l=!1;const d=ce(o);if(le(o,i)){const e=se(o);if(e.length>1){l=!0;let t='';e.forEach((a,i)=>{const o=i<e.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';t+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;${o}">\n                            <span style="color:var(--acu-text-main);font-size:0.95em;">${n(a.name)}</span>\n                            ${a.relation?`<span style="color:var(--acu-text-sub);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${n(a.relation)}</span>`:''}\n                        </div>`}),s=`<div class="acu-relation-container">${t}</div>`}else if(1===e.length&&e[0].relation){const t=e[0];s=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                        <span style="color:var(--acu-text-main);">${n(t.name)}</span>\n                        <span style="color:var(--acu-text-sub);font-size:0.85em;background:var(--acu-badge-bg);padding:1px 6px;border-radius:8px;">${n(t.relation)}</span>\n                    </div>`}}else if(d.length>1){l=!0;let e='';d.forEach((t,a)=>{const i=a<d.length-1?'border-bottom:1px dashed rgba(128,128,128,0.2);':'';e+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;${i}">\n                        <span style="color:var(--acu-text-sub);font-size:0.95em;">${n(t.name)}</span>\n                        <div style="display:flex;align-items:center;gap:6px;">\n                            <span style="color:var(--acu-text-main);font-weight:bold;">${t.value}</span>\n                            <i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${n(t.name)}" data-attr-value="${t.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>\n                        </div></div>`}),s=`<div class="acu-multi-attr-container">${e}</div>`}else if(1===d.length){l=!0;const e=d[0];s=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                    <span style="color:var(--acu-text-sub);font-size:0.95em;">${n(e.name)}</span>\n                    <div style="display:flex;align-items:center;gap:6px;">\n                        <span style="color:var(--acu-text-main);font-weight:bold;">${e.value}</span>\n                        <i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${n(e.name)}" data-attr-value="${e.value}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;" title="检定"></i>\n                    </div></div>`}else if(!oe(o)||o.includes(':')||o.includes('：')){const e=je(o);s=e?`<span class="acu-badge ${e}">${n(o)}</span>`:n(o)}else{const e=re(o);s=`<div style="display:flex;justify-content:space-between;align-items:center;">\n                    <span>${n(o)}</span>\n                    <i class="fa-solid fa-dice-d20 acu-inline-dice-btn" data-attr-name="${n(i)}" data-attr-value="${e}" style="cursor:pointer;color:var(--acu-accent);opacity:0.5;font-size:11px;margin-left:6px;" title="检定"></i>\n                </div>`}p+=`<div class="${'acu-card-row acu-cell'+(l?' acu-hide-label':'')}" data-key="${n(t)}" data-tname="${n(r)}" data-row="${u}" data-col="${a}" data-val="${encodeURIComponent(e??'')}">\n                <div class="acu-card-label">${n(i)}</div>\n                <div class="acu-card-value">${s}</div>\n            </div>`});let g='',f=ie(r);const b=c.findIndex(e=>e&&String(e).includes('交互'));if(b>0&&s[b]){const e=String(s[b]).split(/[,，、;；]/).map(e=>e.trim()).filter(e=>e);e.length>0&&(f=e.map(e=>({label:e,icon:'fa-hand-pointer',type:'prompt',template:`<user>对{Name}进行交互：${e}。`,auto_send:!0})))}if(f.length>0){g=`<div class="acu-card-actions">${f.map((e,t)=>`<button class="acu-action-item ${'check'===e.type?'check-type':''}" data-action-idx="${t}" data-row="${u}"><i class="fa-solid ${e.icon||'fa-play'}"></i> ${n(e.label)}</button>`).join('')}</div>`}const m=`\n            <div class="acu-preview-overlay acu-theme-${l.theme}" style="--acu-card-width:${l.cardWidth}px;--acu-font-size:${l.fontSize}px;">\n                <div class="acu-data-card" style="width:90vw;max-width:420px;max-height:85vh;overflow-y:auto;">\n                    <div class="acu-card-header">\n                        <span class="acu-card-index">#${u+1}</span>\n                        <span class="acu-cell acu-editable-title" data-key="${n(t)}" data-tname="${n(r)}" data-row="${u}" data-col="1" data-val="${encodeURIComponent(d)}">${n(d)}</span>\n                        <button class="acu-preview-close" style="margin-left:auto;background:none;border:none;color:var(--acu-text-sub);cursor:pointer;font-size:16px;padding:4px;"><i class="fa-solid fa-times"></i></button>\n                    </div>\n                    <div class="acu-card-body view-list">${p}</div>\n                    ${g}\n                </div>\n            </div>\n        `;$('.acu-preview-overlay').remove(),$('body').append(m);const h=$('.acu-preview-overlay')[0];h&&(h.style.setProperty('position','fixed','important'),h.style.setProperty('top','0','important'),h.style.setProperty('left','0','important'),h.style.setProperty('right','0','important'),h.style.setProperty('bottom','0','important'),h.style.setProperty('width','100vw','important'),h.style.setProperty('height','100vh','important'),h.style.setProperty('display','flex','important'),h.style.setProperty('justify-content','center','important'),h.style.setProperty('align-items','center','important'),h.style.setProperty('z-index','2147483650','important')),$('.acu-preview-overlay').on('click',function(e){($(e.target).hasClass('acu-preview-overlay')||$(e.target).closest('.acu-preview-close').length)&&$(this).remove()})}),function(){const e=$(document);let t=0,a=0;e.on('touchstart.acuSwipeFix','#acu-data-area',function(e){1===e.originalEvent.touches.length&&(t=e.originalEvent.touches[0].clientX,a=e.originalEvent.touches[0].clientY)}),e.on('touchmove.acuSwipeFix','#acu-data-area',function(e){if(1!==e.originalEvent.touches.length)return;const n=e.originalEvent.touches[0],i=Math.abs(n.clientX-t);i>1.5*Math.abs(n.clientY-a)&&i>10&&(e.stopPropagation(),console.log('[ACU] 阻止水平滑动冒泡，防止 ST swipe'))})}()};const na=(e,a)=>{const{$}=Pe();$('.acu-cell-menu, .acu-menu-backdrop').remove();const i=$('<div class="acu-menu-backdrop"></div>');$('body').append(i);const o=parseInt($(a).data('row'),10),r=parseInt($(a).data('col'),10);if(isNaN(o)||isNaN(r))return console.warn('[ACU] 无效的行/列索引'),void i.remove();const c=$(a).data('key'),l=$(a).data('tname')||$(a).closest('.acu-data-card').find('.acu-editable-title').text(),d=decodeURIComponent($(a).data('val')),u=$t(),p=`${c}-${o}-${r}`;window.acuModifiedSet||(window.acuModifiedSet=new Set);const g=window.acuModifiedSet.has(p),f=(Le()[c]||[]).includes(o),b=xe?.[c]?.content?.[0]||[],m=xe?.[c]?.content?.[o+1]||[],h=t.getRowKey(l,m,b),v=b[r]||'',x=h&&t.isFieldLocked(l,h,v),y=h&&t.isRowLocked(l,h);let w='';h&&(w='<div style="border-top:1px dashed var(--acu-border); margin:4px 0;"></div>',w+=x?'<div class="acu-cell-menu-item" id="act-unlock-field" style="color:#27ae60;"><i class="fa-solid fa-unlock"></i> 解锁此单元格</div>':'<div class="acu-cell-menu-item" id="act-lock-field" style="color:#f39c12;"><i class="fa-solid fa-lock"></i> 锁定此单元格</div>',w+=y?'<div class="acu-cell-menu-item" id="act-unlock-row" style="color:#27ae60;"><i class="fa-solid fa-unlock"></i> 解锁整行</div>':'<div class="acu-cell-menu-item" id="act-lock-row" style="color:#f39c12;"><i class="fa-solid fa-lock"></i> 锁定整行</div>');const k=$(`\n            <div class="acu-cell-menu acu-theme-${u.theme}">\n                <div class="acu-cell-menu-item" id="act-edit"><i class="fa-solid fa-pen"></i> 编辑内容</div>\n                <div class="acu-cell-menu-item" id="act-edit-card" style="color:#9b59b6"><i class="fa-solid fa-edit"></i> 整体编辑</div>\n                <div class="acu-cell-menu-item" id="act-insert" style="color:#2980b9"><i class="fa-solid fa-plus"></i> 在下方插入新行</div>\n                <div class="acu-cell-menu-item" id="act-copy"><i class="fa-solid fa-copy"></i> 复制内容</div>\n                ${oe(d)?'<div class="acu-cell-menu-item" id="act-dice" style="color:#9b59b6; border-top:1px dashed var(--acu-border);"><i class="fa-solid fa-dice-d20"></i> 投骰检定 ('+re(d)+')</div>':''}\n                ${w}\n                ${g?'<div class="acu-cell-menu-item" id="act-undo" style="color:#e67e22; border-top:1px solid #eee;"><i class="fa-solid fa-undo"></i> 撤销本次修改</div>':''}\n                ${f?'<div class="acu-cell-menu-item" id="act-restore" style="color:#27ae60"><i class="fa-solid fa-undo"></i> 恢复整行</div>':'<div class="acu-cell-menu-item" id="act-delete" style="color:#e74c3c"><i class="fa-solid fa-trash"></i> 删除整行</div>'}\n                <div class="acu-cell-menu-item" id="act-close"><i class="fa-solid fa-times"></i> 关闭菜单</div>\n            </div>\n        `);$('body').append(k);const C=$(window).width(),S=$(window).height(),T=k.outerWidth()||150,A=k.outerHeight()||150;let I=e.clientX,M=e.clientY;!I&&e.originalEvent&&e.originalEvent.touches&&e.originalEvent.touches.length?(I=e.originalEvent.touches[0].clientX,M=e.originalEvent.touches[0].clientY):!I&&e.changedTouches&&e.changedTouches.length&&(I=e.changedTouches[0].clientX,M=e.changedTouches[0].clientY),void 0===I&&(I=C/2),void 0===M&&(M=S/2);let B=I+5,E=M+5;B+T>C&&(B=I-T-5),E+A>S&&(E=M-A-5),B<5&&(B=5),E<5&&(E=5),k.css({top:E+'px',left:B+'px'});const P=()=>{k.remove(),i.remove()};i.on('click',P),k.find('#act-close').click(P),k.find('#act-lock-field').click(()=>{h&&v&&(t.lockField(l,h,v,d),Lt()),P()}),k.find('#act-unlock-field').click(()=>{h&&v&&(t.unlockField(l,h,v),Lt()),P()}),k.find('#act-lock-row').click(()=>{h&&(t.lockRow(l,h,m,b),Lt()),P()}),k.find('#act-unlock-row').click(()=>{h&&(t.unlockRow(l,h),Lt()),P()}),k.find('#act-copy').click(async e=>{if(e.stopPropagation(),window.TavernHelper&&window.TavernHelper.triggerSlash)try{const e=d.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\n/g,'\\n').replace(/\{/g,'\\{').replace(/\}/g,'\\}');return await window.TavernHelper.triggerSlash(`/clipboard-set "${e}"`),void P()}catch(e){console.warn('酒馆接口复制失败，尝试浏览器原生方法',e)}const t=e=>{try{const t=document.createElement('textarea');t.value=e,t.style.position='fixed',t.style.left='-9999px',t.style.top='0',t.setAttribute('readonly',''),document.body.appendChild(t),t.select(),t.setSelectionRange(0,99999);const a=document.execCommand('copy');if(document.body.removeChild(t),!a)throw new Error('execCommand failed')}catch(t){console.error('复制失败:',t),prompt('复制失败，请长按下方文本手动复制:',e)}};var a;a=d,navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(a).then(()=>{}).catch(()=>{t(a)}):t(a),P()}),k.find('#act-undo').click(()=>{const e=Je();let t=null;if(e&&e[c]?.content[o+1]&&(t=e[c].content[o+1][r]),null!==t){xe||(xe=zt()),xe&&xe[c]?.content[o+1]&&(xe[c].content[o+1][r]=t);const e=$(a);e.attr('data-val',encodeURIComponent(t)),e.data('val',encodeURIComponent(t));let n=e;e.find('.acu-card-value').length>0?n=e.find('.acu-card-value'):e.hasClass('acu-grid-item')?n=e.find('.acu-grid-value'):e.hasClass('acu-full-item')&&(n=e.find('.acu-full-value'));const i=je(t);i&&!e.hasClass('acu-editable-title')?n.html(`<span class="acu-badge ${i}">${t}</span>`):n.text(t),n.removeClass('acu-highlight-manual acu-highlight-diff'),e.hasClass('acu-editable-title')&&e.removeClass('acu-highlight-manual acu-highlight-diff'),window.acuModifiedSet.delete(p),0===window.acuModifiedSet.size&&(ye=!1,Ne())}else window.toastr&&window.toastr.warning('无法找到原始数据，撤销失败');P()}),k.find('#act-delete').click(async()=>{P();let e=Fe.get(s);e&&Array.isArray(e)||(e=['acu-btn-save-global','acu-btn-collapse','acu-btn-refresh','acu-btn-settings']);if(!e.includes('acu-btn-save-global')){const e=$(a).closest('.acu-data-card');e.css('transition','all 0.2s ease').css('opacity','0').css('transform','scale(0.9)'),setTimeout(()=>e.slideUp(200,()=>e.remove()),200),xe||(xe=zt()||Je()),xe&&xe[c]?.content&&(xe[c].content.splice(o+1,1),He(xe),await At(xe,!0,!0))}else{const e=Le();e[c]||(e[c]=[]),e[c].includes(o)||(e[c].push(o),Ue(e)),$(a).closest('.acu-data-card').addClass('pending-deletion'),Ne()}}),k.find('#act-restore').click(()=>{const e=Le();e[c]&&(e[c]=e[c].filter(e=>e!==o),0===e[c].length&&delete e[c],Ue(e)),$(a).closest('.acu-data-card').removeClass('pending-deletion'),Ne(),P()}),k.find('#act-insert').click(async()=>{if(P(),xe||(xe=zt()),xe||(xe=Je()),xe&&xe[c]?.content){const e=xe[c],t=e.content[0]?e.content[0].length:2,a=new Array(t).fill('');t>0&&(a[0]=String(e.content.length)),e.content.splice(o+2,0,a),await At(xe,!1,!0),Lt(),setTimeout(()=>{const e=$('.acu-panel-content');e.length&&e[0].scrollHeight>e.height()&&e.scrollTop(e.scrollTop()+10)},100)}}),k.find('#act-edit-card').click(()=>{P();const e=xe||zt();if(e&&e[c]){const t=e[c].content[0],a=e[c].content[o+1];a&&wt(a,t,l,o,c)}}),k.find('#act-dice').click(()=>{P();const e=re(d),t=$(a).find('.acu-card-label').text()||'属性';ft({targetValue:e,targetName:t,diceType:'1d100'})}),k.find('#act-edit').click(()=>{P(),ia(d,async e=>{if(xe||(xe=zt()||Je()),!xe||!xe[c]?.content[o+1])return void alert('数据结构异常，无法写入缓存，请刷新页面');xe[c].content[o+1][r]=e;const t=$(a);t.attr('data-val',encodeURIComponent(e)).data('val',encodeURIComponent(e));let i=t;t.find('.acu-card-value').length?i=t.find('.acu-card-value'):t.hasClass('acu-grid-item')?i=t.find('.acu-grid-value'):t.hasClass('acu-editable-title')&&(i=t);const l=je(e);l&&!t.hasClass('acu-editable-title')?i.html(`<span class="acu-badge ${l}">${n(e)}</span>`):i.text(e);let d=Fe.get(s);d&&Array.isArray(d)||(d=['acu-btn-save-global','acu-btn-collapse','acu-btn-refresh','acu-btn-settings']);!d.includes('acu-btn-save-global')?(i.removeClass('acu-highlight-manual acu-highlight-diff'),t.hasClass('acu-editable-title')&&t.removeClass('acu-highlight-manual acu-highlight-diff'),He(xe),await At(xe,!0,!0)):(i.removeClass('acu-highlight-diff').addClass('acu-highlight-manual'),t.hasClass('acu-editable-title')&&t.removeClass('acu-highlight-diff').addClass('acu-highlight-manual'),window.acuModifiedSet||(window.acuModifiedSet=new Set),window.acuModifiedSet.add(p),ye=!0,Ne())})})},ia=(e,t)=>{const{$}=Pe(),a=$t(),i=$(`\n            <div class="acu-edit-overlay">\n                \x3c!-- 2. [修改] 在这里加上 acu-theme-${a.theme} --\x3e\n                <div class="acu-edit-dialog acu-theme-${a.theme}">\n                    <div class="acu-edit-title">编辑单元格内容</div>\n                    <textarea class="acu-edit-textarea" spellcheck="false">${n(e)}</textarea>\n                    <div class="acu-dialog-btns">\n                        <button class="acu-dialog-btn" id="dlg-cancel"><i class="fa-solid fa-times"></i> 取消</button>\n                        <button class="acu-dialog-btn acu-btn-confirm" id="dlg-save"><i class="fa-solid fa-check"></i> 保存</button>\n                    </div>\n                </div>\n            </div>\n        `);$('body').append(i);i.find('textarea').on('input',function(){var e;(e=this).style.height='auto',e.style.height=e.scrollHeight+2+'px'}),i.find('#dlg-cancel').click(()=>i.remove()),i.on('click',function(e){$(e.target).hasClass('acu-edit-overlay')&&i.remove()}),i.find('#dlg-save').click(()=>{t(i.find('textarea').val()),i.remove()})},oa=()=>{if(pe)return;if(V.injectStyles(),he&&(he.disconnect(),he=null),Tt(),window.SillyTavern&&window.SillyTavern.eventSource){const e=window.SillyTavern.eventTypes,t=window.SillyTavern.eventSource,a=[e.CHAT_CHANGED,e.MESSAGE_SWIPED,e.MESSAGE_DELETED,e.MESSAGE_UPDATED];ve||(ve=()=>{fe||setTimeout(Lt,500)}),window._acuBoundChatChangeHandler||(window._acuBoundChatChangeHandler=()=>{xe=null,we={},ke={},Se={},ye=!1,me.clear(),window.acuModifiedSet&&window.acuModifiedSet.clear(),setTimeout(Lt,500)});const n=window._acuBoundChatChangeHandler;a.forEach(a=>{a&&(t.removeListener(a,ve),t.removeListener(a,n),a===e.CHAT_CHANGED?t.on(a,n):t.on(a,ve))})}const e=()=>{const t=Pe().getDB();if(t?.exportTableAsJson){pe=!0;const e=$('#chat');if(e.length&&!he){let t=!1;he=new MutationObserver(()=>{t||(t=!0,requestAnimationFrame(()=>{if('embedded'===$t().positionMode)return void(t=!1);const a=e.children().last()[0],n=$('.acu-wrapper')[0];n&&a&&a!==n&&($(a).hasClass('mes')||$(a).hasClass('message-body'))&&e.append(n),t=!1}))}),he.observe(e[0],{childList:!0})}Lt(),setTimeout(()=>{J()},500),t.registerTableUpdateCallback&&(t.registerTableUpdateCallback(Te.handleUpdate),t.registerTableFillStartCallback&&t.registerTableFillStartCallback(()=>{const e=t.exportTableAsJson();e&&He(e)}))}else pe||(window._acuInitRetries=(window._acuInitRetries||0)+1,window._acuInitRetries<60?setTimeout(e,1e3):console.warn('[ACU] 未检测到数据库后端 API，停止轮询。请确保已安装神·数据库脚本。'))};e();setTimeout(()=>{const{$}=Pe(),e=()=>{_e=!1,$('.acu-option-panel, .acu-embedded-options-container').fadeOut(200,function(){$(this).remove()})},t=()=>{r();const e=document.getElementById('send_but');e&&e.addEventListener('click',function(e){o()},!0),$(document).off('click.acu_restore_dice','#send_but').on('click.acu_restore_dice','#send_but',function(e){o()});const t=document.getElementById('send_textarea');t&&t.addEventListener('keydown',function(e){'Enter'!==e.key||e.shiftKey||o()},!0),$('#send_textarea').off('keydown.acu_restore_dice').on('keydown.acu_restore_dice',function(e){'Enter'!==e.key||e.shiftKey||o()});new MutationObserver(()=>{const e=$('#send_textarea');e.length&&!e[0]._acuValueIntercepted&&r()}).observe(document.body,{childList:!0,subtree:!0})},a=window.SillyTavern||window.parent?.SillyTavern,n=a?.eventTypes?.MESSAGE_SENT||(window.tavern_events?window.tavern_events.MESSAGE_SENT:'message_sent');return a?.eventSource?(a.eventSource.on(n,e),a.eventSource.on(n,()=>{setTimeout(()=>{J()},100)}),void t()):'function'==typeof window.eventOn?(window.eventOn(n,e),window.eventOn(n,()=>{setTimeout(()=>{J()},100)}),void t()):void 0},2e3),setTimeout(()=>{r()},500),$(window).off('beforeunload.acu pagehide.acu').on('beforeunload.acu pagehide.acu',()=>{try{localStorage.setItem(Ce,JSON.stringify(Se)),he&&(he.disconnect(),he=null)}catch(e){}})};window.testPairedTableFix=function(){const e='AM',t='编码索引',a={name:'总结表',content:[['编码索引','时间跨度','纪要'],['AM001','时间1','纪要1'],['AM002','时间2','纪要2'],[null,'时间3-错误行','纪要3-错误行'],['AM030','时间4','纪要4'],[null,'时间5-错误行','纪要5-错误行']]},n={name:'总体大纲',content:[['编码索引','时间跨度','大纲'],[null,'时间A-错误行','大纲A-错误行'],['AM002','时间B','大纲B'],['AM030','时间C','大纲C'],['AM040','时间D','大纲D'],['AM050','时间E','大纲E']]},i=Pt(a,t,e),o=Pt(n,t,e),r=Dt(a,0,n,0,t,Nt(i.allCodes,o.allCodes,e,1),e),c=t=>t.content.slice(1).map(e=>e[0]).filter(t=>t&&String(t).match(new RegExp(`^${e}\\d+$`))),s=c(a),l=c(n),d=a.content.slice(1).filter(t=>!t[0]||!String(t[0]).match(new RegExp(`^${e}\\d+$`))),u=n.content.slice(1).filter(t=>!t[0]||!String(t[0]).match(new RegExp(`^${e}\\d+$`))),p=(e,t,a)=>{const n=e.map(e=>{if(!e)return null;const a=e.match(new RegExp(`^${t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}(\\d+)$`));return a?parseInt(a[1],10):null}).filter(e=>null!==e);for(let e=0;e<n.length;e++)if(n[e]!==a+e)return!1;return!0},g=p(s,e,1),f=p(l,e,1),b=new Set(s),m=new Set(l),h=b.size===m.size&&[...b].every(e=>m.has(e)),v=d.some(e=>e[1]&&e[1].includes('错误行')),x=u.some(e=>e[1]&&e[1].includes('错误行'));return{table1Sheet:a,table2Sheet:n,result:r,codes1:s,codes2:l,emptyRows1:d,emptyRows2:u,isValid1:g,isValid2:f,setsEqual:h,emptyRowsPreserved1:v,emptyRowsPreserved2:x,isValid:g&&f&&h&&v&&x}};const{$}=Pe();$?$(document).ready(oa):window.addEventListener('load',oa)}();
//# sourceMappingURL=stable.js.map